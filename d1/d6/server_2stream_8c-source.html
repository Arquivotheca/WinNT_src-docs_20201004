<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: stream.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>stream.c</h1><a href="../../d0/d7/server_2stream_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    stream.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the NT console server stream API</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 6-Nov-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a0">00024</a> <span class="preprocessor">#define IS_CONTROL_CHAR(wch)  ((wch) &lt; L' ')</span>
<a name="l00025"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a1">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_GLYPH_CHAR(wch)   (((wch) &lt; L' ') || ((wch) == 0x007F))</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a2">00027</a> <span class="preprocessor">#define LINE_INPUT_BUFFER_SIZE (256 * sizeof(WCHAR))</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a3">00029</a> <span class="preprocessor">#define CONSOLE_CTRL_2 0x0</span>
00030 <span class="preprocessor"></span>
00031 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00032 <a class="code" href="../../d0/d7/server_2stream_8c.html#a14">WaitForMoreToRead</a>(
00033     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInformation,
00034     IN PCSR_API_MSG Message OPTIONAL,
00035     IN CSR_WAIT_ROUTINE WaitRoutine OPTIONAL,
00036     IN PVOID WaitParameter OPTIONAL,
00037     IN ULONG WaitParameterLength  OPTIONAL,
00038     IN BOOLEAN WaitBlockExists OPTIONAL
00039     );
00040 
00041 BOOLEAN
00042 <a class="code" href="../../d0/d7/server_2stream_8c.html#a15">WriteConsoleWaitRoutine</a>(
00043     IN PLIST_ENTRY WaitQueue,
00044     IN PCSR_THREAD WaitingThread,
00045     IN PCSR_API_MSG WaitReplyMessage,
00046     IN PVOID WaitParameter,
00047     IN PVOID SatisfyParameter1,
00048     IN PVOID SatisfyParameter2,
00049     IN ULONG WaitFlags
00050     );
00051 
00052 HANDLE
<a name="l00053"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a16">00053</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a16">FindActiveScreenBufferHandle</a>(
00054     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
00055     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00056     )
00057 {
00058     ULONG i;
00059     HANDLE ActiveScreenHandle;
00060     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> ActiveScreenHandleData;
00061     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00062 
00063     ActiveScreenHandle = <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>;
00064     <span class="keywordflow">for</span> (i=0;i&lt;ProcessData-&gt;HandleTableSize;i++) {
00065         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00066                                      (HANDLE) i,
00067                                      &amp;ActiveScreenHandleData
00068                                     );
00069         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp;
00070             Console-&gt;CurrentScreenBuffer == ActiveScreenHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer) {
00071             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ActiveScreenHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; (<a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a> | <a class="code" href="../../d1/d7/server_8h.html#a48">CONSOLE_GRAPHICS_OUTPUT_HANDLE</a>));
00072             ActiveScreenHandle = (HANDLE) i;
00073             <span class="keywordflow">break</span>;
00074         }
00075     }
00076     <span class="keywordflow">return</span> ActiveScreenHandle;
00077 }
00078 
00079 ULONG
<a name="l00080"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a17">00080</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a17">SrvOpenConsole</a>(
00081     IN OUT PCSR_API_MSG m,
00082     IN OUT PCSR_REPLY_STATUS ReplyStatus
00083     )
00084 
00085 <span class="comment">/*++</span>
00086 <span class="comment"></span>
00087 <span class="comment">Routine Description:</span>
00088 <span class="comment"></span>
00089 <span class="comment">    This routine returns a handle to the input buffer or active screen buffer.</span>
00090 <span class="comment"></span>
00091 <span class="comment">Arguments:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
00094 <span class="comment"></span>
00095 <span class="comment">Return Value:</span>
00096 <span class="comment"></span>
00097 <span class="comment">--*/</span>
00098 
00099 {
00100     <a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html">PCONSOLE_OPENCONSOLE_MSG</a> a = (<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html">PCONSOLE_OPENCONSOLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
00101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00102     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00103     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00104     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00105     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
00106 
00107     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o0">ConsoleHandle</a>,
00108                          &amp;Console
00109                         );
00110     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00111         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00112     }
00113 
00114     <span class="keywordflow">try</span> {
00115         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE) -1;
00116         ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
00117         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o1">HandleType</a> == <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
00118 
00119             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00120                                       a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o1">HandleType</a>,
00121                                       &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00122                                      );
00123             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00124                 leave;
00125             }
00126             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00127                                          <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00128                                          &amp;HandleData
00129                                         );
00130             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00131             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00132                 leave;
00133             }
00134             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a>(HandleData,
00135                                        &amp;Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o3">InputBuffer</a>)) {
00136                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00137                 leave;
00138             }
00139             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o3">InheritHandle</a>) {
00140                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00141             }
00142             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o2">DesiredAccess</a>,
00143                                      a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o4">ShareMode</a>,
00144                                      &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ShareAccess,
00145                                      HandleData
00146                                     );
00147             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00148                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;RefCount--;
00149                 leave;
00150             }
00151         }
00152         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o1">HandleType</a> == <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>){
00153             <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo;
00154 
00155             <span class="comment">//</span>
00156             <span class="comment">// open a handle to the active screen buffer.</span>
00157             <span class="comment">//</span>
00158 
00159             ScreenInfo = Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>;
00160             <span class="keywordflow">if</span> (ScreenInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00161                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00162                 leave;
00163             }
00164             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
00165                                       a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o1">HandleType</a>,
00166                                       &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00167                                      );
00168             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00169                 leave;
00170             }
00171             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
00172                                          <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00173                                          &amp;HandleData
00174                                         );
00175             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00176             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00177                 leave;
00178             }
00179             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(HandleData, ScreenInfo);
00180             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o3">InheritHandle</a>) {
00181                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
00182             }
00183             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o2">DesiredAccess</a>,
00184                                      a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o4">ShareMode</a>,
00185                                      &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;ShareAccess,
00186                                      HandleData
00187                                     );
00188             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00189                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount--;
00190                 leave;
00191             }
00192         }
00193         <span class="keywordflow">else</span> {
00194             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00195             leave;
00196         }
00197         a-&gt;<a class="code" href="../../d9/d3/struct__CONSOLE__OPENCONSOLE__MSG.html#o5">Handle</a> = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00198         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00199     } finally {
00200         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != (HANDLE)-1) {
00201             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,
00202                          <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>
00203                         );
00204         }
00205         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
00206     }
00207     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00208     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
00209 }
00210 
00211 <span class="comment">/*</span>
00212 <span class="comment"> * Convert real Windows NT modifier bit into bizarre Console bits</span>
00213 <span class="comment"> */</span>
<a name="l00214"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a4">00214</a> <span class="preprocessor">#define EITHER_CTRL_PRESSED (LEFT_CTRL_PRESSED | RIGHT_CTRL_PRESSED)</span>
<a name="l00215"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a5">00215</a> <span class="preprocessor"></span><span class="preprocessor">#define EITHER_ALT_PRESSED (LEFT_ALT_PRESSED | RIGHT_ALT_PRESSED)</span>
<a name="l00216"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a6">00216</a> <span class="preprocessor"></span><span class="preprocessor">#define MOD_PRESSED (SHIFT_PRESSED | EITHER_CTRL_PRESSED | EITHER_ALT_PRESSED)</span>
00217 <span class="preprocessor"></span>
<a name="l00218"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a13">00218</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a13">ConsKbdState</a>[] = {
00219     0,
00220     SHIFT_PRESSED,
00221                     <a class="code" href="../../d0/d7/server_2stream_8c.html#a4">EITHER_CTRL_PRESSED</a>,
00222     SHIFT_PRESSED | <a class="code" href="../../d0/d7/server_2stream_8c.html#a4">EITHER_CTRL_PRESSED</a>,
00223                                           <a class="code" href="../../d0/d7/server_2stream_8c.html#a5">EITHER_ALT_PRESSED</a>,
00224     SHIFT_PRESSED |                       <a class="code" href="../../d0/d7/server_2stream_8c.html#a5">EITHER_ALT_PRESSED</a>,
00225                     <a class="code" href="../../d0/d7/server_2stream_8c.html#a4">EITHER_CTRL_PRESSED</a> | <a class="code" href="../../d0/d7/server_2stream_8c.html#a5">EITHER_ALT_PRESSED</a>,
00226     SHIFT_PRESSED | <a class="code" href="../../d0/d7/server_2stream_8c.html#a4">EITHER_CTRL_PRESSED</a> | <a class="code" href="../../d0/d7/server_2stream_8c.html#a5">EITHER_ALT_PRESSED</a>
00227 };
00228 
<a name="l00229"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a7">00229</a> <span class="preprocessor">#define KEYEVENTSTATE_EQUAL_WINMODS(Event, WinMods)\</span>
00230 <span class="preprocessor">    ((Event.Event.KeyEvent.dwControlKeyState &amp; ConsKbdState[WinMods]) &amp;&amp; \</span>
00231 <span class="preprocessor">    !(Event.Event.KeyEvent.dwControlKeyState &amp; MOD_PRESSED &amp; ~ConsKbdState[WinMods]))</span>
00232 <span class="preprocessor"></span>
<a name="l00233"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a18">00233</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d2/d4/tounicod_8c.html#a15">IsDbcsExemptionForHighAnsi</a>(
00234     UINT wCodePage,
00235     WORD wNumpadChar)
00236 {
00237     UserAssert(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wNumpadChar) == 0);
00238 
00239     <span class="keywordflow">if</span> (wCodePage == <a class="code" href="../../d1/d0/inc_2user_8h.html#a117">CP_JAPANESE</a> &amp;&amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a123">IS_JPN_1BYTE_KATAKANA</a>(wNumpadChar)) {
00240         <span class="comment">/*</span>
00241 <span class="comment">         * If hkl is JAPANESE and NumpadChar is in KANA range,</span>
00242 <span class="comment">         * NumpadChar should be handled by the input locale.</span>
00243 <span class="comment">         */</span>
00244         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00245     }
00246     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wNumpadChar &gt;= 0x80 &amp;&amp; wNumpadChar &lt;= 0xff) {
00247         <span class="comment">/*</span>
00248 <span class="comment">         * Otherwise if NumpadChar is in High ANSI range,</span>
00249 <span class="comment">         * use 1252 for conversion.</span>
00250 <span class="comment">         */</span>
00251         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00252     }
00253 
00254     <span class="comment">/*</span>
00255 <span class="comment">     * None of the above.</span>
00256 <span class="comment">     * This case includes the compound Leading Byte and Trailing Byte,</span>
00257 <span class="comment">     * which is larger than 0xff.</span>
00258 <span class="comment">     */</span>
00259     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00260 }
00261 
00262 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00263"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a19">00263</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(
00264     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInfo,
00265     OUT PWCHAR Char,
00266     IN BOOLEAN Wait,
00267     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00268     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
00269     IN PCSR_API_MSG Message OPTIONAL,
00270     IN CSR_WAIT_ROUTINE WaitRoutine OPTIONAL,
00271     IN PVOID WaitParameter OPTIONAL,
00272     IN ULONG WaitParameterLength  OPTIONAL,
00273     IN BOOLEAN WaitBlockExists OPTIONAL,
00274     OUT PBOOLEAN CommandLineEditingKeys OPTIONAL,
00275     OUT PBOOLEAN CommandLinePopupKeys OPTIONAL,
00276     OUT PBOOLEAN EnableScrollMode OPTIONAL,
00277     OUT PDWORD KeyState OPTIONAL
00278     )
00279 
00280 <span class="comment">/*++</span>
00281 <span class="comment"></span>
00282 <span class="comment">Routine Description:</span>
00283 <span class="comment"></span>
00284 <span class="comment">    This routine is used in stream input.  It gets input and filters it</span>
00285 <span class="comment">    for unicode characters.</span>
00286 <span class="comment"></span>
00287 <span class="comment">Arguments:</span>
00288 <span class="comment"></span>
00289 <span class="comment">    InputInfo - Pointer to input buffer information.</span>
00290 <span class="comment"></span>
00291 <span class="comment">    Char - Unicode char input.</span>
00292 <span class="comment"></span>
00293 <span class="comment">    Wait - TRUE if the routine shouldn't wait for input.</span>
00294 <span class="comment"></span>
00295 <span class="comment">    Console - Pointer to console buffer information.</span>
00296 <span class="comment"></span>
00297 <span class="comment">    HandleData - Pointer to handle data structure.</span>
00298 <span class="comment"></span>
00299 <span class="comment">    Message - csr api message.</span>
00300 <span class="comment"></span>
00301 <span class="comment">    WaitRoutine - Routine to call when wait is woken up.</span>
00302 <span class="comment"></span>
00303 <span class="comment">    WaitParameter - Parameter to pass to wait routine.</span>
00304 <span class="comment"></span>
00305 <span class="comment">    WaitParameterLength - Length of wait parameter.</span>
00306 <span class="comment"></span>
00307 <span class="comment">    WaitBlockExists - TRUE if wait block has already been created.</span>
00308 <span class="comment"></span>
00309 <span class="comment">    CommandLineEditingKeys - if present, arrow keys will be returned. on</span>
00310 <span class="comment">    output, if TRUE, Char contains virtual key code for arrow key.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    CommandLinePopupKeys - if present, arrow keys will be returned. on</span>
00313 <span class="comment">    output, if TRUE, Char contains virtual key code for arrow key.</span>
00314 <span class="comment"></span>
00315 <span class="comment">Return Value:</span>
00316 <span class="comment"></span>
00317 <span class="comment">--*/</span>
00318 
00319 {
00320     ULONG NumRead;
00321     INPUT_RECORD <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00322     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00323 
00324     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLineEditingKeys)) {
00325         *CommandLineEditingKeys = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00326     }
00327     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLinePopupKeys)) {
00328         *CommandLinePopupKeys = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00329     }
00330     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(EnableScrollMode)) {
00331         *EnableScrollMode = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00332     }
00333     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(KeyState)) {
00334         *KeyState = 0;
00335     }
00336 
00337     NumRead = 1;
00338     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00339         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =<a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a25">ReadInputBuffer</a>(InputInfo,
00340                                  &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>,
00341                                  &amp;NumRead,
00342                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00343                                  Wait,
00344                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00345                                  Console,
00346                                  HandleData,
00347                                  Message,
00348                                  WaitRoutine,
00349                                  WaitParameter,
00350                                  WaitParameterLength,
00351                                  WaitBlockExists
00352 #<span class="keywordflow">if</span> defined(FE_SB)
00353                                  ,
00354                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00355 #endif
00356                                 );
00357         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00358             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00359         }
00360         <span class="keywordflow">if</span> (NumRead == 0) {
00361             <span class="keywordflow">if</span> (Wait) {
00362                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00363             }
00364             <span class="keywordflow">else</span> {
00365                 <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00366             }
00367         }
00368         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.EventType == KEY_EVENT) {
00369             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCommandLineEditKey;
00370 
00371             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLineEditingKeys)) {
00372                 fCommandLineEditKey = <a class="code" href="../../d4/d1/cmdline_8h.html#a51">IsCommandLineEditingKey</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent);
00373             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLinePopupKeys)) {
00374                 fCommandLineEditKey = <a class="code" href="../../d4/d1/cmdline_8h.html#a50">IsCommandLinePopupKey</a>(&amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent);
00375             } <span class="keywordflow">else</span> {
00376                 fCommandLineEditKey = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00377             }
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">// Always return keystate if caller asked for it.</span>
00381             <span class="comment">//</span>
00382             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(KeyState)) {
00383                 *KeyState = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.dwControlKeyState;
00384             }
00385 
00386             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar != 0 &amp;&amp;
00387                     !fCommandLineEditKey) {
00388 
00389                 <span class="comment">//</span>
00390                 <span class="comment">// chars that are generated using alt+numpad</span>
00391                 <span class="comment">//</span>
00392                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.bKeyDown &amp;&amp;
00393                         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.wVirtualKeyCode == VK_MENU) {
00394                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.dwControlKeyState &amp; ALTNUMPAD_BIT)
00395                     {
00396                         <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console) &amp;&amp; <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar)) {
00397                             <span class="keywordtype">char</span> chT[2] = {
00398                                 <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar),
00399                                 <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar),
00400                             };
00401                             *Char = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">CharToWchar</a>(Console, Console-&gt;CP, chT);
00402                         } <span class="keywordflow">else</span> {
00403                             <span class="comment">// Because USER doesn't know our codepage, it gives us the</span>
00404                             <span class="comment">// raw OEM char and we convert it to a Unicode character.</span>
00405                             <span class="keywordtype">char</span> chT = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar);
00406                             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCodePage = Console-&gt;CP;
00407 
00408                             <span class="comment">//</span>
00409                             <span class="comment">// FarEast hack for High ANSI OEM characters.</span>
00410                             <span class="comment">//</span>
00411                             <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console)) {
00412                                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/tounicod_8c.html#a15">IsDbcsExemptionForHighAnsi</a>(uCodePage, chT)) {
00413                                     <span class="comment">/*</span>
00414 <span class="comment">                                     * FarEast hack:</span>
00415 <span class="comment">                                     * treat characters in High ANSI area as if they are</span>
00416 <span class="comment">                                     * the ones of Codepage 1252.</span>
00417 <span class="comment">                                     */</span>
00418                                     uCodePage = 1252;
00419                                 }
00420                             }
00421                             *Char = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">CharToWchar</a>(Console, uCodePage, &amp;chT);
00422                         }
00423                     } <span class="keywordflow">else</span> {
00424                         *Char = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar;
00425                     }
00426                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00427                 }
00428                 <span class="comment">//</span>
00429                 <span class="comment">// Ignore Escape and Newline chars</span>
00430                 <span class="comment">//</span>
00431                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.bKeyDown &amp;&amp;
00432                         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.wVirtualKeyCode != VK_ESCAPE &amp;&amp;
00433                         <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar != 0x0a) {
00434 
00435                     *Char = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar;
00436                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00437                 }
00438             }
00439 
00440             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.bKeyDown) {
00441                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> sTmp;
00442                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLineEditingKeys) &amp;&amp;
00443                         fCommandLineEditKey) {
00444                     *CommandLineEditingKeys = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00445                     *Char = (WCHAR) <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.wVirtualKeyCode;
00446                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00447                 }
00448                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CommandLinePopupKeys) &amp;&amp;
00449                         fCommandLineEditKey) {
00450                     *CommandLinePopupKeys = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00451                     *Char = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>) <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.wVirtualKeyCode;
00452                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00453                 }
00454 
00455                 sTmp = <a class="code" href="../../d0/d8/ntcftxt_8h.html#a31">VkKeyScan</a>(0);
00456 
00457                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(sTmp) == <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.wVirtualKeyCode) &amp;&amp;
00458                     <a class="code" href="../../d0/d7/server_2stream_8c.html#a7">KEYEVENTSTATE_EQUAL_WINMODS</a>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(sTmp))) {
00459                     <span class="comment">/*</span>
00460 <span class="comment">                     * This really is the character 0x0000</span>
00461 <span class="comment">                     */</span>
00462                     *Char = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>.Event.KeyEvent.uChar.UnicodeChar;
00463                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00464                 }
00465             }
00466         }
00467     }
00468 }
00469 
00470 BOOLEAN
<a name="l00471"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a20">00471</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a20">RawReadWaitRoutine</a>(
00472     IN PLIST_ENTRY WaitQueue,
00473     IN PCSR_THREAD WaitingThread,
00474     IN PCSR_API_MSG WaitReplyMessage,
00475     IN PVOID WaitParameter,
00476     IN PVOID SatisfyParameter1,
00477     IN PVOID SatisfyParameter2,
00478     IN ULONG WaitFlags
00479     )
00480 
00481 <span class="comment">/*++</span>
00482 <span class="comment"></span>
00483 <span class="comment">Routine Description:</span>
00484 <span class="comment"></span>
00485 <span class="comment">    This routine is called to complete a raw read that blocked in</span>
00486 <span class="comment">    ReadInputBuffer.  The context of the read was saved in the RawReadData</span>
00487 <span class="comment">    structure.  This routine is called when events have been written to</span>
00488 <span class="comment">    the input buffer.  It is called in the context of the writing thread.</span>
00489 <span class="comment">    ?It will be called at most once per read.?</span>
00490 <span class="comment"></span>
00491 <span class="comment">Arguments:</span>
00492 <span class="comment"></span>
00493 <span class="comment">    WaitQueue - pointer to queue containing wait block</span>
00494 <span class="comment"></span>
00495 <span class="comment">    WaitingThread - pointer to waiting thread</span>
00496 <span class="comment"></span>
00497 <span class="comment">    WaitReplyMessage - Pointer to reply message to return to dll when</span>
00498 <span class="comment">        read is completed.</span>
00499 <span class="comment"></span>
00500 <span class="comment">    RawReadData - pointer to data saved in ReadChars</span>
00501 <span class="comment"></span>
00502 <span class="comment">    SatisfyParameter1 - not used</span>
00503 <span class="comment"></span>
00504 <span class="comment">    SatisfyParameter2 - not used</span>
00505 <span class="comment"></span>
00506 <span class="comment">    WaitFlags - Flags indicating status of wait.</span>
00507 <span class="comment"></span>
00508 <span class="comment">Return Value:</span>
00509 <span class="comment"></span>
00510 <span class="comment">--*/</span>
00511 
00512 {
00513     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00514     PWCHAR lpBuffer;
00515     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a;
00516     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
00517     <a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html">PRAW_READ_DATA</a> RawReadData;
00518     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
00519     BOOLEAN RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00520 <span class="preprocessor">#ifdef FE_SB</span>
00521 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumBytes;
00522     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00523 <span class="preprocessor">#endif</span>
00524 <span class="preprocessor"></span>
00525     a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
00526     RawReadData = (<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html">PRAW_READ_DATA</a>)WaitParameter;
00527 
00528     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o4">ProcessData</a>,
00529                                         RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o5">HandleIndex</a>,
00530                                         &amp;HandleData
00531                                        );
00532     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">// see if this routine was called by CloseInputHandle.  if it</span>
00536     <span class="comment">// was, see if this wait block corresponds to the dying handle.</span>
00537     <span class="comment">// if it doesn't, just return.</span>
00538     <span class="comment">//</span>
00539 
00540     <span class="keywordflow">if</span> (SatisfyParameter1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00541         SatisfyParameter1 != HandleData) {
00542         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00543     }
00544     <span class="keywordflow">if</span> ((ULONG_PTR)SatisfyParameter2 &amp; <a class="code" href="../../d9/d3/input_8h.html#a23">CONSOLE_CTRL_C_SEEN</a>) {
00545         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00546     }
00547 
00548     Console = RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o1">Console</a>;
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">// this routine should be called by a thread owning the same</span>
00552     <span class="comment">// lock on the same console as we're reading from.</span>
00553     <span class="comment">//</span>
00554 
00555     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = 0;
00556 <span class="preprocessor">#ifdef FE_SB</span>
00557 <span class="preprocessor"></span>    NumBytes = 0 ;
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>    <span class="keywordflow">try</span> {
00560         <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
00561         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a>);
00562         HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> -= 1;
00563         <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// if a ctrl-c is seen, don't terminate read.  if ctrl-break is seen,</span>
00567         <span class="comment">// terminate read.</span>
00568         <span class="comment">//</span>
00569 
00570         <span class="keywordflow">if</span> ((ULONG_PTR)SatisfyParameter2 &amp; <a class="code" href="../../d9/d3/input_8h.html#a24">CONSOLE_CTRL_BREAK_SEEN</a>) {
00571             WaitReplyMessage-&gt;ReturnValue = STATUS_ALERTED;
00572             leave;
00573         }
00574 
00575         <span class="comment">//</span>
00576         <span class="comment">// see if called by CsrDestroyProcess or CsrDestroyThread</span>
00577         <span class="comment">// via CsrNotifyWaitBlock.   if so, just decrement the ReadCount</span>
00578         <span class="comment">// and return.</span>
00579         <span class="comment">//</span>
00580 
00581         <span class="keywordflow">if</span> (WaitFlags &amp; CSR_PROCESS_TERMINATING) {
00582             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_THREAD_IS_TERMINATING;
00583             leave;
00584         }
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">// We must see if we were woken up because the handle is being</span>
00588         <span class="comment">// closed.  if so, we decrement the read count.  if it goes to</span>
00589         <span class="comment">// zero, we wake up the close thread.  otherwise, we wake up any</span>
00590         <span class="comment">// other thread waiting for data.</span>
00591         <span class="comment">//</span>
00592 
00593         <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a51">HANDLE_CLOSING</a>) {
00594             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SatisfyParameter1 == HandleData);
00595             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ALERTED;
00596             leave;
00597         }
00598 
00599         <span class="comment">//</span>
00600         <span class="comment">// if we get to here, this routine was called either by the input</span>
00601         <span class="comment">// thread or a write routine.  both of these callers grab the</span>
00602         <span class="comment">// current console lock.</span>
00603         <span class="comment">//</span>
00604 
00605         <span class="comment">//</span>
00606         <span class="comment">// this routine should be called by a thread owning the same</span>
00607         <span class="comment">// lock on the same console as we're reading from.</span>
00608         <span class="comment">//</span>
00609 
00610         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
00611 
00612         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> &lt;= <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>) {
00613             lpBuffer = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>;
00614         }
00615         <span class="keywordflow">else</span> {
00616             lpBuffer = RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o3">BufPtr</a>;
00617         }
00618 
00619         <span class="comment">//</span>
00620         <span class="comment">// this call to GetChar may block.</span>
00621         <span class="comment">//</span>
00622 
00623 <span class="preprocessor">#ifdef FE_SB</span>
00624 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(Console)) {
00625             <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
00626                 fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00627                 *lpBuffer = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
00628                 RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o2">BufferSize</a>-=<span class="keyword">sizeof</span>(WCHAR);
00629                 RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
00630                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00631                 <span class="keywordflow">if</span> (RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o2">BufferSize</a> == 0) {
00632                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = 1;
00633                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00634                 }
00635             }
00636             <span class="keywordflow">else</span>{
00637                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o0">InputInfo</a>,
00638                          lpBuffer,
00639                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00640                          Console,
00641                          HandleData,
00642                          WaitReplyMessage,
00643                          <a class="code" href="../../d0/d7/server_2stream_8c.html#a20">RawReadWaitRoutine</a>,
00644                          RawReadData,
00645                          <span class="keyword">sizeof</span>(*RawReadData),
00646                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00647                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00648                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00649                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00650                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00651                         );
00652             }
00653         }
00654         <span class="keywordflow">else</span>
00655 <span class="preprocessor">#endif</span>
00656 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o0">InputInfo</a>,
00657                          lpBuffer,
00658                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00659                          Console,
00660                          HandleData,
00661                          WaitReplyMessage,
00662                          <a class="code" href="../../d0/d7/server_2stream_8c.html#a20">RawReadWaitRoutine</a>,
00663                          RawReadData,
00664                          <span class="keyword">sizeof</span>(*RawReadData),
00665                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00666                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00667                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00668                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00669                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00670                         );
00671 
00672         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00673             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00674                 RetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00675             }
00676             leave;
00677         }
00678 <span class="preprocessor">#ifdef FE_SB</span>
00679 <span class="preprocessor"></span>        IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00680                            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,*lpBuffer) ? NumBytes+=2 : NumBytes++;
00681 <span class="preprocessor">#endif</span>
00682 <span class="preprocessor"></span>        lpBuffer++;
00683         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> += <span class="keyword">sizeof</span>(WCHAR);
00684         <span class="keywordflow">while</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> &lt; RawReadData-&gt;BufferSize) {
00685 
00686             <span class="comment">//</span>
00687             <span class="comment">// this call to GetChar won't block.</span>
00688             <span class="comment">//</span>
00689 
00690             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(RawReadData-&gt;InputInfo,lpBuffer,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00691             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00692                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00693                 <span class="keywordflow">break</span>;
00694             }
00695 <span class="preprocessor">#ifdef FE_SB</span>
00696 <span class="preprocessor"></span>            IsConsoleFullWidth(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00697                                Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,*lpBuffer) ? NumBytes+=2 : NumBytes++;
00698 <span class="preprocessor">#endif</span>
00699 <span class="preprocessor"></span>            lpBuffer++;
00700             a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> += <span class="keyword">sizeof</span>(WCHAR);
00701         }
00702     } finally {
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// if the read was completed (status != wait), free the raw read</span>
00706         <span class="comment">// data.</span>
00707         <span class="comment">//</span>
00708 
00709         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
00710             <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a>) {
00711 
00712                 <span class="comment">//</span>
00713                 <span class="comment">// if ansi, translate string.</span>
00714                 <span class="comment">//</span>
00715 
00716                 PCHAR TransBuffer;
00717 
00718 <span class="preprocessor">#ifdef FE_SB</span>
00719 <span class="preprocessor"></span>                TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumBytes);
00720 <span class="preprocessor">#else</span>
00721 <span class="preprocessor"></span>                TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / <span class="keyword">sizeof</span>(WCHAR));
00722 <span class="preprocessor">#endif</span>
00723 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00724                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00725                 }
00726 
00727                 <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> &lt;= <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>) {
00728                     lpBuffer = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>;
00729                 }
00730                 <span class="keywordflow">else</span> {
00731                     lpBuffer = RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o3">BufPtr</a>;
00732                 }
00733 
00734 <span class="preprocessor">#ifdef FE_SB</span>
00735 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console))
00736                 {
00737                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a53">TranslateUnicodeToOem</a>(Console,
00738                                                         lpBuffer,
00739                                                         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR),
00740                                                         TransBuffer,
00741                                                         NumBytes,
00742                                                         &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte);
00743                 }
00744                 <span class="keywordflow">else</span>
00745 <span class="preprocessor">#endif</span>
00746 <span class="preprocessor"></span>                a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(RawReadData-&gt;<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o1">Console</a>-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o61">CP</a>,
00747                                      lpBuffer,
00748                                      a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR),
00749                                      TransBuffer,
00750                                      a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR)
00751                                      );
00752                 RtlCopyMemory(lpBuffer,TransBuffer,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
00753 <span class="preprocessor">#ifdef FE_SB</span>
00754 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (fAddDbcsLead)
00755                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>++;
00756 <span class="preprocessor">#endif</span>
00757 <span class="preprocessor"></span>                <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
00758             }
00759             WaitReplyMessage-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00760             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(RawReadData);
00761         }
00762     }
00763     <span class="keywordflow">return</span> RetVal;
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// satisfy the unreferenced parameter warnings.</span>
00767     <span class="comment">//</span>
00768 
00769     UNREFERENCED_PARAMETER(WaitQueue);
00770     UNREFERENCED_PARAMETER(WaitingThread);
00771 }
00772 
00773 ULONG
<a name="l00774"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a21">00774</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a21">RetrieveTotalNumberOfSpaces</a>(
00775     IN SHORT OriginalCursorPositionX,
00776     IN PWCHAR Buffer,
00777     IN ULONG CurrentPosition
00778 #<span class="keywordflow">if</span> defined(FE_SB)
00779     ,
00780     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00781 #endif
00782     )
00783 
00784 <span class="comment">/*++</span>
00785 <span class="comment"></span>
00786 <span class="comment">    This routine returns the total number of screen spaces the characters</span>
00787 <span class="comment">    up to the specified character take up.</span>
00788 <span class="comment"></span>
00789 <span class="comment">--*/</span>
00790 
00791 {
00792     WCHAR Char;
00793     ULONG i,NumSpacesForChar,NumSpaces;
00794     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XPosition;
00795 
00796     XPosition=OriginalCursorPositionX;
00797     NumSpaces=0;
00798     <span class="keywordflow">for</span> (i=0;i&lt;CurrentPosition;i++) {
00799         Char = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i];
00800         <span class="keywordflow">if</span> (Char == <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>) {
00801             NumSpacesForChar = <a class="code" href="../../d9/d3/input_8h.html#a11">NUMBER_OF_SPACES_IN_TAB</a>(XPosition);
00802         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2stream_8c.html#a0">IS_CONTROL_CHAR</a>(Char)) {
00803             NumSpacesForChar = 2;
00804 <span class="preprocessor">#if defined(FE_SB)</span>
00805 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,Console-&gt;CP,Char)) {
00806             NumSpacesForChar = 2;
00807 <span class="preprocessor">#endif</span>
00808 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00809             NumSpacesForChar = 1;
00810         }
00811         XPosition = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(XPosition+NumSpacesForChar);
00812         NumSpaces += NumSpacesForChar;
00813     }
00814     <span class="keywordflow">return</span> NumSpaces;
00815 }
00816 
00817 ULONG
<a name="l00818"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a22">00818</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(
00819     IN SHORT OriginalCursorPositionX,
00820     IN PWCHAR Buffer,
00821     IN ULONG CurrentPosition
00822 #<span class="keywordflow">if</span> defined(FE_SB)
00823     ,
00824     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00825     IN DWORD CodePage
00826 #endif
00827     )
00828 
00829 <span class="comment">/*++</span>
00830 <span class="comment"></span>
00831 <span class="comment">    This routine returns the number of screen spaces the specified character</span>
00832 <span class="comment">    takes up.</span>
00833 <span class="comment"></span>
00834 <span class="comment">--*/</span>
00835 
00836 {
00837     WCHAR Char;
00838     ULONG i,NumSpaces;
00839     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XPosition;
00840 
00841     Char = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[CurrentPosition];
00842     <span class="keywordflow">if</span> (Char == <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>) {
00843         NumSpaces=0;
00844         XPosition=OriginalCursorPositionX;
00845         <span class="keywordflow">for</span> (i=0;i&lt;=CurrentPosition;i++) {
00846             Char = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[i];
00847             <span class="keywordflow">if</span> (Char == <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>) {
00848                 NumSpaces = <a class="code" href="../../d9/d3/input_8h.html#a11">NUMBER_OF_SPACES_IN_TAB</a>(XPosition);
00849             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2stream_8c.html#a0">IS_CONTROL_CHAR</a>(Char)) {
00850                 NumSpaces = 2;
00851 <span class="preprocessor">#if defined(FE_SB)</span>
00852 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,CodePage,Char)) {
00853                 NumSpaces = 2;
00854 <span class="preprocessor">#endif</span>
00855 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
00856                 NumSpaces = 1;
00857             }
00858             XPosition = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(XPosition+NumSpaces);
00859         }
00860         <span class="keywordflow">return</span> NumSpaces;
00861     }
00862     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2stream_8c.html#a0">IS_CONTROL_CHAR</a>(Char)) {
00863         <span class="keywordflow">return</span> 2;
00864     }
00865 <span class="preprocessor">#if defined(FE_SB)</span>
00866 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,CodePage,Char)) {
00867         <span class="keywordflow">return</span> 2;
00868     }
00869 <span class="preprocessor">#endif</span>
00870 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
00871         <span class="keywordflow">return</span> 1;
00872     }
00873 }
00874 
00875 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00876"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a23">00876</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a23">ProcessCookedReadInput</a>(
00877     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
00878     IN WCHAR Char,
00879     IN DWORD KeyState,
00880     OUT PNTSTATUS Status
00881     )
00882 
00883 <span class="comment">/*++</span>
00884 <span class="comment"></span>
00885 <span class="comment">    Return Value:</span>
00886 <span class="comment"></span>
00887 <span class="comment">        TRUE if read is completed</span>
00888 <span class="comment">--*/</span>
00889 
00890 {
00891     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumSpaces;
00892     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> ScrollY=0;
00893     ULONG NumToWrite;
00894     WCHAR wchOrig = Char;
00895     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fStartFromDelim;
00896 
00897     *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00898     <span class="keywordflow">if</span> (CookedReadData-&gt;BytesRead &gt;= (CookedReadData-&gt;BufferSize-(2*<span class="keyword">sizeof</span>(WCHAR))) &amp;&amp;
00899         Char != <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a> &amp;&amp;
00900         Char != <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>) {
00901         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00902     }
00903 
00904     <span class="keywordflow">if</span> (CookedReadData-&gt;CtrlWakeupMask != 0 &amp;&amp;
00905         Char &lt; <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span> &amp;&amp; (CookedReadData-&gt;CtrlWakeupMask &amp; (1 &lt;&lt; Char))) {
00906         *CookedReadData-&gt;BufPtr = Char;
00907         CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
00908         CookedReadData-&gt;BufPtr+=1;
00909         CookedReadData-&gt;CurrentPosition+=1;
00910         CookedReadData-&gt;ControlKeyState = KeyState;
00911         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00912     }
00913 
00914 
00915     <span class="keywordflow">if</span> (Char == EXTKEY_ERASE_PREV_WORD) {
00916         Char = <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>;
00917 
00918     }
00919     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/input_8h.html#a12">AT_EOL</a>(CookedReadData)) {
00920 
00921         <span class="comment">//</span>
00922         <span class="comment">// if at end of line, processing is relatively simple. just store the</span>
00923         <span class="comment">// character and write it to the screen.</span>
00924         <span class="comment">//</span>
00925 
00926 
00927         <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a52">UNICODE_BACKSPACE2</a>) {
00928             Char = <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>;
00929         }
00930         <span class="keywordflow">if</span> (Char != <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a> ||
00931             CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit) {
00932 
00933             fStartFromDelim = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(CookedReadData-&gt;BufPtr[-1]);
00934 
00935 eol_repeat:
00936             <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
00937                 NumToWrite=<span class="keyword">sizeof</span>(WCHAR);
00938                 *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
00939                                     CookedReadData-&gt;BackupLimit,
00940                                     CookedReadData-&gt;BufPtr,
00941                                     &amp;Char,
00942                                     &amp;NumToWrite,
00943                                     (PLONG)&amp;NumSpaces,
00944                                     CookedReadData-&gt;OriginalCursorPosition.X,
00945                                     <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
00946                                             <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
00947                                     &amp;ScrollY
00948                                     );
00949                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00950                     CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
00951                 } <span class="keywordflow">else</span> {
00952                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"WriteCharsFromInput failed %x"</span>, *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00953                 }
00954             }
00955             CookedReadData-&gt;NumberOfVisibleChars += NumSpaces;
00956             <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a> &amp;&amp; CookedReadData-&gt;Processed) {
00957                 CookedReadData-&gt;BytesRead -= <span class="keyword">sizeof</span>(WCHAR);
00958                 *CookedReadData-&gt;BufPtr=(WCHAR)<span class="charliteral">' '</span>;
00959                 CookedReadData-&gt;BufPtr-=1;
00960                 CookedReadData-&gt;CurrentPosition-=1;
00961 
00962                 <span class="comment">// Repeat until it hits the word boundary</span>
00963                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp;
00964                         wchOrig == EXTKEY_ERASE_PREV_WORD &amp;&amp;
00965                         CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit &amp;&amp;
00966                         fStartFromDelim ^ !<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(CookedReadData-&gt;BufPtr[-1])) {
00967                     <span class="keywordflow">goto</span> eol_repeat;
00968                 }
00969             }
00970             <span class="keywordflow">else</span> {
00971                 *CookedReadData-&gt;BufPtr = Char;
00972                 CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
00973                 CookedReadData-&gt;BufPtr+=1;
00974                 CookedReadData-&gt;CurrentPosition+=1;
00975             }
00976         }
00977     } <span class="keywordflow">else</span> {
00978         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> CallWrite=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00979 
00980         <span class="comment">//</span>
00981         <span class="comment">// processing in the middle of the line is more complex:</span>
00982         <span class="comment">//</span>
00983         <span class="comment">//</span>
00984         <span class="comment">// calculate new cursor position</span>
00985         <span class="comment">// store new char</span>
00986         <span class="comment">// clear the current command line from the screen</span>
00987         <span class="comment">// write the new command line to the screen</span>
00988         <span class="comment">// update the cursor position</span>
00989         <span class="comment">//</span>
00990 
00991         <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a> &amp;&amp; CookedReadData-&gt;Processed) {
00992 
00993             <span class="comment">//</span>
00994             <span class="comment">// for backspace, use writechars to calculate the new cursor position.</span>
00995             <span class="comment">// this call also sets the cursor to the right position for the</span>
00996             <span class="comment">// second call to writechars.</span>
00997             <span class="comment">//</span>
00998             <span class="keywordflow">if</span> (CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit) {
00999 
01000                 fStartFromDelim = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp; <a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(CookedReadData-&gt;BufPtr[-1]);
01001 
01002 bs_repeat:
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// we call writechar here so that cursor position gets updated</span>
01006                 <span class="comment">// correctly.  we also call it later if we're not at eol so</span>
01007                 <span class="comment">// that the remainder of the string can be updated correctly.</span>
01008                 <span class="comment">//</span>
01009 
01010                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
01011                     NumToWrite=<span class="keyword">sizeof</span>(WCHAR);
01012                     *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
01013                              CookedReadData-&gt;BackupLimit,
01014                              CookedReadData-&gt;BufPtr,
01015                              &amp;Char,
01016                              &amp;NumToWrite,
01017                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01018                              CookedReadData-&gt;OriginalCursorPosition.X,
01019                              <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
01020                                      <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
01021                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01022 
01023                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01024                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"WriteCharsFromInput failed %x"</span>, *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01025                     }
01026                 }
01027                 CookedReadData-&gt;BytesRead -= <span class="keyword">sizeof</span>(WCHAR);
01028                 CookedReadData-&gt;BufPtr-=1;
01029                 CookedReadData-&gt;CurrentPosition-=1;
01030                 RtlCopyMemory(CookedReadData-&gt;BufPtr,
01031                        CookedReadData-&gt;BufPtr+1,
01032                        CookedReadData-&gt;BytesRead - (CookedReadData-&gt;CurrentPosition * <span class="keyword">sizeof</span>(WCHAR))
01033                       );
01034 <span class="preprocessor">#if defined(FE_SB)</span>
01035 <span class="preprocessor"></span>                {
01036                     PWCHAR buf = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CookedReadData-&gt;BackupLimit +
01037                                                  CookedReadData-&gt;BytesRead    );
01038                     *buf = (WCHAR)<span class="charliteral">' '</span>;
01039                 }
01040 <span class="preprocessor">#endif</span>
01041 <span class="preprocessor"></span>                NumSpaces = 0;
01042 
01043                 <span class="comment">// Repeat until it hits the word boundary</span>
01044                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a24">gExtendedEditKey</a> &amp;&amp;
01045                         wchOrig == EXTKEY_ERASE_PREV_WORD &amp;&amp;
01046                         CookedReadData-&gt;BufPtr != CookedReadData-&gt;BackupLimit &amp;&amp;
01047                         fStartFromDelim ^ !<a class="code" href="../../d4/d1/cmdline_8h.html#a23">IS_WORD_DELIM</a>(CookedReadData-&gt;BufPtr[-1])) {
01048                     <span class="keywordflow">goto</span> bs_repeat;
01049                 }
01050             } <span class="keywordflow">else</span> {
01051                  CallWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01052             }
01053         } <span class="keywordflow">else</span> {
01054 
01055             <span class="comment">//</span>
01056             <span class="comment">// store the char</span>
01057             <span class="comment">//</span>
01058 
01059             <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
01060                 CookedReadData-&gt;BufPtr = (PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CookedReadData-&gt;BackupLimit + CookedReadData-&gt;BytesRead);
01061                 *CookedReadData-&gt;BufPtr = Char;
01062                 CookedReadData-&gt;BufPtr+=1;
01063                 CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
01064                 CookedReadData-&gt;CurrentPosition += 1;
01065             } <span class="keywordflow">else</span> {
01066 <span class="preprocessor">#if defined(FE_SB)</span>
01067 <span class="preprocessor"></span>                <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fBisect = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01068                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
01069                     <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
01070                                             CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
01071                                             CookedReadData-&gt;BackupLimit,
01072                                             CookedReadData-&gt;CurrentPosition+1,
01073                                             CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
01074                                              -CookedReadData-&gt;OriginalCursorPosition.X,
01075                                             CookedReadData-&gt;OriginalCursorPosition.X,
01076                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01077                         fBisect = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01078                     }
01079                 }
01080 <span class="preprocessor">#endif</span>
01081 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/input_8h.html#a13">INSERT_MODE</a>(CookedReadData)) {
01082                     memmove(CookedReadData-&gt;BufPtr+1,
01083                             CookedReadData-&gt;BufPtr,
01084                             CookedReadData-&gt;BytesRead - (CookedReadData-&gt;CurrentPosition * <span class="keyword">sizeof</span>(WCHAR))
01085                            );
01086                     CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
01087                 }
01088                 *CookedReadData-&gt;BufPtr = Char;
01089                 CookedReadData-&gt;BufPtr+=1;
01090                 CookedReadData-&gt;CurrentPosition += 1;
01091 
01092                 <span class="comment">//</span>
01093                 <span class="comment">// calculate new cursor position</span>
01094                 <span class="comment">//</span>
01095 
01096                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
01097                     NumSpaces = <a class="code" href="../../d0/d7/server_2stream_8c.html#a22">RetrieveNumberOfSpaces</a>(CookedReadData-&gt;OriginalCursorPosition.X,
01098                                                        CookedReadData-&gt;BackupLimit,
01099                                                        CookedReadData-&gt;CurrentPosition-1
01100 #<span class="keywordflow">if</span> defined(FE_SB)
01101                                                        ,
01102                                                        CookedReadData-&gt;ScreenInfo-&gt;Console,
01103                                                        CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP
01104 #endif
01105                                                       );
01106 <span class="preprocessor">#if defined(FE_SB)</span>
01107 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (NumSpaces &gt; 0 &amp;&amp; fBisect)
01108                         NumSpaces--;
01109 <span class="preprocessor">#endif</span>
01110 <span class="preprocessor"></span>                }
01111             }
01112         }
01113 
01114         <span class="keywordflow">if</span> (CookedReadData-&gt;Echo &amp;&amp; CallWrite) {
01115 
01116             COORD CursorPosition;
01117 
01118             <span class="comment">//</span>
01119             <span class="comment">// save cursor position</span>
01120             <span class="comment">//</span>
01121 
01122             CursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
01123             CursorPosition.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(CursorPosition.X+NumSpaces);
01124 
01125             <span class="comment">//</span>
01126             <span class="comment">// clear the current command line from the screen</span>
01127             <span class="comment">//</span>
01128 
01129             <a class="code" href="../../d4/d1/cmdline_8h.html#a41">DeleteCommandLine</a>(CookedReadData,
01130                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01131 
01132             <span class="comment">//</span>
01133             <span class="comment">// write the new command line to the screen</span>
01134             <span class="comment">//</span>
01135 
01136             NumToWrite = CookedReadData-&gt;BytesRead;
01137             *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
01138                                 CookedReadData-&gt;BackupLimit,
01139                                 CookedReadData-&gt;BackupLimit,
01140                                 CookedReadData-&gt;BackupLimit,
01141                                 &amp;NumToWrite,
01142                                 (PLONG)&amp;CookedReadData-&gt;NumberOfVisibleChars,
01143                                 CookedReadData-&gt;OriginalCursorPosition.X,
01144                                 (Char != <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) ?
01145                                      <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a> :
01146                                      <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
01147                                 &amp;ScrollY
01148                                 );
01149             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01150                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"WriteCharsFromInput failed %x"</span>, *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01151                 CookedReadData-&gt;BytesRead = 0;
01152                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01153             }
01154 
01155             <span class="comment">//</span>
01156             <span class="comment">// update cursor position</span>
01157             <span class="comment">//</span>
01158 
01159             <span class="keywordflow">if</span> (Char != <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
01160 <span class="preprocessor">#if defined(FE_SB)</span>
01161 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CheckBisectProcessW(CookedReadData-&gt;ScreenInfo,
01162                                         CookedReadData-&gt;ScreenInfo-&gt;Console-&gt;CP,
01163                                         CookedReadData-&gt;BackupLimit,
01164                                         CookedReadData-&gt;CurrentPosition+1,
01165                                         CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X
01166                                          -CookedReadData-&gt;OriginalCursorPosition.X,
01167                                         CookedReadData-&gt;OriginalCursorPosition.X,
01168                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01169                     <span class="keywordflow">if</span> (CursorPosition.X == (CookedReadData-&gt;ScreenInfo-&gt;ScreenBufferSize.X-1))
01170                         CursorPosition.X++;
01171                 }
01172 <span class="preprocessor">#endif</span>
01173 <span class="preprocessor"></span>
01174                 <span class="comment">// adjust cursor position for WriteChars</span>
01175                 CookedReadData-&gt;OriginalCursorPosition.Y += ScrollY;
01176                 CursorPosition.Y += ScrollY;
01177                 *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a10">AdjustCursorPosition</a>(CookedReadData-&gt;ScreenInfo,
01178                                               CursorPosition,
01179                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01180                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01181                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01182                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01183                     CookedReadData-&gt;BytesRead = 0;
01184                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01185                 }
01186             }
01187         }
01188     }
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">// in cooked mode, enter (carriage return) is converted to</span>
01192     <span class="comment">// carriage return linefeed (0xda).  carriage return is always</span>
01193     <span class="comment">// stored at the end of the buffer.</span>
01194     <span class="comment">//</span>
01195 
01196     <span class="keywordflow">if</span> (Char == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
01197         <span class="keywordflow">if</span> (CookedReadData-&gt;Processed) {
01198             <span class="keywordflow">if</span> (CookedReadData-&gt;BytesRead &lt; CookedReadData-&gt;BufferSize) {
01199                 *CookedReadData-&gt;BufPtr = <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01200                 <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
01201                     NumToWrite=<span class="keyword">sizeof</span>(WCHAR);
01202                     *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(CookedReadData-&gt;ScreenInfo,
01203                              CookedReadData-&gt;BackupLimit,
01204                              CookedReadData-&gt;BufPtr,
01205                              CookedReadData-&gt;BufPtr,
01206                              &amp;NumToWrite,
01207                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01208                              CookedReadData-&gt;OriginalCursorPosition.X,
01209                              <a class="code" href="../../d4/d1/cmdline_8h.html#a17">WC_DESTRUCTIVE_BACKSPACE</a> |
01210                                      <a class="code" href="../../d4/d1/cmdline_8h.html#a18">WC_KEEP_CURSOR_VISIBLE</a> | <a class="code" href="../../d4/d1/cmdline_8h.html#a19">WC_ECHO</a>,
01211                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01212 
01213                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01214                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"WriteCharsFromInput failed %x"</span>, *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01215                     }
01216                 }
01217                 CookedReadData-&gt;BytesRead += <span class="keyword">sizeof</span>(WCHAR);
01218                 CookedReadData-&gt;BufPtr++;
01219                 CookedReadData-&gt;CurrentPosition += 1;
01220             }
01221         }
01222         <span class="comment">//</span>
01223         <span class="comment">// reset the cursor back to 25% if necessary</span>
01224         <span class="comment">//</span>
01225         <span class="keywordflow">if</span> (CookedReadData-&gt;Line) {
01226             <span class="keywordflow">if</span> (CookedReadData-&gt;InsertMode != CookedReadData-&gt;Console-&gt;InsertMode) {
01227                 <a class="code" href="../../d4/d1/cmdline_8h.html#a40">ProcessCommandLine</a>(CookedReadData,VK_INSERT,0,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// make cursor small</span>
01228             }
01229             *<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01230             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01231         }
01232     }
01233     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01234 }
01235 
01236 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01237"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a24">01237</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a24">CookedRead</a>(
01238     IN <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData,
01239     IN PCSR_API_MSG WaitReplyMessage,
01240     IN PCSR_THREAD WaitingThread,
01241     IN BOOLEAN WaitRoutine
01242     )
01243 {
01244     WCHAR Char;
01245     BOOLEAN CommandLineEditingKeys,EnableScrollMode;
01246     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> KeyState;
01247     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>=STATUS_SUCCESS;
01248     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a;
01249     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01250 <span class="preprocessor">#ifdef FE_SB</span>
01251 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> NumBytes;
01252     ULONG NumToWrite;
01253     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01254 <span class="preprocessor">#endif</span>
01255 <span class="preprocessor"></span>
01256     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;ProcessData,
01257                                         CookedReadData-&gt;HandleIndex,
01258                                         &amp;HandleData
01259                                        );
01260     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01261     a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
01262     <span class="keywordflow">while</span> (CookedReadData-&gt;BytesRead &lt; CookedReadData-&gt;BufferSize) {
01263 
01264         <span class="comment">//</span>
01265         <span class="comment">// this call to GetChar may block.</span>
01266         <span class="comment">//</span>
01267 
01268         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(CookedReadData-&gt;InputInfo,
01269                          &amp;Char,
01270                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01271                          CookedReadData-&gt;Console,
01272                          HandleData,
01273                          WaitReplyMessage,
01274                          <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
01275                          CookedReadData,
01276                          <span class="keyword">sizeof</span>(*CookedReadData),
01277                          WaitRoutine,
01278                          &amp;CommandLineEditingKeys,
01279                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01280                          &amp;EnableScrollMode,
01281                          &amp;KeyState
01282                         );
01283         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01284             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01285                 CookedReadData-&gt;BytesRead = 0;
01286             }
01287             <span class="keywordflow">break</span>;
01288         }
01289 
01290         <span class="comment">//</span>
01291         <span class="comment">// we should probably set these up in GetChars, but we set them</span>
01292         <span class="comment">// up here because the debugger is multi-threaded and calls</span>
01293         <span class="comment">// read before outputting the prompt.</span>
01294         <span class="comment">//</span>
01295 
01296         <span class="keywordflow">if</span> (CookedReadData-&gt;OriginalCursorPosition.X == -1) {
01297             CookedReadData-&gt;OriginalCursorPosition = CookedReadData-&gt;ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
01298         }
01299 
01300         <span class="keywordflow">if</span> (CommandLineEditingKeys) {
01301             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/cmdline_8h.html#a40">ProcessCommandLine</a>(CookedReadData,Char,KeyState,WaitReplyMessage,WaitingThread,WaitRoutine);
01302             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a65">CONSOLE_STATUS_READ_COMPLETE</a> ||
01303                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01304                 <span class="keywordflow">break</span>;
01305             }
01306             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01307                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>) {
01308                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>;
01309                     <span class="keywordflow">if</span> (!WaitRoutine) {
01310                         <span class="comment">//</span>
01311                         <span class="comment">// we have no wait block, so create one.</span>
01312                         <span class="comment">//</span>
01313                         <a class="code" href="../../d0/d7/server_2stream_8c.html#a14">WaitForMoreToRead</a>(CookedReadData-&gt;InputInfo,
01314                                           WaitReplyMessage,
01315                                           <a class="code" href="../../d4/d1/cmdline_8h.html#a58">CookedReadWaitRoutine</a>,
01316                                           CookedReadData,
01317                                           <span class="keyword">sizeof</span>(*CookedReadData),
01318                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01319                                          );
01320                     }
01321                 } <span class="keywordflow">else</span> {
01322                     CookedReadData-&gt;BytesRead = 0;
01323                 }
01324                 <span class="keywordflow">break</span>;
01325             }
01326         } <span class="keywordflow">else</span> {
01327             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/server_2stream_8c.html#a23">ProcessCookedReadInput</a>(CookedReadData,
01328                                        Char,
01329                                        KeyState,
01330                                        &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01331                                       )) {
01332                 CookedReadData-&gt;Console-&gt;Flags |= <a class="code" href="../../d1/d7/server_8h.html#a17">CONSOLE_IGNORE_NEXT_KEYUP</a>;
01333                 <span class="keywordflow">break</span>;
01334             }
01335         }
01336     }
01337 
01338     <span class="comment">//</span>
01339     <span class="comment">// if the read was completed (status != wait), free the cooked read</span>
01340     <span class="comment">// data.  also, close the temporary output handle that was opened to</span>
01341     <span class="comment">// echo the characters read.</span>
01342     <span class="comment">//</span>
01343 
01344     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01345 
01346         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> LineCount=1;
01347         <span class="keywordflow">if</span> (CookedReadData-&gt;Echo) {
01348             BOOLEAN FoundCR;
01349             ULONG i,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
01350             PWCHAR StringPtr;
01351 
01352             <span class="comment">// figure out where real string ends (at carriage return</span>
01353             <span class="comment">// or end of buffer)</span>
01354 
01355             StringPtr = CookedReadData-&gt;BackupLimit;
01356             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = CookedReadData-&gt;BytesRead;
01357             FoundCR = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01358             <span class="keywordflow">for</span> (i=0;i&lt;(CookedReadData-&gt;BytesRead/<span class="keyword">sizeof</span>(WCHAR));i++) {
01359                 <span class="keywordflow">if</span> (*StringPtr++ == <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>) {
01360                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = i*<span class="keyword">sizeof</span>(WCHAR);
01361                     FoundCR = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01362                     <span class="keywordflow">break</span>;
01363                 }
01364             }
01365 
01366             <span class="keywordflow">if</span> (FoundCR) {
01367                 <span class="comment">//</span>
01368                 <span class="comment">// add to command line recall list</span>
01369                 <span class="comment">//</span>
01370 
01371                 <a class="code" href="../../d8/d5/consrv_8h.html#a252">AddCommand</a>(CookedReadData-&gt;CommandHistory,CookedReadData-&gt;BackupLimit,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>,CookedReadData-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a20">CONSOLE_HISTORY_NODUP</a>);
01372 
01373                 <span class="comment">//</span>
01374                 <span class="comment">// check for alias</span>
01375                 <span class="comment">//</span>
01376 
01377                 i = CookedReadData-&gt;BufferSize;
01378                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a251">MatchandCopyAlias</a>(CookedReadData-&gt;Console,
01379                                                  CookedReadData-&gt;BackupLimit,
01380                                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>,
01381                                                  CookedReadData-&gt;BackupLimit,
01382                                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)&amp;i,
01383                                                  CookedReadData-&gt;ExeName,
01384                                                  CookedReadData-&gt;ExeNameLength,
01385                                                  &amp;LineCount
01386                                                 ))) {
01387                   CookedReadData-&gt;BytesRead = i;
01388                 }
01389             }
01390 
01391             <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(WaitingThread),
01392                               CookedReadData-&gt;Console,
01393                               &amp;CookedReadData-&gt;TempHandle,
01394                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01395                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01396                              );
01397         }
01398         WaitReplyMessage-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01399 
01400         <span class="comment">//</span>
01401         <span class="comment">// at this point, a-&gt;NumBytes contains the number of bytes in</span>
01402         <span class="comment">// the UNICODE string read.  UserBufferSize contains the converted</span>
01403         <span class="comment">// size of the app's buffer.</span>
01404         <span class="comment">//</span>
01405 
01406         <span class="keywordflow">if</span> (CookedReadData-&gt;BytesRead &gt; CookedReadData-&gt;UserBufferSize || LineCount &gt; 1) {
01407             <span class="keywordflow">if</span> (LineCount &gt; 1) {
01408                 PWSTR Tmp;
01409                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>;
01410 <span class="preprocessor">#ifdef FE_SB</span>
01411 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console)) {
01412                     <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
01413                         fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01414                         *CookedReadData-&gt;UserBuffer++ = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
01415                         CookedReadData-&gt;UserBufferSize-=<span class="keyword">sizeof</span>(WCHAR);
01416                         RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
01417                     }
01418                     NumBytes = 0;
01419                     <span class="keywordflow">for</span> (Tmp=CookedReadData-&gt;BackupLimit;
01420                          *Tmp!=<a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a> &amp;&amp; CookedReadData-&gt;UserBufferSize/<span class="keyword">sizeof</span>(WCHAR) &gt; NumBytes;
01421                          (IsConsoleFullWidth(CookedReadData-&gt;Console-&gt;hDC,
01422                                              CookedReadData-&gt;Console-&gt;CP,*Tmp) ? NumBytes+=2 : NumBytes++),Tmp++) ;
01423                 }
01424 <span class="preprocessor">#endif</span>
01425 <span class="preprocessor"></span>                <span class="keywordflow">for</span> (Tmp=CookedReadData-&gt;BackupLimit;*Tmp!=<a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;Tmp++)
01426                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tmp&lt;(CookedReadData-&gt;BackupLimit+CookedReadData-&gt;BytesRead));
01427                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = (ULONG)(Tmp-CookedReadData-&gt;BackupLimit+1)*<span class="keyword">sizeof</span>(*Tmp);
01428             } <span class="keywordflow">else</span> {
01429 <span class="preprocessor">#ifdef FE_SB</span>
01430 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console)) {
01431                     PWSTR Tmp;
01432 
01433                     <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
01434                         fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01435                         *CookedReadData-&gt;UserBuffer++ = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
01436                         CookedReadData-&gt;UserBufferSize-=<span class="keyword">sizeof</span>(WCHAR);
01437                         RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
01438                     }
01439                     NumBytes = 0;
01440                     NumToWrite = CookedReadData-&gt;BytesRead;
01441                     <span class="keywordflow">for</span> (Tmp=CookedReadData-&gt;BackupLimit;
01442                          NumToWrite &amp;&amp; CookedReadData-&gt;UserBufferSize/<span class="keyword">sizeof</span>(WCHAR) &gt; NumBytes;
01443                          (IsConsoleFullWidth(CookedReadData-&gt;Console-&gt;hDC,
01444                                              CookedReadData-&gt;Console-&gt;CP,*Tmp) ? NumBytes+=2 : NumBytes++),Tmp++,NumToWrite-=<span class="keyword">sizeof</span>(WCHAR)) ;
01445                 }
01446 <span class="preprocessor">#endif</span>
01447 <span class="preprocessor"></span>                a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = CookedReadData-&gt;UserBufferSize;
01448             }
01449             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> |= <a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>;
01450             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o5">BufPtr</a> = CookedReadData-&gt;BackupLimit;
01451             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o3">BytesAvailable</a> = CookedReadData-&gt;BytesRead - a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>;
01452             HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o4">CurrentBufPtr</a>=(PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)CookedReadData-&gt;BackupLimit+a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
01453             RtlCopyMemory(CookedReadData-&gt;UserBuffer,CookedReadData-&gt;BackupLimit,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
01454         }
01455         <span class="keywordflow">else</span> {
01456 <span class="preprocessor">#ifdef FE_SB</span>
01457 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console)) {
01458                 PWSTR Tmp;
01459 
01460                 <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
01461                     fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01462                     *CookedReadData-&gt;UserBuffer++ = HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
01463                     CookedReadData-&gt;UserBufferSize-=<span class="keyword">sizeof</span>(WCHAR);
01464                     RtlZeroMemory(&amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
01465 
01466                     <span class="keywordflow">if</span> (CookedReadData-&gt;UserBufferSize == 0) {
01467                         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = 1;
01468                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;BackupLimit);
01469                         <span class="keywordflow">return</span> STATUS_SUCCESS;
01470                     }
01471                 }
01472                 NumBytes = 0;
01473                 NumToWrite = CookedReadData-&gt;BytesRead;
01474                 <span class="keywordflow">for</span> (Tmp=CookedReadData-&gt;BackupLimit;
01475                      NumToWrite &amp;&amp; CookedReadData-&gt;UserBufferSize/<span class="keyword">sizeof</span>(WCHAR) &gt; NumBytes;
01476                      (IsConsoleFullWidth(CookedReadData-&gt;Console-&gt;hDC,
01477                                          CookedReadData-&gt;Console-&gt;CP,*Tmp) ? NumBytes+=2 : NumBytes++),Tmp++,NumToWrite-=<span class="keyword">sizeof</span>(WCHAR)) ;
01478             }
01479 <span class="preprocessor">#endif</span>
01480 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = CookedReadData-&gt;BytesRead;
01481             RtlCopyMemory(CookedReadData-&gt;UserBuffer,CookedReadData-&gt;BackupLimit,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
01482             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;BackupLimit);
01483         }
01484         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o9">ControlKeyState</a> = CookedReadData-&gt;ControlKeyState;
01485 
01486         <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a>) {
01487 
01488             <span class="comment">//</span>
01489             <span class="comment">// if ansi, translate string.</span>
01490             <span class="comment">//</span>
01491 
01492             PCHAR TransBuffer;
01493 
01494 <span class="preprocessor">#ifdef FE_SB</span>
01495 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console))
01496                 TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumBytes);
01497             <span class="keywordflow">else</span>
01498 <span class="preprocessor">#endif</span>
01499 <span class="preprocessor"></span>            TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / <span class="keyword">sizeof</span>(WCHAR));
01500             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01501                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01502             }
01503 
01504 <span class="preprocessor">#ifdef FE_SB</span>
01505 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(CookedReadData-&gt;Console))
01506             {
01507                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = <a class="code" href="../../d0/d3/dbcs_8h.html#a53">TranslateUnicodeToOem</a>(CookedReadData-&gt;Console,
01508                                                     CookedReadData-&gt;UserBuffer,
01509                                                     a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR),
01510                                                     TransBuffer,
01511                                                     NumBytes,
01512                                                     &amp;HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ReadConInpDbcsLeadByte);
01513             }
01514             <span class="keywordflow">else</span>
01515 <span class="preprocessor">#endif</span>
01516 <span class="preprocessor"></span>            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(CookedReadData-&gt;Console-&gt;CP,
01517                                  CookedReadData-&gt;UserBuffer,
01518                                  a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR),
01519                                  TransBuffer,
01520                                  a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / sizeof (WCHAR)
01521                                  );
01522             RtlCopyMemory(CookedReadData-&gt;UserBuffer,TransBuffer,a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>);
01523 <span class="preprocessor">#ifdef FE_SB</span>
01524 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (fAddDbcsLead)
01525                 a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>++;
01526 <span class="preprocessor">#endif</span>
01527 <span class="preprocessor"></span>            <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01528         }
01529         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;ExeName);
01530         <span class="keywordflow">if</span> (WaitRoutine) {
01531 <span class="preprocessor">#ifdef FE_SB</span>
01532 <span class="preprocessor"></span>            CookedReadData-&gt;Console-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01533 <span class="preprocessor">#endif</span>
01534 <span class="preprocessor"></span>            <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData);
01535         }
01536     }
01537     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01538 }
01539 
01540 BOOLEAN
<a name="l01541"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a25">01541</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a25">CookedReadWaitRoutine</a>(
01542     IN PLIST_ENTRY WaitQueue,
01543     IN PCSR_THREAD WaitingThread,
01544     IN PCSR_API_MSG WaitReplyMessage,
01545     IN PVOID WaitParameter,
01546     IN PVOID SatisfyParameter1,
01547     IN PVOID SatisfyParameter2,
01548     IN ULONG WaitFlags
01549     )
01550 
01551 <span class="comment">/*++</span>
01552 <span class="comment"></span>
01553 <span class="comment">Routine Description:</span>
01554 <span class="comment"></span>
01555 <span class="comment">    This routine is called to complete a cooked read that blocked in</span>
01556 <span class="comment">    ReadInputBuffer.  The context of the read was saved in the CookedReadData</span>
01557 <span class="comment">    structure.  This routine is called when events have been written to</span>
01558 <span class="comment">    the input buffer.  It is called in the context of the writing thread.</span>
01559 <span class="comment">    It may be called more than once.</span>
01560 <span class="comment"></span>
01561 <span class="comment">Arguments:</span>
01562 <span class="comment"></span>
01563 <span class="comment">    WaitQueue - pointer to queue containing wait block</span>
01564 <span class="comment"></span>
01565 <span class="comment">    WaitingThread - pointer to waiting thread</span>
01566 <span class="comment"></span>
01567 <span class="comment">    WaitReplyMessage - pointer to reply message</span>
01568 <span class="comment"></span>
01569 <span class="comment">    CookedReadData - pointer to data saved in ReadChars</span>
01570 <span class="comment"></span>
01571 <span class="comment">    SatisfyParameter1 - if this routine was called (indirectly) by</span>
01572 <span class="comment">    CloseInputHandle, this argument contains a HandleData pointer of</span>
01573 <span class="comment">    the dying handle.  otherwise, it contains NULL.</span>
01574 <span class="comment"></span>
01575 <span class="comment">    SatisfyParameter2 - if this routine is called because a ctrl-c or</span>
01576 <span class="comment">    ctrl-break was seen, this argument contains CONSOLE_CTRL_SEEN.</span>
01577 <span class="comment">    otherwise it contains NULL.</span>
01578 <span class="comment"></span>
01579 <span class="comment">    WaitFlags - Flags indicating status of wait.</span>
01580 <span class="comment"></span>
01581 <span class="comment">Return Value:</span>
01582 <span class="comment"></span>
01583 <span class="comment">--*/</span>
01584 
01585 
01586 {
01587     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01588     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
01589     <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a> CookedReadData;
01590     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a;
01591     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
01592 
01593     a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
01594     CookedReadData = (<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">PCOOKED_READ_DATA</a>)WaitParameter;
01595 
01596     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a>,
01597                                         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a>,
01598                                         &amp;HandleData
01599                                        );
01600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>));
01602 
01603     <span class="comment">//</span>
01604     <span class="comment">// see if this routine was called by CloseInputHandle.  if it</span>
01605     <span class="comment">// was, see if this wait block corresponds to the dying handle.</span>
01606     <span class="comment">// if it doesn't, just return.</span>
01607     <span class="comment">//</span>
01608 
01609     <span class="keywordflow">if</span> (SatisfyParameter1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01610         SatisfyParameter1 != HandleData) {
01611         <span class="comment">//DbgPrint("CookedReadWaitRoutine exit 1\n");</span>
01612         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01613     }
01614 
01615     Console = CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>;
01616 
01617     <span class="comment">//</span>
01618     <span class="comment">// this routine should be called by a thread owning the same</span>
01619     <span class="comment">// lock on the same console as we're reading from.</span>
01620     <span class="comment">//</span>
01621 
01622     <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
01623     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a>);
01624     HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o1">ReadCount</a> -= 1;
01625     <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
01626 
01627     <span class="comment">//</span>
01628     <span class="comment">// if ctrl-c or ctrl-break was seen, terminate read.</span>
01629     <span class="comment">//</span>
01630 
01631     <span class="keywordflow">if</span> ((ULONG_PTR)SatisfyParameter2 &amp; (<a class="code" href="../../d9/d3/input_8h.html#a23">CONSOLE_CTRL_C_SEEN</a> | <a class="code" href="../../d9/d3/input_8h.html#a24">CONSOLE_CTRL_BREAK_SEEN</a>)) {
01632         <span class="keywordflow">if</span> (CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o14">Echo</a>) {
01633             <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(WaitingThread),
01634                               CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
01635                               &amp;CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o3">TempHandle</a>,
01636                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01637                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01638                              );
01639         }
01640         <span class="comment">//DbgPrint("CookedReadWaitRoutine exit 2\n");</span>
01641         WaitReplyMessage-&gt;ReturnValue = STATUS_ALERTED;
01642         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o10">BackupLimit</a>);
01643         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>);
01644 <span class="preprocessor">#if defined(FE_SB)</span>
01645 <span class="preprocessor"></span>        CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01646 <span class="preprocessor">#endif</span>
01647 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData);
01648         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01649     }
01650 
01651     <span class="comment">//</span>
01652     <span class="comment">// see if called by CsrDestroyProcess or CsrDestroyThread</span>
01653     <span class="comment">// via CsrNotifyWaitBlock.   if so, just decrement the ReadCount</span>
01654     <span class="comment">// and return.</span>
01655     <span class="comment">//</span>
01656 
01657     <span class="keywordflow">if</span> (WaitFlags &amp; CSR_PROCESS_TERMINATING) {
01658         <span class="keywordflow">if</span> (CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o14">Echo</a>) {
01659             <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(WaitingThread),
01660                               CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
01661                               &amp;CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o3">TempHandle</a>,
01662                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01663                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01664                              );
01665         }
01666         <span class="comment">//DbgPrint("CookedReadWaitRoutine exit 3\n");</span>
01667         WaitReplyMessage-&gt;ReturnValue = (ULONG)STATUS_THREAD_IS_TERMINATING;
01668 
01669         <span class="comment">//</span>
01670         <span class="comment">// clean up popup data structures</span>
01671         <span class="comment">//</span>
01672 
01673         <a class="code" href="../../d4/d1/cmdline_8h.html#a52">CleanUpPopups</a>(CookedReadData);
01674         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o10">BackupLimit</a>);
01675         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>);
01676 <span class="preprocessor">#if defined(FE_SB)</span>
01677 <span class="preprocessor"></span>        CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01678 <span class="preprocessor">#endif</span>
01679 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData);
01680         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01681     }
01682 
01683     <span class="comment">//</span>
01684     <span class="comment">// We must see if we were woken up because the handle is being</span>
01685     <span class="comment">// closed.  if so, we decrement the read count.  if it goes to</span>
01686     <span class="comment">// zero, we wake up the close thread.  otherwise, we wake up any</span>
01687     <span class="comment">// other thread waiting for data.</span>
01688     <span class="comment">//</span>
01689 
01690     <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o6">InputReadData</a>-&gt;<a class="code" href="../../d8/d2/struct__INPUT__READ__HANDLE__DATA.html#o2">InputHandleFlags</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a51">HANDLE_CLOSING</a>) {
01691         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SatisfyParameter1 == HandleData);
01692         <span class="keywordflow">if</span> (CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o14">Echo</a>) {
01693             <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a83">CONSOLE_FROMTHREADPERPROCESSDATA</a>(WaitingThread),
01694                               CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>,
01695                               &amp;CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o3">TempHandle</a>,
01696                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01697                               <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01698                              );
01699         }
01700         <span class="comment">//DbgPrint("CookedReadWaitRoutine exit 4\n");</span>
01701         WaitReplyMessage-&gt;ReturnValue = STATUS_ALERTED;
01702 
01703         <span class="comment">//</span>
01704         <span class="comment">// clean up popup data structures</span>
01705         <span class="comment">//</span>
01706 
01707         <a class="code" href="../../d4/d1/cmdline_8h.html#a52">CleanUpPopups</a>(CookedReadData);
01708         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o10">BackupLimit</a>);
01709         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>);
01710 <span class="preprocessor">#if defined(FE_SB)</span>
01711 <span class="preprocessor"></span>        CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01712 <span class="preprocessor">#endif</span>
01713 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData);
01714         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01715     }
01716 
01717     <span class="comment">//</span>
01718     <span class="comment">// if we get to here, this routine was called either by the input</span>
01719     <span class="comment">// thread or a write routine.  both of these callers grab the</span>
01720     <span class="comment">// current console lock.</span>
01721     <span class="comment">//</span>
01722 
01723     <span class="comment">//</span>
01724     <span class="comment">// this routine should be called by a thread owning the same</span>
01725     <span class="comment">// lock on the same console as we're reading from.</span>
01726     <span class="comment">//</span>
01727 
01728     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
01729 
01730     <span class="keywordflow">if</span> (CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a>) {
01731         <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">PCLE_POPUP</a> Popup;
01732         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/cmdline_8h.html#a14">CLE_NO_POPUPS</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a>)) {
01733             Popup = CONTAINING_RECORD( CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a>-&gt;<a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html#o9">PopupList</a>.Flink, <a class="code" href="../../d1/d0/struct__CLE__POPUP.html">CLE_POPUP</a>, ListLink );
01734             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (Popup-&gt;<a class="code" href="../../d1/d0/struct__CLE__POPUP.html#o9">PopupInputRoutine</a>)(CookedReadData,
01735                                                 WaitReplyMessage,
01736                                                 WaitingThread,
01737                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01738             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a65">CONSOLE_STATUS_READ_COMPLETE</a> ||
01739                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a> &amp;&amp;
01740                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a66">CONSOLE_STATUS_WAIT_NO_BLOCK</a>) ) {
01741                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o10">BackupLimit</a>);
01742                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>);
01743 <span class="preprocessor">#if defined(FE_SB)</span>
01744 <span class="preprocessor"></span>                CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a>-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01745 <span class="preprocessor">#endif</span>
01746 <span class="preprocessor"></span>                <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CookedReadData);
01747                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01748             }
01749             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01750         }
01751     }
01752     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> &lt;= <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a> &amp;&amp;
01753         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o7">BytesRead</a> == 0) {
01754         CookedReadData-&gt;<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o5">UserBuffer</a> = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>;
01755     }
01756     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a24">CookedRead</a>(CookedReadData,
01757                         WaitReplyMessage,
01758                         WaitingThread,
01759                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01760                        );
01761 
01762     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
01763         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01764     } <span class="keywordflow">else</span> {
01765         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01766     }
01767 
01768     <span class="comment">//</span>
01769     <span class="comment">// satisfy the unreferenced parameter warnings.</span>
01770     <span class="comment">//</span>
01771 
01772     UNREFERENCED_PARAMETER(WaitQueue);
01773     UNREFERENCED_PARAMETER(SatisfyParameter2);
01774 }
01775 
01776 
01777 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01778"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a26">01778</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a26">ReadChars</a>(
01779     IN <a class="code" href="../../d7/d2/struct__INPUT__INFORMATION.html">PINPUT_INFORMATION</a> InputInfo,
01780     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01781     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
01782     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01783     IN OUT PWCHAR lpBuffer,
01784     IN OUT PDWORD NumBytes,
01785     IN DWORD InitialNumBytes,
01786     IN DWORD CtrlWakeupMask,
01787     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
01788     IN <a class="code" href="../../d9/d7/struct__COMMAND__HISTORY.html">PCOMMAND_HISTORY</a> CommandHistory,
01789     IN PCSR_API_MSG Message OPTIONAL,
01790     IN HANDLE HandleIndex,
01791     IN USHORT ExeNameLength,
01792     IN PWCHAR ExeName,
01793     IN BOOLEAN Unicode
01794     )
01795 
01796 <span class="comment">/*++</span>
01797 <span class="comment"></span>
01798 <span class="comment">Routine Description:</span>
01799 <span class="comment"></span>
01800 <span class="comment">    This routine reads in characters for stream input and does the</span>
01801 <span class="comment">    required processing based on the input mode (line,char,echo).</span>
01802 <span class="comment">    This routine returns UNICODE characters.</span>
01803 <span class="comment"></span>
01804 <span class="comment">Arguments:</span>
01805 <span class="comment"></span>
01806 <span class="comment">    InputInfo - Pointer to input buffer information.</span>
01807 <span class="comment"></span>
01808 <span class="comment">    Console - Pointer to console buffer information.</span>
01809 <span class="comment"></span>
01810 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
01811 <span class="comment"></span>
01812 <span class="comment">    lpBuffer - Pointer to buffer to read into.</span>
01813 <span class="comment"></span>
01814 <span class="comment">    NumBytes - On input, size of buffer.  On output, number of bytes</span>
01815 <span class="comment">    read.</span>
01816 <span class="comment"></span>
01817 <span class="comment">    HandleData - Pointer to handle data structure.</span>
01818 <span class="comment"></span>
01819 <span class="comment">Return Value:</span>
01820 <span class="comment"></span>
01821 <span class="comment">--*/</span>
01822 
01823 {
01824     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01825     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01826     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">HANDLE_DATA</a> TempHandle;
01827     BOOLEAN <a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01828     ULONG NumToWrite;
01829 <span class="preprocessor">#ifdef FE_SB</span>
01830 <span class="preprocessor"></span>    <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;Message-&gt;u.ApiMessageData;
01831     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01832     ULONG NumToBytes;
01833 <span class="preprocessor">#endif</span>
01834 <span class="preprocessor"></span>
01835     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = *NumBytes;
01836     *NumBytes = 0;
01837 
01838     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>) {
01839 
01840         <span class="comment">//</span>
01841         <span class="comment">// if we have leftover input, copy as much fits into the user's</span>
01842         <span class="comment">// buffer and return.  we may have multi line input, if a macro</span>
01843         <span class="comment">// has been defined that contains the $T character.</span>
01844         <span class="comment">//</span>
01845 
01846         <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>) {
01847             PWSTR Tmp;
01848 <span class="preprocessor">#ifdef FE_SB</span>
01849 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(Console)) {
01850 
01851                 <span class="keywordflow">if</span> (HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
01852                     fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01853                     *lpBuffer++ = HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
01854                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>--;
01855                     HandleData-&gt;InputReadData-&gt;BytesAvailable--;
01856                     RtlZeroMemory(&amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
01857                 }
01858                 <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;BytesAvailable == 0 ||
01859                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
01860                     HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp;= ~(<a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a> | <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>);
01861                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData-&gt;BufPtr);
01862                     *NumBytes = 1;
01863                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01864                 }
01865                 <span class="keywordflow">else</span> {
01866                     <span class="keywordflow">for</span> (NumToWrite=0,Tmp=HandleData-&gt;InputReadData-&gt;CurrentBufPtr,NumToBytes=0;
01867                          NumToBytes &lt; HandleData-&gt;InputReadData-&gt;BytesAvailable &amp;&amp; NumToBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>/<span class="keyword">sizeof</span>(WCHAR) &amp;&amp; *Tmp!=<a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01868                          (IsConsoleFullWidth(Console-&gt;hDC,
01869                                              Console-&gt;CP,*Tmp) ? NumToBytes+=2 : NumToBytes++),Tmp++,NumToWrite+=<span class="keyword">sizeof</span>(WCHAR)) ;
01870                 }
01871             }
01872 <span class="preprocessor">#endif</span>
01873 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (NumToWrite=0,Tmp=HandleData-&gt;InputReadData-&gt;CurrentBufPtr;
01874                  NumToWrite &lt; HandleData-&gt;InputReadData-&gt;BytesAvailable &amp;&amp; *Tmp!=<a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>;
01875                  Tmp++,NumToWrite+=<span class="keyword">sizeof</span>(WCHAR)) ;
01876             NumToWrite += <span class="keyword">sizeof</span>(WCHAR);
01877             <span class="keywordflow">if</span> (NumToWrite &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
01878                 NumToWrite = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01879             }
01880         } <span class="keywordflow">else</span> {
01881 <span class="preprocessor">#ifdef FE_SB</span>
01882 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(Console)) {
01883                 PWSTR Tmp;
01884 
01885                 <span class="keywordflow">if</span> (HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
01886                     fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01887                     *lpBuffer++ = HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
01888                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>-=<span class="keyword">sizeof</span>(WCHAR);
01889                     HandleData-&gt;InputReadData-&gt;BytesAvailable-=<span class="keyword">sizeof</span>(WCHAR);
01890                     RtlZeroMemory(&amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
01891                 }
01892                 <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;BytesAvailable == 0) {
01893                     HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp;= ~(<a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a> | <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>);
01894                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData-&gt;BufPtr);
01895                     *NumBytes = 1;
01896                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01897                 }
01898                 <span class="keywordflow">else</span> {
01899                     <span class="keywordflow">for</span> (NumToWrite=0,Tmp=HandleData-&gt;InputReadData-&gt;CurrentBufPtr,NumToBytes=0;
01900                          NumToBytes &lt; HandleData-&gt;InputReadData-&gt;BytesAvailable &amp;&amp; NumToBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>/<span class="keyword">sizeof</span>(WCHAR);
01901                          (IsConsoleFullWidth(Console-&gt;hDC,
01902                                              Console-&gt;CP,*Tmp) ? NumToBytes+=2 : NumToBytes++),Tmp++,NumToWrite+=<span class="keyword">sizeof</span>(WCHAR)) ;
01903                 }
01904             }
01905 <span class="preprocessor">#endif</span>
01906 <span class="preprocessor"></span>            NumToWrite = (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; HandleData-&gt;InputReadData-&gt;BytesAvailable) ?
01907                           <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> : HandleData-&gt;InputReadData-&gt;BytesAvailable;
01908         }
01909         RtlCopyMemory(lpBuffer,HandleData-&gt;InputReadData-&gt;CurrentBufPtr,NumToWrite);
01910         HandleData-&gt;InputReadData-&gt;BytesAvailable-= NumToWrite;
01911         <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;BytesAvailable == 0) {
01912             HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp;= ~(<a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a> | <a class="code" href="../../d1/d7/server_8h.html#a53">HANDLE_MULTI_LINE_INPUT</a>);
01913             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData-&gt;BufPtr);
01914         }
01915         <span class="keywordflow">else</span> {
01916             HandleData-&gt;InputReadData-&gt;CurrentBufPtr=(PWCHAR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)HandleData-&gt;InputReadData-&gt;CurrentBufPtr+NumToWrite);
01917         }
01918         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
01919 
01920             <span class="comment">//</span>
01921             <span class="comment">// if ansi, translate string.  we allocated the capture buffer large</span>
01922             <span class="comment">// enough to handle the translated string.</span>
01923             <span class="comment">//</span>
01924 
01925             PCHAR TransBuffer;
01926 
01927 <span class="preprocessor">#ifdef FE_SB</span>
01928 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console))
01929                 TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),NumToBytes);
01930             <span class="keywordflow">else</span>
01931 <span class="preprocessor">#endif</span>
01932 <span class="preprocessor"></span>            TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),NumToWrite / <span class="keyword">sizeof</span>(WCHAR));
01933             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01934                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01935             }
01936 
01937 <span class="preprocessor">#ifdef FE_SB</span>
01938 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console))
01939             {
01940                 NumToWrite = <a class="code" href="../../d0/d3/dbcs_8h.html#a53">TranslateUnicodeToOem</a>(Console,
01941                                                    lpBuffer,
01942                                                    NumToWrite / <span class="keyword">sizeof</span> (WCHAR),
01943                                                    TransBuffer,
01944                                                    NumToBytes,
01945                                                    &amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte);
01946             }
01947             <span class="keywordflow">else</span>
01948 <span class="preprocessor">#endif</span>
01949 <span class="preprocessor"></span>            NumToWrite = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
01950                                 lpBuffer,
01951                                 NumToWrite / sizeof (WCHAR),
01952                                 TransBuffer,
01953                                 NumToWrite / <span class="keyword">sizeof</span> (WCHAR)
01954                                 );
01955             RtlCopyMemory(lpBuffer,TransBuffer,NumToWrite);
01956 <span class="preprocessor">#ifdef FE_SB</span>
01957 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (fAddDbcsLead)
01958                 NumToWrite++;
01959 <span class="preprocessor">#endif</span>
01960 <span class="preprocessor"></span>            <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01961         }
01962         *NumBytes = NumToWrite;
01963         <span class="keywordflow">return</span> STATUS_SUCCESS;
01964     }
01965 
01966     <span class="comment">//</span>
01967     <span class="comment">// we need to create a temporary handle to the current screen buffer</span>
01968     <span class="comment">// if echo is on.</span>
01969     <span class="comment">//</span>
01970 
01971     <span class="keywordflow">if</span> ((InputInfo-&gt;InputMode &amp; (ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT)) ==
01972         (ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT)) {
01973         HANDLE ActiveScreenHandle;
01974 
01975         <a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01976         ActiveScreenHandle = <a class="code" href="../../d0/d7/server_2stream_8c.html#a16">FindActiveScreenBufferHandle</a>(ProcessData,Console);
01977         <span class="keywordflow">if</span> (ActiveScreenHandle != <a class="code" href="../../d5/d4/rxact_8c.html#a0">INVALID_HANDLE_VALUE</a>) {
01978             TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>;
01979             TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer = Console-&gt;CurrentScreenBuffer;
01980             <span class="keywordflow">if</span> (TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01981                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a0">ConsoleAddShare</a>(GENERIC_WRITE,
01982                                          FILE_SHARE_READ | FILE_SHARE_WRITE,
01983                                          &amp;TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;ShareAccess,
01984                                          &amp;TempHandle
01985                                         );
01986                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01987                     <a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01988                     TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount++;
01989                 }
01990             }
01991         }
01992     }
01993 
01994     <span class="keywordflow">if</span> (InputInfo-&gt;InputMode &amp; ENABLE_LINE_INPUT) {
01995 
01996         <span class="comment">//</span>
01997         <span class="comment">// read in characters until the buffer is full or return is read.</span>
01998         <span class="comment">// since we may wait inside this loop, store all important variables</span>
01999         <span class="comment">// in the read data structure.  if we do wait, a read data structure</span>
02000         <span class="comment">// will be allocated from the heap and its pointer will be stored</span>
02001         <span class="comment">// in the wait block.  the CookedReadData will be copied into the</span>
02002         <span class="comment">// structure.  the data is freed when the read is completed.</span>
02003         <span class="comment">//</span>
02004 
02005         <a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html">COOKED_READ_DATA</a> CookedReadData;
02006         ULONG i;
02007         PWCHAR TempBuffer;
02008         ULONG TempBufferSize;
02009 
02010         <span class="comment">//</span>
02011         <span class="comment">// to emulate OS/2 KbdStringIn, we read into our own big buffer</span>
02012         <span class="comment">// (256 bytes) until the user types enter.  then return as many</span>
02013         <span class="comment">// chars as will fit in the user's buffer.</span>
02014         <span class="comment">//</span>
02015 
02016         TempBufferSize = (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <a class="code" href="../../d0/d7/server_2stream_8c.html#a2">LINE_INPUT_BUFFER_SIZE</a>) ? <a class="code" href="../../d0/d7/server_2stream_8c.html#a2">LINE_INPUT_BUFFER_SIZE</a> : <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
02017         TempBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),TempBufferSize);
02018         <span class="keywordflow">if</span> (TempBuffer==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02019             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a>) {
02020                 <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(ProcessData,
02021                                   Console,
02022                                   &amp;TempHandle,
02023                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02024                                   <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02025                                  );
02026             }
02027             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02028         }
02029 
02030         <span class="comment">//</span>
02031         <span class="comment">// initialize the user's buffer to spaces.  this is done so that</span>
02032         <span class="comment">// moving in the buffer via cursor doesn't do strange things.</span>
02033         <span class="comment">//</span>
02034 
02035         <span class="keywordflow">for</span> (i=0;i&lt;TempBufferSize/<span class="keyword">sizeof</span>(WCHAR);i++) {
02036             TempBuffer[i] = (WCHAR)<span class="charliteral">' '</span>;
02037         }
02038 
02039         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o0">InputInfo</a> = InputInfo;
02040         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o1">ScreenInfo</a> = ScreenInfo;
02041         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o2">Console</a> = Console;
02042         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o3">TempHandle</a>.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a>;
02043         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o3">TempHandle</a>.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer = TempHandle.<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer;
02044         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o6">BufferSize</a> = TempBufferSize;
02045         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o7">BytesRead</a> = 0;
02046         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o8">CurrentPosition</a> = 0;
02047         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o9">BufPtr</a> = TempBuffer;
02048         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o10">BackupLimit</a> = TempBuffer;
02049         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o4">UserBufferSize</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
02050         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o5">UserBuffer</a> = lpBuffer;
02051         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.X = -1;
02052         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.Y = -1;
02053         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o12">NumberOfVisibleChars</a> = 0;
02054         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o22">CtrlWakeupMask</a> = CtrlWakeupMask;
02055         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o13">CommandHistory</a> = CommandHistory;
02056         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o14">Echo</a> = <a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a>;
02057         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o17">InsertMode</a> = Console-&gt;InsertMode;
02058         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o15">Processed</a> = (InputInfo-&gt;InputMode &amp; ENABLE_PROCESSED_INPUT) != 0;
02059         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o16">Line</a> = (InputInfo-&gt;InputMode &amp; ENABLE_LINE_INPUT) != 0;
02060         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o18">ProcessData</a> = ProcessData;
02061         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o19">HandleIndex</a> = HandleIndex;
02062         CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a> = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a12">HISTORY_TAG</a> ),<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>);
02063         <span class="keywordflow">if</span> (InitialNumBytes != 0) {
02064             RtlCopyMemory(CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o9">BufPtr</a>, CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o5">UserBuffer</a>, InitialNumBytes);
02065             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o7">BytesRead</a> += InitialNumBytes;
02066             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o12">NumberOfVisibleChars</a> = (InitialNumBytes / <span class="keyword">sizeof</span>(WCHAR));
02067             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o9">BufPtr</a> += (InitialNumBytes / <span class="keyword">sizeof</span>(WCHAR));
02068             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o8">CurrentPosition</a> = (InitialNumBytes / <span class="keyword">sizeof</span>(WCHAR));
02069             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a> = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
02070             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.X -= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o8">CurrentPosition</a>;
02071 
02072 
02073             <span class="keywordflow">while</span> (CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.X &lt; 0) {
02074                 CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.X += ScreenInfo-&gt;ScreenBufferSize.X;
02075                 CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o11">OriginalCursorPosition</a>.Y -= 1;
02076             }
02077         }
02078         <span class="keywordflow">if</span> (CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>) {
02079             RtlCopyMemory(CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o20">ExeName</a>,ExeName,<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>);
02080             CookedReadData.<a class="code" href="../../d2/d8/struct__COOKED__READ__DATA.html#o21">ExeNameLength</a> = <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>;
02081         }
02082 <span class="preprocessor">#ifdef FE_SB</span>
02083 <span class="preprocessor"></span>        Console-&gt;lpCookedReadData = (PVOID)&amp;CookedReadData;
02084 <span class="preprocessor">#endif</span>
02085 <span class="preprocessor"></span>
02086         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a24">CookedRead</a>(&amp;CookedReadData,
02087                             Message,
02088                             CSR_SERVER_QUERYCLIENTTHREAD(),
02089                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02090                            );
02091 <span class="preprocessor">#ifdef FE_SB</span>
02092 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02093             Console-&gt;lpCookedReadData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02094         }
02095 <span class="preprocessor">#endif</span>
02096 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02097     }
02098 
02099     <span class="comment">//</span>
02100     <span class="comment">// character (raw) mode</span>
02101     <span class="comment">//</span>
02102 
02103     <span class="keywordflow">else</span> {
02104 
02105         <span class="comment">//</span>
02106         <span class="comment">// read at least one character in.  after one character has been</span>
02107         <span class="comment">// read, get any more available characters and return.  the first</span>
02108         <span class="comment">//  call to GetChar may wait.   if we do wait, a read data structure</span>
02109         <span class="comment">// will be allocated from the heap and its pointer will be stored</span>
02110         <span class="comment">// in the wait block.  the RawReadData will be copied into the</span>
02111         <span class="comment">// structure.  the data is freed when the read is completed.</span>
02112         <span class="comment">//</span>
02113 
02114         <a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html">RAW_READ_DATA</a> RawReadData;
02115 
02116         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o0">InputInfo</a> = InputInfo;
02117         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o1">Console</a> = Console;
02118         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o2">BufferSize</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
02119         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o3">BufPtr</a> = lpBuffer;
02120         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o4">ProcessData</a> = ProcessData;
02121         RawReadData.<a class="code" href="../../d6/d2/struct__RAW__READ__DATA.html#o5">HandleIndex</a> = HandleIndex;
02122         <span class="keywordflow">if</span> (*NumBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02123             PWCHAR pwchT;
02124 
02125 <span class="preprocessor">#ifdef FE_SB</span>
02126 <span class="preprocessor"></span>            PWCHAR lpBufferTmp = lpBuffer;
02127 
02128             NumToWrite = 0;
02129             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> &amp;&amp; CONSOLE_IS_DBCS_CP(Console)) {
02130                 <span class="keywordflow">if</span> (HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar) {
02131                     fAddDbcsLead = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02132                     *lpBuffer++ = HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte.Event.KeyEvent.uChar.AsciiChar;
02133                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>-=<span class="keyword">sizeof</span>(WCHAR);
02134                     RtlZeroMemory(&amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte,<span class="keyword">sizeof</span>(INPUT_RECORD));
02135                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02136                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
02137                         *NumBytes = 1;
02138                         <span class="keywordflow">return</span> STATUS_SUCCESS;
02139                     }
02140                 }
02141                 <span class="keywordflow">else</span>{
02142                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(InputInfo,
02143                              lpBuffer,
02144                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02145                              Console,
02146                              HandleData,
02147                              Message,
02148                              <a class="code" href="../../d0/d7/server_2stream_8c.html#a20">RawReadWaitRoutine</a>,
02149                              &amp;RawReadData,
02150                              <span class="keyword">sizeof</span>(RawReadData),
02151                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02152                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02153                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02154                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02155                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02156                             );
02157                 }
02158             }
02159             <span class="keywordflow">else</span>
02160 <span class="preprocessor">#endif</span>
02161 <span class="preprocessor"></span>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(InputInfo,
02162                              lpBuffer,
02163                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02164                              Console,
02165                              HandleData,
02166                              Message,
02167                              <a class="code" href="../../d0/d7/server_2stream_8c.html#a20">RawReadWaitRoutine</a>,
02168                              &amp;RawReadData,
02169                              <span class="keyword">sizeof</span>(RawReadData),
02170                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02171                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02172                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02173                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02174                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02175                             );
02176 
02177             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02178                 *NumBytes = 0;
02179                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02180             }
02181 <span class="preprocessor">#ifdef FE_SB</span>
02182 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (! fAddDbcsLead) {
02183                 IsConsoleFullWidth(Console-&gt;hDC,
02184                                    Console-&gt;CP,*lpBuffer) ? *NumBytes+=2 : ++*NumBytes;
02185                 NumToWrite+=<span class="keyword">sizeof</span>(WCHAR);
02186                 lpBuffer++;
02187             }
02188             <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console)) {
02189                 <span class="keywordflow">while</span> (NumToWrite &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02190                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(InputInfo,lpBuffer,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02191                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02192                         <span class="keywordflow">return</span> STATUS_SUCCESS;
02193                     }
02194                     IsConsoleFullWidth(Console-&gt;hDC,
02195                                        Console-&gt;CP,*lpBuffer) ? *NumBytes+=2 : ++*NumBytes;
02196                     lpBuffer++;
02197                     NumToWrite+=<span class="keyword">sizeof</span>(WCHAR);
02198                 }
02199             }
02200             <span class="keywordflow">else</span>{
02201 <span class="preprocessor">#endif</span>
02202 <span class="preprocessor"></span>            pwchT = lpBuffer + 1;
02203             *NumBytes += <span class="keyword">sizeof</span>(WCHAR);
02204             <span class="keywordflow">while</span> (*NumBytes &lt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
02205                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a19">GetChar</a>(InputInfo,pwchT,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02206                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02207                     <span class="keywordflow">break</span>;
02208                 }
02209                 pwchT++;
02210                 *NumBytes += <span class="keyword">sizeof</span>(WCHAR);
02211             }
02212 <span class="preprocessor">#ifdef FE_SB</span>
02213 <span class="preprocessor"></span>            }
02214 <span class="preprocessor">#endif</span>
02215 <span class="preprocessor"></span>
02216             <span class="comment">//</span>
02217             <span class="comment">// if ansi, translate string.  we allocated the capture buffer large</span>
02218             <span class="comment">// enough to handle the translated string.</span>
02219             <span class="comment">//</span>
02220 
02221             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>) {
02222 
02223                 PCHAR TransBuffer;
02224 
02225                 TransBuffer = (PCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),*NumBytes / <span class="keyword">sizeof</span>(WCHAR));
02226                 <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02227                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02228                 }
02229 
02230 <span class="preprocessor">#ifdef FE_SB</span>
02231 <span class="preprocessor"></span>                lpBuffer = lpBufferTmp;
02232                 <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_CP(Console))
02233                 {
02234                     *NumBytes = <a class="code" href="../../d0/d3/dbcs_8h.html#a53">TranslateUnicodeToOem</a>(Console,
02235                                                       lpBuffer,
02236                                                       NumToWrite / <span class="keyword">sizeof</span> (WCHAR),
02237                                                       TransBuffer,
02238                                                       *NumBytes,
02239                                                       &amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadConInpDbcsLeadByte);
02240                 }
02241                 <span class="keywordflow">else</span>
02242 <span class="preprocessor">#endif</span>
02243 <span class="preprocessor"></span>                *NumBytes = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(Console-&gt;CP,
02244                                    lpBuffer,
02245                                    *NumBytes / sizeof (WCHAR),
02246                                    TransBuffer,
02247                                    *NumBytes / <span class="keyword">sizeof</span> (WCHAR)
02248                                    );
02249                 RtlCopyMemory(lpBuffer,TransBuffer,*NumBytes);
02250 <span class="preprocessor">#ifdef FE_SB</span>
02251 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (fAddDbcsLead)
02252                     ++*NumBytes;
02253 <span class="preprocessor">#endif</span>
02254 <span class="preprocessor"></span>                <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
02255             }
02256         }
02257     }
02258     <span class="keywordflow">return</span> STATUS_SUCCESS;
02259 }
02260 
02261 
02262 ULONG
<a name="l02263"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a27">02263</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a27">SrvReadConsole</a>(
02264     IN OUT PCSR_API_MSG m,
02265     IN OUT PCSR_REPLY_STATUS ReplyStatus
02266     )
02267 
02268 <span class="comment">/*++</span>
02269 <span class="comment"></span>
02270 <span class="comment">Routine Description:</span>
02271 <span class="comment"></span>
02272 <span class="comment">    This routine reads characters from the input stream.</span>
02273 <span class="comment"></span>
02274 <span class="comment">Arguments:</span>
02275 <span class="comment"></span>
02276 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
02277 <span class="comment"></span>
02278 <span class="comment">Return Value:</span>
02279 <span class="comment"></span>
02280 <span class="comment">--*/</span>
02281 
02282 {
02283     <a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a> a = (<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html">PCONSOLE_READCONSOLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02284     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02285     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02287     PWCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
02288     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
02289 
02290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o0">ConsoleHandle</a>,
02291                          &amp;Console
02292                         );
02293     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02294         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02295     }
02296 
02297     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
02298     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(ProcessData,
02299                                  a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o1">InputHandle</a>,
02300                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>,
02301                                  GENERIC_READ,
02302                                  &amp;HandleData
02303                                 );
02304     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02305         a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> = 0;
02306     } <span class="keywordflow">else</span> {
02307 
02308         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a> &lt;= <a class="code" href="../../d9/d9/tcmpmem_8c.html#a0">BUFFER_SIZE</a>) {
02309             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>;
02310         }
02311         <span class="keywordflow">else</span> {
02312             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o4">BufPtr</a>;
02313             <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o4">BufPtr</a>, a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o6">CaptureBufferSize</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
02314                 <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02315                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02316             }
02317         }
02318 
02319 <span class="preprocessor">#if defined(FE_SB)</span>
02320 <span class="preprocessor"></span>        Console-&gt;ReadConInpNumBytesTemp = a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a> / <span class="keyword">sizeof</span>(WCHAR);
02321 <span class="preprocessor">#endif</span>
02322 <span class="preprocessor"></span>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a26">ReadChars</a>(HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer,
02323                            Console,
02324                            ProcessData,
02325                            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>,
02326                            <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
02327                            &amp;a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o5">NumBytes</a>,
02328                            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o7">InitialNumBytes</a>,
02329                            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o8">CtrlWakeupMask</a>,
02330                            HandleData,
02331                            <a class="code" href="../../d3/d1/server_2cmdline_8c.html#a74">FindCommandHistory</a>(Console,<a class="code" href="../../d1/d7/server_8h.html#a79">CONSOLE_CLIENTPROCESSHANDLE</a>()),
02332                            m,
02333                            <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o1">InputHandle</a>),
02334                            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o2">ExeNameLength</a>,
02335                            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o3">Buffer</a>,
02336                            a-&gt;<a class="code" href="../../d3/d4/struct__CONSOLE__READCONSOLE__MSG.html#o10">Unicode</a>
02337                           );
02338         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02339             *ReplyStatus = CsrReplyPending;
02340         }
02341     }
02342     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02343     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02344 }
02345 
02346 
02347 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02348"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a28">02348</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a28">MakeCursorVisible</a>(
02349     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02350     IN COORD CursorPosition
02351     )
02352 {
02353     COORD WindowOrigin;
02354     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02355 
02356     WindowOrigin.X = 0;
02357     WindowOrigin.Y = 0;
02358     <span class="keywordflow">if</span> (CursorPosition.X &gt; ScreenInfo-&gt;Window.Right) {
02359         WindowOrigin.X = CursorPosition.X - ScreenInfo-&gt;Window.Right;
02360     }
02361     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CursorPosition.X &lt; ScreenInfo-&gt;Window.Left) {
02362         WindowOrigin.X = CursorPosition.X - ScreenInfo-&gt;Window.Left;
02363     }
02364     <span class="keywordflow">if</span> (CursorPosition.Y &gt; ScreenInfo-&gt;Window.Bottom) {
02365         WindowOrigin.Y = CursorPosition.Y - ScreenInfo-&gt;Window.Bottom;
02366     }
02367     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CursorPosition.Y &lt; ScreenInfo-&gt;Window.Top) {
02368         WindowOrigin.Y = CursorPosition.Y - ScreenInfo-&gt;Window.Top;
02369     }
02370     <span class="keywordflow">if</span> (WindowOrigin.X != 0 || WindowOrigin.Y != 0) {
02371         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a66">SetWindowOrigin</a>(ScreenInfo,
02372                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02373                                WindowOrigin
02374                               );
02375         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02376             <span class="keywordflow">return</span>;
02377         }
02378     }
02379 }
02380 
<a name="l02381"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a8">02381</a> <span class="preprocessor">#define WRITE_NO_CR_LF 0</span>
<a name="l02382"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a9">02382</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITE_CR 1</span>
<a name="l02383"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a10">02383</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITE_CR_LF 2</span>
<a name="l02384"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a11">02384</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITE_SPECIAL_CHARS 4</span>
<a name="l02385"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a12">02385</a> <span class="preprocessor"></span><span class="preprocessor">#define WRITE_UNICODE_CRLF 0x000a000d</span>
02386 <span class="preprocessor"></span>
02387 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l02388"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a29">02388</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a29">FastStreamWrite</a>(
02389     IN PWCHAR lpString,
02390     IN DWORD NumChars
02391     )
02392 
02393 <span class="comment">/*++</span>
02394 <span class="comment"></span>
02395 <span class="comment">Routine Description:</span>
02396 <span class="comment"></span>
02397 <span class="comment">    This routine determines whether the text string contains characters</span>
02398 <span class="comment">    that require special processing.  If it doesn't,</span>
02399 <span class="comment">    unicode characters.  The string is also copied to the input buffer, if</span>
02400 <span class="comment">    the output mode is line mode.</span>
02401 <span class="comment"></span>
02402 <span class="comment">Arguments:</span>
02403 <span class="comment"></span>
02404 <span class="comment">    lpString - Pointer to string to write.</span>
02405 <span class="comment"></span>
02406 <span class="comment">    NumChars - Number of chars in buffer.</span>
02407 <span class="comment"></span>
02408 <span class="comment">Return Value:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    WRITE_SPECIAL_CHARS - string contains characters requiring special processing</span>
02411 <span class="comment"></span>
02412 <span class="comment">    WRITE_NO_CR_LF - string contains no special chars and no CRLF</span>
02413 <span class="comment"></span>
02414 <span class="comment">    WRITE_CR_LF - string contains no special chars and is terminated by CRLF</span>
02415 <span class="comment"></span>
02416 <span class="comment">    WRITE_CR - string contains no special chars and is terminated by CR</span>
02417 <span class="comment"></span>
02418 <span class="comment">--*/</span>
02419 
02420 {
02421     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> UNALIGNED *Tmp;
02422     <span class="keyword">register</span> PWCHAR StrPtr=lpString;
02423     <span class="keywordflow">while</span> (NumChars) {
02424         <span class="keywordflow">if</span> (*StrPtr &lt; <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>) {
02425             Tmp = (PDWORD)StrPtr;
02426             <span class="keywordflow">if</span> (NumChars == 2 &amp;&amp;
02427                 *Tmp == <a class="code" href="../../d0/d7/server_2stream_8c.html#a12">WRITE_UNICODE_CRLF</a>) {
02428                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a10">WRITE_CR_LF</a>;
02429             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NumChars == 1 &amp;&amp;
02430                 *StrPtr == (WCHAR)<span class="charliteral">'\r'</span>) {
02431                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a9">WRITE_CR</a>;
02432             } <span class="keywordflow">else</span> {
02433                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a11">WRITE_SPECIAL_CHARS</a>;
02434             }
02435         }
02436         StrPtr++;
02437         NumChars--;
02438     }
02439     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/server_2stream_8c.html#a8">WRITE_NO_CR_LF</a>;
02440 }
02441 
<a name="l02442"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a30">02442</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a30">UnblockWriteConsole</a>(
02443     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02444     IN DWORD Reason)
02445 {
02446     Console-&gt;Flags &amp;= ~Reason;
02447 
02448     <span class="keywordflow">if</span> ((Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a25">CONSOLE_SUSPENDED</a> | <a class="code" href="../../d1/d7/server_8h.html#a4">CONSOLE_SELECTING</a> | <a class="code" href="../../d1/d7/server_8h.html#a21">CONSOLE_SCROLLBAR_TRACKING</a>)) == 0) {
02449         <span class="comment">/*</span>
02450 <span class="comment">         * no remain reason to suspend output, so unblock it.</span>
02451 <span class="comment">         */</span>
02452         <span class="keywordflow">if</span> (CsrNotifyWait(&amp;Console-&gt;OutputQueue, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02453             <span class="comment">// #334370 under stress, WaitQueue may already hold the satisfied waits</span>
02454             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Console-&gt;WaitQueue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02455                     (Console-&gt;WaitQueue == &amp;Console-&gt;OutputQueue));
02456             Console-&gt;WaitQueue = &amp;Console-&gt;OutputQueue;
02457         }
02458     }
02459 }
02460 
02461 
02462 ULONG
<a name="l02463"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a31">02463</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a31">SrvWriteConsole</a>(
02464     IN OUT PCSR_API_MSG m,
02465     IN OUT PCSR_REPLY_STATUS ReplyStatus
02466     )
02467 
02468 <span class="comment">/*++</span>
02469 <span class="comment"></span>
02470 <span class="comment">Routine Description:</span>
02471 <span class="comment"></span>
02472 <span class="comment">    This routine writes characters to the output stream.</span>
02473 <span class="comment"></span>
02474 <span class="comment">Arguments:</span>
02475 <span class="comment"></span>
02476 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
02477 <span class="comment"></span>
02478 <span class="comment">Return Value:</span>
02479 <span class="comment"></span>
02480 <span class="comment">--*/</span>
02481 
02482 {
02483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02484     <a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a> a = (<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02485     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02486     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02487 
02488     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o0">ConsoleHandle</a>,
02489                          &amp;Console
02490                         );
02491     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02492         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02493     }
02494 
02495     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o6">BufferInMessage</a>) {
02496         <span class="keywordflow">if</span> (!CsrValidateMessageBuffer(m, &amp;a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o3">BufPtr</a>, a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>))) {
02497             <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02498             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02499         }
02500     }
02501     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> &gt; <span class="keyword">sizeof</span>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o2">Buffer</a>)) {
02502         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02503         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02504     }
02505 
02506 
02507     <span class="comment">//</span>
02508     <span class="comment">// Make sure we have a valid screen buffer.</span>
02509     <span class="comment">//</span>
02510 
02511     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a31">DereferenceIoHandle</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02512                                  a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o1">OutputHandle</a>,
02513                                  <a class="code" href="../../d5/d5/conmsg_8h.html#a1">CONSOLE_OUTPUT_HANDLE</a>,
02514                                  GENERIC_WRITE,
02515                                  &amp;HandleData
02516                                 );
02517     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02518         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02519         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02520     }
02521 
02522     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a1">DoSrvWriteConsole</a>(m,ReplyStatus,Console,HandleData);
02523 
02524     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02525     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02526 }
02527 
02528 BOOLEAN
<a name="l02529"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a15">02529</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a15">WriteConsoleWaitRoutine</a>(
02530     IN PLIST_ENTRY WaitQueue,
02531     IN PCSR_THREAD WaitingThread,
02532     IN PCSR_API_MSG WaitReplyMessage,
02533     IN PVOID WaitParameter,
02534     IN PVOID SatisfyParameter1,
02535     IN PVOID SatisfyParameter2,
02536     IN ULONG WaitFlags
02537     )
02538 {
02539     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02540     <a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a> a = (<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html">PCONSOLE_WRITECONSOLE_MSG</a>)&amp;WaitReplyMessage-&gt;u.ApiMessageData;
02541     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02542 
02543     <span class="keywordflow">if</span> (WaitFlags &amp; CSR_PROCESS_TERMINATING) {
02544         WaitReplyMessage-&gt;ReturnValue = (ULONG)STATUS_THREAD_IS_TERMINATING;
02545         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02546     }
02547     <a class="code" href="../../d8/d5/consrv_8h.html#a40">LockConsoleHandleTable</a>();
02548     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a11">DereferenceConsoleHandle</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o0">ConsoleHandle</a>,
02549                                       &amp;Console
02550                                      );
02551     <a class="code" href="../../d8/d5/consrv_8h.html#a41">UnlockConsoleHandleTable</a>();
02552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02553 
02554     <span class="comment">//</span>
02555     <span class="comment">// if we get to here, this routine was called by the input</span>
02556     <span class="comment">// thread, which grabs the current console lock.</span>
02557     <span class="comment">//</span>
02558 
02559     <span class="comment">//</span>
02560     <span class="comment">// this routine should be called by a thread owning the same</span>
02561     <span class="comment">// lock on the same console as we're reading from.</span>
02562     <span class="comment">//</span>
02563 
02564     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d7/server_8h.html#a63">ConsoleLocked</a>(Console));
02565 
02566     <span class="comment">//</span>
02567     <span class="comment">// if we're unicode, the string may still be in the message buffer.</span>
02568     <span class="comment">// since the message was reallocated and copied when the wait was</span>
02569     <span class="comment">// created, we need to fix up a-&gt;TransBuffer here.</span>
02570     <span class="comment">//</span>
02571 
02572     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a> &amp;&amp; a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o6">BufferInMessage</a>) {
02573         a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a> = a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o2">Buffer</a>;
02574     }
02575 
02576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/dispatch_8h.html#a8">DoWriteConsole</a>(WaitReplyMessage,Console,WaitingThread);
02577     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d1/d7/server_8h.html#a64">CONSOLE_STATUS_WAIT</a>) {
02578         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02579     }
02580     <span class="keywordflow">if</span> (!a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o7">Unicode</a>) {
02581 <span class="preprocessor">#ifdef FE_SB</span>
02582 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(Console))
02583         {
02584             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> == Console-&gt;WriteConOutNumBytesUnicode)
02585                 a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> = Console-&gt;WriteConOutNumBytesTemp;
02586             <span class="keywordflow">else</span>
02587                 a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> /= <span class="keyword">sizeof</span>(WCHAR);
02588             }
02589         <span class="keywordflow">else</span>
02590 <span class="preprocessor">#endif</span>
02591 <span class="preprocessor"></span>        a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o4">NumBytes</a> /= <span class="keyword">sizeof</span>(WCHAR);
02592         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(a-&gt;<a class="code" href="../../d4/d7/struct__CONSOLE__WRITECONSOLE__MSG.html#o5">TransBuffer</a>);
02593     }
02594     WaitReplyMessage-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02595     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02596     UNREFERENCED_PARAMETER(WaitQueue);
02597     UNREFERENCED_PARAMETER(WaitParameter);
02598     UNREFERENCED_PARAMETER(SatisfyParameter1);
02599     UNREFERENCED_PARAMETER(SatisfyParameter2);
02600 }
02601 
02602 ULONG
<a name="l02603"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a32">02603</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a32">SrvDuplicateHandle</a>(
02604     IN OUT PCSR_API_MSG m,
02605     IN OUT PCSR_REPLY_STATUS ReplyStatus
02606     )
02607 
02608 <span class="comment">/*++</span>
02609 <span class="comment"></span>
02610 <span class="comment">Routine Description:</span>
02611 <span class="comment"></span>
02612 <span class="comment">    This routine duplicates an input or output handle.</span>
02613 <span class="comment"></span>
02614 <span class="comment">Arguments:</span>
02615 <span class="comment"></span>
02616 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
02617 <span class="comment"></span>
02618 <span class="comment">Return Value:</span>
02619 <span class="comment"></span>
02620 <span class="comment">--*/</span>
02621 
02622 {
02623     <a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html">PCONSOLE_DUPHANDLE_MSG</a> a = (<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html">PCONSOLE_DUPHANDLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02624     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02625     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> SourceHandleData,TargetHandleData;
02626     <a class="code" href="../../d8/d6/struct__CONSOLE__SHARE__ACCESS.html">PCONSOLE_SHARE_ACCESS</a> ShareAccess;
02627     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02628     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
02629 
02630     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o0">ConsoleHandle</a>,
02631                          &amp;Console
02632                         );
02633     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02634         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02635     }
02636     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
02637     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
02638                                  <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o1">SourceHandle</a>),
02639                                  &amp;SourceHandleData
02640                                 );
02641     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02642         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02643     }
02644     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o4">Options</a> &amp; DUPLICATE_SAME_ACCESS) {
02645         a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o2">DesiredAccess</a> = SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o1">Access</a>;
02646     }
02647 
02648     <span class="comment">//</span>
02649     <span class="comment">// make sure that requested access is a subset of source handle's access</span>
02650     <span class="comment">//</span>
02651 
02652     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o2">DesiredAccess</a> &amp; SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o1">Access</a>) != a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o2">DesiredAccess</a>) {
02653         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02654         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02655     }
02656     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a28">AllocateIoHandle</a>(ProcessData,
02657                               SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a>,
02658                               &amp;a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>
02659                              );
02660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02661         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02662     }
02663 
02664     <span class="comment">//</span>
02665     <span class="comment">// it's possible that AllocateIoHandle realloced the handle table,</span>
02666     <span class="comment">// so deference SourceHandle again.</span>
02667     <span class="comment">//</span>
02668 
02669     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
02670                                  <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o1">SourceHandle</a>),
02671                                  &amp;SourceHandleData
02672                                 );
02673     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02674     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02675         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02676     }
02677     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
02678                                  a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>,
02679                                  &amp;TargetHandleData
02680                                 );
02681     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02682     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02683         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,
02684                      a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>
02685                     );
02686         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02687     }
02688     <span class="keywordflow">if</span> (SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
02689         <span class="comment">// grab input lock</span>
02690         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a27">InitializeInputHandle</a>(TargetHandleData,
02691                                    SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer)) {
02692             <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,
02693                          a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>
02694                         );
02695             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02696             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02697         }
02698         ShareAccess = &amp;SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;ShareAccess;
02699     }
02700     <span class="keywordflow">else</span> {
02701         <span class="comment">// grab output lock</span>
02702         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a26">InitializeOutputHandle</a>(TargetHandleData,SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer);
02703         ShareAccess = &amp;SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;ShareAccess;
02704     }
02705     TargetHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> = SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a>;
02706     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o3">InheritHandle</a>) {
02707         TargetHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
02708     } <span class="keywordflow">else</span> {
02709         TargetHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
02710     }
02711 
02712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a1">ConsoleDupShare</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o2">DesiredAccess</a>,
02713                              SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o2">ShareAccess</a>,
02714                              ShareAccess,
02715                              TargetHandleData
02716                             );
02717     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02718         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,
02719                      a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>
02720                     );
02721         <span class="keywordflow">if</span> (SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>) {
02722             SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.InputBuffer-&gt;RefCount--;
02723         }
02724         <span class="keywordflow">else</span> {
02725             SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o5">Buffer</a>.ScreenBuffer-&gt;RefCount--;
02726         }
02727     }
02728     <span class="keywordflow">else</span> {
02729         a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a> = <a class="code" href="../../d1/d7/server_8h.html#a57">INDEX_TO_HANDLE</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o5">TargetHandle</a>);
02730     }
02731 
02732     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o4">Options</a> &amp; DUPLICATE_CLOSE_SOURCE) {
02733         <span class="keywordflow">if</span> (SourceHandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>)
02734             <a class="code" href="../../d0/d7/server_2stream_8c.html#a35">CloseInputHandle</a>(ProcessData,Console,SourceHandleData,<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o1">SourceHandle</a>));
02735         <span class="keywordflow">else</span> {
02736             <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(ProcessData,Console,SourceHandleData,<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d0/d0/struct__CONSOLE__DUPHANDLE__MSG.html#o1">SourceHandle</a>),<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02737         }
02738     }
02739 
02740 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02741     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02742     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02743     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02744 }
02745 
02746 ULONG
<a name="l02747"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a33">02747</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a33">SrvGetHandleInformation</a>(
02748     IN OUT PCSR_API_MSG m,
02749     IN OUT PCSR_REPLY_STATUS ReplyStatus
02750     )
02751 
02752 <span class="comment">/*++</span>
02753 <span class="comment"></span>
02754 <span class="comment">Routine Description:</span>
02755 <span class="comment"></span>
02756 <span class="comment">    This gets information about an input or output handle.</span>
02757 <span class="comment"></span>
02758 <span class="comment">Arguments:</span>
02759 <span class="comment"></span>
02760 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
02761 <span class="comment"></span>
02762 <span class="comment">Return Value:</span>
02763 <span class="comment"></span>
02764 <span class="comment">--*/</span>
02765 
02766 {
02767     <a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html">PCONSOLE_GETHANDLEINFORMATION_MSG</a> a = (<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html">PCONSOLE_GETHANDLEINFORMATION_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02768     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02769     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02770     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02771 
02772     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o0">ConsoleHandle</a>,
02773                          &amp;Console
02774                         );
02775     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02776         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02777     }
02778     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02779                                  <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o1">Handle</a>),
02780                                  &amp;HandleData
02781                                 );
02782     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02783         a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o2">Flags</a> = 0;
02784         <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>) {
02785             a-&gt;<a class="code" href="../../d0/d2/struct__CONSOLE__GETHANDLEINFORMATION__MSG.html#o2">Flags</a> |= HANDLE_FLAG_INHERIT;
02786         }
02787     }
02788     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02789     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02790     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02791 }
02792 
02793 ULONG
<a name="l02794"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a34">02794</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a34">SrvSetHandleInformation</a>(
02795     IN OUT PCSR_API_MSG m,
02796     IN OUT PCSR_REPLY_STATUS ReplyStatus
02797     )
02798 
02799 <span class="comment">/*++</span>
02800 <span class="comment"></span>
02801 <span class="comment">Routine Description:</span>
02802 <span class="comment"></span>
02803 <span class="comment">    This sets information about an input or output handle.</span>
02804 <span class="comment"></span>
02805 <span class="comment">Arguments:</span>
02806 <span class="comment"></span>
02807 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
02808 <span class="comment"></span>
02809 <span class="comment">Return Value:</span>
02810 <span class="comment"></span>
02811 <span class="comment">--*/</span>
02812 
02813 {
02814     <a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html">PCONSOLE_SETHANDLEINFORMATION_MSG</a> a = (<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html">PCONSOLE_SETHANDLEINFORMATION_MSG</a>)&amp;m-&gt;u.ApiMessageData;
02815     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
02816     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
02817     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02818 
02819     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o0">ConsoleHandle</a>,
02820                          &amp;Console
02821                         );
02822     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02823         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02824     }
02825     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(<a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>(),
02826                                  <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o1">Handle</a>),
02827                                  &amp;HandleData
02828                                 );
02829     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02830         <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o2">Mask</a> &amp; HANDLE_FLAG_INHERIT) {
02831             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../d7/d5/struct__CONSOLE__SETHANDLEINFORMATION__MSG.html#o3">Flags</a> &amp; HANDLE_FLAG_INHERIT) {
02832                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> |= <a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
02833             } <span class="keywordflow">else</span> {
02834                 HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a49">CONSOLE_INHERITABLE</a>;
02835             }
02836         }
02837     }
02838     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
02839     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02840     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
02841 }
02842 
02843 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02844"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a35">02844</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a35">CloseInputHandle</a>(
02845     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
02846     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02847     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
02848     IN HANDLE Handle
02849     )
02850 
02851 <span class="comment">/*++</span>
02852 <span class="comment"></span>
02853 <span class="comment">Routine Description:</span>
02854 <span class="comment"></span>
02855 <span class="comment">    This routine closes an input handle.  It decrements the input buffer's</span>
02856 <span class="comment">    reference count.  If it goes to zero, the buffer is reinitialized.</span>
02857 <span class="comment">    Otherwise, the handle is removed from sharing.</span>
02858 <span class="comment"></span>
02859 <span class="comment">Arguments:</span>
02860 <span class="comment"></span>
02861 <span class="comment">    ProcessData - Pointer to per process data.</span>
02862 <span class="comment"></span>
02863 <span class="comment">    HandleData - Pointer to handle data structure.</span>
02864 <span class="comment"></span>
02865 <span class="comment">    Handle - Handle to close.</span>
02866 <span class="comment"></span>
02867 <span class="comment">Return Value:</span>
02868 <span class="comment"></span>
02869 <span class="comment">Note:</span>
02870 <span class="comment"></span>
02871 <span class="comment">    The console lock must be held when calling this routine.</span>
02872 <span class="comment"></span>
02873 <span class="comment">--*/</span>
02874 
02875 {
02876     BOOLEAN WaitSatisfied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02877 
02878     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
02879     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp; <a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>) {
02880         HandleData-&gt;InputReadData-&gt;InputHandleFlags &amp;= ~<a class="code" href="../../d1/d7/server_8h.html#a52">HANDLE_INPUT_PENDING</a>;
02881         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(HandleData-&gt;InputReadData-&gt;BufPtr);
02882     }
02883 
02884     <span class="comment">//</span>
02885     <span class="comment">// see if there are any reads waiting for data via this handle.  if</span>
02886     <span class="comment">// there are, wake them up.  there aren't any other outstanding i/o</span>
02887     <span class="comment">// operations via this handle because the console lock is held.</span>
02888     <span class="comment">//</span>
02889 
02890     <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
02891     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;ReadCount != 0) {
02892         <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
02893         HandleData-&gt;InputReadData-&gt;InputHandleFlags |= <a class="code" href="../../d1/d7/server_8h.html#a51">HANDLE_CLOSING</a>;
02894 
02895         WaitSatisfied |= CsrNotifyWait(&amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadWaitQueue,
02896                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02897                       (PVOID) HandleData,
02898                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02899                      );
02900         <a class="code" href="../../d9/d3/input_8h.html#a25">LockReadCount</a>(HandleData);
02901     }
02902     <span class="keywordflow">if</span> (WaitSatisfied) {
02903         <span class="comment">// #334370 under stress, WaitQueue may already hold the satisfied waits</span>
02904         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Console-&gt;WaitQueue == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02905                 (Console-&gt;WaitQueue == &amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadWaitQueue));
02906         Console-&gt;WaitQueue = &amp;HandleData-&gt;Buffer.InputBuffer-&gt;ReadWaitQueue;
02907     }
02908     <span class="keywordflow">if</span> (HandleData-&gt;InputReadData-&gt;ReadCount != 0) {
02909         KdPrint((<span class="stringliteral">"ReadCount is %lX\n"</span>,HandleData-&gt;InputReadData-&gt;ReadCount));
02910     }
02911     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (HandleData-&gt;InputReadData-&gt;ReadCount == 0);
02912     <a class="code" href="../../d9/d3/input_8h.html#a26">UnlockReadCount</a>(HandleData);
02913 
02914     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (HandleData-&gt;Buffer.InputBuffer-&gt;RefCount);
02915     HandleData-&gt;Buffer.InputBuffer-&gt;RefCount--;
02916     <span class="keywordflow">if</span> (HandleData-&gt;Buffer.InputBuffer-&gt;RefCount == 0) {
02917         <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a17">ReinitializeInputBuffer</a>(HandleData-&gt;Buffer.InputBuffer);
02918     }
02919     <span class="keywordflow">else</span> {
02920         <a class="code" href="../../d7/d8/share_8c.html#a2">ConsoleRemoveShare</a>(HandleData-&gt;Access,
02921                            HandleData-&gt;ShareAccess,
02922                            &amp;HandleData-&gt;Buffer.InputBuffer-&gt;ShareAccess
02923                           );
02924     }
02925     <span class="keywordflow">return</span> <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02926 }
02927 
02928 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02929"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a36">02929</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(
02930     IN <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData,
02931     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
02932     IN <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData,
02933     IN HANDLE Handle,
02934     IN BOOLEAN FreeHandle
02935     )
02936 
02937 <span class="comment">/*++</span>
02938 <span class="comment"></span>
02939 <span class="comment">Routine Description:</span>
02940 <span class="comment"></span>
02941 <span class="comment">    This routine closes an output handle.  It decrements the screen buffer's</span>
02942 <span class="comment">    reference count.  If it goes to zero, the buffer is freed.  Otherwise,</span>
02943 <span class="comment">    the handle is removed from sharing.</span>
02944 <span class="comment"></span>
02945 <span class="comment">Arguments:</span>
02946 <span class="comment"></span>
02947 <span class="comment">    ProcessData - Pointer to per process data.</span>
02948 <span class="comment"></span>
02949 <span class="comment">    Console - Pointer to console information structure.</span>
02950 <span class="comment"></span>
02951 <span class="comment">    HandleData - Pointer to handle data structure.</span>
02952 <span class="comment"></span>
02953 <span class="comment">    Handle - Handle to close.</span>
02954 <span class="comment"></span>
02955 <span class="comment">    FreeHandle - if TRUE, free handle.  used by ReadChars in echo mode</span>
02956 <span class="comment">    and by process cleanup.</span>
02957 <span class="comment"></span>
02958 <span class="comment">Return Value:</span>
02959 <span class="comment"></span>
02960 <span class="comment">Note:</span>
02961 <span class="comment"></span>
02962 <span class="comment">    The console lock must be held when calling this routine.</span>
02963 <span class="comment"></span>
02964 <span class="comment">--*/</span>
02965 
02966 {
02967     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02968 
02969     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ProcessData-&gt;Foo == 0xF00);
02970     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (HandleData-&gt;Buffer.ScreenBuffer-&gt;RefCount);
02971     HandleData-&gt;Buffer.ScreenBuffer-&gt;RefCount--;
02972     <span class="keywordflow">if</span> (HandleData-&gt;Buffer.ScreenBuffer-&gt;RefCount == 0) {
02973         <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a23">RemoveScreenBuffer</a>(Console,HandleData-&gt;Buffer.ScreenBuffer);
02974         <span class="keywordflow">if</span> (HandleData-&gt;Buffer.ScreenBuffer == Console-&gt;CurrentScreenBuffer &amp;&amp;
02975             Console-&gt;ScreenBuffers != Console-&gt;CurrentScreenBuffer) {
02976             <span class="keywordflow">if</span> (Console-&gt;ScreenBuffers != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02977                 <a class="code" href="../../d6/d2/output_8c.html#a71">SetActiveScreenBuffer</a>(Console-&gt;ScreenBuffers);
02978             } <span class="keywordflow">else</span> {
02979                 Console-&gt;CurrentScreenBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02980             }
02981         }
02982         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/output_8c.html#a46">FreeScreenBuffer</a>(HandleData-&gt;Buffer.ScreenBuffer);
02983     }
02984     <span class="keywordflow">else</span> {
02985         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/share_8c.html#a2">ConsoleRemoveShare</a>(HandleData-&gt;Access,
02986                                     HandleData-&gt;ShareAccess,
02987                                     &amp;HandleData-&gt;Buffer.ScreenBuffer-&gt;ShareAccess
02988                                    );
02989     }
02990     <span class="keywordflow">if</span> (FreeHandle)
02991         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a29">FreeIoHandle</a>(ProcessData,<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02992     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02993 }
02994 
02995 
02996 ULONG
<a name="l02997"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a37">02997</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a37">SrvCloseHandle</a>(
02998     IN OUT PCSR_API_MSG m,
02999     IN OUT PCSR_REPLY_STATUS ReplyStatus
03000     )
03001 
03002 <span class="comment">/*++</span>
03003 <span class="comment"></span>
03004 <span class="comment">Routine Description:</span>
03005 <span class="comment"></span>
03006 <span class="comment">    This routine closes an input or output handle.</span>
03007 <span class="comment"></span>
03008 <span class="comment">Arguments:</span>
03009 <span class="comment"></span>
03010 <span class="comment">    ApiMessageData - Points to parameter structure.</span>
03011 <span class="comment"></span>
03012 <span class="comment">Return Value:</span>
03013 <span class="comment"></span>
03014 <span class="comment">--*/</span>
03015 
03016 {
03017     <a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html">PCONSOLE_CLOSEHANDLE_MSG</a> a = (<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html">PCONSOLE_CLOSEHANDLE_MSG</a>)&amp;m-&gt;u.ApiMessageData;
03018     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console;
03019     <a class="code" href="../../d4/d3/struct__HANDLE__DATA.html">PHANDLE_DATA</a> HandleData;
03020     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03021     <a class="code" href="../../d0/d4/struct__CONSOLE__PER__PROCESS__DATA.html">PCONSOLE_PER_PROCESS_DATA</a> ProcessData;
03022 
03023     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a33">ApiPreamble</a>(a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o0">ConsoleHandle</a>,
03024                          &amp;Console
03025                         );
03026     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03027         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03028     }
03029     ProcessData = <a class="code" href="../../d1/d7/server_8h.html#a84">CONSOLE_PERPROCESSDATA</a>();
03030     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d8/w32_2ntcon_2server_2handle_8c.html#a30">DereferenceIoHandleNoCheck</a>(ProcessData,
03031                                  <a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o1">Handle</a>),
03032                                  &amp;HandleData
03033                                 );
03034     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03035         <span class="keywordflow">if</span> (HandleData-&gt;<a class="code" href="../../d4/d3/struct__HANDLE__DATA.html#o0">HandleType</a> &amp; <a class="code" href="../../d5/d5/conmsg_8h.html#a0">CONSOLE_INPUT_HANDLE</a>)
03036             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a35">CloseInputHandle</a>(ProcessData,Console,HandleData,<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o1">Handle</a>));
03037         <span class="keywordflow">else</span> {
03038             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2stream_8c.html#a36">CloseOutputHandle</a>(ProcessData,Console,HandleData,<a class="code" href="../../d1/d7/server_8h.html#a58">HANDLE_TO_INDEX</a>(a-&gt;<a class="code" href="../../d7/d9/struct__CONSOLE__CLOSEHANDLE__MSG.html#o1">Handle</a>),<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03039         }
03040     }
03041     <a class="code" href="../../d3/d3/ntcon_2server_2input_8c.html#a54">UnlockConsole</a>(Console);
03042     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03043     UNREFERENCED_PARAMETER(ReplyStatus);    <span class="comment">// get rid of unreferenced parameter warning message</span>
03044 }
03045 
03046 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03047"></a><a class="code" href="../../d0/d7/server_2stream_8c.html#a38">03047</a> <a class="code" href="../../d0/d7/server_2stream_8c.html#a38">WriteCharsFromInput</a>(
03048     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
03049     IN PWCHAR lpBufferBackupLimit,
03050     IN PWCHAR lpBuffer,
03051     IN PWCHAR lpString,
03052     IN OUT PDWORD NumBytes,
03053     OUT PLONG NumSpaces OPTIONAL,
03054     IN SHORT OriginalXPosition,
03055     IN DWORD dwFlags,
03056     OUT PSHORT ScrollY OPTIONAL
03057     )
03058 
03059 <span class="comment">/*++</span>
03060 <span class="comment"></span>
03061 <span class="comment">Routine Description:</span>
03062 <span class="comment"></span>
03063 <span class="comment">    This routine converts chars from their true unicode representation</span>
03064 <span class="comment">    to the Unicode representation (UnicodeAnsi) that will generate</span>
03065 <span class="comment">    the correct glyph given an OEM font and an ANSI translation by GDI.</span>
03066 <span class="comment">    It then calls WriteChars.</span>
03067 <span class="comment"></span>
03068 <span class="comment">Arguments:</span>
03069 <span class="comment"></span>
03070 <span class="comment">    ScreenInfo - Pointer to screen buffer information structure.</span>
03071 <span class="comment"></span>
03072 <span class="comment">    lpBufferBackupLimit - Pointer to beginning of buffer.</span>
03073 <span class="comment"></span>
03074 <span class="comment">    lpBuffer - Pointer to buffer to copy string to.  assumed to be at least</span>
03075 <span class="comment">    as long as lpString.  This pointer is updated to point to the next</span>
03076 <span class="comment">    position in the buffer.</span>
03077 <span class="comment"></span>
03078 <span class="comment">    lpString - Pointer to string to write.</span>
03079 <span class="comment"></span>
03080 <span class="comment">    NumBytes - On input, number of bytes to write.  On output, number of</span>
03081 <span class="comment">    bytes written.</span>
03082 <span class="comment"></span>
03083 <span class="comment">    NumSpaces - On output, the number of spaces consumed by the written characters.</span>
03084 <span class="comment"></span>
03085 <span class="comment">    dwFlags -</span>
03086 <span class="comment">      WC_DESTRUCTIVE_BACKSPACE backspace overwrites characters.</span>
03087 <span class="comment">      WC_KEEP_CURSOR_VISIBLE   change window origin desirable when hit rt. edge</span>
03088 <span class="comment">      WC_ECHO                  if called by Read (echoing characters)</span>
03089 <span class="comment">      WC_FALSIFY_UNICODE       if RealUnicodeToFalseUnicode need be called.</span>
03090 <span class="comment"></span>
03091 <span class="comment">Return Value:</span>
03092 <span class="comment"></span>
03093 <span class="comment">Note:</span>
03094 <span class="comment"></span>
03095 <span class="comment">    This routine does not process tabs and backspace properly.  That code</span>
03096 <span class="comment">    will be implemented as part of the line editing services.</span>
03097 <span class="comment"></span>
03098 <span class="comment">--*/</span>
03099 
03100 {
03101     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length,i;
03102 
03103     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
03104         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03105     }
03106 
03107     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) ||
03108             (ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
03109         <span class="keywordflow">goto</span> SimpleWrite;
03110     }
03111 
03112     Length = *NumBytes / <span class="keyword">sizeof</span>(WCHAR);
03113     <span class="keywordflow">for</span> (i=0;i&lt;Length;i++) {
03114         <span class="keywordflow">if</span> (lpString[i] &gt; 0x7f) {
03115             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= <a class="code" href="../../d4/d1/cmdline_8h.html#a20">WC_FALSIFY_UNICODE</a>;
03116             <span class="keywordflow">break</span>;
03117         }
03118     }
03119 
03120 SimpleWrite:
03121     <span class="keywordflow">return</span> <a class="code" href="../../d6/d8/dispatch_8h.html#a9">WriteChars</a>(ScreenInfo,
03122                     lpBufferBackupLimit,
03123                     lpBuffer,
03124                     lpString,
03125                     NumBytes,
03126                     NumSpaces,
03127                     OriginalXPosition,
03128                     <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>,
03129                     ScrollY
03130                    );
03131 }
03132 
03133 <span class="preprocessor">#if defined(FE_SB)</span>
03134 <span class="preprocessor"></span>
03135 <span class="preprocessor">#define WWSB_NOFE</span>
03136 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d6/d8/dispatch_8h.html">dispatch.h</a>"</span>
03137 <span class="preprocessor">#include "<a class="code" href="../../d0/d3/__stream_8h.html">_stream.h</a>"</span>
03138 <span class="preprocessor">#undef  WWSB_NOFE</span>
03139 <span class="preprocessor"></span><span class="preprocessor">#define WWSB_FE</span>
03140 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d6/d8/dispatch_8h.html">dispatch.h</a>"</span>
03141 <span class="preprocessor">#include "<a class="code" href="../../d0/d3/__stream_8h.html">_stream.h</a>"</span>
03142 <span class="preprocessor">#undef  WWSB_FE</span>
03143 <span class="preprocessor"></span>
03144 <span class="preprocessor">#endif // FE_SB</span>
03145 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
