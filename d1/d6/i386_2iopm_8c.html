<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: i386/iopm.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>iopm.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d2/d5/i386_2iopm_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a0">ALIGN_DOWN</a>(address, amt)&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a1">ALIGN_UP</a>(address, amt)&nbsp;&nbsp;&nbsp;(ALIGN_DOWN( (address + (amt) - 1), (amt) ))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a2">KiSetIoMap</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a> SignalDone, IN PVOID MapSource, IN PVOID MapNumber, IN PVOID Parameter3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a3">KiLoadIopmOffset</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a> SignalDone, IN PVOID Parameter1, IN PVOID Parameter2, IN PVOID Parameter3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a4">Ke386SetIoAccessMap</a> (ULONG MapNumber, PKIO_ACCESS_MAP IoAccessMap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a5">Ke386QueryIoAccessMap</a> (ULONG MapNumber, PKIO_ACCESS_MAP IoAccessMap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a6">Ke386IoSetAccessProcess</a> (<a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, ULONG MapNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/i386_2iopm_8c.html#a7">Ke386SetIOPL</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="i386/iopm.c::ALIGN_DOWN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_DOWN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00036">36</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="i386/iopm.c::ALIGN_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(ALIGN_DOWN( (address + (amt) - 1), (amt) ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00037">37</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="i386/iopm.c::Ke386IoSetAccessProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN Ke386IoSetAccessProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00318">318</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00747">_KPROCESS::ActiveProcessors</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00319">KiIpiSendPacket()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00182">KiIpiStallOnPacketTargets()</a>, <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00413">KiLoadIopmOffset()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00628">KiPcr</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00324                    :
00325 
00326     Set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> i/o access map which controls user mode i/o access
00327     <span class="keywordflow">for</span> a particular process.
00328 
00329 Arguments:
00330 
00331     Process - Pointer to kernel process object describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00332     process which <span class="keywordflow">for</span> which a map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be set.
00333 
00334     MapNumber - Number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map to set.  Value of map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00335     defined by <a class="code" href="../../d5/d3/i386_8h.html#a31">Ke386IoSetAccessProcess</a>.  Setting MapNumber
00336     to IO_ACCESS_MAP_NONE will disallow any user mode i/o
00337     access from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00338 
00339 Return Value:
00340 
00341     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (illegal MapNumber)
00342 
00343 --*/
00344 
00345 {
00346 
00347     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MapOffset;
00348     KIRQL OldIrql;
00349     PKPRCB Prcb;
00350     KAFFINITY TargetProcessors;
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">// Reject illegal requests</span>
00354     <span class="comment">//</span>
00355 
00356     <span class="keywordflow">if</span> (MapNumber &gt; IOPM_COUNT) {
00357         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00358     }
00359 
00360     MapOffset = KiComputeIopmOffset(MapNumber);
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// Acquire the context swap lock so a context switch will not occur.</span>
00364     <span class="comment">//</span>
00365 
00366     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Store new offset in process object,  compute current set of</span>
00370     <span class="comment">// active processors for process, if this cpu is one, set IOPM.</span>
00371     <span class="comment">//</span>
00372 
00373     Process-&gt;IopmOffset = MapOffset;
00374 
00375     TargetProcessors = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o3">ActiveProcessors</a>;
00376     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00377     <span class="keywordflow">if</span> (TargetProcessors &amp; Prcb-&gt;SetMember) {
00378         <a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMapBase = MapOffset;
00379     }
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Compute set of active processors other than this one, if non-empty</span>
00383     <span class="comment">// IPI them to load their IOPMs, wait for them.</span>
00384     <span class="comment">//</span>
00385 
00386 <span class="preprocessor">#if !defined(NT_UP)</span>
00387 <span class="preprocessor"></span>
00388     TargetProcessors = TargetProcessors &amp; ~Prcb-&gt;SetMember;
00389     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00390         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00391                         KiLoadIopmOffset,
00392                         NULL,
00393                         NULL,
00394                         NULL);
00395 
00396         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00397     }
00398 
00399 <span class="preprocessor">#endif</span>
00400 <span class="preprocessor"></span>
00401     <span class="comment">//</span>
00402     <span class="comment">// Restore IRQL and unlock the context swap lock.</span>
00403     <span class="comment">//</span>
00404 
00405     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00406     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="i386/iopm.c::Ke386QueryIoAccessMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN Ke386QueryIoAccessMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKIO_ACCESS_MAP&nbsp;</td>
          <td class="mdname" nowrap> <em>IoAccessMap</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00235">235</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00628">KiPcr</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00242                    :
00243 
00244     The specified i/o access map will be dumped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00245     map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a constant, but will be dumped anyway.
00246 
00247 Arguments:
00248 
00249     MapNumber - Number of access map to set.  map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> fixed.
00250 
00251     IoAccessMap - Pointer to buffer (64K bits, 8K bytes) which
00252            <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> definition of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access map.
00253            Must be in non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00254 
00255 Return Value:
00256 
00257     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (attempt to query a map
00258     which does not exist)
00259 
00260 --*/
00261 
00262 {
00263 
00264     ULONG i;
00265     PVOID Map;
00266     KIRQL OldIrql;
00267     PUCHAR p;
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Reject illegal requests</span>
00271     <span class="comment">//</span>
00272 
00273     <span class="keywordflow">if</span> (MapNumber &gt; IOPM_COUNT) {
00274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Acquire the context swap lock so a context switch will not occur.</span>
00279     <span class="comment">//</span>
00280 
00281     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">// Copy out the map</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> (MapNumber == IO_ACCESS_MAP_NONE) {
00288 
00289         <span class="comment">//</span>
00290         <span class="comment">// no access case, simply return a map of all 1s</span>
00291         <span class="comment">//</span>
00292 
00293         p = (PUCHAR)IoAccessMap;
00294         <span class="keywordflow">for</span> (i = 0; i &lt; IOPM_SIZE; i++) {
00295             p[i] = (UCHAR)-1;
00296         }
00297 
00298     } <span class="keywordflow">else</span> {
00299 
00300         <span class="comment">//</span>
00301         <span class="comment">// normal case, just copy the bits</span>
00302         <span class="comment">//</span>
00303 
00304         Map = (PVOID)&amp;(<a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMaps[MapNumber-1].IoMap);
00305         RtlMoveMemory((PVOID)IoAccessMap, Map, IOPM_SIZE);
00306     }
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Restore IRQL and unlock the context swap lock.</span>
00310     <span class="comment">//</span>
00311 
00312     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00313     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00314 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="i386/iopm.c::Ke386SetIoAccessMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN Ke386SetIoAccessMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PKIO_ACCESS_MAP&nbsp;</td>
          <td class="mdname" nowrap> <em>IoAccessMap</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00080">80</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00319">KiIpiSendPacket()</a>, <a class="el" href="../../d3/d0/xipi_8c-source.html#l00182">KiIpiStallOnPacketTargets()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00128">KiLockContextSwap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00628">KiPcr</a>, <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00188">KiSetIoMap()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00131">KiUnlockContextSwap</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00087                    :
00088 
00089     The specified i/o access map will be set to match <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00090     definition specified by IoAccessMap (i.e. enable/disable
00091     those ports) before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call returns.  The change will take
00092     effect on all processors.
00093 
00094     <a class="code" href="../../d5/d3/i386_8h.html#a29">Ke386SetIoAccessMap</a> does not give any process enhanced I/O
00095     access, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> merely defines a particular access map.
00096 
00097 Arguments:
00098 
00099     MapNumber - Number of access map to set.  Map 0 <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> fixed.
00100 
00101     IoAccessMap - Pointer to bitvector (64K bits, 8K bytes) which
00102            defines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified access map.  Must be in
00103            non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00104 
00105 Return Value:
00106 
00107     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> successful.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">failure</a> (attempt to set a map
00108     which does not exist, attempt to set map 0)
00109 
00110 --*/
00111 
00112 {
00113 
00114     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00115     KIRQL OldIrql;
00116     PKPRCB Prcb;
00117     PVOID pt;
00118     KAFFINITY TargetProcessors;
00119 
00120     <span class="comment">//</span>
00121     <span class="comment">// Reject illegal requests</span>
00122     <span class="comment">//</span>
00123 
00124     <span class="keywordflow">if</span> ((MapNumber &gt; IOPM_COUNT) || (MapNumber == IO_ACCESS_MAP_NONE)) {
00125         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00126     }
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">// Acquire the context swap lock so a context switch will not occur.</span>
00130     <span class="comment">//</span>
00131 
00132     <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql);
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// Compute set of active processors other than this one, if non-empty</span>
00136     <span class="comment">// IPI them to set their maps.</span>
00137     <span class="comment">//</span>
00138 
00139     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00140 
00141 <span class="preprocessor">#if !defined(NT_UP)</span>
00142 <span class="preprocessor"></span>
00143     TargetProcessors = <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a> &amp; ~Prcb-&gt;SetMember;
00144     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00145         <a class="code" href="../../d0/d0/ki_8h.html#a91">KiIpiSendPacket</a>(TargetProcessors,
00146                         KiSetIoMap,
00147                         IoAccessMap,
00148                         (PVOID)MapNumber,
00149                         NULL);
00150     }
00151 
00152 <span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154     <span class="comment">//</span>
00155     <span class="comment">// Copy the IOPM map and load the map for the current process.</span>
00156     <span class="comment">//</span>
00157 
00158     pt = &amp;(<a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMaps[MapNumber-1].IoMap);
00159     RtlMoveMemory(pt, (PVOID)IoAccessMap, IOPM_SIZE);
00160     CurrentProcess = Prcb-&gt;CurrentThread-&gt;ApcState.Process;
00161     <a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMapBase = CurrentProcess-&gt;IopmOffset;
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">// Wait until all of the target processors have finished copying the</span>
00165     <span class="comment">// new map.</span>
00166     <span class="comment">//</span>
00167 
00168 <span class="preprocessor">#if !defined(NT_UP)</span>
00169 <span class="preprocessor"></span>
00170     <span class="keywordflow">if</span> (TargetProcessors != 0) {
00171         <a class="code" href="../../d2/d1/xipi_8c.html#a2">KiIpiStallOnPacketTargets</a>(TargetProcessors);
00172     }
00173 
00174 <span class="preprocessor">#endif</span>
00175 <span class="preprocessor"></span>
00176     <span class="comment">//</span>
00177     <span class="comment">// Restore IRQL and unlock the context swap lock.</span>
00178     <span class="comment">//</span>
00179 
00180     <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql);
00181     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00182 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="i386/iopm.c::Ke386SetIOPL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID Ke386SetIOPL           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00457">457</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00126">ALIGN_UP</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00556">_KTHREAD::InitialStack</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00571">_KTHREAD::Iopl</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00081">KeContextFromKframes()</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00230">KeContextToKframes()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00463                    :
00464 
00465     Gives IOPL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process.
00466 
00467     All threads created from <span class="keyword">this</span> point on will get IOPL.  The current
00468     process will get IOPL.  Must be called from context of thread and
00469     process that are to have IOPL.
00470 
00471     Iopl (to be made a <span class="keywordtype">boolean</span>) in <a class="code" href="../../d5/d7/struct__KPROCESS.html">KPROCESS</a> says all
00472     <span class="keyword">new</span> threads to get IOPL.
00473 
00474     Iopl (to be made a <span class="keywordtype">boolean</span>) in <a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a> says given
00475     thread to get IOPL.
00476 
00477     N.B.    If a kernel mode <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> thread calls <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00478             result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> (a) poinless and (b) will break the system.
00479 
00480 Arguments:
00481 
00482     Process - Pointer to the process == IGNORED!!!
00483 
00484 Return Value:
00485 
00486     none
00487 
00488 --*/
00489 
00490 {
00491 
00492     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>    Thread;
00493     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>   Process2;
00494     PKTRAP_FRAME    TrapFrame;
00495     CONTEXT     Context;
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// get current thread and Process2, set flag for IOPL in both of them</span>
00499     <span class="comment">//</span>
00500 
00501     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00502     Process2 = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00503 
00504     Process2-&gt;Iopl = 1;
00505     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o10">Iopl</a> = 1;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Force IOPL to be on for current thread</span>
00509     <span class="comment">//</span>
00510 
00511     TrapFrame = (PKTRAP_FRAME)((PUCHAR)Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> -
00512                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a4">ALIGN_UP</a>(<span class="keyword">sizeof</span>(KTRAP_FRAME),KTRAP_FRAME_ALIGN) -
00513                 <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00514 
00515     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00516     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame,
00517                          NULL,
00518                          &amp;Context);
00519 
00520     Context.EFlags |= (EFLAGS_IOPL_MASK &amp; -1);  <span class="comment">// IOPL == 3</span>
00521 
00522     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame,
00523                        NULL,
00524                        &amp;Context,
00525                        CONTEXT_CONTROL,
00526                        UserMode);
00527 
00528     <span class="keywordflow">return</span>;
00529 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="i386/iopm.c::KiLoadIopmOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiLoadIopmOffset           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalDone</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00413">413</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00628">KiPcr</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00318">Ke386IoSetAccessProcess()</a>.
<p>
<pre class="fragment"><div>00422                    :
00423 
00424     Edit IopmBase of Tss to match that of currently running process.
00425 
00426 Arguments:
00427 
00428     Argument - actually a pointer to a KIPI_LOAD_IOPM_OFFSET structure
00429     ReadyFlag - Pointer to flag to be set once we are done
00430 
00431 Return Value:
00432 
00433     none
00434 
00435 --*/
00436 
00437 {
00438 
00439     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00440     PKPRCB Prcb;
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">// Update IOPM field in TSS from current process</span>
00444     <span class="comment">//</span>
00445 
00446     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00447     CurrentProcess = Prcb-&gt;CurrentThread-&gt;ApcState.Process;
00448     <a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMapBase = CurrentProcess-&gt;IopmOffset;
00449     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00450     <span class="keywordflow">return</span>;
00451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="i386/iopm.c::KiSetIoMap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetIoMap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a54">PKIPI_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SignalDone</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MapSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MapNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Parameter3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00188">188</a> of file <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html">i386/iopm.c</a>.
<p>
References <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00628">KiPcr</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00080">Ke386SetIoAccessMap()</a>.
<p>
<pre class="fragment"><div>00196                    :
00197 
00198     copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified map into <span class="keyword">this</span> processor's TSS.
00199     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> runs at IPI level.
00200 
00201 Arguments:
00202 
00203     Argument - actually a pointer to a KIPI_SET_IOPM structure
00204     ReadyFlag - pointer to flag to set once setiopm has completed
00205 
00206 Return Value:
00207 
00208     none
00209 
00210 --*/
00211 
00212 {
00213 
00214     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> CurrentProcess;
00215     PKPRCB Prcb;
00216     PVOID pt;
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// Copy the IOPM map and load the map for the current process.</span>
00220     <span class="comment">//</span>
00221 
00222     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00223     pt = &amp;(<a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMaps[((ULONG) MapNumber)-1].IoMap);
00224     RtlMoveMemory(pt, MapSource, IOPM_SIZE);
00225     CurrentProcess = Prcb-&gt;CurrentThread-&gt;ApcState.Process;
00226     <a class="code" href="../../d6/d7/halmips_8h.html#a460">KiPcr</a>()-&gt;TSS-&gt;IoMapBase = CurrentProcess-&gt;IopmOffset;
00227     <a class="code" href="../../d0/d0/ki_8h.html#a93">KiIpiSignalPacketDone</a>(SignalDone);
00228     <span class="keywordflow">return</span>;
00229 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
