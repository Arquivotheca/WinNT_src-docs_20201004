<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: axp64/physsect.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>physsect.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d2/d5/axp64_2physsect_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/axp64_2physsect_8c.html#a0">MaximumAlignment</a> (ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/axp64_2physsect_8c.html#a1">AggregatePages</a> (<a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>, PFN_NUMBER, ULONG, PULONG)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/axp64_2physsect_8c.html#a2">MiMapViewOfPhysicalSection</a> (IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PVOID *CapturedBase, IN PLARGE_INTEGER SectionOffset, IN PSIZE_T CapturedViewSize, IN ULONG ProtectionMask, IN ULONG_PTR ZeroBits, IN ULONG AllocationType, IN BOOLEAN WriteCombined, OUT PBOOLEAN ReleasedWsMutex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a> (IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte, IN PFN_NUMBER Pfn, IN ULONG Pages, OUT PULONG GranularityHint)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="axp64/physsect.c::AggregatePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG AggregatePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PointerPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>Pfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Pages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>GranularityHint</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00522">522</a> of file <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html">axp64/physsect.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00248">GH0</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00241">GH1</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00242">GH1_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00234">GH2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00235">GH2_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00227">GH3</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00228">GH3_PAGE_SIZE</a>, <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00478">MaximumAlignment()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00043">MiMapViewOfPhysicalSection()</a>.
<p>
<pre class="fragment"><div>00530                    :
00531 
00532     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of standard size pages that can be
00533     aggregated into a single large page and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granularity hint
00534     <span class="keywordflow">for</span> that size large page.
00535 
00536 Arguments:
00537 
00538     PointerPte - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE pointer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <span class="keyword">virtual</span> address
00539                      of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping.
00540     Pfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting page frame number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory to be
00541                      mapped.
00542     Pages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to map.
00543 
00544     GranularityHint - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granularity hint <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> large page used
00545                          to aggregate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard pages.
00546 
00547 Return Value:
00548 
00549     The number of pages that can be aggregated together.
00550 
00551 Environment:
00552 
00553 --*/
00554 {
00555 
00556     ULONG MaxVirtualAlignment;
00557     ULONG MaxPhysicalAlignment;
00558     ULONG MaxPageAlignment;
00559     ULONG MaxAlignment;
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Determine the largest page that will map a maximum of Pages.</span>
00563     <span class="comment">// The largest page must be both virtually and physically aligned</span>
00564     <span class="comment">// to the large page size boundary.</span>
00565     <span class="comment">// Determine the largest common alignment for the virtual and</span>
00566     <span class="comment">// physical addresses, factor in Pages, and then match to the</span>
00567     <span class="comment">// largest page size possible via the granularity hints.</span>
00568     <span class="comment">//</span>
00569 
00570     MaxVirtualAlignment =
00571         <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>((ULONG)((ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte)));
00572 
00573     MaxPhysicalAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( (ULONG)(Pfn &lt;&lt; PAGE_SHIFT) );
00574 
00575     MaxPageAlignment = (ULONG)(Pages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00576 
00577 <span class="preprocessor">#ifdef AGGREGATE_DBG</span>
00578 <span class="preprocessor"></span>
00579     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxVirtualAlign = %x\n"</span>, MaxVirtualAlignment );
00580     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPhysicalAlign = %x\n"</span>, MaxPhysicalAlignment );
00581     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate MaxPageAlign = %x\n"</span>, MaxPageAlignment );
00582 
00583 <span class="preprocessor">#endif //AGGREGATE_DBG</span>
00584 <span class="preprocessor"></span>    <span class="comment">//</span>
00585     <span class="comment">// Maximum alignment is the minimum of the virtual and physical alignments.</span>
00586     <span class="comment">//</span>
00587 
00588     MaxAlignment =  (MaxVirtualAlignment &gt; MaxPhysicalAlignment) ?
00589                         MaxPhysicalAlignment : MaxVirtualAlignment;
00590     MaxAlignment = (MaxAlignment &gt; MaxPageAlignment) ?
00591                         MaxPageAlignment : MaxAlignment;
00592 
00593     <span class="comment">//</span>
00594     <span class="comment">// Convert MaxAlignment to granularity hint value</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00598 
00599         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a36">GH3</a>;
00600 
00601     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00602 
00603         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a38">GH2</a>;
00604 
00605     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00606 
00607         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a40">GH1</a>;
00608 
00609     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( (MaxAlignment &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00610 
00611         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00612 
00613     } <span class="keywordflow">else</span> {
00614 
00615         *GranularityHint = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a42">GH0</a>;
00616 
00617 <span class="preprocessor">#if DBG</span>
00618 <span class="preprocessor"></span>
00619         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Aggregate Physical pages - not page aligned\n"</span> );
00620 
00621 <span class="preprocessor">#endif //DBG</span>
00622 <span class="preprocessor"></span>
00623     } <span class="comment">// end, if then elseif</span>
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Return number of pages aggregated.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">return</span>( MaxAlignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> );
00630 
00631 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="axp64/physsect.c::AggregatePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG AggregatePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="axp64/physsect.c::MaximumAlignment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MaximumAlignment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Offset</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00478">478</a> of file <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html">axp64/physsect.c</a>.
<p>
References <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00242">GH1_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00235">GH2_PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00228">GH3_PAGE_SIZE</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00516">AggregatePages()</a>, and <a class="el" href="../../d1/d5/alpha_2physsect_8c-source.html#l00043">MiMapViewOfPhysicalSection()</a>.
<p>
<pre class="fragment"><div>00483                    :
00484 
00485     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum granularity hint alignment boundary
00486     to which <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> naturally aligned.
00487 
00488 Arguments:
00489 
00490     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address offset to check <span class="keywordflow">for</span> alignment.
00491 
00492 Return Value:
00493 
00494     The number which represents <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> largest natural alignment of <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.
00495 
00496 Environment:
00497 
00498 --*/
00499 {
00500 
00501     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a> - 1)) == 0 ){
00502         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a37">GH3_PAGE_SIZE</a>;
00503     }
00504 
00505     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a> - 1)) == 0 ){
00506         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a39">GH2_PAGE_SIZE</a>;
00507     }
00508 
00509     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a> - 1)) == 0 ){
00510         <span class="keywordflow">return</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a41">GH1_PAGE_SIZE</a>;
00511     }
00512 
00513     <span class="keywordflow">if</span>( (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0 ){
00514         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00515     }
00516 
00517     <span class="keywordflow">return</span> 0;
00518 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="axp64/physsect.c::MaximumAlignment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MaximumAlignment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Offset</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [static]</code></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="axp64/physsect.c::MiMapViewOfPhysicalSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MiMapViewOfPhysicalSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlArea</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedViewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProtectionMask</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ZeroBits</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>WriteCombined</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReleasedWsMutex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00045">45</a> of file <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html">axp64/physsect.c</a>.
<p>
References <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00522">AggregatePages()</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02394">_MMVAD::FirstPrototypePte</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02395">_MMVAD::LastContiguousPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02426">_MI_PHYSICAL_VIEW::ListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01039">LOCK_WS</a>, <a class="el" href="../../d2/d5/axp64_2physsect_8c-source.html#l00478">MaximumAlignment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00360">MI_64K_ALIGN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02312">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02433">MI_PHYSICAL_VIEW_KEY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o13">_MMVAD::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
<pre class="fragment"><div>00060                    :
00061 
00062     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical section into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00063     specified process's address space.
00064 
00065 Arguments:
00066 
00067     see <a class="code" href="../../d2/d1/mm_8h.html#a241">MmMapViewOfSection</a> above...
00068 
00069     ControlArea - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> area <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00070 
00071     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process pointer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> receiving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.
00072 
00073     ProtectionMask - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial page protection-mask.
00074 
00075     ReleasedWsMutex - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, receives <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
00076                       mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released.
00077 
00078 Return Value:
00079 
00080     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> map view operation.
00081 
00082 Environment:
00083 
00084     Kernel Mode, working set mutex and address creation mutex held.
00085 
00086 --*/
00087 
00088 {
00089     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
00090     PVOID StartingAddress;
00091     PVOID EndingAddress;
00092     KIRQL OldIrql;
00093     KIRQL OldIrql2;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00097     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00098     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00099     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00100     SIZE_T PhysicalViewSize;
00101     ULONG Alignment;
00102     ULONG PagesToMap;
00103     PFN_NUMBER NextPfn;
00104     PVOID UsedPageTableHandle;
00105     PVOID UsedPageDirectoryHandle;
00106     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Physical memory section.</span>
00110     <span class="comment">//</span>
00111 
00112 <span class="preprocessor">#ifdef FIRSTDBG</span>
00113 <span class="preprocessor"></span>
00114     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect CaptureBase = %x  SectionOffset = %x\n"</span>,
00115               CapturedBase, SectionOffset-&gt;LowPart );
00116     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect Allocation Type = %x, MEM_LARGE_PAGES = %x\n"</span>,
00117               AllocationType, MEM_LARGE_PAGES );
00118 
00119 <span class="preprocessor">#endif //FIRSTDBG</span>
00120 <span class="preprocessor"></span>
00121     <span class="comment">//</span>
00122     <span class="comment">// Compute the alignment we require for the virtual mapping.</span>
00123     <span class="comment">// The default is 64K to match protection boundaries.</span>
00124     <span class="comment">// Larger page sizes are used if MEM_LARGE_PAGES is requested.</span>
00125     <span class="comment">// The Alpha AXP architecture supports granularity hints so that</span>
00126     <span class="comment">// larger pages can be defined in the following multiples of</span>
00127     <span class="comment">// PAGE_SIZE:</span>
00128     <span class="comment">//            8**(GH) * PAGE_SIZE, where GH element of {0,1,2,3}</span>
00129     <span class="comment">//</span>
00130 
00131     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
00132 
00133     <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// MaxAlignment is the maximum boundary alignment of the</span>
00137         <span class="comment">// SectionOffset (where the maximum boundary is one of the possible</span>
00138         <span class="comment">//                granularity hints boundaries)</span>
00139         <span class="comment">//</span>
00140 
00141         ULONG MaxAlignment = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a3">MaximumAlignment</a>( SectionOffset-&gt;LowPart );
00142 
00143         Alignment = (MaxAlignment &gt; Alignment) ? MaxAlignment : Alignment;
00144 
00145 <span class="preprocessor">#ifdef FIRSTDBG</span>
00146 <span class="preprocessor"></span>
00147         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Alignment = %x, SectionOffset = %x\n"</span>,
00148                        Alignment, SectionOffset-&gt;LowPart );
00149 
00150 <span class="preprocessor">#endif //FIRSTDBG</span>
00151 <span class="preprocessor"></span>
00152     }
00153 
00154 
00155     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
00156 
00157     <span class="keywordflow">if</span> (*CapturedBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00158 
00159         <span class="comment">//</span>
00160         <span class="comment">// Attempt to locate address space.  This could raise an</span>
00161         <span class="comment">// exception.</span>
00162         <span class="comment">//</span>
00163 
00164         <span class="keywordflow">try</span> {
00165 
00166             <span class="comment">//</span>
00167             <span class="comment">// Find a starting address on an alignment boundary.</span>
00168             <span class="comment">//</span>
00169 
00170 
00171             PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00172                                (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00173 
00174             StartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (PhysicalViewSize,
00175                                                        Alignment,
00176                                                        (ULONG)ZeroBits);
00177 
00178         } except (EXCEPTION_EXECUTE_HANDLER) {
00179 
00180             <span class="keywordflow">return</span> GetExceptionCode();
00181         }
00182 
00183         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
00184                                 PhysicalViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00185 
00186         StartingAddress = (PVOID)((ULONG_PTR)StartingAddress +
00187                                      (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00188 
00189         <span class="keywordflow">if</span> (ZeroBits &gt; 0) {
00190             <span class="keywordflow">if</span> (EndingAddress &gt; (PVOID)((LONG_PTR)0xFFFFFFFF &gt;&gt; ZeroBits)) {
00191                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00192             }
00193         }
00194 
00195     } <span class="keywordflow">else</span> {
00196 
00197         <span class="comment">//</span>
00198         <span class="comment">// Check to make sure the specified base address to ending address</span>
00199         <span class="comment">// is currently unused.</span>
00200         <span class="comment">//</span>
00201 
00202         PhysicalViewSize = (SectionOffset-&gt;LowPart + *CapturedViewSize) -
00203                                 (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(SectionOffset-&gt;LowPart);
00204 
00205         StartingAddress = (PVOID)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a91">MI_64K_ALIGN</a>(*CapturedBase) +
00206                                     (SectionOffset-&gt;LowPart &amp; (<a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a> - 1)));
00207 
00208         EndingAddress = (PVOID)(((ULONG_PTR)StartingAddress +
00209                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
00210 
00211         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (StartingAddress, EndingAddress);
00212         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00213 <span class="preprocessor">#if 0</span>
00214 <span class="preprocessor"></span>            MiDumpConflictingVad (StartingAddress, EndingAddress, Vad);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>
00217             <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
00218         }
00219     }
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">// An unoccuppied address range has been found, build the virtual</span>
00223     <span class="comment">// address descriptor to describe this range.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Establish an exception handler and attempt to allocate</span>
00228     <span class="comment">// the pool and charge quota.  Note that the InsertVad routine</span>
00229     <span class="comment">// will also charge quota which could raise an exception.</span>
00230     <span class="comment">//</span>
00231 
00232     <span class="keywordflow">try</span>  {
00233 
00234         PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00235                                                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
00236                                                                  MI_PHYSICAL_VIEW_KEY);
00237         <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00238             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00239         }
00240 
00241         Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
00242         <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00243             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
00244         }
00245 
00246         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
00247         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = StartingAddress;
00248         PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
00249 
00250         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (StartingAddress);
00251         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
00252         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
00253         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
00254         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = ViewUnmap;
00255         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
00256         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.Banked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257         <span class="comment">// Vad-&gt;u.VadFlags.ImageMap = 0;</span>
00258         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
00259         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = 0;
00260         <span class="comment">// Vad-&gt;u.VadFlags.LargePages = 0;</span>
00261         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> =
00262                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">// Set the first prototype PTE field in the Vad.</span>
00266         <span class="comment">//</span>
00267 
00268         Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> =
00269                        (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset));
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Insert the VAD.  This could get an exception.</span>
00273         <span class="comment">//</span>
00274 
00275         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
00276 
00277     } except (EXCEPTION_EXECUTE_HANDLER) {
00278 
00279         <span class="keywordflow">if</span> (PhysicalView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00280             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
00281         }
00282 
00283         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00284 
00285             <span class="comment">//</span>
00286             <span class="comment">// The pool allocation suceeded, but the quota charge</span>
00287             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
00288             <span class="comment">// and error.</span>
00289             <span class="comment">//</span>
00290 
00291             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
00292             <span class="keywordflow">return</span> GetExceptionCode();
00293         }
00294         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00295     }
00296 
00297     <span class="comment">// Increment the count of the number of views for the</span>
00298     <span class="comment">// section object.  This requires the PFN mutex to be held.</span>
00299     <span class="comment">//</span>
00300 
00301     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
00302     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
00303 
00304     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">ListEntry</a>);
00305 
00306     ControlArea-&gt;NumberOfMappedViews += 1;
00307     ControlArea-&gt;NumberOfUserReferences += 1;
00308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;NumberOfSectionReferences != 0);
00309 
00310     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
00311     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// Build the PTEs in the address space.</span>
00315     <span class="comment">//</span>
00316 
00317     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (StartingAddress);
00318     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (StartingAddress);
00319     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartingAddress);
00320     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
00321 
00322 <span class="preprocessor">#if defined (_WIN64)</span>
00323 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00324     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00325         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00326         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_USED_PTES_FROM_HANDLE (UsedPageDirectoryHandle) == 0); 
00327         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00328     }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>
00331     <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
00332 
00333     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00334 
00335     PagesToMap = (ULONG)((((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress))
00336                    + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1) ) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00337 
00338     NextPfn = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a180">MI_CONVERT_PHYSICAL_BUS_TO_PFN</a>(*SectionOffset);
00339 
00340 <span class="preprocessor">#ifdef FIRSTDBG</span>
00341 <span class="preprocessor"></span>
00342     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect, PagesToMap = %x  NextPfn = %x\n"</span>,
00343                    PagesToMap, NextPfn );
00344 
00345 <span class="preprocessor">#endif //FIRSTDBG</span>
00346 <span class="preprocessor"></span>
00347     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00348                        NextPfn,
00349                        ProtectionMask,
00350                        PointerPte);
00351 
00352     <span class="keywordflow">if</span> (WriteCombined == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00353         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
00354     }
00355 
00356     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
00357             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.FaultOnWrite = 1;
00358     }
00359 
00360     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00361 
00362         ULONG PagesTogether;
00363         ULONG GranularityHint;
00364 
00365         <span class="comment">//</span>
00366         <span class="comment">// Compute the number of pages that can be mapped together</span>
00367         <span class="comment">//</span>
00368 
00369         <span class="keywordflow">if</span>( AllocationType &amp; MEM_LARGE_PAGES ){
00370             PagesTogether = <a class="code" href="../../d1/d6/axp64_2physsect_8c.html#a4">AggregatePages</a>( PointerPte,
00371                                             NextPfn,
00372                                             PagesToMap,
00373                                             &amp;GranularityHint );
00374         } <span class="keywordflow">else</span> {
00375             PagesTogether = 1;
00376             GranularityHint = 0;
00377         }
00378 
00379 <span class="preprocessor">#ifdef FIRSTDBG</span>
00380 <span class="preprocessor"></span>
00381         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Physsect  PointerPte = %x, NextPfn = %x\n"</span>,
00382                        PointerPte, NextPfn );
00383         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: Va = %x  TempPte.Pfn = %x\n"</span>,
00384                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>( PointerPte ),
00385                        TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber );
00386         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesToMap = %x\n"</span>, PagesToMap );
00387         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MM: PagesTogether = %x, GH = %x\n"</span>,
00388                        PagesTogether, GranularityHint );
00389 
00390 <span class="preprocessor">#endif //FIRSTDBG</span>
00391 <span class="preprocessor"></span>
00392         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.GranularityHint = GranularityHint;
00393 
00394         NextPfn += PagesTogether;
00395         PagesToMap -= PagesTogether;
00396 
00397         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00398 
00399         <span class="keywordflow">while</span>( PagesTogether-- ){
00400 
00401             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
00402 
00403                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
00404 
00405                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a> (PointerPte)) {
00406                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
00407                     <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
00408                     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00409                         UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
00410                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_GET_USED_PTES_FROM_HANDLE (UsedPageDirectoryHandle) == 0); 
00411                 
00412                         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
00413                     }
00414                 }
00415 
00416                 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde, Process, FALSE);
00417                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00418                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (MiGetVirtualAddressMappedByPte (PointerPte));
00419             }
00420 
00421             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0 );
00422 
00423             *PointerPte = TempPte;
00424 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00425 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>            Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00428 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00429 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00430 <span class="preprocessor">#endif</span>
00431 <span class="preprocessor"></span>
00432             <span class="comment">//</span>
00433             <span class="comment">// Increment the count of non-zero page table entries for this</span>
00434             <span class="comment">// page table and the number of private pages for the process.</span>
00435             <span class="comment">//</span>
00436 
00437             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
00438 
00439             PointerPte += 1;
00440 
00441             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += 1;
00442 
00443         } <span class="comment">// while (PagesTogether-- )</span>
00444 
00445     }  <span class="comment">// while (PointerPte &lt;= LastPte)</span>
00446 
00447     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00448     *ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">// Update the current virtual size in the process header.</span>
00452     <span class="comment">//</span>
00453 
00454     *CapturedViewSize = (ULONG)((ULONG_PTR)EndingAddress - (ULONG_PTR)StartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00455     Process-&gt;VirtualSize += *CapturedViewSize;
00456 
00457     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
00458         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
00459     }
00460 
00461     <span class="comment">//</span>
00462     <span class="comment">// Translate the virtual address to a quasi-virtual address for</span>
00463     <span class="comment">// use by drivers that touch mapped devices.  Note: the routine</span>
00464     <span class="comment">// HalCreateQva will not translate the StartingAddress if the</span>
00465     <span class="comment">// StartingAddress is within system memory address space.</span>
00466     <span class="comment">//</span>
00467     <span class="comment">// N.B. - It will not work to attempt map addresses that begin in</span>
00468     <span class="comment">// system memory and extend through i/o space.</span>
00469     <span class="comment">//</span>
00470 
00471     *CapturedBase = HalCreateQva( *SectionOffset, StartingAddress );
00472 
00473     <span class="keywordflow">return</span> STATUS_SUCCESS;
00474 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
