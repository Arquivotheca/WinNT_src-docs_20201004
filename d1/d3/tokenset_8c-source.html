<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: tokenset.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>tokenset.c</h1><a href="../../d0/d4/tokenset_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Tokenset.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the SET function for the executive</span>
00012 <span class="comment">    token object.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Jim Kelly (JimK) 15-June-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d6/d6/sep_8h.html">sep.h</a>"</span>
00024 <span class="preprocessor">#include "sertlp.h"</span>
00025 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00026 
00027 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtSetInformationToken)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepFreePrimaryGroup)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepFreeDefaultDacl)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAppendPrimaryGroup)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAppendDefaultDacl)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00034 <span class="preprocessor"></span>
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00037"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a0">00037</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a0">NtSetInformationToken</a> (
00038     IN HANDLE TokenHandle,
00039     IN TOKEN_INFORMATION_CLASS TokenInformationClass,
00040     IN PVOID TokenInformation,
00041     IN ULONG TokenInformationLength
00042     )
00043 
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment"></span>
00047 <span class="comment">Routine Description:</span>
00048 <span class="comment"></span>
00049 <span class="comment">    Modify information in a specified token.</span>
00050 <span class="comment"></span>
00051 <span class="comment">Arguments:</span>
00052 <span class="comment"></span>
00053 <span class="comment">    TokenHandle - Provides a handle to the token to operate on.</span>
00054 <span class="comment"></span>
00055 <span class="comment">    TokenInformationClass - The token information class being set.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    TokenInformation - The buffer containing the new values for the</span>
00058 <span class="comment">        specified class of information.  The buffer must be aligned</span>
00059 <span class="comment">        on at least a longword boundary.  The actual structures</span>
00060 <span class="comment">        provided are dependent upon the information class specified,</span>
00061 <span class="comment">        as defined in the TokenInformationClass parameter</span>
00062 <span class="comment">        description.</span>
00063 <span class="comment"></span>
00064 <span class="comment">        TokenInformation Format By Information Class:</span>
00065 <span class="comment"></span>
00066 <span class="comment">           TokenUser =&gt; This value is not a valid value for this API.</span>
00067 <span class="comment">           The User ID may not be replaced.</span>
00068 <span class="comment"></span>
00069 <span class="comment">           TokenGroups =&gt; This value is not a valid value for this</span>
00070 <span class="comment">           API.  The Group IDs may not be replaced.  However, groups</span>
00071 <span class="comment">           may be enabled and disabled using NtAdjustGroupsToken().</span>
00072 <span class="comment"></span>
00073 <span class="comment">           TokenPrivileges =&gt; This value is not a valid value for</span>
00074 <span class="comment">           this API.  Privilege information may not be replaced.</span>
00075 <span class="comment">           However, privileges may be explicitly enabled and disabled</span>
00076 <span class="comment">           using the NtAdjustPrivilegesToken API.</span>
00077 <span class="comment"></span>
00078 <span class="comment">           TokenOwner =&gt; TOKEN_OWNER data structure.</span>
00079 <span class="comment">           TOKEN_ADJUST_DEFAULT access is needed to replace this</span>
00080 <span class="comment">           information in a token.  The owner values that may be</span>
00081 <span class="comment">           specified are restricted to the user and group IDs with an</span>
00082 <span class="comment">           attribute indicating they may be assigned as the owner of</span>
00083 <span class="comment">           objects.</span>
00084 <span class="comment"></span>
00085 <span class="comment">           TokenPrimaryGroup =&gt; TOKEN_PRIMARY_GROUP data structure.</span>
00086 <span class="comment">           TOKEN_ADJUST_DEFAULT access is needed to replace this</span>
00087 <span class="comment">           information in a token.  The primary group values that may</span>
00088 <span class="comment">           be specified are restricted to be one of the group IDs</span>
00089 <span class="comment">           already in the token.</span>
00090 <span class="comment"></span>
00091 <span class="comment">           TokenDefaultDacl =&gt; TOKEN_DEFAULT_DACL data structure.</span>
00092 <span class="comment">           TOKEN_ADJUST_DEFAULT access is needed to replace this</span>
00093 <span class="comment">           information in a token.  The ACL provided as a new default</span>
00094 <span class="comment">           discretionary ACL is not validated for structural</span>
00095 <span class="comment">           correctness or consistency.</span>
00096 <span class="comment"></span>
00097 <span class="comment">           TokenSource =&gt; This value is not a valid value for this</span>
00098 <span class="comment">           API.  The source name and context handle  may not be</span>
00099 <span class="comment">           replaced.</span>
00100 <span class="comment"></span>
00101 <span class="comment">           TokenStatistics =&gt; This value is not a valid value for this</span>
00102 <span class="comment">           API.  The statistics of a token are read-only.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    TokenInformationLength - Indicates the length, in bytes, of the</span>
00105 <span class="comment">        TokenInformation buffer.  This is only the length of the primary</span>
00106 <span class="comment">        buffer.  All extensions of the primary buffer are self describing.</span>
00107 <span class="comment"></span>
00108 <span class="comment">Return Value:</span>
00109 <span class="comment"></span>
00110 <span class="comment">    STATUS_SUCCESS - The operation was successful.</span>
00111 <span class="comment"></span>
00112 <span class="comment">    STATUS_INVALID_OWNER - The ID specified to be an owner (or</span>
00113 <span class="comment">        default owner) is not one the caller may assign as the owner</span>
00114 <span class="comment">        of an object.</span>
00115 <span class="comment"></span>
00116 <span class="comment">    STATUS_INVALID_INFO_CLASS - The specified information class is</span>
00117 <span class="comment">        not one that may be specified in this API.</span>
00118 <span class="comment"></span>
00119 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The space allotted for storage</span>
00120 <span class="comment">        of the default discretionary access control and the primary</span>
00121 <span class="comment">        group ID is not large enough to accept the new value of one</span>
00122 <span class="comment">        of these fields.</span>
00123 <span class="comment"></span>
00124 <span class="comment">--*/</span>
00125 {
00126 
00127     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00129 
00130     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00131 
00132     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00133     BOOLEAN Found;
00134     BOOLEAN TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135 
00136     ULONG NewLength;
00137     ULONG <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a>;
00138 
00139     PSID CapturedOwner;
00140     PSID CapturedPrimaryGroup;
00141     PACL CapturedDefaultDacl;
00142     ACCESS_MASK DesiredAccess;
00143 
00144     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">// Get previous processor mode and probe input buffer if necessary.</span>
00148     <span class="comment">//</span>
00149 
00150     PreviousMode = KeGetPreviousMode();
00151     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00152         <span class="keywordflow">try</span> {
00153 
00154             <span class="comment">//</span>
00155             <span class="comment">// This just probes the main part of the information buffer.</span>
00156             <span class="comment">// Any information class-specific data hung off the primary</span>
00157             <span class="comment">// buffer are self describing and must be probed separately</span>
00158             <span class="comment">// below.</span>
00159             <span class="comment">//</span>
00160 
00161             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00162                 TokenInformation,
00163                 TokenInformationLength,
00164                 <span class="keyword">sizeof</span>(ULONG)
00165                 );
00166 
00167         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00168             <span class="keywordflow">return</span> GetExceptionCode();
00169         }
00170     }
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Return error if not legal class</span>
00174     <span class="comment">//</span>
00175     <span class="keywordflow">if</span> ( (TokenInformationClass != TokenOwner)  &amp;&amp;
00176          (TokenInformationClass != TokenPrimaryGroup) &amp;&amp;
00177          (TokenInformationClass != TokenSessionId) &amp;&amp;
00178          (TokenInformationClass != TokenDefaultDacl) ) {
00179 
00180         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00181 
00182     }
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// Check access rights and reference token</span>
00186     <span class="comment">//</span>
00187 
00188 
00189     DesiredAccess = TOKEN_ADJUST_DEFAULT;
00190     <span class="keywordflow">if</span> (TokenInformationClass == TokenSessionId) {
00191         DesiredAccess |= TOKEN_ADJUST_SESSIONID;
00192     }
00193 
00194     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00195              TokenHandle,           <span class="comment">// Handle</span>
00196              DesiredAccess,         <span class="comment">// DesiredAccess</span>
00197              <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,    <span class="comment">// ObjectType</span>
00198              PreviousMode,          <span class="comment">// AccessMode</span>
00199              (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,       <span class="comment">// Object</span>
00200              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>                   <span class="comment">// GrantedAccess</span>
00201              );
00202 
00203     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00204         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00205     }
00206 
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Case on information class.</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">switch</span> ( TokenInformationClass ) {
00213 
00214     <span class="keywordflow">case</span> TokenOwner:
00215 
00216         <span class="comment">//</span>
00217         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00218         <span class="comment">//  necessary information class data structure.</span>
00219         <span class="comment">//</span>
00220 
00221         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_OWNER)) {
00222 
00223             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00224             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00225         }
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">//  Capture and copy</span>
00229 
00230         <span class="keywordflow">try</span> {
00231 
00232             <span class="comment">//</span>
00233             <span class="comment">//  Capture Owner SID</span>
00234             <span class="comment">//</span>
00235 
00236             CapturedOwner = ((PTOKEN_OWNER)TokenInformation)-&gt;Owner;
00237             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
00238                          CapturedOwner,
00239                          PreviousMode,
00240                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00241                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00242                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00243                          &amp;CapturedOwner
00244                          );
00245 
00246         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00247 
00248             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00249             <span class="keywordflow">return</span> GetExceptionCode();
00250         }
00251 
00252         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00253             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00254             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00255         }
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  Gain write access to the token.</span>
00259         <span class="comment">//</span>
00260 
00261         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00262 
00263         <span class="comment">//</span>
00264         <span class="comment">//  Walk through the list of user and group IDs looking</span>
00265         <span class="comment">//  for a match to the specified SID.  If one is found,</span>
00266         <span class="comment">//  make sure it may be assigned as an owner.  If it can,</span>
00267         <span class="comment">//  then set the index in the token's OwnerIndex field.</span>
00268         <span class="comment">//  Otherwise, return invalid owner error.</span>
00269         <span class="comment">//</span>
00270 
00271         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00272         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount) {
00273 
00274             <span class="keywordflow">try</span> {
00275 
00276                 Found = <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
00277                             CapturedOwner,
00278                             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Sid
00279                             );
00280 
00281                 <span class="keywordflow">if</span> ( Found ) {
00282 
00283                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a33">SepIdAssignableAsOwner</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) ){
00284 
00285                         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultOwnerIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00286                         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00287                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00288 
00289                     } <span class="keywordflow">else</span> {
00290 
00291                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_OWNER;
00292 
00293                     } <span class="comment">//endif assignable</span>
00294 
00295                     <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00296                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00297                     <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00298                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00299 
00300                 }  <span class="comment">//endif Found</span>
00301 
00302             } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00303 
00304                 <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00305                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00306                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00307                 <span class="keywordflow">return</span> GetExceptionCode();
00308 
00309             }  <span class="comment">//endtry</span>
00310 
00311             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00312 
00313         } <span class="comment">//endwhile</span>
00314 
00315         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00316         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00317         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedOwner, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00318         <span class="keywordflow">return</span> STATUS_INVALID_OWNER;
00319 
00320     <span class="keywordflow">case</span> TokenPrimaryGroup:
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">// Assuming everything works out, the strategy is to move everything</span>
00324         <span class="comment">// in the Dynamic part of the token (exept the primary group) to</span>
00325         <span class="comment">// the beginning of the dynamic part, freeing up the entire end of</span>
00326         <span class="comment">// the dynamic part for the new primary group.</span>
00327         <span class="comment">//</span>
00328 
00329         <span class="comment">//</span>
00330         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00331         <span class="comment">//  necessary information class data structure.</span>
00332         <span class="comment">//</span>
00333 
00334         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_PRIMARY_GROUP)) {
00335 
00336             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00337             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00338         }
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Capture And Validate TOKEN_PRIMARY_GROUP and corresponding SID.</span>
00342         <span class="comment">//</span>
00343 
00344         <span class="keywordflow">try</span> {
00345 
00346             CapturedPrimaryGroup =
00347                 ((PTOKEN_PRIMARY_GROUP)TokenInformation)-&gt;PrimaryGroup;
00348 
00349             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
00350                          CapturedPrimaryGroup,
00351                          PreviousMode,
00352                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00353                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00354                          <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00355                          &amp;CapturedPrimaryGroup
00356                          );
00357 
00358         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00359 
00360             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00361             <span class="keywordflow">return</span> GetExceptionCode();
00362         }
00363 
00364         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00365             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00366             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00367         }
00368 
00369         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/subject_8c.html#a5">SepIdAssignableAsGroup</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, CapturedPrimaryGroup )) {
00370             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00371             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00372             <span class="keywordflow">return</span> STATUS_INVALID_PRIMARY_GROUP;
00373         }
00374 
00375         <span class="comment">//</span>
00376         <span class="comment">//  Gain write access to the token.</span>
00377         <span class="comment">//</span>
00378 
00379         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00380 
00381         <span class="comment">//</span>
00382         <span class="comment">// See if there is enough room in the dynamic part of the token</span>
00383         <span class="comment">// to replace the current Primary Group with the one specified.</span>
00384         <span class="comment">//</span>
00385 
00386         NewLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( CapturedPrimaryGroup );
00387         <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00388 
00389         <span class="keywordflow">if</span> (NewLength &gt; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable) ) {
00390 
00391             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00392             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00393             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00394             <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">// Free up the existing primary group</span>
00399         <span class="comment">//</span>
00400 
00401         <a class="code" href="../../d0/d4/tokenset_8c.html#a1">SepFreePrimaryGroup</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00402 
00403         <span class="comment">//</span>
00404         <span class="comment">// And put the new SID in its place</span>
00405         <span class="comment">//</span>
00406 
00407         <a class="code" href="../../d0/d4/tokenset_8c.html#a3">SepAppendPrimaryGroup</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, CapturedPrimaryGroup );
00408 
00409         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00410 
00411         <span class="comment">//</span>
00412         <span class="comment">// All done.</span>
00413         <span class="comment">//</span>
00414 
00415         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00416         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00417         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrimaryGroup, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00418         <span class="keywordflow">return</span> STATUS_SUCCESS;
00419 
00420 
00421     <span class="keywordflow">case</span> TokenDefaultDacl:
00422 
00423         <span class="comment">//</span>
00424         <span class="comment">// Assuming everything works out, the strategy is to move everything</span>
00425         <span class="comment">// in the Dynamic part of the token (exept the default Dacl) to</span>
00426         <span class="comment">// the beginning of the dynamic part, freeing up the entire end of</span>
00427         <span class="comment">// the dynamic part for the new default Dacl.</span>
00428         <span class="comment">//</span>
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">//  Make sure the buffer is large enough to hold the</span>
00432         <span class="comment">//  necessary information class data structure.</span>
00433         <span class="comment">//</span>
00434 
00435         <span class="keywordflow">if</span> (TokenInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(TOKEN_DEFAULT_DACL)) {
00436 
00437             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00438             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00439         }
00440 
00441         <span class="comment">//</span>
00442         <span class="comment">// Capture And Validate TOKEN_DEFAULT_DACL and corresponding ACL.</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">try</span> {
00446 
00447             CapturedDefaultDacl =
00448                 ((PTOKEN_DEFAULT_DACL)TokenInformation)-&gt;DefaultDacl;
00449 
00450             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00451                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a10">SeCaptureAcl</a>(
00452                              CapturedDefaultDacl,
00453                              PreviousMode,
00454                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
00455                              <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00456                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00457                              &amp;CapturedDefaultDacl,
00458                              &amp;NewLength
00459                              );
00460 
00461             } <span class="keywordflow">else</span> {
00462                 NewLength = 0;
00463                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00464             }
00465 
00466         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00467 
00468             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00469             <span class="keywordflow">return</span> GetExceptionCode();
00470         }
00471 
00472         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00473             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00474             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00475         }
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">//  Gain write access to the token.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00482 
00483         <span class="comment">//</span>
00484         <span class="comment">// See if there is enough room in the dynamic part of the token</span>
00485         <span class="comment">// to replace the current Default Dacl with the one specified.</span>
00486         <span class="comment">//</span>
00487 
00488         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00489             <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00490         } <span class="keywordflow">else</span> {
00491             <a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> = 0;
00492         }
00493 
00494         <span class="keywordflow">if</span> (NewLength &gt; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a47">CurrentLength</a> + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable) ) {
00495 
00496             <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00497             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00498             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00499                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00500             }
00501             <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
00502         }
00503 
00504         <span class="comment">//</span>
00505         <span class="comment">// Free up the existing Default Dacl</span>
00506         <span class="comment">//</span>
00507 
00508         <a class="code" href="../../d0/d4/tokenset_8c.html#a2">SepFreeDefaultDacl</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// And put the new ACL in its place</span>
00512         <span class="comment">//</span>
00513 
00514         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00515             <a class="code" href="../../d0/d4/tokenset_8c.html#a4">SepAppendDefaultDacl</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, CapturedDefaultDacl );
00516         }
00517 
00518         TokenModified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">// All done.</span>
00522         <span class="comment">//</span>
00523 
00524         <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, TokenModified );
00525         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00526         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CapturedDefaultDacl)) {
00527             <a class="code" href="../../d2/d5/se_2capture_8c.html#a11">SeReleaseAcl</a>( CapturedDefaultDacl, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00528         }
00529         <span class="keywordflow">return</span> STATUS_SUCCESS;
00530 
00531     <span class="keywordflow">case</span> TokenSessionId:
00532     {
00533        ULONG SessionId;
00534 
00535         <span class="keywordflow">if</span> ( TokenInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
00536             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00537             <span class="keywordflow">return</span>( STATUS_INFO_LENGTH_MISMATCH );
00538         }
00539 
00540         <span class="keywordflow">try</span> {
00541 
00542            SessionId = *(PULONG)TokenInformation;
00543 
00544         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00545             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00546             <span class="keywordflow">return</span> GetExceptionCode();
00547         }
00548 
00549         <span class="comment">//</span>
00550         <span class="comment">// We only allow TCB to set SessionId's</span>
00551         <span class="comment">//</span>
00552         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a84">SeTcbPrivilege</a>,PreviousMode) ) {
00553             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00554             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00555         }
00556 
00557         <span class="comment">//</span>
00558         <span class="comment">// Set SessionId for the token</span>
00559         <span class="comment">//</span>
00560         <a class="code" href="../../d0/d4/tokenset_8c.html#a5">SeSetSessionIdToken</a>( (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00561                              SessionId );
00562 
00563         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00564         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00565     }
00566 
00567     } <span class="comment">//endswitch</span>
00568 
00569     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );  <span class="comment">// Should never reach here.</span>
00570     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00571 
00572 }
00573 
00574 
00575 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00576"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a1">00576</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a1">SepFreePrimaryGroup</a>(
00577     IN PTOKEN Token
00578     )
00579 
00580 <span class="comment">/*++</span>
00581 <span class="comment"></span>
00582 <span class="comment"></span>
00583 <span class="comment">Routine Description:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    Free up the space in the dynamic part of the token take up by the primary</span>
00586 <span class="comment">    group.</span>
00587 <span class="comment"></span>
00588 <span class="comment">    The token is assumed to be locked for write access before calling</span>
00589 <span class="comment">    this routine.</span>
00590 <span class="comment"></span>
00591 <span class="comment">Arguments:</span>
00592 <span class="comment"></span>
00593 <span class="comment">    Token - Pointer to the token.</span>
00594 <span class="comment"></span>
00595 <span class="comment">Return Value:</span>
00596 <span class="comment"></span>
00597 <span class="comment">    None.</span>
00598 <span class="comment"></span>
00599 <span class="comment">--*/</span>
00600 {
00601     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Add the size of the primary group to the DynamicAvailable field.</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// If there is a default discretionary ACL, and it is not already at the</span>
00611     <span class="comment">// beginning of the dynamic part, move it there (remember to update the</span>
00612     <span class="comment">// pointer to it).</span>
00613     <span class="comment">//</span>
00614 
00615     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00616         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00617 
00618             RtlMoveMemory(
00619                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00620                 (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl),
00621                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize
00622                 );
00623 
00624             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00625 
00626         }
00627     }
00628 
00629     <span class="keywordflow">return</span>;
00630 
00631 }
00632 
00633 
00634 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00635"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a2">00635</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a2">SepFreeDefaultDacl</a>(
00636     IN PTOKEN Token
00637     )
00638 
00639 <span class="comment">/*++</span>
00640 <span class="comment"></span>
00641 <span class="comment"></span>
00642 <span class="comment">Routine Description:</span>
00643 <span class="comment"></span>
00644 <span class="comment">    Free up the space in the dynamic part of the token take up by the default</span>
00645 <span class="comment">    discretionary access control list.</span>
00646 <span class="comment"></span>
00647 <span class="comment">    The token is assumed to be locked for write access before calling</span>
00648 <span class="comment">    this routine.</span>
00649 <span class="comment"></span>
00650 <span class="comment">Arguments:</span>
00651 <span class="comment"></span>
00652 <span class="comment">    Token - Pointer to the token.</span>
00653 <span class="comment"></span>
00654 <span class="comment">Return Value:</span>
00655 <span class="comment"></span>
00656 <span class="comment">    None.</span>
00657 <span class="comment"></span>
00658 <span class="comment">--*/</span>
00659 {
00660    ULONG PrimaryGroupSize;
00661 
00662    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00666     <span class="comment">// DynamicAvailable field.</span>
00667     <span class="comment">//</span>
00668     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00669 
00670         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable += <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00671         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00672 
00673     }
00674 
00675     <span class="comment">//</span>
00676     <span class="comment">// If it is not already at the beginning of the dynamic part, move</span>
00677     <span class="comment">// the primary group there (remember to update the pointer to it).</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart != (PULONG)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup)) {
00681 
00682         PrimaryGroupSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup );
00683 
00684         RtlMoveMemory(
00685             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart),
00686             (PVOID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup),
00687             PrimaryGroupSize
00688             );
00689 
00690         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00691     }
00692 
00693     <span class="keywordflow">return</span>;
00694 }
00695 
00696 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00697"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a3">00697</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a3">SepAppendPrimaryGroup</a>(
00698     IN PTOKEN Token,
00699     IN PSID PSid
00700     )
00701 
00702 <span class="comment">/*++</span>
00703 <span class="comment"></span>
00704 <span class="comment"></span>
00705 <span class="comment">Routine Description:</span>
00706 <span class="comment"></span>
00707 <span class="comment">    Add a primary group SID to the available space at the end of the dynamic</span>
00708 <span class="comment">    part of the token.  It is the caller's responsibility to ensure that the</span>
00709 <span class="comment">    primary group SID fits within the available space of the dynamic part of</span>
00710 <span class="comment">    the token.</span>
00711 <span class="comment"></span>
00712 <span class="comment">    The token is assumed to be locked for write access before calling</span>
00713 <span class="comment">    this routine.</span>
00714 <span class="comment"></span>
00715 <span class="comment">Arguments:</span>
00716 <span class="comment"></span>
00717 <span class="comment">    Token - Pointer to the token.</span>
00718 <span class="comment"></span>
00719 <span class="comment">    PSid - Pointer to the SID to add.</span>
00720 <span class="comment"></span>
00721 <span class="comment">Return Value:</span>
00722 <span class="comment"></span>
00723 <span class="comment">    None.</span>
00724 <span class="comment"></span>
00725 <span class="comment">--*/</span>
00726 {
00727    ULONG_PTR NextFree;
00728    ULONG SidSize;
00729 
00730    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">// Add the size of the Default Dacl (if there is one) to the</span>
00734     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00735     <span class="comment">// where the primary group should be placed.</span>
00736     <span class="comment">//</span>
00737 
00738     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl)) {
00739 
00740 <span class="comment">//        ASSERT( (ULONG)(Token-&gt;DefaultDacl-&gt;AclSize) ==</span>
00741 <span class="comment">//                (ULONG)LongAlignSize(Token-&gt;DefaultDacl-&gt;AclSize) );</span>
00742 
00743         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl-&gt;AclSize;
00744 
00745     } <span class="keywordflow">else</span> {
00746 
00747         NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart);
00748 
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Now copy the primary group SID.</span>
00753     <span class="comment">//</span>
00754 
00755 
00756     SidSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( PSid );
00757 
00758     RtlCopyMemory(
00759         (PVOID)NextFree,
00760         (PVOID)PSid,
00761         SidSize
00762         );
00763 
00764     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup = (PSID)NextFree;
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SidSize &lt;= (Token-&gt;DynamicAvailable) );
00771     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= SidSize;
00772 
00773     <span class="keywordflow">return</span>;
00774 
00775 }
00776 
00777 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00778"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a4">00778</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a4">SepAppendDefaultDacl</a>(
00779     IN PTOKEN Token,
00780     IN PACL PAcl
00781     )
00782 
00783 <span class="comment">/*++</span>
00784 <span class="comment"></span>
00785 <span class="comment"></span>
00786 <span class="comment">Routine Description:</span>
00787 <span class="comment"></span>
00788 <span class="comment">    Add a default discretionary ACL to the available space at the end of the</span>
00789 <span class="comment">    dynamic part of the token.  It is the caller's responsibility to ensure</span>
00790 <span class="comment">    that the default Dacl fits within the available space of the dynamic</span>
00791 <span class="comment">    part of the token.</span>
00792 <span class="comment"></span>
00793 <span class="comment">    The token is assumed to be locked for write access before calling</span>
00794 <span class="comment">    this routine.</span>
00795 <span class="comment"></span>
00796 <span class="comment">Arguments:</span>
00797 <span class="comment"></span>
00798 <span class="comment">    Token - Pointer to the token.</span>
00799 <span class="comment"></span>
00800 <span class="comment">    PAcl - Pointer to the ACL to add.</span>
00801 <span class="comment"></span>
00802 <span class="comment">Return Value:</span>
00803 <span class="comment"></span>
00804 <span class="comment">    None.</span>
00805 <span class="comment"></span>
00806 <span class="comment">--*/</span>
00807 {
00808    ULONG_PTR NextFree;
00809    ULONG AclSize;
00810 
00811    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Add the size of the primary group to the</span>
00815     <span class="comment">// address of the Dynamic Part of the token to establish</span>
00816     <span class="comment">// where the primary group should be placed.</span>
00817     <span class="comment">//</span>
00818 
00819     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup));
00820 
00821     NextFree = (ULONG_PTR)(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicPart) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;PrimaryGroup);
00822 
00823     <span class="comment">//</span>
00824     <span class="comment">// Now copy the default Dacl</span>
00825     <span class="comment">//</span>
00826 
00827     AclSize = (ULONG)(PAcl-&gt;AclSize);
00828 <span class="comment">//    ASSERT(AclSize == (ULONG)LongAlignSize(AclSize));</span>
00829 
00830     RtlCopyMemory(
00831         (PVOID)NextFree,
00832         (PVOID)PAcl,
00833         AclSize
00834         );
00835 
00836     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DefaultDacl = (PACL)NextFree;
00837 
00838     <span class="comment">//</span>
00839     <span class="comment">// And decrement the amount of the dynamic part that is available.</span>
00840     <span class="comment">//</span>
00841 
00842     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AclSize &lt;= (Token-&gt;DynamicAvailable) );
00843     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;DynamicAvailable -= AclSize;
00844 
00845     <span class="keywordflow">return</span>;
00846 
00847 }
00848 
00849 
00850 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00851"></a><a class="code" href="../../d0/d4/tokenset_8c.html#a5">00851</a> <a class="code" href="../../d0/d4/tokenset_8c.html#a5">SeSetSessionIdToken</a>(
00852     PACCESS_TOKEN Token,
00853     ULONG SessionId
00854     )
00855 <span class="comment">/*++</span>
00856 <span class="comment"></span>
00857 <span class="comment"></span>
00858 <span class="comment">Routine Description:</span>
00859 <span class="comment"></span>
00860 <span class="comment">    Sets the SessionId for the specified token object.</span>
00861 <span class="comment"></span>
00862 <span class="comment">Arguments:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    pOpaqueToken (input)</span>
00865 <span class="comment">      Opaque kernel Token access pointer</span>
00866 <span class="comment"></span>
00867 <span class="comment">    SessionId (input)</span>
00868 <span class="comment">      SessionId to store in token</span>
00869 <span class="comment"></span>
00870 <span class="comment">Return Value:</span>
00871 <span class="comment"></span>
00872 <span class="comment">    STATUS_SUCCESS - no error</span>
00873 <span class="comment"></span>
00874 <span class="comment">--*/</span>
00875 {
00876 
00877 
00878    <span class="comment">//</span>
00879    <span class="comment">//  Gain write access to the token.</span>
00880    <span class="comment">//</span>
00881 
00882    <a class="code" href="../../d8/d3/tokenp_8h.html#a7">SepAcquireTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00883 
00884    ((<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>)-&gt;SessionId = SessionId;
00885 
00886    <a class="code" href="../../d8/d3/tokenp_8h.html#a9">SepReleaseTokenWriteLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00887 
00888    <span class="keywordflow">return</span>( STATUS_SUCCESS );
00889 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
