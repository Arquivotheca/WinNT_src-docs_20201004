<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: accessck.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>accessck.c</h1><a href="../../d0/d4/accessck_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Accessck.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements the access check procedures.  Both NtAccessCheck</span>
00012 <span class="comment">    and SeAccessCheck check to is if a user (denoted by an input token) can</span>
00013 <span class="comment">    be granted the desired access rights to object protected by a security</span>
00014 <span class="comment">    descriptor and an optional object owner.  Both procedures use a common</span>
00015 <span class="comment">    local procedure to do the test.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Robert Reichel  (RobertRe)    11-30-90</span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel Mode</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">    Richard Ward     (RichardW)     14-Apr-92   Changed ACE_HEADER</span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/tokenp_8h.html">tokenp.h</a>"</span>
00031 <span class="preprocessor">#include &lt;sertlp.h&gt;</span>
00032 
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">//  Define the local macros and procedure for this module</span>
00036 <span class="comment">//</span>
00037 
00038 <span class="preprocessor">#if DBG</span>
00039 <span class="preprocessor"></span>
00040 <span class="keyword">extern</span> BOOLEAN SepDumpSD;
00041 <span class="keyword">extern</span> BOOLEAN SepDumpToken;
00042 BOOLEAN SepShowAccessFail;
00043 
00044 <span class="preprocessor">#endif // DBG</span>
00045 <span class="preprocessor"></span>
00046 
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00049 <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a> (
00050     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00051     IN ULONG ObjectTypeListLength,
00052     IN ULONG StartIndex
00053     );
00054 
<a name="l00055"></a><a class="code" href="../../d0/d4/accessck_8c.html#a23">00055</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {
00056     <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>,
00057     <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>,
00058     <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>
00059 } <a class="code" href="../../d0/d4/accessck_8c.html#a23">ACCESS_MASK_FIELD_TO_UPDATE</a>;
00060 
00061 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00062 <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a> (
00063     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00064     IN ULONG ObjectTypeListLength,
00065     IN ULONG StartIndex,
00066     IN ACCESS_MASK AccessMask,
00067     IN ACCESS_MASK_FIELD_TO_UPDATE FieldToUpdate
00068     );
00069 
00070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00071 <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
00072     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
00073     IN PSID PrincipalSelfSid,
00074     IN HANDLE ClientToken,
00075     IN ACCESS_MASK DesiredAccess,
00076     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
00077     IN ULONG ObjectTypeListLength,
00078     IN PGENERIC_MAPPING GenericMapping,
00079     OUT PPRIVILEGE_SET PrivilegeSet,
00080     IN OUT PULONG PrivilegeSetLength,
00081     OUT PACCESS_MASK GrantedAccess,
00082     OUT PNTSTATUS AccessStatus,
00083     IN BOOLEAN ReturnResultList
00084     );
00085 
00086 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00087 <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
00088     IN <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> EToken,
00089     IN PTOKEN PrimaryToken,
00090     IN PACL Dacl,
00091     IN PSID PrincipalSelfSid,
00092     IN ULONG LocalTypeListLength,
00093     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList,
00094     IN ULONG ObjectTypeListLength,
00095     IN BOOLEAN Restricted
00096     );
00097 
00098 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00099 <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
00100     IN ACCESS_MASK Remaining,
00101     IN PTOKEN EToken,
00102     IN PTOKEN PrimaryToken,
00103     IN PACL Dacl,
00104     IN PSID PrincipalSelfSid,
00105     IN ULONG LocalTypeListLength,
00106     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList,
00107     IN ULONG ObjectTypeListLength,
00108     IN BOOLEAN Restricted
00109     );
00110 
00111 BOOLEAN
00112 <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a> (
00113     IN PACCESS_TOKEN AToken,
00114     IN PSID PrincipalSelfSid,
00115     IN PSID Sid,
00116     IN BOOLEAN DenyAce,
00117     IN BOOLEAN Restricted
00118     );
00119 
00120 
00121 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00122 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeCaptureObjectTypeList)</span>
00123 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeFreeCapturedObjectTypeList)</span>
00124 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepUpdateParentTypeList)</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepObjectInTypeList)</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAddAccessTypeList)</span>
00127 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepSidInToken)</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepSidInTokenEx)</span>
00129 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepAccessCheck)</span>
00130 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheck)</span>
00131 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtAccessCheckByType)</span>
00132 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAccessCheckByType)</span>
00133 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeFreePrivileges)</span>
00134 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeAccessCheck)</span>
00135 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SePrivilegePolicyCheck)</span>
00136 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepTokenIsOwner)</span>
00137 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SeFastTraverseCheck)</span>
00138 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepMaximumAccessCheck)</span>
00139 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,SepNormalAccessCheck)</span>
00140 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00141 <span class="preprocessor"></span>
00142 
00143 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00144"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a21">00144</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a> (
00145     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
00146     IN ULONG ObjectTypeListLength,
00147     IN KPROCESSOR_MODE RequestorMode,
00148     OUT <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> *CapturedObjectTypeList
00149 )
00150 <span class="comment">/*++</span>
00151 <span class="comment"></span>
00152 <span class="comment">Routine Description:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    This routine probes and captures a copy of any object type list</span>
00155 <span class="comment">    that might have been provided via the ObjectTypeList argument.</span>
00156 <span class="comment"></span>
00157 <span class="comment">    The object type list is converted to the internal form that explicitly</span>
00158 <span class="comment">    specifies the hierarchical relationship between the entries.</span>
00159 <span class="comment"></span>
00160 <span class="comment">    The object typs list is validated to ensure a valid hierarchical</span>
00161 <span class="comment">    relationship is represented.</span>
00162 <span class="comment"></span>
00163 <span class="comment">Arguments:</span>
00164 <span class="comment"></span>
00165 <span class="comment">    ObjectTypeList - The object type list from which the type list</span>
00166 <span class="comment">        information is to be retrieved.</span>
00167 <span class="comment"></span>
00168 <span class="comment">    ObjectTypeListLength - Number of elements in ObjectTypeList</span>
00169 <span class="comment"></span>
00170 <span class="comment">    RequestorMode - Indicates the processor mode by which the access</span>
00171 <span class="comment">        is being requested.</span>
00172 <span class="comment"></span>
00173 <span class="comment">    CapturedObjectTypeList - Receives the captured type list which</span>
00174 <span class="comment">        must be freed using SeFreeCapturedObjectTypeList().</span>
00175 <span class="comment"></span>
00176 <span class="comment">Return Value:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    STATUS_SUCCESS indicates no exceptions were encountered.</span>
00179 <span class="comment"></span>
00180 <span class="comment">    Any access violations encountered will be returned.</span>
00181 <span class="comment"></span>
00182 <span class="comment">--*/</span>
00183 
00184 {
00185     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00186     ULONG i;
00187     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00188 
00189     ULONG Levels[ACCESS_MAX_LEVEL+1];
00190 
00191     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  Set default return</span>
00195     <span class="comment">//</span>
00196 
00197     *CapturedObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00200         <span class="keywordflow">return</span> STATUS_NOT_IMPLEMENTED;
00201     }
00202 
00203     <span class="keywordflow">try</span> {
00204 
00205         <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
00206 
00207             <span class="comment">// Drop through</span>
00208 
00209         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(ObjectTypeList) ) {
00210 
00211             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00212 
00213         } <span class="keywordflow">else</span> {
00214 
00215             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( ObjectTypeListLength, <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> ) )
00216             {
00217                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER ;
00218 
00219                 <span class="comment">//</span>
00220                 <span class="comment">// No more to do, get out of the try statement:</span>
00221                 <span class="comment">//</span>
00222 
00223                 leave ;
00224             }
00225 
00226             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( ObjectTypeList,
00227                           <span class="keyword">sizeof</span>(OBJECT_TYPE_LIST) * ObjectTypeListLength,
00228                           <span class="keyword">sizeof</span>(ULONG)
00229                           );
00230 
00231             <span class="comment">//</span>
00232             <span class="comment">// Allocate a buffer to copy into.</span>
00233             <span class="comment">//</span>
00234 
00235             LocalTypeList = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a>) * ObjectTypeListLength, 'tOeS' );
00236 
00237             <span class="keywordflow">if</span> ( LocalTypeList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00238                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">// Copy the callers structure to the local structure.</span>
00242             <span class="comment">//</span>
00243 
00244             } <span class="keywordflow">else</span> {
00245                 GUID * CapturedObjectType;
00246                 <span class="keywordflow">for</span> ( i=0; i&lt;ObjectTypeListLength; i++ ) {
00247                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> CurrentLevel;
00248 
00249                     <span class="comment">//</span>
00250                     <span class="comment">// Limit ourselves</span>
00251                     <span class="comment">//</span>
00252                     CurrentLevel = ObjectTypeList[i].Level;
00253                     <span class="keywordflow">if</span> ( CurrentLevel &gt; ACCESS_MAX_LEVEL ) {
00254                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00255                         <span class="keywordflow">break</span>;
00256                     }
00257 
00258                     <span class="comment">//</span>
00259                     <span class="comment">// Copy data the caller passed in</span>
00260                     <span class="comment">//</span>
00261                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> = CurrentLevel;
00262                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o1">Flags</a> = 0;
00263                     CapturedObjectType = ObjectTypeList[i].ObjectType;
00264                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
00265                         CapturedObjectType,
00266                         <span class="keyword">sizeof</span>(GUID),
00267                         <span class="keyword">sizeof</span>(ULONG)
00268                         );
00269                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o2">ObjectType</a> = *CapturedObjectType;
00270                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = 0;
00271                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> = 0;
00272                     LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o6">CurrentDenied</a> = 0;
00273 
00274                     <span class="comment">//</span>
00275                     <span class="comment">// Ensure that the level number is consistent with the</span>
00276                     <span class="comment">//  level number of the previous entry.</span>
00277                     <span class="comment">//</span>
00278 
00279                     <span class="keywordflow">if</span> ( i == 0 ) {
00280                         <span class="keywordflow">if</span> ( CurrentLevel != 0 ) {
00281                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00282                             <span class="keywordflow">break</span>;
00283                         }
00284 
00285                     } <span class="keywordflow">else</span> {
00286 
00287                         <span class="comment">//</span>
00288                         <span class="comment">// The previous entry is either:</span>
00289                         <span class="comment">//  my immediate parent,</span>
00290                         <span class="comment">//  my sibling, or</span>
00291                         <span class="comment">//  the child (or grandchild, etc.) of my sibling.</span>
00292                         <span class="comment">//</span>
00293                         <span class="keywordflow">if</span> ( CurrentLevel &gt; LocalTypeList[i-1].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o0">Level</a> + 1 ) {
00294                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00295                             <span class="keywordflow">break</span>;
00296                         }
00297 
00298                         <span class="comment">//</span>
00299                         <span class="comment">// Don't support two roots.</span>
00300                         <span class="comment">//</span>
00301                         <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00302                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00303                             <span class="keywordflow">break</span>;
00304                         }
00305 
00306                     }
00307 
00308                     <span class="comment">//</span>
00309                     <span class="comment">// If the above rules are maintained,</span>
00310                     <span class="comment">//  then my parent object is the last object seen that</span>
00311                     <span class="comment">//  has a level one less than mine.</span>
00312                     <span class="comment">//</span>
00313 
00314                     <span class="keywordflow">if</span> ( CurrentLevel == 0 ) {
00315                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = -1;
00316                     } <span class="keywordflow">else</span> {
00317                         LocalTypeList[i].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o3">ParentIndex</a> = Levels[CurrentLevel-1];
00318                     }
00319 
00320                     <span class="comment">//</span>
00321                     <span class="comment">// Save this obect as the last object seen at this level.</span>
00322                     <span class="comment">//</span>
00323 
00324                     Levels[CurrentLevel] = i;
00325 
00326                 }
00327 
00328             }
00329 
00330         } <span class="comment">// end_if</span>
00331 
00332     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00333 
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// If we captured any proxy data, we need to free it now.</span>
00337         <span class="comment">//</span>
00338 
00339         <span class="keywordflow">if</span> ( LocalTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00340             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalTypeList );
00341             LocalTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00342         }
00343 
00344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00345     } <span class="comment">// end_try</span>
00346 
00347     *CapturedObjectTypeList = LocalTypeList;
00348     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00349 }
00350 
00351 
00352 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00353"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a22">00353</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>(
00354     IN PVOID ObjectTypeList
00355     )
00356 
00357 <span class="comment">/*++</span>
00358 <span class="comment"></span>
00359 <span class="comment">Routine Description:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    This routine frees the data associated with a captured ObjectTypeList</span>
00362 <span class="comment">    structure.</span>
00363 <span class="comment"></span>
00364 <span class="comment">Arguments:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    ObjectTypeList - Points to a captured object type list structure.</span>
00367 <span class="comment"></span>
00368 <span class="comment">Return Value:</span>
00369 <span class="comment"></span>
00370 <span class="comment">    None.</span>
00371 <span class="comment"></span>
00372 <span class="comment">--*/</span>
00373 
00374 {
00375     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00376 
00377     <span class="keywordflow">if</span> ( ObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00378         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObjectTypeList );
00379     }
00380 
00381     <span class="keywordflow">return</span>;
00382 }
00383 
00384 
00385 
00386 
00387 BOOLEAN
<a name="l00388"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a39">00388</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a> (
00389     IN GUID *ObjectType,
00390     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00391     IN ULONG ObjectTypeListLength,
00392     OUT PULONG ReturnedIndex
00393 )
00394 <span class="comment">/*++</span>
00395 <span class="comment"></span>
00396 <span class="comment">Routine Description:</span>
00397 <span class="comment"></span>
00398 <span class="comment">    This routine searches an ObjectTypeList to determine if the specified</span>
00399 <span class="comment">    object type is in the list.</span>
00400 <span class="comment"></span>
00401 <span class="comment">Arguments:</span>
00402 <span class="comment"></span>
00403 <span class="comment">    ObjectType - Object Type to search for.</span>
00404 <span class="comment"></span>
00405 <span class="comment">    ObjectTypeList - The object type list to search.</span>
00406 <span class="comment"></span>
00407 <span class="comment">    ObjectTypeListLength - Number of elements in ObjectTypeList</span>
00408 <span class="comment"></span>
00409 <span class="comment">    ReturnedIndex - Index to the element ObjectType was found in</span>
00410 <span class="comment"></span>
00411 <span class="comment"></span>
00412 <span class="comment">Return Value:</span>
00413 <span class="comment"></span>
00414 <span class="comment">    TRUE: ObjectType was found in list.</span>
00415 <span class="comment">    FALSE: ObjectType was not found in list.</span>
00416 <span class="comment"></span>
00417 <span class="comment">--*/</span>
00418 
00419 {
00420     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00421     GUID *LocalObjectType;
00422 
00423     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00424 
00425     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(GUID) == <span class="keyword">sizeof</span>(ULONG) * 4 );
00426     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00427 
00428         LocalObjectType = &amp;ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].ObjectType;
00429 
00430         <span class="keywordflow">if</span>  ( RtlpIsEqualGuid( ObjectType, LocalObjectType ) ) {
00431             *ReturnedIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00432             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00433         }
00434     }
00435 
00436     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00437 }
00438 
00439 
00440 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00441"></a><a class="code" href="../../d0/d4/accessck_8c.html#a3">00441</a> <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a> (
00442     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00443     IN ULONG ObjectTypeListLength,
00444     IN ULONG StartIndex
00445 )
00446 <span class="comment">/*++</span>
00447 <span class="comment"></span>
00448 <span class="comment">Routine Description:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    Update the Access fields of the parent object of the specified object.</span>
00451 <span class="comment"></span>
00452 <span class="comment"></span>
00453 <span class="comment">        The "remaining" field of a parent object is the logical OR of</span>
00454 <span class="comment">        the remaining field of all of its children.</span>
00455 <span class="comment"></span>
00456 <span class="comment">        The CurrentGranted field of the parent is the collection of bits</span>
00457 <span class="comment">        granted to every one of its children..</span>
00458 <span class="comment"></span>
00459 <span class="comment">        The CurrentDenied fields of the parent is the logical OR of</span>
00460 <span class="comment">        the bits denied to any of its children.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    This routine takes an index to one of the children and updates the</span>
00463 <span class="comment">    remaining field of the parent (and grandparents recursively).</span>
00464 <span class="comment"></span>
00465 <span class="comment">Arguments:</span>
00466 <span class="comment"></span>
00467 <span class="comment">    ObjectTypeList - The object type list to update.</span>
00468 <span class="comment"></span>
00469 <span class="comment">    ObjectTypeListLength - Number of elements in ObjectTypeList</span>
00470 <span class="comment"></span>
00471 <span class="comment">    StartIndex - Index to the "child" element whose parents are to be updated.</span>
00472 <span class="comment"></span>
00473 <span class="comment">Return Value:</span>
00474 <span class="comment"></span>
00475 <span class="comment">    None.</span>
00476 <span class="comment"></span>
00477 <span class="comment"></span>
00478 <span class="comment">--*/</span>
00479 
00480 {
00481     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00482     ULONG ParentIndex;
00483     ULONG Level;
00484     ACCESS_MASK NewRemaining = 0;
00485     ACCESS_MASK NewCurrentGranted = 0xFFFFFFFF;
00486     ACCESS_MASK NewCurrentDenied = 0;
00487 
00488     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// If the target node is at the root,</span>
00492     <span class="comment">//  we're all done.</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> ( ObjectTypeList[StartIndex].ParentIndex == -1 ) {
00496         <span class="keywordflow">return</span>;
00497     }
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Get the index to the parent that needs updating and the level of</span>
00501     <span class="comment">// the siblings.</span>
00502     <span class="comment">//</span>
00503 
00504     ParentIndex = ObjectTypeList[StartIndex].ParentIndex;
00505     Level = ObjectTypeList[StartIndex].Level;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Loop through all the children.</span>
00509     <span class="comment">//</span>
00510 
00511     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=ParentIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// By definition, the children of an object are all those entries</span>
00515         <span class="comment">// immediately following the target.  The list of children (or</span>
00516         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
00517         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
00518         <span class="comment">// (an uncle).</span>
00519         <span class="comment">//</span>
00520 
00521         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[ParentIndex].Level ) {
00522             <span class="keywordflow">break</span>;
00523         }
00524 
00525         <span class="comment">//</span>
00526         <span class="comment">// Only handle direct children of the parent.</span>
00527         <span class="comment">//</span>
00528 
00529         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level != Level ) {
00530             <span class="keywordflow">continue</span>;
00531         }
00532 
00533         <span class="comment">//</span>
00534         <span class="comment">// Compute the new bits for the parent.</span>
00535         <span class="comment">//</span>
00536 
00537         NewRemaining |= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining;
00538         NewCurrentGranted &amp;= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted;
00539         NewCurrentDenied |= ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied;
00540 
00541     }
00542 
00543     <span class="comment">//</span>
00544     <span class="comment">// If we've not changed the access to the parent,</span>
00545     <span class="comment">//  we're done.</span>
00546     <span class="comment">//</span>
00547 
00548     <span class="keywordflow">if</span> ( NewRemaining == ObjectTypeList[ParentIndex].Remaining &amp;&amp;
00549          NewCurrentGranted == ObjectTypeList[ParentIndex].CurrentGranted &amp;&amp;
00550         NewCurrentDenied == ObjectTypeList[ParentIndex].CurrentDenied ) {
00551         <span class="keywordflow">return</span>;
00552     }
00553 
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Change the parent.</span>
00557     <span class="comment">//</span>
00558 
00559     ObjectTypeList[ParentIndex].Remaining = NewRemaining;
00560     ObjectTypeList[ParentIndex].CurrentGranted = NewCurrentGranted;
00561     ObjectTypeList[ParentIndex].CurrentDenied = NewCurrentDenied;
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Go update the grand parents.</span>
00565     <span class="comment">//</span>
00566 
00567     <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a>( ObjectTypeList,
00568                              ObjectTypeListLength,
00569                              ParentIndex );
00570 }
00571 
00572 
00573 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00574"></a><a class="code" href="../../d0/d4/accessck_8c.html#a4">00574</a> <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a> (
00575     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList,
00576     IN ULONG ObjectTypeListLength,
00577     IN ULONG StartIndex,
00578     IN ACCESS_MASK AccessMask,
00579     IN ACCESS_MASK_FIELD_TO_UPDATE FieldToUpdate
00580 )
00581 <span class="comment">/*++</span>
00582 <span class="comment"></span>
00583 <span class="comment">Routine Description:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    This routine grants the specified AccessMask to all of the objects that</span>
00586 <span class="comment">    are descendents of the object specified by StartIndex.</span>
00587 <span class="comment"></span>
00588 <span class="comment">    The Access fields of the parent objects are also recomputed as needed.</span>
00589 <span class="comment"></span>
00590 <span class="comment">    For example, if an ACE granting access to a Property Set is found,</span>
00591 <span class="comment">        that access is granted to all the Properties in the Property Set.</span>
00592 <span class="comment"></span>
00593 <span class="comment">Arguments:</span>
00594 <span class="comment"></span>
00595 <span class="comment">    ObjectTypeList - The object type list to update.</span>
00596 <span class="comment"></span>
00597 <span class="comment">    ObjectTypeListLength - Number of elements in ObjectTypeList</span>
00598 <span class="comment"></span>
00599 <span class="comment">    StartIndex - Index to the target element to update.</span>
00600 <span class="comment"></span>
00601 <span class="comment">    AccessMask - Mask of access to grant to the target element and</span>
00602 <span class="comment">        all of its decendents</span>
00603 <span class="comment"></span>
00604 <span class="comment">    FieldToUpdate - Indicate which fields to update in object type list</span>
00605 <span class="comment"></span>
00606 <span class="comment">Return Value:</span>
00607 <span class="comment"></span>
00608 <span class="comment">    None.</span>
00609 <span class="comment"></span>
00610 <span class="comment">--*/</span>
00611 
00612 {
00613     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00614     ACCESS_MASK OldRemaining;
00615     ACCESS_MASK OldCurrentGranted;
00616     ACCESS_MASK OldCurrentDenied;
00617     BOOLEAN AvoidParent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00618 
00619     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// Update the requested field.</span>
00623     <span class="comment">//</span>
00624     <span class="comment">// Always handle the target entry.</span>
00625     <span class="comment">//</span>
00626     <span class="comment">// If we've not actually changed the bits,</span>
00627     <span class="comment">//  early out.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">switch</span> (FieldToUpdate ) {
00631     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>:
00632 
00633         OldRemaining = ObjectTypeList[StartIndex].Remaining;
00634         ObjectTypeList[StartIndex].Remaining = OldRemaining &amp; ~AccessMask;
00635 
00636         <span class="keywordflow">if</span> ( OldRemaining == ObjectTypeList[StartIndex].Remaining ) {
00637             <span class="keywordflow">return</span>;
00638         }
00639         <span class="keywordflow">break</span>;
00640 
00641     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>:
00642 
00643         OldCurrentGranted = ObjectTypeList[StartIndex].CurrentGranted;
00644         ObjectTypeList[StartIndex].CurrentGranted |=
00645             AccessMask &amp; ~ObjectTypeList[StartIndex].CurrentDenied;
00646 
00647         <span class="keywordflow">if</span> ( OldCurrentGranted == ObjectTypeList[StartIndex].CurrentGranted ) {
00648             <span class="comment">//</span>
00649             <span class="comment">// We can't simply return here.</span>
00650             <span class="comment">// We have to visit our children.  Consider the case where there</span>
00651             <span class="comment">// was a previous deny ACE on a child.  That deny would have</span>
00652             <span class="comment">// propagated up the tree to this entry.  However, this allow ACE</span>
00653             <span class="comment">// needs to be added all of the children that haven't been</span>
00654             <span class="comment">// explictly denied.</span>
00655             <span class="comment">//</span>
00656             AvoidParent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00657         }
00658         <span class="keywordflow">break</span>;
00659 
00660     <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>:
00661 
00662         OldCurrentDenied = ObjectTypeList[StartIndex].CurrentDenied;
00663         ObjectTypeList[StartIndex].CurrentDenied |=
00664             AccessMask &amp; ~ObjectTypeList[StartIndex].CurrentGranted;
00665 
00666         <span class="keywordflow">if</span> ( OldCurrentDenied == ObjectTypeList[StartIndex].CurrentDenied ) {
00667             <span class="keywordflow">return</span>;
00668         }
00669         <span class="keywordflow">break</span>;
00670 
00671     <span class="keywordflow">default</span>:
00672         <span class="keywordflow">return</span>;
00673     }
00674 
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Go update parent of the target.</span>
00678     <span class="comment">//</span>
00679 
00680     <span class="keywordflow">if</span> ( !AvoidParent ) {
00681         <a class="code" href="../../d0/d4/accessck_8c.html#a3">SepUpdateParentTypeList</a>( ObjectTypeList,
00682                                  ObjectTypeListLength,
00683                                  StartIndex );
00684     }
00685 
00686     <span class="comment">//</span>
00687     <span class="comment">// Loop handling all children of the target.</span>
00688     <span class="comment">//</span>
00689 
00690     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=StartIndex+1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>&lt;ObjectTypeListLength; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00691 
00692         <span class="comment">//</span>
00693         <span class="comment">// By definition, the children of an object are all those entries</span>
00694         <span class="comment">// immediately following the target.  The list of children (or</span>
00695         <span class="comment">// grandchildren) stops as soon as we reach an entry the has the</span>
00696         <span class="comment">// same level as the target (a sibling) or lower than the target</span>
00697         <span class="comment">// (an uncle).</span>
00698         <span class="comment">//</span>
00699 
00700         <span class="keywordflow">if</span> ( ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Level &lt;= ObjectTypeList[StartIndex].Level ) {
00701             <span class="keywordflow">break</span>;
00702         }
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Grant access to the children</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="keywordflow">switch</span> (FieldToUpdate) {
00709         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a>:
00710 
00711             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining &amp;= ~AccessMask;
00712             <span class="keywordflow">break</span>;
00713 
00714         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a>:
00715 
00716             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted |=
00717                 AccessMask &amp; ~ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied;
00718             <span class="keywordflow">break</span>;
00719 
00720         <span class="keywordflow">case</span> <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a>:
00721 
00722             ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentDenied |=
00723                 AccessMask &amp; ~ObjectTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].CurrentGranted;
00724             <span class="keywordflow">break</span>;
00725 
00726         <span class="keywordflow">default</span>:
00727             <span class="keywordflow">return</span>;
00728         }
00729     }
00730 }
00731 
00732 BOOLEAN
<a name="l00733"></a><a class="code" href="../../d6/d6/sep_8h.html#a61">00733</a> <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a> (
00734     IN PACCESS_TOKEN AToken,
00735     IN PSID PrincipalSelfSid,
00736     IN PSID Sid,
00737     IN BOOLEAN DenyAce
00738     )
00739 
00740 <span class="comment">/*++</span>
00741 <span class="comment"></span>
00742 <span class="comment">Routine Description:</span>
00743 <span class="comment"></span>
00744 <span class="comment">    Checks to see if a given SID is in the given token.</span>
00745 <span class="comment"></span>
00746 <span class="comment">    N.B. The code to compute the length of a SID and test for equality</span>
00747 <span class="comment">         is duplicated from the security runtime since this is such a</span>
00748 <span class="comment">         frequently used routine.</span>
00749 <span class="comment"></span>
00750 <span class="comment">Arguments:</span>
00751 <span class="comment"></span>
00752 <span class="comment">    Token - Pointer to the token to be examined</span>
00753 <span class="comment"></span>
00754 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
00755 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
00756 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
00757 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
00758 <span class="comment"></span>
00759 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
00760 <span class="comment"></span>
00761 <span class="comment"></span>
00762 <span class="comment">    Sid - Pointer to the SID of interest</span>
00763 <span class="comment"></span>
00764 <span class="comment">Return Value:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    A value of TRUE indicates that the SID is in the token, FALSE</span>
00767 <span class="comment">    otherwise.</span>
00768 <span class="comment"></span>
00769 <span class="comment">--*/</span>
00770 
00771 {
00772 
00773     ULONG i;
00774     PISID MatchSid;
00775     ULONG SidLength;
00776     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00777     PSID_AND_ATTRIBUTES TokenSid;
00778     ULONG UserAndGroupCount;
00779 
00780     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00781 
00782 <span class="preprocessor">#if DBG</span>
00783 <span class="preprocessor"></span>
00784     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>(AToken);
00785 
00786 <span class="preprocessor">#endif</span>
00787 <span class="preprocessor"></span>
00788     <span class="comment">//</span>
00789     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00790     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00791     <span class="comment">//</span>
00792 
00793     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00794          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a48">SePrincipalSelfSid</a>, Sid ) ) {
00795         Sid = PrincipalSelfSid;
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00800     <span class="comment">// once.</span>
00801     <span class="comment">//</span>
00802 
00803     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">// Get address of user/group array and number of user/groups.</span>
00807     <span class="comment">//</span>
00808 
00809     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AToken;
00810     TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups;
00811     UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00812 
00813     <span class="comment">//</span>
00814     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
00815     <span class="comment">// specified SID.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">for</span> (i = 0 ; i &lt; UserAndGroupCount ; i += 1) {
00819         MatchSid = (PISID)TokenSid-&gt;Sid;
00820 
00821         <span class="comment">//</span>
00822         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
00823         <span class="comment">// for equality.</span>
00824         <span class="comment">//</span>
00825 
00826         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
00827             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
00828             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
00829 
00830                 <span class="comment">//</span>
00831                 <span class="comment">// If this is the first one in the list, then it is the User,</span>
00832                 <span class="comment">// and return success immediately.</span>
00833                 <span class="comment">//</span>
00834                 <span class="comment">// If this is not the first one, then it represents a group,</span>
00835                 <span class="comment">// and we must make sure the group is currently enabled before</span>
00836                 <span class="comment">// we can say that the group is "in" the token.</span>
00837                 <span class="comment">//</span>
00838 
00839                 <span class="keywordflow">if</span> ((i == 0) || (TokenSid-&gt;Attributes &amp; SE_GROUP_ENABLED) ||
00840                     (DenyAce &amp;&amp; (TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY))) {
00841                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00842 
00843                 } <span class="keywordflow">else</span> {
00844                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00845                 }
00846             }
00847         }
00848 
00849         TokenSid += 1;
00850     }
00851 
00852     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00853 }
00854 
00855 BOOLEAN
<a name="l00856"></a><a class="code" href="../../d0/d4/accessck_8c.html#a8">00856</a> <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a> (
00857     IN PACCESS_TOKEN AToken,
00858     IN PSID PrincipalSelfSid,
00859     IN PSID Sid,
00860     IN BOOLEAN DenyAce,
00861     IN BOOLEAN Restricted
00862     )
00863 
00864 <span class="comment">/*++</span>
00865 <span class="comment"></span>
00866 <span class="comment">Routine Description:</span>
00867 <span class="comment"></span>
00868 <span class="comment">    Checks to see if a given restricted SID is in the given token.</span>
00869 <span class="comment"></span>
00870 <span class="comment">    N.B. The code to compute the length of a SID and test for equality</span>
00871 <span class="comment">         is duplicated from the security runtime since this is such a</span>
00872 <span class="comment">         frequently used routine.</span>
00873 <span class="comment"></span>
00874 <span class="comment">Arguments:</span>
00875 <span class="comment"></span>
00876 <span class="comment">    Token - Pointer to the token to be examined</span>
00877 <span class="comment"></span>
00878 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
00879 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
00880 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
00881 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
00882 <span class="comment"></span>
00883 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
00884 <span class="comment"></span>
00885 <span class="comment"></span>
00886 <span class="comment">    Sid - Pointer to the SID of interest</span>
00887 <span class="comment"></span>
00888 <span class="comment">    DenyAce - The ACE being evaluated is a DENY or ACCESS DENIED ace</span>
00889 <span class="comment"></span>
00890 <span class="comment">    Restricted - The access check being performed uses the restricted sids.</span>
00891 <span class="comment"></span>
00892 <span class="comment">Return Value:</span>
00893 <span class="comment"></span>
00894 <span class="comment">    A value of TRUE indicates that the SID is in the token, FALSE</span>
00895 <span class="comment">    otherwise.</span>
00896 <span class="comment"></span>
00897 <span class="comment">--*/</span>
00898 
00899 {
00900 
00901     ULONG i;
00902     PISID MatchSid;
00903     ULONG SidLength;
00904     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00905     PSID_AND_ATTRIBUTES TokenSid;
00906     ULONG UserAndGroupCount;
00907 
00908     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00909 
00910 <span class="preprocessor">#if DBG</span>
00911 <span class="preprocessor"></span>
00912     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>(AToken);
00913 
00914 <span class="preprocessor">#endif</span>
00915 <span class="preprocessor"></span>
00916     <span class="comment">//</span>
00917     <span class="comment">// If Sid is the constant PrincipalSelfSid,</span>
00918     <span class="comment">//  replace it with the passed in PrincipalSelfSid.</span>
00919     <span class="comment">//</span>
00920 
00921     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00922          <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a48">SePrincipalSelfSid</a>, Sid ) ) {
00923         Sid = PrincipalSelfSid;
00924     }
00925 
00926     <span class="comment">//</span>
00927     <span class="comment">// Get the length of the source SID since this only needs to be computed</span>
00928     <span class="comment">// once.</span>
00929     <span class="comment">//</span>
00930 
00931     SidLength = 8 + (4 * ((PISID)Sid)-&gt;SubAuthorityCount);
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">// Get address of user/group array and number of user/groups.</span>
00935     <span class="comment">//</span>
00936 
00937     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)AToken;
00938     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>) {
00939         TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSids;
00940         UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;RestrictedSidCount;
00941     } <span class="keywordflow">else</span> {
00942         TokenSid = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroups;
00943         UserAndGroupCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;UserAndGroupCount;
00944     }
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">// Scan through the user/groups and attempt to find a match with the</span>
00948     <span class="comment">// specified SID.</span>
00949     <span class="comment">//</span>
00950 
00951     <span class="keywordflow">for</span> (i = 0; i &lt; UserAndGroupCount ; i += 1) {
00952         MatchSid = (PISID)TokenSid-&gt;Sid;
00953 
00954         <span class="comment">//</span>
00955         <span class="comment">// If the SID revision and length matches, then compare the SIDs</span>
00956         <span class="comment">// for equality.</span>
00957         <span class="comment">//</span>
00958 
00959         <span class="keywordflow">if</span> ((((PISID)Sid)-&gt;Revision == MatchSid-&gt;Revision) &amp;&amp;
00960             (SidLength == (8 + (4 * (ULONG)MatchSid-&gt;SubAuthorityCount)))) {
00961             <span class="keywordflow">if</span> (RtlEqualMemory(Sid, MatchSid, SidLength)) {
00962 
00963                 <span class="comment">//</span>
00964                 <span class="comment">// If this is the first one in the list and not deny-only it</span>
00965                 <span class="comment">// is not a restricted token then it is the User, and return</span>
00966                 <span class="comment">// success immediately.</span>
00967                 <span class="comment">//</span>
00968                 <span class="comment">// If this is not the first one, then it represents a group,</span>
00969                 <span class="comment">// and we must make sure the group is currently enabled before</span>
00970                 <span class="comment">// we can say that the group is "in" the token.</span>
00971                 <span class="comment">//</span>
00972 
00973                 <span class="keywordflow">if</span> ((!<a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> &amp;&amp; (i == 0) &amp;&amp; ((TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY) == 0)) ||
00974                     (TokenSid-&gt;Attributes &amp; SE_GROUP_ENABLED) ||
00975                     (DenyAce &amp;&amp; (TokenSid-&gt;Attributes &amp; SE_GROUP_USE_FOR_DENY_ONLY))) {
00976                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00977 
00978                 } <span class="keywordflow">else</span> {
00979                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00980                 }
00981 
00982             }
00983         }
00984 
00985         TokenSid += 1;
00986     }
00987 
00988     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00989 }
00990 
00991 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00992"></a><a class="code" href="../../d0/d4/accessck_8c.html#a6">00992</a> <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
00993     IN PTOKEN EToken,
00994     IN PTOKEN PrimaryToken,
00995     IN PACL Dacl,
00996     IN PSID PrincipalSelfSid,
00997     IN ULONG LocalTypeListLength,
00998     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList,
00999     IN ULONG ObjectTypeListLength,
01000     IN BOOLEAN Restricted
01001     )
01002 <span class="comment">/*++</span>
01003 <span class="comment"></span>
01004 <span class="comment">Routine Description:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    Does an access check for maximum allowed or with a result list. If the</span>
01007 <span class="comment">    Restricted flag is set, it is done for a restricted token. The sids</span>
01008 <span class="comment">    checked are the restricted sids, not the users and groups. The current</span>
01009 <span class="comment">    granted access is stored in the Remaining access and then another access</span>
01010 <span class="comment">    check is run.</span>
01011 <span class="comment"></span>
01012 <span class="comment">Arguments:</span>
01013 <span class="comment"></span>
01014 <span class="comment">    EToken - Effective token of caller.</span>
01015 <span class="comment"></span>
01016 <span class="comment">    PrimaryToken - Process token of calling process</span>
01017 <span class="comment"></span>
01018 <span class="comment">    Dacl - ACL to check</span>
01019 <span class="comment"></span>
01020 <span class="comment">    PrincipalSelfSid - Sid to use in replacing the well-known self sid</span>
01021 <span class="comment"></span>
01022 <span class="comment">    LocalTypeListLength - Length of list of types.</span>
01023 <span class="comment"></span>
01024 <span class="comment">    LocalTypeList - List of types.</span>
01025 <span class="comment"></span>
01026 <span class="comment">    ObjectTypeList - Length of caller-supplied list of object types.</span>
01027 <span class="comment"></span>
01028 <span class="comment">Return Value:</span>
01029 <span class="comment"></span>
01030 <span class="comment">    none</span>
01031 <span class="comment"></span>
01032 <span class="comment">--*/</span>
01033 
01034 {
01035     ULONG i,j;
01036     PVOID Ace;
01037     ULONG AceCount;
01038     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01039     ULONG ResultListIndex;
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">// The remaining bits are the granted bits for each object type on a</span>
01043     <span class="comment">// restricted check</span>
01044     <span class="comment">//</span>
01045 
01046     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) {
01047         <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
01048             LocalTypeList[j].Remaining = LocalTypeList[j].CurrentGranted;
01049             LocalTypeList[j].CurrentGranted = 0;
01050         }
01051     }
01052 
01053 
01054     AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount;
01055 
01056     <span class="comment">//</span>
01057     <span class="comment">// granted == NUL</span>
01058     <span class="comment">// denied == NUL</span>
01059     <span class="comment">//</span>
01060     <span class="comment">//  for each ACE</span>
01061     <span class="comment">//</span>
01062     <span class="comment">//      if grant</span>
01063     <span class="comment">//          for each SID</span>
01064     <span class="comment">//              if SID match, then add all that is not denied to grant mask</span>
01065     <span class="comment">//</span>
01066     <span class="comment">//      if deny</span>
01067     <span class="comment">//          for each SID</span>
01068     <span class="comment">//              if SID match, then add all that is not granted to deny mask</span>
01069     <span class="comment">//</span>
01070 
01071     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> ) ;
01072           i &lt; AceCount  ;
01073           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )
01074         ) {
01075 
01076         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
01077 
01078             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
01079 
01080                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> )) {
01081 
01082                     <span class="comment">//</span>
01083                     <span class="comment">// Only grant access types from this mask that have</span>
01084                     <span class="comment">// not already been denied</span>
01085                     <span class="comment">//</span>
01086 
01087                     <span class="comment">// Optimize 'normal' case</span>
01088                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01089                         LocalTypeList-&gt;CurrentGranted |=
01090                            (((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01091                     } <span class="keywordflow">else</span> {
01092                        <span class="comment">//</span>
01093                        <span class="comment">// The zeroeth object type represents the object itself.</span>
01094                        <span class="comment">//</span>
01095                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01096                             LocalTypeList,          <span class="comment">// List to modify</span>
01097                             LocalTypeListLength,    <span class="comment">// Length of list</span>
01098                             0,                      <span class="comment">// Element to update</span>
01099                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01100                             <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a> );
01101                     }
01102                  }
01103 
01104 
01105              <span class="comment">//</span>
01106              <span class="comment">// Handle an object specific Access Allowed ACE</span>
01107              <span class="comment">//</span>
01108              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
01109                  GUID *ObjectTypeInAce;
01110 
01111                  <span class="comment">//</span>
01112                  <span class="comment">// If no object type is in the ACE,</span>
01113                  <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
01114                  <span class="comment">//</span>
01115 
01116                  ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01117 
01118                  <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01119 
01120                      <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01121 
01122                          <span class="comment">// Optimize 'normal' case</span>
01123                          <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01124                              LocalTypeList-&gt;CurrentGranted |=
01125                                 (((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01126                          } <span class="keywordflow">else</span> {
01127                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01128                                  LocalTypeList,          <span class="comment">// List to modify</span>
01129                                  LocalTypeListLength,    <span class="comment">// Length of list</span>
01130                                  0,                      <span class="comment">// Element to update</span>
01131                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01132                                  <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a> );
01133                          }
01134                      }
01135 
01136                  <span class="comment">//</span>
01137                  <span class="comment">// If no object type list was passed,</span>
01138                  <span class="comment">//  don't grant access to anyone.</span>
01139                  <span class="comment">//</span>
01140 
01141                  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01142 
01143                      <span class="comment">// Drop through</span>
01144 
01145 
01146                 <span class="comment">//</span>
01147                 <span class="comment">// If an object type is in the ACE,</span>
01148                 <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01149                 <span class="comment">//</span>
01150                 } <span class="keywordflow">else</span> {
01151 
01152                      <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01153 
01154                          <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01155                                                    LocalTypeList,
01156                                                    LocalTypeListLength,
01157                                                    &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
01158                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01159                                   LocalTypeList,          <span class="comment">// List to modify</span>
01160                                   LocalTypeListLength,   <span class="comment">// Length of list</span>
01161                                   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,                  <span class="comment">// Element already updated</span>
01162                                   ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01163                                   <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a> );
01164                          }
01165                      }
01166                 }
01167 
01168              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
01169 
01170                  <span class="comment">//</span>
01171                  <span class="comment">//  If we're impersonating, EToken is set to the Client, and if we're not,</span>
01172                  <span class="comment">//  EToken is set to the Primary.  According to the DSA architecture, if</span>
01173                  <span class="comment">//  we're asked to evaluate a compound ACE and we're not impersonating,</span>
01174                  <span class="comment">//  pretend we are impersonating ourselves.  So we can just use the EToken</span>
01175                  <span class="comment">//  for the client token, since it's already set to the right thing.</span>
01176                  <span class="comment">//</span>
01177 
01178 
01179                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>) &amp;&amp;
01180                       <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RtlCompoundAceServerSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
01181                     ) {
01182 
01183                      <span class="comment">//</span>
01184                      <span class="comment">// Only grant access types from this mask that have</span>
01185                      <span class="comment">// not already been denied</span>
01186                      <span class="comment">//</span>
01187 
01188                      <span class="comment">// Optimize 'normal' case</span>
01189                      <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01190                          LocalTypeList-&gt;CurrentGranted |=
01191                             (((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentDenied);
01192                      } <span class="keywordflow">else</span> {
01193                         <span class="comment">//</span>
01194                         <span class="comment">// The zeroeth object type represents the object itself.</span>
01195                         <span class="comment">//</span>
01196                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01197                              LocalTypeList,          <span class="comment">// List to modify</span>
01198                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01199                              0,                      <span class="comment">// Element to update</span>
01200                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01201                              <a class="code" href="../../d0/d4/accessck_8c.html#a23a1">UpdateCurrentGranted</a> );
01202                      }
01203 
01204                  }
01205 
01206 
01207              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
01208 
01209                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> )) {
01210 
01211                       <span class="comment">//</span>
01212                       <span class="comment">// Only deny access types from this mask that have</span>
01213                       <span class="comment">// not already been granted</span>
01214                       <span class="comment">//</span>
01215 
01216                      <span class="comment">// Optimize 'normal' case</span>
01217                      <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01218                          LocalTypeList-&gt;CurrentDenied |=
01219                              (((PACCESS_DENIED_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01220                      } <span class="keywordflow">else</span> {
01221                          <span class="comment">//</span>
01222                          <span class="comment">// The zeroeth object type represents the object itself.</span>
01223                          <span class="comment">//</span>
01224                          <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01225                              LocalTypeList,          <span class="comment">// List to modify</span>
01226                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01227                              0,                      <span class="comment">// Element to update</span>
01228                              ((PACCESS_DENIED_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01229                              <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a> );
01230                     }
01231                  }
01232 
01233 
01234              <span class="comment">//</span>
01235              <span class="comment">// Handle an object specific Access Denied ACE</span>
01236              <span class="comment">//</span>
01237              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
01238 
01239                  <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01240                      GUID *ObjectTypeInAce;
01241 
01242                      <span class="comment">//</span>
01243                      <span class="comment">// If there is no object type in the ACE,</span>
01244                      <span class="comment">//  or if the caller didn't specify an object type list,</span>
01245                      <span class="comment">//  apply this deny ACE to the entire object.</span>
01246                      <span class="comment">//</span>
01247 
01248                      ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01249 
01250                      <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01251 
01252                          <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01253                              LocalTypeList-&gt;CurrentDenied |=
01254                                  (((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01255                          } <span class="keywordflow">else</span> {
01256 
01257                              <span class="comment">//</span>
01258                              <span class="comment">// The zeroeth object type represents the object itself.</span>
01259                              <span class="comment">//</span>
01260 
01261                              <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01262                                  LocalTypeList,          <span class="comment">// List to modify</span>
01263                                  LocalTypeListLength,    <span class="comment">// Length of list</span>
01264                                  0,
01265                                  ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01266                                  <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a> );
01267                          }
01268                      <span class="comment">//</span>
01269                      <span class="comment">// If no object type list was passed,</span>
01270                      <span class="comment">//  don't grant access to anyone.</span>
01271                      <span class="comment">//</span>
01272 
01273                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01274 
01275                          LocalTypeList-&gt;CurrentDenied |=
01276                              (((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask &amp; ~LocalTypeList-&gt;CurrentGranted);
01277 
01278 
01279                      <span class="comment">//</span>
01280                      <span class="comment">// If an object type is in the ACE,</span>
01281                      <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01282                      <span class="comment">//</span>
01283 
01284                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01285                                                           LocalTypeList,
01286                                                           LocalTypeListLength,
01287                                                           &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
01288 
01289                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01290                                 LocalTypeList,          <span class="comment">// List to modify</span>
01291                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
01292                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,                  <span class="comment">// Element to update</span>
01293                                 ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access denied</span>
01294                                 <a class="code" href="../../d0/d4/accessck_8c.html#a23a2">UpdateCurrentDenied</a> );
01295 
01296                     }
01297                 }
01298             }
01299         }
01300     }
01301 }
01302 
01303 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01304"></a><a class="code" href="../../d0/d4/accessck_8c.html#a7">01304</a> <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
01305     IN ACCESS_MASK Remaining,
01306     IN PTOKEN EToken,
01307     IN PTOKEN PrimaryToken,
01308     IN PACL Dacl,
01309     IN PSID PrincipalSelfSid,
01310     IN ULONG LocalTypeListLength,
01311     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList,
01312     IN ULONG ObjectTypeListLength,
01313     IN BOOLEAN Restricted
01314     )
01315 <span class="comment">/*++</span>
01316 <span class="comment"></span>
01317 <span class="comment">Routine Description:</span>
01318 <span class="comment"></span>
01319 <span class="comment">    Does an access check when the caller isn't asking for MAXIMUM_ALLOWED or</span>
01320 <span class="comment">    a type result list. If the Restricted flag is set, the sids checked are</span>
01321 <span class="comment">    the restricted sids, not the users and groups. The Remaining field is</span>
01322 <span class="comment">    reset to the original remaining value and then another access check is run.</span>
01323 <span class="comment"></span>
01324 <span class="comment">Arguments:</span>
01325 <span class="comment"></span>
01326 <span class="comment">    Remaining - Remaining access desired after special checks</span>
01327 <span class="comment"></span>
01328 <span class="comment">    EToken - Effective token of caller.</span>
01329 <span class="comment"></span>
01330 <span class="comment">    PrimaryToken - Process token of calling process</span>
01331 <span class="comment"></span>
01332 <span class="comment">    Dacl - ACL to check</span>
01333 <span class="comment"></span>
01334 <span class="comment">    PrincipalSelfSid - Sid to use in replacing the well-known self sid</span>
01335 <span class="comment"></span>
01336 <span class="comment">    LocalTypeListLength - Length of list of types.</span>
01337 <span class="comment"></span>
01338 <span class="comment">    LocalTypeList - List of types.</span>
01339 <span class="comment"></span>
01340 <span class="comment">    ObjectTypeList - Length of caller-supplied list of object types.</span>
01341 <span class="comment"></span>
01342 <span class="comment">    Restricted - Use the restricted sids for the access check.</span>
01343 <span class="comment"></span>
01344 <span class="comment">Return Value:</span>
01345 <span class="comment"></span>
01346 <span class="comment">    none</span>
01347 <span class="comment"></span>
01348 <span class="comment">--*/</span>
01349 {
01350     ULONG i,j;
01351     PVOID Ace;
01352     ULONG AceCount;
01353     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01354 
01355     AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount;
01356 
01357     <span class="comment">//</span>
01358     <span class="comment">// The remaining bits are "remaining" at all levels</span>
01359     <span class="comment">//</span>
01360 
01361     <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
01362         LocalTypeList[j].Remaining = Remaining;
01363     }
01364 
01365     <span class="comment">//</span>
01366     <span class="comment">// Process the DACL handling individual access bits.</span>
01367     <span class="comment">//</span>
01368 
01369     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> ) ;
01370           ( i &lt; AceCount ) &amp;&amp; ( LocalTypeList-&gt;Remaining != 0 )  ;
01371           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
01372 
01373         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">// Handle an Access Allowed ACE</span>
01377             <span class="comment">//</span>
01378 
01379             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
01380 
01381                <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE   )Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01382 
01383                    <span class="comment">// Optimize 'normal' case</span>
01384                    <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01385                        LocalTypeList-&gt;Remaining &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01386                    } <span class="keywordflow">else</span> {
01387                        <span class="comment">//</span>
01388                        <span class="comment">// The zeroeth object type represents the object itself.</span>
01389                        <span class="comment">//</span>
01390                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01391                             LocalTypeList,          <span class="comment">// List to modify</span>
01392                             LocalTypeListLength,    <span class="comment">// Length of list</span>
01393                             0,                      <span class="comment">// Element to update</span>
01394                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01395                             <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
01396                    }
01397 
01398                }
01399 
01400 
01401             <span class="comment">//</span>
01402             <span class="comment">// Handle an object specific Access Allowed ACE</span>
01403             <span class="comment">//</span>
01404             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
01405                 GUID *ObjectTypeInAce;
01406 
01407                 <span class="comment">//</span>
01408                 <span class="comment">// If no object type is in the ACE,</span>
01409                 <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
01410                 <span class="comment">//</span>
01411 
01412                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01413 
01414                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01415 
01416                     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01417 
01418                        <span class="comment">// Optimize 'normal' case</span>
01419                        <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01420                            LocalTypeList-&gt;Remaining &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01421                        } <span class="keywordflow">else</span> {
01422                            <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01423                                 LocalTypeList,          <span class="comment">// List to modify</span>
01424                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
01425                                 0,                      <span class="comment">// Element to update</span>
01426                                 ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01427                                 <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
01428                        }
01429                     }
01430 
01431                 <span class="comment">//</span>
01432                 <span class="comment">// If no object type list was passed,</span>
01433                 <span class="comment">//  don't grant access to anyone.</span>
01434                 <span class="comment">//</span>
01435 
01436                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01437 
01438                     <span class="comment">// Drop through</span>
01439 
01440 
01441                <span class="comment">//</span>
01442                <span class="comment">// If an object type is in the ACE,</span>
01443                <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
01444                <span class="comment">//</span>
01445                } <span class="keywordflow">else</span> {
01446 
01447                     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01448 
01449                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01450                                                   LocalTypeList,
01451                                                   LocalTypeListLength,
01452                                                   &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
01453                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01454                                  LocalTypeList,          <span class="comment">// List to modify</span>
01455                                  LocalTypeListLength,   <span class="comment">// Length of list</span>
01456                                  <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,                  <span class="comment">// Element already updated</span>
01457                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01458                                  <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
01459                         }
01460                     }
01461                }
01462 
01463 
01464             <span class="comment">//</span>
01465             <span class="comment">// Handle a compound Access Allowed ACE</span>
01466             <span class="comment">//</span>
01467 
01468             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
01469 
01470                 <span class="comment">//</span>
01471                 <span class="comment">// See comment in MAXIMUM_ALLOWED case as to why we can use EToken here</span>
01472                 <span class="comment">// for the client.</span>
01473                 <span class="comment">//</span>
01474 
01475                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>) &amp;&amp;
01476                      <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RtlCompoundAceServerSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a>) ) {
01477 
01478                     <span class="comment">// Optimize 'normal' case</span>
01479                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
01480                         LocalTypeList-&gt;Remaining &amp;= ~((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
01481                     } <span class="keywordflow">else</span> {
01482                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
01483                              LocalTypeList,          <span class="comment">// List to modify</span>
01484                              LocalTypeListLength,    <span class="comment">// Length of list</span>
01485                              0,                      <span class="comment">// Element to update</span>
01486                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
01487                              <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
01488                     }
01489                 }
01490 
01491 
01492 
01493             <span class="comment">//</span>
01494             <span class="comment">// Handle an Access Denied ACE</span>
01495             <span class="comment">//</span>
01496 
01497             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
01498 
01499                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01500 
01501                     <span class="comment">//</span>
01502                     <span class="comment">// The zeroeth element represents the object itself.</span>
01503                     <span class="comment">//  Just check that element.</span>
01504                     <span class="comment">//</span>
01505                     <span class="keywordflow">if</span> (LocalTypeList-&gt;Remaining &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) {
01506 
01507                         <span class="keywordflow">break</span>;
01508                     }
01509                 }
01510 
01511 
01512             <span class="comment">//</span>
01513             <span class="comment">// Handle an object specific Access Denied ACE</span>
01514             <span class="comment">//</span>
01515             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
01516 
01517                 <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d9/restrfil_8c.html#a5">Restricted</a> ) ) {
01518                     GUID *ObjectTypeInAce;
01519 
01520                     <span class="comment">//</span>
01521                     <span class="comment">// If there is no object type in the ACE,</span>
01522                     <span class="comment">//  or if the caller didn't specify an object type list,</span>
01523                     <span class="comment">//  apply this deny ACE to the entire object.</span>
01524                     <span class="comment">//</span>
01525 
01526                     ObjectTypeInAce = RtlObjectAceObjectType(Ace);
01527                     <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01528                          ObjectTypeListLength == 0 ) {
01529 
01530                         <span class="comment">//</span>
01531                         <span class="comment">// The zeroeth element represents the object itself.</span>
01532                         <span class="comment">//  Just check that element.</span>
01533                         <span class="comment">//</span>
01534                         <span class="keywordflow">if</span> (LocalTypeList-&gt;Remaining &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
01535                             <span class="keywordflow">break</span>;
01536                         }
01537 
01538                     <span class="comment">//</span>
01539                     <span class="comment">// Otherwise apply the deny ACE to the object specified</span>
01540                     <span class="comment">//  in the ACE.</span>
01541                     <span class="comment">//</span>
01542 
01543                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
01544                                                   LocalTypeList,
01545                                                   LocalTypeListLength,
01546                                                   &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
01547 
01548                         <span class="keywordflow">if</span> (LocalTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Remaining &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
01549                             <span class="keywordflow">break</span>;
01550                         }
01551 
01552                     }
01553                }
01554             }
01555 
01556         }
01557     }
01558 
01559 
01560 }
01561 
01562 
01563 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01564"></a><a class="code" href="../../d8/d3/tokenp_8h.html#a38">01564</a> <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (
01565     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
01566     IN PSID PrincipalSelfSid,
01567     IN PTOKEN PrimaryToken,
01568     IN PTOKEN ClientToken OPTIONAL,
01569     IN ACCESS_MASK DesiredAccess,
01570     IN <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> ObjectTypeList OPTIONAL,
01571     IN ULONG ObjectTypeListLength,
01572     IN PGENERIC_MAPPING GenericMapping,
01573     IN ACCESS_MASK PreviouslyGrantedAccess,
01574     IN KPROCESSOR_MODE PreviousMode,
01575     OUT PACCESS_MASK GrantedAccess,
01576     OUT PPRIVILEGE_SET *Privileges OPTIONAL,
01577     OUT PNTSTATUS AccessStatus,
01578     IN BOOLEAN ReturnResultList,
01579     OUT PBOOLEAN ReturnSomeAccessGranted,
01580     OUT PBOOLEAN ReturnSomeAccessDenied
01581     )
01582 
01583 <span class="comment">/*++</span>
01584 <span class="comment"></span>
01585 <span class="comment">Routine Description:</span>
01586 <span class="comment"></span>
01587 <span class="comment">    Worker routine for SeAccessCheck and NtAccessCheck.  We actually do the</span>
01588 <span class="comment">    access checking here.</span>
01589 <span class="comment"></span>
01590 <span class="comment">    Whether or not we actually evaluate the DACL is based on the following</span>
01591 <span class="comment">    interaction between the SE_DACL_PRESENT bit in the security descriptor</span>
01592 <span class="comment">    and the value of the DACL pointer itself.</span>
01593 <span class="comment"></span>
01594 <span class="comment"></span>
01595 <span class="comment">                          SE_DACL_PRESENT</span>
01596 <span class="comment"></span>
01597 <span class="comment">                        SET          CLEAR</span>
01598 <span class="comment"></span>
01599 <span class="comment">                   +-------------+-------------+</span>
01600 <span class="comment">                   |             |             |</span>
01601 <span class="comment">             NULL  |    GRANT    |    GRANT    |</span>
01602 <span class="comment">                   |     ALL     |     ALL     |</span>
01603 <span class="comment">     DACL          |             |             |</span>
01604 <span class="comment">     Pointer       +-------------+-------------+</span>
01605 <span class="comment">                   |             |             |</span>
01606 <span class="comment">            !NULL  |  EVALUATE   |    GRANT    |</span>
01607 <span class="comment">                   |    ACL      |     ALL     |</span>
01608 <span class="comment">                   |             |             |</span>
01609 <span class="comment">                   +-------------+-------------+</span>
01610 <span class="comment"></span>
01611 <span class="comment">Arguments:</span>
01612 <span class="comment"></span>
01613 <span class="comment">    SecurityDescriptor - Pointer to the security descriptor from the object</span>
01614 <span class="comment">        being accessed.</span>
01615 <span class="comment"></span>
01616 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
01617 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
01618 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
01619 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
01620 <span class="comment"></span>
01621 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
01622 <span class="comment"></span>
01623 <span class="comment">    Token - Pointer to user's token object.</span>
01624 <span class="comment"></span>
01625 <span class="comment">    TokenLocked - Boolean describing whether or not there is a read lock</span>
01626 <span class="comment">        on the token.</span>
01627 <span class="comment"></span>
01628 <span class="comment">    DesiredAccess - Access mask describing the user's desired access to the</span>
01629 <span class="comment">        object.  This mask is assumed not to contain generic access types.</span>
01630 <span class="comment"></span>
01631 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
01632 <span class="comment">        sub-objects) being accessed.  If no list is present, AccessCheckByType</span>
01633 <span class="comment">        behaves identically to AccessCheck.</span>
01634 <span class="comment"></span>
01635 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
01636 <span class="comment"></span>
01637 <span class="comment">    GenericMapping - Supplies a pointer to the generic mapping associated</span>
01638 <span class="comment">        with this object type.</span>
01639 <span class="comment"></span>
01640 <span class="comment">    PreviouslyGrantedAccess - Access mask indicating any access' that have</span>
01641 <span class="comment">        already been granted by higher level routines</span>
01642 <span class="comment"></span>
01643 <span class="comment">    PrivilgedAccessMask - Mask describing access types that may not be</span>
01644 <span class="comment">        granted without a privilege.</span>
01645 <span class="comment"></span>
01646 <span class="comment">    GrantedAccess - Returns an access mask describing all granted access',</span>
01647 <span class="comment">        or NULL.</span>
01648 <span class="comment"></span>
01649 <span class="comment">    Privileges - Optionally supplies a pointer in which will be returned</span>
01650 <span class="comment">        any privileges that were used for the access.  If this is null,</span>
01651 <span class="comment">        it will be assumed that privilege checks have been done already.</span>
01652 <span class="comment"></span>
01653 <span class="comment">    AccessStatus - Returns STATUS_SUCCESS or other error code to be</span>
01654 <span class="comment">        propogated back to the caller</span>
01655 <span class="comment"></span>
01656 <span class="comment">    ReturnResultList - If true, GrantedAccess and AccessStatus is actually</span>
01657 <span class="comment">        an array of entries ObjectTypeListLength elements long.</span>
01658 <span class="comment"></span>
01659 <span class="comment">    ReturnSomeAccessGranted - Returns a value of TRUE to indicate that some access'</span>
01660 <span class="comment">        were granted, FALSE otherwise.</span>
01661 <span class="comment"></span>
01662 <span class="comment">    ReturnSomeAccessDenied - Returns a value of FALSE if some of the requested</span>
01663 <span class="comment">        access was not granted.  This will alway be an inverse of SomeAccessGranted</span>
01664 <span class="comment">        unless ReturnResultList is TRUE.  In that case,</span>
01665 <span class="comment"></span>
01666 <span class="comment">Return Value:</span>
01667 <span class="comment"></span>
01668 <span class="comment">    A value of TRUE indicates that some access' were granted, FALSE</span>
01669 <span class="comment">    otherwise.</span>
01670 <span class="comment"></span>
01671 <span class="comment">--*/</span>
01672 {
01673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01674     ACCESS_MASK Remaining;
01675 
01676 
01677     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01678 
01679     PVOID Ace;
01680     ULONG AceCount;
01681 
01682     ULONG i;
01683     ULONG j;
01684     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01685     ULONG PrivilegeCount = 0;
01686     BOOLEAN Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01687     BOOLEAN SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01688     BOOLEAN WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01689     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> EToken;
01690 
01691     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">IOBJECT_TYPE_LIST</a> FixedTypeList;
01692     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalTypeList;
01693     ULONG LocalTypeListLength;
01694     ULONG ResultListIndex;
01695 
01696     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01697 
01698 <span class="preprocessor">#if DBG</span>
01699 <span class="preprocessor"></span>
01700     <a class="code" href="../../d6/d6/sep_8h.html#a57">SepDumpSecurityDescriptor</a>(
01701         SecurityDescriptor,
01702         <span class="stringliteral">"Input to SeAccessCheck\n"</span>
01703         );
01704 
01705     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> )) {
01706         <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> );
01707     }
01708 
01709     <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a> );
01710 
01711 <span class="preprocessor">#endif</span>
01712 <span class="preprocessor"></span>
01713 
01714     EToken = ARGUMENT_PRESENT( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> ) ? <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a> : <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>;
01715 
01716     <span class="comment">//</span>
01717     <span class="comment">// Assert that there are no generic accesses in the DesiredAccess</span>
01718     <span class="comment">//</span>
01719 
01720     <a class="code" href="../../d0/d5/se_8h.html#a14">SeAssertMappedCanonicalAccess</a>( DesiredAccess );
01721 
01722     Remaining = DesiredAccess;
01723 
01724 
01725     <span class="comment">//</span>
01726     <span class="comment">// Check for ACCESS_SYSTEM_SECURITY here,</span>
01727     <span class="comment">// fail if he's asking for it and doesn't have</span>
01728     <span class="comment">// the privilege.</span>
01729     <span class="comment">//</span>
01730 
01731     <span class="keywordflow">if</span> ( Remaining &amp; ACCESS_SYSTEM_SECURITY ) {
01732 
01733         <span class="comment">//</span>
01734         <span class="comment">// Bugcheck if we weren't given a pointer to return privileges</span>
01735         <span class="comment">// into.  Our caller was supposed to have taken care of this</span>
01736         <span class="comment">// in that case.</span>
01737         <span class="comment">//</span>
01738 
01739         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT( Privileges ));
01740 
01741         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01742                     <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>,
01743                     EToken,
01744                     PreviousMode
01745                     );
01746 
01747         <span class="keywordflow">if</span> (!Success) {
01748             PreviouslyGrantedAccess = 0;
01749             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01750             <span class="keywordflow">goto</span> ReturnOneStatus;
01751         }
01752 
01753         <span class="comment">//</span>
01754         <span class="comment">// Success, remove ACCESS_SYSTEM_SECURITY from remaining, add it</span>
01755         <span class="comment">// to PreviouslyGrantedAccess</span>
01756         <span class="comment">//</span>
01757 
01758         Remaining &amp;= ~ACCESS_SYSTEM_SECURITY;
01759         PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01760 
01761         PrivilegeCount++;
01762         SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01763 
01764         <span class="keywordflow">if</span> ( Remaining == 0 ) {
01765             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01766             <span class="keywordflow">goto</span> ReturnOneStatus;
01767         }
01768 
01769     }
01770 
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Get pointer to client SID's</span>
01774     <span class="comment">//</span>
01775 
01776     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor );
01777 
01778     <span class="comment">//</span>
01779     <span class="comment">//  If the SE_DACL_PRESENT bit is not set, the object has no</span>
01780     <span class="comment">//  security, so all accesses are granted.  If he's asking for</span>
01781     <span class="comment">//  MAXIMUM_ALLOWED, return the GENERIC_ALL field from the generic</span>
01782     <span class="comment">//  mapping.</span>
01783     <span class="comment">//</span>
01784     <span class="comment">//  Also grant all access if the Dacl is NULL.</span>
01785     <span class="comment">//</span>
01786 
01787     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(
01788              (PISECURITY_DESCRIPTOR)SecurityDescriptor,
01789              SE_DACL_PRESENT) || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01790 
01791 
01792         <span class="comment">//</span>
01793         <span class="comment">// Restricted tokens treat a NULL dacl the same as a DACL with no</span>
01794         <span class="comment">// ACEs.</span>
01795         <span class="comment">//</span>
01796 <span class="preprocessor">#ifdef SECURE_NULL_DACLS</span>
01797 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken )) {
01798             <span class="comment">//</span>
01799             <span class="comment">// We know that Remaining != 0 here, because we</span>
01800             <span class="comment">// know it was non-zero coming into this routine,</span>
01801             <span class="comment">// and we've checked it against 0 every time we've</span>
01802             <span class="comment">// cleared a bit.</span>
01803             <span class="comment">//</span>
01804 
01805             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01806 
01807             <span class="comment">//</span>
01808             <span class="comment">// There are ungranted accesses.  Since there is</span>
01809             <span class="comment">// nothing in the DACL, they will not be granted.</span>
01810             <span class="comment">// If, however, the only ungranted access at this</span>
01811             <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01812             <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01813             <span class="comment">// what has been granted.</span>
01814             <span class="comment">//</span>
01815 
01816             <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01817                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01818                 <span class="keywordflow">goto</span> ReturnOneStatus;
01819 
01820             } <span class="keywordflow">else</span> {
01821                 PreviouslyGrantedAccess = 0;
01822                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01823                 <span class="keywordflow">goto</span> ReturnOneStatus;
01824             }
01825         }
01826 <span class="preprocessor">#endif //SECURE_NULL_DACLS</span>
01827 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01828 
01829             <span class="comment">//</span>
01830             <span class="comment">// Give him:</span>
01831             <span class="comment">//   GenericAll</span>
01832             <span class="comment">//   Anything else he asked for</span>
01833             <span class="comment">//</span>
01834 
01835             PreviouslyGrantedAccess =
01836                 GenericMapping-&gt;GenericAll |
01837                 (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01838 
01839         } <span class="keywordflow">else</span> {
01840 
01841             PreviouslyGrantedAccess |= DesiredAccess;
01842         }
01843 
01844         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01845         <span class="keywordflow">goto</span> ReturnOneStatus;
01846     }
01847 
01848     <span class="comment">//</span>
01849     <span class="comment">// There is security on this object.  Check to see</span>
01850     <span class="comment">// if he's asking for WRITE_OWNER, and perform the</span>
01851     <span class="comment">// privilege check if so.</span>
01852     <span class="comment">//</span>
01853 
01854     <span class="keywordflow">if</span> ( (Remaining &amp; WRITE_OWNER) &amp;&amp; ARGUMENT_PRESENT( Privileges ) ) {
01855 
01856         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
01857                     <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>,
01858                     EToken,
01859                     PreviousMode
01860                     );
01861 
01862         <span class="keywordflow">if</span> (Success) {
01863 
01864             <span class="comment">//</span>
01865             <span class="comment">// Success, remove WRITE_OWNER from remaining, add it</span>
01866             <span class="comment">// to PreviouslyGrantedAccess</span>
01867             <span class="comment">//</span>
01868 
01869             Remaining &amp;= ~WRITE_OWNER;
01870             PreviouslyGrantedAccess |= WRITE_OWNER;
01871 
01872             PrivilegeCount++;
01873             WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01874 
01875             <span class="keywordflow">if</span> ( Remaining == 0 ) {
01876                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01877                 <span class="keywordflow">goto</span> ReturnOneStatus;
01878             }
01879         }
01880     }
01881 
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// If the DACL is empty,</span>
01885     <span class="comment">// deny all access immediately.</span>
01886     <span class="comment">//</span>
01887 
01888     <span class="keywordflow">if</span> ((AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount) == 0) {
01889 
01890         <span class="comment">//</span>
01891         <span class="comment">// We know that Remaining != 0 here, because we</span>
01892         <span class="comment">// know it was non-zero coming into this routine,</span>
01893         <span class="comment">// and we've checked it against 0 every time we've</span>
01894         <span class="comment">// cleared a bit.</span>
01895         <span class="comment">//</span>
01896 
01897         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Remaining != 0 );
01898 
01899         <span class="comment">//</span>
01900         <span class="comment">// There are ungranted accesses.  Since there is</span>
01901         <span class="comment">// nothing in the DACL, they will not be granted.</span>
01902         <span class="comment">// If, however, the only ungranted access at this</span>
01903         <span class="comment">// point is MAXIMUM_ALLOWED, and something has been</span>
01904         <span class="comment">// granted in the PreviouslyGranted mask, return</span>
01905         <span class="comment">// what has been granted.</span>
01906         <span class="comment">//</span>
01907 
01908         <span class="keywordflow">if</span> ( (Remaining == MAXIMUM_ALLOWED) &amp;&amp; (PreviouslyGrantedAccess != (ACCESS_MASK)0) ) {
01909             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01910             <span class="keywordflow">goto</span> ReturnOneStatus;
01911 
01912         } <span class="keywordflow">else</span> {
01913             PreviouslyGrantedAccess = 0;
01914             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01915             <span class="keywordflow">goto</span> ReturnOneStatus;
01916         }
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Fake out a top level ObjectType list if none is passed by the caller.</span>
01921     <span class="comment">//</span>
01922 
01923     <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
01924         LocalTypeList = &amp;FixedTypeList;
01925         LocalTypeListLength = 1;
01926         RtlZeroMemory( &amp;FixedTypeList, <span class="keyword">sizeof</span>(FixedTypeList) );
01927         FixedTypeList.ParentIndex = -1;
01928     } <span class="keywordflow">else</span> {
01929         LocalTypeList = ObjectTypeList;
01930         LocalTypeListLength = ObjectTypeListLength;
01931     }
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// If the caller wants the MAXIMUM_ALLOWED or the caller wants the</span>
01935     <span class="comment">//  results on all objects and subobjects, use a slower algorithm</span>
01936     <span class="comment">//  that traverses all the ACEs.</span>
01937     <span class="comment">//</span>
01938 
01939     <span class="keywordflow">if</span> ( (DesiredAccess &amp; MAXIMUM_ALLOWED) != 0 ||
01940          ReturnResultList ) {
01941 
01942         <span class="comment">//</span>
01943         <span class="comment">// Do the normal maximum-allowed access check</span>
01944         <span class="comment">//</span>
01945 
01946         <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01947             EToken,
01948             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
01949             <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01950             PrincipalSelfSid,
01951             LocalTypeListLength,
01952             LocalTypeList,
01953             ObjectTypeListLength,
01954             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01955             );
01956 
01957         <span class="comment">//</span>
01958         <span class="comment">// If this is a restricted token, do the additional access check</span>
01959         <span class="comment">//</span>
01960 
01961         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
01962             <a class="code" href="../../d0/d4/accessck_8c.html#a6">SepMaximumAccessCheck</a>(
01963                 EToken,
01964                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
01965                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01966                 PrincipalSelfSid,
01967                 LocalTypeListLength,
01968                 LocalTypeList,
01969                 ObjectTypeListLength,
01970                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
01971                 );
01972         }
01973 
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// If the caller wants to know the individual results of each sub-object,</span>
01977         <span class="comment">//  sub-object,</span>
01978         <span class="comment">//  break it down for him.</span>
01979         <span class="comment">//</span>
01980 
01981         <span class="keywordflow">if</span> ( ReturnResultList ) {
01982             ACCESS_MASK GrantedAccessMask;
01983             ACCESS_MASK RequiredAccessMask;
01984             BOOLEAN SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01985             BOOLEAN SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01986 
01987             <span class="comment">//</span>
01988             <span class="comment">// Compute mask of Granted access bits to tell the caller about.</span>
01989             <span class="comment">//  If he asked for MAXIMUM_ALLOWED,</span>
01990             <span class="comment">//      tell him everything,</span>
01991             <span class="comment">//  otherwise</span>
01992             <span class="comment">//      tell him what he asked about.</span>
01993             <span class="comment">//</span>
01994 
01995             <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
01996                 GrantedAccessMask = (ACCESS_MASK) ~MAXIMUM_ALLOWED;
01997                 RequiredAccessMask = (DesiredAccess | PreviouslyGrantedAccess) &amp; ~MAXIMUM_ALLOWED;
01998             } <span class="keywordflow">else</span> {
01999                 GrantedAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02000                 RequiredAccessMask = DesiredAccess | PreviouslyGrantedAccess;
02001             }
02002 
02003 
02004 
02005 
02006             <span class="comment">//</span>
02007             <span class="comment">// Loop computing the access granted to each object and sub-object.</span>
02008             <span class="comment">//</span>
02009             <span class="keywordflow">for</span> ( ResultListIndex=0;
02010                   ResultListIndex&lt;LocalTypeListLength;
02011                   ResultListIndex++ ) {
02012 
02013                 <span class="comment">//</span>
02014                 <span class="comment">// Return the subset of the access granted that the caller</span>
02015                 <span class="comment">//  expressed interest in.</span>
02016                 <span class="comment">//</span>
02017 
02018                 GrantedAccess[ResultListIndex] =
02019                     (LocalTypeList[ResultListIndex].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a> |
02020                      PreviouslyGrantedAccess ) &amp;
02021                     GrantedAccessMask;
02022 
02023                 <span class="comment">//</span>
02024                 <span class="comment">// If absolutely no access was granted,</span>
02025                 <span class="comment">//  indicate so.</span>
02026                 <span class="comment">//</span>
02027                 <span class="keywordflow">if</span> ( GrantedAccess[ResultListIndex] == 0 ) {
02028                     AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02029                     SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02030                 } <span class="keywordflow">else</span> {
02031 
02032                     <span class="comment">//</span>
02033                     <span class="comment">// If some requested access is still missing,</span>
02034                     <span class="comment">//  the bottom line is that access is denied.</span>
02035                     <span class="comment">//</span>
02036                     <span class="comment">// Note, that ByTypeResultList actually returns the</span>
02037                     <span class="comment">// partially granted access mask even though the caller</span>
02038                     <span class="comment">// really has no access to the object.</span>
02039                     <span class="comment">//</span>
02040 
02041                     <span class="keywordflow">if</span>  ( ((~GrantedAccess[ResultListIndex]) &amp; RequiredAccessMask ) != 0 ) {
02042                         AccessStatus[ResultListIndex] = STATUS_ACCESS_DENIED;
02043                         SomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02044                     } <span class="keywordflow">else</span> {
02045                         AccessStatus[ResultListIndex] = STATUS_SUCCESS;
02046                         SomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02047                     }
02048                 }
02049             }
02050 
02051             <span class="keywordflow">if</span> ( SomeAccessGranted &amp;&amp; PrivilegeCount != 0 ) {
02052 
02053                 <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02054                     PrivilegeCount,
02055                     SystemSecurity,
02056                     WriteOwner,
02057                     Privileges
02058                     );
02059             }
02060 
02061             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02062                 *ReturnSomeAccessGranted = SomeAccessGranted;
02063             }
02064             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02065                 *ReturnSomeAccessDenied = SomeAccessDenied;
02066             }
02067             <span class="keywordflow">return</span>;
02068 
02069         <span class="comment">//</span>
02070         <span class="comment">// If the caller is only interested in the access to the object itself,</span>
02071         <span class="comment">//  just summarize.</span>
02072         <span class="comment">//</span>
02073 
02074         } <span class="keywordflow">else</span> {
02075 
02076             <span class="comment">//</span>
02077             <span class="comment">// Turn off the MAXIMUM_ALLOWED bit and whatever we found that</span>
02078             <span class="comment">// he was granted.  If the user passed in extra bits in addition</span>
02079             <span class="comment">// to MAXIMUM_ALLOWED, make sure that he was granted those access</span>
02080             <span class="comment">// types.  If not, he didn't get what he wanted, so return failure.</span>
02081             <span class="comment">//</span>
02082 
02083             Remaining &amp;= ~(MAXIMUM_ALLOWED | LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>);
02084 
02085             <span class="keywordflow">if</span> (Remaining != 0) {
02086 
02087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02088                 PreviouslyGrantedAccess = 0;
02089                 <span class="keywordflow">goto</span> ReturnOneStatus;
02090 
02091             }
02092 
02093 
02094 
02095             PreviouslyGrantedAccess |= LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o5">CurrentGranted</a>;
02096             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02097             <span class="keywordflow">goto</span> ReturnOneStatus;
02098 
02099         }
02100 
02101     } <span class="comment">// if MAXIMUM_ALLOWED...</span>
02102 
02103 
02104 <span class="preprocessor">#ifdef notdef</span>
02105 <span class="preprocessor"></span>    <span class="comment">//</span>
02106     <span class="comment">// The remaining bits are "remaining" at all levels</span>
02107 
02108     <span class="keywordflow">for</span> ( j=0; j&lt;LocalTypeListLength; j++ ) {
02109         LocalTypeList[j].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> = Remaining;
02110     }
02111 
02112     <span class="comment">//</span>
02113     <span class="comment">// Process the DACL handling individual access bits.</span>
02114     <span class="comment">//</span>
02115 
02116     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> ) ;
02117           ( i &lt; AceCount ) &amp;&amp; ( LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0 )  ;
02118           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ) ) {
02119 
02120         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">// Handle an Access Allowed ACE</span>
02124             <span class="comment">//</span>
02125 
02126             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
02127 
02128                <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) {
02129 
02130                    <span class="comment">// Optimize 'normal' case</span>
02131                    <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02132                        LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02133                    } <span class="keywordflow">else</span> {
02134                        <span class="comment">//</span>
02135                        <span class="comment">// The zeroeth object type represents the object itself.</span>
02136                        <span class="comment">//</span>
02137                        <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02138                             LocalTypeList,          <span class="comment">// List to modify</span>
02139                             LocalTypeListLength,    <span class="comment">// Length of list</span>
02140                             0,                      <span class="comment">// Element to update</span>
02141                             ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02142                             <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
02143                    }
02144 
02145                }
02146 
02147 
02148             <span class="comment">//</span>
02149             <span class="comment">// Handle an object specific Access Allowed ACE</span>
02150             <span class="comment">//</span>
02151             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_OBJECT_ACE_TYPE) ) {
02152                 GUID *ObjectTypeInAce;
02153 
02154                 <span class="comment">//</span>
02155                 <span class="comment">// If no object type is in the ACE,</span>
02156                 <span class="comment">//  treat this as an ACCESS_ALLOWED_ACE.</span>
02157                 <span class="comment">//</span>
02158 
02159                 ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02160 
02161                 <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02162 
02163                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) {
02164 
02165                        <span class="comment">// Optimize 'normal' case</span>
02166                        <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02167                            LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02168                        } <span class="keywordflow">else</span> {
02169                            <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02170                                 LocalTypeList,          <span class="comment">// List to modify</span>
02171                                 LocalTypeListLength,    <span class="comment">// Length of list</span>
02172                                 0,                      <span class="comment">// Element to update</span>
02173                                 ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02174                                 <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
02175                        }
02176                     }
02177 
02178                 <span class="comment">//</span>
02179                 <span class="comment">// If no object type list was passed,</span>
02180                 <span class="comment">//  don't grant access to anyone.</span>
02181                 <span class="comment">//</span>
02182 
02183                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
02184 
02185                     <span class="comment">// Drop through</span>
02186 
02187 
02188                <span class="comment">//</span>
02189                <span class="comment">// If an object type is in the ACE,</span>
02190                <span class="comment">//   Find it in the LocalTypeList before using the ACE.</span>
02191                <span class="comment">//</span>
02192                } <span class="keywordflow">else</span> {
02193 
02194                     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) ) {
02195 
02196                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02197                                                   LocalTypeList,
02198                                                   LocalTypeListLength,
02199                                                   &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
02200                             <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02201                                  LocalTypeList,          <span class="comment">// List to modify</span>
02202                                  LocalTypeListLength,   <span class="comment">// Length of list</span>
02203                                  <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,                  <span class="comment">// Element already updated</span>
02204                                  ((PACCESS_ALLOWED_OBJECT_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02205                                  <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
02206                         }
02207                     }
02208                }
02209 
02210 
02211             <span class="comment">//</span>
02212             <span class="comment">// Handle a compound Access Allowed ACE</span>
02213             <span class="comment">//</span>
02214             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_COMPOUND_ACE_TYPE) ) {
02215 
02216                 <span class="comment">//</span>
02217                 <span class="comment">// See comment in MAXIMUM_ALLOWED case as to why we can use EToken here</span>
02218                 <span class="comment">// for the client.</span>
02219                 <span class="comment">//</span>
02220 
02221                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(EToken, PrincipalSelfSid, RtlCompoundAceClientSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
02222                      <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RtlCompoundAceServerSid( Ace ), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ) {
02223 
02224                     <span class="comment">// Optimize 'normal' case</span>
02225                     <span class="keywordflow">if</span> ( LocalTypeListLength == 1 ) {
02226                         LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp;= ~((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask;
02227                     } <span class="keywordflow">else</span> {
02228                         <a class="code" href="../../d0/d4/accessck_8c.html#a4">SepAddAccessTypeList</a>(
02229                              LocalTypeList,          <span class="comment">// List to modify</span>
02230                              LocalTypeListLength,    <span class="comment">// Length of list</span>
02231                              0,                      <span class="comment">// Element to update</span>
02232                              ((PCOMPOUND_ACCESS_ALLOWED_ACE)Ace)-&gt;Mask, <span class="comment">// Access Granted</span>
02233                              <a class="code" href="../../d0/d4/accessck_8c.html#a23a0">UpdateRemaining</a> );
02234                     }
02235                 }
02236 
02237 
02238 
02239             <span class="comment">//</span>
02240             <span class="comment">// Handle an Access Denied ACE</span>
02241             <span class="comment">//</span>
02242 
02243             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
02244 
02245                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) ) {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">// The zeroeth element represents the object itself.</span>
02249                     <span class="comment">//  Just check that element.</span>
02250                     <span class="comment">//</span>
02251                     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) {
02252 
02253                         <span class="keywordflow">break</span>;
02254                     }
02255                 }
02256 
02257 
02258             <span class="comment">//</span>
02259             <span class="comment">// Handle an object specific Access Denied ACE</span>
02260             <span class="comment">//</span>
02261             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_OBJECT_ACE_TYPE) ) {
02262 
02263                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( EToken, PrincipalSelfSid, RtlObjectAceSid(Ace), <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) ) {
02264                     GUID *ObjectTypeInAce;
02265 
02266                     <span class="comment">//</span>
02267                     <span class="comment">// If there is no object type in the ACE,</span>
02268                     <span class="comment">//  or if the caller didn't specify an object type list,</span>
02269                     <span class="comment">//  apply this deny ACE to the entire object.</span>
02270                     <span class="comment">//</span>
02271 
02272                     ObjectTypeInAce = RtlObjectAceObjectType(Ace);
02273                     <span class="keywordflow">if</span> ( ObjectTypeInAce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
02274                          ObjectTypeListLength == 0 ) {
02275 
02276                         <span class="comment">//</span>
02277                         <span class="comment">// The zeroeth element represents the object itself.</span>
02278                         <span class="comment">//  Just check that element.</span>
02279                         <span class="comment">//</span>
02280                         <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02281                             <span class="keywordflow">break</span>;
02282                         }
02283 
02284                     <span class="comment">//</span>
02285                     <span class="comment">// Otherwise apply the deny ACE to the object specified</span>
02286                     <span class="comment">//  in the ACE.</span>
02287                     <span class="comment">//</span>
02288 
02289                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d3/tokenp_8h.html#a39">SepObjectInTypeList</a>( ObjectTypeInAce,
02290                                                   LocalTypeList,
02291                                                   LocalTypeListLength,
02292                                                   &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ) ) {
02293 
02294                         <span class="keywordflow">if</span> (LocalTypeList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> &amp; ((PACCESS_DENIED_OBJECT_ACE)Ace)-&gt;Mask) {
02295                             <span class="keywordflow">break</span>;
02296                         }
02297 
02298                     }
02299                }
02300             }
02301 
02302         }
02303     }
02304 
02305 <span class="preprocessor">#endif</span>
02306 <span class="preprocessor"></span>
02307     <span class="comment">//</span>
02308     <span class="comment">// Do the normal access check first</span>
02309     <span class="comment">//</span>
02310 
02311     <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02312         Remaining,
02313         EToken,
02314         <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
02315         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
02316         PrincipalSelfSid,
02317         LocalTypeListLength,
02318         LocalTypeList,
02319         ObjectTypeListLength,
02320         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02321         );
02322 
02323     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02324         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02325         PreviouslyGrantedAccess = 0;
02326         <span class="keywordflow">goto</span> ReturnOneStatus;
02327     }
02328 
02329     <span class="comment">//</span>
02330     <span class="comment">// If this is a restricted token, do the additional access check</span>
02331     <span class="comment">//</span>
02332 
02333     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/token_8c.html#a5">SeTokenIsRestricted</a>( EToken ) ) {
02334         <a class="code" href="../../d0/d4/accessck_8c.html#a7">SepNormalAccessCheck</a>(
02335             Remaining,
02336             EToken,
02337             <a class="code" href="../../d6/d0/ctaccess_8c.html#a31">PrimaryToken</a>,
02338             <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
02339             PrincipalSelfSid,
02340             LocalTypeListLength,
02341             LocalTypeList,
02342             ObjectTypeListLength,
02343             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02344             );
02345     }
02346 
02347 
02348     <span class="keywordflow">if</span> (LocalTypeList-&gt;<a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html#o4">Remaining</a> != 0) {
02349         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02350         PreviouslyGrantedAccess = 0;
02351         <span class="keywordflow">goto</span> ReturnOneStatus;
02352     }
02353 
02354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02355     PreviouslyGrantedAccess |= DesiredAccess;
02356 
02357     <span class="comment">//</span>
02358     <span class="comment">// Return a single status code to the caller.</span>
02359     <span class="comment">//</span>
02360 
02361     ReturnOneStatus:
02362     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS &amp;&amp; PreviouslyGrantedAccess == 0 ) {
02363         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
02364     }
02365 
02366     <span class="comment">//</span>
02367     <span class="comment">// If the caller asked for a list of status',</span>
02368     <span class="comment">//  duplicate the status all over.</span>
02369     <span class="comment">//</span>
02370     <span class="keywordflow">if</span> ( ReturnResultList ) {
02371         <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
02372             AccessStatus[ResultListIndex] = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02373             GrantedAccess[ResultListIndex] = PreviouslyGrantedAccess;
02374         }
02375     } <span class="keywordflow">else</span> {
02376         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02377         *GrantedAccess = PreviouslyGrantedAccess;
02378     }
02379 
02380     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
02381         <span class="keywordflow">if</span> ( PrivilegeCount &gt; 0 ) {
02382 
02383             <a class="code" href="../../d6/d6/sep_8h.html#a64">SepAssemblePrivileges</a>(
02384                 PrivilegeCount,
02385                 SystemSecurity,
02386                 WriteOwner,
02387                 Privileges
02388                 );
02389         }
02390 
02391         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02392             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02393         }
02394         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02395             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02396         }
02397     } <span class="keywordflow">else</span> {
02398         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessGranted)) {
02399             *ReturnSomeAccessGranted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02400         }
02401         <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnSomeAccessDenied)) {
02402             *ReturnSomeAccessDenied = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;;
02403         }
02404     }
02405     <span class="keywordflow">return</span>;
02406 
02407 }
02408 
02409 
02410 
02411 
02412 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02413"></a><a class="code" href="../../d0/d4/accessck_8c.html#a14">02413</a> <a class="code" href="../../d0/d4/accessck_8c.html#a14">NtAccessCheck</a> (
02414     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02415     IN HANDLE ClientToken,
02416     IN ACCESS_MASK DesiredAccess,
02417     IN PGENERIC_MAPPING GenericMapping,
02418     OUT PPRIVILEGE_SET PrivilegeSet,
02419     IN OUT PULONG PrivilegeSetLength,
02420     OUT PACCESS_MASK GrantedAccess,
02421     OUT PNTSTATUS AccessStatus
02422     )
02423 
02424 
02425 <span class="comment">/*++</span>
02426 <span class="comment"></span>
02427 <span class="comment">Routine Description:</span>
02428 <span class="comment"></span>
02429 <span class="comment">    See module abstract.</span>
02430 <span class="comment"></span>
02431 <span class="comment">Arguments:</span>
02432 <span class="comment"></span>
02433 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the object</span>
02434 <span class="comment">        being accessed</span>
02435 <span class="comment"></span>
02436 <span class="comment">    ClientToken - Supplies the handle of the user's token.</span>
02437 <span class="comment"></span>
02438 <span class="comment">    DesiredAccess - Supplies the desired access mask.</span>
02439 <span class="comment"></span>
02440 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
02441 <span class="comment">        object type.</span>
02442 <span class="comment"></span>
02443 <span class="comment">    PrivilegeSet - A pointer to a buffer that upon return will contain</span>
02444 <span class="comment">        any privileges that were used to perform the access validation.</span>
02445 <span class="comment">        If no privileges were used, the buffer will contain a privilege</span>
02446 <span class="comment">        set consisting of zero privileges.</span>
02447 <span class="comment"></span>
02448 <span class="comment">    PrivilegeSetLength - The size of the PrivilegeSet buffer in bytes.</span>
02449 <span class="comment"></span>
02450 <span class="comment">    GrantedAccess - Returns an access mask describing the granted access.</span>
02451 <span class="comment"></span>
02452 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
02453 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
02454 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
02455 <span class="comment">         be returned when mandatory access control is implemented.</span>
02456 <span class="comment"></span>
02457 <span class="comment">Return Value:</span>
02458 <span class="comment"></span>
02459 <span class="comment">    STATUS_SUCCESS - The attempt proceeded normally.  This does not</span>
02460 <span class="comment">        mean access was granted, rather that the parameters were</span>
02461 <span class="comment">        correct.</span>
02462 <span class="comment"></span>
02463 <span class="comment">    STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained</span>
02464 <span class="comment">        an unmapped generic access.</span>
02465 <span class="comment"></span>
02466 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough</span>
02467 <span class="comment">        to contain the information being returned.</span>
02468 <span class="comment"></span>
02469 <span class="comment">    STATUS_NO_IMPERSONTAION_TOKEN - The passed Token was not an impersonation</span>
02470 <span class="comment">        token.</span>
02471 <span class="comment"></span>
02472 <span class="comment">--*/</span>
02473 
02474 {
02475 
02476     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02477 
02478     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02479                  SecurityDescriptor,
02480                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      <span class="comment">// No Principal Self sid</span>
02481                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
02482                  DesiredAccess,
02483                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      <span class="comment">// No ObjectType List</span>
02484                  0,         <span class="comment">// No ObjectType List</span>
02485                  GenericMapping,
02486                  PrivilegeSet,
02487                  PrivilegeSetLength,
02488                  GrantedAccess,
02489                  AccessStatus,
02490                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
02491 
02492 
02493 }
02494 
02495 
02496 
02497 
02498 
02499 
02500 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02501"></a><a class="code" href="../../d0/d4/accessck_8c.html#a15">02501</a> <a class="code" href="../../d0/d4/accessck_8c.html#a15">NtAccessCheckByType</a> (
02502     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02503     IN PSID PrincipalSelfSid,
02504     IN HANDLE ClientToken,
02505     IN ACCESS_MASK DesiredAccess,
02506     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
02507     IN ULONG ObjectTypeListLength,
02508     IN PGENERIC_MAPPING GenericMapping,
02509     OUT PPRIVILEGE_SET PrivilegeSet,
02510     IN OUT PULONG PrivilegeSetLength,
02511     OUT PACCESS_MASK GrantedAccess,
02512     OUT PNTSTATUS AccessStatus
02513     )
02514 
02515 
02516 <span class="comment">/*++</span>
02517 <span class="comment"></span>
02518 <span class="comment">Routine Description:</span>
02519 <span class="comment"></span>
02520 <span class="comment">    See module abstract.</span>
02521 <span class="comment"></span>
02522 <span class="comment">Arguments:</span>
02523 <span class="comment"></span>
02524 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the object</span>
02525 <span class="comment">        being accessed</span>
02526 <span class="comment"></span>
02527 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
02528 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
02529 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
02530 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
02531 <span class="comment"></span>
02532 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
02533 <span class="comment"></span>
02534 <span class="comment">    ClientToken - Supplies the handle of the user's token.</span>
02535 <span class="comment"></span>
02536 <span class="comment">    DesiredAccess - Supplies the desired access mask.</span>
02537 <span class="comment"></span>
02538 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
02539 <span class="comment">        sub-objects) being accessed.  If no list is present, AccessCheckByType</span>
02540 <span class="comment">        behaves identically to AccessCheck.</span>
02541 <span class="comment"></span>
02542 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
02543 <span class="comment"></span>
02544 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
02545 <span class="comment">        object type.</span>
02546 <span class="comment"></span>
02547 <span class="comment">    PrivilegeSet - A pointer to a buffer that upon return will contain</span>
02548 <span class="comment">        any privileges that were used to perform the access validation.</span>
02549 <span class="comment">        If no privileges were used, the buffer will contain a privilege</span>
02550 <span class="comment">        set consisting of zero privileges.</span>
02551 <span class="comment"></span>
02552 <span class="comment">    PrivilegeSetLength - The size of the PrivilegeSet buffer in bytes.</span>
02553 <span class="comment"></span>
02554 <span class="comment">    GrantedAccess - Returns an access mask describing the granted access.</span>
02555 <span class="comment"></span>
02556 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
02557 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
02558 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
02559 <span class="comment">         be returned when mandatory access control is implemented.</span>
02560 <span class="comment"></span>
02561 <span class="comment">Return Value:</span>
02562 <span class="comment"></span>
02563 <span class="comment">    STATUS_SUCCESS - The attempt proceeded normally.  This does not</span>
02564 <span class="comment">        mean access was granted, rather that the parameters were</span>
02565 <span class="comment">        correct.</span>
02566 <span class="comment"></span>
02567 <span class="comment">    STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained</span>
02568 <span class="comment">        an unmapped generic access.</span>
02569 <span class="comment"></span>
02570 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough</span>
02571 <span class="comment">        to contain the information being returned.</span>
02572 <span class="comment"></span>
02573 <span class="comment">    STATUS_NO_IMPERSONTAION_TOKEN - The passed Token was not an impersonation</span>
02574 <span class="comment">        token.</span>
02575 <span class="comment"></span>
02576 <span class="comment">--*/</span>
02577 
02578 {
02579 
02580     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02581 
02582     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02583                  SecurityDescriptor,
02584                  PrincipalSelfSid,
02585                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
02586                  DesiredAccess,
02587                  ObjectTypeList,
02588                  ObjectTypeListLength,
02589                  GenericMapping,
02590                  PrivilegeSet,
02591                  PrivilegeSetLength,
02592                  GrantedAccess,
02593                  AccessStatus,
02594                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );  <span class="comment">// Return a single GrantedAccess and AccessStatus</span>
02595 }
02596 
02597 
02598 
02599 
02600 
02601 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02602"></a><a class="code" href="../../d0/d4/accessck_8c.html#a16">02602</a> <a class="code" href="../../d0/d4/accessck_8c.html#a16">NtAccessCheckByTypeResultList</a> (
02603     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02604     IN PSID PrincipalSelfSid,
02605     IN HANDLE ClientToken,
02606     IN ACCESS_MASK DesiredAccess,
02607     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
02608     IN ULONG ObjectTypeListLength,
02609     IN PGENERIC_MAPPING GenericMapping,
02610     OUT PPRIVILEGE_SET PrivilegeSet,
02611     IN OUT PULONG PrivilegeSetLength,
02612     OUT PACCESS_MASK GrantedAccess,
02613     OUT PNTSTATUS AccessStatus
02614     )
02615 
02616 
02617 <span class="comment">/*++</span>
02618 <span class="comment"></span>
02619 <span class="comment">Routine Description:</span>
02620 <span class="comment"></span>
02621 <span class="comment">    See module abstract.</span>
02622 <span class="comment"></span>
02623 <span class="comment">Arguments:</span>
02624 <span class="comment"></span>
02625 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the object</span>
02626 <span class="comment">        being accessed</span>
02627 <span class="comment"></span>
02628 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
02629 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
02630 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
02631 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
02632 <span class="comment"></span>
02633 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
02634 <span class="comment"></span>
02635 <span class="comment">    ClientToken - Supplies the handle of the user's token.</span>
02636 <span class="comment"></span>
02637 <span class="comment">    DesiredAccess - Supplies the desired access mask.</span>
02638 <span class="comment"></span>
02639 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
02640 <span class="comment">        sub-objects) being accessed.  If no list is present, AccessCheckByType</span>
02641 <span class="comment">        behaves identically to AccessCheck.</span>
02642 <span class="comment"></span>
02643 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
02644 <span class="comment"></span>
02645 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
02646 <span class="comment">        object type.</span>
02647 <span class="comment"></span>
02648 <span class="comment">    PrivilegeSet - A pointer to a buffer that upon return will contain</span>
02649 <span class="comment">        any privileges that were used to perform the access validation.</span>
02650 <span class="comment">        If no privileges were used, the buffer will contain a privilege</span>
02651 <span class="comment">        set consisting of zero privileges.</span>
02652 <span class="comment"></span>
02653 <span class="comment">    PrivilegeSetLength - The size of the PrivilegeSet buffer in bytes.</span>
02654 <span class="comment"></span>
02655 <span class="comment">    GrantedAccess - Returns an access mask describing the granted access.</span>
02656 <span class="comment"></span>
02657 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
02658 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
02659 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
02660 <span class="comment">         be returned when mandatory access control is implemented.</span>
02661 <span class="comment"></span>
02662 <span class="comment">Return Value:</span>
02663 <span class="comment"></span>
02664 <span class="comment">    STATUS_SUCCESS - The attempt proceeded normally.  This does not</span>
02665 <span class="comment">        mean access was granted, rather that the parameters were</span>
02666 <span class="comment">        correct.</span>
02667 <span class="comment"></span>
02668 <span class="comment">    STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained</span>
02669 <span class="comment">        an unmapped generic access.</span>
02670 <span class="comment"></span>
02671 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough</span>
02672 <span class="comment">        to contain the information being returned.</span>
02673 <span class="comment"></span>
02674 <span class="comment">    STATUS_NO_IMPERSONTAION_TOKEN - The passed Token was not an impersonation</span>
02675 <span class="comment">        token.</span>
02676 <span class="comment"></span>
02677 <span class="comment">--*/</span>
02678 
02679 {
02680 
02681     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02682 
02683     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02684                  SecurityDescriptor,
02685                  PrincipalSelfSid,
02686                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,
02687                  DesiredAccess,
02688                  ObjectTypeList,
02689                  ObjectTypeListLength,
02690                  GenericMapping,
02691                  PrivilegeSet,
02692                  PrivilegeSetLength,
02693                  GrantedAccess,
02694                  AccessStatus,
02695                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );  <span class="comment">// Return an array of GrantedAccess and AccessStatus</span>
02696 }
02697 
02698 
02699 
02700 
02701 
02702 
02703 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02704"></a><a class="code" href="../../d0/d4/accessck_8c.html#a5">02704</a> <a class="code" href="../../d0/d4/accessck_8c.html#a5">SeAccessCheckByType</a> (
02705     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
02706     IN PSID PrincipalSelfSid,
02707     IN HANDLE ClientToken,
02708     IN ACCESS_MASK DesiredAccess,
02709     IN POBJECT_TYPE_LIST ObjectTypeList OPTIONAL,
02710     IN ULONG ObjectTypeListLength,
02711     IN PGENERIC_MAPPING GenericMapping,
02712     OUT PPRIVILEGE_SET PrivilegeSet,
02713     IN OUT PULONG PrivilegeSetLength,
02714     OUT PACCESS_MASK GrantedAccess,
02715     OUT PNTSTATUS AccessStatus,
02716     IN BOOLEAN ReturnResultList
02717     )
02718 
02719 
02720 <span class="comment">/*++</span>
02721 <span class="comment"></span>
02722 <span class="comment">Routine Description:</span>
02723 <span class="comment"></span>
02724 <span class="comment">    See module abstract.</span>
02725 <span class="comment"></span>
02726 <span class="comment">Arguments:</span>
02727 <span class="comment"></span>
02728 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the object</span>
02729 <span class="comment">        being accessed</span>
02730 <span class="comment"></span>
02731 <span class="comment">    PrincipalSelfSid - If the object being access checked is an object which</span>
02732 <span class="comment">        represents a principal (e.g., a user object), this parameter should</span>
02733 <span class="comment">        be the SID of the object.  Any ACE containing the constant</span>
02734 <span class="comment">        PRINCIPAL_SELF_SID is replaced by this SID.</span>
02735 <span class="comment"></span>
02736 <span class="comment">        The parameter should be NULL if the object does not represent a principal.</span>
02737 <span class="comment"></span>
02738 <span class="comment">    ClientToken - Supplies the handle of the user's token.</span>
02739 <span class="comment"></span>
02740 <span class="comment">    DesiredAccess - Supplies the desired access mask.</span>
02741 <span class="comment"></span>
02742 <span class="comment">    ObjectTypeList - Supplies a list of GUIDs representing the object (and</span>
02743 <span class="comment">        sub-objects) being accessed.  If no list is present, AccessCheckByType</span>
02744 <span class="comment">        behaves identically to AccessCheck.</span>
02745 <span class="comment"></span>
02746 <span class="comment">    ObjectTypeListLength - Specifies the number of elements in the ObjectTypeList.</span>
02747 <span class="comment"></span>
02748 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
02749 <span class="comment">        object type.</span>
02750 <span class="comment"></span>
02751 <span class="comment">    PrivilegeSet - A pointer to a buffer that upon return will contain</span>
02752 <span class="comment">        any privileges that were used to perform the access validation.</span>
02753 <span class="comment">        If no privileges were used, the buffer will contain a privilege</span>
02754 <span class="comment">        set consisting of zero privileges.</span>
02755 <span class="comment"></span>
02756 <span class="comment">    PrivilegeSetLength - The size of the PrivilegeSet buffer in bytes.</span>
02757 <span class="comment"></span>
02758 <span class="comment">    GrantedAccess - Returns an access mask describing the granted access.</span>
02759 <span class="comment"></span>
02760 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
02761 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
02762 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
02763 <span class="comment">         be returned when mandatory access control is implemented.</span>
02764 <span class="comment"></span>
02765 <span class="comment">    ReturnResultList - If true, GrantedAccess and AccessStatus are actually</span>
02766 <span class="comment">        arrays of entries ObjectTypeListLength elements long.</span>
02767 <span class="comment"></span>
02768 <span class="comment">Return Value:</span>
02769 <span class="comment"></span>
02770 <span class="comment">    STATUS_SUCCESS - The attempt proceeded normally.  This does not</span>
02771 <span class="comment">        mean access was granted, rather that the parameters were</span>
02772 <span class="comment">        correct.</span>
02773 <span class="comment"></span>
02774 <span class="comment">    STATUS_GENERIC_NOT_MAPPED - The DesiredAccess mask contained</span>
02775 <span class="comment">        an unmapped generic access.</span>
02776 <span class="comment"></span>
02777 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough</span>
02778 <span class="comment">        to contain the information being returned.</span>
02779 <span class="comment"></span>
02780 <span class="comment">    STATUS_NO_IMPERSONTAION_TOKEN - The passed Token was not an impersonation</span>
02781 <span class="comment">        token.</span>
02782 <span class="comment"></span>
02783 <span class="comment">--*/</span>
02784 
02785 {
02786     ACCESS_MASK LocalGrantedAccess;
02787     PACCESS_MASK LocalGrantedAccessPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02788     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> LocalAccessStatus;
02789     PNTSTATUS LocalAccessStatusPointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02791     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02792     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02793     PSECURITY_DESCRIPTOR CapturedSecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02794     PSID CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02795     ACCESS_MASK PreviouslyGrantedAccess = 0;
02796     GENERIC_MAPPING LocalGenericMapping;
02797     <a class="code" href="../../d7/d9/struct__IOBJECT__TYPE__LIST.html">PIOBJECT_TYPE_LIST</a> LocalObjectTypeList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02798     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02799     <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
02800     ULONG LocalPrivilegeSetLength;
02801     ULONG ResultListIndex;
02802 
02803     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02804 
02805     PreviousMode = KeGetPreviousMode();
02806 
02807     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02808         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !ReturnResultList );
02809         *AccessStatus = STATUS_SUCCESS;
02810         *GrantedAccess = DesiredAccess;
02811         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02812     }
02813 
02814     <span class="keywordflow">try</span> {
02815 
02816         <span class="keywordflow">if</span> ( ReturnResultList ) {
02817 
02818             <span class="keywordflow">if</span> ( ObjectTypeListLength == 0 ) {
02819                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
02820                 leave ;
02821             }
02822 
02823             <span class="keywordflow">if</span> ( !<a class="code" href="../../d6/d6/sep_8h.html#a11">IsValidElementCount</a>( ObjectTypeListLength, OBJECT_TYPE_LIST ) )
02824             {
02825                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER ;
02826 
02827                 leave ;
02828             }
02829 
02830             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02831                 AccessStatus,
02832                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) * ObjectTypeListLength,
02833                 <span class="keyword">sizeof</span>(ULONG)
02834                 );
02835 
02836             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02837                 GrantedAccess,
02838                 <span class="keyword">sizeof</span>(ACCESS_MASK) * ObjectTypeListLength,
02839                 <span class="keyword">sizeof</span>(ULONG)
02840                 );
02841 
02842         } <span class="keywordflow">else</span> {
02843             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)AccessStatus);
02844             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>((PULONG)GrantedAccess);
02845         }
02846 
02847         LocalPrivilegeSetLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( PrivilegeSetLength );
02848         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(
02849             PrivilegeSetLength
02850             );
02851 
02852         <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(
02853             PrivilegeSet,
02854             LocalPrivilegeSetLength,
02855             <span class="keyword">sizeof</span>(ULONG)
02856             );
02857 
02858         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
02859             GenericMapping,
02860             <span class="keyword">sizeof</span>(GENERIC_MAPPING),
02861             <span class="keyword">sizeof</span>(ULONG)
02862             );
02863 
02864         LocalGenericMapping = *GenericMapping;
02865 
02866     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02867         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02868     }
02869     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
02870         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02871     }
02872 
02873     <span class="keywordflow">if</span> (DesiredAccess &amp;
02874         ( GENERIC_READ | GENERIC_WRITE | GENERIC_EXECUTE | GENERIC_ALL )) {
02875 
02876 
02877         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_GENERIC_NOT_MAPPED;
02878         <span class="keywordflow">goto</span> Cleanup;
02879     }
02880 
02881     <span class="comment">//</span>
02882     <span class="comment">// Obtain a pointer to the passed token</span>
02883     <span class="comment">//</span>
02884 
02885     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02886                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a16">ClientToken</a>,                  <span class="comment">// Handle</span>
02887                  (ACCESS_MASK)TOKEN_QUERY,     <span class="comment">// DesiredAccess</span>
02888                  <a class="code" href="../../d0/d5/se_8h.html#a36">SepTokenObjectType</a>,           <span class="comment">// ObjectType</span>
02889                  PreviousMode,                 <span class="comment">// AccessMode</span>
02890                  (PVOID *)&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,              <span class="comment">// Object</span>
02891                  0                             <span class="comment">// GrantedAccess</span>
02892                  );
02893 
02894     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02895         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02896         <span class="keywordflow">goto</span> Cleanup;
02897     }
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// It must be an impersonation token, and at impersonation</span>
02901     <span class="comment">// level of Identification or above.</span>
02902     <span class="comment">//</span>
02903 
02904     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenType != TokenImpersonation) {
02905         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_IMPERSONATION_TOKEN;
02906         <span class="keywordflow">goto</span> Cleanup;
02907     }
02908 
02909     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;ImpersonationLevel &lt; SecurityIdentification ) {
02910         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BAD_IMPERSONATION_LEVEL;
02911         <span class="keywordflow">goto</span> Cleanup;
02912     }
02913 
02914     <span class="comment">//</span>
02915     <span class="comment">// Capture any Object type list</span>
02916     <span class="comment">//</span>
02917 
02918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d3/tokenp_8h.html#a21">SeCaptureObjectTypeList</a>( ObjectTypeList,
02919                                       ObjectTypeListLength,
02920                                       PreviousMode,
02921                                       &amp;LocalObjectTypeList );
02922 
02923     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02924         <span class="keywordflow">goto</span> Cleanup;
02925     }
02926 
02927     <span class="comment">//</span>
02928     <span class="comment">// Compare the DesiredAccess with the privileges in the</span>
02929     <span class="comment">// passed token, and see if we can either satisfy the requested</span>
02930     <span class="comment">// access with a privilege, or bomb out immediately because</span>
02931     <span class="comment">// we don't have a privilege we need.</span>
02932     <span class="comment">//</span>
02933 
02934     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a>(
02935                  &amp;DesiredAccess,
02936                  &amp;PreviouslyGrantedAccess,
02937                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02938                  (PACCESS_TOKEN)<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
02939                  &amp;Privileges,
02940                  PreviousMode
02941                  );
02942 
02943     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02944 
02945         <span class="keywordflow">try</span> {
02946 
02947             <span class="keywordflow">if</span> ( ReturnResultList ) {
02948                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
02949                     AccessStatus[ResultListIndex] = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02950                     GrantedAccess[ResultListIndex] = 0;
02951                 }
02952 
02953             } <span class="keywordflow">else</span> {
02954                 *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02955                 *GrantedAccess = 0;
02956             }
02957 
02958             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02959 
02960         } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
02961 
02962             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02963         }
02964 
02965         <span class="keywordflow">goto</span> Cleanup;
02966     }
02967 
02968     <span class="comment">//</span>
02969     <span class="comment">// Make sure the passed privileges buffer is large enough for</span>
02970     <span class="comment">// whatever we have to put into it.</span>
02971     <span class="comment">//</span>
02972 
02973     <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02974 
02975         <span class="keywordflow">if</span> ( ((ULONG)<a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges )) &gt; LocalPrivilegeSetLength ) {
02976 
02977             <span class="keywordflow">try</span> {
02978 
02979                 *PrivilegeSetLength = <a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges );
02980                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
02981 
02982             } except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
02983 
02984                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
02985             }
02986 
02987             <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
02988 
02989             <span class="keywordflow">goto</span> Cleanup;
02990 
02991         } <span class="keywordflow">else</span> {
02992 
02993             <span class="keywordflow">try</span> {
02994 
02995                 RtlCopyMemory(
02996                     PrivilegeSet,
02997                     Privileges,
02998                     <a class="code" href="../../d6/d6/sep_8h.html#a6">SepPrivilegeSetSize</a>( Privileges )
02999                     );
03000 
03001             } except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
03002 
03003                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
03004                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03005                 <span class="keywordflow">goto</span> Cleanup;
03006             }
03007 
03008         }
03009         <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
03010 
03011     } <span class="keywordflow">else</span> {
03012 
03013         <span class="comment">//</span>
03014         <span class="comment">// No privileges were used, construct an empty privilege set</span>
03015         <span class="comment">//</span>
03016 
03017         <span class="keywordflow">if</span> ( LocalPrivilegeSetLength &lt; <span class="keyword">sizeof</span>(PRIVILEGE_SET) ) {
03018 
03019             <span class="keywordflow">try</span> {
03020 
03021                 *PrivilegeSetLength = <span class="keyword">sizeof</span>(PRIVILEGE_SET);
03022                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
03023 
03024             } except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
03025 
03026                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03027             }
03028 
03029             <span class="keywordflow">goto</span> Cleanup;
03030         }
03031 
03032         <span class="keywordflow">try</span> {
03033 
03034             PrivilegeSet-&gt;PrivilegeCount = 0;
03035             PrivilegeSet-&gt;Control = 0;
03036 
03037         } except ( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
03038 
03039             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03040             <span class="keywordflow">goto</span> Cleanup;
03041 
03042         }
03043 
03044     }
03045 
03046     <span class="comment">//</span>
03047     <span class="comment">// Capture the PrincipalSelfSid.</span>
03048     <span class="comment">//</span>
03049 
03050     <span class="keywordflow">if</span> ( PrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03051         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>(
03052                      PrincipalSelfSid,
03053                      PreviousMode,
03054                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0,
03055                      <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03056                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
03057                      &amp;CapturedPrincipalSelfSid );
03058 
03059         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03060             CapturedPrincipalSelfSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03061             <span class="keywordflow">goto</span> Cleanup;
03062         }
03063     }
03064 
03065 
03066     <span class="comment">//</span>
03067     <span class="comment">// Capture the passed security descriptor.</span>
03068     <span class="comment">//</span>
03069     <span class="comment">// SeCaptureSecurityDescriptor probes the input security descriptor,</span>
03070     <span class="comment">// so we don't have to</span>
03071     <span class="comment">//</span>
03072 
03073     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a> (
03074                 SecurityDescriptor,
03075                 PreviousMode,
03076                 <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
03077                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03078                 &amp;CapturedSecurityDescriptor
03079                 );
03080 
03081     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
03082         <span class="keywordflow">goto</span> Cleanup;
03083     }
03084 
03085 
03086     <span class="comment">//</span>
03087     <span class="comment">// If there's no security descriptor, then we've been</span>
03088     <span class="comment">// called without all the parameters we need.</span>
03089     <span class="comment">// Return invalid security descriptor.</span>
03090     <span class="comment">//</span>
03091 
03092     <span class="keywordflow">if</span> ( CapturedSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03093         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
03094         <span class="keywordflow">goto</span> Cleanup;
03095     }
03096 
03097     <span class="comment">//</span>
03098     <span class="comment">// A valid security descriptor must have an owner and a group</span>
03099     <span class="comment">//</span>
03100 
03101     <span class="keywordflow">if</span> ( RtlpOwnerAddrSecurityDescriptor(
03102                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
03103                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
03104          RtlpGroupAddrSecurityDescriptor(
03105                 (PISECURITY_DESCRIPTOR)CapturedSecurityDescriptor
03106                 ) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03107 
03108         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03109             CapturedSecurityDescriptor,
03110             PreviousMode,
03111             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03112             );
03113 
03114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_SECURITY_DESCR;
03115         <span class="keywordflow">goto</span> Cleanup;
03116     }
03117 
03118 
03119     <a class="code" href="../../d0/d8/subject_8c.html#a0">SeCaptureSubjectContext</a>( &amp;SubjectContext );
03120 
03121     <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03122 
03123     <span class="comment">//</span>
03124     <span class="comment">// If the user in the token is the owner of the object, we</span>
03125     <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
03126     <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
03127     <span class="comment">// these bits are turned off, we don't have to do any more</span>
03128     <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
03129     <span class="comment">//</span>
03130 
03131 
03132     <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
03133 
03134         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, CapturedSecurityDescriptor, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
03135 
03136             <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
03137 
03138                 PreviouslyGrantedAccess |= (WRITE_DAC | READ_CONTROL);
03139 
03140             } <span class="keywordflow">else</span> {
03141 
03142                 PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
03143             }
03144 
03145             DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
03146         }
03147 
03148     }
03149 
03150     <span class="keywordflow">if</span> (DesiredAccess == 0) {
03151 
03152         <span class="keywordflow">try</span> {
03153 
03154 
03155             <span class="keywordflow">if</span> ( ReturnResultList ) {
03156                 <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
03157                     AccessStatus[ResultListIndex] = STATUS_SUCCESS;
03158                     GrantedAccess[ResultListIndex] = PreviouslyGrantedAccess;
03159                 }
03160 
03161             } <span class="keywordflow">else</span> {
03162                 *AccessStatus = STATUS_SUCCESS;
03163                 *GrantedAccess = PreviouslyGrantedAccess;
03164             }
03165             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03166 
03167         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03168 
03169             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03170 
03171         }
03172 
03173         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03174 
03175         <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03176 
03177         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03178             CapturedSecurityDescriptor,
03179             PreviousMode,
03180             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03181             );
03182 
03183         <span class="keywordflow">goto</span> Cleanup;
03184 
03185     }
03186 
03187 
03188     <span class="comment">//</span>
03189     <span class="comment">// Finally, handle the case where we actually have to check the DACL.</span>
03190     <span class="comment">//</span>
03191 
03192     <span class="keywordflow">if</span> ( ReturnResultList ) {
03193         LocalGrantedAccessPointer =
03194             <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, (<span class="keyword">sizeof</span>(ACCESS_MASK)+<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)) * ObjectTypeListLength, 'aGeS' );
03195 
03196         <span class="keywordflow">if</span> (LocalGrantedAccessPointer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03197 
03198             <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03199 
03200             <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03201 
03202             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03203                 CapturedSecurityDescriptor,
03204                 PreviousMode,
03205                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03206                 );
03207 
03208             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
03209             <span class="keywordflow">goto</span> Cleanup;
03210         }
03211         LocalAccessStatusPointer = (PNTSTATUS)(LocalGrantedAccessPointer + ObjectTypeListLength);
03212     } <span class="keywordflow">else</span> {
03213         LocalGrantedAccessPointer = &amp;LocalGrantedAccess;
03214         LocalAccessStatusPointer =  &amp;LocalAccessStatus;
03215     }
03216 
03217     <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a> (
03218         CapturedSecurityDescriptor,
03219         CapturedPrincipalSelfSid,
03220         SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>,
03221         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
03222         DesiredAccess,
03223         LocalObjectTypeList,
03224         ObjectTypeListLength,
03225         &amp;LocalGenericMapping,
03226         PreviouslyGrantedAccess,
03227         PreviousMode,
03228         LocalGrantedAccessPointer,
03229         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03230         LocalAccessStatusPointer,
03231         ReturnResultList,
03232         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03233         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03234 
03235     <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03236 
03237     <a class="code" href="../../d0/d8/subject_8c.html#a3">SeReleaseSubjectContext</a>( &amp;SubjectContext );
03238 
03239     <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a> (
03240         CapturedSecurityDescriptor,
03241         PreviousMode,
03242         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03243         );
03244 
03245     <span class="keywordflow">try</span> {
03246 
03247         <span class="keywordflow">if</span> ( ReturnResultList ) {
03248             <span class="keywordflow">for</span> ( ResultListIndex=0; ResultListIndex&lt;ObjectTypeListLength; ResultListIndex++ ) {
03249                 AccessStatus[ResultListIndex] = LocalAccessStatusPointer[ResultListIndex];
03250                 GrantedAccess[ResultListIndex] = LocalGrantedAccessPointer[ResultListIndex];
03251             }
03252 
03253         } <span class="keywordflow">else</span> {
03254             *AccessStatus = *LocalAccessStatusPointer;
03255             *GrantedAccess = *LocalGrantedAccessPointer;
03256         }
03257 
03258         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03259 
03260     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
03261         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
03262     }
03263 
03264     <span class="keywordflow">if</span> ( ReturnResultList ) {
03265         <span class="keywordflow">if</span> ( LocalGrantedAccessPointer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03266             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LocalGrantedAccessPointer );
03267         }
03268     }
03269 
03270 
03271     <span class="comment">//</span>
03272     <span class="comment">// Free locally used resources.</span>
03273     <span class="comment">//</span>
03274 Cleanup:
03275 
03276     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03278     }
03279 
03280     <span class="keywordflow">if</span> ( LocalObjectTypeList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03281         <a class="code" href="../../d8/d3/tokenp_8h.html#a22">SeFreeCapturedObjectTypeList</a>( LocalObjectTypeList );
03282     }
03283 
03284     <span class="keywordflow">if</span> (CapturedPrincipalSelfSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03285         <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedPrincipalSelfSid, PreviousMode, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03286     }
03287 
03288     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03289 }
03290 
03291 
03292 
03293 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03294"></a><a class="code" href="../../d0/d4/accessck_8c.html#a17">03294</a> <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>(
03295     IN PPRIVILEGE_SET Privileges
03296     )
03297 
03298 <span class="comment">/*++</span>
03299 <span class="comment"></span>
03300 <span class="comment">Routine Description:</span>
03301 <span class="comment"></span>
03302 <span class="comment">    This routine frees a privilege set returned by SeAccessCheck.</span>
03303 <span class="comment"></span>
03304 <span class="comment">Arguments:</span>
03305 <span class="comment"></span>
03306 <span class="comment">    Privileges - Supplies a pointer to the privilege set to be freed.</span>
03307 <span class="comment"></span>
03308 <span class="comment">Return Value:</span>
03309 <span class="comment"></span>
03310 <span class="comment">    None.</span>
03311 <span class="comment"></span>
03312 <span class="comment">--*/</span>
03313 
03314 {
03315     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03316 
03317     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Privileges );
03318 }
03319 
03320 
03321 
03322 BOOLEAN
<a name="l03323"></a><a class="code" href="../../d0/d4/accessck_8c.html#a18">03323</a> <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a> (
03324     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03325     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
03326     IN BOOLEAN SubjectContextLocked,
03327     IN ACCESS_MASK DesiredAccess,
03328     IN ACCESS_MASK PreviouslyGrantedAccess,
03329     OUT PPRIVILEGE_SET *Privileges OPTIONAL,
03330     IN PGENERIC_MAPPING GenericMapping,
03331     IN KPROCESSOR_MODE AccessMode,
03332     OUT PACCESS_MASK GrantedAccess,
03333     OUT PNTSTATUS AccessStatus
03334     )
03335 
03336 <span class="comment">/*++</span>
03337 <span class="comment"></span>
03338 <span class="comment">Routine Description:</span>
03339 <span class="comment"></span>
03340 <span class="comment">    See module abstract</span>
03341 <span class="comment"></span>
03342 <span class="comment">    This routine MAY perform tests for the following</span>
03343 <span class="comment">    privileges:</span>
03344 <span class="comment"></span>
03345 <span class="comment">                SeTakeOwnershipPrivilege</span>
03346 <span class="comment">                SeSecurityPrivilege</span>
03347 <span class="comment"></span>
03348 <span class="comment">    depending upon the accesses being requested.</span>
03349 <span class="comment"></span>
03350 <span class="comment">    This routine may also check to see if the subject is the owner</span>
03351 <span class="comment">    of the object (to grant WRITE_DAC access).</span>
03352 <span class="comment"></span>
03353 <span class="comment">Arguments:</span>
03354 <span class="comment"></span>
03355 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the</span>
03356 <span class="comment">         object being accessed</span>
03357 <span class="comment"></span>
03358 <span class="comment">    SubjectSecurityContext - A pointer to the subject's captured security</span>
03359 <span class="comment">         context</span>
03360 <span class="comment"></span>
03361 <span class="comment">    SubjectContextLocked - Supplies a flag indiciating whether or not</span>
03362 <span class="comment">        the user's subject context is locked, so that it does not have</span>
03363 <span class="comment">        to be locked again.</span>
03364 <span class="comment"></span>
03365 <span class="comment">    DesiredAccess - Supplies the access mask that the user is attempting to</span>
03366 <span class="comment">         acquire</span>
03367 <span class="comment"></span>
03368 <span class="comment">    PreviouslyGrantedAccess - Supplies any accesses that the user has</span>
03369 <span class="comment">        already been granted, for example, as a result of holding a</span>
03370 <span class="comment">        privilege.</span>
03371 <span class="comment"></span>
03372 <span class="comment">    Privileges - Supplies a pointer in which will be returned a privilege</span>
03373 <span class="comment">        set indicating any privileges that were used as part of the</span>
03374 <span class="comment">        access validation.</span>
03375 <span class="comment"></span>
03376 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
03377 <span class="comment">        object type.</span>
03378 <span class="comment"></span>
03379 <span class="comment">    AccessMode - Supplies the access mode to be used in the check</span>
03380 <span class="comment"></span>
03381 <span class="comment">    GrantedAccess - Pointer to a returned access mask indicatating the</span>
03382 <span class="comment">         granted access</span>
03383 <span class="comment"></span>
03384 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
03385 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
03386 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
03387 <span class="comment">         be returned when mandatory access control is implemented.</span>
03388 <span class="comment"></span>
03389 <span class="comment"></span>
03390 <span class="comment">Return Value:</span>
03391 <span class="comment"></span>
03392 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise</span>
03393 <span class="comment"></span>
03394 <span class="comment">--*/</span>
03395 
03396 {
03397     BOOLEAN Success;
03398 
03399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03400 
03401     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03402 
03403         <span class="keywordflow">if</span> (DesiredAccess &amp; MAXIMUM_ALLOWED) {
03404 
03405             <span class="comment">//</span>
03406             <span class="comment">// Give him:</span>
03407             <span class="comment">//   GenericAll</span>
03408             <span class="comment">//   Anything else he asked for</span>
03409             <span class="comment">//</span>
03410 
03411             *GrantedAccess = GenericMapping-&gt;GenericAll;
03412             *GrantedAccess |= (DesiredAccess &amp; ~MAXIMUM_ALLOWED);
03413             *GrantedAccess |= PreviouslyGrantedAccess;
03414 
03415         } <span class="keywordflow">else</span> {
03416 
03417             *GrantedAccess = DesiredAccess | PreviouslyGrantedAccess;
03418         }
03419         *AccessStatus = STATUS_SUCCESS;
03420         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03421     }
03422 
03423     <span class="comment">//</span>
03424     <span class="comment">// If the object doesn't have a security descriptor (and it's supposed</span>
03425     <span class="comment">// to), return access denied.</span>
03426     <span class="comment">//</span>
03427 
03428     <span class="keywordflow">if</span> ( SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03429 
03430        *AccessStatus = STATUS_ACCESS_DENIED;
03431        <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03432 
03433     }
03434 
03435     <span class="comment">//</span>
03436     <span class="comment">// If we're impersonating a client, we have to be at impersonation level</span>
03437     <span class="comment">// of SecurityImpersonation or above.</span>
03438     <span class="comment">//</span>
03439 
03440     <span class="keywordflow">if</span> ( (SubjectSecurityContext-&gt;ClientToken != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03441          (SubjectSecurityContext-&gt;ImpersonationLevel &lt; SecurityImpersonation)
03442        ) {
03443            *AccessStatus = STATUS_BAD_IMPERSONATION_LEVEL;
03444            <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03445     }
03446 
03447     <span class="keywordflow">if</span> ( DesiredAccess == 0 ) {
03448 
03449         <span class="keywordflow">if</span> ( PreviouslyGrantedAccess == 0 ) {
03450             *AccessStatus = STATUS_ACCESS_DENIED;
03451             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03452         }
03453 
03454         *GrantedAccess = PreviouslyGrantedAccess;
03455         *AccessStatus = STATUS_SUCCESS;
03456         *Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03457         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03458 
03459     }
03460 
03461     <a class="code" href="../../d0/d5/se_8h.html#a14">SeAssertMappedCanonicalAccess</a>( DesiredAccess );
03462 
03463 
03464     <span class="comment">//</span>
03465     <span class="comment">// If the caller did not lock the subject context for us,</span>
03466     <span class="comment">// lock it here to keep lower level routines from having</span>
03467     <span class="comment">// to lock it.</span>
03468     <span class="comment">//</span>
03469 
03470     <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03471         <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( SubjectSecurityContext );
03472     }
03473 
03474     <span class="comment">//</span>
03475     <span class="comment">// If the user in the token is the owner of the object, we</span>
03476     <span class="comment">// must automatically grant ReadControl and WriteDac access</span>
03477     <span class="comment">// if desired.  If the DesiredAccess mask is empty after</span>
03478     <span class="comment">// these bits are turned off, we don't have to do any more</span>
03479     <span class="comment">// access checking (ref section 4, DSA ACL Arch)</span>
03480     <span class="comment">//</span>
03481 
03482     <span class="keywordflow">if</span> ( DesiredAccess &amp; (WRITE_DAC | READ_CONTROL | MAXIMUM_ALLOWED) ) {
03483 
03484         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>(
03485                  <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ),
03486                  SecurityDescriptor,
03487                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03488                  ) ) {
03489 
03490             <span class="keywordflow">if</span> ( DesiredAccess &amp; MAXIMUM_ALLOWED ) {
03491 
03492                 PreviouslyGrantedAccess |= (WRITE_DAC | READ_CONTROL);
03493 
03494             } <span class="keywordflow">else</span> {
03495 
03496                 PreviouslyGrantedAccess |= (DesiredAccess &amp; (WRITE_DAC | READ_CONTROL));
03497             }
03498 
03499             DesiredAccess &amp;= ~(WRITE_DAC | READ_CONTROL);
03500         }
03501     }
03502 
03503     <span class="keywordflow">if</span> (DesiredAccess == 0) {
03504 
03505         <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03506             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03507         }
03508 
03509         *GrantedAccess = PreviouslyGrantedAccess;
03510         *AccessStatus = STATUS_SUCCESS;
03511         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03512 
03513     } <span class="keywordflow">else</span> {
03514 
03515         <a class="code" href="../../d8/d3/tokenp_8h.html#a38">SepAccessCheck</a>(
03516                     SecurityDescriptor,
03517                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// No PrincipalSelfSid</span>
03518                     SubjectSecurityContext-&gt;PrimaryToken,
03519                     SubjectSecurityContext-&gt;ClientToken,
03520                     DesiredAccess,
03521                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// No object type list</span>
03522                     0,      <span class="comment">// No object type list</span>
03523                     GenericMapping,
03524                     PreviouslyGrantedAccess,
03525                     AccessMode,
03526                     GrantedAccess,
03527                     Privileges,
03528                     AccessStatus,
03529                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,   <span class="comment">// Don't return a list</span>
03530                     &amp;Success,
03531                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03532                     );
03533 <span class="preprocessor">#if DBG</span>
03534 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (!Success &amp;&amp; SepShowAccessFail) {
03535               <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE: Access check failed, DesiredAccess = 0x%x\n"</span>,
03536                 DesiredAccess);
03537               SepDumpSD = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03538               <a class="code" href="../../d6/d6/sep_8h.html#a57">SepDumpSecurityDescriptor</a>(
03539                   SecurityDescriptor,
03540                   <span class="stringliteral">"Input to SeAccessCheck\n"</span>
03541                   );
03542               SepDumpSD = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03543               SepDumpToken = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03544               <a class="code" href="../../d6/d6/sep_8h.html#a59">SepDumpTokenInfo</a>( <a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext ) );
03545               SepDumpToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03546           }
03547 <span class="preprocessor">#endif</span>
03548 <span class="preprocessor"></span>
03549         <span class="comment">//</span>
03550         <span class="comment">// If we locked it in this routine, unlock it before we</span>
03551         <span class="comment">// leave.</span>
03552         <span class="comment">//</span>
03553 
03554         <span class="keywordflow">if</span> ( !SubjectContextLocked ) {
03555             <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( SubjectSecurityContext );
03556         }
03557 
03558         <span class="keywordflow">return</span>( Success );
03559     }
03560 }
03561 
03562 
03563 BOOLEAN
<a name="l03564"></a><a class="code" href="../../d0/d4/accessck_8c.html#a19">03564</a> <a class="code" href="../../d0/d4/accessck_8c.html#a19">SeProxyAccessCheck</a> (
03565     IN PUNICODE_STRING Volume,
03566     IN PUNICODE_STRING RelativePath,
03567     IN BOOLEAN ContainerObject,
03568     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03569     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext,
03570     IN BOOLEAN SubjectContextLocked,
03571     IN ACCESS_MASK DesiredAccess,
03572     IN ACCESS_MASK PreviouslyGrantedAccess,
03573     OUT PPRIVILEGE_SET *Privileges OPTIONAL,
03574     IN PGENERIC_MAPPING GenericMapping,
03575     IN KPROCESSOR_MODE AccessMode,
03576     OUT PACCESS_MASK GrantedAccess,
03577     OUT PNTSTATUS AccessStatus
03578     )
03579 
03580 <span class="comment">/*++</span>
03581 <span class="comment"></span>
03582 <span class="comment">Routine Description:</span>
03583 <span class="comment"></span>
03584 <span class="comment"></span>
03585 <span class="comment">Arguments:</span>
03586 <span class="comment"></span>
03587 <span class="comment">    Volume - Supplies the volume information of the file being opened.</span>
03588 <span class="comment"></span>
03589 <span class="comment">    RelativePath - The volume-relative path of the file being opened.  The full path of the</span>
03590 <span class="comment">        file is the RelativePath appended to the Volume string.</span>
03591 <span class="comment"></span>
03592 <span class="comment">    ContainerObject - Indicates if the access is to a container object (TRUE), or a leaf object (FALSE).</span>
03593 <span class="comment"></span>
03594 <span class="comment">    SecurityDescriptor - Supplies the security descriptor protecting the</span>
03595 <span class="comment">         object being accessed</span>
03596 <span class="comment"></span>
03597 <span class="comment">    SubjectSecurityContext - A pointer to the subject's captured security</span>
03598 <span class="comment">         context</span>
03599 <span class="comment"></span>
03600 <span class="comment">    SubjectContextLocked - Supplies a flag indiciating whether or not</span>
03601 <span class="comment">        the user's subject context is locked, so that it does not have</span>
03602 <span class="comment">        to be locked again.</span>
03603 <span class="comment"></span>
03604 <span class="comment">    DesiredAccess - Supplies the access mask that the user is attempting to</span>
03605 <span class="comment">         acquire</span>
03606 <span class="comment"></span>
03607 <span class="comment">    PreviouslyGrantedAccess - Supplies any accesses that the user has</span>
03608 <span class="comment">        already been granted, for example, as a result of holding a</span>
03609 <span class="comment">        privilege.</span>
03610 <span class="comment"></span>
03611 <span class="comment">    Privileges - Supplies a pointer in which will be returned a privilege</span>
03612 <span class="comment">        set indicating any privileges that were used as part of the</span>
03613 <span class="comment">        access validation.</span>
03614 <span class="comment"></span>
03615 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
03616 <span class="comment">        object type.</span>
03617 <span class="comment"></span>
03618 <span class="comment">    AccessMode - Supplies the access mode to be used in the check</span>
03619 <span class="comment"></span>
03620 <span class="comment">    GrantedAccess - Pointer to a returned access mask indicatating the</span>
03621 <span class="comment">         granted access</span>
03622 <span class="comment"></span>
03623 <span class="comment">    AccessStatus - Status value that may be returned indicating the</span>
03624 <span class="comment">         reason why access was denied.  Routines should avoid hardcoding a</span>
03625 <span class="comment">         return value of STATUS_ACCESS_DENIED so that a different value can</span>
03626 <span class="comment">         be returned when mandatory access control is implemented.</span>
03627 <span class="comment"></span>
03628 <span class="comment"></span>
03629 <span class="comment">Return Value:</span>
03630 <span class="comment"></span>
03631 <span class="comment">    BOOLEAN - TRUE if access is allowed and FALSE otherwise</span>
03632 <span class="comment"></span>
03633 <span class="comment">--*/</span>
03634 
03635 {
03636     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a> (
03637                 SecurityDescriptor,
03638                 SubjectSecurityContext,
03639                 SubjectContextLocked,
03640                 DesiredAccess,
03641                 PreviouslyGrantedAccess,
03642                 Privileges,
03643                 GenericMapping,
03644                 AccessMode,
03645                 GrantedAccess,
03646                 AccessStatus
03647                );
03648 }
03649 
03650 
03651 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03652"></a><a class="code" href="../../d0/d4/accessck_8c.html#a20">03652</a> <a class="code" href="../../d0/d4/accessck_8c.html#a20">SePrivilegePolicyCheck</a>(
03653     IN OUT PACCESS_MASK RemainingDesiredAccess,
03654     IN OUT PACCESS_MASK PreviouslyGrantedAccess,
03655     IN <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">PSECURITY_SUBJECT_CONTEXT</a> SubjectSecurityContext OPTIONAL,
03656     IN PACCESS_TOKEN ExplicitToken OPTIONAL,
03657     OUT PPRIVILEGE_SET *PrivilegeSet,
03658     IN KPROCESSOR_MODE PreviousMode
03659     )
03660 
03661 <span class="comment">/*++</span>
03662 <span class="comment"></span>
03663 <span class="comment">Routine Description:</span>
03664 <span class="comment"></span>
03665 <span class="comment">    This routine implements privilege policy by examining the bits in</span>
03666 <span class="comment">    a DesiredAccess mask and adjusting them based on privilege checks.</span>
03667 <span class="comment"></span>
03668 <span class="comment">    Currently, a request for ACCESS_SYSTEM_SECURITY may only be satisfied</span>
03669 <span class="comment">    by the caller having SeSecurityPrivilege.  WRITE_OWNER may optionally</span>
03670 <span class="comment">    be satisfied via SeTakeOwnershipPrivilege.</span>
03671 <span class="comment"></span>
03672 <span class="comment">Arguments:</span>
03673 <span class="comment"></span>
03674 <span class="comment">    RemainingDesiredAccess - The desired access for the current operation.</span>
03675 <span class="comment">        Bits may be cleared in this if the subject has particular privileges.</span>
03676 <span class="comment"></span>
03677 <span class="comment">    PreviouslyGrantedAccess - Supplies an access mask describing any</span>
03678 <span class="comment">        accesses that have already been granted.  Bits may be set in</span>
03679 <span class="comment">        here as a result of privilge checks.</span>
03680 <span class="comment"></span>
03681 <span class="comment">    SubjectSecurityContext - Optionally provides the subject's security</span>
03682 <span class="comment">        context.</span>
03683 <span class="comment"></span>
03684 <span class="comment">    ExplicitToken - Optionally provides the token to be examined.</span>
03685 <span class="comment"></span>
03686 <span class="comment">    PrivilegeSet - Supplies a pointer to a location in which will be</span>
03687 <span class="comment">        returned a pointer to a privilege set.</span>
03688 <span class="comment"></span>
03689 <span class="comment">    PreviousMode - The previous processor mode.</span>
03690 <span class="comment"></span>
03691 <span class="comment">Return Value:</span>
03692 <span class="comment"></span>
03693 <span class="comment">    STATUS_SUCCESS - Any access requests that could be satisfied via</span>
03694 <span class="comment">        privileges were done.</span>
03695 <span class="comment"></span>
03696 <span class="comment">    STATUS_PRIVILEGE_NOT_HELD - An access type was being requested that</span>
03697 <span class="comment">        requires a privilege, and the current subject did not have the</span>
03698 <span class="comment">        privilege.</span>
03699 <span class="comment"></span>
03700 <span class="comment"></span>
03701 <span class="comment"></span>
03702 <span class="comment">--*/</span>
03703 
03704 {
03705     BOOLEAN Success;
03706     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03707     BOOLEAN WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03708     BOOLEAN SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03709     ULONG PrivilegeNumber = 0;
03710     ULONG PrivilegeCount = 0;
03711     ULONG SizeRequired;
03712 
03713     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03714 
03715     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( SubjectSecurityContext )) {
03716 
03717         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>( SubjectSecurityContext );
03718 
03719     } <span class="keywordflow">else</span> {
03720 
03721         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)ExplicitToken;
03722     }
03723 
03724 
03725     <span class="keywordflow">if</span> (*RemainingDesiredAccess &amp; ACCESS_SYSTEM_SECURITY) {
03726 
03727         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
03728                     <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>,
03729                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
03730                     PreviousMode
03731                     );
03732 
03733         <span class="keywordflow">if</span> (!Success) {
03734 
03735             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
03736         }
03737 
03738         PrivilegeCount++;
03739         SystemSecurity = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03740 
03741         *RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
03742         *PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
03743     }
03744 
03745     <span class="keywordflow">if</span> (*RemainingDesiredAccess &amp; WRITE_OWNER) {
03746 
03747         Success = <a class="code" href="../../d6/d6/sep_8h.html#a49">SepSinglePrivilegeCheck</a> (
03748                     <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>,
03749                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
03750                     PreviousMode
03751                     );
03752 
03753         <span class="keywordflow">if</span> (Success) {
03754 
03755             PrivilegeCount++;
03756             WriteOwner = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03757 
03758             *RemainingDesiredAccess &amp;= ~WRITE_OWNER;
03759             *PreviouslyGrantedAccess |= WRITE_OWNER;
03760 
03761         }
03762     }
03763 
03764     <span class="keywordflow">if</span> (PrivilegeCount &gt; 0) {
03765         SizeRequired = <span class="keyword">sizeof</span>(PRIVILEGE_SET) +
03766                         (PrivilegeCount - <a class="code" href="../../d5/d4/acpitabl_8h.html#a44">ANYSIZE_ARRAY</a>) *
03767                         (ULONG)<span class="keyword">sizeof</span>(LUID_AND_ATTRIBUTES);
03768 
03769         *PrivilegeSet = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, SizeRequired, 'rPeS' );
03770 
03771         <span class="keywordflow">if</span> ( *PrivilegeSet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
03772             <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
03773         }
03774 
03775         (*PrivilegeSet)-&gt;PrivilegeCount = PrivilegeCount;
03776         (*PrivilegeSet)-&gt;Control = 0;
03777 
03778         <span class="keywordflow">if</span> (WriteOwner) {
03779             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Luid = <a class="code" href="../../d0/d5/se_8h.html#a86">SeTakeOwnershipPrivilege</a>;
03780             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
03781             PrivilegeNumber++;
03782         }
03783 
03784         <span class="keywordflow">if</span> (SystemSecurity) {
03785             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
03786             (*PrivilegeSet)-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
03787         }
03788     }
03789 
03790     <span class="keywordflow">return</span>( STATUS_SUCCESS );
03791 }
03792 
03793 
03794 
03795 BOOLEAN
<a name="l03796"></a><a class="code" href="../../d6/d6/sep_8h.html#a54">03796</a> <a class="code" href="../../d6/d6/sep_8h.html#a54">SepTokenIsOwner</a>(
03797     IN PACCESS_TOKEN EffectiveToken,
03798     IN PSECURITY_DESCRIPTOR SecurityDescriptor,
03799     IN BOOLEAN TokenLocked
03800     )
03801 
03802 <span class="comment">/*++</span>
03803 <span class="comment"></span>
03804 <span class="comment">Routine Description:</span>
03805 <span class="comment"></span>
03806 <span class="comment">    This routine will determine of the Owner of the passed security descriptor</span>
03807 <span class="comment">    is in the passed token. If the token is restricted it cannot be the</span>
03808 <span class="comment">    owner.</span>
03809 <span class="comment"></span>
03810 <span class="comment"></span>
03811 <span class="comment">Arguments:</span>
03812 <span class="comment"></span>
03813 <span class="comment">    Token - The token representing the current user.</span>
03814 <span class="comment"></span>
03815 <span class="comment">    SecurityDescriptor - The security descriptor for the object being</span>
03816 <span class="comment">        accessed.</span>
03817 <span class="comment"></span>
03818 <span class="comment">    TokenLocked - A boolean describing whether the caller has taken</span>
03819 <span class="comment">        a read lock for the token.</span>
03820 <span class="comment"></span>
03821 <span class="comment"></span>
03822 <span class="comment">Return Value:</span>
03823 <span class="comment"></span>
03824 <span class="comment">    TRUE - The user of the token is the owner of the object.</span>
03825 <span class="comment"></span>
03826 <span class="comment">    FALSE - The user of the token is not the owner of the object.</span>
03827 <span class="comment"></span>
03828 <span class="comment">--*/</span>
03829 
03830 {
03831     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
03832     BOOLEAN rc;
03833 
03834     PISECURITY_DESCRIPTOR ISecurityDescriptor;
03835     <a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
03836 
03837     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03838 
03839     ISecurityDescriptor = (PISECURITY_DESCRIPTOR)SecurityDescriptor;
03840     <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = (<a class="code" href="../../d5/d3/parseini_8c.html#a4">PTOKEN</a>)<a class="code" href="../../d6/d6/sep_8h.html#a7">EffectiveToken</a>;
03841 
03842     <span class="keywordflow">if</span> (!TokenLocked) {
03843         <a class="code" href="../../d8/d3/tokenp_8h.html#a6">SepAcquireTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03844     }
03845 
03846     <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor( ISecurityDescriptor );
03847     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
03848 
03849     rc = <a class="code" href="../../d6/d6/sep_8h.html#a61">SepSidInToken</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03850 
03851     <span class="comment">//</span>
03852     <span class="comment">// For restricted tokens, check the restricted sids too.</span>
03853     <span class="comment">//</span>
03854 
03855     <span class="keywordflow">if</span> (rc &amp;&amp; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>-&gt;TokenFlags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0) {
03856         rc = <a class="code" href="../../d0/d4/accessck_8c.html#a8">SepSidInTokenEx</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03857 
03858     }
03859 
03860     <span class="keywordflow">if</span> (!TokenLocked) {
03861         <a class="code" href="../../d8/d3/tokenp_8h.html#a8">SepReleaseTokenReadLock</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
03862     }
03863 
03864     <span class="keywordflow">return</span>( rc );
03865 }
03866 
03867 
03868 
03869 
03870 BOOLEAN
<a name="l03871"></a><a class="code" href="../../d0/d4/accessck_8c.html#a22">03871</a> <a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>(
03872     PSECURITY_DESCRIPTOR SecurityDescriptor,
03873     ACCESS_MASK TraverseAccess,
03874     KPROCESSOR_MODE AccessMode
03875     )
03876 <span class="comment">/*++</span>
03877 <span class="comment"></span>
03878 <span class="comment">Routine Description:</span>
03879 <span class="comment"></span>
03880 <span class="comment">    This routine will examine the DACL of the passed Security Descriptor</span>
03881 <span class="comment">    to see if WORLD has Traverse access.  If so, no further access checking</span>
03882 <span class="comment">    is necessary.</span>
03883 <span class="comment"></span>
03884 <span class="comment">    Note that the SubjectContext for the client process does not have</span>
03885 <span class="comment">    to be locked to make this call, since it does not examine any data</span>
03886 <span class="comment">    structures in the Token.</span>
03887 <span class="comment"></span>
03888 <span class="comment">Arguments:</span>
03889 <span class="comment"></span>
03890 <span class="comment">    SecurityDescriptor - The Security Descriptor protecting the container</span>
03891 <span class="comment">        object being traversed.</span>
03892 <span class="comment"></span>
03893 <span class="comment">    TraverseAccess - Access mask describing Traverse access for this</span>
03894 <span class="comment">        object type.</span>
03895 <span class="comment"></span>
03896 <span class="comment">    AccessMode - Supplies the access mode to be used in the check</span>
03897 <span class="comment"></span>
03898 <span class="comment"></span>
03899 <span class="comment">Return Value:</span>
03900 <span class="comment"></span>
03901 <span class="comment">    TRUE - WORLD has Traverse access to this container.  FALSE</span>
03902 <span class="comment">    otherwise.</span>
03903 <span class="comment"></span>
03904 <span class="comment">--*/</span>
03905 
03906 {
03907     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
03908     ULONG i;
03909     PVOID Ace;
03910     ULONG AceCount;
03911 
03912     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03913 
03914     <span class="keywordflow">if</span> ( AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> ) {
03915         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03916     }
03917 
03918     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03919         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03920     }
03921 
03922     <span class="comment">//</span>
03923     <span class="comment">// See if there is a valid DACL in the passed Security Descriptor.</span>
03924     <span class="comment">// No DACL, no security, all is granted.</span>
03925     <span class="comment">//</span>
03926 
03927     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( (PISECURITY_DESCRIPTOR)SecurityDescriptor );
03928 
03929     <span class="comment">//</span>
03930     <span class="comment">//  If the SE_DACL_PRESENT bit is not set, the object has no</span>
03931     <span class="comment">//  security, so all accesses are granted.</span>
03932     <span class="comment">//</span>
03933     <span class="comment">//  Also grant all access if the Dacl is NULL.</span>
03934     <span class="comment">//</span>
03935 
03936     <span class="keywordflow">if</span> ( !RtlpAreControlBitsSet(
03937             (PISECURITY_DESCRIPTOR)SecurityDescriptor, SE_DACL_PRESENT
03938             )
03939          || (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
03940 
03941         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03942     }
03943 
03944     <span class="comment">//</span>
03945     <span class="comment">// There is security on this object.  If the DACL is empty,</span>
03946     <span class="comment">// deny all access immediately</span>
03947     <span class="comment">//</span>
03948 
03949     <span class="keywordflow">if</span> ((AceCount = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AceCount) == 0) {
03950 
03951         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03952     }
03953 
03954     <span class="comment">//</span>
03955     <span class="comment">// There's stuff in the DACL, walk down the list and see</span>
03956     <span class="comment">// if WORLD has been granted TraverseAccess</span>
03957     <span class="comment">//</span>
03958 
03959     <span class="keywordflow">for</span> ( i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> ) ;
03960           i &lt; AceCount  ;
03961           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )
03962         ) {
03963 
03964         <span class="keywordflow">if</span> ( !(((PACE_HEADER)Ace)-&gt;AceFlags &amp; INHERIT_ONLY_ACE)) {
03965 
03966             <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_ALLOWED_ACE_TYPE) ) {
03967 
03968                 <span class="keywordflow">if</span> ( (TraverseAccess &amp; ((PACCESS_ALLOWED_ACE)Ace)-&gt;Mask) ) {
03969 
03970                     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>, &amp;((PACCESS_ALLOWED_ACE)Ace)-&gt;SidStart ) ) {
03971 
03972                         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
03973                     }
03974                 }
03975 
03976             } <span class="keywordflow">else</span> {
03977 
03978                 <span class="keywordflow">if</span> ( (((PACE_HEADER)Ace)-&gt;AceType == ACCESS_DENIED_ACE_TYPE) ) {
03979 
03980                     <span class="keywordflow">if</span> ( (TraverseAccess &amp; ((PACCESS_DENIED_ACE)Ace)-&gt;Mask) ) {
03981 
03982                         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( <a class="code" href="../../d0/d5/se_8h.html#a42">SeWorldSid</a>, &amp;((PACCESS_DENIED_ACE)Ace)-&gt;SidStart ) ) {
03983 
03984                             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03985                         }
03986                     }
03987                 }
03988             }
03989         }
03990     }
03991 
03992     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
03993 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
