<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lfsprocs.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lfsprocs.h</h1><a href="../../d0/d4/lfsprocs_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++ BUILD Version: 0000    // Increment this if a change has global effects</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    LfsProcs.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module defines all of the globally used procedures in the Log</span>
00012 <span class="comment">    File Service.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#ifndef _LFSPROCS_</span>
00023 <span class="preprocessor"></span><span class="preprocessor">#define _LFSPROCS_</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00026 <span class="preprocessor">#include &lt;string.h&gt;</span>
00027 <span class="preprocessor">#include &lt;zwapi.h&gt;</span>
00028 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d3/lfs_8h.html">lfs.h</a>&gt;</span>
00029 <span class="preprocessor">#include &lt;<a class="code" href="../../d1/d8/fsrtl_8h.html">fsrtl.h</a>&gt;</span>
00030 
00031 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/lfs_2nodetype_8h.html">nodetype.h</a>"</span>
00032 <span class="preprocessor">#include "LfsDisk.h"</span>
00033 <span class="preprocessor">#include "LfsStruc.h"</span>
00034 <span class="preprocessor">#include "LfsData.h"</span>
00035 
00036 <span class="comment">//</span>
00037 <span class="comment">//  Tag all of our allocations if tagging is turned on</span>
00038 <span class="comment">//</span>
00039 
00040 <span class="preprocessor">#undef FsRtlAllocatePool</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#undef FsRtlAllocatePoolWithQuota</span>
00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a0">00043</a> <span class="preprocessor">#define FsRtlAllocatePool(a,b) FsRtlAllocatePoolWithTag(a,b,' sfL')</span>
<a name="l00044"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a1">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define FsRtlAllocatePoolWithQuota(a,b) FsRtlAllocatePoolWithQuotaTag(a,b,' sfL')</span>
00045 <span class="preprocessor"></span>
<a name="l00046"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a2">00046</a> <span class="preprocessor">#define LfsAllocatePoolNoRaise(a,b)         ExAllocatePoolWithTag((a),(b),MODULE_POOL_TAG)</span>
<a name="l00047"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a3">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define LfsAllocatePool(a,b)                ExAllocatePoolWithTag(((a) | POOL_RAISE_IF_ALLOCATION_FAILURE),(b),MODULE_POOL_TAG)</span>
<a name="l00048"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a4">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define LfsFreePool(pv)                     ExFreePool(pv)</span>
00049 <span class="preprocessor"></span>
00050 
00051 <span class="comment">//</span>
00052 <span class="comment">//  The following routines provide an interface with the cache package.</span>
00053 <span class="comment">//  They are contained in 'CacheSup.c'.</span>
00054 <span class="comment">//</span>
00055 
00056 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00057 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a48">LfsPinOrMapData</a> (
00058     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00059     IN LONGLONG FileOffset,
00060     IN ULONG Length,
00061     IN BOOLEAN PinData,
00062     IN BOOLEAN AllowErrors,
00063     IN BOOLEAN IgnoreUsaErrors,
00064     OUT PBOOLEAN UsaError,
00065     OUT PVOID *Buffer,
00066     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb
00067     );
00068 
00069 <span class="comment">//</span>
00070 <span class="comment">//  VOID</span>
00071 <span class="comment">//  LfsPreparePinWriteData (</span>
00072 <span class="comment">//      IN PLFCB Lfcb,</span>
00073 <span class="comment">//      IN LONGLONG FileOffset,</span>
00074 <span class="comment">//      IN ULONG Length,</span>
00075 <span class="comment">//      OUT PVOID *Buffer,</span>
00076 <span class="comment">//      OUT PBCB *Bcb</span>
00077 <span class="comment">//      );</span>
00078 <span class="comment">//</span>
00079 
<a name="l00080"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a5">00080</a> <span class="preprocessor">#define LfsPreparePinWriteData(L,FO,LEN,BUF,B) {    \</span>
00081 <span class="preprocessor">    LONGLONG _LocalFileOffset = (FO);          \</span>
00082 <span class="preprocessor">    CcPreparePinWrite( (L)-&gt;FileObject,             \</span>
00083 <span class="preprocessor">                       (PLARGE_INTEGER)&amp;_LocalFileOffset,           \</span>
00084 <span class="preprocessor">                       (LEN),                       \</span>
00085 <span class="preprocessor">                       FALSE,                       \</span>
00086 <span class="preprocessor">                       TRUE,                        \</span>
00087 <span class="preprocessor">                       (B),                         \</span>
00088 <span class="preprocessor">                       (BUF) );                     \</span>
00089 <span class="preprocessor">}</span>
00090 <span class="preprocessor"></span>
00091 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00092 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a> (
00093     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00094     IN LSN Lsn,
00095     IN BOOLEAN PinData,
00096     IN BOOLEAN IgnoreUsaErrors,
00097     OUT PBOOLEAN UsaError,
00098     OUT <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> *RecordHeader,
00099     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *Bcb
00100     );
00101 
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00103 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a> (
00104     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00105     IN <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader,
00106     OUT PVOID Buffer
00107     );
00108 
00109 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00110 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a51">LfsFlushLfcb</a> (
00111     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00112     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00113     );
00114 
00115 BOOLEAN
00116 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a52">LfsReadRestart</a> (
00117     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00118     IN LONGLONG FileSize,
00119     IN BOOLEAN FirstRestart,
00120     OUT PLONGLONG RestartPageOffset,
00121     OUT <a class="code" href="../../d3/d1/struct__LFS__RESTART__PAGE__HEADER.html">PLFS_RESTART_PAGE_HEADER</a> *RestartPage,
00122     OUT <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> *RestartPageBcb,
00123     OUT PBOOLEAN ChkdskWasRun,
00124     OUT PBOOLEAN ValidPage,
00125     OUT PBOOLEAN UninitializedFile,
00126     OUT PBOOLEAN LogPacked,
00127     OUT PLSN LastLsn
00128     );
00129 
00130 
00131 <span class="comment">//</span>
00132 <span class="comment">//  The following routines manipulate buffer control blocks.  They are</span>
00133 <span class="comment">//  contained in 'LbcbSup.c'</span>
00134 <span class="comment">//</span>
00135 
00136 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00137 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a53">LfsFlushLbcb</a> (
00138     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00139     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00140     );
00141 
00142 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00143 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a54">LfsFlushToLsnPriv</a> (
00144     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00145     IN LSN Lsn
00146     );
00147 
00148 <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>
00149 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a55">LfsGetLbcb</a> (
00150     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb
00151     );
00152 
00153 
00154 <span class="comment">//</span>
00155 <span class="comment">//  The following routines are in LfsData.c</span>
00156 <span class="comment">//</span>
00157 
00158 LONG
00159 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a> (
00160     IN PEXCEPTION_POINTERS ExceptionPointer
00161     );
00162 
00163 
00164 <span class="comment">//</span>
00165 <span class="comment">//  Log page support routines.  The following routines manipulate and</span>
00166 <span class="comment">//  modify log pages.  They are contained in 'LogPgSup.c'</span>
00167 <span class="comment">//</span>
00168 
00169 <span class="comment">//</span>
00170 <span class="comment">//  VOID</span>
00171 <span class="comment">//  LfsTruncateOffsetToLogPage (</span>
00172 <span class="comment">//      IN PLFCB Lfcb,</span>
00173 <span class="comment">//      IN LONGLONG LargeInt,</span>
00174 <span class="comment">//      OUT PLONGLONG Result</span>
00175 <span class="comment">//      );</span>
00176 <span class="comment">//</span>
00177 <span class="comment">//  ULONG</span>
00178 <span class="comment">//  LfsLogPageOffset (</span>
00179 <span class="comment">//      IN PLFCB Lfcb,</span>
00180 <span class="comment">//      IN ULONG Integer</span>
00181 <span class="comment">//      );</span>
00182 <span class="comment">//</span>
00183 
<a name="l00184"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a6">00184</a> <span class="preprocessor">#define LfsTruncateOffsetToLogPage(LFCB,LI,OUTLI)       \</span>
00185 <span class="preprocessor">    *(OUTLI) = LI;                                      \</span>
00186 <span class="preprocessor">    *((PULONG)(OUTLI)) &amp;= (LFCB)-&gt;SystemPageInverseMask</span>
00187 <span class="preprocessor"></span>
<a name="l00188"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a7">00188</a> <span class="preprocessor">#define LfsLogPageOffset(LFCB,INT)                      \</span>
00189 <span class="preprocessor">    (INT &amp; (LFCB)-&gt;LogPageMask)</span>
00190 <span class="preprocessor"></span>
00191 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00192 <a class="code" href="../../d6/d5/logpgsup_8c.html#a2">LfsNextLogPageOffset</a> (
00193     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00194     IN LONGLONG CurrentLogPageOffset,
00195     OUT PLONGLONG NextLogPageOffset,
00196     OUT PBOOLEAN Wrapped
00197     );
00198 
00199 PVOID
00200 <a class="code" href="../../d6/d5/logpgsup_8c.html#a3">LfsAllocateSpanningBuffer</a> (
00201     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00202     IN ULONG Length
00203     );
00204 
00205 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00206 <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a> (
00207     IN PVOID Buffer
00208     );
00209 
00210 
00211 <span class="comment">//</span>
00212 <span class="comment">//  The following routines provide support for dealing with log records.  They</span>
00213 <span class="comment">//  are contained in 'LogRcSup.c'</span>
00214 <span class="comment">//</span>
00215 
00216 BOOLEAN
00217 <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a> (
00218     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00219     IN <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch,
00220     IN ULONG NumberOfWriteEntries,
00221     IN <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">PLFS_WRITE_ENTRY</a> WriteEntries,
00222     IN LFS_RECORD_TYPE RecordType,
00223     IN TRANSACTION_ID *TransactionId OPTIONAL,
00224     IN LSN ClientUndoNextLsn OPTIONAL,
00225     IN LSN ClientPreviousLsn OPTIONAL,
00226     IN LONG UndoRequirement,
00227     IN BOOLEAN ForceToDisk,
00228     OUT PLSN Lsn
00229     );
00230 
00231 
00232 <span class="comment">//</span>
00233 <span class="comment">//  Lsn support routines.  The following routines provide support for</span>
00234 <span class="comment">//  manipulating Lsn values.  They are contained in 'LsnSup.c'</span>
00235 <span class="comment">//</span>
00236 
00237 <span class="comment">//</span>
00238 <span class="comment">//  LSN</span>
00239 <span class="comment">//  LfsFileOffsetToLsn (</span>
00240 <span class="comment">//      IN PLFCB Lfcb,</span>
00241 <span class="comment">//      IN LONGLONG FileOffset,</span>
00242 <span class="comment">//      IN LONGLONG SequenceNumber</span>
00243 <span class="comment">//      );</span>
00244 <span class="comment">//</span>
00245 <span class="comment">//  BOOLEAN</span>
00246 <span class="comment">//  LfsIsLsnInFile (</span>
00247 <span class="comment">//      IN PLFCB Lfcb,</span>
00248 <span class="comment">//      IN LSN Lsn</span>
00249 <span class="comment">//      );</span>
00250 <span class="comment">//</span>
00251 <span class="comment">//  LSN</span>
00252 <span class="comment">//  LfsComputeLsnFromLbcb (</span>
00253 <span class="comment">//      IN PLFCB Lfcb,</span>
00254 <span class="comment">//      IN PLBCB Lbcb</span>
00255 <span class="comment">//      );</span>
00256 <span class="comment">//</span>
00257 <span class="comment">//  VOID</span>
00258 <span class="comment">//  LfsTruncateLsnToLogPage (</span>
00259 <span class="comment">//      IN PLFCB Lfcb,</span>
00260 <span class="comment">//      IN LSN Lsn,</span>
00261 <span class="comment">//      OUT PLONGLONG FileOffset</span>
00262 <span class="comment">//      );</span>
00263 <span class="comment">//</span>
00264 <span class="comment">//  LONGLONG</span>
00265 <span class="comment">//  LfsLsnToFileOffset (</span>
00266 <span class="comment">//      IN PLFCB Lfcb,</span>
00267 <span class="comment">//      IN LSN Lsn</span>
00268 <span class="comment">//      );</span>
00269 <span class="comment">//</span>
00270 <span class="comment">//  LONGLONG</span>
00271 <span class="comment">//  LfsLsnToSeqNumber (</span>
00272 <span class="comment">//      IN PLFCB Lfcb,</span>
00273 <span class="comment">//      IN LSN Lsn</span>
00274 <span class="comment">//      );</span>
00275 <span class="comment">//</span>
00276 <span class="comment">//  ULONG</span>
00277 <span class="comment">//  LfsLsnToPageOffset (</span>
00278 <span class="comment">//      IN PLFCB Lfcb,</span>
00279 <span class="comment">//      IN LSN Lsn</span>
00280 <span class="comment">//      );</span>
00281 <span class="comment">//</span>
00282 
<a name="l00283"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a8">00283</a> <span class="preprocessor">#define LfsFileOffsetToLsn(LFCB,FO,SN) (                                        \</span>
00284 <span class="preprocessor">    (((ULONGLONG)(FO)) &gt;&gt; 3) + Int64ShllMod32((SN), (LFCB)-&gt;FileDataBits)                                \</span>
00285 <span class="preprocessor">)</span>
00286 <span class="preprocessor"></span>
<a name="l00287"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a9">00287</a> <span class="preprocessor">#define LfsIsLsnInFile(LFCB,LSN)                                                \</span>
00288 <span class="preprocessor">    (</span><span class="comment">/*xxGeq*/</span>( (LSN).QuadPart &gt;= ((LFCB)-&gt;OldestLsn).QuadPart )                                          \
00289      &amp;&amp; <span class="comment">/*xxLeq*/</span>( (LSN).QuadPart &lt;= ((LFCB)-&gt;RestartArea-&gt;CurrentLsn).QuadPart ))
00290 
<a name="l00291"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a10">00291</a> <span class="preprocessor">#define LfsComputeLsnFromLbcb(LFCB,LBCB) (                                              \</span>
00292 <span class="preprocessor">    LfsFileOffsetToLsn( LFCB,                                                           \</span>
00293 <span class="preprocessor">                        (LBCB)-&gt;FileOffset + (LBCB)-&gt;BufferOffset,    \</span>
00294 <span class="preprocessor">                        (LBCB)-&gt;SeqNumber )                                    \</span>
00295 <span class="preprocessor">)</span>
00296 <span class="preprocessor"></span>
<a name="l00297"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a11">00297</a> <span class="preprocessor">#define LfsTruncateLsnToLogPage(LFCB,LSN,FO) {                                  \</span>
00298 <span class="preprocessor">    *(FO) = LfsLsnToFileOffset( LFCB, LSN );                                    \</span>
00299 <span class="preprocessor">    *((PULONG)(FO)) &amp;= (LFCB)-&gt;LogPageInverseMask;                                \</span>
00300 <span class="preprocessor">}</span>
00301 <span class="preprocessor"></span>
<a name="l00302"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">00302</a> <span class="preprocessor">#define LfsLsnToFileOffset(LFCB,LSN)                                            \</span>
00303 <span class="preprocessor">    </span><span class="comment">/*xxShr*/</span>( ((ULONGLONG)<span class="comment">/*xxShl*/</span>( (LSN).QuadPart &lt;&lt; (LFCB)-&gt;SeqNumberBits )) &gt;&gt; ((LFCB)-&gt;SeqNumberBits - 3) )
00304 
<a name="l00305"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a13">00305</a> <span class="preprocessor">#define LfsLsnToSeqNumber(LFCB,LSN)                                             \</span>
00306 <span class="preprocessor">    </span><span class="comment">/*xxShr*/</span>Int64ShrlMod32( ((ULONGLONG)(LSN).QuadPart), (LFCB)-&gt;FileDataBits )
00307 
<a name="l00308"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a14">00308</a> <span class="preprocessor">#define LfsLsnToPageOffset(LFCB,LSN)                                            \</span>
00309 <span class="preprocessor">    LfsLogPageOffset( LFCB, (LSN).LowPart &lt;&lt; 3 )</span>
00310 <span class="preprocessor"></span>
00311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00312 <a class="code" href="../../d9/d7/lsnsup_8c.html#a1">LfsLsnFinalOffset</a> (
00313     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00314     IN LSN Lsn,
00315     IN ULONG DataLength,
00316     OUT PLONGLONG FinalOffset
00317     );
00318 
00319 BOOLEAN
00320 <a class="code" href="../../d9/d7/lsnsup_8c.html#a2">LfsFindNextLsn</a> (
00321     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00322     IN <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader,
00323     OUT PLSN Lsn
00324     );
00325 
00326 
00327 <span class="comment">//</span>
00328 <span class="comment">//  The following routines support the Lfs restart areas.  They are contained</span>
00329 <span class="comment">//  in 'RstrtSup.c'</span>
00330 <span class="comment">//</span>
00331 
00332 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00333 <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a> (
00334     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00335     IN ULONG ThisRestartSize,
00336     IN BOOLEAN WaitForIo
00337     );
00338 
00339 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00340 <a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a> (
00341     IN <a class="code" href="../../d2/d1/struct__LFS__RESTART__AREA.html">PLFS_RESTART_AREA</a> RestartArea,
00342     IN <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientArray,
00343     OUT PLSN OldestLsn
00344     );
00345 
00346 
00347 <span class="comment">//</span>
00348 <span class="comment">//  The following routines are used for managing the structures allocated</span>
00349 <span class="comment">//  by us.  They are contained in 'StrucSup.c'</span>
00350 <span class="comment">//</span>
00351 
00352 <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a>
00353 <a class="code" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a> (
00354     );
00355 
00356 
00357 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00358 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a> (
00359     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00360     IN BOOLEAN CompleteTeardown
00361     );
00362 
00363 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00364 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a> (
00365     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00366     OUT <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *Lbcb
00367     );
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00370 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a> (
00371     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00372     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00373     );
00374 
00375 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00376 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a5">LfsAllocateLcb</a> (
00377     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00378     OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> *NewLcb
00379     );
00380 
00381 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00382 <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a> (
00383     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00384     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb
00385     );
00386 
00387 <span class="comment">//</span>
00388 <span class="comment">//  VOID</span>
00389 <span class="comment">//  LfsInitializeLcb (</span>
00390 <span class="comment">//      IN PLCB Lcb,</span>
00391 <span class="comment">//      IN LFS_CLIENT_ID ClientId,</span>
00392 <span class="comment">//      IN LFS_CONTEXT_MODE ContextMode</span>
00393 <span class="comment">//      );</span>
00394 <span class="comment">//</span>
00395 <span class="comment">//</span>
00396 <span class="comment">//  VOID</span>
00397 <span class="comment">//  LfsAllocateLch (</span>
00398 <span class="comment">//      OUT PLCH *Lch</span>
00399 <span class="comment">//      );</span>
00400 <span class="comment">//</span>
00401 <span class="comment">//  VOID</span>
00402 <span class="comment">//  LfsDeallocateLch (</span>
00403 <span class="comment">//      IN PLCH Lch</span>
00404 <span class="comment">//      );</span>
00405 <span class="comment">//</span>
00406 <span class="comment">//  VOID</span>
00407 <span class="comment">//  LfsAllocateRestartArea (</span>
00408 <span class="comment">//      OUT PLFS_RESTART_AREA *RestartArea,</span>
00409 <span class="comment">//      ULONG Size</span>
00410 <span class="comment">//      );</span>
00411 <span class="comment">//</span>
00412 <span class="comment">//  VOID</span>
00413 <span class="comment">//  LfsDeallocateRestartArea (</span>
00414 <span class="comment">//      IN PLFS_RESTART_AREA RestartArea</span>
00415 <span class="comment">//      );</span>
00416 <span class="comment">//</span>
00417 <span class="comment">//  BOOLEAN</span>
00418 <span class="comment">//  LfsLbcbIsRestart (</span>
00419 <span class="comment">//      IN PLBCB Lbcb</span>
00420 <span class="comment">//      );</span>
00421 <span class="comment">//</span>
00422 
<a name="l00423"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a15">00423</a> <span class="preprocessor">#define LfsInitializeLcb(LCB,ID,MODE)                           \</span>
00424 <span class="preprocessor">    (LCB)-&gt;ClientId = ID;                                       \</span>
00425 <span class="preprocessor">    (LCB)-&gt;ContextMode = MODE</span>
00426 <span class="preprocessor"></span>
00427 
<a name="l00428"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a16">00428</a> <span class="preprocessor">#define LfsAllocateLch(NEW)     {                               \</span>
00429 <span class="preprocessor">    *(NEW) = FsRtlAllocatePool( PagedPool, sizeof( LCH ));      \</span>
00430 <span class="preprocessor">    RtlZeroMemory( (*NEW), sizeof( LCH ));                      \</span>
00431 <span class="preprocessor">    (*(NEW))-&gt;NodeTypeCode = LFS_NTC_LCH;                       \</span>
00432 <span class="preprocessor">    (*(NEW))-&gt;NodeByteSize = sizeof( LCH );                     \</span>
00433 <span class="preprocessor">}</span>
00434 <span class="preprocessor"></span>
<a name="l00435"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a17">00435</a> <span class="preprocessor">#define LfsDeallocateLch(LCH)                                   \</span>
00436 <span class="preprocessor">    ExFreePool( LCH )</span>
00437 <span class="preprocessor"></span>
<a name="l00438"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a18">00438</a> <span class="preprocessor">#define LfsAllocateRestartArea(RS,SIZE)                         \</span>
00439 <span class="preprocessor">    *(RS) = FsRtlAllocatePool( PagedPool, (SIZE) );             \</span>
00440 <span class="preprocessor">    RtlZeroMemory( *(RS), (SIZE) )</span>
00441 <span class="preprocessor"></span>
<a name="l00442"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">00442</a> <span class="preprocessor">#define LfsDeallocateRestartArea(RS)                            \</span>
00443 <span class="preprocessor">    ExFreePool( RS )</span>
00444 <span class="preprocessor"></span>
<a name="l00445"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a20">00445</a> <span class="preprocessor">#define LfsLbcbIsRestart(LBCB)                                  \</span>
00446 <span class="preprocessor">    (FlagOn( (LBCB)-&gt;LbcbFlags, LBCB_RESTART_LBCB ))</span>
00447 <span class="preprocessor"></span>
00448 
00449 <span class="comment">//</span>
00450 <span class="comment">//  The following routines provide synchronization support for the Lfs</span>
00451 <span class="comment">//  shared structures.  They are contained in 'SyncSup.c'</span>
00452 <span class="comment">//</span>
00453 
00454 <span class="comment">//</span>
00455 <span class="comment">//  VOID</span>
00456 <span class="comment">//  LfsAcquireLfsData (</span>
00457 <span class="comment">//      );</span>
00458 <span class="comment">//</span>
00459 <span class="comment">//  VOID</span>
00460 <span class="comment">//  LfsReleaseLfsData (</span>
00461 <span class="comment">//      );</span>
00462 <span class="comment">//</span>
00463 <span class="comment">//  VOID</span>
00464 <span class="comment">//  LfsAcquireLfcb (</span>
00465 <span class="comment">//      IN PLFCB Lfcb</span>
00466 <span class="comment">//      );</span>
00467 <span class="comment">//</span>
00468 <span class="comment">//  VOID</span>
00469 <span class="comment">//  LfsReleaseLfcb (</span>
00470 <span class="comment">//      IN PLFCB Lfcb</span>
00471 <span class="comment">//      );</span>
00472 <span class="comment">//</span>
00473 <span class="comment">//  VOID</span>
00474 <span class="comment">//  LfsAcquireLch (</span>
00475 <span class="comment">//      IN PLCH Lch</span>
00476 <span class="comment">//      );</span>
00477 <span class="comment">//</span>
00478 <span class="comment">//  VOID</span>
00479 <span class="comment">//  LfsReleaseLfcb (</span>
00480 <span class="comment">//      IN PLCH Lch</span>
00481 <span class="comment">//      );</span>
00482 <span class="comment">//</span>
00483 
<a name="l00484"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a21">00484</a> <span class="preprocessor">#define LfsAcquireLfsData()                                 \</span>
00485 <span class="preprocessor">    ExAcquireFastMutex( &amp;LfsData.LfsDataLock )</span>
00486 <span class="preprocessor"></span>
<a name="l00487"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a22">00487</a> <span class="preprocessor">#define LfsReleaseLfsData()                                 \</span>
00488 <span class="preprocessor">    ExReleaseFastMutex( &amp;LfsData.LfsDataLock )</span>
00489 <span class="preprocessor"></span>
<a name="l00490"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a23">00490</a> <span class="preprocessor">#define LfsAcquireBufferLock()                              \</span>
00491 <span class="preprocessor">    ExAcquireFastMutex( &amp;LfsData.BufferLock )</span>
00492 <span class="preprocessor"></span>
<a name="l00493"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a24">00493</a> <span class="preprocessor">#define LfsReleaseBufferLock()                              \</span>
00494 <span class="preprocessor">    ExReleaseFastMutex( &amp;LfsData.BufferLock )</span>
00495 <span class="preprocessor"></span>
<a name="l00496"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a25">00496</a> <span class="preprocessor">#define LfsWaitForBufferNotification()                      \</span>
00497 <span class="preprocessor">    KeWaitForSingleObject( &amp;LfsData.BufferNotification,     \</span>
00498 <span class="preprocessor">                           Executive,                       \</span>
00499 <span class="preprocessor">                           KernelMode,                      \</span>
00500 <span class="preprocessor">                           FALSE,                           \</span>
00501 <span class="preprocessor">                           NULL )                          </span>
00502 <span class="preprocessor"></span>
<a name="l00503"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a26">00503</a> <span class="preprocessor">#define LfsNotifyBufferWaiters()                            \</span>
00504 <span class="preprocessor">    KeSetEvent( &amp;LfsData.BufferNotification, 0, FALSE )</span>
00505 <span class="preprocessor"></span>
<a name="l00506"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a27">00506</a> <span class="preprocessor">#define LfsBlockBufferWaiters()                             \</span>
00507 <span class="preprocessor">    KeClearEvent( &amp;LfsData.BufferNotification )</span>
00508 <span class="preprocessor"></span>
<a name="l00509"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a28">00509</a> <span class="preprocessor">#define LfsAcquireLfcb(LFCB)                                                            \</span>
00510 <span class="preprocessor">    ExAcquireResourceExclusive( &amp;(LFCB)-&gt;Sync-&gt;Resource, TRUE )</span>
00511 <span class="preprocessor"></span>
<a name="l00512"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">00512</a> <span class="preprocessor">#define LfsReleaseLfcb(LFCB)                                                            \</span>
00513 <span class="preprocessor">    if ((LFCB)-&gt;Sync-&gt;Resource.OwnerThreads[0].OwnerThread == ExGetCurrentResourceThread()) {\</span>
00514 <span class="preprocessor">        ExReleaseResource( &amp;(LFCB)-&gt;Sync-&gt;Resource );                                   \</span>
00515 <span class="preprocessor">    }</span>
00516 <span class="preprocessor"></span>
<a name="l00517"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">00517</a> <span class="preprocessor">#define LfsAcquireLch(LCH)                                                              \</span>
00518 <span class="preprocessor">    ExAcquireResourceExclusive( &amp;(LCH)-&gt;Sync-&gt;Resource, TRUE )</span>
00519 <span class="preprocessor"></span>
<a name="l00520"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">00520</a> <span class="preprocessor">#define LfsReleaseLch(LCH)                                                              \</span>
00521 <span class="preprocessor">    if ((LCH)-&gt;Sync-&gt;Resource.OwnerThreads[0].OwnerThread == ExGetCurrentResourceThread()) { \</span>
00522 <span class="preprocessor">        ExReleaseResource( &amp;(LCH)-&gt;Sync-&gt;Resource );                                    \</span>
00523 <span class="preprocessor">    }</span>
00524 <span class="preprocessor"></span>
00525 
00526 <span class="comment">//</span>
00527 <span class="comment">//  The following routines are used to check various structures for validity</span>
00528 <span class="comment">//  and comparability.  They are contained in 'VerfySup.c'.</span>
00529 <span class="comment">//</span>
00530 
00531 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00532 <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a0">LfsCurrentAvailSpace</a> (
00533     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00534     OUT PLONGLONG CurrentAvailSpace,
00535     OUT PULONG CurrentPageBytes
00536     );
00537 
00538 BOOLEAN
00539 <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a1">LfsVerifyLogSpaceAvail</a> (
00540     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00541     IN <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch,
00542     IN ULONG RemainingLogBytes,
00543     IN LONG UndoRequirement,
00544     IN BOOLEAN ForceToDisk
00545     );
00546 
00547 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00548 <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a> (
00549     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb
00550     );
00551 
00552 <span class="comment">//</span>
00553 <span class="comment">//  VOID</span>
00554 <span class="comment">//  LfsValidateLch (</span>
00555 <span class="comment">//      IN PLCH Lch</span>
00556 <span class="comment">//      );</span>
00557 <span class="comment">//</span>
00558 <span class="comment">//  VOID</span>
00559 <span class="comment">//  LfsValidateClientId (</span>
00560 <span class="comment">//      IN PLFCB Lfcb,</span>
00561 <span class="comment">//      IN PLCH Lch</span>
00562 <span class="comment">//      );</span>
00563 <span class="comment">//</span>
00564 <span class="comment">//  BOOLEAN</span>
00565 <span class="comment">//  LfsVerifyClientLsnInRange (</span>
00566 <span class="comment">//      IN PLFCB Lfcb,</span>
00567 <span class="comment">//      IN PLFS_CLIENT_RECORD ClientRecord,</span>
00568 <span class="comment">//      IN LSN Lsn</span>
00569 <span class="comment">//      );</span>
00570 <span class="comment">//</span>
00571 <span class="comment">//  BOOLEAN</span>
00572 <span class="comment">//  LfsClientIdMatch (</span>
00573 <span class="comment">//      IN PLFS_CLIENT_ID ClientA,</span>
00574 <span class="comment">//      IN PLFS_CLIENT_ID ClientB</span>
00575 <span class="comment">//      )</span>
00576 <span class="comment">//</span>
00577 <span class="comment">//  VOID</span>
00578 <span class="comment">//  LfsValidateLcb (</span>
00579 <span class="comment">//      IN PLFS_CONTEXT_BLOCK Lcb,</span>
00580 <span class="comment">//      IN PLCH Lch</span>
00581 <span class="comment">//      )</span>
00582 <span class="comment">//</span>
00583 
<a name="l00584"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">00584</a> <span class="preprocessor">#define LfsValidateLch(LCH)                                     \</span>
00585 <span class="preprocessor">    if ((LCH) == NULL                                           \</span>
00586 <span class="preprocessor">        || (LCH)-&gt;NodeTypeCode != LFS_NTC_LCH                   \</span>
00587 <span class="preprocessor">        || ((LCH)-&gt;Lfcb != NULL                                 \</span>
00588 <span class="preprocessor">            &amp;&amp; (LCH)-&gt;Lfcb-&gt;NodeTypeCode != LFS_NTC_LFCB)) {    \</span>
00589 <span class="preprocessor">                                                                \</span>
00590 <span class="preprocessor">        ExRaiseStatus( STATUS_ACCESS_DENIED );                  \</span>
00591 <span class="preprocessor">    }</span>
00592 <span class="preprocessor"></span>
<a name="l00593"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">00593</a> <span class="preprocessor">#define LfsValidateClientId(LFCB,LCH)                                   \</span>
00594 <span class="preprocessor">    if ((LCH)-&gt;ClientId.ClientIndex &gt;= (LFCB)-&gt;RestartArea-&gt;LogClients  \</span>
00595 <span class="preprocessor">        || (LCH)-&gt;ClientId.SeqNumber                                    \</span>
00596 <span class="preprocessor">           != Add2Ptr( Lfcb-&gt;ClientArray,                               \</span>
00597 <span class="preprocessor">                       (LCH)-&gt;ClientArrayByteOffset,                    \</span>
00598 <span class="preprocessor">                       PLFS_CLIENT_RECORD )-&gt;SeqNumber) {               \</span>
00599 <span class="preprocessor">        ExRaiseStatus( STATUS_ACCESS_DENIED );                          \</span>
00600 <span class="preprocessor">    }</span>
00601 <span class="preprocessor"></span>
<a name="l00602"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a34">00602</a> <span class="preprocessor">#define LfsVerifyClientLsnInRange(LFCB,CLIENT,LSN)                      \</span>
00603 <span class="preprocessor">    (</span><span class="comment">/*xxGeq*/</span>( (LSN).QuadPart &gt;= ((CLIENT)-&gt;OldestLsn).QuadPart )                                  \
00604      &amp;&amp; <span class="comment">/*xxLeq*/</span>( (LSN).QuadPart &lt;= ((LFCB)-&gt;RestartArea-&gt;CurrentLsn).QuadPart )                   \
00605      &amp;&amp; <span class="comment">/*xxNeqZero*/</span>( (LSN).QuadPart != 0 ))
00606 
<a name="l00607"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a35">00607</a> <span class="preprocessor">#define LfsClientIdMatch(CLIENT_A,CLIENT_B)                             \</span>
00608 <span class="preprocessor">    ((BOOLEAN) ((CLIENT_A)-&gt;SeqNumber == (CLIENT_B)-&gt;SeqNumber          \</span>
00609 <span class="preprocessor">                &amp;&amp; (CLIENT_A)-&gt;ClientIndex == (CLIENT_B)-&gt;ClientIndex))</span>
00610 <span class="preprocessor"></span>
<a name="l00611"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a36">00611</a> <span class="preprocessor">#define LfsValidateLcb(LCB,LCH)                                         \</span>
00612 <span class="preprocessor">    if (LCB == NULL                                                     \</span>
00613 <span class="preprocessor">        || (LCB)-&gt;NodeTypeCode != LFS_NTC_LCB                           \</span>
00614 <span class="preprocessor">        || !LfsClientIdMatch( &amp;(LCB)-&gt;ClientId, &amp;(LCH)-&gt;ClientId )) {   \</span>
00615 <span class="preprocessor">        ExRaiseStatus( STATUS_ACCESS_DENIED );                          \</span>
00616 <span class="preprocessor">    }</span>
00617 <span class="preprocessor"></span>
00618 
00619 <span class="comment">//</span>
00620 <span class="comment">//  Miscellaneous support routines</span>
00621 <span class="comment">//</span>
00622 
00623 <span class="comment">//</span>
00624 <span class="comment">//      ULONG</span>
00625 <span class="comment">//      FlagOn (</span>
00626 <span class="comment">//          IN ULONG Flags,</span>
00627 <span class="comment">//          IN ULONG SingleFlag</span>
00628 <span class="comment">//          );</span>
00629 <span class="comment">//</span>
00630 <span class="comment">//      BOOLEAN</span>
00631 <span class="comment">//      BooleanFlagOn (</span>
00632 <span class="comment">//          IN ULONG Flags,</span>
00633 <span class="comment">//          IN ULONG SingleFlag</span>
00634 <span class="comment">//          );</span>
00635 <span class="comment">//</span>
00636 <span class="comment">//      VOID</span>
00637 <span class="comment">//      SetFlag (</span>
00638 <span class="comment">//          IN ULONG Flags,</span>
00639 <span class="comment">//          IN ULONG SingleFlag</span>
00640 <span class="comment">//          );</span>
00641 <span class="comment">//</span>
00642 <span class="comment">//      VOID</span>
00643 <span class="comment">//      ClearFlag (</span>
00644 <span class="comment">//          IN ULONG Flags,</span>
00645 <span class="comment">//          IN ULONG SingleFlag</span>
00646 <span class="comment">//          );</span>
00647 <span class="comment">//</span>
00648 
00649 <span class="comment">//</span>
00650 <span class="comment">//  This macro returns TRUE if a flag in a set of flags is on and FALSE</span>
00651 <span class="comment">//  otherwise</span>
00652 <span class="comment">//</span>
00653 
<a name="l00654"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a37">00654</a> <span class="preprocessor">#define FlagOn(F,SF) ( \</span>
00655 <span class="preprocessor">    (((F) &amp; (SF)))     \</span>
00656 <span class="preprocessor">)</span>
00657 <span class="preprocessor"></span>
<a name="l00658"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a38">00658</a> <span class="preprocessor">#define BooleanFlagOn(F,SF) (    \</span>
00659 <span class="preprocessor">    (BOOLEAN)(((F) &amp; (SF)) != 0) \</span>
00660 <span class="preprocessor">)</span>
00661 <span class="preprocessor"></span>
<a name="l00662"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a39">00662</a> <span class="preprocessor">#define SetFlag(Flags,SingleFlag) { \</span>
00663 <span class="preprocessor">    (Flags) |= (SingleFlag);        \</span>
00664 <span class="preprocessor">}</span>
00665 <span class="preprocessor"></span>
<a name="l00666"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a40">00666</a> <span class="preprocessor">#define ClearFlag(Flags,SingleFlag) { \</span>
00667 <span class="preprocessor">    (Flags) &amp;= ~(SingleFlag);         \</span>
00668 <span class="preprocessor">}</span>
00669 <span class="preprocessor"></span>
00670 <span class="comment">//</span>
00671 <span class="comment">//  This macro takes a pointer (or ulong) and returns its rounded up word</span>
00672 <span class="comment">//  value</span>
00673 <span class="comment">//</span>
00674 
<a name="l00675"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a41">00675</a> <span class="preprocessor">#define WordAlign(Ptr) (                \</span>
00676 <span class="preprocessor">    ((((ULONG)(Ptr)) + 1) &amp; 0xfffffffe) \</span>
00677 <span class="preprocessor">    )</span>
00678 <span class="preprocessor"></span>
00679 <span class="comment">//</span>
00680 <span class="comment">//  This macro takes a pointer (or ulong) and returns its rounded up longword</span>
00681 <span class="comment">//  value</span>
00682 <span class="comment">//</span>
00683 
<a name="l00684"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a42">00684</a> <span class="preprocessor">#define LongAlign(Ptr) (                \</span>
00685 <span class="preprocessor">    ((((ULONG)(Ptr)) + 3) &amp; 0xfffffffc) \</span>
00686 <span class="preprocessor">    )</span>
00687 <span class="preprocessor"></span>
00688 <span class="comment">//</span>
00689 <span class="comment">//  This macro takes a pointer (or ulong) and returns its rounded up quadword</span>
00690 <span class="comment">//  value</span>
00691 <span class="comment">//</span>
00692 
<a name="l00693"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a43">00693</a> <span class="preprocessor">#define QuadAlign(Ptr) (                \</span>
00694 <span class="preprocessor">    ((((ULONG)(Ptr)) + 7) &amp; 0xfffffff8) \</span>
00695 <span class="preprocessor">    )</span>
00696 <span class="preprocessor"></span>
00697 <span class="comment">//</span>
00698 <span class="comment">//  This macro will up a 64 bit value to the next quad align boundary.</span>
00699 <span class="comment">//</span>
00700 
<a name="l00701"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a44">00701</a> <span class="preprocessor">#define LiQuadAlign(LI,OUT)   {         \</span>
00702 <span class="preprocessor">    *(OUT) = </span><span class="comment">/*xxAdd*/</span>( (LI) + 7 );       \
00703     *((PULONG)(OUT)) &amp;= 0xfffffff8;       \
00704 }
00705 
00706 <span class="comment">//</span>
00707 <span class="comment">//      CAST</span>
00708 <span class="comment">//      Add2Ptr (</span>
00709 <span class="comment">//          IN PVOID Pointer,</span>
00710 <span class="comment">//          IN ULONG Increment</span>
00711 <span class="comment">//          IN (CAST)</span>
00712 <span class="comment">//          );</span>
00713 <span class="comment">//</span>
00714 <span class="comment">//      ULONG</span>
00715 <span class="comment">//      PtrOffset (</span>
00716 <span class="comment">//          IN PVOID BasePtr,</span>
00717 <span class="comment">//          IN PVOID OffsetPtr</span>
00718 <span class="comment">//          );</span>
00719 <span class="comment">//</span>
00720 
<a name="l00721"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a45">00721</a> <span class="preprocessor">#define Add2Ptr(PTR,INC,CAST) ((CAST)((PUCHAR)(PTR) + (INC)))</span>
00722 <span class="preprocessor"></span>
<a name="l00723"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a46">00723</a> <span class="preprocessor">#define PtrOffset(BASE,OFFSET) ((ULONG)((ULONG_PTR)(OFFSET) - (ULONG_PTR)(BASE)))</span>
00724 <span class="preprocessor"></span>
00725 
00726 <span class="comment">//</span>
00727 <span class="comment">//  The following macros are used to establish the semantics needed</span>
00728 <span class="comment">//  to do a return from within a try-finally clause.  As a rule every</span>
00729 <span class="comment">//  try clause must end with a label call try_exit.  For example,</span>
00730 <span class="comment">//</span>
00731 <span class="comment">//      try {</span>
00732 <span class="comment">//              :</span>
00733 <span class="comment">//              :</span>
00734 <span class="comment">//</span>
00735 <span class="comment">//      try_exit: NOTHING;</span>
00736 <span class="comment">//      } finally {</span>
00737 <span class="comment">//</span>
00738 <span class="comment">//              :</span>
00739 <span class="comment">//              :</span>
00740 <span class="comment">//      }</span>
00741 <span class="comment">//</span>
00742 <span class="comment">//  Every return statement executed inside of a try clause should use the</span>
00743 <span class="comment">//  try_return macro.  If the compiler fully supports the try-finally construct</span>
00744 <span class="comment">//  then the macro should be</span>
00745 <span class="comment">//</span>
00746 <span class="comment">//      #define try_return(S)  { return(S); }</span>
00747 <span class="comment">//</span>
00748 <span class="comment">//  If the compiler does not support the try-finally construct then the macro</span>
00749 <span class="comment">//  should be</span>
00750 <span class="comment">//</span>
00751 <span class="comment">//      #define try_return(S)  { S; goto try_exit; }</span>
00752 <span class="comment">//</span>
00753 
<a name="l00754"></a><a class="code" href="../../d0/d4/lfsprocs_8h.html#a47">00754</a> <span class="preprocessor">#define try_return(S) { S; goto try_exit; }</span>
00755 <span class="preprocessor"></span>
00756 <span class="preprocessor">#endif // _LFSPROCS_</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
