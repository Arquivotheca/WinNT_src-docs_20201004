<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mrcf.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mrcf.c</h1><a href="../../d0/d4/mrcf_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    mrcf.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the Mrcf compression engine.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Gary Kimura     [GaryKi]    21-Jan-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00022 
00023 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00024 
00025 
00026 <span class="comment">//</span>
00027 <span class="comment">//  To decompress/compress a block of data the user needs to</span>
00028 <span class="comment">//  provide a work space as an extra parameter to all the exported</span>
00029 <span class="comment">//  procedures.  That way the routines will not need to use excessive</span>
00030 <span class="comment">//  stack space and will still be multithread safe</span>
00031 <span class="comment">//</span>
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">//  Variables for reading and writing bits</span>
00035 <span class="comment">//</span>
00036 
<a name="l00037"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">00037</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">_MRCF_BIT_IO</a> {
00038 
<a name="l00039"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">00039</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>;        <span class="comment">//  16-bit buffer being read</span>
<a name="l00040"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">00040</a>     LONG    <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>;        <span class="comment">//  Number of bits left in abitsBB</span>
00041 
<a name="l00042"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o2">00042</a>     PUCHAR  <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o2">pbBB</a>;           <span class="comment">//  Pointer to byte stream being read</span>
<a name="l00043"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">00043</a>     ULONG   <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">cbBB</a>;           <span class="comment">//  Number of bytes left in pbBB</span>
<a name="l00044"></a><a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o4">00044</a>     ULONG   <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o4">cbBBInitial</a>;    <span class="comment">//  Initial size of pbBB</span>
00045 
00046 } <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">MRCF_BIT_IO</a>;
<a name="l00047"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a5">00047</a> <span class="keyword">typedef</span> <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">MRCF_BIT_IO</a> *<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">PMRCF_BIT_IO</a>;
00048 
00049 <span class="comment">//</span>
00050 <span class="comment">//  Maximum back-pointer value, also used to indicate end of compressed stream!</span>
00051 <span class="comment">//</span>
00052 
<a name="l00053"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a0">00053</a> <span class="preprocessor">#define wBACKPOINTERMAX                  (4415)</span>
00054 <span class="preprocessor"></span>
00055 <span class="comment">//</span>
00056 <span class="comment">//  MDSIGNATURE - Signature at start of each compressed block</span>
00057 <span class="comment">//</span>
00058 <span class="comment">//      This 4-byte signature is used as a check to ensure that we</span>
00059 <span class="comment">//      are decompressing data we compressed, and also to indicate</span>
00060 <span class="comment">//      which compression method was used.</span>
00061 <span class="comment">//</span>
00062 <span class="comment">//      NOTE: A compressed block consists of one or more "chunks", separated</span>
00063 <span class="comment">//            by the bitsEND_OF_STREAM pattern.</span>
00064 <span class="comment">//</span>
00065 <span class="comment">//            Byte          Word</span>
00066 <span class="comment">//        -----------    ---------</span>
00067 <span class="comment">//         0  1  2  3      0    1      Meaning</span>
00068 <span class="comment">//        -- -- -- --    ---- ----     ----------------</span>
00069 <span class="comment">//        44 53 00 01    5344 0100     MaxCompression</span>
00070 <span class="comment">//        44 53 00 02    5344 0200     StandardCompression</span>
00071 <span class="comment">//</span>
00072 <span class="comment">//      NOTE: The *WORD* values are listed to be clear about the</span>
00073 <span class="comment">//            byte ordering!</span>
00074 <span class="comment">//</span>
00075 
<a name="l00076"></a><a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">00076</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">_MDSIGNATURE</a> {
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Must be MD_STAMP</span>
00080     <span class="comment">//</span>
00081 
<a name="l00082"></a><a class="code" href="../../d8/d7/struct__MDSIGNATURE.html#o0">00082</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d7/struct__MDSIGNATURE.html#o0">sigStamp</a>;
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">//  mdsSTANDARD or mdsMAX</span>
00086     <span class="comment">//</span>
00087 
<a name="l00088"></a><a class="code" href="../../d8/d7/struct__MDSIGNATURE.html#o1">00088</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d7/struct__MDSIGNATURE.html#o1">sigType</a>;
00089 
00090 } <a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">MDSIGNATURE</a>;
<a name="l00091"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a7">00091</a> <span class="keyword">typedef</span> <a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">MDSIGNATURE</a> *<a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">PMDSIGNATURE</a>;
00092 
<a name="l00093"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a1">00093</a> <span class="preprocessor">#define MD_STAMP        0x5344  // Signature stamp at start of compressed blk</span>
<a name="l00094"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a2">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define MASK_VALID_mds  0x0300  // All other bits must be zero</span>
00095 <span class="preprocessor"></span>
00096 
00097 <span class="comment">//</span>
00098 <span class="comment">//  Local procedure declarations and macros</span>
00099 <span class="comment">//</span>
00100 
<a name="l00101"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a3">00101</a> <span class="preprocessor">#define minimum(a,b) (a &lt; b ? a : b)</span>
00102 <span class="preprocessor"></span>
00103 <span class="comment">//</span>
00104 <span class="comment">//  Local procedure prototypes</span>
00105 <span class="comment">//</span>
00106 
00107 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00108 <a class="code" href="../../d0/d4/mrcf_8c.html#a8">MrcfSetBitBuffer</a> (
00109     PUCHAR pb,
00110     ULONG cb,
00111     PMRCF_BIT_IO BitIo
00112     );
00113 
00114 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00115 <a class="code" href="../../d0/d4/mrcf_8c.html#a9">MrcfFillBitBuffer</a> (
00116     PMRCF_BIT_IO BitIo
00117     );
00118 
00119 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
00120 <a class="code" href="../../d0/d4/mrcf_8c.html#a10">MrcfReadBit</a> (
00121     PMRCF_BIT_IO BitIo
00122     );
00123 
00124 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
00125 <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a> (
00126     LONG cbits,
00127     PMRCF_BIT_IO BitIo
00128     );
00129 
00130 
00131 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00132"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a12">00132</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a12">RtlDecompressBufferMrcf</a> (
00133     OUT PUCHAR UncompressedBuffer,
00134     IN ULONG UncompressedBufferSize,
00135     IN PUCHAR CompressedBuffer,
00136     IN ULONG CompressedBufferSize,
00137     OUT PULONG FinalUncompressedSize
00138     )
00139 
00140 <span class="comment">/*++</span>
00141 <span class="comment"></span>
00142 <span class="comment">Routine Description:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    This routine decompresses a buffer of StandardCompressed or MaxCompressed</span>
00145 <span class="comment">    data.</span>
00146 <span class="comment"></span>
00147 <span class="comment">Arguments:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    UncompressedBuffer - buffer to receive uncompressed data</span>
00150 <span class="comment"></span>
00151 <span class="comment">    UncompressedBufferSize - length of UncompressedBuffer</span>
00152 <span class="comment"></span>
00153 <span class="comment">          NOTE: UncompressedBufferSize must be the EXACT length of the uncompressed</span>
00154 <span class="comment">                data, as Decompress uses this information to detect</span>
00155 <span class="comment">                when decompression is complete.  If this value is</span>
00156 <span class="comment">                incorrect, Decompress may crash!</span>
00157 <span class="comment"></span>
00158 <span class="comment">    CompressedBuffer - buffer containing compressed data</span>
00159 <span class="comment"></span>
00160 <span class="comment">    CompressedBufferSize - length of CompressedBuffer</span>
00161 <span class="comment"></span>
00162 <span class="comment">    WorkSpace - pointer to a private work area for use by this operation</span>
00163 <span class="comment"></span>
00164 <span class="comment">Return Value:</span>
00165 <span class="comment"></span>
00166 <span class="comment">    ULONG - Returns the size of the decompressed data in bytes. Returns 0 if</span>
00167 <span class="comment">        there was an error in the decompress.</span>
00168 <span class="comment"></span>
00169 <span class="comment">--*/</span>
00170 
00171 {
00172     <a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html">MRCF_BIT_IO</a> WorkSpace;
00173 
00174     ULONG  cbMatch; <span class="comment">//  Length of match string</span>
00175     ULONG  i;       <span class="comment">//  Index in UncompressedBuffer to receive decoded data</span>
00176     ULONG  iMatch;  <span class="comment">//  Index in UncompressedBuffer of matched string</span>
00177     ULONG  k;       <span class="comment">//  Number of bits in length string</span>
00178     ULONG  off;     <span class="comment">//  Offset from i in UncompressedBuffer of match string</span>
00179     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> x;       <span class="comment">//  Current bit being examined</span>
00180     ULONG  y;
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">//  verify that compressed data starts with proper signature</span>
00184     <span class="comment">//</span>
00185 
00186     <span class="keywordflow">if</span> (CompressedBufferSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">MDSIGNATURE</a>) ||                            <span class="comment">// Must have signature</span>
00187         ((<a class="code" href="../../d0/d4/mrcf_8c.html#a7">PMDSIGNATURE</a>)CompressedBuffer)-&gt;sigStamp != <a class="code" href="../../d0/d4/mrcf_8c.html#a1">MD_STAMP</a> ||            <span class="comment">// Stamp must be OK</span>
00188         ((<a class="code" href="../../d0/d4/mrcf_8c.html#a7">PMDSIGNATURE</a>)CompressedBuffer)-&gt;sigType &amp; (~<a class="code" href="../../d0/d4/mrcf_8c.html#a2">MASK_VALID_mds</a>)) {     <span class="comment">// Type must be OK</span>
00189 
00190         *FinalUncompressedSize = 0;
00191         <span class="keywordflow">return</span> STATUS_BAD_COMPRESSION_BUFFER;
00192     }
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  Skip over the valid signature</span>
00196     <span class="comment">//</span>
00197 
00198     CompressedBufferSize -= <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">MDSIGNATURE</a>);
00199     CompressedBuffer += <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d7/struct__MDSIGNATURE.html">MDSIGNATURE</a>);
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">//  Set up for decompress, start filling UncompressedBuffer at front</span>
00203     <span class="comment">//</span>
00204 
00205     i = 0;
00206 
00207     <span class="comment">//</span>
00208     <span class="comment">//  Set statics to save parm passing</span>
00209     <span class="comment">//</span>
00210 
00211     <a class="code" href="../../d0/d4/mrcf_8c.html#a8">MrcfSetBitBuffer</a>(CompressedBuffer,CompressedBufferSize,&amp;WorkSpace);
00212 
00213     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00214 
00215         y = <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(2,&amp;WorkSpace);
00216 
00217         <span class="comment">//</span>
00218         <span class="comment">//  Check if next 7 bits are a byte</span>
00219         <span class="comment">//  1 if 128..255 (0x80..0xff), 2 if 0..127 (0x00..0x7f)</span>
00220         <span class="comment">//</span>
00221 
00222         <span class="keywordflow">if</span> (y == 1 || y == 2) {
00223 
00224             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Don't exceed expected length "</span>, i&lt;UncompressedBufferSize);
00225 
00226             UncompressedBuffer[i] = (UCHAR)((y == 1 ? 0x80 : 0) | <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(7,&amp;WorkSpace));
00227 
00228             i++;
00229 
00230         } <span class="keywordflow">else</span> {
00231 
00232             <span class="comment">//</span>
00233             <span class="comment">//  Have match sequence</span>
00234             <span class="comment">//</span>
00235 
00236             <span class="comment">//</span>
00237             <span class="comment">// Get the offset</span>
00238             <span class="comment">//</span>
00239 
00240             <span class="keywordflow">if</span> (y == 0) {
00241 
00242                 <span class="comment">//</span>
00243                 <span class="comment">//  next 6 bits are offset</span>
00244                 <span class="comment">//</span>
00245 
00246                 off = <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(6,&amp;WorkSpace);
00247 
00248                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"offset 0 is invalid "</span>, off != 0);
00249 
00250             } <span class="keywordflow">else</span> {
00251 
00252                 x = <a class="code" href="../../d0/d4/mrcf_8c.html#a10">MrcfReadBit</a>(&amp;WorkSpace);
00253 
00254                 <span class="keywordflow">if</span> (x == 0) {
00255 
00256                     <span class="comment">//</span>
00257                     <span class="comment">//  next 8 bits are offset-64 (0x40)</span>
00258                     <span class="comment">//</span>
00259 
00260                     off = <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(8, &amp;WorkSpace) + 64;
00261 
00262                 } <span class="keywordflow">else</span> {
00263 
00264                     <span class="comment">//</span>
00265                     <span class="comment">//  next 12 bits are offset-320 (0x140)</span>
00266                     <span class="comment">//</span>
00267 
00268                     off = <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(12, &amp;WorkSpace) + 320;
00269 
00270                     <span class="keywordflow">if</span> (off == <a class="code" href="../../d0/d4/mrcf_8c.html#a0">wBACKPOINTERMAX</a>) {
00271 
00272                         <span class="comment">//</span>
00273                         <span class="comment">//  EOS marker</span>
00274                         <span class="comment">//</span>
00275 
00276                         <span class="keywordflow">if</span> (i &gt;= UncompressedBufferSize) {
00277 
00278                             <span class="comment">//</span>
00279                             <span class="comment">// Done with entire buffer</span>
00280                             <span class="comment">//</span>
00281 
00282                             *FinalUncompressedSize = i;
00283                             <span class="keywordflow">return</span> STATUS_SUCCESS;
00284 
00285                         } <span class="keywordflow">else</span> {
00286 
00287                             <span class="comment">//</span>
00288                             <span class="comment">//  More to do</span>
00289                             <span class="comment">//  Done with a 512-byte chunk</span>
00290                             <span class="comment">//</span>
00291 
00292                             <span class="keywordflow">continue</span>;
00293                         }
00294                     }
00295                 }
00296             }
00297 
00298             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Don't exceed expected length "</span>, i&lt;UncompressedBufferSize);
00299             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Cannot match before start of uncoded buffer! "</span>, off &lt;= i);
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">//  Get the length  - logarithmically encoded</span>
00303             <span class="comment">//</span>
00304 
00305             <span class="keywordflow">for</span> (k=0; (x=<a class="code" href="../../d0/d4/mrcf_8c.html#a10">MrcfReadBit</a>(&amp;WorkSpace)) == 0; k++) { NOTHING; }
00306 
00307             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(k &lt;= 8);
00308 
00309             <span class="keywordflow">if</span> (k == 0) {
00310 
00311                 <span class="comment">//</span>
00312                 <span class="comment">//  All matches at least 2 chars long</span>
00313                 <span class="comment">//</span>
00314 
00315                 cbMatch = 2;
00316 
00317             } <span class="keywordflow">else</span> {
00318 
00319                 cbMatch = (1 &lt;&lt; k) + 1 + <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a>(k, &amp;WorkSpace);
00320             }
00321 
00322             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Don't exceed buffer size "</span>, (i - off + cbMatch - 1) &lt;= UncompressedBufferSize);
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">//  Copy the matched string</span>
00326             <span class="comment">//</span>
00327 
00328             iMatch = i - off;
00329 
00330             <span class="keywordflow">while</span> ( (cbMatch &gt; 0) &amp;&amp; (i&lt;UncompressedBufferSize) ) {
00331 
00332                 UncompressedBuffer[i++] = UncompressedBuffer[iMatch++];
00333                 cbMatch--;
00334             }
00335 
00336             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"Should have copied it all "</span>, cbMatch == 0);
00337         }
00338     }
00339 }
00340 
00341 
00342 <span class="comment">//</span>
00343 <span class="comment">//  Internal Support Routine</span>
00344 <span class="comment">//</span>
00345 
00346 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00347"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a8">00347</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a8">MrcfSetBitBuffer</a> (
00348     PUCHAR pb,
00349     ULONG cb,
00350     PMRCF_BIT_IO BitIo
00351     )
00352 
00353 <span class="comment">/*++</span>
00354 <span class="comment"></span>
00355 <span class="comment">Routine Description:</span>
00356 <span class="comment"></span>
00357 <span class="comment">    Set statics with coded buffer pointer and length</span>
00358 <span class="comment"></span>
00359 <span class="comment">Arguments:</span>
00360 <span class="comment"></span>
00361 <span class="comment">    pb - pointer to compressed data buffer</span>
00362 <span class="comment"></span>
00363 <span class="comment">    cb - length of compressed data buffer</span>
00364 <span class="comment"></span>
00365 <span class="comment">    BitIo - Supplies a pointer to the bit buffer statics</span>
00366 <span class="comment"></span>
00367 <span class="comment">Return Value:</span>
00368 <span class="comment"></span>
00369 <span class="comment">    None.</span>
00370 <span class="comment"></span>
00371 <span class="comment">--*/</span>
00372 
00373 {
00374     BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o2">pbBB</a>        = pb;
00375     BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">cbBB</a>        = cb;
00376     BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o4">cbBBInitial</a> = cb;
00377     BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>     = 0;
00378     BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>     = 0;
00379 }
00380 
00381 
00382 <span class="comment">//</span>
00383 <span class="comment">//  Internal Support Routine</span>
00384 <span class="comment">//</span>
00385 
00386 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l00387"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a10">00387</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a10">MrcfReadBit</a> (
00388     PMRCF_BIT_IO BitIo
00389     )
00390 
00391 <span class="comment">/*++</span>
00392 <span class="comment"></span>
00393 <span class="comment">Routine Description:</span>
00394 <span class="comment"></span>
00395 <span class="comment">    Get next bit from bit buffer</span>
00396 <span class="comment"></span>
00397 <span class="comment">Arguments:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    BitIo - Supplies a pointer to the bit buffer statics</span>
00400 <span class="comment"></span>
00401 <span class="comment">Return Value:</span>
00402 <span class="comment"></span>
00403 <span class="comment">    USHORT - Returns next bit (0 or 1)</span>
00404 <span class="comment"></span>
00405 <span class="comment">--*/</span>
00406 
00407 {
00408     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> bit;
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">//  Check if no bits available</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> ((BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>) == 0) {
00415 
00416         <a class="code" href="../../d0/d4/mrcf_8c.html#a9">MrcfFillBitBuffer</a>(BitIo);
00417     }
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">//  Decrement the bit count</span>
00421     <span class="comment">//  get the bit, remove it, and return the bit</span>
00422     <span class="comment">//</span>
00423 
00424     (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>)--;
00425     bit = (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>) &amp; 1;
00426     (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>) &gt;&gt;= 1;
00427 
00428     <span class="keywordflow">return</span> bit;
00429 }
00430 
00431 
00432 <span class="comment">//</span>
00433 <span class="comment">//  Internal Support Routine</span>
00434 <span class="comment">//</span>
00435 
00436 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>
<a name="l00437"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a11">00437</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a11">MrcfReadNBits</a> (
00438     LONG cbits,
00439     PMRCF_BIT_IO BitIo
00440     )
00441 
00442 <span class="comment">/*++</span>
00443 <span class="comment"></span>
00444 <span class="comment">Routine Description:</span>
00445 <span class="comment"></span>
00446 <span class="comment">    Get next N bits from bit buffer</span>
00447 <span class="comment"></span>
00448 <span class="comment">Arguments:</span>
00449 <span class="comment"></span>
00450 <span class="comment">    cbits - count of bits to get</span>
00451 <span class="comment"></span>
00452 <span class="comment">    BitIo - Supplies a pointer to the bit buffer statics</span>
00453 <span class="comment"></span>
00454 <span class="comment">Return Value:</span>
00455 <span class="comment"></span>
00456 <span class="comment">    USHORT - Returns next cbits bits.</span>
00457 <span class="comment"></span>
00458 <span class="comment">--*/</span>
00459 
00460 {
00461     ULONG abits;        <span class="comment">// Bits to return</span>
00462     LONG cbitsPart;    <span class="comment">// Partial count of bits</span>
00463     ULONG cshift;       <span class="comment">// Shift count</span>
00464     ULONG mask;         <span class="comment">// Mask</span>
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">//  Largest number of bits we should read at one time is 12 bits for</span>
00468     <span class="comment">//  a 12-bit offset.  The largest length field component that we</span>
00469     <span class="comment">//  read is 8 bits.  If this routine were used for some other purpose,</span>
00470     <span class="comment">//  it can support up to 15 (NOT 16) bit reads, due to how the masking</span>
00471     <span class="comment">//  code works.</span>
00472     <span class="comment">//</span>
00473 
00474     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cbits &lt;= 12);
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">//  No shift and no bits yet</span>
00478     <span class="comment">//</span>
00479 
00480     cshift = 0;
00481     abits = 0;
00482 
00483     <span class="keywordflow">while</span> (cbits &gt; 0) {
00484 
00485         <span class="comment">//</span>
00486         <span class="comment">//  If not bits available get some bits</span>
00487         <span class="comment">//</span>
00488 
00489         <span class="keywordflow">if</span> ((BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>) == 0) {
00490 
00491             <a class="code" href="../../d0/d4/mrcf_8c.html#a9">MrcfFillBitBuffer</a>(BitIo);
00492         }
00493 
00494         <span class="comment">//</span>
00495         <span class="comment">//  Number of bits we can read</span>
00496         <span class="comment">//</span>
00497 
00498         cbitsPart = <a class="code" href="../../d0/d4/mrcf_8c.html#a3">minimum</a>((BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>), cbits);
00499 
00500         <span class="comment">//</span>
00501         <span class="comment">//  Mask for bits we want, extract and store them</span>
00502         <span class="comment">//</span>
00503 
00504         mask = (1 &lt;&lt; cbitsPart) - 1;
00505         abits |= ((BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>) &amp; mask) &lt;&lt; cshift;
00506 
00507         <span class="comment">//</span>
00508         <span class="comment">//  Remember the next chunk of bits</span>
00509         <span class="comment">//</span>
00510 
00511         cshift = cbitsPart;
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">//  Update bit buffer, move remaining bits down and</span>
00515         <span class="comment">//  update count of bits left</span>
00516         <span class="comment">//</span>
00517 
00518         (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a>) &gt;&gt;= cbitsPart;
00519         (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>) -= cbitsPart;
00520 
00521         <span class="comment">//</span>
00522         <span class="comment">//  Update count of bits left to read</span>
00523         <span class="comment">//</span>
00524 
00525         cbits -= cbitsPart;
00526     }
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">//  Return requested bits</span>
00530     <span class="comment">//</span>
00531 
00532     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)abits;
00533 }
00534 
00535 
00536 <span class="comment">//</span>
00537 <span class="comment">//  Internal Support Routine</span>
00538 <span class="comment">//</span>
00539 
00540 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00541"></a><a class="code" href="../../d0/d4/mrcf_8c.html#a9">00541</a> <a class="code" href="../../d0/d4/mrcf_8c.html#a9">MrcfFillBitBuffer</a> (
00542     PMRCF_BIT_IO BitIo
00543     )
00544 
00545 <span class="comment">/*++</span>
00546 <span class="comment"></span>
00547 <span class="comment">Routine Description:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    Fill abitsBB from static bit buffer</span>
00550 <span class="comment"></span>
00551 <span class="comment">Arguments:</span>
00552 <span class="comment"></span>
00553 <span class="comment">    BitIo - Supplies a pointer to the bit buffer statics</span>
00554 <span class="comment"></span>
00555 <span class="comment">Return Value:</span>
00556 <span class="comment"></span>
00557 <span class="comment">    None.</span>
00558 <span class="comment"></span>
00559 <span class="comment">--*/</span>
00560 
00561 {
00562     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a>) == 0);
00563 
00564     <span class="keywordflow">switch</span> (BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">cbBB</a>) {
00565 
00566     <span class="keywordflow">case</span> 0:
00567 
00568         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>(<span class="stringliteral">"no bits left in coded buffer!"</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00569 
00570         <span class="keywordflow">break</span>;
00571 
00572     <span class="keywordflow">case</span> 1:
00573 
00574         <span class="comment">//</span>
00575         <span class="comment">//  Get last byte and adjust count</span>
00576         <span class="comment">//</span>
00577 
00578         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a> = 8;
00579         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a> = *(BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o2">pbBB</a>)++;
00580         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">cbBB</a>--;
00581 
00582         <span class="keywordflow">break</span>;
00583 
00584     <span class="keywordflow">default</span>:
00585 
00586         <span class="comment">//</span>
00587         <span class="comment">//  Get word and adjust count</span>
00588         <span class="comment">//</span>
00589 
00590         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o1">cbitsBB</a> = 16;
00591         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o0">abitsBB</a> = *((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *)(BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o2">pbBB</a>))++;
00592         BitIo-&gt;<a class="code" href="../../d5/d9/struct__MRCF__BIT__IO.html#o3">cbBB</a> -= 2;
00593 
00594         <span class="keywordflow">break</span>;
00595     }
00596 }
00597 
00598 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
