<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: color.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>color.c</h1><a href="../../d0/d4/color_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************Module*Header******************************\</span>
00002 <span class="comment">* Module Name: COLOR.C</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Module Descripton: Functions for color matching outside the DC</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Warnings:</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* Issues:</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* Public Routines:</span>
00011 <span class="comment">*</span>
00012 <span class="comment">* Created:  23 April 1996</span>
00013 <span class="comment">* Author:   Srinivasan Chandrasekar    [srinivac]</span>
00014 <span class="comment">*</span>
00015 <span class="comment">* Copyright (c) 1996, 1997  Microsoft Corporation</span>
00016 <span class="comment">\***********************************************************************/</span>
00017 
00018 <span class="preprocessor">#include "<a class="code" href="../../d3/d4/mscms_8h.html">mscms.h</a>"</span>
00019 <span class="preprocessor">#include "wingdip.h"</span> <span class="comment">/* for LCS_DEVICE_CMYK */</span>
00020 
00021 <span class="comment">//</span>
00022 <span class="comment">// Local functions</span>
00023 <span class="comment">//</span>
00024 
00025 HTRANSFORM <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a39">LPLOGCOLORSPACE</a>, HPROFILE, HPROFILE, DWORD);
00026 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>(PTSTR, DWORD, PTSTR);
00027 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>(PTSTR, DWORD);
00028 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>      <a class="code" href="../../d0/d4/color_8c.html#a3">GetBitmapBytes</a>(BMFORMAT, DWORD, DWORD);
00029 
00030 
00031 <span class="comment">/******************************************************************************</span>
00032 <span class="comment"> *</span>
00033 <span class="comment"> *                            CreateColorTransform</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> *  Function:</span>
00036 <span class="comment"> *       These are the ANSI &amp; Unicode wrappers for InternalCreateColorTransform.</span>
00037 <span class="comment"> *       Please see InternalCreateColorTransform for more details on this</span>
00038 <span class="comment"> *       function.</span>
00039 <span class="comment"> *</span>
00040 <span class="comment"> *  Arguments:</span>
00041 <span class="comment"> *       pLogColorSpace - pointer to LOGCOLORSPACE structure identifying</span>
00042 <span class="comment"> *                        source color space</span>
00043 <span class="comment"> *       hDestProfile   - handle identifing the destination profile object</span>
00044 <span class="comment"> *       hTargetProfile - handle identifing the target profile object</span>
00045 <span class="comment"> *       dwFlags        - optimization flags</span>
00046 <span class="comment"> *</span>
00047 <span class="comment"> *  Returns:</span>
00048 <span class="comment"> *       Handle to color transform if successful, NULL otherwise</span>
00049 <span class="comment"> *</span>
00050 <span class="comment"> ******************************************************************************/</span>
00051 
00052 <span class="preprocessor">#ifdef UNICODE              // Windows NT version</span>
00053 <span class="preprocessor"></span>
00054 HTRANSFORM WINAPI <a class="code" href="../../d0/d4/color_8c.html#a4">CreateColorTransformA</a>(
00055     LPLOGCOLORSPACEA pLogColorSpace,
00056     HPROFILE         hDestProfile,
00057     HPROFILE         hTargetProfile,
00058     DWORD            dwFlags
00059     )
00060 {
00061     LOGCOLORSPACEW  wLCS;
00062 
00063     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateColorTransformA\n"</span>)));
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">// Validate parameter before we touch it</span>
00067     <span class="comment">//</span>
00068 
00069     <span class="keywordflow">if</span> (IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEA)))
00070     {
00071         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateColorTransform\n"</span>)));
00072         SetLastError(ERROR_INVALID_PARAMETER);
00073         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     }
00075 
00076     CopyMemory(&amp;wLCS, pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEA));
00077     wLCS.lcsSize = <span class="keyword">sizeof</span>(LOGCOLORSPACEW);
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// Convert filename to Unicode and call the internal version</span>
00081     <span class="comment">//</span>
00082 
00083     <span class="keywordflow">if</span> (! MultiByteToWideChar(CP_ACP, 0, pLogColorSpace-&gt;lcsFilename, -1,
00084         wLCS.lcsFilename, MAX_PATH))
00085     {
00086         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error converting LogColorSpace filename to Unicode\n"</span>)));
00087         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00088     }
00089 
00090     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(&amp;wLCS, hDestProfile, hTargetProfile, dwFlags);
00091 }
00092 
00093 
00094 HTRANSFORM WINAPI <a class="code" href="../../d0/d4/color_8c.html#a5">CreateColorTransformW</a>(
00095     LPLOGCOLORSPACEW pLogColorSpace,
00096     HPROFILE         hDestProfile,
00097     HPROFILE         hTargetProfile,
00098     DWORD            dwFlags
00099     )
00100 {
00101     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateColorTransformW\n"</span>)));
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Internal version is Unicode in Windows NT, call it directly</span>
00105     <span class="comment">//</span>
00106 
00107     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(pLogColorSpace, hDestProfile, hTargetProfile, dwFlags);
00108 }
00109 
00110 <span class="preprocessor">#else                   // Windows 95 version</span>
00111 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="../../d0/d4/color_8c.html#a4">00112</a> HTRANSFORM WINAPI <a class="code" href="../../d0/d4/color_8c.html#a4">CreateColorTransformA</a>(
00113     LPLOGCOLORSPACEA pLogColorSpace,
00114     HPROFILE         hDestProfile,
00115     HPROFILE         hTargetProfile,
00116     DWORD            dwFlags
00117     )
00118 {
00119     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateColorTransformA\n"</span>)));
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Internal version is ANSI in Windows 95, call it directly</span>
00123     <span class="comment">//</span>
00124 
00125     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(pLogColorSpace, hDestProfile, hTargetProfile, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00126 }
00127 
00128 
<a name="l00129"></a><a class="code" href="../../d0/d4/color_8c.html#a5">00129</a> HTRANSFORM WINAPI <a class="code" href="../../d0/d4/color_8c.html#a5">CreateColorTransformW</a>(
00130     LPLOGCOLORSPACEW  pLogColorSpace,
00131     HPROFILE          hDestProfile,
00132     HPROFILE          hTargetProfile,
00133     DWORD             dwFlags
00134     )
00135 {
00136     LOGCOLORSPACEA  aLCS;
00137     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            bUsedDefaultChar;
00138 
00139     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateColorTransformW\n"</span>)));
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">// Validate parameter before we touch it</span>
00143     <span class="comment">//</span>
00144 
00145     <span class="keywordflow">if</span> (IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEW)))
00146     {
00147         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateColorTransform\n"</span>)));
00148         SetLastError(ERROR_INVALID_PARAMETER);
00149         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00150     }
00151 
00152     CopyMemory(&amp;aLCS, pLogColorSpace, <span class="keyword">sizeof</span>(LOGCOLORSPACEA));
00153     aLCS.lcsSize = <span class="keyword">sizeof</span>(LOGCOLORSPACEA);
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Convert filename to ANSI and call the internal version</span>
00157     <span class="comment">//</span>
00158 
00159     <span class="keywordflow">if</span> (! WideCharToMultiByte(CP_ACP, 0, pLogColorSpace-&gt;lcsFilename, -1,
00160         aLCS.lcsFilename, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;bUsedDefaultChar) ||
00161         bUsedDefaultChar)
00162     {
00163         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Error converting LogColorSpace filename to ANSI\n"</span>)));
00164         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00165     }
00166 
00167     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(&amp;aLCS, hDestProfile, hTargetProfile, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00168 }
00169 
00170 <span class="preprocessor">#endif</span>
00171 <span class="preprocessor"></span>
00172 
00173 <span class="comment">/******************************************************************************</span>
00174 <span class="comment"> *</span>
00175 <span class="comment"> *                        CreateMultiProfileTransform</span>
00176 <span class="comment"> *</span>
00177 <span class="comment"> *  Function:</span>
00178 <span class="comment"> *       This functions creates a color transform from a set of profiles.</span>
00179 <span class="comment"> *</span>
00180 <span class="comment"> *  Arguments:</span>
00181 <span class="comment"> *       pahProfiles       - pointer to array of handles of profiles</span>
00182 <span class="comment"> *       nProfiles         - number of profiles in array</span>
00183 <span class="comment"> *       padwIntent        - array of intents to use</span>
00184 <span class="comment"> *       nIntents          - size of array - can be 1 or nProfiles</span>
00185 <span class="comment"> *       dwFlags           - optimization flags</span>
00186 <span class="comment"> *       indexPreferredCMM - one based index of profile which specifies</span>
00187 <span class="comment"> *                           preferred CMM to use.</span>
00188 <span class="comment"> *</span>
00189 <span class="comment"> *  Returns:</span>
00190 <span class="comment"> *       Handle to color transform if successful, NULL otherwise</span>
00191 <span class="comment"> *</span>
00192 <span class="comment"> ******************************************************************************/</span>
00193 
<a name="l00194"></a><a class="code" href="../../d0/d4/color_8c.html#a6">00194</a> HTRANSFORM WINAPI <a class="code" href="../../d0/d4/color_8c.html#a6">CreateMultiProfileTransform</a>(
00195     PHPROFILE   pahProfiles,
00196     DWORD       nProfiles,
00197     PDWORD      padwIntent,
00198     DWORD       nIntents,
00199     DWORD       dwFlags,
00200     DWORD       indexPreferredCMM
00201     )
00202 {
00203     PPROFOBJ      pProfObj;
00204     PCMMOBJ       pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00205     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         cmmID;
00206     HTRANSFORM    hxform = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207     PTRANSFORMOBJ pxformObj;
00208     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         i;
00209 
00210     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CreateMultiProfileTransform\n"</span>)));
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// Validate parameters</span>
00214     <span class="comment">//</span>
00215 
00216     <span class="keywordflow">if</span> (nProfiles &lt; 1 ||
00217         indexPreferredCMM &gt; nProfiles ||
00218         IsBadReadPtr(pahProfiles, nProfiles * <span class="keyword">sizeof</span>(HANDLE)) ||
00219         padwIntent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00220         ((nIntents != nProfiles) &amp;&amp; (nIntents != 1)) ||
00221         IsBadReadPtr(padwIntent, nIntents * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)))
00222     {
00223         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateMultiProfileTransform\n"</span>)));
00224         SetLastError(ERROR_INVALID_PARAMETER);
00225         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00226     }
00227 
00228     <span class="keywordflow">for</span> (i=0; i&lt;nProfiles; i++)
00229     {
00230         <span class="keywordflow">if</span> (pahProfiles[i] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00231             ! <a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(pahProfiles[i], OBJ_PROFILE))
00232         {
00233             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to CreateMultiProfileTransform\n"</span>)));
00234             SetLastError(ERROR_INVALID_PARAMETER);
00235             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00236         }
00237 
00238         pProfObj = (PPROFOBJ)HDLTOPTR(pahProfiles[i]);
00239 
00240         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">// Quick check on the integrity of the profile</span>
00244         <span class="comment">//</span>
00245 
00246         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pProfObj))
00247         {
00248             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid profile passed to CreateMultiProfileTransform\n"</span>)));
00249             SetLastError(ERROR_INVALID_PROFILE);
00250             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251         }
00252 
00253         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00254 
00255         <span class="keywordflow">if</span> (i+1 == indexPreferredCMM)
00256         {
00257             <span class="comment">//</span>
00258             <span class="comment">// Get ID of preferred CMM</span>
00259             <span class="comment">//</span>
00260 
00261             cmmID = HEADER(pProfObj)-&gt;phCMMType;
00262             cmmID = FIX_ENDIAN(cmmID);
00263         }
00264     }
00265 
00266     <span class="keywordflow">if</span> (indexPreferredCMM == INDEX_DONT_CARE)
00267     {
00268         pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
00269     }
00270     <span class="keywordflow">else</span>
00271     {
00272         <span class="comment">//</span>
00273         <span class="comment">// Get CMM associated with preferred profile</span>
00274         <span class="comment">//</span>
00275 
00276         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Finally try Windows default CMM</span>
00281     <span class="comment">//</span>
00282 
00283     <span class="keywordflow">if</span> (!pCMMObj)
00284     {
00285         pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
00286         <span class="keywordflow">if</span> (!pCMMObj)
00287         {
00288             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM not found\n"</span>)));
00289             SetLastError(ERROR_INVALID_CMM);
00290             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00291         }
00292     }
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Allocate an object on the heap for the transform</span>
00296     <span class="comment">//</span>
00297 
00298     hxform = <a class="code" href="../../d2/d1/object_8c.html#a3">AllocateHeapObject</a>(OBJ_TRANSFORM);
00299     <span class="keywordflow">if</span> (!hxform)
00300     {
00301         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate transform object\n"</span>)));
00302         SetLastError(ERROR_NOT_ENOUGH_MEMORY);
00303         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
00304         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00305     }
00306 
00307     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00308 
00309     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00310 
00311     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pCMMObj-&gt;fns.pCMCreateMultiProfileTransform != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00312 
00313     pxformObj-&gt;pCMMObj = pCMMObj;
00314     pxformObj-&gt;objHdr.dwUseCount = 1;
00315 
00316     pxformObj-&gt;hcmxform = pCMMObj-&gt;fns.pCMCreateMultiProfileTransform(
00317                             pahProfiles,
00318                             nProfiles,
00319                             padwIntent,
00320                             nIntents,
00321                             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00322 
00323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMCreateMultiProfileTransform returned 0x%x\n"</span>), pxformObj-&gt;hcmxform));
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// If return value from CMM is less than 256, then it is an error code</span>
00327     <span class="comment">//</span>
00328 
00329     <span class="keywordflow">if</span> (pxformObj-&gt;hcmxform &lt;= TRANSFORM_ERROR)
00330     {
00331         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"CMCreateMultiProfileTransform failed\n"</span>)));
00332         <span class="keywordflow">if</span> (GetLastError() == ERROR_SUCCESS)
00333         {
00334             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"CMM did not set error code\n"</span>)));
00335             SetLastError(ERROR_INVALID_PROFILE);
00336         }
00337         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pxformObj-&gt;pCMMObj);
00338         pxformObj-&gt;objHdr.dwUseCount--;        <span class="comment">// decrement before freeing</span>
00339         <a class="code" href="../../d2/d1/object_8c.html#a4">FreeHeapObject</a>(hxform);
00340         hxform = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341     }
00342 
00343     <span class="keywordflow">return</span> hxform;
00344 }
00345 
00346 
00347 <span class="comment">/******************************************************************************</span>
00348 <span class="comment"> *</span>
00349 <span class="comment"> *                          DeleteColorTransform</span>
00350 <span class="comment"> *</span>
00351 <span class="comment"> *  Function:</span>
00352 <span class="comment"> *       This functions deletes a color transform and frees all associated</span>
00353 <span class="comment"> *       memory.</span>
00354 <span class="comment"> *</span>
00355 <span class="comment"> *  Arguments:</span>
00356 <span class="comment"> *       hxform - handle to color transform to delete</span>
00357 <span class="comment"> *</span>
00358 <span class="comment"> *  Returns:</span>
00359 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00360 <span class="comment"> *</span>
00361 <span class="comment"> ******************************************************************************/</span>
00362 
<a name="l00363"></a><a class="code" href="../../d0/d4/color_8c.html#a7">00363</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d0/d4/color_8c.html#a7">DeleteColorTransform</a>(
00364     HTRANSFORM  hxform
00365     )
00366 {
00367     PTRANSFORMOBJ pxformObj;
00368     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00369 
00370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"DeleteColorTransform\n"</span>)));
00371 
00372     <span class="comment">//</span>
00373     <span class="comment">// Validate parameters</span>
00374     <span class="comment">//</span>
00375 
00376     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM))
00377     {
00378         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to DeleteColorTransform\n"</span>)));
00379         SetLastError(ERROR_INVALID_PARAMETER);
00380         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381     }
00382 
00383     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00384 
00385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00386 
00387     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;objHdr.dwUseCount &gt; 0);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// Decrease  object count, and delete if it goes to zero.</span>
00391     <span class="comment">// The following code retains the object and returns failure if the CMM</span>
00392     <span class="comment">// fails the delete transform operation.</span>
00393     <span class="comment">//</span>
00394 
00395     pxformObj-&gt;objHdr.dwUseCount--;
00396 
00397     <span class="keywordflow">if</span> (pxformObj-&gt;objHdr.dwUseCount == 0)
00398     {
00399         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00400 
00401         rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMDeleteTransform(pxformObj-&gt;hcmxform);
00402         <span class="keywordflow">if</span> (!rc)
00403         {
00404             pxformObj-&gt;objHdr.dwUseCount++;     <span class="comment">// set count back</span>
00405             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00406         }
00407         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pxformObj-&gt;pCMMObj);
00408         <a class="code" href="../../d2/d1/object_8c.html#a4">FreeHeapObject</a>(hxform);
00409     }
00410 
00411     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00412 }
00413 
00414 
00415 <span class="comment">/******************************************************************************</span>
00416 <span class="comment"> *</span>
00417 <span class="comment"> *                          TranslateColors</span>
00418 <span class="comment"> *</span>
00419 <span class="comment"> *  Function:</span>
00420 <span class="comment"> *       This functions translates an array of color strcutures using the</span>
00421 <span class="comment"> *       given transform</span>
00422 <span class="comment"> *</span>
00423 <span class="comment"> *  Arguments:</span>
00424 <span class="comment"> *       hxform         - handle to color transform to use</span>
00425 <span class="comment"> *       paInputcolors  - pointer to array of input colors</span>
00426 <span class="comment"> *       nColors        - number of colors in the array</span>
00427 <span class="comment"> *       ctInput        - color type of input</span>
00428 <span class="comment"> *       paOutputColors - pointer to buffer to get translated colors</span>
00429 <span class="comment"> *       ctOutput       - output color type</span>
00430 <span class="comment"> *</span>
00431 <span class="comment"> *  Comments:</span>
00432 <span class="comment"> *       Input and output color types must be consistent with the transform</span>
00433 <span class="comment"> *</span>
00434 <span class="comment"> *  Returns:</span>
00435 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00436 <span class="comment"> *</span>
00437 <span class="comment"> ******************************************************************************/</span>
00438 
<a name="l00439"></a><a class="code" href="../../d0/d4/color_8c.html#a8">00439</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a8">TranslateColors</a>(
00440     HTRANSFORM  hxform,
00441     PCOLOR      paInputColors,
00442     DWORD       nColors,
00443     COLORTYPE   ctInput,
00444     PCOLOR      paOutputColors,
00445     COLORTYPE   ctOutput
00446     )
00447 {
00448     PTRANSFORMOBJ pxformObj;
00449     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00450 
00451     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"TranslateColors\n"</span>)));
00452 
00453     <span class="comment">//</span>
00454     <span class="comment">// Validate parameters</span>
00455     <span class="comment">//</span>
00456 
00457     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM) ||
00458         (nColors == 0) ||
00459         IsBadReadPtr(paInputColors, nColors*<span class="keyword">sizeof</span>(COLOR)) ||
00460         IsBadWritePtr(paOutputColors, nColors*<span class="keyword">sizeof</span>(COLOR)))
00461     {
00462         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to TranslateColors\n"</span>)));
00463         SetLastError(ERROR_INVALID_PARAMETER);
00464         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00465     }
00466 
00467     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00468 
00469     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00470 
00471     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00472 
00473     rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMTranslateColors(
00474             pxformObj-&gt;hcmxform,
00475             paInputColors,
00476             nColors,
00477             ctInput,
00478             paOutputColors,
00479             ctOutput);
00480 
00481     <span class="keywordflow">return</span> rc;
00482 }
00483 
00484 
00485 <span class="comment">/******************************************************************************</span>
00486 <span class="comment"> *</span>
00487 <span class="comment"> *                          CheckColors</span>
00488 <span class="comment"> *</span>
00489 <span class="comment"> *  Function:</span>
00490 <span class="comment"> *       This functions checks if an array of colors fall within the output</span>
00491 <span class="comment"> *       gamut of the given transform</span>
00492 <span class="comment"> *</span>
00493 <span class="comment"> *  Arguments:</span>
00494 <span class="comment"> *       hxform         - handle to color transform to use</span>
00495 <span class="comment"> *       paInputcolors  - pointer to array of input colors</span>
00496 <span class="comment"> *       nColors        - number of colors in the array</span>
00497 <span class="comment"> *       ctInput        - color type of input</span>
00498 <span class="comment"> *       paResult       - pointer to buffer to hold the result</span>
00499 <span class="comment"> *</span>
00500 <span class="comment"> *  Comments:</span>
00501 <span class="comment"> *       Input color type must be consistent with the transform</span>
00502 <span class="comment"> *</span>
00503 <span class="comment"> *  Returns:</span>
00504 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00505 <span class="comment"> *</span>
00506 <span class="comment"> ******************************************************************************/</span>
00507 
<a name="l00508"></a><a class="code" href="../../d0/d4/color_8c.html#a9">00508</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a9">CheckColors</a>(
00509     HTRANSFORM      hxform,
00510     PCOLOR          paInputColors,
00511     DWORD           nColors,
00512     COLORTYPE       ctInput,
00513     PBYTE           paResult
00514     )
00515 {
00516     PTRANSFORMOBJ pxformObj;
00517     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00518 
00519     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CheckColors\n"</span>)));
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">// Validate parameters</span>
00523     <span class="comment">//</span>
00524 
00525     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM) ||
00526         (nColors == 0) ||
00527         IsBadReadPtr(paInputColors, nColors * <span class="keyword">sizeof</span>(COLOR)) ||
00528         IsBadWritePtr(paResult, nColors * <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)))
00529     {
00530         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CheckColors\n"</span>)));
00531         SetLastError(ERROR_INVALID_PARAMETER);
00532         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00533     }
00534 
00535     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00536 
00537     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00538 
00539     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00540 
00541     rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMCheckColors(
00542             pxformObj-&gt;hcmxform,
00543             paInputColors,
00544             nColors,
00545             ctInput,
00546             paResult);
00547 
00548     <span class="keywordflow">return</span> rc;
00549 }
00550 
00551 
00552 <span class="comment">/******************************************************************************</span>
00553 <span class="comment"> *</span>
00554 <span class="comment"> *                          TranslateBitmapBits</span>
00555 <span class="comment"> *</span>
00556 <span class="comment"> *  Function:</span>
00557 <span class="comment"> *       This functions translates the colors of a bitmap using the</span>
00558 <span class="comment"> *       given transform</span>
00559 <span class="comment"> *</span>
00560 <span class="comment"> *  Arguments:</span>
00561 <span class="comment"> *       hxform         - handle to color transform to use</span>
00562 <span class="comment"> *       pSrcBits       - pointer to source bitmap</span>
00563 <span class="comment"> *       bmInput        - input bitmap format</span>
00564 <span class="comment"> *       dwWidth        - width in pixels of each scanline</span>
00565 <span class="comment"> *       dwHeight       - number of scanlines in bitmap</span>
00566 <span class="comment"> *       dwInputStride  - number of bytes from beginning of one scanline to next</span>
00567 <span class="comment"> *                        in input buffer, 0 means DWORD aligned</span>
00568 <span class="comment"> *       pDestBits      - pointer to destination bitmap to store results</span>
00569 <span class="comment"> *       bmOutput       - output bitmap format</span>
00570 <span class="comment"> *       dwOutputStride - number of bytes from beginning of one scanline to next</span>
00571 <span class="comment"> *                        in output buffer, 0 means DWORD aligned</span>
00572 <span class="comment"> *       pfnCallback    - callback function to report progress</span>
00573 <span class="comment"> *       ulCallbackData - parameter to callback function</span>
00574 <span class="comment"> *</span>
00575 <span class="comment"> *  Comments:</span>
00576 <span class="comment"> *       Input and output bitmap formats must be consistent with the transform</span>
00577 <span class="comment"> *</span>
00578 <span class="comment"> *  Returns:</span>
00579 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00580 <span class="comment"> *</span>
00581 <span class="comment"> ******************************************************************************/</span>
00582 
<a name="l00583"></a><a class="code" href="../../d0/d4/color_8c.html#a10">00583</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a10">TranslateBitmapBits</a>(
00584     HTRANSFORM      hxform,
00585     PVOID           pSrcBits,
00586     BMFORMAT        bmInput,
00587     DWORD           dwWidth,
00588     DWORD           dwHeight,
00589     DWORD           dwInputStride,
00590     PVOID           pDestBits,
00591     BMFORMAT        bmOutput,
00592     DWORD           dwOutputStride,
00593     PBMCALLBACKFN   pfnCallback,
00594     LPARAM          ulCallbackData
00595 )
00596 {
00597     PTRANSFORMOBJ pxformObj;
00598     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         nBytes, cbSize;
00599     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00600 
00601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"TranslateBitmapBits\n"</span>)));
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Calculate number of bytes input bitmap should be</span>
00605     <span class="comment">//</span>
00606 
00607     <span class="keywordflow">if</span> (dwInputStride)
00608         cbSize = dwInputStride * dwHeight;
00609     <span class="keywordflow">else</span>
00610         cbSize = <a class="code" href="../../d0/d4/color_8c.html#a3">GetBitmapBytes</a>(bmInput, dwWidth, dwHeight);
00611 
00612     <span class="comment">//</span>
00613     <span class="comment">// Calculate number of bytes output bitmap should be</span>
00614     <span class="comment">//</span>
00615 
00616     <span class="keywordflow">if</span> (dwOutputStride)
00617         nBytes = dwOutputStride * dwHeight;
00618     <span class="keywordflow">else</span>
00619         nBytes = <a class="code" href="../../d0/d4/color_8c.html#a3">GetBitmapBytes</a>(bmOutput, dwWidth, dwHeight);
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">// Validate parameters</span>
00623     <span class="comment">//</span>
00624 
00625     <span class="keywordflow">if</span> (nBytes == 0 ||
00626         cbSize == 0 ||
00627         !<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM) ||
00628         IsBadReadPtr(pSrcBits, cbSize) ||
00629         IsBadWritePtr(pDestBits, nBytes) ||
00630         (pfnCallback &amp;&amp; IsBadCodePtr((FARPROC)pfnCallback)))
00631     {
00632         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to TranslateBitmapBits\n"</span>)));
00633         SetLastError(ERROR_INVALID_PARAMETER);
00634         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00635     }
00636 
00637     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00638 
00639     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00640 
00641     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00642 
00643     rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMTranslateRGBsExt(
00644             pxformObj-&gt;hcmxform,
00645             pSrcBits,
00646             bmInput,
00647             dwWidth,
00648             dwHeight,
00649             dwInputStride,
00650             pDestBits,
00651             bmOutput,
00652             dwOutputStride,
00653             pfnCallback,
00654             ulCallbackData);
00655 
00656     <span class="keywordflow">return</span> rc;
00657 }
00658 
00659 
00660 <span class="comment">/******************************************************************************</span>
00661 <span class="comment"> *</span>
00662 <span class="comment"> *                           CheckBitmapBits</span>
00663 <span class="comment"> *</span>
00664 <span class="comment"> *  Function:</span>
00665 <span class="comment"> *       This functions checks if the colors of a bitmap fall within the</span>
00666 <span class="comment"> *       output gamut of the given transform</span>
00667 <span class="comment"> *</span>
00668 <span class="comment"> *  Arguments:</span>
00669 <span class="comment"> *       hxform         - handle to color transform to use</span>
00670 <span class="comment"> *       pSrcBits       - pointer to source bitmap</span>
00671 <span class="comment"> *       bmInput        - input bitmap format</span>
00672 <span class="comment"> *       dwWidth        - width in pixels of each scanline</span>
00673 <span class="comment"> *       dwHeight       - number of scanlines in bitmap</span>
00674 <span class="comment"> *       dwStride       - number of bytes from beginning of one scanline to next</span>
00675 <span class="comment"> *       paResult       - pointer to buffer to hold the result</span>
00676 <span class="comment"> *       pfnCallback    - callback function to report progress</span>
00677 <span class="comment"> *       ulCallbackData - parameter to callback function</span>
00678 <span class="comment"> *</span>
00679 <span class="comment"> *  Comments:</span>
00680 <span class="comment"> *       Input bitmap format must be consistent with the transform</span>
00681 <span class="comment"> *</span>
00682 <span class="comment"> *  Returns:</span>
00683 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00684 <span class="comment"> *</span>
00685 <span class="comment"> ******************************************************************************/</span>
00686 
<a name="l00687"></a><a class="code" href="../../d0/d4/color_8c.html#a11">00687</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a11">CheckBitmapBits</a>(
00688     HTRANSFORM      hxform,
00689     PVOID           pSrcBits,
00690     BMFORMAT        bmInput,
00691     DWORD           dwWidth,
00692     DWORD           dwHeight,
00693     DWORD           dwStride,
00694     PBYTE           paResult,
00695     PBMCALLBACKFN   pfnCallback,
00696     LPARAM          ulCallbackData
00697 )
00698 {
00699     PTRANSFORMOBJ pxformObj;
00700     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         cbSize;
00701     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00702 
00703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"CheckBitmapBits\n"</span>)));
00704 
00705     <span class="comment">//</span>
00706     <span class="comment">// Calculate number of bytes input bitmap should be</span>
00707     <span class="comment">//</span>
00708 
00709     <span class="keywordflow">if</span> (dwStride)
00710         cbSize = dwStride*dwHeight;
00711     <span class="keywordflow">else</span>
00712         cbSize = <a class="code" href="../../d0/d4/color_8c.html#a3">GetBitmapBytes</a>(bmInput, dwWidth, dwHeight);
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">// Validate parameters</span>
00716     <span class="comment">//</span>
00717 
00718     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM) ||
00719         cbSize == 0 ||
00720         IsBadReadPtr(pSrcBits, cbSize) ||
00721         IsBadWritePtr(paResult, dwWidth*dwHeight) ||
00722         (pfnCallback &amp;&amp; IsBadCodePtr((FARPROC)pfnCallback)))
00723     {
00724         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CheckBitmapBits\n"</span>)));
00725         SetLastError(ERROR_INVALID_PARAMETER);
00726         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00727     }
00728 
00729     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00730 
00731     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00732 
00733     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00734 
00735     rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMCheckRGBs(
00736             pxformObj-&gt;hcmxform,
00737             pSrcBits,
00738             bmInput,
00739             dwWidth,
00740             dwHeight,
00741             dwStride,
00742             paResult,
00743             pfnCallback,
00744             ulCallbackData);
00745 
00746     <span class="keywordflow">return</span> rc;
00747 }
00748 
00749 
00750 <span class="comment">/******************************************************************************</span>
00751 <span class="comment"> *</span>
00752 <span class="comment"> *                           GetCMMInfo</span>
00753 <span class="comment"> *</span>
00754 <span class="comment"> *  Function:</span>
00755 <span class="comment"> *       This functions retrieves information about the CMM that created the</span>
00756 <span class="comment"> *       given transform</span>
00757 <span class="comment"> *</span>
00758 <span class="comment"> *  Arguments:</span>
00759 <span class="comment"> *       hxform         - handle to color transform</span>
00760 <span class="comment"> *       dwInfo         - Can be one of the following:</span>
00761 <span class="comment"> *                        CMM_WIN_VERSION: Version of Windows support</span>
00762 <span class="comment"> *                        CMM_DLL_VERSION: Version of CMM</span>
00763 <span class="comment"> *                        CMM_IDENT:       CMM signature registered with ICC</span>
00764 <span class="comment"> *</span>
00765 <span class="comment"> *  Returns:</span>
00766 <span class="comment"> *       For CMM_WIN_VERSION, it returns the Windows version it was written for.</span>
00767 <span class="comment"> *       For CMM_DLL_VERSION, it returns the version number of the CMM DLL.</span>
00768 <span class="comment"> *       For CMM_IDENT, it returns the CMM signature registered with the ICC.</span>
00769 <span class="comment"> *       If the function fails it returns zero.</span>
00770 <span class="comment"> *</span>
00771 <span class="comment"> ******************************************************************************/</span>
00772 
<a name="l00773"></a><a class="code" href="../../d0/d4/color_8c.html#a12">00773</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a12">GetCMMInfo</a>(
00774         HTRANSFORM      hxform,
00775         DWORD           dwInfo
00776         )
00777 {
00778     PTRANSFORMOBJ pxformObj;
00779     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          rc;
00780 
00781     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"GetCMMInfo\n"</span>)));
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Validate parameters</span>
00785     <span class="comment">//</span>
00786 
00787     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hxform, OBJ_TRANSFORM) ||
00788         (dwInfo != <a class="code" href="../../d8/d6/mscmm_2icm32_8c.html#a0">CMM_WIN_VERSION</a> &amp;&amp;
00789          dwInfo != <a class="code" href="../../d8/d6/mscmm_2icm32_8c.html#a3">CMM_DLL_VERSION</a> &amp;&amp;
00790          dwInfo != <a class="code" href="../../d8/d6/mscmm_2icm32_8c.html#a1">CMM_IDENT</a>
00791          )
00792         )
00793     {
00794         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to GetCMMInfo\n"</span>)));
00795         SetLastError(ERROR_INVALID_PARAMETER);
00796         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00797     }
00798 
00799     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
00800 
00801     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00802 
00803     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj-&gt;pCMMObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00804 
00805     rc = pxformObj-&gt;pCMMObj-&gt;fns.pCMGetInfo(dwInfo);
00806 
00807     <span class="keywordflow">return</span> rc;
00808 }
00809 
00810 
00811 <span class="comment">/******************************************************************************</span>
00812 <span class="comment"> *</span>
00813 <span class="comment"> *                              RegisterCMM</span>
00814 <span class="comment"> *</span>
00815 <span class="comment"> *  Function:</span>
00816 <span class="comment"> *       These are the ANSI and Unicode wrappers. For more information on this</span>
00817 <span class="comment"> *       function, see InternalRegisterCMM.</span>
00818 <span class="comment"> *</span>
00819 <span class="comment"> *  Arguments:</span>
00820 <span class="comment"> *       pMachineName   - name identifying machine on which the CMM should be</span>
00821 <span class="comment"> *                        registered</span>
00822 <span class="comment"> *       cmmID          - ID of CMM to register</span>
00823 <span class="comment"> *       pCMMdll        - pointer to CMM dll to register</span>
00824 <span class="comment"> *</span>
00825 <span class="comment"> *  Returns:</span>
00826 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00827 <span class="comment"> *</span>
00828 <span class="comment"> ******************************************************************************/</span>
00829 
00830 <span class="preprocessor">#ifdef UNICODE              // Windows NT version</span>
00831 <span class="preprocessor"></span>
00832 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a13">RegisterCMMA</a>(
00833     PCSTR       pMachineName,
00834     DWORD       cmmID,
00835     PCSTR       pCMMdll
00836     )
00837 {
00838     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
00839     PWSTR pwszCMMdll = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;        <span class="comment">// Unicode CMM dll path</span>
00840     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00841 
00842     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"RegisterCMMA\n"</span>)));
00843 
00844     <span class="comment">//</span>
00845     <span class="comment">// Convert machine name to Unicode</span>
00846     <span class="comment">//</span>
00847 
00848     <span class="keywordflow">if</span> (pMachineName)
00849     {
00850         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
00851     }
00852     <span class="keywordflow">else</span>
00853         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00854 
00855     <span class="comment">//</span>
00856     <span class="comment">// Convert pCMMdll to Unicode</span>
00857     <span class="comment">//</span>
00858 
00859     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pCMMdll, &amp;pwszCMMdll, TRUE);
00860 
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">// Call the internal Unicode function</span>
00864     <span class="comment">//</span>
00865 
00866     rc = rc &amp;&amp; <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>(pwszMachineName, cmmID, pwszCMMdll);
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">// Free memory before leaving</span>
00870     <span class="comment">//</span>
00871 
00872     <span class="keywordflow">if</span> (pwszMachineName)
00873     {
00874         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
00875     }
00876 
00877     <span class="keywordflow">if</span> (pwszCMMdll)
00878     {
00879         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszCMMdll);
00880     }
00881 
00882     <span class="keywordflow">return</span> rc;
00883 }
00884 
00885 
00886 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a14">RegisterCMMW</a>(
00887     PCWSTR      pMachineName,
00888     DWORD       cmmID,
00889     PCWSTR      pCMMdll
00890     )
00891 {
00892     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"RegisterCMMW\n"</span>)));
00893 
00894     <span class="comment">//</span>
00895     <span class="comment">// Internal version is Unicode in Windows NT, call it directly</span>
00896     <span class="comment">//</span>
00897 
00898     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>((PWSTR)pMachineName, cmmID, (PWSTR)pCMMdll);
00899 }
00900 
00901 <span class="preprocessor">#else                   // Windows 95 version</span>
00902 <span class="preprocessor"></span>
<a name="l00903"></a><a class="code" href="../../d0/d4/color_8c.html#a13">00903</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a13">RegisterCMMA</a>(
00904     PCSTR       pMachineName,
00905     DWORD       cmmID,
00906     PCSTR       pCMMdll
00907     )
00908 {
00909     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"RegisterCMMA\n"</span>)));
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">// Internal version is ANSI in Windows 95, call it directly</span>
00913     <span class="comment">//</span>
00914 
00915     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>((PSTR)pMachineName, cmmID, (PSTR)pCMMdll);
00916 }
00917 
00918 
<a name="l00919"></a><a class="code" href="../../d0/d4/color_8c.html#a14">00919</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a14">RegisterCMMW</a>(
00920     PCWSTR      pMachineName,
00921     DWORD       cmmID,
00922     PCWSTR      pCMMdll
00923     )
00924 {
00925     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
00926     PSTR  pszCMMdll = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;         <span class="comment">// Ansi CMM dll path</span>
00927     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
00928 
00929     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"RegisterCMMW\n"</span>)));
00930 
00931     <span class="comment">//</span>
00932     <span class="comment">// Convert machine name to Ansi</span>
00933     <span class="comment">//</span>
00934 
00935     <span class="keywordflow">if</span> (pMachineName)
00936     {
00937         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00938     }
00939     <span class="keywordflow">else</span>
00940         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00941 
00942     <span class="comment">//</span>
00943     <span class="comment">// Convert pCMMdll to Ansi</span>
00944     <span class="comment">//</span>
00945 
00946     rc = rc &amp;&amp; <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pCMMdll, &amp;pszCMMdll, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Call the internal Ansi function</span>
00950     <span class="comment">//</span>
00951 
00952     rc = rc &amp;&amp; <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>(pszMachineName, cmmID, pszCMMdll);
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Free memory before leaving</span>
00956     <span class="comment">//</span>
00957 
00958     <span class="keywordflow">if</span> (pszMachineName)
00959     {
00960         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
00961     }
00962 
00963     <span class="keywordflow">if</span> (pszCMMdll)
00964     {
00965         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszCMMdll);
00966     }
00967 
00968     <span class="keywordflow">return</span> rc;
00969 }
00970 
00971 <span class="preprocessor">#endif</span>
00972 <span class="preprocessor"></span>
00973 
00974 <span class="comment">/******************************************************************************</span>
00975 <span class="comment"> *</span>
00976 <span class="comment"> *                            UnregisterCMM</span>
00977 <span class="comment"> *</span>
00978 <span class="comment"> *  Function:</span>
00979 <span class="comment"> *       These are the ANSI and Unicode wrappers. For more information on this</span>
00980 <span class="comment"> *       function, see InternalUnregisterCMM.</span>
00981 <span class="comment"> *</span>
00982 <span class="comment"> *  Arguments:</span>
00983 <span class="comment"> *       pMachineName   - name identifying machine on which the CMM is</span>
00984 <span class="comment"> *                        registered</span>
00985 <span class="comment"> *       cmmID          - ID of CMM to unregister</span>
00986 <span class="comment"> *</span>
00987 <span class="comment"> *  Returns:</span>
00988 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
00989 <span class="comment"> *</span>
00990 <span class="comment"> ******************************************************************************/</span>
00991 
00992 <span class="preprocessor">#ifdef UNICODE              // Windows NT version</span>
00993 <span class="preprocessor"></span>
00994 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a15">UnregisterCMMA</a>(
00995     PCSTR   pMachineName,
00996     DWORD   cmmID
00997     )
00998 {
00999     PWSTR pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Unicode machine name</span>
01000     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01001 
01002     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UnregisterCMMA\n"</span>)));
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// Convert machine name to Unicode</span>
01006     <span class="comment">//</span>
01007 
01008     <span class="keywordflow">if</span> (pMachineName)
01009     {
01010         rc = <a class="code" href="../../d2/d1/object_8c.html#a11">ConvertToUnicode</a>(pMachineName, &amp;pwszMachineName, TRUE);
01011     }
01012     <span class="keywordflow">else</span>
01013         pwszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01014 
01015     <span class="comment">//</span>
01016     <span class="comment">// Call the internal Unicode function</span>
01017     <span class="comment">//</span>
01018 
01019     rc = rc &amp;&amp; <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>(pwszMachineName, cmmID);
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// Free memory before leaving</span>
01023     <span class="comment">//</span>
01024 
01025     <span class="keywordflow">if</span> (pwszMachineName)
01026     {
01027         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pwszMachineName);
01028     }
01029 
01030     <span class="keywordflow">return</span> rc;
01031 }
01032 
01033 
01034 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a16">UnregisterCMMW</a>(
01035     PCWSTR      pMachineName,
01036     DWORD       cmmID
01037     )
01038 {
01039     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UnregisterCMMW\n"</span>)));
01040 
01041     <span class="comment">//</span>
01042     <span class="comment">// Internal version is Unicode in Windows NT, call it directly</span>
01043     <span class="comment">//</span>
01044 
01045     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>((PWSTR)pMachineName, cmmID);
01046 }
01047 
01048 <span class="preprocessor">#else                   // Windows 95 version</span>
01049 <span class="preprocessor"></span>
<a name="l01050"></a><a class="code" href="../../d0/d4/color_8c.html#a15">01050</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a15">UnregisterCMMA</a>(
01051     PCSTR       pMachineName,
01052     DWORD       cmmID
01053     )
01054 {
01055     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UnregisterCMMA\n"</span>)));
01056 
01057     <span class="comment">//</span>
01058     <span class="comment">// Internal version is ANSI in Windows 95, call it directly</span>
01059     <span class="comment">//</span>
01060 
01061     <span class="keywordflow">return</span> <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>((PSTR)pMachineName, cmmID);
01062 }
01063 
01064 
<a name="l01065"></a><a class="code" href="../../d0/d4/color_8c.html#a16">01065</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a16">UnregisterCMMW</a>(
01066     PCWSTR      pMachineName,
01067     DWORD       cmmID
01068     )
01069 {
01070     PSTR  pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;    <span class="comment">// Ansi machine name</span>
01071     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;                <span class="comment">// return code</span>
01072 
01073     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"UnregisterCMMW\n"</span>)));
01074 
01075     <span class="comment">//</span>
01076     <span class="comment">// Convert machine name to Ansi</span>
01077     <span class="comment">//</span>
01078 
01079     <span class="keywordflow">if</span> (pMachineName)
01080     {
01081         rc = <a class="code" href="../../d2/d1/object_8c.html#a12">ConvertToAnsi</a>(pMachineName, &amp;pszMachineName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01082     }
01083     <span class="keywordflow">else</span>
01084         pszMachineName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">// Call the internal Ansi function</span>
01088     <span class="comment">//</span>
01089 
01090     rc = rc &amp;&amp; <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>(pszMachineName, cmmID);
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// Free memory before leaving</span>
01094     <span class="comment">//</span>
01095 
01096     <span class="keywordflow">if</span> (pszMachineName)
01097     {
01098         <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pszMachineName);
01099     }
01100 
01101     <span class="keywordflow">return</span> rc;
01102 }
01103 
01104 <span class="preprocessor">#endif</span>
01105 <span class="preprocessor"></span>
01106 
01107 <span class="comment">/******************************************************************************</span>
01108 <span class="comment"> *</span>
01109 <span class="comment"> *                               SelectCMM</span>
01110 <span class="comment"> *</span>
01111 <span class="comment"> *  Function:</span>
01112 <span class="comment"> *       This function allows an application to select the preferred CMM to use</span>
01113 <span class="comment"> *</span>
01114 <span class="comment"> *  Arguments:</span>
01115 <span class="comment"> *       cmmID          - ID of preferred CMM to use</span>
01116 <span class="comment"> *</span>
01117 <span class="comment"> *  Returns:</span>
01118 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01119 <span class="comment"> *</span>
01120 <span class="comment"> ******************************************************************************/</span>
01121 
<a name="l01122"></a><a class="code" href="../../d0/d4/color_8c.html#a17">01122</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  WINAPI <a class="code" href="../../d0/d4/color_8c.html#a17">SelectCMM</a>(
01123         DWORD   dwCMMType
01124     )
01125 {
01126     PCMMOBJ pCMMObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127 
01128     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a0">TRACEAPI</a>((__TEXT(<span class="stringliteral">"SelectCMM\n"</span>)));
01129 
01130     <span class="keywordflow">if</span> (dwCMMType)
01131     {
01132         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(dwCMMType);
01133         <span class="keywordflow">if</span> (!pCMMObj)
01134         {
01135             SetLastError(ERROR_INVALID_CMM);
01136             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01137         }
01138     }
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">// Update Preferred CMM</span>
01142     <span class="comment">//</span>
01143     EnterCriticalSection(&amp;<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a19">critsec</a>);         <span class="comment">// Critical Section</span>
01144     <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a1">gpPreferredCMM</a> = pCMMObj;
01145     LeaveCriticalSection(&amp;<a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a19">critsec</a>);         <span class="comment">// Critical Section</span>
01146 
01147     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01148 }
01149 
01150 
01151 <span class="comment">/*****************************************************************************/</span>
01152 <span class="comment">/***************************** Internal Functions ****************************/</span>
01153 <span class="comment">/*****************************************************************************/</span>
01154 
01155 <span class="comment">/******************************************************************************</span>
01156 <span class="comment"> *</span>
01157 <span class="comment"> *                         InternalCreateColorTransform</span>
01158 <span class="comment"> *</span>
01159 <span class="comment"> *  Function:</span>
01160 <span class="comment"> *       This functions creates a color transform that translates from</span>
01161 <span class="comment"> *       the logcolorspace to the optional target device color space to the</span>
01162 <span class="comment"> *       destination device color space.</span>
01163 <span class="comment"> *</span>
01164 <span class="comment"> *  Arguments:</span>
01165 <span class="comment"> *       pLogColorSpace - pointer to LOGCOLORSPACE structure identifying</span>
01166 <span class="comment"> *                        source color space</span>
01167 <span class="comment"> *       hDestProfile   - handle identifing the destination profile object</span>
01168 <span class="comment"> *       hTargetProfile - handle identifing the target profile object</span>
01169 <span class="comment"> *       dwFlags        - optimization flags</span>
01170 <span class="comment"> *</span>
01171 <span class="comment"> *  Returns:</span>
01172 <span class="comment"> *       Handle to color transform if successful, NULL otherwise</span>
01173 <span class="comment"> *</span>
01174 <span class="comment"> ******************************************************************************/</span>
01175 
<a name="l01176"></a><a class="code" href="../../d0/d4/color_8c.html#a0">01176</a> HTRANSFORM <a class="code" href="../../d0/d4/color_8c.html#a0">InternalCreateColorTransform</a>(
01177     LPLOGCOLORSPACE pLogColorSpace,
01178     HPROFILE        hDestProfile,
01179     HPROFILE        hTargetProfile,
01180     DWORD           dwFlags
01181     )
01182 {
01183     PPROFOBJ         pDestProfObj, pTargetProfObj = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01184     PCMMOBJ          pCMMObj;
01185     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>            cmmID;
01186     HTRANSFORM       hxform = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01187     PTRANSFORMOBJ    pxformObj;
01188     <a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a39">LPLOGCOLORSPACE</a>  pLCS;
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">// Validate parameters</span>
01192     <span class="comment">//</span>
01193 
01194     <span class="keywordflow">if</span> (!pLogColorSpace ||
01195         IsBadReadPtr(pLogColorSpace, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/structtagLOGCOLORSPACE.html">LOGCOLORSPACE</a>)) ||
01196         pLogColorSpace-&gt;lcsSignature !=  LCS_SIGNATURE ||
01197         pLogColorSpace-&gt;lcsVersion &lt; 0x00000400 ||
01198         !hDestProfile ||
01199         !<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hDestProfile, OBJ_PROFILE) ||
01200         ((hTargetProfile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01201          !<a class="code" href="../../d2/d1/object_8c.html#a5">ValidHandle</a>(hTargetProfile, OBJ_PROFILE)
01202         )
01203        )
01204     {
01205         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to CreateColorTransform\n"</span>)));
01206         SetLastError(ERROR_INVALID_PARAMETER);
01207         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01208     }
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Allocate LogColorSpace and copy incoming data.</span>
01212     <span class="comment">// Leave space for passing in two handles below it</span>
01213     <span class="comment">//</span>
01214 
01215     pLCS = (<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a39">LPLOGCOLORSPACE</a>)<a class="code" href="../../d2/d1/object_8c.html#a7">MemAlloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a38">LOGCOLORSPACE</a>) + 2*<span class="keyword">sizeof</span>(HPROFILE));
01216     <span class="keywordflow">if</span> (!pLCS)
01217     {
01218         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate LogColorSpace"</span>)));
01219         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01220     }
01221     CopyMemory((PVOID)pLCS, (PVOID)pLogColorSpace, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a38">LOGCOLORSPACE</a>));
01222 
01223     <span class="comment">//</span>
01224     <span class="comment">// Copy handles below this structure</span>
01225     <span class="comment">//</span>
01226 
01227     *((PHPROFILE)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pLCS+<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a38">LOGCOLORSPACE</a>))) = hDestProfile;
01228     *((PHPROFILE)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pLCS+<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a38">LOGCOLORSPACE</a>)+<span class="keyword">sizeof</span>(HPROFILE))) = hTargetProfile;
01229 
01230     <span class="comment">//</span>
01231     <span class="comment">// If input color space is a predefined color space,</span>
01232     <span class="comment">// find the right profile to use</span>
01233     <span class="comment">//</span>
01234 
01235     <span class="keywordflow">if</span> (pLCS-&gt;lcsCSType &gt; <a class="code" href="../../d1/d6/aug98_2dll32_2icm_8h.html#a19">LCS_DEVICE_CMYK</a>)
01236     {
01237         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize = <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>;
01238 
01239         <span class="keywordflow">if</span> (! GetStandardColorSpaceProfile(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pLCS-&gt;lcsCSType,
01240                 pLCS-&gt;lcsFilename, &amp;cbSize))
01241         {
01242             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not get profile for predefined color space 0x%x\n"</span>), pLCS-&gt;lcsCSType));
01243             <span class="keywordflow">goto</span> EndCreateColorTransform;
01244         }
01245     }
01246 
01247     pDestProfObj = (PPROFOBJ)HDLTOPTR(hDestProfile);
01248 
01249     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pDestProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01250 
01251     <span class="comment">//</span>
01252     <span class="comment">// Quick check on the integrity of the profile before calling the CMM</span>
01253     <span class="comment">//</span>
01254 
01255     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pDestProfObj))
01256     {
01257         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid dest profile passed to CreateColorTransform\n"</span>)));
01258         SetLastError(ERROR_INVALID_PROFILE);
01259         <span class="keywordflow">goto</span> EndCreateColorTransform;
01260     }
01261 
01262     <span class="comment">//</span>
01263     <span class="comment">// If target profile is given, get the profile object and check integrity</span>
01264     <span class="comment">//</span>
01265 
01266     <span class="keywordflow">if</span> (hTargetProfile)
01267     {
01268         pTargetProfObj = (PPROFOBJ)HDLTOPTR(hTargetProfile);
01269 
01270         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pTargetProfObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01271 
01272         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d1/object_8c.html#a6">ValidProfile</a>(pTargetProfObj))
01273         {
01274             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid target profile passed to CreateColorTransform\n"</span>)));
01275             SetLastError(ERROR_INVALID_PROFILE);
01276             <span class="keywordflow">goto</span> EndCreateColorTransform;
01277         }
01278     }
01279 
01280     <span class="comment">//</span>
01281     <span class="comment">// Check if application specified CMM is present</span>
01282     <span class="comment">//</span>
01283 
01284     pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a15">GetPreferredCMM</a>();
01285     <span class="keywordflow">if</span> (!pCMMObj)
01286     {
01287         <span class="comment">//</span>
01288         <span class="comment">// Get CMM associated with destination profile. If it does not exist,</span>
01289         <span class="comment">// get default CMM.</span>
01290         <span class="comment">//</span>
01291 
01292         cmmID = HEADER(pDestProfObj)-&gt;phCMMType;
01293         cmmID = FIX_ENDIAN(cmmID);
01294 
01295         pCMMObj  = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(cmmID);
01296         <span class="keywordflow">if</span> (!pCMMObj)
01297         {
01298             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMM associated with profile could not be found"</span>)));
01299 
01300             pCMMObj = <a class="code" href="../../d2/d1/object_8c.html#a14">GetColorMatchingModule</a>(CMM_WINDOWS_DEFAULT);
01301             <span class="keywordflow">if</span> (!pCMMObj)
01302             {
01303                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a9">RIP</a>((__TEXT(<span class="stringliteral">"Default CMM not found\n"</span>)));
01304                 SetLastError(ERROR_INVALID_CMM);
01305                 <span class="keywordflow">goto</span> EndCreateColorTransform;
01306             }
01307         }
01308     }
01309 
01310     <span class="comment">//</span>
01311     <span class="comment">// Allocate an object on the heap for the transform</span>
01312     <span class="comment">//</span>
01313 
01314     hxform = <a class="code" href="../../d2/d1/object_8c.html#a3">AllocateHeapObject</a>(OBJ_TRANSFORM);
01315     <span class="keywordflow">if</span> (!hxform)
01316     {
01317         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not allocate transform object\n"</span>)));
01318         SetLastError(ERROR_NOT_ENOUGH_MEMORY);
01319         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pCMMObj);
01320         <span class="keywordflow">goto</span> EndCreateColorTransform;
01321     }
01322 
01323     pxformObj = (PTRANSFORMOBJ)HDLTOPTR(hxform);
01324 
01325     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pxformObj != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01326 
01327     <span class="comment">//</span>
01328     <span class="comment">// Call into CMM to create a color transform</span>
01329     <span class="comment">//</span>
01330 
01331     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pCMMObj-&gt;fns.pCMCreateTransformExt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01332 
01333     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pDestProfObj-&gt;pView != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01334 
01335     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!pTargetProfObj || pTargetProfObj-&gt;pView);
01336 
01337     pxformObj-&gt;pCMMObj = pCMMObj;
01338     pxformObj-&gt;objHdr.dwUseCount = 1;
01339 
01340     pxformObj-&gt;hcmxform = pCMMObj-&gt;fns.pCMCreateTransformExt(
01341                             pLCS,
01342                             pDestProfObj-&gt;pView,
01343                             pTargetProfObj ? pTargetProfObj-&gt;pView : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01344                             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
01345 
01346     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a3">TERSE</a>((__TEXT(<span class="stringliteral">"CMCreateTransform returned 0x%x\n"</span>), pxformObj-&gt;hcmxform));
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">// If return value from CMM is less than 256, then it is an error code</span>
01350     <span class="comment">//</span>
01351 
01352     <span class="keywordflow">if</span> (pxformObj-&gt;hcmxform &lt;= TRANSFORM_ERROR)
01353     {
01354         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"CMCreateTransform failed\n"</span>)));
01355         <span class="keywordflow">if</span> (GetLastError() == ERROR_SUCCESS)
01356         {
01357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"CMM did not set error code\n"</span>)));
01358             SetLastError(ERROR_INVALID_PROFILE);
01359         }
01360         <a class="code" href="../../d2/d1/object_8c.html#a16">ReleaseColorMatchingModule</a>(pxformObj-&gt;pCMMObj);
01361         pxformObj-&gt;objHdr.dwUseCount--;        <span class="comment">// decrement before freeing</span>
01362         <a class="code" href="../../d2/d1/object_8c.html#a4">FreeHeapObject</a>(hxform);
01363         hxform = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01364     }
01365 
01366 EndCreateColorTransform:
01367     <a class="code" href="../../d2/d1/object_8c.html#a9">MemFree</a>(pLCS);
01368 
01369     <span class="keywordflow">return</span> hxform;
01370 }
01371 
01372 <span class="comment">/******************************************************************************</span>
01373 <span class="comment"> *</span>
01374 <span class="comment"> *                            InternalRegisterCMM</span>
01375 <span class="comment"> *</span>
01376 <span class="comment"> *  Function:</span>
01377 <span class="comment"> *       This function associates an ID with a CMM DLL, so that we can use</span>
01378 <span class="comment"> *       the ID in profiles to find the CMM to use when creating a transform.</span>
01379 <span class="comment"> *</span>
01380 <span class="comment"> *  Arguments:</span>
01381 <span class="comment"> *       pMachineName   - name identifying machine on which the CMM should be</span>
01382 <span class="comment"> *                        registered</span>
01383 <span class="comment"> *       cmmID          - ID of CMM to register</span>
01384 <span class="comment"> *       pCMMdll        - pointer to CMM dll to register</span>
01385 <span class="comment"> *</span>
01386 <span class="comment"> *  Returns:</span>
01387 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01388 <span class="comment"> *</span>
01389 <span class="comment"> ******************************************************************************/</span>
01390 
<a name="l01391"></a><a class="code" href="../../d0/d4/color_8c.html#a1">01391</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d0/d4/color_8c.html#a1">InternalRegisterCMM</a>(
01392     PTSTR       pMachineName,
01393     DWORD       cmmID,
01394     PTSTR       pCMMdll
01395     )
01396 {
01397     PCMMOBJ   pCMMObj;
01398     HKEY      hkCMM;
01399     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dwErr;
01400     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01401     <span class="keywordtype">int</span>       i;
01402     TCHAR     szCMMID[5];
01403 
01404     <span class="comment">//</span>
01405     <span class="comment">// Validate parameters</span>
01406     <span class="comment">//</span>
01407 
01408     <span class="keywordflow">if</span> (!pCMMdll || IsBadReadPtr(pCMMdll, lstrlen(pCMMdll)*<span class="keyword">sizeof</span>(TCHAR)))
01409     {
01410         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Invalid parameter to RegisterCMM\n"</span>)));
01411         SetLastError(ERROR_INVALID_PARAMETER);
01412         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01413     }
01414 
01415 
01416     <span class="comment">//</span>
01417     <span class="comment">// Only local installs are allowed now</span>
01418     <span class="comment">//</span>
01419 
01420     <span class="keywordflow">if</span> (pMachineName)
01421     {
01422         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote CMM registration attempted, failing...\n"</span>)));
01423         SetLastError(ERROR_INVALID_PARAMETER);
01424         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01425     }
01426 
01427     <span class="comment">//</span>
01428     <span class="comment">// Check if the CMM actually exists, and it's valid CMM</span>
01429     <span class="comment">//</span>
01430 
01431     rc = <a class="code" href="../../d2/d1/object_8c.html#a13">ValidColorMatchingModule</a>(cmmID,pCMMdll);
01432 
01433     <span class="keywordflow">if</span> (rc)
01434     {
01435         <span class="comment">//</span>
01436         <span class="comment">// Open the registry key for ICMatchers</span>
01437         <span class="comment">//</span>
01438 
01439         <span class="keywordflow">if</span> ((dwErr = RegCreateKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a7">gszICMatcher</a>, &amp;hkCMM)) != ERROR_SUCCESS)
01440         {
01441             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Could not open ICMatcher registry key: %d\n"</span>), dwErr));
01442             SetLastError(dwErr);
01443             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01444         }
01445 
01446         <span class="comment">//</span>
01447         <span class="comment">// Make a string with the CMM ID</span>
01448         <span class="comment">//</span>
01449 
01450         <span class="keywordflow">for</span> (i=0; i&lt;4; i++)
01451         {
01452             szCMMID[i]  = (TCHAR)(((<span class="keywordtype">char</span>*)&amp;cmmID)[3-i]);
01453         }
01454         szCMMID[4] = <span class="charliteral">'\0'</span>;
01455 
01456         <span class="comment">//</span>
01457         <span class="comment">// Set the file name of the CMM dll in the registry</span>
01458         <span class="comment">//</span>
01459 
01460         <span class="keywordflow">if</span> ((dwErr = RegSetValueEx(hkCMM, (PTSTR)szCMMID, 0, REG_SZ, (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pCMMdll,
01461             (lstrlen(pCMMdll)+1)*<span class="keyword">sizeof</span>(TCHAR))) != ERROR_SUCCESS)
01462         {
01463             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not set CMM dll in the registry %s: %d\n"</span>), szCMMID, dwErr));
01464             SetLastError(dwErr);
01465             rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01466         }
01467 
01468         RegCloseKey(hkCMM);
01469     }
01470 
01471     <span class="keywordflow">return</span> rc;
01472 }
01473 
01474 
01475 
01476 <span class="comment">/******************************************************************************</span>
01477 <span class="comment"> *</span>
01478 <span class="comment"> *                            InternalUnregisterCMM</span>
01479 <span class="comment"> *</span>
01480 <span class="comment"> *  Function:</span>
01481 <span class="comment"> *       This function unregisters a CMM from the system by dissociating the</span>
01482 <span class="comment"> *       ID from the CMM dll in the registry.</span>
01483 <span class="comment"> *</span>
01484 <span class="comment"> *  Arguments:</span>
01485 <span class="comment"> *       pMachineName   - name identifying machine on which the CMM is</span>
01486 <span class="comment"> *                        registered</span>
01487 <span class="comment"> *       cmmID          - ID of CMM to unregister</span>
01488 <span class="comment"> *</span>
01489 <span class="comment"> *  Returns:</span>
01490 <span class="comment"> *       TRUE if successful, FALSE otherwise</span>
01491 <span class="comment"> *</span>
01492 <span class="comment"> ******************************************************************************/</span>
01493 
<a name="l01494"></a><a class="code" href="../../d0/d4/color_8c.html#a2">01494</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  <a class="code" href="../../d0/d4/color_8c.html#a2">InternalUnregisterCMM</a>(
01495     PTSTR       pMachineName,
01496     DWORD       cmmID
01497     )
01498 {
01499     HKEY      hkCMM;
01500     TCHAR     szCMMID[5];
01501     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dwErr;
01502     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01503 
01504     <span class="comment">//</span>
01505     <span class="comment">// Only local installs are allowed now</span>
01506     <span class="comment">//</span>
01507 
01508     <span class="keywordflow">if</span> (pMachineName)
01509     {
01510         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Remote CMM unregistration attempted, failing...\n"</span>)));
01511         SetLastError(ERROR_INVALID_PARAMETER);
01512         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01513     }
01514 
01515     <span class="comment">//</span>
01516     <span class="comment">// Open the registry key for ICMatchers</span>
01517     <span class="comment">//</span>
01518 
01519     <span class="keywordflow">if</span> ((dwErr = RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d1/d6/ntgdi_2icm_2mscms_2globals_8c.html#a7">gszICMatcher</a>, &amp;hkCMM)) != ERROR_SUCCESS)
01520     {
01521         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a5">ERR</a>((__TEXT(<span class="stringliteral">"Could not open ICMatcher registry key: %d\n"</span>), dwErr));
01522         SetLastError(dwErr);
01523         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01524     }
01525 
01526     <span class="comment">//</span>
01527     <span class="comment">// Make a string with the CMM ID</span>
01528     <span class="comment">//</span>
01529 
01530     szCMMID[0] = ((<span class="keywordtype">char</span> *)&amp;cmmID)[3];
01531     szCMMID[1] = ((<span class="keywordtype">char</span> *)&amp;cmmID)[2];
01532     szCMMID[2] = ((<span class="keywordtype">char</span> *)&amp;cmmID)[1];
01533     szCMMID[3] = ((<span class="keywordtype">char</span> *)&amp;cmmID)[0];
01534     szCMMID[4] = <span class="charliteral">'\0'</span>;
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">// Delete the file name of the CMM dll from the registry</span>
01538     <span class="comment">//</span>
01539 
01540     <span class="keywordflow">if</span> ((dwErr = RegDeleteValue(hkCMM, (PTSTR)szCMMID)) != ERROR_SUCCESS)
01541     {
01542         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>((__TEXT(<span class="stringliteral">"Could not delete CMM dll from the registry %s: %d\n"</span>), szCMMID, dwErr));
01543         SetLastError(dwErr);
01544         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01545     }
01546 
01547     RegCloseKey(hkCMM);
01548 
01549     <span class="keywordflow">return</span> rc;
01550 }
01551 
01552 
01553 <span class="comment">/******************************************************************************</span>
01554 <span class="comment"> *</span>
01555 <span class="comment"> *                           GetBitmapBytes</span>
01556 <span class="comment"> *</span>
01557 <span class="comment"> *  Function:</span>
01558 <span class="comment"> *       This functions returns number of bytes required for a bitmap given</span>
01559 <span class="comment"> *       the format, the width in pixels and number of scanlines</span>
01560 <span class="comment"> *</span>
01561 <span class="comment"> *  Arguments:</span>
01562 <span class="comment"> *       bmFmt          - format of bitmap</span>
01563 <span class="comment"> *       deWidth        - number of pixels per scanline</span>
01564 <span class="comment"> *       dwHeight       - number of scanlines in bitmap</span>
01565 <span class="comment"> *</span>
01566 <span class="comment"> *  Returns:</span>
01567 <span class="comment"> *       Number of bytes required for bitmap on success, 0 on failure</span>
01568 <span class="comment"> *</span>
01569 <span class="comment"> ******************************************************************************/</span>
01570 
<a name="l01571"></a><a class="code" href="../../d0/d4/color_8c.html#a3">01571</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d0/d4/color_8c.html#a3">GetBitmapBytes</a>(
01572     BMFORMAT bmFmt,
01573     DWORD    dwWidth,
01574     DWORD    dwHeight
01575     )
01576 {
01577     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nBytes;
01578 
01579     <span class="keywordflow">switch</span> (bmFmt)
01580     {
01581     <span class="comment">//</span>
01582     <span class="comment">// 1 byte per pixel</span>
01583     <span class="comment">//</span>
01584 
01585     <span class="keywordflow">case</span> BM_GRAY:
01586         nBytes = dwWidth;
01587         <span class="keywordflow">break</span>;
01588 
01589     <span class="comment">//</span>
01590     <span class="comment">// 2 bytes per pixel</span>
01591     <span class="comment">//</span>
01592 
01593     <span class="keywordflow">case</span> BM_x555RGB:
01594     <span class="keywordflow">case</span> BM_x555XYZ:
01595     <span class="keywordflow">case</span> BM_x555Yxy:
01596     <span class="keywordflow">case</span> BM_x555Lab:
01597     <span class="keywordflow">case</span> BM_x555G3CH:
01598     <span class="keywordflow">case</span> BM_16b_GRAY:
01599     <span class="keywordflow">case</span> BM_565RGB:
01600         nBytes = dwWidth*2;
01601         <span class="keywordflow">break</span>;
01602 
01603     <span class="comment">//</span>
01604     <span class="comment">// 3 bytes per pixel</span>
01605     <span class="comment">//</span>
01606 
01607     <span class="keywordflow">case</span> BM_BGRTRIPLETS:
01608     <span class="keywordflow">case</span> BM_RGBTRIPLETS:
01609     <span class="keywordflow">case</span> BM_XYZTRIPLETS:
01610     <span class="keywordflow">case</span> BM_YxyTRIPLETS:
01611     <span class="keywordflow">case</span> BM_LabTRIPLETS:
01612     <span class="keywordflow">case</span> BM_G3CHTRIPLETS:
01613         nBytes = dwWidth*3;
01614         <span class="keywordflow">break</span>;
01615 
01616     <span class="comment">//</span>
01617     <span class="comment">// 4 bytes per pixel</span>
01618     <span class="comment">//</span>
01619 
01620     <span class="keywordflow">case</span> BM_xRGBQUADS:
01621     <span class="keywordflow">case</span> BM_xBGRQUADS:
01622 <span class="preprocessor">    #if 0</span>
01623 <span class="preprocessor"></span>    <span class="keywordflow">case</span> BM_xXYZQUADS:
01624     <span class="keywordflow">case</span> BM_xYxyQUADS:
01625     <span class="keywordflow">case</span> BM_xLabQUADS:
01626 <span class="preprocessor">    #endif</span>
01627 <span class="preprocessor"></span>    <span class="keywordflow">case</span> BM_xG3CHQUADS:
01628     <span class="keywordflow">case</span> BM_KYMCQUADS:
01629     <span class="keywordflow">case</span> BM_CMYKQUADS:
01630     <span class="keywordflow">case</span> BM_10b_RGB:
01631     <span class="keywordflow">case</span> BM_10b_XYZ:
01632     <span class="keywordflow">case</span> BM_10b_Yxy:
01633     <span class="keywordflow">case</span> BM_10b_Lab:
01634     <span class="keywordflow">case</span> BM_10b_G3CH:
01635     <span class="keywordflow">case</span> BM_NAMED_INDEX:
01636         nBytes = dwWidth*4;
01637         <span class="keywordflow">break</span>;
01638 
01639     <span class="comment">//</span>
01640     <span class="comment">// 5 bytes per pixel</span>
01641     <span class="comment">//</span>
01642 
01643     <span class="keywordflow">case</span> BM_5CHANNEL:
01644         nBytes = dwWidth*5;
01645         <span class="keywordflow">break</span>;
01646 
01647     <span class="comment">//</span>
01648     <span class="comment">// 6 bytes per pixel</span>
01649     <span class="comment">//</span>
01650 
01651     <span class="keywordflow">case</span> BM_16b_RGB:
01652     <span class="keywordflow">case</span> BM_16b_XYZ:
01653     <span class="keywordflow">case</span> BM_16b_Yxy:
01654     <span class="keywordflow">case</span> BM_16b_Lab:
01655     <span class="keywordflow">case</span> BM_16b_G3CH:
01656     <span class="keywordflow">case</span> BM_6CHANNEL:
01657         nBytes = dwWidth*6;
01658         <span class="keywordflow">break</span>;
01659 
01660     <span class="comment">//</span>
01661     <span class="comment">// 7 bytes per pixel</span>
01662     <span class="comment">//</span>
01663 
01664     <span class="keywordflow">case</span> BM_7CHANNEL:
01665         nBytes = dwWidth*7;
01666         <span class="keywordflow">break</span>;
01667 
01668     <span class="comment">//</span>
01669     <span class="comment">// 8 bytes per pixel</span>
01670     <span class="comment">//</span>
01671 
01672     <span class="keywordflow">case</span> BM_8CHANNEL:
01673         nBytes = dwWidth*8;
01674         <span class="keywordflow">break</span>;
01675 
01676     <span class="comment">//</span>
01677     <span class="comment">// Error case</span>
01678     <span class="comment">//</span>
01679 
01680     <span class="keywordflow">default</span>:
01681         nBytes = 0;
01682         <span class="keywordflow">break</span>;
01683     }
01684 
01685     <span class="comment">//</span>
01686     <span class="comment">// Align to DWORD boundary</span>
01687     <span class="comment">//</span>
01688 
01689     nBytes = (nBytes + 3) &amp; ~3;
01690 
01691     <span class="keywordflow">return</span> nBytes*dwHeight;
01692 }
01693 
01694 
01695 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
