<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsysini.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsysini.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d3/d8/arccodes_8h-source.html">arccodes.h</a>"</code><br>

<p>
<a href="../../d2/d2/cmsysini_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a0">INIT_SYSTEMROOT_HIVEPATH</a>&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Config\\"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a1">INIT_REGISTRY_MASTERPATH</a>&nbsp;&nbsp;&nbsp;L"\\REGISTRY\\"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a2">SYSTEM_HIVE_INDEX</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a3">CLONE_HIVE_INDEX</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a4">SYSTEM_PATH</a>&nbsp;&nbsp;&nbsp;L"\\registry\\machine\\system"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a5">HKEY_PERFORMANCE_TEXT</a>&nbsp;&nbsp;&nbsp;(( HANDLE ) (ULONG_PTR)((LONG)0x80000050) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a6">HKEY_PERFORMANCE_NLSTEXT</a>&nbsp;&nbsp;&nbsp;(( HANDLE ) (ULONG_PTR)((LONG)0x80000060) )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a7">CMP_KEY_INVALID_ATTRIBUTES</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>&nbsp;&nbsp;&nbsp;128</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a> (IN HANDLE Root, IN PWSTR <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN HANDLE PredefinedHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a31">CmpCreatePerfKeys</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a> (PWSTR <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a2">KeyPath</a>, PWSTR HivePath)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a33">CmpValidateAlternate</a> (IN HANDLE FileHandle, IN <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> PrimaryHive)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a34">CmpCreateControlSet</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a36">CmpCreateObjectTypes</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a37">CmpCreateRegistryRoot</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a38">CmpCreateRootNode</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN PWSTR <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> RootCellIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN PLIST_ENTRY DriverList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a40">CmpInitializeHiveList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a41">CmpInitializeSystemHive</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a> (PWCHAR RegistryValueKey, VOID(*InterlockedFunction)(VOID))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a43">CmpConfigureProcessors</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (IN HANDLE <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, IN <a class="el" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> *ProfileBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a45">CmpAddAliasEntry</a> (IN HANDLE IDConfigDB, IN <a class="el" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> *ProfileBlock, IN ULONG ProfileNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a46">CmpDeleteCloneTree</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a47">CmpDiskFullWarning</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a48">CmInitSystem1</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a49">CmpLinkHiveToMaster</a> (PUNICODE_STRING LinkName, HANDLE RootDirectory, <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive, BOOLEAN Allocate, PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a50">CmpSetVersionData</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PHANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a51">CmGetSystemDriverList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>, IN ULONG HiveFlags, OUT <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *CmHive, IN OUT PBOOLEAN Allocate, IN OUT PBOOLEAN RegistryLocked)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a53">CmpHwprofileDefaultSelect</a> (IN <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList, OUT PULONG ProfileIndexToUse, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a54">CmpSaveBootControlSet</a> (<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> ControlSetNum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a55">CmpDeleteCloneTree</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a56">CmBootLastKnownGood</a> (ULONG ErrorLevel)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a58">CmShutdownSystem</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a9">CmpSystemProcess</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a10">CmpRegistryLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a13">CmFirstTime</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a14">CmpMachineHiveList</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a15">CmpSystemFileName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a16">CmSymbolicLinkValueName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a17">CmpLoadOptions</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PWCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a18">CmpProcessorControl</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PWCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a19">CmpControlSessionManager</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a20">CmpMasterHive</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a21">CmpNoMasterCreates</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a22">CmpHiveListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a23">CmpKeyObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a24">CmpNoWrite</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a25">HvShutdownComplete</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a26">CmpStashBuffer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a27">CmpStashBufferSize</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a28">CmpCannotWriteConfiguration</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/cmsysini_8c.html#a29">nullclass</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="cmsysini.c::CLONE_HIVE_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLONE_HIVE_INDEX&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00064">64</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="cmsysini.c::CMP_KEY_INVALID_ATTRIBUTES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CMP_KEY_INVALID_ATTRIBUTES          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(OBJ_EXCLUSIVE  |\
                                     OBJ_PERMANENT)
</div></pre>
<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00115">115</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="cmsysini.c::HKEY_PERFORMANCE_NLSTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKEY_PERFORMANCE_NLSTEXT&nbsp;&nbsp;&nbsp;(( HANDLE ) (ULONG_PTR)((LONG)0x80000060) )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00072">72</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmsysini.c::HKEY_PERFORMANCE_TEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HKEY_PERFORMANCE_TEXT&nbsp;&nbsp;&nbsp;(( HANDLE ) (ULONG_PTR)((LONG)0x80000050) )          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00071">71</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmsysini.c::INIT_REGISTRY_MASTERPATH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INIT_REGISTRY_MASTERPATH&nbsp;&nbsp;&nbsp;L"\\REGISTRY\\"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00039">39</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="cmsysini.c::INIT_SYSTEMROOT_HIVEPATH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INIT_SYSTEMROOT_HIVEPATH&nbsp;&nbsp;&nbsp;L"\\SystemRoot\\System32\\Config\\"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00037">37</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="cmsysini.c::MAX_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_NAME&nbsp;&nbsp;&nbsp;128          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmsysini.c::SYSTEM_HIVE_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSTEM_HIVE_INDEX&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00063">63</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmsysini.c::SYSTEM_PATH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SYSTEM_PATH&nbsp;&nbsp;&nbsp;L"\\registry\\machine\\system"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00066">66</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a56" doxytag="cmsysini.c::CmBootLastKnownGood" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmBootLastKnownGood           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ErrorLevel</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">3778</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d8/arc_8h-source.html#l00040">ARC_STATUS</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00311">CmFirstTime</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">CmpIsLastKnownGoodBoot()</a>, <a class="el" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>, <a class="el" href="../../d4/d9/ke_8h.html#a411a244">HalRebootRoutine</a>, <a class="el" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>.
<p>
<pre class="fragment"><div>03784                    :
03785 
03786     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to indicate a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> during <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot process.
03787     The actual result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of ErrorLevel:
03788 
03789         IGNORE - Will <span class="keywordflow">return</span>, boot should proceed
03790         NORMAL - Will <span class="keywordflow">return</span>, boot should proceed
03791 
03792         SEVERE - If not booting LastKnownGood, will <span class="keywordflow">switch</span> to LastKnownGood
03793                  and reboot <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
03794 
03795                  If already booting LastKnownGood, will <span class="keywordflow">return</span>.  Boot should
03796                  proceed.
03797 
03798         CRITICAL - If not booting LastKnownGood, will <span class="keywordflow">switch</span> to LastKnownGood
03799                  and reboot <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
03800 
03801                  If already booting LastKnownGood, will bugcheck.
03802 
03803 Arguments:
03804 
03805     ErrorLevel - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> severity level of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
03806 
03807 Return Value:
03808 
03809     None.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns, boot should proceed.  May cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system to
03810     reboot.
03811 
03812 --*/
03813 
03814 {
03815     <a class="code" href="../../d1/d9/arc_8h.html#a44">ARC_STATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03816 
03817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03818 
03819     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a68">CmFirstTime</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03820 
03821         <span class="comment">//</span>
03822         <span class="comment">// NtInitializeRegistry has been called, so handling</span>
03823         <span class="comment">// driver errors is not a task for ScReg.</span>
03824         <span class="comment">// Treat all errors as Normal</span>
03825         <span class="comment">//</span>
03826         <span class="keywordflow">return</span>;
03827     }
03828 
03829     <span class="keywordflow">switch</span> (ErrorLevel) {
03830         <span class="keywordflow">case</span> NormalError:
03831         <span class="keywordflow">case</span> IgnoreError:
03832             <span class="keywordflow">break</span>;
03833 
03834         <span class="keywordflow">case</span> SevereError:
03835             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a>()) {
03836                 <span class="keywordflow">break</span>;
03837             } <span class="keywordflow">else</span> {
03838                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable</a>(<span class="stringliteral">"LastKnownGood"</span>, <span class="stringliteral">"TRUE"</span>);
03839                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
03840                     <a class="code" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware</a>(HalRebootRoutine);
03841                 }
03842             }
03843             <span class="keywordflow">break</span>;
03844 
03845         <span class="keywordflow">case</span> CriticalError:
03846             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d3/cmsysini_8c.html#a57">CmpIsLastKnownGoodBoot</a>()) {
03847                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CRITICAL_SERVICE_FAILED,5,9,0,0);
03848             } <span class="keywordflow">else</span> {
03849                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/hal_8h.html#a168">HalSetEnvironmentVariable</a>(<span class="stringliteral">"LastKnownGood"</span>, <span class="stringliteral">"TRUE"</span>);
03850                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d2/d9/arccodes_8h.html#a24a1">ESUCCESS</a>) {
03851                     <a class="code" href="../../d2/d7/hal_8h.html#a177">HalReturnToFirmware</a>(HalRebootRoutine);
03852                 } <span class="keywordflow">else</span> {
03853                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(SET_ENV_VAR_FAILED,5,10,0,0);
03854                 }
03855             }
03856             <span class="keywordflow">break</span>;
03857     }
03858     <span class="keywordflow">return</span>;
03859 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="cmsysini.c::CmGetSystemDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PHANDLE CmGetSystemDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">2169</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l01082">CmpFindControlSet()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00333">CmpFindDrivers()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02380">CmpFreeDriverList()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00920">CmpResolveDriverDependencies()</a>, <a class="el" href="../../d1/d9/cmboot_8c-source.html#l00744">CmpSortDriverList()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00067">DriverEntry()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>.
<p>
<pre class="fragment"><div>02175                    :
02176 
02177     Traverses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current SERVICES subtree and creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of drivers
02178     to be loaded during Phase 1 initialization.
02179 
02180 Arguments:
02181 
02182     None
02183 
02184 Return Value:
02185 
02186     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to an array of handles, each of which refers to a key in
02187     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> \Services section of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.  The caller will traverse
02188     <span class="keyword">this</span> array and load and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drivers described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys.
02189 
02190     The last key will be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.  The array <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated in Pool and should
02191     be freed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
02192 
02193 --*/
02194 
02195 {
02196     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02197     HANDLE SystemHandle;
02198     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
02199     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02200     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
02201     LIST_ENTRY DriverList;
02202     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02203     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCell;
02204     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlCell;
02205     ULONG DriverCount;
02206     PLIST_ENTRY Current;
02207     PHANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
02208     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
02209     BOOLEAN Success;
02210     BOOLEAN AutoSelect;
02211 
02212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02213     InitializeListHead(&amp;DriverList);
02214     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name,
02215                          L<span class="stringliteral">"\\Registry\\Machine\\System"</span>);
02216 
02217     InitializeObjectAttributes(&amp;ObjectAttributes,
02218                                &amp;Name,
02219                                OBJ_CASE_INSENSITIVE,
02220                                (HANDLE)NULL,
02221                                NULL);
02222     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SystemHandle,
02223                        KEY_READ,
02224                        &amp;ObjectAttributes);
02225 
02226     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02227         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02228             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't open registry key %wZ\n"</span>,&amp;Name));
02229             KdPrint((<span class="stringliteral">"CM:     status %08lx\n"</span>, Status));
02230         }
02231         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02232     }
02233 
02234 
02235     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( SystemHandle,
02236                                         KEY_QUERY_VALUE,
02237                                         CmpKeyObjectType,
02238                                         KernelMode,
02239                                         (PVOID *)(&amp;KeyBody),
02240                                         NULL );
02241     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02242         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02243             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't dereference Systemhandle\n"</span>));
02244             KdPrint((<span class="stringliteral">"CM:     status %08lx\n"</span>, Status));
02245         }
02246         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02247         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02248     }
02249 
02250     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02251 
02252     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
02253     RootCell = KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">// Now we have found out the PHHIVE and HCELL_INDEX of the root of the</span>
02257     <span class="comment">// SYSTEM hive, we can use all the same code that the OS Loader does.</span>
02258     <span class="comment">//</span>
02259 
02260     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, L<span class="stringliteral">"Current"</span>);
02261     ControlCell = <a class="code" href="../../d1/d2/cmp_8h.html#a296">CmpFindControlSet</a>(Hive,
02262                                     RootCell,
02263                                     &amp;Name,
02264                                     &amp;AutoSelect);
02265     <span class="keywordflow">if</span> (ControlCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
02266         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02267             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't find control set\n"</span>));
02268         }
02269         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02270         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02271         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02272         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02273     }
02274 
02275     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a297">CmpFindDrivers</a>(Hive,
02276                              ControlCell,
02277                              SystemLoad,
02278                              NULL,
02279                              &amp;DriverList);
02280 
02281 
02282     <span class="keywordflow">if</span> (!Success) {
02283         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02284             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't find any valid drivers\n"</span>));
02285         }
02286         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(Hive, &amp;DriverList);
02287         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02288         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02289         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02290         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02291     }
02292 
02293     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a302">CmpSortDriverList</a>(Hive,
02294                            ControlCell,
02295                            &amp;DriverList)) {
02296         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02297             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't sort driver list\n"</span>));
02298         }
02299         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(Hive, &amp;DriverList);
02300         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02301         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02302         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02303         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02304     }
02305 
02306     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d2/cmp_8h.html#a301">CmpResolveDriverDependencies</a>(&amp;DriverList)) {
02307         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02308             KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't resolve driver dependencies\n"</span>));
02309         }
02310         <a class="code" href="../../d1/d3/cmsysini_8c.html#a39">CmpFreeDriverList</a>(Hive, &amp;DriverList);
02311         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02312         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02313         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02314         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02315     }
02316     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02317     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
02318     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SystemHandle);
02319 
02320     <span class="comment">//</span>
02321     <span class="comment">// We now have a fully sorted and ordered list of drivers to be loaded</span>
02322     <span class="comment">// by IoInit.</span>
02323     <span class="comment">//</span>
02324 
02325     <span class="comment">//</span>
02326     <span class="comment">// Count the nodes in the list.</span>
02327     <span class="comment">//</span>
02328     Current = DriverList.Flink;
02329     DriverCount = 0;
02330     <span class="keywordflow">while</span> (Current != &amp;DriverList) {
02331         ++DriverCount;
02332         Current = Current-&gt;Flink;
02333     }
02334 
02335     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (PHANDLE)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool,
02336                                      (DriverCount+1) * <span class="keyword">sizeof</span>(HANDLE));
02337 
02338     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02339         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,5,8,0,0); <span class="comment">// odds against this are huge</span>
02340     }
02341 
02342     <span class="comment">//</span>
02343     <span class="comment">// Walk the list, opening each registry key and adding it to the</span>
02344     <span class="comment">// table of handles.</span>
02345     <span class="comment">//</span>
02346     Current = DriverList.Flink;
02347     DriverCount = 0;
02348     <span class="keywordflow">while</span> (Current != &amp;DriverList) {
02349         <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = CONTAINING_RECORD(Current,
02350                                         <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">BOOT_DRIVER_LIST_ENTRY</a>,
02351                                         Link);
02352 
02353         InitializeObjectAttributes(&amp;ObjectAttributes,
02354                                    &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath,
02355                                    OBJ_CASE_INSENSITIVE,
02356                                    (HANDLE)NULL,
02357                                    NULL);
02358 
02359         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(Handle+DriverCount,
02360                            KEY_READ | KEY_WRITE,
02361                            &amp;ObjectAttributes);
02362         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02363             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02364                 KdPrint((<span class="stringliteral">"CM: CmGetSystemDriverList couldn't open driver "</span>));
02365                 KdPrint((<span class="stringliteral">"key %wZ\n"</span>, &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath));
02366                 KdPrint((<span class="stringliteral">"    status %08lx\n"</span>,Status));
02367             }
02368         } <span class="keywordflow">else</span> {
02369             ++DriverCount;
02370         }
02371         Current = Current-&gt;Flink;
02372     }
02373     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>[DriverCount] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02374 
02375     <span class="keywordflow">return</span>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02376 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="cmsysini.c::CmInitSystem1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmInitSystem1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">293</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00064">CLONE_HIVE_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01609">_HIVE_LIST_ENTRY::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00293">CmpComputeGlobalQuotaAllowed()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">CmpCreateObjectTypes()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00027">CmpHiveListHead</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l01512">CmpInitializeCache()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00087">CmpInitializeHardwareConfiguration()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d0/config_2ppc_2init_8c-source.html#l00033">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d1/d0/cmdatini_8c-source.html#l00089">CmpInitializeRegistryNames()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00229">CmpKcbLock</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00043">CmpLoadOptions</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00250">CmpMachineHiveList</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00276">CmpNoMasterCreates</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00642">CmpPostLock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01174">CmpRegistryLock</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00032">CmpStashBuffer</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00033">CmpStashBufferSize</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00050">CmpSystemProcess</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00168">CmRegistryMachineHardwareName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00167">CmRegistryMachineName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00186">CmRegistrySystemCloneName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00185">CmRegistryUserName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00159">nullclass</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00298                    :
00299 
00300     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as part of phase1 init, after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00301     manager has been inited, but before IoInit.  It's purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00302     set up basic registry object operations, and transform data
00303     captured during boot into registry <a class="code" href="../../d8/d3/rtvbatcr_8c.html#a8">format</a> (whether it was read
00304     from the SYSTEM hive file by the osloader or computed by recognizers.)
00305     After <span class="keyword">this</span> call, Nt*Key calls work, but only part of the name
00306     space is available and any changes written must be held in
00307     memory.
00308 
00309     CmpMachineHiveList entries marked CM_PHASE_1 are available
00310     after <span class="keywordflow">return</span> from <span class="keyword">this</span> call, but writes must be held in memory.
00311 
00312     This function will:
00313 
00314         1.  Create the regisrty worker/lazy-write thread
00315         2.  Create the registry key object type
00316         4.  Create the master hive
00317         5.  Create the \REGISTRY node
00318         6.  Create a KEY object that refers to \REGISTRY
00319         7.  Create \REGISTRY\MACHINE node
00320         8.  Create the SYSTEM hive, fill in with data from loader
00321         9.  Create the HARDWARE hive, fill in with data from loader
00322        10.  Create:
00323                 \REGISTRY\MACHINE\SYSTEM
00324                 \REGISTRY\MACHINE\HARDWARE
00325                 Both of which will be link nodes in the master hive.
00326 
00327     NOTE:   We <span class="keywordflow">do</span> NOT free allocated pool in failure <span class="keywordflow">case</span>.  This is because
00328             our caller is going to bugcheck anyway, and having the memory
00329             object to look at is useful.
00330 
00331 Arguments:
00332 
00333     LoaderBlock - supplies the LoaderBlock passed in from the OSLoader.
00334         By looking through the memory descriptor list we can find the
00335         SYSTEM hive which the OSLoader has placed in memory <span class="keywordflow">for</span> us.
00336 
00337 Return Value:
00338 
00339     TRUE <span class="keywordflow">if</span> all operations were successful, <span class="keyword">false</span> <span class="keywordflow">if</span> any failed.
00340 
00341     Bugchecks when something went wrong (CONFIG_INITIALIZATION_FAILED,4,.....)
00342 
00343 --*/
00344 {
00345     HANDLE  key1;
00346     OBJECT_ATTRIBUTES ObjectAttributes;
00347     NTSTATUS    status;
00348     NTSTATUS    status2;
00349     PSECURITY_DESCRIPTOR SecurityDescriptor;
00350     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> HardwareHive;
00351     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CloneHive;
00352     UNICODE_STRING NameString;
00353 
00354     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00355     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) KdPrint((<span class="stringliteral">"CmInitSystem1\n"</span>));
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Initialize Names of all registry paths.</span>
00359     <span class="comment">// This simply initializes unicode strings so we don't have to bother</span>
00360     <span class="comment">// with it later. This can not fail.</span>
00361     <span class="comment">//</span>
00362     <a class="code" href="../../d1/d2/cmp_8h.html#a277">CmpInitializeRegistryNames</a>();
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// Compute registry global quota</span>
00366     <span class="comment">//</span>
00367     <a class="code" href="../../d1/d2/cmp_8h.html#a246">CmpComputeGlobalQuotaAllowed</a>();
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">// Initialize the hive list head</span>
00371     <span class="comment">//</span>
00372     InitializeListHead(&amp;CmpHiveListHead);
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">// Initialize the global registry resource</span>
00376     <span class="comment">//</span>
00377     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>(&amp;CmpRegistryLock);
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">// Initialize the KCB tree mutex</span>
00381     <span class="comment">//</span>
00382     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;CmpKcbLock);
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Initialize the PostList mutex</span>
00386     <span class="comment">//</span>
00387     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;CmpPostLock);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// Initialize the cache</span>
00391     <span class="comment">//</span>
00392     CmpInitializeCache ();
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">// Save the current process to allow us to attach to it later.</span>
00396     <span class="comment">//</span>
00397     CmpSystemProcess = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb;
00398 
00399     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// Create the Key object type.</span>
00403     <span class="comment">//</span>
00404     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a36">CmpCreateObjectTypes</a>()) {
00405         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00406             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpCreateObjectTypes failed\n"</span>));
00407         }
00408         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,1,0,0); <span class="comment">// could not registrate with object manager</span>
00409         <span class="keywordflow">return</span> FALSE;
00410     }
00411 
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">// Create the master hive and initialize it.</span>
00415     <span class="comment">//</span>
00416     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;CmpMasterHive,
00417                 HINIT_CREATE,
00418                 HIVE_VOLATILE,
00419                 HFILE_TYPE_PRIMARY,     <span class="comment">// i.e. no logging, no alterate</span>
00420                 NULL,
00421                 NULL,
00422                 NULL,
00423                 NULL,
00424                 NULL,
00425                 NULL);
00426     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00427         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00428             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpInitializeHive(master) failed\n"</span>));
00429         }
00430         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,2,0,0); <span class="comment">// could not initialize master hive</span>
00431         <span class="keywordflow">return</span> (FALSE);
00432     }
00433 
00434     <span class="comment">//</span>
00435     <span class="comment">// try to allocate a stash buffer.  if we can't get 1 page this</span>
00436     <span class="comment">// early on, we're in deep trouble, so punt.</span>
00437     <span class="comment">//</span>
00438     CmpStashBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, HBLOCK_SIZE,'bSmC');
00439     <span class="keywordflow">if</span> (CmpStashBuffer == NULL) {
00440         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,3,0,0); <span class="comment">// odds against this are huge</span>
00441         <span class="keywordflow">return</span> FALSE;
00442     }
00443     CmpStashBufferSize = HBLOCK_SIZE;
00444 
00445     <span class="comment">//</span>
00446     <span class="comment">// Create the \REGISTRY node</span>
00447     <span class="comment">//</span>
00448     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a37">CmpCreateRegistryRoot</a>()) {
00449         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00450             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpCreateRegistryRoot failed\n"</span>));
00451         }
00452         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,4,0,0); <span class="comment">// could not create root of the registry</span>
00453         <span class="keywordflow">return</span> FALSE;
00454     }
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// --- 6. Create \REGISTRY\MACHINE and \REGISTRY\USER nodes ---</span>
00458     <span class="comment">//</span>
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// Get default security descriptor for the nodes we will create.</span>
00462     <span class="comment">//</span>
00463     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
00464 
00465     InitializeObjectAttributes(
00466         &amp;ObjectAttributes,
00467         &amp;CmRegistryMachineName,
00468         OBJ_CASE_INSENSITIVE,
00469         (HANDLE)NULL,
00470         SecurityDescriptor
00471         );
00472 
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00474                         &amp;key1,
00475                         KEY_READ | KEY_WRITE,
00476                         &amp;ObjectAttributes,
00477                         0,
00478                         &amp;nullclass,
00479                         0,
00480                         NULL
00481         )))
00482     {
00483         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00484         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00485             KdPrint((<span class="stringliteral">"CmInitSystem1: NtCreateKey(MACHINE) failed\n"</span>));
00486         }
00487         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,5,0,0); <span class="comment">// could not create HKLM</span>
00488         <span class="keywordflow">return</span> FALSE;
00489     }
00490 
00491     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00492 
00493     InitializeObjectAttributes(
00494         &amp;ObjectAttributes,
00495         &amp;CmRegistryUserName,
00496         OBJ_CASE_INSENSITIVE,
00497         (HANDLE)NULL,
00498         SecurityDescriptor
00499         );
00500 
00501     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00502                         &amp;key1,
00503                         KEY_READ | KEY_WRITE,
00504                         &amp;ObjectAttributes,
00505                         0,
00506                         &amp;nullclass,
00507                         0,
00508                         NULL
00509         )))
00510     {
00511         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00512         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00513             KdPrint((<span class="stringliteral">"CmInitSystem1: NtCreateKey(USER) failed\n"</span>));
00514         }
00515         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,6,0,0); <span class="comment">// could not create HKUSER</span>
00516         <span class="keywordflow">return</span> FALSE;
00517     }
00518 
00519     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00520 
00521 
00522     <span class="comment">//</span>
00523     <span class="comment">// --- 7. Create the SYSTEM hive, fill in with data from loader ---</span>
00524     <span class="comment">//</span>
00525     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a41">CmpInitializeSystemHive</a>(LoaderBlock)) {
00526         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00527         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00528             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00529             KdPrint((<span class="stringliteral">"Hive allocation failure for SYSTEM\n"</span>));
00530         }
00531         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,7,0,0); <span class="comment">// could not create SystemHive</span>
00532         <span class="keywordflow">return</span>(FALSE);
00533     }
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Create the symbolic link \Registry\Machine\System\CurrentControlSet</span>
00537     <span class="comment">//</span>
00538     status = <a class="code" href="../../d1/d3/cmsysini_8c.html#a34">CmpCreateControlSet</a>(LoaderBlock);
00539     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00540         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,8,0,0); <span class="comment">// could not create CurrentControlSet</span>
00541         <span class="keywordflow">return</span>(FALSE);
00542     }
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">// Handle the copying of the CurrentControlSet to a Clone volatile</span>
00546     <span class="comment">// hive (but only if we really want to have a clone)</span>
00547     <span class="comment">//</span>
00548 
00549 #<span class="keywordflow">if</span> CLONE_CONTROL_SET
00550 
00551     <span class="comment">//</span>
00552     <span class="comment">// Create the Clone temporary hive, link it into the master hive,</span>
00553     <span class="comment">// and make a symbolic link to it.</span>
00554     <span class="comment">//</span>
00555     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;CloneHive,
00556                 HINIT_CREATE,
00557                 HIVE_VOLATILE,
00558                 HFILE_TYPE_PRIMARY,
00559                 NULL,
00560                 NULL,
00561                 NULL,
00562                 NULL,
00563                 NULL,
00564                 NULL);
00565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00566         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00567             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00568             KdPrint((<span class="stringliteral">"Could not initialize CLONE hive\n"</span>));
00569         }
00570         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,9,0,0); <span class="comment">// could not initialize clone hive</span>
00571         <span class="keywordflow">return</span>(FALSE);
00572     }
00573 
00574     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00575             &amp;CmRegistrySystemCloneName,
00576             NULL,
00577             CloneHive,
00578             TRUE,
00579             SecurityDescriptor
00580             ) != STATUS_SUCCESS)
00581     {
00582         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00583             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Clone) failed\n"</span>));
00584         }
00585         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,10,0,0); <span class="comment">// could not link clone hive to master hive</span>
00586         <span class="keywordflow">return</span> FALSE;
00587     }
00588     <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(CloneHive);
00589     CmpMachineHiveList[CLONE_HIVE_INDEX].CmHive = CloneHive;
00590 
00591     <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
00592         L<span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>,
00593         L<span class="stringliteral">"\\Registry\\Machine\\CLONE\\CLONE"</span>
00594         );
00595 
00596 
00597     <span class="comment">//</span>
00598     <span class="comment">// Clone the current control set for the service controller</span>
00599     <span class="comment">//</span>
00600     status = <a class="code" href="../../d1/d3/cmsysini_8c.html#a35">CmpCloneControlSet</a>();
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// If this didn't work, it's bad, but not bad enough to fail the boot</span>
00604     <span class="comment">//</span>
00605     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00606 
00607 #endif
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// --- 8. Create the HARDWARE hive, fill in with data from loader ---</span>
00611     <span class="comment">//</span>
00612     status = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;HardwareHive,
00613                 HINIT_CREATE,
00614                 HIVE_VOLATILE,
00615                 HFILE_TYPE_PRIMARY,     <span class="comment">// i.e. no log, no alternate</span>
00616                 NULL,
00617                 NULL,
00618                 NULL,
00619                 NULL,
00620                 NULL,
00621                 NULL);
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00624         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00625             KdPrint((<span class="stringliteral">"CmpInitSystem1: "</span>));
00626             KdPrint((<span class="stringliteral">"Could not initialize HARDWARE hive\n"</span>));
00627         }
00628         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,11,0,0); <span class="comment">// could not initialize hardware hive</span>
00629         <span class="keywordflow">return</span>(FALSE);
00630     }
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">// Allocate the root node</span>
00634     <span class="comment">//</span>
00635     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00636             &amp;CmRegistryMachineHardwareName,
00637             NULL,
00638             HardwareHive,
00639             TRUE,
00640             SecurityDescriptor
00641             ) != STATUS_SUCCESS)
00642     {
00643         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
00644             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Hardware) failed\n"</span>));
00645         }
00646         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,12,0,0); <span class="comment">// could not link hardware hive to master hive</span>
00647         <span class="keywordflow">return</span> FALSE;
00648     }
00649     <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(HardwareHive);
00650 
00651     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
00652 
00653     CmpMachineHiveList[0].CmHive = HardwareHive;
00654 
00655     <span class="comment">//</span>
00656     <span class="comment">// put loader configuration tree data to our hardware registry.</span>
00657     <span class="comment">//</span>
00658     status = <a class="code" href="../../d1/d2/cmp_8h.html#a272">CmpInitializeHardwareConfiguration</a>(LoaderBlock);
00659 
00660     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00661         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,13,0,0); <span class="comment">// could not initialize hardware configuration</span>
00662         <span class="keywordflow">return</span>(FALSE);
00663     }
00664 
00665     CmpNoMasterCreates = TRUE;
00666     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00667 
00668     <span class="comment">//</span>
00669     <span class="comment">// put machine dependant configuration data to our hardware registry.</span>
00670     <span class="comment">//</span>
00671     status = <a class="code" href="../../d6/d1/config_2ppc_2init_8c.html#a0">CmpInitializeMachineDependentConfiguration</a>(LoaderBlock);
00672 
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// store boot loader command tail in registry</span>
00676     <span class="comment">//</span>
00677     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00678         &amp;NameString,
00679         L<span class="stringliteral">"\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\Control"</span>
00680         );
00681 
00682     InitializeObjectAttributes(
00683         &amp;ObjectAttributes,
00684         &amp;NameString,
00685         OBJ_CASE_INSENSITIVE,
00686         (HANDLE)NULL,
00687         NULL
00688         );
00689 
00690     status2 = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00691                 &amp;key1,
00692                 KEY_WRITE,
00693                 &amp;ObjectAttributes
00694                 );
00695 
00696     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status2)) {
00697         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00698             &amp;NameString,
00699             L<span class="stringliteral">"SystemStartOptions"</span>
00700             );
00701 
00702         <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00703             key1,
00704             &amp;NameString,
00705             0,              <span class="comment">// TitleIndex</span>
00706             REG_SZ,
00707             <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer,
00708             <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length
00709             );
00710 
00711         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
00712     }
00713     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer);
00714 
00715 
00716     if (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00717         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,4,14,0,0); <span class="comment">// could not open CurrentControlSet\\Control</span>
00718         <span class="keywordflow">return</span>(FALSE);
00719     }
00720 
00721     <span class="keywordflow">return</span> TRUE;
00722 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="cmsysini.c::CmpAddAliasEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAddAliasEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>IDConfigDB</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">2606</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01572">CM_HARDWARE_PROFILE_STR_ALIAS</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01584">CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>.
<p>
<pre class="fragment"><div>02612                    :
02613     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> an alias entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IDConfigDB database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given
02614     hardware profile.
02615 
02616     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"Alias"</span> key <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
02617 
02618 Parameters:
02619 
02620     IDConfigDB - Pointer to <span class="stringliteral">"..\CurrentControlSet\Control\IDConfigDB"</span>
02621 
02622     ProfileBlock - <a class="code" href="../../d4/d9/heapdbg_8c.html#a4">Description</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Docking information
02623 
02624     ProfileNumber -
02625 
02626 --*/
02627 {
02628     OBJECT_ATTRIBUTES attributes;
02629     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS;
02630     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>            asciiBuffer [128];
02631     WCHAR           unicodeBuffer [128];
02632     ANSI_STRING     ansiString;
02633     UNICODE_STRING  name;
02634     HANDLE          aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02635     HANDLE          aliasEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02636     ULONG           value;
02637     ULONG           disposition;
02638     ULONG           aliasNumber = 0;
02639 
02640     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02641 
02642     <span class="comment">//</span>
02643     <span class="comment">// Find the Alias Key or Create it if it does not already exist.</span>
02644     <span class="comment">//</span>
02645     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name,CM_HARDWARE_PROFILE_STR_ALIAS);
02646 
02647     InitializeObjectAttributes (&amp;attributes,
02648                                 &amp;name,
02649                                 OBJ_CASE_INSENSITIVE,
02650                                 IDConfigDB,
02651                                 NULL);
02652 
02653     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasKey,
02654                         KEY_READ | KEY_WRITE,
02655                         &amp;attributes);
02656 
02657     <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
02658         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasKey,
02659                               KEY_READ | KEY_WRITE,
02660                               &amp;attributes,
02661                               0, <span class="comment">// no title</span>
02662                               NULL, <span class="comment">// no class</span>
02663                               0, <span class="comment">// no options</span>
02664                               &amp;disposition);
02665     }
02666 
02667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02668         aliasKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02669         <span class="keywordflow">goto</span> Exit;
02670     }
02671 
02672     <span class="comment">//</span>
02673     <span class="comment">// Create an entry key</span>
02674     <span class="comment">//</span>
02675 
02676     <span class="keywordflow">while</span> (aliasNumber &lt; 200) {
02677         aliasNumber++;
02678 
02679         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(asciiBuffer, <span class="stringliteral">"%04d"</span>, aliasNumber);
02680 
02681         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, asciiBuffer);
02682         name.MaximumLength = <span class="keyword">sizeof</span>(unicodeBuffer);
02683         name.Buffer = unicodeBuffer;
02684         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;name,
02685                                               &amp;ansiString,
02686                                               FALSE);
02687         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == status);
02688 
02689         InitializeObjectAttributes(&amp;attributes,
02690                                    &amp;name,
02691                                    OBJ_CASE_INSENSITIVE,
02692                                    aliasKey,
02693                                    NULL);
02694 
02695         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;aliasEntry,
02696                             KEY_READ | KEY_WRITE,
02697                             &amp;attributes);
02698 
02699         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02700             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
02701 
02702         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (STATUS_OBJECT_NAME_NOT_FOUND == status) {
02703             status = STATUS_SUCCESS;
02704             <span class="keywordflow">break</span>;
02705 
02706         } <span class="keywordflow">else</span> {
02707             <span class="keywordflow">break</span>;
02708         }
02709 
02710     }
02711     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02712         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02713             KdPrint((<span class="stringliteral">"CM: cmpCreateAliasEntry error finding new set %08lx\n"</span>,
02714                      status));
02715         }
02716         aliasEntry = 0;
02717         <span class="keywordflow">goto</span> Exit;
02718     }
02719 
02720     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;aliasEntry,
02721                           KEY_READ | KEY_WRITE,
02722                           &amp;attributes,
02723                           0,
02724                           NULL,
02725                           0,
02726                           &amp;disposition);
02727 
02728     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02729         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02730             KdPrint((<span class="stringliteral">"CM: cmpCreateAliasEntry error creating new set %08lx\n"</span>,
02731                      status));
02732         }
02733         aliasEntry = 0;
02734         <span class="keywordflow">goto</span> Exit;
02735     }
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// Write the standard goo</span>
02739     <span class="comment">//</span>
02740     <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (aliasEntry, ProfileBlock);
02741 
02742     <span class="comment">//</span>
02743     <span class="comment">// Write the Profile Number</span>
02744     <span class="comment">//</span>
02745     value = ProfileNumber;
02746     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_PROFILE_NUMBER);
02747     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (aliasEntry,
02748                             &amp;name,
02749                             0,
02750                             REG_DWORD,
02751                             &amp;value,
02752                             <span class="keyword">sizeof</span> (value));
02753 
02754 Exit:
02755 
02756     <span class="keywordflow">if</span> (aliasKey) {
02757         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasKey);
02758     }
02759 
02760     <span class="keywordflow">if</span> (aliasEntry) {
02761         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (aliasEntry);
02762     }
02763 
02764     <span class="keywordflow">return</span> status;
02765 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="cmsysini.c::CmpAddDockingInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpAddDockingInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__PROFILE__PARAMETER__BLOCK.html">PROFILE_PARAMETER_BLOCK</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">2532</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l01580">CM_HARDWARE_PROFILE_STR_CAPABILITIES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01581">CM_HARDWARE_PROFILE_STR_DOCKID</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01579">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01582">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>.
<p>
<pre class="fragment"><div>02537                    :
02538     Write DockID SerialNumber DockState and Capabilities intot <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given
02539     registry key.
02540 
02541 --*/
02542 {
02543     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02544     UNICODE_STRING name;
02545     ULONG value;
02546 
02547     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02548 
02549     value = ProfileBlock-&gt;DockingState;
02550     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
02551     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (Key,
02552                             &amp;name,
02553                             0,
02554                             REG_DWORD,
02555                             &amp;value,
02556                             <span class="keyword">sizeof</span> (value));
02557 
02558     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02559         <span class="keywordflow">return</span> status;
02560     }
02561 
02562     value = ProfileBlock-&gt;Capabilities;
02563     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_CAPABILITIES);
02564     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (Key,
02565                             &amp;name,
02566                             0,
02567                             REG_DWORD,
02568                             &amp;value,
02569                             <span class="keyword">sizeof</span> (value));
02570 
02571     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02572         <span class="keywordflow">return</span> status;
02573     }
02574 
02575     value = ProfileBlock-&gt;DockID;
02576     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_DOCKID);
02577     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (Key,
02578                             &amp;name,
02579                             0,
02580                             REG_DWORD,
02581                             &amp;value,
02582                             <span class="keyword">sizeof</span> (value));
02583 
02584     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02585         <span class="keywordflow">return</span> status;
02586     }
02587 
02588     value = ProfileBlock-&gt;SerialNumber;
02589     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;name, CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER);
02590     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (Key,
02591                             &amp;name,
02592                             0,
02593                             REG_DWORD,
02594                             &amp;value,
02595                             <span class="keyword">sizeof</span> (value));
02596 
02597     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
02598         <span class="keywordflow">return</span> status;
02599     }
02600 
02601     <span class="keywordflow">return</span> status;
02602 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="cmsysini.c::CmpCloneControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCloneControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">3262</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01314">CmpCopyTree</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>03268                    :
03269 
03270     First, create a <span class="keyword">new</span> hive, \registry\machine\clone, which will be
03271     <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>.
03272 
03273     Second, link \Registry\Machine\System\Clone to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
03274 
03275     Third, tree copy \Registry\Machine\System\CurrentControlSet into
03276     \Registry\Machine\System\Clone (and thus into the clone hive.)
03277 
03278     When the service controller is done with the clone hive, it can
03279     simply NtUnloadKey it to free its storage.
03280 
03281 Arguments:
03282 
03283     None.  \Registry\Machine\System\CurrentControlSet must already exist.
03284 
03285 Return Value:
03286 
03287     NTSTATUS
03288 
03289 --*/
03290 
03291 {
03292     UNICODE_STRING Current;
03293     UNICODE_STRING Clone;
03294     HANDLE CurrentHandle;
03295     HANDLE CloneHandle;
03296     OBJECT_ATTRIBUTES Attributes;
03297     NTSTATUS Status;
03298     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> CurrentKey;
03299     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> CloneKey;
03300     ULONG Disposition;
03301     PSECURITY_DESCRIPTOR Security;
03302     ULONG SecurityLength;
03303 
03304     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03305 
03306     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Current,
03307                          L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet"</span>);
03308     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Clone,
03309                          L<span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>);
03310 
03311     InitializeObjectAttributes(&amp;Attributes,
03312                                &amp;Current,
03313                                OBJ_CASE_INSENSITIVE,
03314                                NULL,
03315                                NULL);
03316     Status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;CurrentHandle,
03317                        KEY_READ,
03318                        &amp;Attributes);
03319     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03320         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03321             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet couldn't open CurrentControlSet %08lx\n"</span>,Status));
03322         }
03323         <span class="keywordflow">return</span>(Status);
03324     }
03325 
03326     <span class="comment">//</span>
03327     <span class="comment">// Get the security descriptor from the key so we can create the clone</span>
03328     <span class="comment">// tree with the correct ACL.</span>
03329     <span class="comment">//</span>
03330     Status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(CurrentHandle,
03331                                    DACL_SECURITY_INFORMATION,
03332                                    NULL,
03333                                    0,
03334                                    &amp;SecurityLength);
03335     <span class="keywordflow">if</span> (Status==STATUS_BUFFER_TOO_SMALL) {
03336         Security=<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,SecurityLength);
03337         <span class="keywordflow">if</span> (Security!=NULL) {
03338             Status = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(CurrentHandle,
03339                                            DACL_SECURITY_INFORMATION,
03340                                            Security,
03341                                            SecurityLength,
03342                                            &amp;SecurityLength);
03343             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03344                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03345                     KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet - NtQuerySecurityObject failed %08lx\n"</span>,Status));
03346                 }
03347                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03348                 Security=NULL;
03349             }
03350         }
03351     } <span class="keywordflow">else</span> {
03352         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03353             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet - NtQuerySecurityObject returned %08lx\n"</span>,Status));
03354         }
03355         Security=NULL;
03356     }
03357 
03358     InitializeObjectAttributes(&amp;Attributes,
03359                                &amp;Clone,
03360                                OBJ_CASE_INSENSITIVE,
03361                                NULL,
03362                                Security);
03363     Status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CloneHandle,
03364                          KEY_READ | KEY_WRITE,
03365                          &amp;Attributes,
03366                          0,
03367                          NULL,
03368                          REG_OPTION_VOLATILE,
03369                          &amp;Disposition);
03370     <span class="keywordflow">if</span> (Security!=NULL) {
03371         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03372     }
03373     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03374         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03375             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet couldn't create Clone %08lx\n"</span>,Status));
03376         }
03377         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
03378         <span class="keywordflow">return</span>(Status);
03379     }
03380 
03381     <span class="comment">//</span>
03382     <span class="comment">// Check to make sure the key was created.  If it already exists,</span>
03383     <span class="comment">// something is wrong.</span>
03384     <span class="comment">//</span>
03385     <span class="keywordflow">if</span> (Disposition != REG_CREATED_NEW_KEY) {
03386         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03387         <span class="comment">//  KdPrint(("CM: CmpCloneControlSet: Clone tree already exists!\n"));</span>
03388         }
03389 
03390         <span class="comment">//</span>
03391         <span class="comment">// WARNNOTE:</span>
03392         <span class="comment">//      If somebody somehow managed to create a key in our way,</span>
03393         <span class="comment">//      they'll thwart last known good.  Tough luck.</span>
03394         <span class="comment">//      Claim it worked and go on.</span>
03395         <span class="comment">//</span>
03396         Status = STATUS_SUCCESS;
03397         <span class="keywordflow">goto</span> Exit;
03398     }
03399 
03400     Status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CurrentHandle,
03401                                        KEY_READ,
03402                                        CmpKeyObjectType,
03403                                        KernelMode,
03404                                        (PVOID *)(&amp;CurrentKey),
03405                                        NULL);
03406     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03407         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03408             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: couldn't reference CurrentHandle %08lx\n"</span>,Status));
03409         }
03410         <span class="keywordflow">goto</span> Exit;
03411     }
03412 
03413     Status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(CloneHandle,
03414                                        KEY_WRITE,
03415                                        CmpKeyObjectType,
03416                                        KernelMode,
03417                                        (PVOID *)(&amp;CloneKey),
03418                                        NULL);
03419     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03420         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03421             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: couldn't reference CurrentHandle %08lx\n"</span>,Status));
03422         }
03423         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CurrentKey);
03424         <span class="keywordflow">goto</span> Exit;
03425     }
03426 
03427     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03428 
03429     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a118">CmpCopyTree</a>(CurrentKey-&gt;KeyControlBlock-&gt;KeyHive,
03430                     CurrentKey-&gt;KeyControlBlock-&gt;KeyCell,
03431                     CloneKey-&gt;KeyControlBlock-&gt;KeyHive,
03432                     CloneKey-&gt;KeyControlBlock-&gt;KeyCell)) {
03433         <span class="comment">//</span>
03434         <span class="comment">// Set the max subkey name property for the new target key.</span>
03435         <span class="comment">//</span>
03436         CloneKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen = CurrentKey-&gt;KeyControlBlock-&gt;KeyNode-&gt;MaxNameLen;
03437         Status = STATUS_SUCCESS;
03438     } <span class="keywordflow">else</span> {
03439         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03440             KdPrint((<span class="stringliteral">"CM: CmpCloneControlSet: tree copy failed.\n"</span>));
03441         }
03442         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
03443     }
03444 
03445     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03446 
03447     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CurrentKey);
03448     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)CloneKey);
03449 
03450 Exit:
03451     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
03452     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CloneHandle);
03453     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03454 
03455 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="cmsysini.c::CmpConfigureProcessors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpConfigureProcessors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01986">1986</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d7/d8/kernlini_8c-source.html#l01998">KeOptimizeProcessorControlState()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01153">KeRevertToUserAffinityThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01467">KeSetSystemAffinityThread()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.
<p>
<pre class="fragment"><div>01991                    :
01992 
01993     Set each processor to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s optimal settings <span class="keywordflow">for</span> NT.
01994 
01995 --*/
01996 {
01997     ULONG   i;
01998 
01999     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02000 
02001     <span class="comment">//</span>
02002     <span class="comment">// Set each processor into its best NT configuration</span>
02003     <span class="comment">//</span>
02004 
02005     <span class="keywordflow">for</span> (i=0; i &lt; (ULONG)<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>; i++) {
02006         <a class="code" href="../../d9/d1/thredobj_8c.html#a19">KeSetSystemAffinityThread</a>((KAFFINITY) 1 &lt;&lt; i);
02007 
02008 <span class="preprocessor">#if i386</span>
02009 <span class="preprocessor"></span>        <span class="comment">// for now x86 only</span>
02010         <a class="code" href="../../d6/d9/kernlini_8c.html#a60">KeOptimizeProcessorControlState</a> ();
02011 <span class="preprocessor">#endif</span>
02012 <span class="preprocessor"></span>    }
02013 
02014     <span class="comment">//</span>
02015     <span class="comment">// Restore threads affinity</span>
02016     <span class="comment">//</span>
02017 
02018     <a class="code" href="../../d9/d1/thredobj_8c.html#a16">KeRevertToUserAffinityThread</a>();
02019 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="cmsysini.c::CmpCreateControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpCreateControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">2786</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01580">CM_HARDWARE_PROFILE_STR_CAPABILITIES</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01593">CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01581">CM_HARDWARE_PROFILE_STR_DOCKID</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01579">CM_HARDWARE_PROFILE_STR_DOCKING_STATE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01582">CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02532">CmpAddDockingInfo()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02769">CmpHwprofileDefaultSelect()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00805">CmSetAcpiHwProfile()</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00079">_PROFILE_ACPI_DOCKING_STATE::DockingState</a>, <a class="el" href="../../d8/d0/genuedef_8c-source.html#l00009">extension</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00044">HW_PROFILE_DOCKSTATE_UNDOCKED</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00035">HW_PROFILE_STATUS_ALIAS_MATCH</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00038">HW_PROFILE_STATUS_FAILURE</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00037">HW_PROFILE_STATUS_PRISTINE_MATCH</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00034">HW_PROFILE_STATUS_SUCCESS</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00036">HW_PROFILE_STATUS_TRUE_MATCH</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/profiles_8h.html#a17">PROFILE_ACPI_DOCKING_STATE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00080">_PROFILE_ACPI_DOCKING_STATE::SerialLength</a>, <a class="el" href="../../d7/d6/profiles_8h-source.html#l00081">_PROFILE_ACPI_DOCKING_STATE::SerialNumber</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>02792                    :
02793 
02794     This routine sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic links from
02795 
02796         \Registry\Machine\System\CurrentControlSet to
02797         \Registry\Machine\System\ControlSetNNN
02798 
02799         \Registry\Machine\System\CurrentControlSet\Hardware Profiles\Current to
02800         \Registry\Machine\System\ControlSetNNN\Hardware Profiles\NNNN
02801 
02802     based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of \Registry\Machine\System\Select:Current. and
02803                           \Registry\Machine\System\ControlSetNNN\Control\IDConfigDB:CurrentConfig
02804 
02805 Arguments:
02806 
02807     None
02808 
02809 Return Value:
02810 
02811     status
02812 
02813 --*/
02814 
02815 {
02816     UNICODE_STRING IDConfigDBName;
02817     UNICODE_STRING SelectName;
02818     UNICODE_STRING CurrentName;
02819     OBJECT_ATTRIBUTES Attributes;
02820     HANDLE SelectHandle;
02821     HANDLE CurrentHandle;
02822     HANDLE IDConfigDB = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02823     HANDLE CurrentProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02824     HANDLE ParentOfProfile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02825     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> AsciiBuffer[128];
02826     WCHAR UnicodeBuffer[128];
02827     UCHAR <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[128];
02828     ULONG ControlSet;
02829     ULONG HWProfile;
02830     PKEY_VALUE_FULL_INFORMATION Value;
02831     ANSI_STRING AnsiString;
02832     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02833     ULONG ResultLength;
02834     ULONG Disposition;
02835     BOOLEAN signalAcpiEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02836 
02837     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02838 
02839     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SelectName, L<span class="stringliteral">"\\Registry\\Machine\\System\\Select"</span>);
02840     InitializeObjectAttributes(&amp;Attributes,
02841                                &amp;SelectName,
02842                                OBJ_CASE_INSENSITIVE,
02843                                NULL,
02844                                NULL);
02845     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;SelectHandle,
02846                        KEY_READ,
02847                        &amp;Attributes);
02848     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02849         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02850             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: Couldn't open Select node %08lx\n"</span>,Status));
02851         }
02852         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02853     }
02854 
02855     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, L<span class="stringliteral">"Current"</span>);
02856     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(SelectHandle,
02857                              &amp;CurrentName,
02858                              KeyValueFullInformation,
02859                              ValueBuffer,
02860                              <span class="keyword">sizeof</span>(ValueBuffer),
02861                              &amp;ResultLength);
02862     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SelectHandle);
02863     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02864         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02865             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: Couldn't query Select value %08lx\n"</span>,Status));
02866         }
02867         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02868     }
02869     Value = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
02870     ControlSet = *(PULONG)((PUCHAR)Value + Value-&gt;DataOffset);
02871 
02872     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet"</span>);
02873     InitializeObjectAttributes(&amp;Attributes,
02874                                &amp;CurrentName,
02875                                OBJ_CASE_INSENSITIVE,
02876                                NULL,
02877                                NULL);
02878     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CurrentHandle,
02879                          KEY_CREATE_LINK,
02880                          &amp;Attributes,
02881                          0,
02882                          NULL,
02883                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
02884                          &amp;Disposition);
02885     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02886         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02887             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create CurrentControlSet %08lx\n"</span>,Status));
02888         }
02889         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02890     }
02891 
02892     <span class="comment">//</span>
02893     <span class="comment">// Check to make sure that the key was created, not just opened.  Since</span>
02894     <span class="comment">// this key is always created volatile, it should never be present in</span>
02895     <span class="comment">// the hive when we boot.</span>
02896     <span class="comment">//</span>
02897     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
02898 
02899     <span class="comment">//</span>
02900     <span class="comment">// Create symbolic link for current hardware profile.</span>
02901     <span class="comment">//</span>
02902     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"\\Registry\\Machine\\System\\ControlSet%03d"</span>, ControlSet);
02903     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
02904 
02905     CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
02906     CurrentName.Buffer = UnicodeBuffer;
02907     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
02908                                           &amp;AnsiString,
02909                                           FALSE);
02910     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(CurrentHandle,
02911                            &amp;CmSymbolicLinkValueName,
02912                            0,
02913                            REG_LINK,
02914                            CurrentName.Buffer,
02915                            CurrentName.Length);
02916 
02917     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02918         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
02919             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create symbolic link "</span>));
02920             KdPrint((<span class="stringliteral">"to %wZ\n"</span>,&amp;CurrentName));
02921             KdPrint((<span class="stringliteral">"    Status=%08lx\n"</span>,Status));
02922         }
02923         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02924     }
02925 
02926     <span class="comment">//</span>
02927     <span class="comment">// Determine the Current Hardware Profile Number</span>
02928     <span class="comment">//</span>
02929     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;IDConfigDBName, L<span class="stringliteral">"Control\\IDConfigDB"</span>);
02930     InitializeObjectAttributes(&amp;Attributes,
02931                                &amp;IDConfigDBName,
02932                                OBJ_CASE_INSENSITIVE,
02933                                CurrentHandle,
02934                                NULL);
02935     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;IDConfigDB,
02936                        KEY_READ,
02937                        &amp;Attributes);
02938     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(CurrentHandle);
02939 
02940     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02941         IDConfigDB = 0;
02942         <span class="keywordflow">goto</span> Cleanup;
02943     }
02944 
02945     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, L<span class="stringliteral">"CurrentConfig"</span>);
02946     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(IDConfigDB,
02947                              &amp;CurrentName,
02948                              KeyValueFullInformation,
02949                              ValueBuffer,
02950                              <span class="keyword">sizeof</span>(ValueBuffer),
02951                              &amp;ResultLength);
02952 
02953     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ||
02954         (((PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>)-&gt;Type != REG_DWORD)) {
02955 
02956         <span class="keywordflow">goto</span> Cleanup;
02957     }
02958 
02959     Value = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
02960     HWProfile = *(PULONG)((PUCHAR)Value + Value-&gt;DataOffset);
02961     <span class="comment">//</span>
02962     <span class="comment">// We know now the config set that the user selected.</span>
02963     <span class="comment">// namely: HWProfile.</span>
02964     <span class="comment">//</span>
02965 
02966     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
02967               &amp;CurrentName,
02968               L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles"</span>);
02969     InitializeObjectAttributes(&amp;Attributes,
02970                                &amp;CurrentName,
02971                                OBJ_CASE_INSENSITIVE,
02972                                NULL,
02973                                NULL);
02974     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;ParentOfProfile,
02975                        KEY_READ,
02976                        &amp;Attributes);
02977 
02978     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
02979         ParentOfProfile = 0;
02980         <span class="keywordflow">goto</span> Cleanup;
02981     }
02982 
02983     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"%04d"</span>,HWProfile);
02984     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
02985     CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
02986     CurrentName.Buffer = UnicodeBuffer;
02987     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
02988                                           &amp;AnsiString,
02989                                           FALSE);
02990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == Status);
02991 
02992     InitializeObjectAttributes(&amp;Attributes,
02993                                &amp;CurrentName,
02994                                OBJ_CASE_INSENSITIVE,
02995                                ParentOfProfile,
02996                                NULL);
02997 
02998     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;CurrentProfile,
02999                         KEY_READ | KEY_WRITE,
03000                         &amp;Attributes);
03001 
03002     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03003         CurrentProfile = 0;
03004         <span class="keywordflow">goto</span> Cleanup;
03005     }
03006 
03007     <span class="comment">//</span>
03008     <span class="comment">// We need to determine if Value was selected by exact match</span>
03009     <span class="comment">// (TRUE_MATCH) or because the profile selected was aliasable.</span>
03010     <span class="comment">//</span>
03011     <span class="comment">// If aliasable we need to manufacture another alias entry in the</span>
03012     <span class="comment">// alias table.</span>
03013     <span class="comment">//</span>
03014     <span class="comment">// If the profile information is there and not failed then we should</span>
03015     <span class="comment">// mark the Docking state information:</span>
03016     <span class="comment">// (DockID, SerialNumber, DockState, and Capabilities)</span>
03017     <span class="comment">//</span>
03018 
03019     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> != LoaderBlock-&gt;Extension) {
03020         <a class="code" href="../../d3/d2/struct__LOADER__PARAMETER__EXTENSION.html">PLOADER_PARAMETER_EXTENSION</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>;
03021         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> = LoaderBlock-&gt;Extension;
03022         <span class="keywordflow">switch</span> (<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.Status) {
03023         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a3">HW_PROFILE_STATUS_PRISTINE_MATCH</a>:
03024             <span class="comment">//</span>
03025             <span class="comment">// If the selected profile is pristine then we need to clone.</span>
03026             <span class="comment">//</span>
03027             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a7">CmpCloneHwProfile</a> (IDConfigDB,
03028                                         ParentOfProfile,
03029                                         CurrentProfile,
03030                                         HWProfile,
03031                                         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState,
03032                                         &amp;CurrentProfile,
03033                                         &amp;HWProfile);
03034             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03035                 CurrentProfile = 0;
03036                 <span class="keywordflow">goto</span> Cleanup;
03037             }
03038 
03039             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, L<span class="stringliteral">"CurrentConfig"</span>);
03040             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (IDConfigDB,
03041                                     &amp;CurrentName,
03042                                     0,
03043                                     REG_DWORD,
03044                                     &amp;HWProfile,
03045                                     <span class="keyword">sizeof</span> (HWProfile));
03046             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
03047                 <span class="keywordflow">goto</span> Cleanup;
03048             }
03049 
03050             <span class="comment">//</span>
03051             <span class="comment">// Fall through</span>
03052             <span class="comment">//</span>
03053         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a1">HW_PROFILE_STATUS_ALIAS_MATCH</a>:
03054             <span class="comment">//</span>
03055             <span class="comment">// Create the alias entry for this profile.</span>
03056             <span class="comment">//</span>
03057 
03058             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a45">CmpAddAliasEntry</a> (IDConfigDB,
03059                                        &amp;<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile,
03060                                        HWProfile);
03061 
03062 <span class="preprocessor">#if 0</span>
03063 <span class="preprocessor"></span>            <span class="comment">//</span>
03064             <span class="comment">// If we are booting in the undocked state, and creating a brand</span>
03065             <span class="comment">// new alias for this undocked state, we need to create an acpi</span>
03066             <span class="comment">// alias as well that points to this new profile.</span>
03067             <span class="comment">//</span>
03068             <span class="comment">// BUGBUG.</span>
03069             <span class="comment">// We are not checking for the case where we may manufacture more</span>
03070             <span class="comment">// than one bios alias entry for the undocked state.</span>
03071             <span class="comment">// If we do create more than one, then we will of course create</span>
03072             <span class="comment">// more than one acpi alias entry for the undocked state.</span>
03073             <span class="comment">//</span>
03074             <span class="comment">// Therefore we are assuming that when undocked the machine always</span>
03075             <span class="comment">// returns the same serial number.  (Not a bad assumption.)</span>
03076             <span class="comment">//</span>
03077             <span class="comment">// But we are also assuming that if we have more than one NT4 style</span>
03078             <span class="comment">// HW profile (which would allow the user to select such a profile</span>
03079             <span class="comment">// for each boot, and the user selected more than one for two</span>
03080             <span class="comment">// different undocked boots, then we will create two undocked acpi</span>
03081             <span class="comment">// aliases.  (Perhaps that is what we actually want.  I'm not sure,</span>
03082             <span class="comment">// but at least it's noted.</span>
03083             <span class="comment">//</span>
03084 
03085             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a> == <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState) {
03086                 <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a> newDockState;
03087                 <span class="comment">//</span>
03088                 <span class="comment">// Note the definition of PROFILE_ACPI_DOCKING_STATE has a</span>
03089                 <span class="comment">// WCHAR array of length 1.</span>
03090                 <span class="comment">//</span>
03091 
03092 
03093                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState;
03094                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o1">SerialLength</a> = 2;
03095                 newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03096 
03097                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a5">CmpAddAcpiAliasEntry</a> (IDConfigDB,
03098                                                &amp;newDockState,
03099                                                HWProfile,
03100                                                UnicodeBuffer,
03101                                                ValueBuffer,
03102                                                <span class="keyword">sizeof</span> (ValueBuffer),
03103                                                TRUE); <span class="comment">// Prevent Duplication</span>
03104 
03105                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
03106             }
03107 <span class="preprocessor">#endif</span>
03108 <span class="preprocessor"></span>
03109             <span class="comment">//</span>
03110             <span class="comment">// Fall through</span>
03111             <span class="comment">//</span>
03112         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a2">HW_PROFILE_STATUS_TRUE_MATCH</a>:
03113             <span class="comment">//</span>
03114             <span class="comment">// Write DockID, SerialNumber, DockState, and Caps into the current</span>
03115             <span class="comment">// Hardware profile.</span>
03116             <span class="comment">//</span>
03117 
03118 <span class="preprocessor">#ifndef DISABLE_CLEAN_HW_PROFILE_INFO</span>
03119 <span class="preprocessor"></span>            <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, CM_HARDWARE_PROFILE_STR_DOCKING_STATE);
03120             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03121 
03122             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, CM_HARDWARE_PROFILE_STR_CAPABILITIES);
03123             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03124 
03125             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, CM_HARDWARE_PROFILE_STR_DOCKID);
03126             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03127 
03128             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName, CM_HARDWARE_PROFILE_STR_SERIAL_NUMBER);
03129             <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a> (CurrentProfile, &amp;CurrentName);
03130 <span class="preprocessor">#endif</span>
03131 <span class="preprocessor"></span>
03132             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;CurrentName,
03133                                   CM_HARDWARE_PROFILE_STR_CURRENT_DOCK_INFO);
03134 
03135             InitializeObjectAttributes (&amp;Attributes,
03136                                         &amp;CurrentName,
03137                                         OBJ_CASE_INSENSITIVE,
03138                                         IDConfigDB,
03139                                         NULL);
03140 
03141             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> (&amp;CurrentHandle,
03142                                   KEY_READ | KEY_WRITE,
03143                                   &amp;Attributes,
03144                                   0,
03145                                   NULL,
03146                                   REG_OPTION_VOLATILE,
03147                                   &amp;Disposition);
03148 
03149             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == Status);
03150 
03151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a44">CmpAddDockingInfo</a> (CurrentHandle, &amp;<a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile);
03152 
03153             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a> == <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>-&gt;Profile.DockingState) {
03154                 signalAcpiEvent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03155             }
03156 
03157             <span class="keywordflow">break</span>;
03158 
03159 
03160         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a0">HW_PROFILE_STATUS_SUCCESS</a>:
03161         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/profiles_8h.html#a4">HW_PROFILE_STATUS_FAILURE</a>:
03162             <span class="keywordflow">break</span>;
03163 
03164         <span class="keywordflow">default</span>:
03165             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a> (<span class="stringliteral">"Invalid Profile status state"</span>, FALSE);
03166         }
03167     }
03168 
03169     <span class="comment">//</span>
03170     <span class="comment">// Create the symbolic link.</span>
03171     <span class="comment">//</span>
03172     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CurrentName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\Current"</span>);
03173     InitializeObjectAttributes(&amp;Attributes,
03174                                &amp;CurrentName,
03175                                OBJ_CASE_INSENSITIVE,
03176                                NULL,
03177                                NULL);
03178     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;CurrentHandle,
03179                          KEY_CREATE_LINK,
03180                          &amp;Attributes,
03181                          0,
03182                          NULL,
03183                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
03184                          &amp;Disposition);
03185     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03186         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03187             KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create Hardware Profile\\Current %08lx\n"</span>,Status));
03188         }
03189     } <span class="keywordflow">else</span> {
03190         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
03191 
03192         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\%04d"</span>,HWProfile);
03193         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, AsciiBuffer);
03194         CurrentName.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
03195         CurrentName.Buffer = UnicodeBuffer;
03196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;CurrentName,
03197                                               &amp;AnsiString,
03198                                               FALSE);
03199         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (STATUS_SUCCESS == Status);
03200 
03201         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(CurrentHandle,
03202                                &amp;CmSymbolicLinkValueName,
03203                                0,
03204                                REG_LINK,
03205                                CurrentName.Buffer,
03206                                CurrentName.Length);
03207         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03208             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
03209                 KdPrint((<span class="stringliteral">"CM: CmpCreateControlSet: couldn't create symbolic link "</span>));
03210                 KdPrint((<span class="stringliteral">"to %wZ\n"</span>,&amp;CurrentName));
03211                 KdPrint((<span class="stringliteral">"    Status=%08lx\n"</span>,Status));
03212             }
03213         }
03214     }
03215 
03216     <span class="keywordflow">if</span> (signalAcpiEvent) {
03217         <span class="comment">//</span>
03218         <span class="comment">// We are booting in the undocked state.</span>
03219         <span class="comment">// This is interesting because our buddies in PnP cannot tell</span>
03220         <span class="comment">// us when we are booting without a dock.  They can only tell</span>
03221         <span class="comment">// us when they see a hot undock.</span>
03222         <span class="comment">//</span>
03223         <span class="comment">// Therefore in the interest of matching a boot undocked with</span>
03224         <span class="comment">// a hot undock, we need to simulate an acpi undock event.</span>
03225         <span class="comment">//</span>
03226 
03227         <a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html">PROFILE_ACPI_DOCKING_STATE</a> newDockState;
03228         HANDLE profile;
03229         BOOLEAN changed;
03230 
03231         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o0">DockingState</a> = <a class="code" href="../../d6/d7/profiles_8h.html#a6">HW_PROFILE_DOCKSTATE_UNDOCKED</a>;
03232         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o1">SerialLength</a> = 2;
03233         newDockState.<a class="code" href="../../d9/d0/struct__PROFILE__ACPI__DOCKING__STATE.html#o2">SerialNumber</a>[0] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03234 
03235         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d2/hwprofil_8c.html#a6">CmSetAcpiHwProfile</a> (&amp;newDockState,
03236                                      CmpHwprofileDefaultSelect,
03237                                      NULL,
03238                                      &amp;profile,
03239                                      &amp;changed);
03240 
03241         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NT_SUCCESS (Status));
03242         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (profile);
03243     }
03244 
03245 
03246 Cleanup:
03247     <span class="keywordflow">if</span> (IDConfigDB) {
03248         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (IDConfigDB);
03249     }
03250     <span class="keywordflow">if</span> (CurrentProfile) {
03251         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (CurrentProfile);
03252     }
03253     <span class="keywordflow">if</span> (ParentOfProfile) {
03254         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (ParentOfProfile);
03255     }
03256 
03257     <span class="keywordflow">return</span>(STATUS_SUCCESS);
03258 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="cmsysini.c::CmpCreateObjectTypes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCreateObjectTypes           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01074">1074</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00115">CMP_KEY_INVALID_ATTRIBUTES</a>, <a class="el" href="../../d4/d9/cmclose_8c-source.html#l00028">CmpCloseKeyObject()</a>, <a class="el" href="../../d2/d0/cmdelete_8c-source.html#l00031">CmpDeleteKeyObject()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00076">CmpKeyMapping</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>, <a class="el" href="../../d6/d1/cmquery_8c-source.html#l00028">CmpQueryKeyName()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>01079                    :
01080 
01081     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
01082 
01083 Arguments:
01084 
01085     NONE.
01086 
01087 Return Value:
01088 
01089     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> == success,  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> == <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01090 
01091 --*/
01092 {
01093    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01094    <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
01095    UNICODE_STRING TypeName;
01096 
01097    <span class="comment">//</span>
01098    <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
01099    <span class="comment">// specific access rights for registry key objects.</span>
01100    <span class="comment">//</span>
01101 
01102    GENERIC_MAPPING <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a> = {
01103       KEY_READ,
01104       KEY_WRITE,
01105       KEY_EXECUTE,
01106       KEY_ALL_ACCESS
01107    };
01108 
01109     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01110     <span class="comment">//</span>
01111     <span class="comment">// --- Create the registry key object type ---</span>
01112     <span class="comment">//</span>
01113 
01114     <span class="comment">//</span>
01115     <span class="comment">// Initialize string descriptor.</span>
01116     <span class="comment">//</span>
01117 
01118     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Key"</span>);
01119 
01120     <span class="comment">//</span>
01121     <span class="comment">// Create key object type descriptor.</span>
01122     <span class="comment">//</span>
01123 
01124     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
01125     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
01126     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a7">CMP_KEY_INVALID_ATTRIBUTES</a>;
01127     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a3">CmpKeyMapping</a>;
01128     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = KEY_ALL_ACCESS;
01129     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>);
01130     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01131     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
01132     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01133     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o1">UseDefaultObject</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01134 
01135     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o12">DumpProcedure</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01136     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01137     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> = <a class="code" href="../../d3/d0/cmclose_8c.html#a0">CmpCloseKeyObject</a>;
01138     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d1/d1/cmdelete_8c.html#a0">CmpDeleteKeyObject</a>;
01139     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a208">CmpParseKey</a>;
01140     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a214">CmpSecurityMethod</a>;
01141     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o18">QueryNameProcedure</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a211">CmpQueryKeyName</a>;
01142 
01143     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(
01144                 &amp;TypeName,
01145                 &amp;ObjectTypeInitializer,
01146                 (PSECURITY_DESCRIPTOR)NULL,
01147                 &amp;CmpKeyObjectType
01148                 );
01149 
01150 
01151     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01152         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01153             KdPrint((<span class="stringliteral">"CmpCreateObjectTypes: "</span>));
01154             KdPrint((<span class="stringliteral">"ObCreateObjectType(Key) failed %08lx\n"</span>, Status));
01155         }
01156         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01157     }
01158 
01159     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="cmsysini.c::CmpCreatePerfKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCreatePerfKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">4155</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d4/d9/user32_8def-source.html#l00799">c</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">CmpCreatePredefined()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00233">CmpRegistryPerflibString</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00072">HKEY_PERFORMANCE_NLSTEXT</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00071">HKEY_PERFORMANCE_TEXT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00584">PsDefaultSystemLocaleId</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.
<p>
<pre class="fragment"><div>04161                    :
04162 
04163     Creates predefined keys <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> performance <a class="code" href="../../d7/d1/genuedef_8c.html#a5">text</a> to support old apps on 1.0a
04164 
04165 Arguments:
04166 
04167     None.
04168 
04169 Return Value:
04170 
04171     None.
04172 
04173 --*/
04174 
04175 {
04176     HANDLE Perflib;
04177     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04178     WCHAR LanguageId[4];
04179     OBJECT_ATTRIBUTES Attributes;
04180     UNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
04181     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Language;
04182     LONG i;
04183     WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
04184     <span class="keyword">extern</span> PWCHAR <a class="code" href="../../d6/d0/cmdat_8c.html#a58">CmpRegistryPerflibString</a>;
04185 
04186     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;String, CmpRegistryPerflibString);
04187 
04188     InitializeObjectAttributes(&amp;Attributes,
04189                                &amp;String,
04190                                OBJ_CASE_INSENSITIVE,
04191                                NULL,
04192                                NULL);
04193     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;Perflib,
04194                        KEY_WRITE,
04195                        &amp;Attributes);
04196     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04197         <span class="keywordflow">return</span>;
04198     }
04199 
04200 
04201     <span class="comment">//</span>
04202     <span class="comment">// Always create the predefined keys for the english language</span>
04203     <span class="comment">//</span>
04204     <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(Perflib,
04205                         L<span class="stringliteral">"009"</span>,
04206                         HKEY_PERFORMANCE_TEXT);
04207 
04208     <span class="comment">//</span>
04209     <span class="comment">// If the default language is not english, create a predefined key for</span>
04210     <span class="comment">// that, too.</span>
04211     <span class="comment">//</span>
04212     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a58">PsDefaultSystemLocaleId</a> != 0x00000409) {
04213         Language = LANGIDFROMLCID(PsDefaultSystemLocaleId) &amp; 0xff;
04214         LanguageId[3] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
04215         <span class="keywordflow">for</span> (i=2;i&gt;=0;i--) {
04216             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = Language % 16;
04217             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>&gt;9) {
04218                 LanguageId[i]= <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>+<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>-10;
04219             } <span class="keywordflow">else</span> {
04220                 LanguageId[i]= <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>+<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>;
04221             }
04222             Language = Language &gt;&gt; 4;
04223         }
04224         <a class="code" href="../../d1/d3/cmsysini_8c.html#a30">CmpCreatePredefined</a>(Perflib,
04225                             LanguageId,
04226                             HKEY_PERFORMANCE_NLSTEXT);
04227     }
04228 
04229 
04230 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="cmsysini.c::CmpCreatePredefined" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpCreatePredefined           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Root</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PredefinedHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04234">4234</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00771">_CM_PARSE_CONTEXT::Class</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00772">_CM_PARSE_CONTEXT::CreateOptions</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00773">_CM_PARSE_CONTEXT::Disposition</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00776">_CM_PARSE_CONTEXT::PredefinedHandle</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00766">REG_OPTION_PREDEF_HANDLE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d1/cmp_8h-source.html#l00770">_CM_PARSE_CONTEXT::TitleIndex</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>.
<p>
<pre class="fragment"><div>04242                    :
04243 
04244     Creates a special key that will always <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given predefined handle
04245     instead of a real handle.
04246 
04247 Arguments:
04248 
04249     Root - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keyname <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to
04250 
04251     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
04252 
04253     PredefinedHandle - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> predefined handle to be returned when <span class="keyword">this</span>
04254         key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened.
04255 
04256 Return Value:
04257 
04258     None.
04259 
04260 --*/
04261 
04262 {
04263     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
04264     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a> ParseContext;
04265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04266     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
04267     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
04268 
04269     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
04270     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04271 
04272     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
04273     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = REG_OPTION_VOLATILE | <a class="code" href="../../d1/d2/cmp_8h.html#a112">REG_OPTION_PREDEF_HANDLE</a>;
04274     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = 0;
04275     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04276     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o6">PredefinedHandle</a> = PredefinedHandle;
04277 
04278     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Name, KeyName);
04279     InitializeObjectAttributes(&amp;ObjectAttributes,
04280                                &amp;Name,
04281                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
04282                                Root,
04283                                NULL);
04284 
04285     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;ObjectAttributes,
04286                                 CmpKeyObjectType,
04287                                 KernelMode,
04288                                 NULL,
04289                                 KEY_READ,
04290                                 (PVOID)&amp;ParseContext,
04291                                 &amp;Handle);
04292     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
04293 
04294     ZwClose(Handle);
04295 
04296 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="cmsysini.c::CmpCreateRegistryRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCreateRegistryRoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">1165</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d9/d1/cmsubs_8c-source.html#l00824">CmpCreateKeyControlBlock()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">CmpCreateRootNode()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00036">CmpMasterHive</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00166">CmRegistryRootName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00526">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d5/d5/regext_8c-source.html#l00458">kcb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00486">KEY_BODY_TYPE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>01170                    :
01171 
01172     Manually create \REGISTRY in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> master hive, create a key
01173     object to refer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>, and insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key object into
01174     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root (\) of the object space.
01175 
01176 Arguments:
01177 
01178     None
01179 
01180 Return Value:
01181 
01182     TRUE == success, FALSE == failure
01183 
01184 --*/
01185 {
01186     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01187     UNICODE_STRING NullString = { 0, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> };
01188     HANDLE  ObjHandle;
01189     PVOID   ObjectPointer;
01190     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> Object;
01191     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01192     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01193     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> RootCellIndex;
01194     PSECURITY_DESCRIPTOR SecurityDescriptor;
01195 
01196     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01197     <span class="comment">//</span>
01198     <span class="comment">// --- Create hive entry for \REGISTRY ---</span>
01199     <span class="comment">//</span>
01200 
01201     <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a38">CmpCreateRootNode</a>(
01202             &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>), L<span class="stringliteral">"REGISTRY"</span>, &amp;RootCellIndex))
01203     {
01204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01205     }
01206 
01207     <span class="comment">//</span>
01208     <span class="comment">// --- Create a KEY object that refers to \REGISTRY ---</span>
01209     <span class="comment">//</span>
01210 
01211 
01212     <span class="comment">//</span>
01213     <span class="comment">// Create the object manager object</span>
01214     <span class="comment">//</span>
01215 
01216     <span class="comment">//</span>
01217     <span class="comment">// WARNING: \\REGISTRY is not in pool, so if anybody ever tries to</span>
01218     <span class="comment">//          free it, we are in deep trouble.  On the other hand,</span>
01219     <span class="comment">//          this implies somebody has removed \\REGISTRY from the</span>
01220     <span class="comment">//          root, so we're in trouble anyway.</span>
01221     <span class="comment">//</span>
01222 
01223     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
01224 
01225     InitializeObjectAttributes(
01226         &amp;ObjectAttributes,
01227         &amp;CmRegistryRootName,
01228         OBJ_CASE_INSENSITIVE,
01229         (HANDLE)NULL,
01230         SecurityDescriptor
01231         );
01232 
01233 
01234     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(
01235         KernelMode,
01236         CmpKeyObjectType,
01237         &amp;ObjectAttributes,
01238         UserMode,
01239         NULL,                   <span class="comment">// Parse context</span>
01240         <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
01241         0,
01242         0,
01243         (PVOID *)&amp;Object
01244         );
01245 
01246     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01247 
01248     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01249         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01250             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01251             KdPrint((<span class="stringliteral">"ObCreateObject(\\REGISTRY) failed %08lx\n"</span>, Status));
01252         }
01253         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01254     }
01255 
01256     <span class="comment">//</span>
01257     <span class="comment">// Create the key control block</span>
01258     <span class="comment">//</span>
01259     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(
01260             &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>),
01261             RootCellIndex,
01262             (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>,RootCellIndex),
01263             NULL,
01264             FALSE,
01265             &amp;CmRegistryRootName
01266             );
01267 
01268     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01269         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01270     }
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">// Initialize the type specific body</span>
01274     <span class="comment">//</span>
01275     Object-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
01276     Object-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01277     Object-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01278     Object-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01279     <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(Object);
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">// Put the object in the root directory</span>
01283     <span class="comment">//</span>
01284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(
01285                 Object,
01286                 NULL,
01287                 (ACCESS_MASK)0,
01288                 0,
01289                 NULL,
01290                 &amp;ObjHandle
01291                 );
01292 
01293     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01294         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01295             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01296             KdPrint((<span class="stringliteral">"ObInsertObject(\\REGISTRY) failed %08lx\n"</span>, Status));
01297         }
01298         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01299     }
01300 
01301     <span class="comment">//</span>
01302     <span class="comment">// We cannot make the root permanent because registry objects in</span>
01303     <span class="comment">// general are not allowed to be.  (They're stable via virtue of being</span>
01304     <span class="comment">// stored in the registry, not the object manager.)  But we never</span>
01305     <span class="comment">// ever want the root to go away.  So reference it.</span>
01306     <span class="comment">//</span>
01307     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01308                         ObjHandle,
01309                         KEY_READ,
01310                         NULL,
01311                         KernelMode,
01312                         &amp;ObjectPointer,
01313                         NULL
01314                         )))
01315     {
01316         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01317             KdPrint((<span class="stringliteral">"CmpCreateRegistryRoot: "</span>));
01318             KdPrint((<span class="stringliteral">"ObReferenceObjectByHandle failed %08lx\n"</span>, Status));
01319         }
01320         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01321     }
01322 
01323     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01324 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="cmsysini.c::CmpCreateRootNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpCreateRootNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RootCellIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01328">1328</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00422">CM_KEY_NODE_SIGNATURE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00074">CmpCopyName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00683">CmpHKeyNodeSize</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00386">HvAllocateCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00434">KEY_HIVE_ENTRY</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00437">KEY_NO_DELETE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00537">_CELL_DATA::_u::KeyNode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00333">_CHILD_LIST::List</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00453">_CM_KEY_NODE::Parent</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00463">_CM_KEY_NODE::Security</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00449">_CM_KEY_NODE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00457">_CM_KEY_NODE::SubKeyLists</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01165">CmpCreateRegistryRoot()</a>.
<p>
<pre class="fragment"><div>01335                    :
01336 
01337     Manually create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root node of a hive.
01338 
01339 Arguments:
01340 
01341     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to a <a class="code" href="../../d7/d1/hivemap_8c.html#a0">Hive</a> (Hv level) <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure
01342 
01343     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - pointer to a unicode name string
01344 
01345     RootCellIndex - supplies pointer to a variable to recieve
01346                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cell index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created node.
01347 
01348 Return Value:
01349 
01350     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> == success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> == <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
01351 
01352 --*/
01353 {
01354     UNICODE_STRING temp;
01355     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
01356     <a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html">CM_KEY_REFERENCE</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01357     LARGE_INTEGER systemtime;
01358 
01359     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01360     <span class="comment">//</span>
01361     <span class="comment">// Allocate the node.</span>
01362     <span class="comment">//</span>
01363     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;temp, Name);
01364     *RootCellIndex = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01365                 Hive,
01366                 <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(Hive, &amp;temp),
01367                 Stable
01368                 );
01369     <span class="keywordflow">if</span> (*RootCellIndex == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01370         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01371             KdPrint((<span class="stringliteral">"CmpCreateRootNode: HvAllocateCell failed\n"</span>));
01372         }
01373         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01374     }
01375 
01376     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = *RootCellIndex;
01377 
01378     CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, *RootCellIndex);
01379 
01380     <span class="comment">//</span>
01381     <span class="comment">// Initialize the node</span>
01382     <span class="comment">//</span>
01383     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a25">CM_KEY_NODE_SIGNATURE</a>;
01384     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01385     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01386     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01387 <span class="comment">//    CellData-&gt;u.KeyNode.TitleIndex = 0;</span>
01388     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01389 
01390     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
01391     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
01392     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01393     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01394 
01395     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01396     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01397     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01398     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01399     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
01400 
01401     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
01402     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = 0;
01403     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
01404     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = 0;
01405 
01406     CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(Hive,
01407                                                  CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01408                                                  &amp;temp);
01409     <span class="keywordflow">if</span> (CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; temp.Length) {
01410         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
01411     }
01412 
01413     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.KeyHive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01414     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.KeyCell = *RootCellIndex;
01415 
01416     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01417 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="cmsysini.c::CmpDeleteCloneTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDeleteCloneTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03747">3747</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00186">CmRegistrySystemCloneName</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>.
<p>
<pre class="fragment"><div>03750                    :
03751 
03752    Deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cloned CurrentControlSet by unloading <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CLONE hive.
03753 
03754 Arguments:
03755 
03756    NONE.
03757 
03758 Return Value:
03759 
03760    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <span class="keywordflow">return</span> from <a class="code" href="../../d7/d7/ntapi_8c.html#a32">NtUnloadKey</a>.
03761 
03762 --*/
03763 {
03764    OBJECT_ATTRIBUTES   Obja;
03765 
03766    InitializeObjectAttributes(
03767        &amp;Obja,
03768        &amp;CmRegistrySystemCloneName,
03769        OBJ_CASE_INSENSITIVE,
03770        (HANDLE)NULL,
03771        NULL);
03772 
03773    <span class="keywordflow">return</span> <a class="code" href="../../d7/d7/ntapi_8c.html#a32">NtUnloadKey</a>(&amp;Obja);
03774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="cmsysini.c::CmpDeleteCloneTree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpDeleteCloneTree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="cmsysini.c::CmpDiskFullWarning" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpDiskFullWarning           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00556">556</a> of file <a class="el" href="../../d6/d2/cmworker_8c-source.html">cmworker.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00059">CmpCannotWriteConfiguration</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00518">CmpDiskFullWarningWorker()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00058">CmpDiskFullWorkerPopupDisplayed</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00029">CmpProfileLoaded</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00058">ExReadyForErrors</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00561                    :
00562 
00563     Raises a hard error of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> STATUS_DISK_FULL <span class="keywordflow">if</span> wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> already raised
00564 
00565 Arguments:
00566 
00567     None
00568 
00569 Return Value:
00570 
00571     None
00572 
00573 --*/
00574 {
00575     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a> WorkItem;
00576 
00577     <span class="keywordflow">if</span>( (!<a class="code" href="../../d7/d0/cmdat2_8c.html#a7">CmpDiskFullWorkerPopupDisplayed</a>) &amp;&amp; (<a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a>) &amp;&amp; (<a class="code" href="../../d6/d8/ex_2harderr_8c.html#a5">ExReadyForErrors</a>) &amp;&amp; (<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a>) ) {
00578 
00579         <span class="comment">//</span>
00580         <span class="comment">// Queue work item to display popup</span>
00581         <span class="comment">//</span>
00582         WorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>));
00583         <span class="keywordflow">if</span> (WorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00584 
00585             <a class="code" href="../../d7/d0/cmdat2_8c.html#a7">CmpDiskFullWorkerPopupDisplayed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586             <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(WorkItem,
00587                                  CmpDiskFullWarningWorker,
00588                                  WorkItem);
00589             <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(WorkItem, DelayedWorkQueue);
00590         }
00591     }
00592 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="cmsysini.c::CmpFreeDriverList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeDriverList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02380">2380</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>.
<p>
<pre class="fragment"><div>02387                    :
02388 
02389     Walks down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver list, freeing each node in <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02390 
02391     Note that <span class="keyword">this</span> calls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive's free routine pointer to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory.
02392 
02393 Arguments:
02394 
02395     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - Supplies  a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure.
02396 
02397     DriverList - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Driver <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.  Note
02398             that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> head of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not actually freed, <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02399             entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
02400 
02401 Return Value:
02402 
02403     None.
02404 
02405 --*/
02406 
02407 {
02408     PLIST_ENTRY Next;
02409     PLIST_ENTRY Current;
02410 
02411     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02412     Current = DriverList-&gt;Flink;
02413     <span class="keywordflow">while</span> (Current != DriverList) {
02414         Next = Current-&gt;Flink;
02415         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)((PVOID)Current, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>));
02416         Current = Next;
02417     }
02418 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="cmsysini.c::CmpHwprofileDefaultSelect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpHwprofileDefaultSelect           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileIndexToUse</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02769">2769</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>.
<p>
<pre class="fragment"><div>02774 {
02775     UNREFERENCED_PARAMETER (Context);
02776 
02777     * ProfileIndexToUse = 0;
02778 
02779     <span class="keywordflow">return</span> STATUS_SUCCESS;
02780 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="cmsysini.c::CmpInitHiveFromFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInitHiveFromFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Allocate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryLocked</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">2422</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, and <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>.
<p>
<pre class="fragment"><div>02432                    :
02433 
02434     This routine opens a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and log, allocates a <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, and initializes
02435     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02436 
02437 Arguments:
02438 
02439     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - Supplies name of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to be loaded.
02440 
02441     HiveFlags - Supplies hive flags to be passed to <a class="code" href="../../d8/d1/cminit_8c.html#a4">CmpInitializeHive</a>
02442 
02443     CmHive   - Returns pointer to initialized hive (<span class="keywordflow">if</span> successful)
02444 
02445     Allocate - IN: <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ok to allocate, <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> hive must exist
02446                     (bug .log may get created)
02447                OUT: <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> actually created hive, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> existed before
02448 
02449 Return Value:
02450 
02451     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02452 
02453 --*/
02454 
02455 {
02456     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02457     ULONG Disposition;
02458     ULONG SecondaryDisposition;
02459     HANDLE PrimaryHandle;
02460     HANDLE LogHandle;
02461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02462     ULONG FileType;
02463     ULONG Operation;
02464 
02465     BOOLEAN Success;
02466 
02467     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02468     *CmHive = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02469 
02470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(FileName,
02471                               L<span class="stringliteral">".LOG"</span>,
02472                               &amp;PrimaryHandle,
02473                               &amp;LogHandle,
02474                               &amp;Disposition,
02475                               &amp;SecondaryDisposition,
02476                               *Allocate,
02477                               FALSE,
02478                               NULL);
02479 
02480     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02481         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02482     }
02483 
02484     <span class="keywordflow">if</span> (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02485         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
02486     } <span class="keywordflow">else</span> {
02487         FileType = <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>;
02488     }
02489 
02490     <span class="keywordflow">if</span> (Disposition == FILE_CREATED) {
02491         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>;
02492         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02493     } <span class="keywordflow">else</span> {
02494         Operation = <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>;
02495         *Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="keywordflow">if</span>( !(*RegistryLocked) ) {
02499         <span class="comment">//</span>
02500         <span class="comment">// Registry should be locked exclusive</span>
02501         <span class="comment">// if not, lock it now and signal this to the caller</span>
02502         <span class="comment">//</span>
02503         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02504         *RegistryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02505     }
02506 
02507     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;NewHive,
02508                                 Operation,
02509                                 HiveFlags,
02510                                 FileType,
02511                                 NULL,
02512                                 PrimaryHandle,
02513                                 NULL,
02514                                 LogHandle,
02515                                 NULL,
02516                                 FileName
02517                                 );
02518     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02519         ZwClose(PrimaryHandle);
02520         <span class="keywordflow">if</span> (LogHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02521             ZwClose(LogHandle);
02522         }
02523         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02524     } <span class="keywordflow">else</span> {
02525         *CmHive = NewHive;
02526         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02527     }
02528 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="cmsysini.c::CmpInitializeHiveList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpInitializeHiveList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">726</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00062">BaseName</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01609">_HIVE_LIST_ENTRY::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00247">CML_MINOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00059">CmpCannotWriteConfiguration</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04155">CmpCreatePerfKeys()</a>, <a class="el" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00509">CmpFileSetSize()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02422">CmpInitHiveFromFile()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00097">CmpLazyFlush()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00250">CmpMachineHiveList</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00025">CmpNoWrite</a>, <a class="el" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00700">ExRaiseHardError()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00650">_CMHIVE::FileHandles</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00571">HFILE_TYPE_EXTERNAL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00647">HvSyncHive()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l01433">HvWriteHive()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00039">INIT_REGISTRY_MASTERPATH</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00037">INIT_SYSTEMROOT_HIVEPATH</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01607">_HIVE_LIST_ENTRY::Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00663">RtlAppendStringToString()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02305">RtlAreBitsClear()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l02227">RtlNumberOfSetBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l01634">RtlSetBits()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00731                    :
00732 
00733     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to map hive files to hives.  It both
00734     maps existing hives to files, and creates <span class="keyword">new</span> hives from files.
00735 
00736     It operates on files in <span class="stringliteral">"\SYSTEMROOT\CONFIG"</span>.
00737 
00738     NOTE:   MUST run in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d2/cmp_8h.html#a292">CmpWorker</a>
00739             thread runs in.  Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to arrange <span class="keyword">this</span>.
00740 
00741     NOTE:   Will bugcheck on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00742 
00743 Arguments:
00744 
00745 Return Value:
00746 
00747     NONE.
00748 
00749 --*/
00750 {
00751 <span class="preprocessor">    #define MAX_NAME    128</span>
00752 <span class="preprocessor"></span>    UCHAR   FileBuffer[<a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>];
00753     UCHAR   RegBuffer[<a class="code" href="../../d1/d3/cmsysini_8c.html#a8">MAX_NAME</a>];
00754 
00755     UNICODE_STRING TempName;
00756     UNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00757     UNICODE_STRING RegName;
00758 
00759     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  FileStart;
00760     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  RegStart;
00761     ULONG   i;
00762     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00763     BOOLEAN Allocate;
00764     HANDLE  PrimaryHandle;
00765     HANDLE  LogHandle;
00766     ULONG   PrimaryDisposition;
00767     ULONG   SecondaryDisposition;
00768     ULONG   Length;
00769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00770     PSECURITY_DESCRIPTOR SecurityDescriptor;
00771     BOOLEAN RegistryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772 
00773     PVOID   ErrorParameters;
00774     ULONG   ErrorResponse;
00775     ULONG   ClusterSize;
00776 
00777     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00778     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) KdPrint(("CmpInitializeHiveList\n"));
00779 
00780     CmpNoWrite = FALSE;
00781 
00782     FileName.MaximumLength = MAX_NAME;
00783     FileName.Length = 0;
00784     FileName.Buffer = (PWSTR)&amp;(FileBuffer[0]);
00785 
00786     RegName.MaximumLength = MAX_NAME;
00787     RegName.Length = 0;
00788     RegName.Buffer = (PWSTR)&amp;(RegBuffer[0]);
00789 
00790     RtlInitUnicodeString(
00791         &amp;TempName,
00792         INIT_SYSTEMROOT_HIVEPATH
00793         );
00794     RtlAppendStringToString((PSTRING)&amp;FileName, (PSTRING)&amp;TempName);
00795     FileStart = FileName.Length;
00796 
00797     RtlInitUnicodeString(
00798         &amp;TempName,
00799         INIT_REGISTRY_MASTERPATH
00800         );
00801     RtlAppendStringToString((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00802     RegStart = RegName.Length;
00803 
00804     SecurityDescriptor = CmpHiveRootSecurityDescriptor();
00805 
00806 
00807     for (i = 0; CmpMachineHiveList[i].Name != NULL; i++) {
00808 
00809         <span class="comment">//</span>
00810         <span class="comment">// Compute the name of the file, and the name to link to in</span>
00811         <span class="comment">// the registry.</span>
00812         <span class="comment">//</span>
00813 
00814         <span class="comment">// REGISTRY</span>
00815 
00816         RegName.Length = RegStart;
00817         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00818             &amp;TempName,
00819             CmpMachineHiveList[i].BaseName
00820             );
00821         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00822 
00823         <span class="comment">// REGISTRY\MACHINE or REGISTRY\USER</span>
00824 
00825         <span class="keywordflow">if</span> (RegName.Buffer[ (RegName.Length / <span class="keyword">sizeof</span>( WCHAR )) - 1 ] == <span class="charliteral">'\\'</span>) {
00826             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00827                 &amp;TempName,
00828                 CmpMachineHiveList[i].Name
00829                 );
00830             <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;RegName, (PSTRING)&amp;TempName);
00831         }
00832 
00833         <span class="comment">// REGISTRY\[MACHINE|USER]\HIVE</span>
00834 
00835         <span class="comment">// &lt;sysroot&gt;\config</span>
00836 
00837         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00838             &amp;TempName,
00839             CmpMachineHiveList[i].Name
00840             );
00841         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length = FileStart;
00842         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;FileName, (PSTRING)&amp;TempName);
00843 
00844         <span class="comment">// &lt;sysroot&gt;\config\hive</span>
00845 
00846 
00847         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00848 
00849             <span class="comment">//</span>
00850             <span class="comment">// Hive has not been inited in any way.</span>
00851             <span class="comment">//</span>
00852 
00853             Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00854             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d3/cmsysini_8c.html#a52">CmpInitHiveFromFile</a>(&amp;FileName,
00855                                          CmpMachineHiveList[i].Flags,
00856                                          &amp;CmHive,
00857                                          &amp;Allocate,
00858                                          &amp;RegistryLocked
00859                                          );
00860 
00861             <span class="keywordflow">if</span> ( (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) ||
00862                  (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>] == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) )
00863             {
00864                 ErrorParameters = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00865                 <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00866                     STATUS_CANNOT_LOAD_REGISTRY_FILE,
00867                     1,
00868                     1,
00869                     (PULONG_PTR)&amp;ErrorParameters,
00870                     OptionOk,
00871                     &amp;ErrorResponse
00872                     );
00873 
00874                 <span class="keywordflow">continue</span>;           <span class="comment">// If we are here it isn't SYSTEM,</span>
00875                                     <span class="comment">// so punt and go on.</span>
00876             }
00877 
00878             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MINOR, CMS_INIT) {
00879                 KdPrint((<span class="stringliteral">"CmpInitializeHiveList:\n"</span>));
00880                 KdPrint((<span class="stringliteral">"\tCmHive for '%ws' @"</span>, CmpMachineHiveList[i]));
00881                 KdPrint((<span class="stringliteral">"%08lx"</span>, CmHive));
00882             }
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">// Link hive into master hive</span>
00886             <span class="comment">//</span>
00887             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(
00888                     &amp;RegName,
00889                     NULL,
00890                     CmHive,
00891                     Allocate,
00892                     SecurityDescriptor
00893                     ) != STATUS_SUCCESS)
00894             {
00895                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
00896                     KdPrint((<span class="stringliteral">"CmpInitializeHiveList: "</span>));
00897                     KdPrint((<span class="stringliteral">"CmpLinkHiveToMaster failed\n"</span>));
00898                     KdPrint((<span class="stringliteral">"\ti=%d s='%ws'\n"</span>, i, CmpMachineHiveList[i]));
00899                 }
00900                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_LIST_FAILED,5,2,i,(ULONG_PTR)&amp;RegName);
00901             }
00902             <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(CmHive);
00903 
00904             <span class="keywordflow">if</span> (Allocate) {
00905                 <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
00906             }
00907 
00908         } <span class="keywordflow">else</span> {
00909 
00910             CmHive = <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[i].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a>;
00911 
00912             <span class="keywordflow">if</span> (!(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00913 
00914                 <span class="comment">//</span>
00915                 <span class="comment">// CmHive already exists.  It is not an entirely volatile</span>
00916                 <span class="comment">// hive (we do nothing for those.)</span>
00917                 <span class="comment">//</span>
00918                 <span class="comment">// First, open the files (Primary and Alternate) that</span>
00919                 <span class="comment">// back the hive.  Stuff their handles into the CmHive</span>
00920                 <span class="comment">// object.  Force the size of the files to match the</span>
00921                 <span class="comment">// in memory images.  Call HvSyncHive to write changes</span>
00922                 <span class="comment">// out to disk.</span>
00923                 <span class="comment">//</span>
00924                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a290">CmpOpenHiveFiles</a>(&amp;FileName,
00925                                           L<span class="stringliteral">".ALT"</span>,
00926                                           &amp;PrimaryHandle,
00927                                           &amp;LogHandle,
00928                                           &amp;PrimaryDisposition,
00929                                           &amp;SecondaryDisposition,
00930                                           TRUE,
00931                                           TRUE,
00932                                           &amp;ClusterSize);
00933 
00934                 <span class="keywordflow">if</span> ( ( ! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) ||
00935                      (LogHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) )
00936                 {
00937                     ErrorParameters = &amp;<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00938                     <a class="code" href="../../d5/d8/ex_8h.html#a306">ExRaiseHardError</a>(
00939                         STATUS_CANNOT_LOAD_REGISTRY_FILE,
00940                         1,
00941                         1,
00942                         (PULONG_PTR)&amp;ErrorParameters,
00943                         OptionOk,
00944                         &amp;ErrorResponse
00945                         );
00946 
00947                     <span class="comment">//</span>
00948                     <span class="comment">// WARNNOTE</span>
00949                     <span class="comment">// We've just told the user that something essential,</span>
00950                     <span class="comment">// like the SYSTEM hive, is hosed.  Don't try to run,</span>
00951                     <span class="comment">// we just risk destroying user data.  Punt.</span>
00952                     <span class="comment">//</span>
00953                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_SYSTEM_CONFIG_INFO,5,3,i,Status);
00954                 }
00955 
00956                 CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>] = LogHandle;
00957                 CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>] = PrimaryHandle;
00958 
00959                 Length = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length + <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00960 
00961                 <span class="comment">//</span>
00962                 <span class="comment">// When an in-memory hive is opened with no backing</span>
00963                 <span class="comment">// file, ClusterSize is assumed to be 1.  When the file</span>
00964                 <span class="comment">// is opened later (for the SYSTEM hive) we need</span>
00965                 <span class="comment">// to update this field in the hive if we are</span>
00966                 <span class="comment">// booting from media where the cluster size &gt; 1</span>
00967                 <span class="comment">//</span>
00968                 <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> != ClusterSize) {
00969                     <span class="comment">//</span>
00970                     <span class="comment">// The cluster size is different than previous assumed.</span>
00971                     <span class="comment">// Since a cluster in the dirty vector must be either</span>
00972                     <span class="comment">// completely dirty or completely clean, go through the</span>
00973                     <span class="comment">// dirty vector and mark all clusters that contain a dirty</span>
00974                     <span class="comment">// logical sector as completely dirty.</span>
00975                     <span class="comment">//</span>
00976                     PRTL_BITMAP  <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
00977                     ULONG        <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00978 
00979                     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = &amp;(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00980                     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00981                          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00982                          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += ClusterSize)
00983                     {
00984                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a40">RtlAreBitsClear</a> (BitMap, Index, ClusterSize)) {
00985                             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a34">RtlSetBits</a> (BitMap, Index, ClusterSize);
00986                         }
00987                     }
00988                     <span class="comment">//</span>
00989                     <span class="comment">// Update DirtyCount and Cluster</span>
00990                     <span class="comment">//</span>
00991                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a39">RtlNumberOfSetBits</a>(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>);
00992                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> = ClusterSize;
00993                 }
00994 
00995                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/cmwraper_8c.html#a29">CmpFileSetSize</a>(
00996                         (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_PRIMARY, Length) ||
00997                     !<a class="code" href="../../d6/d3/cmwraper_8c.html#a29">CmpFileSetSize</a>(
00998                         (<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive, HFILE_TYPE_ALTERNATE, Length)
00999                    )
01000                 {
01001                     <span class="comment">//</span>
01002                     <span class="comment">// WARNNOTE</span>
01003                     <span class="comment">// Data written into the system hive since boot</span>
01004                     <span class="comment">// cannot be written out, punt.</span>
01005                     <span class="comment">//</span>
01006                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01007 
01008                     <span class="comment">//KeBugCheckEx(CANNOT_WRITE_CONFIGURATION,5,4,i,0);</span>
01009                 }
01010 
01011                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, Hive) == 0);
01012 
01013                 <span class="keywordflow">if</span> ( (PrimaryDisposition == FILE_CREATED) ||
01014                      (SecondaryDisposition == FILE_CREATED) ||
01015                      (!<a class="code" href="../../d1/d3/cmsysini_8c.html#a33">CmpValidateAlternate</a>(LogHandle,CmHive)))
01016                 {
01017                     <span class="comment">//</span>
01018                     <span class="comment">// Force all data to be written to the secondary (.alt)</span>
01019                     <span class="comment">//</span>
01020                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] =
01021                         CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>];
01022                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/hivesync_8c.html#a15">HvWriteHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
01023                     CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o1">FileHandles</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a41">HFILE_TYPE_EXTERNAL</a>] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01024 
01025                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01026                         <span class="comment">//</span>
01027                         <span class="comment">// WARNNOTE</span>
01028                         <span class="comment">//  If we keep running here, we risk REALLY</span>
01029                         <span class="comment">//  screwing the user over (eating all their</span>
01030                         <span class="comment">//  data), while if we fail, we'll at least</span>
01031                         <span class="comment">//  fail clean.</span>
01032                         <span class="comment">//</span>
01033                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01034 
01035                         <span class="comment">//KeBugCheckEx(CANNOT_WRITE_CONFIGURATION,5,5,0,0);</span>
01036                     }
01037                 }
01038                 <a class="code" href="../../d1/d2/cmp_8h.html#a309">CmpAddToHiveFileList</a>(CmpMachineHiveList[i].CmHive);
01039 
01040                 <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)CmHive);
01041 
01042                 <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a8">CmpCannotWriteConfiguration</a> ) {
01043                     <span class="comment">//</span>
01044                     <span class="comment">// The system disk is full; Give user a chance to log-on and make room</span>
01045                     <span class="comment">//</span>
01046                     <a class="code" href="../../d5/d3/cmworker_8c.html#a19">CmpDiskFullWarning</a>();
01047                     <a class="code" href="../../d6/d3/cmwraper_8c.html#a11">CmpLazyFlush</a>();
01048                 }
01049             }
01050         }
01051     }   <span class="comment">// for</span>
01052 
01053     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Create symbolic link from SECURITY hive into SAM hive.</span>
01057     <span class="comment">//</span>
01058     <a class="code" href="../../d1/d3/cmsysini_8c.html#a32">CmpLinkKeyToHive</a>(
01059         L<span class="stringliteral">"\\Registry\\Machine\\Security\\SAM"</span>,
01060         L<span class="stringliteral">"\\Registry\\Machine\\SAM\\SAM"</span>
01061         );
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">// Create predefined handles.</span>
01065     <span class="comment">//</span>
01066     <a class="code" href="../../d1/d3/cmsysini_8c.html#a31">CmpCreatePerfKeys</a>();
01067 
01068     <span class="keywordflow">return</span>;
01069 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="cmsysini.c::CmpInitializeSystemHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpInitializeSystemHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">2022</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00108">CmCheckRegistry()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01609">_HIVE_LIST_ENTRY::CmHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00496">CmpLinkHiveToMaster()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00043">CmpLoadOptions</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00250">CmpMachineHiveList</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00187">CmpSystemFileName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00174">CmRegistryMachineSystemName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">HINIT_MEMORY</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00063">SYSTEM_HIVE_INDEX</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.
<p>
<pre class="fragment"><div>02027                    :
02028 
02029     Initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SYSTEM hive based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raw hive image passed in
02030     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
02031 
02032 Arguments:
02033 
02034     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Loader Block passed in by
02035         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
02036 
02037 Return Value:
02038 
02039     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> worked
02040 
02041     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> failed
02042 
02043 --*/
02044 
02045 {
02046     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> SystemHive;
02047     PVOID HiveImageBase;
02048     BOOLEAN Allocate=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02049     PSECURITY_DESCRIPTOR SecurityDescriptor;
02050     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02051     STRING  TempString;
02052 
02053 
02054     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02055 
02056     <span class="comment">//</span>
02057     <span class="comment">// capture tail of boot.ini line (load options, portable)</span>
02058     <span class="comment">//</span>
02059     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
02060         &amp;TempString,
02061         LoaderBlock-&gt;LoadOptions
02062         );
02063 
02064     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length = 0;
02065     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.MaximumLength = (TempString.Length+1)*<span class="keyword">sizeof</span>(WCHAR);
02066     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02067                                 PagedPool, (TempString.Length+1)*<span class="keyword">sizeof</span>(WCHAR));
02068 
02069     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02070         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,5,6,0,0); <span class="comment">// odds against this are huge</span>
02071     }
02072     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
02073         &amp;CmpLoadOptions,
02074         &amp;TempString,
02075         FALSE
02076         );
02077     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Buffer[TempString.Length] = UNICODE_NULL;
02078     <a class="code" href="../../d6/d0/cmdat_8c.html#a0">CmpLoadOptions</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
02079 
02080 
02081     <span class="comment">//</span>
02082     <span class="comment">// move the loaded registry into the real registry</span>
02083     <span class="comment">//</span>
02084     HiveImageBase = LoaderBlock-&gt;RegistryBase;
02085 
02086     <span class="keywordflow">if</span> (HiveImageBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02087         <span class="comment">//</span>
02088         <span class="comment">// No memory descriptor for the hive, so we must recreate it.</span>
02089         <span class="comment">//</span>
02090         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;SystemHive,
02091                     HINIT_CREATE,
02092                     0,
02093                     HFILE_TYPE_ALTERNATE,
02094                     NULL,
02095                     NULL,
02096                     NULL,
02097                     NULL,
02098                     NULL,
02099                     &amp;CmpSystemFileName);
02100         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02101             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02102                 KdPrint((<span class="stringliteral">"CmpInitializeSystemHive: "</span>));
02103                 KdPrint((<span class="stringliteral">"Couldn't initialize newly allocated SYSTEM hive\n"</span>));
02104             }
02105             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02106         }
02107         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02108 
02109     } <span class="keywordflow">else</span> {
02110 
02111         <span class="comment">//</span>
02112         <span class="comment">// There is a memory image for the hive, copy it and make it active</span>
02113         <span class="comment">//</span>
02114         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;SystemHive,
02115                     HINIT_MEMORY,
02116                     0,
02117                     HFILE_TYPE_ALTERNATE,
02118                     HiveImageBase,
02119                     NULL,
02120                     NULL,
02121                     NULL,
02122                     NULL,
02123                     &amp;CmpSystemFileName);
02124         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02125                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02126                 KdPrint((<span class="stringliteral">"CmpInitializeSystemHive: "</span>));
02127                 KdPrint((<span class="stringliteral">"Couldn't initialize OS Loader-loaded SYSTEM hive\n"</span>));
02128             }
02129             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02130         }
02131 
02132         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d2/cmp_8h.html#a294">CmCheckRegistry</a>(SystemHive, TRUE) != 0) {
02133             <span class="comment">//</span>
02134             <span class="comment">// We couldn't use the SYSTEM hive passed in from the loader.</span>
02135             <span class="comment">// We are dead.</span>
02136             <span class="comment">//</span>
02137             <span class="comment">//</span>
02138             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_SYSTEM_CONFIG_INFO,5,7,0,0);
02139         }
02140         Allocate = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02141     }
02142 
02143     <span class="comment">//</span>
02144     <span class="comment">// Create the link node</span>
02145     <span class="comment">//</span>
02146     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
02147 
02148     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(&amp;CmRegistryMachineSystemName,
02149                                  NULL,
02150                                  SystemHive,
02151                                  Allocate,
02152                                  SecurityDescriptor);
02153     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
02154 
02155     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02156         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT_ERROR) {
02157             KdPrint((<span class="stringliteral">"CmInitSystem1: CmpLinkHiveToMaster(Hardware) failed\n"</span>));
02158         }
02159         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02160     }
02161 
02162     <a class="code" href="../../d6/d0/cmdat_8c.html#a62">CmpMachineHiveList</a>[<a class="code" href="../../d1/d3/cmsysini_8c.html#a2">SYSTEM_HIVE_INDEX</a>].<a class="code" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html#o2">CmHive</a> = SystemHive;
02163 
02164     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02165 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="cmsysini.c::CmpInterlockedFunction" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpInterlockedFunction           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>RegistryValueKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>VOID(*&nbsp;</td>
          <td class="mdname" nowrap> <em>InterlockedFunction</em>)(VOID)</td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">1845</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00236">CmpControlSessionManager</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00904">NtFlushKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.
<p>
<pre class="fragment"><div>01851                    :
01852 
01853     This routine guards calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InterlockedFunction in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01854     passed RegistryValueKey.
01855 
01856     The RegistryValueKey will record <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first
01857     call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InterlockedFunction.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system crashes
01858     durning <span class="keyword">this</span> call then ValueKey will be left in a state
01859     where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InterlockedFunction will not be called on subsequent
01860     attempts.
01861 
01862 Arguments:
01863 
01864     RegistryValueKey - ValueKey name <span class="keywordflow">for</span> Control\Session <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a79">Manager</a>
01865     InterlockedFunction - Function to call
01866 
01867 Return Value:
01868 
01869     STATUS_SUCCESS  - The interlocked function was successfully called
01870 
01871 
01872 --*/
01873 {
01874     OBJECT_ATTRIBUTES   objectAttributes;
01875     HANDLE              hControl, hSession;
01876     UNICODE_STRING      <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01877     UCHAR               <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> [<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION)+<span class="keyword">sizeof</span>(ULONG)];
01878     ULONG               length, Value;
01879     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01880 
01881     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01882 
01883     <span class="comment">//</span>
01884     <span class="comment">// Open CurrentControlSet</span>
01885     <span class="comment">//</span>
01886 
01887     InitializeObjectAttributes (
01888         &amp;objectAttributes,
01889         &amp;CmRegistryMachineSystemCurrentControlSet,
01890         OBJ_CASE_INSENSITIVE,
01891         NULL,
01892         NULL
01893         );
01894 
01895     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;hControl, KEY_READ | KEY_WRITE, &amp;objectAttributes);
01896     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01897         <span class="keywordflow">return</span> status;
01898     }
01899 
01900     <span class="comment">//</span>
01901     <span class="comment">// Open Control\Session Manager</span>
01902     <span class="comment">//</span>
01903 
01904     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;Name, CmpControlSessionManager);
01905     InitializeObjectAttributes (
01906         &amp;objectAttributes,
01907         &amp;Name,
01908         OBJ_CASE_INSENSITIVE,
01909         hControl,
01910         NULL
01911         );
01912 
01913     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;hSession, KEY_READ | KEY_WRITE, &amp;objectAttributes );
01914     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hControl);
01915     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01916         <span class="keywordflow">return</span> status;
01917     }
01918 
01919     <span class="comment">//</span>
01920     <span class="comment">// Read ValueKey to interlock operation with</span>
01921     <span class="comment">//</span>
01922 
01923     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;Name, RegistryValueKey);
01924     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (hSession,
01925                               &amp;Name,
01926                               KeyValuePartialInformation,
01927                               Buffer,
01928                               <span class="keyword">sizeof</span> (Buffer),
01929                               &amp;length );
01930 
01931     Value = 0;
01932     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01933         Value = ((PKEY_VALUE_PARTIAL_INFORMATION)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>)-&gt;Data[0];
01934     }
01935 
01936     <span class="comment">//</span>
01937     <span class="comment">// Value 0  - Before InterlockedFunction</span>
01938     <span class="comment">//       1  - In the middle of InterlockedFunction</span>
01939     <span class="comment">//       2  - After InterlockedFunction</span>
01940     <span class="comment">//</span>
01941     <span class="comment">// If the value is a 0, then we haven't tried calling this</span>
01942     <span class="comment">// interlocked function, set the value to a 1 and try it.</span>
01943     <span class="comment">//</span>
01944     <span class="comment">// If the value is a 1, then we crased durning an execution</span>
01945     <span class="comment">// of the interlocked function last time, don't try it again.</span>
01946     <span class="comment">//</span>
01947     <span class="comment">// If the value is a 2, then we called the interlocked function</span>
01948     <span class="comment">// before and it worked.  Call it again this time.</span>
01949     <span class="comment">//</span>
01950 
01951     <span class="keywordflow">if</span> (Value != 1) {
01952 
01953         <span class="keywordflow">if</span> (Value != 2) {
01954             <span class="comment">//</span>
01955             <span class="comment">// This interlocked function is not known to work.  Write</span>
01956             <span class="comment">// a 1 to this value so we can detect if we crash durning</span>
01957             <span class="comment">// this call.</span>
01958             <span class="comment">//</span>
01959 
01960             Value = 1;
01961             <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (hSession, &amp;Name, 0L, REG_DWORD, &amp;Value, <span class="keyword">sizeof</span> (Value));
01962             <a class="code" href="../../d7/d7/ntapi_8c.html#a19">NtFlushKey</a>    (hSession);   <span class="comment">// wait until it's on the disk</span>
01963         }
01964 
01965         InterlockedFunction();
01966 
01967         <span class="keywordflow">if</span> (Value != 2) {
01968             <span class="comment">//</span>
01969             <span class="comment">// The worker function didn't crash - update the value for</span>
01970             <span class="comment">// this interlocked function to 2.</span>
01971             <span class="comment">//</span>
01972 
01973             Value = 2;
01974             <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (hSession, &amp;Name, 0L, REG_DWORD, &amp;Value, <span class="keyword">sizeof</span> (Value));
01975         }
01976 
01977     } <span class="keywordflow">else</span> {
01978         status = STATUS_UNSUCCESSFUL;
01979     }
01980 
01981     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (hSession);
01982     <span class="keywordflow">return</span> status;
01983 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="cmsysini.c::CmpIsLastKnownGoodBoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpIsLastKnownGoodBoot           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03863">3863</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03778">CmBootLastKnownGood()</a>.
<p>
<pre class="fragment"><div>03869                    :
03870 
03871     Determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current system boot <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a LastKnownGood boot or
03872     not.  It does <span class="keyword">this</span> by comparing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following two values:
03873 
03874         \registry\machine\system\select:Current
03875         \registry\machine\system\select:LastKnownGood
03876 
03877     If both of these values refer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set, and <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
03878     set <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different from:
03879 
03880         \registry\machine\system\select:Default
03881 
03882     we are booting LastKnownGood.
03883 
03884 Arguments:
03885 
03886     None.
03887 
03888 Return Value:
03889 
03890     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>  - Booting LastKnownGood
03891     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - Not booting LastKnownGood
03892 
03893 --*/
03894 
03895 {
03896     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03897     ULONG Default;
03898     ULONG Current;
03899     ULONG LKG;
03900     RTL_QUERY_REGISTRY_TABLE QueryTable[] = {
03901         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03902          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>, &amp;Current,
03903          REG_DWORD, (PVOID)&amp;Current, 0 },
03904         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03905          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LastKnownGood"</span>, &amp;LKG,
03906          REG_DWORD, (PVOID)&amp;LKG, 0 },
03907         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      RTL_QUERY_REGISTRY_DIRECT,
03908          <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>, &amp;Default,
03909          REG_DWORD, (PVOID)&amp;Default, 0 },
03910         {<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,      0,
03911          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03912          REG_NONE, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 }
03913     };
03914 
03915     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03916 
03917     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(RTL_REGISTRY_ABSOLUTE,
03918                                     L<span class="stringliteral">"\\Registry\\Machine\\System\\Select"</span>,
03919                                     QueryTable,
03920                                     NULL,
03921                                     NULL);
03922     <span class="comment">//</span>
03923     <span class="comment">// If this failed, something is severely wrong.</span>
03924     <span class="comment">//</span>
03925 
03926     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
03927     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03928         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
03929             KdPrint((<span class="stringliteral">"CmpIsLastKnownGoodBoot: RtlQueryRegistryValues "</span>));
03930             KdPrint((<span class="stringliteral">"failed, Status %08lx\n"</span>, Status));
03931         }
03932         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03933     }
03934 
03935     <span class="keywordflow">if</span> ((LKG == Current) &amp;&amp; (Current != Default)){
03936         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03937     } <span class="keywordflow">else</span> {
03938         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03939     }
03940 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="cmsysini.c::CmpLinkHiveToMaster" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpLinkHiveToMaster           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>LinkName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>RootDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CmHive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Allocate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01421">1421</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00775">_CM_PARSE_CONTEXT::ChildHive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00771">_CM_PARSE_CONTEXT::Class</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00114">CmpReportNotify()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00272">CMS_INIT_ERROR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00774">_CM_PARSE_CONTEXT::CreateLink</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00772">_CM_PARSE_CONTEXT::CreateOptions</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00341">_CM_KEY_REFERENCE::KeyCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00342">_CM_KEY_REFERENCE::KeyHive</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00770">_CM_PARSE_CONTEXT::TitleIndex</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01430                    :
01431 
01432     The existing, <span class="stringliteral">"free floating"</span> hive CmHive describes <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> linked into
01433     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name space at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> node named by LinkName.  The node will be created.
01434     The hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to already have an appropriate root node.
01435 
01436 Arguments:
01437 
01438     LinkName - supplies a pointer to a unicode string which describes where
01439                 in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry name space <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be linked.
01440                 All components but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last must exist.  The last must not.
01441 
01442     RootDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LinkName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to.
01443 
01444     CmHive - pointer to a <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a> structure describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive to link in.
01445 
01446     Allocate - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created
01447                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root cell already exists.
01448 
01449     SecurityDescriptor - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to
01450                be placed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive root.
01451 
01452 Return Value:
01453 
01454     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> == success, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> == <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>
01455 
01456 --*/
01457 {
01458     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01459     HANDLE              KeyHandle;
01460     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">CM_PARSE_CONTEXT</a>    ParseContext;
01461     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01462     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>        KeyBody;
01463 
01464     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01465     <span class="comment">//</span>
01466     <span class="comment">// Fill in special ParseContext to indicate that we are creating</span>
01467     <span class="comment">// a link node and opening or creating a root node.</span>
01468     <span class="comment">//</span>
01469     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o0">TitleIndex</a> = 0;
01470     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Length = 0;
01471     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.MaximumLength = 0;
01472     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o1">Class</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o2">CreateOptions</a> = 0;
01474     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01475     ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o1">KeyHive</a> = &amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>;
01476     <span class="keywordflow">if</span> (Allocate) {
01477 
01478         <span class="comment">//</span>
01479         <span class="comment">// Creating a new root node</span>
01480         <span class="comment">//</span>
01481 
01482         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01483     } <span class="keywordflow">else</span> {
01484 
01485         <span class="comment">//</span>
01486         <span class="comment">// Opening an existing root node</span>
01487         <span class="comment">//</span>
01488 
01489         ParseContext.<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o5">ChildHive</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>;
01490     }
01491 
01492     <span class="comment">//</span>
01493     <span class="comment">// Create a path to the hive</span>
01494     <span class="comment">//</span>
01495     InitializeObjectAttributes(
01496         &amp;ObjectAttributes,
01497         LinkName,
01498         OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01499         (HANDLE)RootDirectory,
01500         SecurityDescriptor
01501         );
01502 
01503     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( &amp;ObjectAttributes,
01504                                  CmpKeyObjectType,
01505                                  KernelMode,
01506                                  NULL,
01507                                  KEY_READ | KEY_WRITE,
01508                                  (PVOID)&amp;ParseContext,
01509                                  &amp;KeyHandle );
01510 
01511     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01512         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT_ERROR) {
01513             KdPrint((<span class="stringliteral">"CmpLinkHiveToMaster: "</span>));
01514             KdPrint((<span class="stringliteral">"ObOpenObjectByName() failed %08lx\n"</span>, Status));
01515             KdPrint((<span class="stringliteral">"\tLinkName='%ws'\n"</span>, LinkName));
01516         }
01517         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01518     }
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// Report the notification event</span>
01522     <span class="comment">//</span>
01523     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(KeyHandle,
01524                                        0,
01525                                        CmpKeyObjectType,
01526                                        KernelMode,
01527                                        (PVOID *)&amp;KeyBody,
01528                                        NULL);
01529     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
01530     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01531         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>,
01532                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
01533                         KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
01534                         REG_NOTIFY_CHANGE_NAME);
01535 
01536         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)KeyBody);
01537     }
01538 
01539     ZwClose(KeyHandle);
01540     <span class="keywordflow">return</span> STATUS_SUCCESS;
01541 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="cmsysini.c::CmpLinkKeyToHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpLinkKeyToHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>HivePath</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">3983</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00035">CmSymbolicLinkValueName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00058">KeyPath</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.
<p>
<pre class="fragment"><div>03990                    :
03991 
03992     Creates a symbolic link at <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a> that points to HivePath.
03993 
03994 Arguments:
03995 
03996     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a> - pointer to unicode string with name of key
03997               (e.g. <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\Security\\SAM"</span>)
03998 
03999     HivePath - pointer to unicode string with name of hive root
04000                (e.g. <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\SAM\\SAM"</span>)
04001 
04002 Return Value:
04003 
04004     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> links were successfully created, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04005 
04006 --*/
04007 
04008 {
04009     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
04010     UNICODE_STRING LinkName;
04011     OBJECT_ATTRIBUTES Attributes;
04012     HANDLE LinkHandle;
04013     ULONG Disposition;
04014     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04015 
04016     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04017 
04018     <span class="comment">//</span>
04019     <span class="comment">// Create link for CLONE hive</span>
04020     <span class="comment">//</span>
04021 
04022     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;KeyName, KeyPath);
04023     InitializeObjectAttributes(&amp;Attributes,
04024                                &amp;KeyName,
04025                                OBJ_CASE_INSENSITIVE,
04026                                NULL,
04027                                NULL);
04028     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;LinkHandle,
04029                          KEY_CREATE_LINK,
04030                          &amp;Attributes,
04031                          0,
04032                          NULL,
04033                          REG_OPTION_VOLATILE | REG_OPTION_CREATE_LINK,
04034                          &amp;Disposition);
04035     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04036         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
04037             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: couldn't create %S\n"</span>, &amp;KeyName));
04038             KdPrint((<span class="stringliteral">"    Status = %08lx\n"</span>,Status));
04039         }
04040         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04041     }
04042 
04043     <span class="comment">//</span>
04044     <span class="comment">// Check to make sure that the key was created, not just opened.  Since</span>
04045     <span class="comment">// this key is always created volatile, it should never be present in</span>
04046     <span class="comment">// the hive when we boot.</span>
04047     <span class="comment">//</span>
04048     <span class="keywordflow">if</span> (Disposition != REG_CREATED_NEW_KEY) {
04049         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
04050             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: %S already exists!\n"</span>, &amp;KeyName));
04051         }
04052 
04053         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
04054         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04055     }
04056 
04057     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LinkName, HivePath);
04058     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(LinkHandle,
04059                            &amp;CmSymbolicLinkValueName,
04060                            0,
04061                            REG_LINK,
04062                            LinkName.Buffer,
04063                            LinkName.Length);
04064     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
04065     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
04066         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
04067             KdPrint((<span class="stringliteral">"CM: CmpLinkKeyToHive: couldn't create symbolic link for %S\n"</span>, HivePath));
04068         }
04069         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04070     }
04071 
04072     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04073 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="cmsysini.c::CmpSaveBootControlSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpSaveBootControlSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlSetNum</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">3458</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00417">CLONE_CONTROL_SET</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01327">CmpCopyTreeEx</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03747">CmpDeleteCloneTree()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00289">CmpKeyObjectType</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l01339">CmpSyncTrees</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00175">CmRegistryMachineSystemCurrentControlSet</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">NtQuerySecurityObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.
<p>
<pre class="fragment"><div>03461                    :
03462 
03463    This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible <span class="keywordflow">for</span> saving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set
03464    used to accomplish <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> latest boot into a different <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
03465    set (presumably so that the different control set may be
03466    marked as the LKG control set).
03467 
03468    This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d7/d7/ntapi_8c.html#a20">NtInitializeRegistry</a> when
03469    a boot <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accepted via that routine.
03470 
03471 Arguments:
03472 
03473    ControlSetNum - The number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set that will
03474                    be used to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set.
03475 
03476 Return Value:
03477 
03478    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
03479 
03480       STATUS_SUCCESS - everything worked perfectly
03481       STATUS_REGISTRY_CORRUPT - could not save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> set,
03482                                 <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> likely that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> copy or sync
03483                                 operation used <span class="keywordflow">for</span> <span class="keyword">this</span> save failed
03484                                 and some part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>
03485                                 set was not saved.
03486 --*/
03487 {
03488    UNICODE_STRING SavedBoot, Boot;
03489    HANDLE BootHandle, SavedBootHandle;
03490    OBJECT_ATTRIBUTES Attributes;
03491    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03492    <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> BootKey, SavedBootKey;
03493    ULONG Disposition;
03494    PSECURITY_DESCRIPTOR Security;
03495    ULONG SecurityLength;
03496    BOOLEAN CopyRet;
03497    WCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
03498 
03499    <span class="comment">//</span>
03500    <span class="comment">// Figure out where the boot control set is</span>
03501    <span class="comment">//</span>
03502 
03503 <span class="preprocessor">#if CLONE_CONTROL_SET</span>
03504 <span class="preprocessor"></span>
03505    <span class="comment">//</span>
03506    <span class="comment">// If we have cloned the control set, then use the clone</span>
03507    <span class="comment">// since it is guaranteed to have an untouched copy of the</span>
03508    <span class="comment">// boot control set</span>
03509    <span class="comment">//</span>
03510 
03511    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Boot,
03512                         L<span class="stringliteral">"\\Registry\\Machine\\System\\Clone"</span>);
03513 
03514    InitializeObjectAttributes(&amp;Attributes,
03515                               &amp;Boot,
03516                               OBJ_CASE_INSENSITIVE,
03517                               NULL,
03518                               NULL);
03519 <span class="preprocessor">#else</span>
03520 <span class="preprocessor"></span>
03521    <span class="comment">//</span>
03522    <span class="comment">// If we are not using the clone, then just use the</span>
03523    <span class="comment">// current control set.</span>
03524    <span class="comment">//</span>
03525 
03526    InitializeObjectAttributes(&amp;Attributes,
03527                               &amp;CmRegistryMachineSystemCurrentControlSet,
03528                               OBJ_CASE_INSENSITIVE,
03529                               NULL,
03530                               NULL);
03531 <span class="preprocessor">#endif</span>
03532 <span class="preprocessor"></span>
03533    <span class="comment">//</span>
03534    <span class="comment">// Open the boot control set</span>
03535    <span class="comment">//</span>
03536 
03537    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(&amp;BootHandle,
03538                       KEY_READ,
03539                       &amp;Attributes);
03540 
03541 
03542    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03543 
03544    <span class="comment">//</span>
03545    <span class="comment">// We may be saving the boot control set into a brand new</span>
03546    <span class="comment">// tree that we will create. If this is true, then we will</span>
03547    <span class="comment">// need to create the root node of this tree below</span>
03548    <span class="comment">// and give it the right security descriptor. So, we fish</span>
03549    <span class="comment">// the security descriptor out of the root node of the</span>
03550    <span class="comment">// boot control set tree.</span>
03551    <span class="comment">//</span>
03552 
03553    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(BootHandle,
03554                                   DACL_SECURITY_INFORMATION,
03555                                   NULL,
03556                                   0,
03557                                   &amp;SecurityLength);
03558 
03559 
03560    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>==STATUS_BUFFER_TOO_SMALL) {
03561 
03562       Security=<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,SecurityLength);
03563 
03564       <span class="keywordflow">if</span> (Security!=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03565 
03566          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>(BootHandle,
03567                                         DACL_SECURITY_INFORMATION,
03568                                         Security,
03569                                         SecurityLength,
03570                                         &amp;SecurityLength);
03571 
03572 
03573          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03574             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03575             Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03576          }
03577       }
03578 
03579    } <span class="keywordflow">else</span> {
03580       Security=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03581    }
03582 
03583    <span class="comment">//</span>
03584    <span class="comment">// Now, create the path of the control set we will be saving to</span>
03585    <span class="comment">//</span>
03586 
03587    swprintf(Buffer, L<span class="stringliteral">"\\Registry\\Machine\\System\\ControlSet%03d"</span>, ControlSetNum);
03588 
03589    <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SavedBoot,
03590                         Buffer);
03591 
03592    <span class="comment">//</span>
03593    <span class="comment">// Open/Create the control set to which we are saving</span>
03594    <span class="comment">//</span>
03595 
03596    InitializeObjectAttributes(&amp;Attributes,
03597                               &amp;SavedBoot,
03598                               OBJ_CASE_INSENSITIVE,
03599                               NULL,
03600                               Security);
03601 
03602    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(&amp;SavedBootHandle,
03603                         KEY_READ | KEY_WRITE,
03604                         &amp;Attributes,
03605                         0,
03606                         NULL,
03607                         REG_OPTION_NON_VOLATILE,
03608                         &amp;Disposition);
03609 
03610 
03611    <span class="keywordflow">if</span> (Security) <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Security);
03612 
03613    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03614       <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BootHandle);
03615       <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03616    }
03617 
03618    <span class="comment">//</span>
03619    <span class="comment">// Get the key objects for out two controls</span>
03620    <span class="comment">//</span>
03621 
03622    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(BootHandle,
03623                                       KEY_READ,
03624                                       CmpKeyObjectType,
03625                                       KernelMode,
03626                                       (PVOID *)(&amp;BootKey),
03627                                       NULL);
03628 
03629    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) <span class="keywordflow">goto</span> Exit;
03630 
03631    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(SavedBootHandle,
03632                                       KEY_WRITE,
03633                                       CmpKeyObjectType,
03634                                       KernelMode,
03635                                       (PVOID *)(&amp;SavedBootKey),
03636                                       NULL);
03637 
03638 
03639    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03640       <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)BootKey);
03641       <span class="keywordflow">goto</span> Exit;
03642    }
03643 
03644    <span class="comment">//</span>
03645    <span class="comment">// Lock the registry and do the actual saving</span>
03646    <span class="comment">//</span>
03647 
03648    <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03649 
03650    <span class="keywordflow">if</span> (Disposition == REG_CREATED_NEW_KEY) {
03651 
03652       <span class="comment">//</span>
03653       <span class="comment">// If we are saving to a control set that we have just</span>
03654       <span class="comment">// created, it is most efficient to just copy</span>
03655       <span class="comment">// the boot control set tree into the new control set.</span>
03656       <span class="comment">//</span>
03657 
03658       <span class="comment">//</span>
03659       <span class="comment">// N.B. We copy the volatile keys only if we are using</span>
03660       <span class="comment">//      a clone and thus our boot control set tree is</span>
03661       <span class="comment">//      composed only of volatile keys.</span>
03662       <span class="comment">//</span>
03663 
03664       CopyRet = <a class="code" href="../../d1/d2/cmp_8h.html#a119">CmpCopyTreeEx</a>(BootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
03665                               BootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
03666                               SavedBootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
03667                               SavedBootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
03668                               CLONE_CONTROL_SET);
03669 
03670         <span class="comment">//</span>
03671         <span class="comment">// Set the max subkey name property for the new target key.</span>
03672         <span class="comment">//</span>
03673         SavedBootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = BootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a>;
03674    } <span class="keywordflow">else</span> {
03675 
03676       <span class="comment">//</span>
03677       <span class="comment">// If we are saving to a control set that already exists</span>
03678       <span class="comment">// then its likely that this control set is nearly identical</span>
03679       <span class="comment">// to the boot control set (control sets don't change much</span>
03680       <span class="comment">// between boots).</span>
03681       <span class="comment">//</span>
03682       <span class="comment">// Furthermore, the control set we are saving to must be old</span>
03683       <span class="comment">// and hence has not been modified at all since it ceased</span>
03684       <span class="comment">// being a current control set.</span>
03685       <span class="comment">//</span>
03686       <span class="comment">// Thus, it is most efficient for us to simply synchronize</span>
03687       <span class="comment">// the target control set with the boot control set.</span>
03688       <span class="comment">//</span>
03689 
03690       <span class="comment">//</span>
03691       <span class="comment">// N.B. We sync the volatile keys only if we are using</span>
03692       <span class="comment">//      a clone for the same reasons as stated above.</span>
03693       <span class="comment">//</span>
03694 
03695       CopyRet = <a class="code" href="../../d1/d2/cmp_8h.html#a120">CmpSyncTrees</a>(BootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
03696                              BootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
03697                              SavedBootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>,
03698                              SavedBootKey-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>,
03699                              CLONE_CONTROL_SET);
03700    }
03701 
03702    <span class="comment">//</span>
03703    <span class="comment">// Check if the Copy/Sync succeeded and adjust our return code</span>
03704    <span class="comment">// accordingly.</span>
03705    <span class="comment">//</span>
03706 
03707    <span class="keywordflow">if</span> (CopyRet) {
03708       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03709    } <span class="keywordflow">else</span> {
03710       <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
03711    }
03712 
03713    <span class="comment">//</span>
03714    <span class="comment">// All done. Clean up.</span>
03715    <span class="comment">//</span>
03716 
03717    <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03718 
03719    <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)BootKey);
03720    <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)SavedBootKey);
03721 
03722 Exit:
03723 
03724    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BootHandle);
03725    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SavedBootHandle);
03726 
03727 <span class="preprocessor">#if CLONE_CONTROL_SET</span>
03728 <span class="preprocessor"></span>
03729    <span class="comment">//</span>
03730    <span class="comment">// If we have been using a clone, then the clone is no longer</span>
03731    <span class="comment">// needed since we have saved its contents into a non-volatile</span>
03732    <span class="comment">// control set. Thus, we can just erase it.</span>
03733    <span class="comment">//</span>
03734 
03735    <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
03736    {
03737       <a class="code" href="../../d1/d3/cmsysini_8c.html#a55">CmpDeleteCloneTree</a>();
03738    }
03739 
03740 <span class="preprocessor">#endif</span>
03741 <span class="preprocessor"></span>
03742    <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
03743 
03744 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="cmsysini.c::CmpSetVersionData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpSetVersionData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">1545</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d9/d0/init_8h-source.html#l00034">CmCSDVersionString</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01986">CmpConfigureProcessors()</a>, <a class="el" href="../../d8/d1/cmse_8c-source.html#l01227">CmpHiveRootSecurityDescriptor()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00235">CmpProcessorControl</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00033">CmVersionString</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/triage_8c-source.html#l00042">NtBuildNumber</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00504">NtDeleteValueKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02672">NtSetValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00028">NtSystemRoot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00159">nullclass</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00137">RtlFreeStringRoutine</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d9/heappage_8c.html#a68">sprintf()</a>, and <a class="el" href="../../d2/d0/hivedmp_8c-source.html#l00060">ValueBuffer</a>.
<p>
Referenced by <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00997">NtInitializeRegistry()</a>.
<p>
<pre class="fragment"><div>01550                    :
01551 
01552     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> \REGISTRY\MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion:
01553                 CurrentVersion = VER_PRODUCTVERSION_STR             <span class="comment">// From ntverp.h</span>
01554                 CurrentBuildNumber = VER_PRODUCTBUILD               <span class="comment">// From ntverp.h</span>
01555                 CurrentType = <span class="stringliteral">"[Multiprocessor|Uniprocessor]        // From NT_UP</span>
01556 <span class="stringliteral">                                [Retail|Free|Checked]"</span>              <span class="comment">// From DBG, DEVL</span>
01557                 SystemRoot = <span class="stringliteral">"[c:\nt]"</span>
01558 
01559 
01560     NOTE:   It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not worth bugchecking over <span class="keyword">this</span>, so <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
01561             work, just fail.
01562 
01563 Arguments:
01564 
01565 Return Value:
01566 
01567 --*/
01568 {
01569     ANSI_STRING     AnsiString;
01570     UNICODE_STRING  NameString;
01571     UNICODE_STRING  ValueString;
01572     HANDLE          key1, key2;
01573     UCHAR           WorkString[128];
01574     WCHAR           <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>[128];
01575     OBJECT_ATTRIBUTES   <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01576     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
01577     PUCHAR              proctype;
01578     PUCHAR              buildtype;
01579     PSECURITY_DESCRIPTOR SecurityDescriptor;
01580 
01581     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01582     <span class="comment">//</span>
01583     <span class="comment">// Get default security descriptor for the nodes we will create.</span>
01584     <span class="comment">//</span>
01585     SecurityDescriptor = <a class="code" href="../../d7/d2/cmse_8c.html#a13">CmpHiveRootSecurityDescriptor</a>();
01586 
01587     <span class="comment">//</span>
01588     <span class="comment">// Create the key</span>
01589     <span class="comment">//</span>
01590     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01591         &amp;NameString,
01592         L<span class="stringliteral">"\\REGISTRY\\MACHINE\\SOFTWARE\\Microsoft"</span>
01593         );
01594 
01595     InitializeObjectAttributes(
01596         &amp;ObjectAttributes,
01597         &amp;NameString,
01598         OBJ_CASE_INSENSITIVE,
01599         (HANDLE)NULL,
01600         SecurityDescriptor
01601         );
01602 
01603     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01604                 &amp;key1,
01605                 KEY_CREATE_SUB_KEY,
01606                 &amp;ObjectAttributes,
01607                 0,
01608                 &amp;nullclass,
01609                 0,
01610                 NULL
01611                 );
01612 
01613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01614 <span class="preprocessor">#if DBG</span>
01615 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01616                  &amp;NameString, status);
01617 <span class="preprocessor">#endif</span>
01618 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01619         <span class="keywordflow">return</span>;
01620     }
01621 
01622     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01623         &amp;NameString,
01624         L<span class="stringliteral">"Windows NT"</span>
01625         );
01626 
01627     InitializeObjectAttributes(
01628         &amp;ObjectAttributes,
01629         &amp;NameString,
01630         OBJ_CASE_INSENSITIVE,
01631         key1,
01632         SecurityDescriptor
01633         );
01634 
01635     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01636                 &amp;key2,
01637                 KEY_SET_VALUE,
01638                 &amp;ObjectAttributes,
01639                 0,
01640                 &amp;nullclass,
01641                 0,
01642                 NULL
01643                 );
01644     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01645     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01646         &amp;NameString,
01647         L<span class="stringliteral">"CurrentVersion"</span>
01648         );
01649 
01650     InitializeObjectAttributes(
01651         &amp;ObjectAttributes,
01652         &amp;NameString,
01653         OBJ_CASE_INSENSITIVE,
01654         key2,
01655         SecurityDescriptor
01656         );
01657 
01658     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
01659                 &amp;key1,
01660                 KEY_SET_VALUE,
01661                 &amp;ObjectAttributes,
01662                 0,
01663                 &amp;nullclass,
01664                 0,
01665                 NULL
01666                 );
01667     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key2);
01668     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(SecurityDescriptor);
01669     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01670 <span class="preprocessor">#if DBG</span>
01671 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: CreateKey of %wZ failed - Status == %lx\n"</span>,
01672                  &amp;NameString, status);
01673 <span class="preprocessor">#endif</span>
01674 <span class="preprocessor"></span>        <span class="keywordflow">return</span>;
01675     }
01676 
01677 
01678     <span class="comment">//</span>
01679     <span class="comment">// Set the value entries for the key</span>
01680     <span class="comment">//</span>
01681     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01682         &amp;NameString,
01683         L<span class="stringliteral">"CurrentVersion"</span>
01684         );
01685 
01686     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01687         key1,
01688         &amp;NameString,
01689         0,              <span class="comment">// TitleIndex</span>
01690         REG_SZ,
01691         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer,
01692         <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01693         );
01694 <span class="preprocessor">#if DBG</span>
01695 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01696         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01697                  &amp;NameString, status);
01698     }
01699 <span class="preprocessor">#endif</span>
01700 <span class="preprocessor"></span>    (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a8">CmVersionString</a>.Buffer );
01701     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmVersionString, NULL );
01702 
01703     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01704         &amp;NameString,
01705         L<span class="stringliteral">"CurrentBuildNumber"</span>
01706         );
01707 
01708     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01709         WorkString,
01710         <span class="stringliteral">"%u"</span>,
01711         NtBuildNumber &amp; 0xFFFF
01712         );
01713     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01714 
01715     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01716     ValueString.Length = 0;
01717     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01718 
01719     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, FALSE );
01720 
01721     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01722         key1,
01723         &amp;NameString,
01724         0,              <span class="comment">// TitleIndex</span>
01725         REG_SZ,
01726         ValueString.Buffer,
01727         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01728         );
01729 <span class="preprocessor">#if DBG</span>
01730 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01731         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01732                  &amp;NameString, status);
01733     }
01734 <span class="preprocessor">#endif</span>
01735 <span class="preprocessor"></span>
01736     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01737         &amp;NameString,
01738         L<span class="stringliteral">"CurrentType"</span>
01739         );
01740 
01741 <span class="preprocessor">#if defined(NT_UP)</span>
01742 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Uniprocessor"</span>;
01743 <span class="preprocessor">#else</span>
01744 <span class="preprocessor"></span>    proctype = <span class="stringliteral">"Multiprocessor"</span>;
01745 <span class="preprocessor">#endif</span>
01746 <span class="preprocessor"></span>
01747 <span class="preprocessor">#if DBG</span>
01748 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Checked"</span>;
01749 <span class="preprocessor">#else</span>
01750 <span class="preprocessor"></span><span class="preprocessor">#if DEVL</span>
01751 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Free"</span>;
01752 <span class="preprocessor">#else</span>
01753 <span class="preprocessor"></span>    buildtype = <span class="stringliteral">"Retail"</span>;
01754 <span class="preprocessor">#endif</span>
01755 <span class="preprocessor"></span>
01756 <span class="preprocessor">#endif</span>
01757 <span class="preprocessor"></span>
01758     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
01759         WorkString,
01760         <span class="stringliteral">"%s %s"</span>,
01761         proctype,
01762         buildtype
01763         );
01764     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;AnsiString, WorkString );
01765 
01766     ValueString.Buffer = <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a>;
01767     ValueString.Length = 0;
01768     ValueString.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> );
01769 
01770     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>( &amp;ValueString, &amp;AnsiString, FALSE );
01771 
01772     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01773         key1,
01774         &amp;NameString,
01775         0,              <span class="comment">// TitleIndex</span>
01776         REG_SZ,
01777         ValueString.Buffer,
01778         ValueString.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01779         );
01780 
01781     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
01782         &amp;NameString,
01783         L<span class="stringliteral">"CSDVersion"</span>
01784         );
01785 
01786     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length != 0) {
01787         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
01788             key1,
01789             &amp;NameString,
01790             0,              <span class="comment">// TitleIndex</span>
01791             REG_SZ,
01792             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer,
01793             <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
01794             );
01795 <span class="preprocessor">#if DBG</span>
01796 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01797             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01798                      &amp;NameString, status);
01799         }
01800 <span class="preprocessor">#endif</span>
01801 <span class="preprocessor"></span>        (<a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a>)( <a class="code" href="../../d8/d1/init_8h.html#a9">CmCSDVersionString</a>.Buffer );
01802         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CmCSDVersionString, NULL );
01803     } <span class="keywordflow">else</span> {
01804         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(
01805             key1,
01806             &amp;NameString
01807             );
01808 <span class="preprocessor">#if DBG</span>
01809 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; status != STATUS_OBJECT_NAME_NOT_FOUND) {
01810             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: DeleteValueKey of %wZ failed - Status == %lx\n"</span>,
01811                      &amp;NameString, status);
01812         }
01813 <span class="preprocessor">#endif</span>
01814 <span class="preprocessor"></span>    }
01815     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;NameString,
01816                          L<span class="stringliteral">"SystemRoot"</span>);
01817     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(key1,
01818                            &amp;NameString,
01819                            0,
01820                            REG_SZ,
01821                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Buffer,
01822                            <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>.Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
01823 <span class="preprocessor">#if DBG</span>
01824 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01825         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CMINIT: SetValueKey of %wZ failed - Status == %lx\n"</span>,
01826                  &amp;NameString,
01827                  status);
01828     }
01829 <span class="preprocessor">#endif</span>
01830 <span class="preprocessor"></span>    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key1);
01831 
01832     <span class="comment">//</span>
01833     <span class="comment">// Set each processor to it's optimal configuration.</span>
01834     <span class="comment">//</span>
01835     <span class="comment">// Note: this call is performed interlocked such that the user</span>
01836     <span class="comment">// can disable this automatic configuration update.</span>
01837     <span class="comment">//</span>
01838 
01839     <a class="code" href="../../d1/d3/cmsysini_8c.html#a42">CmpInterlockedFunction</a>(CmpProcessorControl, CmpConfigureProcessors);
01840 
01841     <span class="keywordflow">return</span>;
01842 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="cmsysini.c::CmpValidateAlternate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN CmpValidateAlternate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PrimaryHive</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">4077</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00242">CML_BUGCHECK</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d8/d2/cmwrapr_8c-source.html#l00186">CmpFree()</a>, <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00187">CmpSystemFileName</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00649">_CMHIVE::Hive</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00652">_CMHIVE::HiveList</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00653">_CMHIVE::HiveLock</a>, <a class="el" href="../../d3/d0/hivefree_8c-source.html#l00034">HvFreeHive()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>.
<p>
<pre class="fragment"><div>04084                    :
04085 
04086     Loads an alternate hive (SYSTEM.ALT) and verifies that it is a
04087     valid hive file.
04088 
04089 Arguments:
04090 
04091     FileHandle - Supplies a handle to the hive file.
04092 
04093     PrimaryHive - Supplies the <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a> structure of the primary hive.
04094 
04095 Return Value:
04096 
04097     TRUE - Hive is valid.
04098 
04099     FALSE - Hive is corrupt or in transition.
04100 
04101 --*/
04102 
04103 {
04104     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
04105     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04106     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> Status2;
04107 
04108     Status2 = <a class="code" href="../../d1/d2/cmp_8h.html#a275">CmpInitializeHive</a>(&amp;CmHive,
04109                            HINIT_FILE,
04110                            0,
04111                            HFILE_TYPE_PRIMARY,
04112                            NULL,
04113                            FileHandle,
04114                            NULL,
04115                            NULL,
04116                            NULL,
04117                            &amp;CmpSystemFileName    <span class="comment">// non system ALT will screw up</span>
04118                            );
04119     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status2)) {
04120         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK, CMS_INIT) {
04121             KdPrint((<span class="stringliteral">"CmpValidateSecondary: SYSTEM.ALT is corrupt\n"</span>));
04122         }
04123         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04124     }
04125 
04126     <span class="comment">//</span>
04127     <span class="comment">// Compare the timestamps in the baseblock.  These must always be</span>
04128     <span class="comment">// equal to ensure that SYSTEM and SYSTEM.ALT are really the same</span>
04129     <span class="comment">// hive.</span>
04130     <span class="comment">//</span>
04131     <span class="keywordflow">if</span> (CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.QuadPart !=
04132         PrimaryHive-&gt;Hive.BaseBlock-&gt;TimeStamp.QuadPart) {
04133         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BUGCHECK,CMS_INIT) {
04134             KdPrint((<span class="stringliteral">"CmpValidateSecondary: timestamps don't match"</span>));
04135         }
04136         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04137     } <span class="keywordflow">else</span> {
04138         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04139     }
04140 
04141     <span class="comment">//</span>
04142     <span class="comment">// Hive is valid, free up everything we allocated.</span>
04143     <span class="comment">//</span>
04144     RemoveEntryList(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>);
04145     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(&amp;CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>);
04146     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
04147     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
04148     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
04149     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
04150 
04151 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="cmsysini.c::CmShutdownSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmShutdownSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03944">3944</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
References <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00081">CmpLockRegistryExclusive()</a>, <a class="el" href="../../d1/d2/cmsubs3_8c-source.html#l00116">CmpUnlockRegistry()</a>, <a class="el" href="../../d6/d2/cmworker_8c-source.html#l00115">CmpWorker()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00738">_REGISTRY_COMMAND::Command</a>, <a class="el" href="../../d9/d2/cmwrapr2_8c-source.html#l00029">CommandArea</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00076">HvShutdownComplete</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00724">REG_CMD_SHUTDOWN</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03949                    :
03950 
03951     Shuts down <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry.
03952 
03953     Call to CmpWorkerThread, which will call back
03954     to <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
03955 
03956 Arguments:
03957 
03958     NONE
03959 
03960 Return Value:
03961 
03962     NONE
03963 
03964 --*/
03965 {
03966     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>;
03967 
03968     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03969     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
03970 
03971     <a class="code" href="../../d8/d3/cmwrapr2_8c.html#a0">CommandArea</a>.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a106">REG_CMD_SHUTDOWN</a>;
03972     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;CommandArea);
03973 
03974     <a class="code" href="../../d7/d0/cmdat2_8c.html#a13">HvShutdownComplete</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;      <span class="comment">// Tell HvSyncHive to ignore all</span>
03975                                     <span class="comment">// further requests</span>
03976 
03977     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
03978     <span class="keywordflow">return</span>;
03979 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a13" doxytag="cmsysini.c::CmFirstTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d7/ntapi_8c.html#a5">CmFirstTime</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00055">55</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="cmsysini.c::CmpCannotWriteConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d3/cmworker_8c.html#a14">CmpCannotWriteConfiguration</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00145">145</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="cmsysini.c::CmpControlSessionManager" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PWCHAR <a class="el" href="../../d1/d3/cmsysini_8c.html#a19">CmpControlSessionManager</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00078">78</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="cmsysini.c::CmpHiveListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d4/edithive_8c.html#a2">CmpHiveListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00102">102</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="cmsysini.c::CmpKcbLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a11">CmpKcbLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00052">52</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="cmsysini.c::CmpKeyObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d7/d7/ntapi_8c.html#a4">CmpKeyObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00109">109</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="cmsysini.c::CmpLoadOptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d1/d3/cmsysini_8c.html#a17">CmpLoadOptions</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00076">76</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="cmsysini.c::CmpMachineHiveList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d7/struct__HIVE__LIST__ENTRY.html">HIVE_LIST_ENTRY</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a14">CmpMachineHiveList</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00061">61</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00726">CmpInitializeHiveList()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="cmsysini.c::CmpMasterHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="el" href="../../d6/d3/cmwraper_8c.html#a7">CmpMasterHive</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00096">96</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="cmsysini.c::CmpNoMasterCreates" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d1/d3/cmsysini_8c.html#a21">CmpNoMasterCreates</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00097">97</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, and <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00145">CmpParseKey()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="cmsysini.c::CmpNoWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d6/d3/cmwraper_8c.html#a4">CmpNoWrite</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00131">131</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="cmsysini.c::CmpPostLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a12">CmpPostLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00053">53</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="cmsysini.c::CmpProcessorControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PWCHAR <a class="el" href="../../d1/d3/cmsysini_8c.html#a18">CmpProcessorControl</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00077">77</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="cmsysini.c::CmpRegistryLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d1/d3/cmsysini_8c.html#a10">CmpRegistryLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00051">51</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="cmsysini.c::CmpStashBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR <a class="el" href="../../d1/d3/cmsysini_8c.html#a26">CmpStashBuffer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00138">138</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="cmsysini.c::CmpStashBufferSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d3/cmsysini_8c.html#a27">CmpStashBufferSize</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00139">139</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="cmsysini.c::CmpSystemFileName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d1/d3/cmsysini_8c.html#a15">CmpSystemFileName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00074">74</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/cmdatini_8c-source.html#l00089">CmpInitializeRegistryNames()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02022">CmpInitializeSystemHive()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l04077">CmpValidateAlternate()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="cmsysini.c::CmpSystemProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> <a class="el" href="../../d5/d3/cmworker_8c.html#a4">CmpSystemProcess</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00050">50</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="cmsysini.c::CmSymbolicLinkValueName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d6/d2/hwprofil_8c.html#a0">CmSymbolicLinkValueName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00075">75</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="cmsysini.c::HvShutdownComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d0/d2/hivesync_8c.html#a1">HvShutdownComplete</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00133">133</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="cmsysini.c::nullclass" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d1/d3/cmsysini_8c.html#a29">nullclass</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00150">150</a> of file <a class="el" href="../../d2/d2/cmsysini_8c-source.html">cmsysini.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, and <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
