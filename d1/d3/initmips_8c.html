<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: initmips.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initmips.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d2/d2/initmips_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/initmips_8c.html#a0">MiInitMachineDependent</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="initmips.c::MiInitMachineDependent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitMachineDependent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LoaderBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/initmips_8c-source.html#l00027">27</a> of file <a class="el" href="../../d2/d2/initmips_8c-source.html">initmips.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a176">BadPageList</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01701">_MEMORY_ALLOCATION_DESCRIPTOR::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d4/d9/user32_8def-source.html#l00799">c</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00351">FIRST_MAPPING_PTE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00349">HYPER_SPACE</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00220">KeSweepDcache()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00355">LAST_MAPPING_PTE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01699">_MEMORY_ALLOCATION_DESCRIPTOR::ListEntry</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01080">_MMPFNLIST::ListName</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>, <a class="el" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01700">_MEMORY_ALLOCATION_DESCRIPTOR::MemoryType</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l02476">MiInitializeNonPagedPool()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01740">MiInitializeSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00059">MiInsertPageInList()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00135">MM_EXECUTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00136">MM_EXECUTE_READ</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00139">MM_EXECUTE_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00140">MM_EXECUTE_WRITECOPY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00143">MM_GUARD_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00162">MM_LOWEST_NONPAGED_SYSTEM_START</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00196">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00190">MM_MAX_INITIAL_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00303">MM_MAXIMUM_NUMBER_OF_COLORS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00130">MM_PAGES_IN_KSEG0</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00134">MM_READONLY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00333">MM_SECONDARY_COLORS_DEFAULT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00337">MM_SECONDARY_COLORS_MAX</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00335">MM_SECONDARY_COLORS_MIN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01531">MM_SUBSECTION_MAP</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00168">MM_SYSTEM_SPACE_END</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00135">MM_SYSTEM_SPACE_START</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00138">MM_WRITECOPY</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a202">MMCOLOR_TABLES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04640">MmDefaultMaximumNonPagedPool</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04616">MmFirstReservedMappingPte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d6/d1/datamips_8c-source.html#l00142">MmFreePagesByPrimaryColor</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00911">MmInitializeProcessAddressSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04618">MmLastReservedMappingPte</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00043">MmLowestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04644">MmMaxAdditionNonPagedPoolPerMb</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00062">MmMaximumNonPagedPoolInBytes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04642">MmMinAdditionNonPagedPoolPerMb</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04638">MmMinimumNonPagedPoolSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04710">MmNonPagedMustSucceed</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00065">MmNonPagedPoolEnd</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00114">MmNonPagedPoolExpansionStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00064">MmNonPagedPoolStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00079">MmNumberOfSystemPtes</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04732">MmPageAlignedPoolBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00039">MmPfnLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00201">MmProtectToPteMask</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00117">MmSecondaryColorMask</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00081">MmSecondaryColors</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04652">MmSizeOfNonPagedMustSucceed</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00075">MmSizeOfNonPagedPoolInBytes</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00055">MmSubsectionBase</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04436">MmSubsectionTopPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05150">MmSystemProcessWorkingSetMax</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05148">MmSystemProcessWorkingSetMin</a>, <a class="el" href="../../d5/d3/alpha_2splocks_8c-source.html#l00072">MmSystemSpaceLock</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00444">MmWsle</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00353">NUMBER_OF_MAPPING_PTES</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00276">PAGE_DIRECTORY_MASK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01702">_MEMORY_ALLOCATION_DESCRIPTOR::PageCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00455">PTE_PER_PAGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00714">RtlCompareMemoryUlong()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00060">ValidKernelPde</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00056">ValidPdePde</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00052">ValidPtePte</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00047">ValidUserPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00362">WORKING_SET_LIST</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00212">_EPROCESS::WorkingSetPage</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
<pre class="fragment"><div>00033                    :
00034 
00035     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> necessary operations to enable <span class="keyword">virtual</span>
00036     memory.  This includes building <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page directory page, building
00037     page table pages to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code section, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data section, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>'
00038     stack section and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap handler.
00039 
00040     It also initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database and populates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list.
00041 
00042 
00043 Arguments:
00044 
00045     None.
00046 
00047 Return Value:
00048 
00049     None.
00050 
00051 Environment:
00052 
00053     Kernel mode.
00054 
00055 --*/
00056 
00057 {
00058 
00059     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BasePfn;
00060     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> BottomPfn;
00061     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> TopPfn;
00062     BOOLEAN PfnInKseg0;
00063     ULONG i, j;
00064     ULONG HighPage;
00065     ULONG PagesLeft;
00066     ULONG PageNumber;
00067     ULONG PdePageNumber;
00068     ULONG PdePage;
00069     ULONG PageFrameIndex;
00070     ULONG NextPhysicalPage;
00071     ULONG PfnAllocation;
00072     ULONG MaxPool;
00073     KIRQL OldIrql;
00074     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00075     ULONG DirBase;
00076     PVOID SpinLockPage;
00077     ULONG MostFreePage = 0;
00078     PLIST_ENTRY NextMd;
00079     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> FreeDescriptor;
00080     <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">PMEMORY_ALLOCATION_DESCRIPTOR</a> MemoryDescriptor;
00081     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00082     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00083     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00084     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
00085     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CacheStackPage;
00086     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Pde;
00087     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPde;
00088     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPde;
00089     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00090     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
00091     PULONG PointerLong;
00092     PVOID NonPagedPoolStartVirtual;
00093     ULONG Range;
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Initialize color tables and cache policy fields of static data if R4000.</span>
00097     <span class="comment">//</span>
00098 
00099     <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CachePolicy = PCR-&gt;CachePolicy;
00100     <a class="code" href="../../d4/d2/datalpha_8c.html#a4">ValidUserPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CachePolicy = PCR-&gt;CachePolicy;
00101     <a class="code" href="../../d4/d2/datalpha_8c.html#a5">ValidPtePte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CachePolicy = PCR-&gt;CachePolicy;
00102     <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CachePolicy = PCR-&gt;CachePolicy;
00103     <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CachePolicy = PCR-&gt;CachePolicy ;
00104 
00105     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>] |= PCR-&gt;AlignedCachePolicy;
00106     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>] |= PCR-&gt;AlignedCachePolicy;
00107     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>] |= PCR-&gt;AlignedCachePolicy;
00108     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>] |= PCR-&gt;AlignedCachePolicy;
00109     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>] |= PCR-&gt;AlignedCachePolicy;
00110     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>] |= PCR-&gt;AlignedCachePolicy;
00111     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>] |= PCR-&gt;AlignedCachePolicy;
00112 
00113     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>] |= PCR-&gt;AlignedCachePolicy;
00114     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a37">MM_EXECUTE</a>] |= PCR-&gt;AlignedCachePolicy;
00115     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>] |= PCR-&gt;AlignedCachePolicy;
00116     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>] |= PCR-&gt;AlignedCachePolicy;
00117     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a40">MM_WRITECOPY</a>] |= PCR-&gt;AlignedCachePolicy;
00118     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>] |= PCR-&gt;AlignedCachePolicy;
00119     <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>] |= PCR-&gt;AlignedCachePolicy;
00120 
00121     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PDE_BASE);
00122 
00123     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty = 1;
00124     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 1;
00125     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global = 1;
00126     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 0;
00127 
00128     PdePageNumber = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00129 
00130     <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Pcb.DirectoryTableBase[0] = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00131 
00132     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (FALSE);
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">// Get the lower bound of the free physical memory and the</span>
00136     <span class="comment">// number of physical pages by walking the memory descriptor lists.</span>
00137     <span class="comment">//</span>
00138 
00139     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00140     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00141         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00142                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00143                                              ListEntry);
00144 
00145         <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> += MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00146         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> &lt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>) {
00147             <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a> = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00148         }
00149 
00150         <span class="comment">//</span>
00151         <span class="comment">// If the memory range described by the descriptor is larger</span>
00152         <span class="comment">// than the previous largest range and the descriptor describes</span>
00153         <span class="comment">// memory that is in KSEG0, then record the address of the</span>
00154         <span class="comment">// descriptor.</span>
00155         <span class="comment">//</span>
00156 
00157         HighPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> - 1;
00158         <span class="keywordflow">if</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a> == <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>) {
00159             <span class="keywordflow">if</span> ((MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> &gt; MostFreePage) &amp;&amp;
00160                 (HighPage &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a8">MM_PAGES_IN_KSEG0</a>)) {
00161                 MostFreePage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00162                 FreeDescriptor = MemoryDescriptor;
00163             }
00164         }
00165 
00166         <span class="keywordflow">if</span> (HighPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00167             <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> = HighPage;
00168         }
00169 
00170         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00171     }
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">// If the number of physical pages is less than 1024, then bug check.</span>
00175     <span class="comment">//</span>
00176 
00177     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt; 1024) {
00178         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (INSTALL_MORE_MEMORY,
00179                       MmNumberOfPhysicalPages,
00180                       MmLowestPhysicalPage,
00181                       MmHighestPhysicalPage,
00182                       0);
00183     }
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Build non-paged pool using the physical pages following the</span>
00187     <span class="comment">// data page in which to build the pool from.  Non-page pool grows</span>
00188     <span class="comment">// from the high range of the virtual address space and expands</span>
00189     <span class="comment">// downward.</span>
00190     <span class="comment">//</span>
00191     <span class="comment">// At this time non-paged pool is constructed so virtual addresses</span>
00192     <span class="comment">// are also physically contiguous.</span>
00193     <span class="comment">//</span>
00194 
00195     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &gt;
00196                         (7 * (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;&lt; 3))) {
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">// More than 7/8 of memory allocated to nonpagedpool, reset to 0.</span>
00200         <span class="comment">//</span>
00201 
00202         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = 0;
00203     }
00204 
00205     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>) {
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">// Calculate the size of nonpaged pool.</span>
00209         <span class="comment">// Use the minimum size, then for every MB about 4mb add extra</span>
00210         <span class="comment">// pages.</span>
00211         <span class="comment">//</span>
00212 
00213         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>;
00214 
00215         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> +=
00216                             ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00217                             <a class="code" href="../../d4/d8/mi_8h.html#a622">MmMinAdditionNonPagedPoolPerMb</a>;
00218     }
00219 
00220     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>) {
00221         <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a30">MM_MAX_INITIAL_NONPAGED_POOL</a>;
00222     }
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// Align to page size boundary.</span>
00226     <span class="comment">//</span>
00227 
00228     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// Calculate the maximum size of pool.</span>
00232     <span class="comment">//</span>
00233 
00234     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> == 0) {
00235 
00236         <span class="comment">//</span>
00237         <span class="comment">// Calculate the size of nonpaged pool.  If 4mb of less use</span>
00238         <span class="comment">// the minimum size, then for every MB about 4mb add extra</span>
00239         <span class="comment">// pages.</span>
00240         <span class="comment">//</span>
00241 
00242         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d4/d8/mi_8h.html#a621">MmDefaultMaximumNonPagedPool</a>;
00243 
00244         <span class="comment">//</span>
00245         <span class="comment">// Make sure enough expansion for pfn database exists.</span>
00246         <span class="comment">//</span>
00247 
00248         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> += (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00249                                       MmHighestPhysicalPage * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00250 
00251         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> +=
00252                         ((<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> - 1024)/256) *
00253                         <a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a>;
00254     }
00255 
00256     MaxPool = <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 16 +
00257                                    (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (
00258                                         MmHighestPhysicalPage * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>));
00259 
00260     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &lt; MaxPool) {
00261         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = MaxPool;
00262     }
00263 
00264     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>) {
00265         <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a31">MM_MAX_ADDITIONAL_NONPAGED_POOL</a>;
00266     }
00267 
00268     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>
00269                                       - (<a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a> - 1));
00270 
00271     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> = (PVOID)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(MmNonPagedPoolStart);
00272     NonPagedPoolStartVirtual = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00273 
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Calculate the starting PDE for the system PTE pool which is</span>
00277     <span class="comment">// right below the nonpaged pool.</span>
00278     <span class="comment">//</span>
00279 
00280     <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = (PVOID)(((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00281                                 ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> + 1) * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;
00282                                  (~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a49">PAGE_DIRECTORY_MASK</a>));
00283 
00284     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>) {
00285         <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a22">MM_LOWEST_NONPAGED_SYSTEM_START</a>;
00286         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = (((ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> -
00287                                  (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)-1;
00288         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmNumberOfSystemPtes &gt; 1000);
00289     }
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">// Set the global bit in all PDE's for system space.</span>
00293     <span class="comment">//</span>
00294 
00295     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MM_SYSTEM_SPACE_START);
00296     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MM_SYSTEM_SPACE_END);
00297 
00298     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00299         <span class="keywordflow">if</span> (StartPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global == 0) {
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">// Set the Global bit.</span>
00303             <span class="comment">//</span>
00304 
00305             TempPte = *StartPde;
00306             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global = 1;
00307             *StartPde = TempPte;
00308         }
00309         StartPde += 1;
00310     }
00311 
00312     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (MmNonPagedSystemStart);
00313 
00314     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>((PVOID)((PCHAR)MmNonPagedPoolEnd - 1));
00315 
00316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((EndPde - StartPde) &lt; (LONG)FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>);
00317 
00318     NextPhysicalPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00319     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
00320 
00321     <span class="keywordflow">while</span> (StartPde &lt;= EndPde) {
00322         <span class="keywordflow">if</span> (StartPde-&gt;u.Hard.Valid == 0) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// Map in a page directory page.</span>
00326             <span class="comment">//</span>
00327 
00328             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00329             NextPhysicalPage += 1;
00330             *StartPde = TempPte;
00331 
00332         }
00333         StartPde += 1;
00334     }
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Zero the PTEs before nonpaged pool.</span>
00338     <span class="comment">//</span>
00339 
00340     StartPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmNonPagedSystemStart);
00341     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmNonPagedPoolStart);
00342 
00343     RtlZeroMemory (StartPde, ((ULONG)PointerPte - (ULONG)StartPde));
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// Fill in the PTEs for non-paged pool.</span>
00347     <span class="comment">//</span>
00348 
00349     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((ULONG)MmNonPagedPoolStart +
00350                                         MmSizeOfNonPagedPoolInBytes - 1);
00351     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00352         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00353         NextPhysicalPage += 1;
00354         *PointerPte = TempPte;
00355         PointerPte++;
00356     }
00357 
00358     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NextPhysicalPage &lt;
00359                        (FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>));
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// Zero the remaining PTEs (if any).</span>
00363     <span class="comment">//</span>
00364 
00365     StartPde = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmNonPagedPoolEnd) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)));
00366     <span class="keywordflow">while</span> (PointerPte &lt;= StartPde) {
00367         *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
00368         PointerPte++;
00369     }
00370 
00371     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MmNonPagedPoolStart);
00372     <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a> =
00373         (PVOID)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> | (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00374 
00375     <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00376 
00377     <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = (ULONG)<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00378     <span class="keywordflow">if</span> (NextPhysicalPage &lt; (MM_SUBSECTION_MAP &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
00379         <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>;
00380         <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a147">MM_SUBSECTION_MAP</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00381     }
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">// Non-paged pages now exist, build the pool structures.</span>
00385     <span class="comment">//</span>
00386 
00387     <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a> = (PVOID)((PCHAR)NonPagedPoolStartVirtual +
00388                     <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>);
00389     <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> (NonPagedPoolStartVirtual);
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Before Non-paged pool can be used, the PFN database must</span>
00393     <span class="comment">// be built.  This is due to the fact that the start and end of</span>
00394     <span class="comment">// allocation bits for nonpaged pool are maintained in the</span>
00395     <span class="comment">// PFN elements for the corresponding pages.</span>
00396     <span class="comment">//</span>
00397 
00398     <span class="comment">//</span>
00399     <span class="comment">// Calculate the number of pages required from page zero to</span>
00400     <span class="comment">// the highest page.</span>
00401     <span class="comment">//</span>
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">// Get the number of secondary colors and add the arrary for tracking</span>
00405     <span class="comment">// secondary colors to the end of the PFN database.</span>
00406     <span class="comment">//</span>
00407     <span class="comment">// Get secondary color value from registry.</span>
00408     <span class="comment">//</span>
00409 
00410     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> == 0) {
00411         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = PCR-&gt;SecondLevelDcacheSize;
00412     }
00413 
00414     <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00415 
00416     <span class="comment">//</span>
00417     <span class="comment">// Make sure value is power of two and within limits.</span>
00418     <span class="comment">//</span>
00419 
00420     <span class="keywordflow">if</span> (((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &amp; (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> -1)) != 0) ||
00421         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a61">MM_SECONDARY_COLORS_MIN</a>) ||
00422         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a62">MM_SECONDARY_COLORS_MAX</a>)) {
00423         <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a60">MM_SECONDARY_COLORS_DEFAULT</a>;
00424     }
00425 
00426     <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a> = (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> - 1) &amp; ~<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
00427 
00428     PfnAllocation = 1 + ((((<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>)) +
00429                         (<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)*2))
00430                             &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
00431 
00432     <span class="comment">//</span>
00433     <span class="comment">// If the number of pages remaining in the current descriptor is</span>
00434     <span class="comment">// greater than the number of pages needed for the PFN database,</span>
00435     <span class="comment">// then allocate the PFN database from the current free descriptor.</span>
00436     <span class="comment">//</span>
00437 
00438     HighPage = FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> + FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00439     PagesLeft = HighPage - NextPhysicalPage;
00440     <span class="keywordflow">if</span> (PagesLeft &gt;= PfnAllocation) {
00441 
00442         <span class="comment">//</span>
00443         <span class="comment">// Allocate the PFN database in kseg0.</span>
00444         <span class="comment">//</span>
00445         <span class="comment">// Compute the address of the PFN by allocating the appropriate</span>
00446         <span class="comment">// number of pages from the end of the free descriptor.</span>
00447         <span class="comment">//</span>
00448 
00449         PfnInKseg0 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00450         <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> |
00451                                     ((HighPage - PfnAllocation) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
00452 
00453         RtlZeroMemory(MmPfnDatabase, PfnAllocation * PAGE_SIZE);
00454         FreeDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a> -= PfnAllocation;
00455 
00456     } <span class="keywordflow">else</span> {
00457 
00458         <span class="comment">//</span>
00459         <span class="comment">// Allocate the PFN database in virtual memory.</span>
00460         <span class="comment">//</span>
00461         <span class="comment">// Calculate the start of the Pfn Database (it starts a physical</span>
00462         <span class="comment">// page zero, even if the Lowest physical page is not zero).</span>
00463         <span class="comment">//</span>
00464 
00465         PfnInKseg0 = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (PfnAllocation,
00467                                           NonPagedPoolExpansion,
00468                                           0,
00469                                           0,
00470                                           TRUE);
00471 
00472         <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte));
00473 
00474         <span class="comment">//</span>
00475         <span class="comment">// Go through the memory descriptors and for each physical page</span>
00476         <span class="comment">// make the PFN database has a valid PTE to map it.  This allows</span>
00477         <span class="comment">// machines with sparse physical memory to have a minimal PFN</span>
00478         <span class="comment">// database.</span>
00479         <span class="comment">//</span>
00480 
00481         NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00482         <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00483 
00484             MemoryDescriptor = CONTAINING_RECORD(NextMd,
00485                                                  <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00486                                                  ListEntry);
00487 
00488             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
00489                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>));
00490 
00491             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (((PCHAR)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(
00492                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a> +
00493                                             MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>))) - 1);
00494 
00495             <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00496                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00497                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00498                     NextPhysicalPage += 1;
00499                     *PointerPte = TempPte;
00500                     RtlZeroMemory (MiGetVirtualAddressMappedByPte (PointerPte),
00501                                    PAGE_SIZE);
00502                 }
00503                 PointerPte++;
00504             }
00505 
00506             NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00507         }
00508     }
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Initialize support for colored pages.</span>
00512     <span class="comment">//</span>
00513 
00514     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = (<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>)
00515                                 &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a> + 1];
00516 
00517     <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
00518 
00519     <span class="comment">//</span>
00520     <span class="comment">// Make sure the PTEs are mapped.</span>
00521     <span class="comment">//</span>
00522 
00523     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(MmFreePagesByColor[0])) {
00524         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;MmFreePagesByColor[0][0]);
00525 
00526         LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
00527               (PVOID)((PCHAR)&amp;MmFreePagesByColor[1][MmSecondaryColors] - 1));
00528 
00529         <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
00530             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00531                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NextPhysicalPage;
00532                 NextPhysicalPage += 1;
00533                 *PointerPte = TempPte;
00534                 RtlZeroMemory (MiGetVirtualAddressMappedByPte (PointerPte),
00535                                PAGE_SIZE);
00536             }
00537             PointerPte++;
00538         }
00539     }
00540 
00541     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; i++) {
00542         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00543         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00544     }
00545 
00546     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a55">MM_MAXIMUM_NUMBER_OF_COLORS</a>; i++) {
00547         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>;
00548         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o1">ListName</a> = <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>;
00549         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00550         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00551         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00552         <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>][i].<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00553     }
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Go through the page table entries and for any page which is</span>
00557     <span class="comment">// valid, update the corresponding PFN database element.</span>
00558     <span class="comment">//</span>
00559 
00560     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PTE_BASE);
00561 
00562     PdePage = PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00563     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
00564     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
00565     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPde;
00566     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00567     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00568     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00569     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPde);
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">// Add the pages which were used to construct nonpaged pool to</span>
00573     <span class="comment">// the pfn database.</span>
00574     <span class="comment">//</span>
00575 
00576     Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> ((ULONG)NonPagedPoolStartVirtual -
00577                                 ((MmNumberOfSystemPtes + 1) * PAGE_SIZE));
00578 
00579     EndPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(MmNonPagedPoolEnd);
00580 
00581     <span class="keywordflow">while</span> (Pde &lt;= EndPde) {
00582         <span class="keywordflow">if</span> (Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00583             PdePage = Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00584             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PdePage);
00585             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00586             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
00587             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00588             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00589             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00590             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pde);
00591 
00592             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Pde);
00593             <span class="keywordflow">for</span> (j = 0 ; j &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; j++) {
00594                 <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00595 
00596                     PageFrameIndex = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00597                     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
00598                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePage;
00599                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00600                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00601                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00602                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> =
00603                             (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a> | (PageFrameIndex &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
00604 
00605                     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor =
00606                              <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00607                 }
00608                 PointerPte++;
00609             }
00610         }
00611         Pde++;
00612     }
00613 
00614     <span class="comment">//</span>
00615     <span class="comment">// If page zero is still unused, mark it as in use. This is</span>
00616     <span class="comment">// temporary as we want to find bugs where a physical page</span>
00617     <span class="comment">// is specified as zero.</span>
00618     <span class="comment">//</span>
00619 
00620     Pfn1 = &amp;<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>[<a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>];
00621     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00622 
00623         <span class="comment">//</span>
00624         <span class="comment">// Make the reference count non-zero and point it into a</span>
00625         <span class="comment">// page directory.</span>
00626         <span class="comment">//</span>
00627 
00628         Pde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (0xb0000000);
00629         PdePage = Pde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00630         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
00631         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = Pde;
00632         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00633         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00634         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00635         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (Pde);
00636     }
00637 
00638     <span class="comment">// end of temporary set to physical page zero.</span>
00639 
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">//</span>
00643     <span class="comment">// Walk through the memory descriptors and add pages to the</span>
00644     <span class="comment">// free list in the PFN database.</span>
00645     <span class="comment">//</span>
00646 
00647     NextMd = LoaderBlock-&gt;MemoryDescriptorListHead.Flink;
00648 
00649     <span class="keywordflow">while</span> (NextMd != &amp;LoaderBlock-&gt;MemoryDescriptorListHead) {
00650 
00651         MemoryDescriptor = CONTAINING_RECORD(NextMd,
00652                                              <a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html">MEMORY_ALLOCATION_DESCRIPTOR</a>,
00653                                              ListEntry);
00654 
00655         i = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o3">PageCount</a>;
00656         NextPhysicalPage = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o2">BasePage</a>;
00657 
00658         <span class="keywordflow">switch</span> (MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o1">MemoryType</a>) {
00659             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a257">LoaderBad</a>:
00660                 <span class="keywordflow">while</span> (i != 0) {
00661                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[BadPageList],
00662                                         NextPhysicalPage);
00663                     i -= 1;
00664                     NextPhysicalPage += 1;
00665                 }
00666                 <span class="keywordflow">break</span>;
00667 
00668             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a256">LoaderFree</a>:
00669             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a258">LoaderLoadedProgram</a>:
00670             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a259">LoaderFirmwareTemporary</a>:
00671             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a320a262">LoaderOsloaderStack</a>:
00672 
00673                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
00674                 <span class="keywordflow">while</span> (i != 0) {
00675                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00676 
00677                         <span class="comment">//</span>
00678                         <span class="comment">// Set the PTE address to the phyiscal page for</span>
00679                         <span class="comment">// virtual address alignment checking.</span>
00680                         <span class="comment">//</span>
00681 
00682                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(NextPhysicalPage &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00683                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
00684                                                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00685 
00686                         <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList],
00687                                             NextPhysicalPage);
00688                     }
00689                     Pfn1++;
00690                     i -= 1;
00691                     NextPhysicalPage += 1;
00692                 }
00693                 <span class="keywordflow">break</span>;
00694 
00695             <span class="keywordflow">default</span>:
00696                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(KSEG0_BASE |
00697                                             (NextPhysicalPage &lt;&lt; PAGE_SHIFT));
00698 
00699                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (NextPhysicalPage);
00700                 <span class="keywordflow">while</span> (i != 0) {
00701 
00702                     <span class="comment">//</span>
00703                     <span class="comment">// Set page as in use.</span>
00704                     <span class="comment">//</span>
00705 
00706                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PdePageNumber;
00707                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
00708                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00709                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00710                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00711                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (
00712                                                     PointerPte);
00713 
00714                     Pfn1++;
00715                     i -= 1;
00716                     NextPhysicalPage += 1;
00717                     PointerPte += 1;
00718                 }
00719 
00720                 <span class="keywordflow">break</span>;
00721         }
00722 
00723         NextMd = MemoryDescriptor-&gt;<a class="code" href="../../d2/d8/struct__MEMORY__ALLOCATION__DESCRIPTOR.html#o0">ListEntry</a>.Flink;
00724     }
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// If the PFN database is allocated in virtual memory, then indicate that</span>
00728     <span class="comment">// the PFN database is allocated in NonPaged pool. Otherwise, scan the PFN</span>
00729     <span class="comment">// database for holes and insert the respective pages in the free page list.</span>
00730     <span class="comment">//</span>
00731 
00732     <span class="keywordflow">if</span> (PfnInKseg0 == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00733 
00734         <span class="comment">//</span>
00735         <span class="comment">// The PFN database is allocated in virtual memory.</span>
00736         <span class="comment">//</span>
00737         <span class="comment">// Set the start and end of allocation.</span>
00738         <span class="comment">//</span>
00739 
00740         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;MmPfnDatabase[MmLowestPhysicalPage])-&gt;u.Hard.PageFrameNumber);
00741         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
00742         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;MmPfnDatabase[MmHighestPhysicalPage])-&gt;u.Hard.PageFrameNumber);
00743         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
00744 
00745     } <span class="keywordflow">else</span> {
00746 
00747         <span class="comment">//</span>
00748         <span class="comment">// The PFN database is allocated in KSEG0.</span>
00749         <span class="comment">//</span>
00750         <span class="comment">// Mark all pfn entries for the pfn pages in use.</span>
00751         <span class="comment">//</span>
00752 
00753         PageNumber = ((ULONG)<a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a> - <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00754         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNumber);
00755         <span class="keywordflow">do</span> {
00756             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageNumber &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00757             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00758             Pfn1 += 1;
00759             PfnAllocation -= 1;
00760         } <span class="keywordflow">while</span> (PfnAllocation != 0);
00761 
00762         <span class="comment">// Scan the PFN database backward for pages that are completely zero.</span>
00763         <span class="comment">// These pages are unused and can be added to the free list</span>
00764         <span class="comment">//</span>
00765 
00766         BottomPfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(MmHighestPhysicalPage);
00767         <span class="keywordflow">do</span> {
00768 
00769             <span class="comment">//</span>
00770             <span class="comment">// Compute the address of the start of the page that is next</span>
00771             <span class="comment">// lower in memory and scan backwards until that page address</span>
00772             <span class="comment">// is reached or just crossed.</span>
00773             <span class="comment">//</span>
00774 
00775             <span class="keywordflow">if</span> (((ULONG)BottomPfn &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) != 0) {
00776                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG)BottomPfn &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00777                 TopPfn = BottomPfn + 1;
00778 
00779             } <span class="keywordflow">else</span> {
00780                 BasePfn = (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)((ULONG)BottomPfn - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00781                 TopPfn = BottomPfn;
00782             }
00783 
00784             <span class="keywordflow">while</span> (BottomPfn &gt; BasePfn) {
00785                 BottomPfn -= 1;
00786             }
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// If the entire range over which the PFN entries span is</span>
00790             <span class="comment">// completely zero and the PFN entry that maps the page is</span>
00791             <span class="comment">// not in the range, then add the page to the appropriate</span>
00792             <span class="comment">// free list.</span>
00793             <span class="comment">//</span>
00794 
00795             Range = (ULONG)TopPfn - (ULONG)BottomPfn;
00796             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/string_8c.html#a17">RtlCompareMemoryUlong</a>((PVOID)BottomPfn, Range, 0) == Range) {
00797 
00798                 <span class="comment">//</span>
00799                 <span class="comment">// Set the PTE address to the physical page for virtual</span>
00800                 <span class="comment">// address alignment checking.</span>
00801                 <span class="comment">//</span>
00802 
00803                 PageNumber = ((ULONG)BasePfn - <a class="code" href="../../d6/d7/halmips_8h.html#a443">KSEG0_BASE</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00804                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNumber);
00805 
00806                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
00807 
00808                 PfnAllocation += 1;
00809 
00810                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(PageNumber &lt;&lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>);
00811                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00812                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a>(MmPageLocationList[FreePageList],
00813                                    PageNumber);
00814             }
00815 
00816         } <span class="keywordflow">while</span> (BottomPfn &gt; <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>);
00817     }
00818 
00819     <span class="comment">//</span>
00820     <span class="comment">// Indicate that nonpaged pool must succeed is allocated in</span>
00821     <span class="comment">// nonpaged pool.</span>
00822     <span class="comment">//</span>
00823 
00824     i = <a class="code" href="../../d4/d8/mi_8h.html#a627">MmSizeOfNonPagedMustSucceed</a>;
00825     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(MI_CONVERT_PHYSICAL_TO_PFN (MmNonPagedMustSucceed));
00826     <span class="keywordflow">while</span> ((LONG)i &gt; 0) {
00827         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
00828         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
00829         i -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00830         Pfn1 += 1;
00831     }
00832 
00833     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;MmSystemSpaceLock);
00834     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;MmPfnLock);
00835 
00836     <span class="comment">//</span>
00837     <span class="comment">// Initialize the nonpaged available PTEs for mapping I/O space</span>
00838     <span class="comment">// and kernel stacks.</span>
00839     <span class="comment">//</span>
00840 
00841     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((ULONG)NonPagedPoolStartVirtual -
00842                                 ((MmNumberOfSystemPtes + 1) * PAGE_SIZE));
00843 
00844     PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (PointerPte);
00845     <span class="keywordflow">if</span> (PfnInKseg0) {
00846         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmNonPagedPoolExpansionStart) - PointerPte - 1;
00847     } <span class="keywordflow">else</span> {
00848         <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NonPagedPoolStartVirtual) - PointerPte - 1;
00849     }
00850 
00851     <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (PointerPte, MmNumberOfSystemPtes, SystemPteSpace);
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Initialize the nonpaged pool.</span>
00855     <span class="comment">//</span>
00856 
00857     <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a>(NonPagedPool,0);
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">// Initialize memory management structures for this process.</span>
00861     <span class="comment">//</span>
00862 
00863     <span class="comment">//</span>
00864     <span class="comment">// Build working set list.  System initialization has created</span>
00865     <span class="comment">// a PTE for hyperspace.</span>
00866     <span class="comment">//</span>
00867     <span class="comment">// Note, we can't remove a zeroed page as hyper space does not</span>
00868     <span class="comment">// exist and we map non-zeroed pages into hyper space to zero.</span>
00869     <span class="comment">//</span>
00870 
00871     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(HYPER_SPACE);
00872 
00873     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00874     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global = 0;
00875     PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
00876     PageFrameIndex = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">// Point to the page table page we just created and zero it.</span>
00880     <span class="comment">//</span>
00881 
00882 
00883 <span class="comment">//    KeFillEntryTb ((PHARDWARE_PTE)PointerPte,</span>
00884 <span class="comment">//                    MiGetPteAddress(HYPER_SPACE),</span>
00885 <span class="comment">//                    TRUE);</span>
00886 
00887     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(HYPER_SPACE);
00888     RtlZeroMemory ((PVOID)PointerPte, PAGE_SIZE);
00889 
00890     <span class="comment">//</span>
00891     <span class="comment">// Hyper space now exists, set the necessary variables.</span>
00892     <span class="comment">//</span>
00893 
00894     <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FIRST_MAPPING_PTE);
00895     <a class="code" href="../../d4/d8/mi_8h.html#a616">MmLastReservedMappingPte</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LAST_MAPPING_PTE);
00896 
00897     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a>;
00898     <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PUCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>));
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Initialize this process's memory management structures including</span>
00902     <span class="comment">// the working set list.</span>
00903     <span class="comment">//</span>
00904 
00905     <span class="comment">//</span>
00906     <span class="comment">// The pfn element for the page directory has already been initialized,</span>
00907     <span class="comment">// zero the reference count and the share count so they won't be</span>
00908     <span class="comment">// wrong.</span>
00909     <span class="comment">//</span>
00910 
00911     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PdePageNumber);
00912     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00913     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
00914     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// The pfn element for the PDE which maps hyperspace has already</span>
00918     <span class="comment">// been initialized, zero the reference count and the share count</span>
00919     <span class="comment">// so they won't be wrong.</span>
00920     <span class="comment">//</span>
00921 
00922     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00923     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
00924     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
00925     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 1;
00926 
00927 
00928     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// Get a page for the working set list and map it into the Page</span>
00932     <span class="comment">// directory at the page after hyperspace.</span>
00933     <span class="comment">//</span>
00934 
00935     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (HYPER_SPACE);
00936     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a>(PointerPte));
00937     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o23">WorkingSetPage</a> = PageFrameIndex;
00938 
00939     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global = 0;
00940     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
00941     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (HYPER_SPACE) + 1;
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Assert that the double mapped pages have the same alignment.</span>
00945     <span class="comment">//</span>
00946 
00947     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; (0xF &lt;&lt; PTE_SHIFT)) ==
00948             (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; (0xF &lt;&lt; PTE_SHIFT)));
00949 
00950     *PointerPde = TempPte;
00951 
00952     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
00953 
00954     KeFillEntryTb ((PHARDWARE_PTE)PointerPde,
00955                     PointerPte,
00956                     TRUE);
00957 
00958     RtlZeroMemory ((PVOID)PointerPte, PAGE_SIZE);
00959 
00960     TempPte = *PointerPde;
00961     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 0;
00962     TempPte.u.Hard.Global = 0;
00963 
00964     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;OldIrql);
00965     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (PointerPte,
00966                      TRUE,
00967                      FALSE,
00968                      (PHARDWARE_PTE)PointerPde,
00969                      TempPte.u.Hard);
00970 
00971     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00972 
00973 <span class="preprocessor">#ifdef R4000</span>
00974 <span class="preprocessor"></span>
00975     <span class="comment">//</span>
00976     <span class="comment">// Initialize hyperspace for this process.</span>
00977     <span class="comment">//</span>
00978 
00979     i = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a65">NUMBER_OF_MAPPING_PTES</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>;
00980     PointerPte = <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a>;
00981     <span class="keywordflow">while</span> (PointerPte &lt;= (<a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a> + <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a57">MM_COLOR_MASK</a>)) {
00982         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = i;
00983         PointerPte += 1;
00984     }
00985 
00986 <span class="preprocessor">#endif</span>
00987 <span class="preprocessor"></span>
00988     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a740">MmSystemProcessWorkingSetMax</a>;
00989     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a739">MmSystemProcessWorkingSetMin</a>;
00990 
00991     <a class="code" href="../../d4/d5/procsup_8c.html#a30">MmInitializeProcessAddressSpace</a> (CurrentProcess,
00992                                 (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)NULL,
00993                                 (PVOID)NULL);
00994 
00995     *PointerPde = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
00996     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(TRUE, TRUE);
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">// Check to see if moving the secondary page structures to the end</span>
01000     <span class="comment">// of the PFN database is a waste of memory.  And if so, copy it</span>
01001     <span class="comment">// to paged pool.</span>
01002     <span class="comment">//</span>
01003     <span class="comment">// If the PFN datbase ends on a page aligned boundary and the</span>
01004     <span class="comment">// size of the two arrays is less than a page, free the page</span>
01005     <span class="comment">// and allocate nonpagedpool for this.</span>
01006     <span class="comment">//</span>
01007 
01008     <span class="keywordflow">if</span> ((((ULONG)<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0) &amp;&amp;
01009        ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a> * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>)) &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01010 
01011         <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
01012 
01013         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0];
01014 
01015         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0] = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPoolMustSucceed,
01016                                MmSecondaryColors * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>),
01017                                '  mM');
01018 
01019         <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[1] = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[0][<a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>];
01020 
01021         RtlMoveMemory (MmFreePagesByColor[0],
01022                        c,
01023                        MmSecondaryColors * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>));
01024 
01025         <span class="comment">//</span>
01026         <span class="comment">// Free the page.</span>
01027         <span class="comment">//</span>
01028 
01029         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(c)) {
01030             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(c);
01031             PageFrameIndex = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber;
01032             *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
01033         } <span class="keywordflow">else</span> {
01034             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (c);
01035         }
01036 
01037         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01038         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &lt;= 1) &amp;&amp; (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &lt;= 1));
01039         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
01040         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 0;
01041         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
01042 <span class="preprocessor">#if DBG</span>
01043 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
01044 <span class="preprocessor">#endif //DBG</span>
01045 <span class="preprocessor"></span>        <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (MmPageLocationList[FreePageList], PageFrameIndex);
01046     }
01047     <span class="keywordflow">return</span>;
01048 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
