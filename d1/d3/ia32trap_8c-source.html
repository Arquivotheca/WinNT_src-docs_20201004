<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ia32trap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ia32trap.c</h1><a href="../../d0/d4/ia32trap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment">        </span>
00005 <span class="comment">    ia32trap.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module contains iA32 trap handling code.</span>
00010 <span class="comment">    Only used by kernel.</span>
00011 <span class="comment"></span>
00012 <span class="comment">    Fault can ONLY be initiated from user mode code.  There is no support</span>
00013 <span class="comment">    for iA32 code in the kernel mode.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    For common pratice, we always return to the caller (lower level fault</span>
00016 <span class="comment">    handler) and have the system do a normal ia64 exception dispatch. The</span>
00017 <span class="comment">    wow64 code takes that exception and passes it back to the ia32 code</span>
00018 <span class="comment">    as needed.</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    1 Feb.  1999              Initial Version</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="comment">// Get all the iadebugging stuff for now.</span>
<a name="l00027"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a0">00027</a> <span class="preprocessor">#define IADBG   1</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/ia32def_8h.html">ia32def.h</a>"</span>
00031 
00032 BOOLEAN <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a12">KiUnalignedFault</a> (IN PKTRAP_FRAME TrapFrame);
00033 
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00036"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a4">00036</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a> (
00037     IN PKTRAP_FRAME Frame,
00038     IN ULONG ExceptionCode,
00039     IN PVOID ExceptionAddress,
00040     IN ULONG_PTR Argument0,
00041     IN ULONG_PTR Argument1,
00042     IN ULONG_PTR Argument2
00043     )
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description</span>
00047 <span class="comment">    This routine sets up the ExceptionFrame </span>
00048 <span class="comment"></span>
00049 <span class="comment">Arguments:</span>
00050 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00051 <span class="comment"></span>
00052 <span class="comment">    ExceptionCode - Supplies a Exception Code</span>
00053 <span class="comment"></span>
00054 <span class="comment">    ExceptionAddress - Supplies a pointer to user exception address</span>
00055 <span class="comment"></span>
00056 <span class="comment">    Argument0, Argument1, Argument2 - Possible ExceptionInformation</span>
00057 <span class="comment"></span>
00058 <span class="comment">Return:</span>
00059 <span class="comment">    Nothing</span>
00060 <span class="comment">--*/</span>
00061 {
00062     PEXCEPTION_RECORD ExceptionRecord;
00063 
00064     ExceptionRecord = (PEXCEPTION_RECORD)&amp;Frame-&gt;ExceptionRecord;
00065 
00066     ExceptionRecord-&gt;ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00067 
00068     ExceptionRecord-&gt;ExceptionCode = ExceptionCode;
00069     ExceptionRecord-&gt;ExceptionFlags = 0;
00070     ExceptionRecord-&gt;ExceptionAddress = ExceptionAddress;
00071     ExceptionRecord-&gt;NumberParameters = 5;
00072        
00073     ExceptionRecord-&gt;ExceptionInformation[0] = Argument0;
00074     ExceptionRecord-&gt;ExceptionInformation[1] = Argument1;
00075     ExceptionRecord-&gt;ExceptionInformation[2] = Argument2;
00076     ExceptionRecord-&gt;ExceptionInformation[3] = (ULONG_PTR)Frame-&gt;StIIPA;
00077     ExceptionRecord-&gt;ExceptionInformation[4] = (ULONG_PTR)Frame-&gt;StISR;
00078 }
00079 
00080 BOOLEAN
<a name="l00081"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a5">00081</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a5">KiIA32ExceptionDivide</a>(
00082     IN PKTRAP_FRAME Frame
00083     )
00084 <span class="comment">/*++</span>
00085 <span class="comment"></span>
00086 <span class="comment">Routine Description:</span>
00087 <span class="comment">    iA-32_Exception(Divide) - fault</span>
00088 <span class="comment"></span>
00089 <span class="comment">    Handle divide error fault.</span>
00090 <span class="comment"></span>
00091 <span class="comment">    Called from iA32_Exception() with </span>
00092 <span class="comment">        ISR.vector : 0</span>
00093 <span class="comment"></span>
00094 <span class="comment">    The divide error fault occurs if a DIV or IDIV instructions is</span>
00095 <span class="comment">    executed with a divisor of 0, or if the quotient is too big to</span>
00096 <span class="comment">    fit in the result operand.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    An INTEGER DIVIDED BY ZERO exception will be raised for the fault.</span>
00099 <span class="comment">    The Faults can only come from user mode.</span>
00100 <span class="comment"></span>
00101 <span class="comment">Arguments:</span>
00102 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">--*/</span>
00107 {
00108     <span class="comment">// </span>
00109     <span class="comment">// Setup exception and back to caller</span>
00110     <span class="comment">//</span>
00111 
00112     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00113                      <a class="code" href="../../d4/d4/iafptrap_8c.html#a11">Ki386CheckDivideByZeroTrap</a>(Frame),
00114                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00115                      0, 0, 0);
00116     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00117 }
00118 
00119 BOOLEAN
<a name="l00120"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a6">00120</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a6">KiIA32ExceptionDebug</a>(
00121     IN PKTRAP_FRAME Frame
00122     )
00123 <span class="comment">/*++</span>
00124 <span class="comment">Routine Description:</span>
00125 <span class="comment">    iA-32_Exception(Debug)</span>
00126 <span class="comment"></span>
00127 <span class="comment">    Called from iA32_Exception() with</span>
00128 <span class="comment">        ISR.Vector = 1</span>
00129 <span class="comment"></span>
00130 <span class="comment">    Depend on ISR.Code</span>
00131 <span class="comment">       0:  It is Code BreakPoint Trap</span>
00132 <span class="comment">       TrapCode:  Can be Concurrent Single Step | </span>
00133 <span class="comment">                  Taken Branch | Data BreakPoint Trap</span>
00134 <span class="comment">       Handler needs to decode ISR.Code to distinguish</span>
00135 <span class="comment">    Note: EFlag isn't saved yet, so write directly to ar.24</span>
00136 <span class="comment"></span>
00137 <span class="comment">Arguments:</span>
00138 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00139 <span class="comment"></span>
00140 <span class="comment">Return Value:</span>
00141 <span class="comment">    No return</span>
00142 <span class="comment"></span>
00143 <span class="comment">--*/</span>
00144 {
00145     ULONGLONG EFlag;
00146 
00147 <span class="preprocessor">#if defined(IADBG)</span>
00148 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( DEBUG )
00149        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Debug: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00150 <span class="preprocessor">#endif // IADBG</span>
00151 <span class="preprocessor"></span>    <span class="comment">// Turn off the TF bit</span>
00152     EFlag = __getReg(CV_IA64_AR24);
00153     EFlag &amp;= ~<a class="code" href="../../d8/d3/ia32def_8h.html#a22">EFLAGS_TF_BIT</a>;
00154     __setReg(CV_IA64_AR24, EFlag);
00155 
00156     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00157                      STATUS_WX86_SINGLE_STEP,
00158                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00159                      0, 0, 0);
00160     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00161 }
00162 
00163 BOOLEAN
<a name="l00164"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a7">00164</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a7">KiIA32ExceptionBreak</a>(
00165     IN PKTRAP_FRAME Frame
00166     )
00167 <span class="comment">/*++</span>
00168 <span class="comment"></span>
00169 <span class="comment">Routine Description:</span>
00170 <span class="comment">    iA-32_Exception(Break) - Trap</span>
00171 <span class="comment"></span>
00172 <span class="comment">    BreakPoint instruction (INT 3) trigged a trap.</span>
00173 <span class="comment">    Note: EFlag isn't saved yet, so write directly to ar.24</span>
00174 <span class="comment">Arguments:</span>
00175 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00176 <span class="comment"></span>
00177 <span class="comment">Return Value:</span>
00178 <span class="comment"></span>
00179 <span class="comment">--*/</span>
00180 {
00181     ULONGLONG EFlag;
00182 
00183 <span class="preprocessor">#if defined(IADBG)</span>
00184 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( BREAK )
00185        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Break: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00186 <span class="preprocessor">#endif // IADBG</span>
00187 <span class="preprocessor"></span>    <span class="comment">// Turn off the TF bit</span>
00188     EFlag = __getReg(CV_IA64_AR24);
00189     EFlag &amp;= ~<a class="code" href="../../d8/d3/ia32def_8h.html#a22">EFLAGS_TF_BIT</a>;
00190     __setReg(CV_IA64_AR24, EFlag);
00191 
00192     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00193                      STATUS_WX86_BREAKPOINT,
00194                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00195                      <a class="code" href="../../d8/d3/ia32def_8h.html#a17">BREAKPOINT_BREAK</a>,
00196                      <a class="code" href="../../d8/d3/ia32def_8h.html#a125">ECX</a>(Frame),
00197                      <a class="code" href="../../d8/d3/ia32def_8h.html#a126">EDX</a>(Frame));
00198     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00199 }
00200 
00201 BOOLEAN
<a name="l00202"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a8">00202</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a8">KiIA32ExceptionOverflow</a>(
00203     IN PKTRAP_FRAME Frame
00204     )
00205 <span class="comment">/*++</span>
00206 <span class="comment">Routine Description:</span>
00207 <span class="comment">    iA-32_Exception(Overflow) - Trap</span>
00208 <span class="comment">       ISR.Vector = 4</span>
00209 <span class="comment"></span>
00210 <span class="comment">    Handle INTO overflow</span>
00211 <span class="comment"></span>
00212 <span class="comment">    Eip - point to the address that next to the one causing INTO </span>
00213 <span class="comment"></span>
00214 <span class="comment">    Occurres when INTO instruction as well as EFlags.OF is ON</span>
00215 <span class="comment">    Trap only initiated from user mode</span>
00216 <span class="comment"></span>
00217 <span class="comment">Arguments:</span>
00218 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00219 <span class="comment"></span>
00220 <span class="comment">Return Value:</span>
00221 <span class="comment"></span>
00222 <span class="comment">--*/</span>
00223 {
00224 <span class="preprocessor">#if defined(IADBG)</span>
00225 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( OVERFLOW )
00226        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 OverFlow: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00227 <span class="preprocessor">#endif // IADBG</span>
00228 <span class="preprocessor"></span>
00229     <span class="comment">//</span>
00230     <span class="comment">// All error, generate exception and Eip point to INTO instruction</span>
00231     <span class="comment">//</span>
00232 
00233     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00234                      STATUS_INTEGER_OVERFLOW,
00235                      (PVOID) (<a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) - 1),
00236                      0, 0, 0);
00237     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00238 }
00239 
00240 
00241 BOOLEAN
<a name="l00242"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a9">00242</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a9">KiIA32ExceptionBound</a>(
00243     IN PKTRAP_FRAME Frame
00244     )
00245 <span class="comment">/*++</span>
00246 <span class="comment"></span>
00247 <span class="comment">Routine Description:</span>
00248 <span class="comment">    iA-32_Exception(Bound) - Fault</span>
00249 <span class="comment">    </span>
00250 <span class="comment">    Handle Bound check fault</span>
00251 <span class="comment">    ISR.Vector = 5</span>
00252 <span class="comment">    Eip - point to BOUND instruction</span>
00253 <span class="comment"></span>
00254 <span class="comment">    The bound check fault occurs if a BOUND instruction finds that</span>
00255 <span class="comment">    the tested value is outside the specified range.</span>
00256 <span class="comment"></span>
00257 <span class="comment">    For bound check fault, an ARRAY BOUND EXCEEDED exception will be raised.</span>
00258 <span class="comment"></span>
00259 <span class="comment">Arguments:</span>
00260 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00261 <span class="comment"></span>
00262 <span class="comment">Return Value:</span>
00263 <span class="comment"></span>
00264 <span class="comment">--*/</span>
00265 {
00266 <span class="preprocessor">#if defined(IADBG)</span>
00267 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( BOUND )
00268        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Bound: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00269 <span class="preprocessor">#endif // IADBG</span>
00270 <span class="preprocessor"></span>    <span class="comment">//</span>
00271     <span class="comment">// All error, generate exception with Eip point to BOUND instruction</span>
00272     <span class="comment">//</span>
00273     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00274                      STATUS_ARRAY_BOUNDS_EXCEEDED,
00275                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00276                      0, 0, 0);
00277     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00278 }
00279 
00280 
00281 ULONG
<a name="l00282"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a10">00282</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a10">IA32CheckOpcode</a>(
00283     IN PKTRAP_FRAME Frame
00284     )
00285 <span class="comment">/*++</span>
00286 <span class="comment"></span>
00287 <span class="comment">Routine Description:</span>
00288 <span class="comment">    </span>
00289 <span class="comment">    To identify the Opcode violation state</span>
00290 <span class="comment">    </span>
00291 <span class="comment">Arguments:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    Frame:  Pointer to iA32 TrapFrame in the stack</span>
00294 <span class="comment"></span>
00295 <span class="comment">Return Value:</span>
00296 <span class="comment">    Exception code</span>
00297 <span class="comment"></span>
00298 <span class="comment">--*/</span>
00299 {
00300     ULONG i;
00301     UCHAR OpCodeByte0;
00302     UCHAR OpCodeByte1;
00303     UCHAR OpCodeByte2;
00304         
00305         
00306     OpCodeByte0 = (UCHAR) Frame-&gt;StIIM &amp; 0xff;
00307     OpCodeByte1 = (UCHAR) (Frame-&gt;StIIM &gt;&gt; 8) &amp; 0xff;
00308     OpCodeByte2 = (UCHAR) (Frame-&gt;StIIM &gt;&gt; 16) &amp; 0xff;
00309 
00310     <span class="keywordflow">switch</span> (OpCodeByte0) {
00311        <span class="keywordflow">case</span> <a class="code" href="../../d8/d3/ia32def_8h.html#a73">MI_HLT</a>:
00312            <span class="keywordflow">return</span> (STATUS_PRIVILEGED_INSTRUCTION);
00313            <span class="keywordflow">break</span>;
00314 
00315        <span class="keywordflow">case</span> <a class="code" href="../../d8/d3/ia32def_8h.html#a72">MI_TWO_BYTE</a>:
00316            <span class="keywordflow">if</span> (OpCodeByte1 == <a class="code" href="../../d8/d3/ia32def_8h.html#a74">MI_LTR_LLDT</a> || 
00317                OpCodeByte2 == <a class="code" href="../../d8/d3/ia32def_8h.html#a75">MI_LGDT_LIDT_LMSW</a>) {
00318 
00319                OpCodeByte2 &amp;= <a class="code" href="../../d8/d3/ia32def_8h.html#a76">MI_MODRM_MASK</a>;      <span class="comment">// get bit 3-5 of ModRM byte</span>
00320 
00321                <span class="keywordflow">if</span> (OpCodeByte2==<a class="code" href="../../d8/d3/ia32def_8h.html#a77">MI_LLDT_MASK</a> || OpCodeByte2==<a class="code" href="../../d8/d3/ia32def_8h.html#a78">MI_LTR_MASK</a> ||
00322                    OpCodeByte2==<a class="code" href="../../d8/d3/ia32def_8h.html#a79">MI_LGDT_MASK</a> || OpCodeByte2==<a class="code" href="../../d8/d3/ia32def_8h.html#a80">MI_LIDT_MASK</a> || 
00323                    OpCodeByte2==<a class="code" href="../../d8/d3/ia32def_8h.html#a81">MI_LMSW_MASK</a>) {
00324                    <span class="keywordflow">return</span> (STATUS_PRIVILEGED_INSTRUCTION);
00325                } <span class="keywordflow">else</span>  {
00326                    <span class="keywordflow">return</span> (STATUS_ACCESS_VIOLATION);
00327                }
00328 
00329             } <span class="keywordflow">else</span> {
00330                 <span class="keywordflow">if</span> (OpCodeByte1 &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a82">MI_SPECIAL_MOV_MASK</a>) {
00331                     <span class="comment">//</span>
00332                     <span class="comment">// mov may have special_mov_mask</span>
00333                     <span class="comment">// but they are not 2 bytes OpCode</span>
00334                     <span class="comment">//</span>
00335                     <span class="keywordflow">return</span> (STATUS_PRIVILEGED_INSTRUCTION);
00336                 } <span class="keywordflow">else</span> {
00337                     <span class="comment">//</span>
00338                     <span class="comment">// Do we need to further check if it is INVD, INVLPG ... ?</span>
00339                     <span class="comment">//</span>
00340                     <span class="keywordflow">return</span> (STATUS_ACCESS_VIOLATION);
00341                 }
00342             }
00343             <span class="keywordflow">break</span>;
00344 
00345         <span class="keywordflow">default</span>:
00346             <span class="comment">//</span>
00347             <span class="comment">// All other </span>
00348             <span class="comment">//</span>
00349             <span class="keywordflow">return</span> (STATUS_ILLEGAL_INSTRUCTION);
00350             <span class="keywordflow">break</span>;
00351         }
00352 }
00353 
00354 BOOLEAN
<a name="l00355"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a11">00355</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a11">KiIA32InterceptInstruction</a>(
00356     IN PKTRAP_FRAME Frame
00357     )
00358 <span class="comment">/*++</span>
00359 <span class="comment"></span>
00360 <span class="comment">Routine Description:</span>
00361 <span class="comment">    iA-32_Exception(InstructionIntercept Opcode)</span>
00362 <span class="comment"></span>
00363 <span class="comment">    Program entry for either</span>
00364 <span class="comment">       1. IA-32 Invalid Opcode Fault #6, or</span>
00365 <span class="comment">       2. IA-32 interceptions(Inst)</span>
00366 <span class="comment"></span>
00367 <span class="comment">    Execution of unimplemented IA-32 opcodes, illegal opcodes or sensitive </span>
00368 <span class="comment">    privileged IA32 operating system instructions results this interception.</span>
00369 <span class="comment"></span>
00370 <span class="comment">    Possible Opcodes:</span>
00371 <span class="comment">        Privileged Opcodes: CLTS, HLT, INVD, INVLPG, LIDT, LMSW, LTR, </span>
00372 <span class="comment">                            mov to/from CRs, DRs</span>
00373 <span class="comment">                            RDMSR, RSM, SMSW, WBINVD, WRMSR</span>
00374 <span class="comment"></span>
00375 <span class="comment">Arguments:</span>
00376 <span class="comment"></span>
00377 <span class="comment">    Frame - Supply a pointer to an iA32 TrapFrame</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">--*/</span>
00382 {
00383 <span class="preprocessor">#if defined(IADBG)</span>
00384 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( INSTRUCTION )
00385        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Instruction: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00386 <span class="preprocessor">#endif // IADBG</span>
00387 <span class="preprocessor"></span>
00388     <span class="keywordflow">switch</span> ( <a class="code" href="../../d0/d4/ia32trap_8c.html#a10">IA32CheckOpcode</a>(Frame) ) {
00389         <span class="keywordflow">case</span> STATUS_PRIVILEGED_INSTRUCTION:
00390             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00391                              STATUS_PRIVILEGED_INSTRUCTION,
00392                              (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00393                              0, 0, 0);
00394             <span class="keywordflow">break</span>;
00395         <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION:    
00396             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00397                              STATUS_ACCESS_VIOLATION,
00398                              (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00399                              0, -1, 0);
00400             <span class="keywordflow">break</span>; 
00401         <span class="keywordflow">case</span> STATUS_ILLEGAL_INSTRUCTION:
00402             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00403                              STATUS_ILLEGAL_INSTRUCTION,
00404                              (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00405                              0, -1, 0);
00406             <span class="keywordflow">break</span>;
00407         <span class="keywordflow">default</span>:
00408             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a22">TRAP_CAUSE_UNKNOWN</a>, (ULONG_PTR)Frame, <a class="code" href="../../d0/d4/ia32trap_8c.html#a10">IA32CheckOpcode</a>(Frame), 0, 1);
00409             <span class="comment">// Should never get here...</span>
00410             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00411             <span class="keywordflow">break</span>;
00412     }
00413     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00414 }
00415 
00416 BOOLEAN
<a name="l00417"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a12">00417</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a12">KiIA32ExceptionNoDevice</a>(
00418     IN PKTRAP_FRAME Frame
00419     )
00420 <span class="comment">/*++</span>
00421 <span class="comment"></span>
00422 <span class="comment">Routine Description:</span>
00423 <span class="comment"></span>
00424 <span class="comment">    iA-32_Exception(Coprocessor Not Available) - fault</span>
00425 <span class="comment"></span>
00426 <span class="comment">    This routine is called from iA32_Exception() with</span>
00427 <span class="comment">         ISR.Vector = 7</span>
00428 <span class="comment"></span>
00429 <span class="comment">    Note:</span>
00430 <span class="comment">        At this time, the AR registers have not been saved. This</span>
00431 <span class="comment">        includes, CFLAGS (AR.27), EFLAGS (AR.24), FCR (AR.21),</span>
00432 <span class="comment">        FSR (AR.28), FIR (AR.29) and FDR (AR.30).</span>
00433 <span class="comment"></span>
00434 <span class="comment">        Not handling MMX and KNI exceptions yet.</span>
00435 <span class="comment"></span>
00436 <span class="comment">Arguments:</span>
00437 <span class="comment"></span>
00438 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00439 <span class="comment"></span>
00440 <span class="comment">Return Value:</span>
00441 <span class="comment"></span>
00442 <span class="comment">--*/</span>
00443 {
00444     ULONG ErrorCode;
00445     ULONG FirOffset, FdrOffset;
00446     ULONG FpState;
00447     <span class="comment">// For these 2 registers, we only care about the lower 32-bits</span>
00448     ULONG FcrRegister, FsrRegister;
00449         
00450 <span class="preprocessor">#if defined(IADBG)</span>
00451 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( NODEVICE )
00452        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 NoDevice: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00453 <span class="preprocessor">#endif // IADBG</span>
00454 <span class="preprocessor"></span>
00455     FcrRegister = (ULONG) (__getReg(CV_IA64_AR21) &amp; 0xFFFFFFFF);
00456     FsrRegister = (ULONG) (__getReg(CV_IA64_AR28) &amp; 0xFFFFFFFF);
00457     FirOffset = (ULONG) (__getReg(CV_IA64_AR29) &amp; 0xFFFFFFFF);
00458     FdrOffset = (ULONG) (__getReg(CV_IA64_AR30) &amp; 0xFFFFFFFF);
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">// According to the floating error priority, </span>
00462     <span class="comment">// we test what is the cause of the NPX error </span>
00463     <span class="comment">// and raise an appropriate exception</span>
00464     <span class="comment">//</span>
00465     FpState = ~(FcrRegister &amp;
00466                 (<a class="code" href="../../d8/d3/ia32def_8h.html#a110">FSW_INVALID_OPERATION</a> | <a class="code" href="../../d8/d3/ia32def_8h.html#a111">FSW_DENORMAL</a> | 
00467                  <a class="code" href="../../d8/d3/ia32def_8h.html#a112">FSW_ZERO_DIVIDE</a> | <a class="code" href="../../d8/d3/ia32def_8h.html#a113">FSW_OVERFLOW</a> | 
00468                  <a class="code" href="../../d8/d3/ia32def_8h.html#a114">FSW_UNDERFLOW</a> | <a class="code" href="../../d8/d3/ia32def_8h.html#a115">FSW_PRECISION</a>)) &amp; (FsrRegister &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a121">FSW_ERR_MASK</a>);
00469 
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">// Was an invalid operation fault?</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a110">FSW_INVALID_OPERATION</a>) {
00476 
00477         <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a116">FSW_STACK_FAULT</a>) {
00478             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00479                              STATUS_FLOAT_STACK_CHECK,
00480                              (PVOID) FirOffset,
00481                              0, FdrOffset, 0);
00482             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00483         } <span class="keywordflow">else</span> {
00484             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00485                              STATUS_FLOAT_INVALID_OPERATION,
00486                              (PVOID) FirOffset,
00487                              0, 0, 0);
00488             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489         }
00490 
00491     } <span class="keywordflow">else</span> {
00492 
00493         <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a112">FSW_ZERO_DIVIDE</a>)
00494             ErrorCode = STATUS_FLOAT_DIVIDE_BY_ZERO; 
00495         <span class="keywordflow">else</span> { <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a111">FSW_DENORMAL</a>) 
00496                    ErrorCode = STATUS_FLOAT_INVALID_OPERATION; 
00497                <span class="keywordflow">else</span> { <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a113">FSW_OVERFLOW</a>)
00498                           ErrorCode = STATUS_FLOAT_OVERFLOW; 
00499                       <span class="keywordflow">else</span> { <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a114">FSW_UNDERFLOW</a>)
00500                                  ErrorCode = STATUS_FLOAT_UNDERFLOW; 
00501                              <span class="keywordflow">else</span> { <span class="keywordflow">if</span> (FpState &amp; <a class="code" href="../../d8/d3/ia32def_8h.html#a115">FSW_PRECISION</a>)
00502                                         ErrorCode = STATUS_FLOAT_INEXACT_RESULT; 
00503                                     <span class="keywordflow">else</span>
00504                                         ErrorCode = 0;
00505                              }
00506                       }
00507                }
00508         }
00509     }
00510                     
00511     <span class="keywordflow">if</span> (ErrorCode) {
00512             <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00513                              STATUS_FLOAT_INEXACT_RESULT,
00514                              (PVOID) FirOffset,
00515                              0, 0, 0);
00516             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00517     } <span class="keywordflow">else</span> {  
00518 
00519         <span class="comment">//</span>
00520         <span class="comment">// FpState indicates no error, then something is wrong</span>
00521         <span class="comment">// Panic the system !!!</span>
00522         <span class="comment">//</span>
00523 
00524         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a22">TRAP_CAUSE_UNKNOWN</a>, (ULONG_PTR)Frame, 0, 0, 2);
00525     }
00526 
00527     <span class="comment">// Should never get here...</span>
00528     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529 }
00530 
00531 BOOLEAN
<a name="l00532"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a13">00532</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a13">KiIA32ExceptionSegmentNotPresent</a>(
00533     IN PKTRAP_FRAME Frame
00534         )
00535 <span class="comment">/*++</span>
00536 <span class="comment"></span>
00537 <span class="comment">Routine Description:</span>
00538 <span class="comment">    iA-32_Exception(Not Present) - fault</span>
00539 <span class="comment"></span>
00540 <span class="comment">    Handle Segment Not Present fault.</span>
00541 <span class="comment">        ISR.Vector = 11</span>
00542 <span class="comment"></span>
00543 <span class="comment">    This exception occurs when the processor finds the P bit 0</span>
00544 <span class="comment">    when accessing an otherwise valid descriptor that is not to</span>
00545 <span class="comment">    be loaded in SS register.</span>
00546 <span class="comment"></span>
00547 <span class="comment">Arguments:</span>
00548 <span class="comment"></span>
00549 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00550 <span class="comment"></span>
00551 <span class="comment">Return Value:</span>
00552 <span class="comment"></span>
00553 <span class="comment">--*/</span>
00554 {
00555     KIRQL OldIrql;
00556     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ErrorCode;
00557 
00558 <span class="preprocessor">#if defined(IADBG)</span>
00559 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( NOTPRESENT )
00560        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 NotPresent: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00561 <span class="preprocessor">#endif // IADBG</span>
00562 <span class="preprocessor"></span>
00563     <span class="comment">//</span>
00564     <span class="comment">// Generate Exception for all other errors</span>
00565     <span class="comment">//</span>
00566 
00567     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00568                      STATUS_ACCESS_VIOLATION,
00569                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00570                      0, <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>(Frame) | RPL_MASK, 0);
00571     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00572 }
00573 
00574 BOOLEAN
<a name="l00575"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a14">00575</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a14">KiIA32ExceptionStack</a>(
00576     IN PKTRAP_FRAME Frame
00577     )
00578 <span class="comment">/*++</span>
00579 <span class="comment"></span>
00580 <span class="comment">Routine Description:</span>
00581 <span class="comment">    iA-32_Exception(Stack) - fault</span>
00582 <span class="comment"></span>
00583 <span class="comment">    ISR.Vector = 12</span>
00584 <span class="comment"></span>
00585 <span class="comment">    This exception occurs when the processor detects certain problem</span>
00586 <span class="comment">    with the segment addressed by the SS segment register:</span>
00587 <span class="comment"></span>
00588 <span class="comment">    1. A limit violation in the segment addressed by the SS (error</span>
00589 <span class="comment">       code = 0)</span>
00590 <span class="comment">    2. A limit vioalation in the inner stack during an interlevel</span>
00591 <span class="comment">       call or interrupt (error code = selector for the inner stack)</span>
00592 <span class="comment">    3. If the descriptor to be loaded into SS has its present bit 0</span>
00593 <span class="comment">       (error code = selector for the not-present segment)</span>
00594 <span class="comment"></span>
00595 <span class="comment">    The exception only occurred from user mode</span>
00596 <span class="comment"></span>
00597 <span class="comment">Arguments:</span>
00598 <span class="comment"></span>
00599 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00600 <span class="comment"></span>
00601 <span class="comment">Return Value:</span>
00602 <span class="comment"></span>
00603 <span class="comment">--*/</span>
00604 {
00605     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Code;
00606 
00607 <span class="preprocessor">#if defined(IADBG)</span>
00608 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( STACK )
00609        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Stack: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00610 <span class="preprocessor">#endif // IADBG</span>
00611 <span class="preprocessor"></span>
00612     <span class="comment">//</span>
00613     <span class="comment">// Dispatch Exception to user</span>
00614     <span class="comment">//</span>
00615    
00616     Code = <a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>(Frame);
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// Code may contain the faulting selector</span>
00620     <span class="comment">//</span>
00621     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00622                      STATUS_ACCESS_VIOLATION,
00623                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00624                       Code ? (Code | RPL_MASK) :  <a class="code" href="../../d8/d3/ia32def_8h.html#a124">ESP</a>(Frame),
00625                       Code ? <a class="code" href="../../d8/d3/ia32def_8h.html#a18">EXCEPT_UNKNOWN_ACCESS</a> : <a class="code" href="../../d8/d3/ia32def_8h.html#a19">EXCEPT_LIMIT_ACCESS</a>,
00626                       0);
00627     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00628 }
00629 
00630 BOOLEAN
<a name="l00631"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a15">00631</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a15">KiIA32ExceptionInvalidOp</a>(
00632     IN PKTRAP_FRAME Frame
00633     )
00634 <span class="comment">/*++</span>
00635 <span class="comment"></span>
00636 <span class="comment">Routine Description:</span>
00637 <span class="comment">    iA-32_Exception(Invalid Opcode) - fault</span>
00638 <span class="comment"></span>
00639 <span class="comment">    PKTRAP_FRAME Frame</span>
00640 <span class="comment">           Eip  : virtual iA-32 instruction address</span>
00641 <span class="comment">           ISR.vector : 6</span>
00642 <span class="comment"></span>
00643 <span class="comment">    Note: </span>
00644 <span class="comment">        Only MMX and KNI instructions can cause this fault based</span>
00645 <span class="comment">        on values in CR0 and CR4</span>
00646 <span class="comment"></span>
00647 <span class="comment">Arguments:</span>
00648 <span class="comment"></span>
00649 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00650 <span class="comment"></span>
00651 <span class="comment">Return Value:</span>
00652 <span class="comment">--*/</span>
00653 {
00654 <span class="preprocessor">#if defined(IADBG)</span>
00655 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( INSTRUCTION )
00656        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Invalid Opcode: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00657 <span class="preprocessor">#endif // IADBG</span>
00658 <span class="preprocessor"></span>
00659     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00660         STATUS_ILLEGAL_INSTRUCTION,
00661         (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00662         0, 0, 0);
00663     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00664 }
00665 
00666 BOOLEAN
<a name="l00667"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a16">00667</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a16">KiIA32ExceptionGPFault</a>(
00668     IN PKTRAP_FRAME Frame
00669     )
00670 <span class="comment">/*++</span>
00671 <span class="comment"></span>
00672 <span class="comment">Routine Description:</span>
00673 <span class="comment">    iA-32_Exception(General Protection) - fault</span>
00674 <span class="comment"></span>
00675 <span class="comment">    PKTRAP_FRAME Frame</span>
00676 <span class="comment">           Eip  : virtual iA-32 instruction address</span>
00677 <span class="comment">           ISR.vector : 13</span>
00678 <span class="comment">           ISR.code   : ErrorCode</span>
00679 <span class="comment"></span>
00680 <span class="comment">    Note: </span>
00681 <span class="comment">        Previlidged instructions are intercepted, </span>
00682 <span class="comment">           see KiIA32InterceptInstruction</span>
00683 <span class="comment"></span>
00684 <span class="comment">Arguments:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00687 <span class="comment"></span>
00688 <span class="comment">Return Value:</span>
00689 <span class="comment"></span>
00690 <span class="comment">--*/</span>
00691 {
00692 <span class="preprocessor">#if defined(IADBG)</span>
00693 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( GPFAULT )
00694        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 GpFault: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00695 <span class="preprocessor">#endif // IADBG</span>
00696 <span class="preprocessor"></span>
00697     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00698                      STATUS_ACCESS_VIOLATION,
00699                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00700                      0, 0, 0);
00701     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00702 }
00703 
00704 
00705 
00706 BOOLEAN
<a name="l00707"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a17">00707</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a17">KiIA32ExceptionKNI</a>(
00708     IN PKTRAP_FRAME Frame
00709     )
00710 <span class="comment">/*++</span>
00711 <span class="comment"></span>
00712 <span class="comment">iA32_Exception(KNI) - Fault</span>
00713 <span class="comment"></span>
00714 <span class="comment">   Unmasked KNI IA32 Error.</span>
00715 <span class="comment">   ISR.Vector = 19</span>
00716 <span class="comment"></span>
00717 <span class="comment">--*/</span>
00718 {
00719 <span class="preprocessor">#if defined(IADBG)</span>
00720 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( FPFAULT )
00721        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 KNI Fault: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00722 <span class="preprocessor">#endif // IADBG</span>
00723 <span class="preprocessor"></span>    <span class="keywordflow">return</span>(<a class="code" href="../../d0/d4/ia32trap_8c.html#a12">KiIA32ExceptionNoDevice</a>(Frame));
00724 }
00725 
00726 
00727 BOOLEAN
<a name="l00728"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a18">00728</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a18">KiIA32ExceptionFPFault</a>(
00729     IN PKTRAP_FRAME Frame
00730     )
00731 <span class="comment">/*++</span>
00732 <span class="comment"></span>
00733 <span class="comment">iA32_Exception(Floating Point) - Fault</span>
00734 <span class="comment"></span>
00735 <span class="comment">   Handle Coprocessor Error.</span>
00736 <span class="comment">   ISR.Vector = 16</span>
00737 <span class="comment"></span>
00738 <span class="comment">   This exception is used on 486 or above only.  For i386, it uses</span>
00739 <span class="comment">   IRQ 13 instead. </span>
00740 <span class="comment"> </span>
00741 <span class="comment">   JMPE instruction should flush all FP delayed exception, and the traps </span>
00742 <span class="comment">   will goto Device Not Available trap</span>
00743 <span class="comment"></span>
00744 <span class="comment">--*/</span>
00745 {
00746 <span class="preprocessor">#if defined(IADBG)</span>
00747 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( FPFAULT )
00748        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 FpFault: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00749 <span class="preprocessor">#endif // IADBG</span>
00750 <span class="preprocessor"></span>    <span class="keywordflow">return</span>(<a class="code" href="../../d0/d4/ia32trap_8c.html#a12">KiIA32ExceptionNoDevice</a>(Frame));
00751 }
00752 
00753 
00754 BOOLEAN
<a name="l00755"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a19">00755</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a19">KiIA32ExceptionAlignmentFault</a>(
00756     IN PKTRAP_FRAME Frame
00757     )
00758 <span class="comment">/*++</span>
00759 <span class="comment"></span>
00760 <span class="comment">iA32_Exception(Alignment Check) - fault</span>
00761 <span class="comment"></span>
00762 <span class="comment">   Handle alignment faults.</span>
00763 <span class="comment">   ISR.Vector = 17</span>
00764 <span class="comment"></span>
00765 <span class="comment">   This exception occurs when an unaligned data access is made by a thread</span>
00766 <span class="comment">   with alignment checking turned on.</span>
00767 <span class="comment"></span>
00768 <span class="comment">   This fault occurred when unaligned access on EM PSR.AC is ON</span>
00769 <span class="comment">   Note that iA32 EFLAFS.AC, CR0.AM and CPL!=3 does not unmask the fault.</span>
00770 <span class="comment"></span>
00771 <span class="comment">    So, for now, let the ia64 alignment handler handle this...</span>
00772 <span class="comment"></span>
00773 <span class="comment">--*/</span>
00774 {
00775 <span class="preprocessor">#if defined(IADBG)</span>
00776 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( ALIGNMENT )
00777        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Alignment: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00778 <span class="preprocessor">#endif // IADBG</span>
00779 <span class="preprocessor"></span>
00780     <span class="comment">//</span>
00781     <span class="comment">// BUGBUG: We should really turn off psr.ac for an ia32 process...</span>
00782     <span class="comment">//</span>
00783     <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a12">KiUnalignedFault</a>(Frame);
00784 }
00785 
00786 
00787 BOOLEAN
<a name="l00788"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a20">00788</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a20">KiIA32InterruptVector</a>(
00789     IN PKTRAP_FRAME Frame
00790     )
00791 <span class="comment">/*++</span>
00792 <span class="comment"></span>
00793 <span class="comment">iA32_Interrupt(Vector #) - trap</span>
00794 <span class="comment"></span>
00795 <span class="comment">   Handle INTnn trap</span>
00796 <span class="comment"></span>
00797 <span class="comment">   Under EM system mode, iA32 INT instruction forces a mandatory iA-32 </span>
00798 <span class="comment">   interrupt trap through iA-32 Interrupt(SoftWare Interrupt)</span>
00799 <span class="comment"></span>
00800 <span class="comment">--*/</span>
00801 {
00802 <span class="preprocessor">#if defined(IADBG)</span>
00803 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( INTNN )
00804        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Intnn: Eip %x INT 0x%xH\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame), <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame));
00805 <span class="preprocessor">#endif // IADBG</span>
00806 <span class="preprocessor"></span>    <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00807         STATUS_PRIVILEGED_INSTRUCTION,
00808         (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00809         0, 0, 0);
00810     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00811 }
00812 
00813 
00814 BOOLEAN
<a name="l00815"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a21">00815</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a21">KiIA32InterceptGate</a>(
00816     IN PKTRAP_FRAME Frame
00817     )
00818 <span class="comment">/*++</span>
00819 <span class="comment"></span>
00820 <span class="comment">Routine Description:</span>
00821 <span class="comment"></span>
00822 <span class="comment">    iA32_Intercept(Gate) - trap</span>
00823 <span class="comment"></span>
00824 <span class="comment">    If an iA32 control transfer is initiated through a GDT or LDT descriptor</span>
00825 <span class="comment">    that results in an either a promotion of privilege level (interlevel Call</span>
00826 <span class="comment">    or Jump Gate and IRET) or an iA32 task switch (TSS segment or Gate), </span>
00827 <span class="comment">    the intercept trap is generated.</span>
00828 <span class="comment"></span>
00829 <span class="comment">    Possible instructions intercepted:</span>
00830 <span class="comment">        CALL, RET, IRET, IRETD and JMP</span>
00831 <span class="comment"></span>
00832 <span class="comment">    Handling</span>
00833 <span class="comment">        No CaLL, RET, JMP, IRET, IRETD are allowed in any mode, </span>
00834 <span class="comment">           STATUS_ACCESS_VIOLATION is returned</span>
00835 <span class="comment"></span>
00836 <span class="comment">Arguments:</span>
00837 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
00838 <span class="comment"></span>
00839 <span class="comment">Return Value:</span>
00840 <span class="comment"></span>
00841 <span class="comment">--*/</span>
00842 {
00843 <span class="preprocessor">#if defined(IADBG)</span>
00844 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( GATE )
00845        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 Gate: Eip %x GateSelector %x OpcodeId %x\n"</span>,
00846                  <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00847                  (ULONG) (Frame-&gt;IFA &amp; 0xff),
00848                  (ULONG) (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>(Frame) &gt;&gt; 14));
00849 <span class="preprocessor">#endif // IADBG</span>
00850 <span class="preprocessor"></span>
00851     <span class="comment">//</span>
00852     <span class="comment">// all error fall through here</span>
00853     <span class="comment">//</span>
00854     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00855         STATUS_ILLEGAL_INSTRUCTION,
00856         (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00857         0, 0, 0);
00858     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00859 }
00860 
00861 <span class="comment">/*++</span>
00862 <span class="comment"></span>
00863 <span class="comment">iA32_intercept(System Flag) - trap</span>
00864 <span class="comment"></span>
00865 <span class="comment">   Possible Causes:</span>
00866 <span class="comment">        1. if CFLAG.ii==1 and EFLAG.if changes state</span>
00867 <span class="comment">        2. Generated after either EFLAG.ac, tf or rf changes state</span>
00868 <span class="comment">           if no IOPL or CPL to modify bits then no interception.</span>
00869 <span class="comment">        3. if CFLG.nm==1 then successful execution of IRET also intercepted</span>
00870 <span class="comment"></span>
00871 <span class="comment">   Possible instructions:</span>
00872 <span class="comment">       CLI, POPF, POFD, STI and IRET</span>
00873 <span class="comment"></span>
00874 <span class="comment">   Currently, we set both CFLAG.ii and nm to 0, so that we will only possiblly </span>
00875 <span class="comment">   get case #2.  But in EM/NT, it should always come from user land which</span>
00876 <span class="comment">   we hard-set EFLAG.IOPL to 0, so there if we do get case #2, then it is user</span>
00877 <span class="comment">   play around EFLAG.IOPL through JMPE.  We should fail it.</span>
00878 <span class="comment"></span>
00879 <span class="comment">--*/</span>
00880 
00881 BOOLEAN
<a name="l00882"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a22">00882</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a22">KiIA32InterceptSystemFlag</a>(
00883     IN PKTRAP_FRAME Frame
00884     )
00885 {
00886 <span class="preprocessor">#if defined(IADBG)</span>
00887 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( FLAG )
00888        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 FLAG: Eip %x Old EFlag: %x OpcodeId %x\n"</span>, 
00889                  <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00890                  (ULONG) (Frame-&gt;IIM &amp; 0xff),
00891                  (ULONG) (<a class="code" href="../../d8/d3/ia32def_8h.html#a127">ISRCode</a>(Frame) &gt;&gt; 14));
00892 <span class="preprocessor">#endif // IADBG</span>
00893 <span class="preprocessor"></span>    <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00894         STATUS_ILLEGAL_INSTRUCTION,
00895         (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00896         0, 0, 0);
00897     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00898 }
00899 
00900 BOOLEAN
<a name="l00901"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a23">00901</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a23">KiIA32InterceptLock</a>(
00902     IN PKTRAP_FRAME Frame
00903     )
00904 <span class="comment">/*++</span>
00905 <span class="comment"></span>
00906 <span class="comment">Routine Description:</span>
00907 <span class="comment">    iA32_Intercept(Lock) - trap</span>
00908 <span class="comment"></span>
00909 <span class="comment">    Lock intercepts occurred if platform or firmware code has disabled locked</span>
00910 <span class="comment">    transactions and atomic memory update requires a processor external </span>
00911 <span class="comment">    indication</span>
00912 <span class="comment"></span>
00913 <span class="comment">Arguments:</span>
00914 <span class="comment">    Frame - Point to iA32 TrapFrame</span>
00915 <span class="comment"></span>
00916 <span class="comment">Return:</span>
00917 <span class="comment"></span>
00918 <span class="comment">--*/</span>
00919 {
00920 <span class="preprocessor">#if defined(IADBG)</span>
00921 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> )
00922        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"IA32 LOCK: Eip %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame) );
00923 <span class="preprocessor">#endif // IADBG</span>
00924 <span class="preprocessor"></span>
00925     <span class="comment">//</span>
00926     <span class="comment">// BUGBUG: Delay implementation of this handler</span>
00927     <span class="comment">// Should we bug check instead so we know when we're running</span>
00928     <span class="comment">// on a platform that needs this?</span>
00929     <span class="comment">//</span>
00930     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
00931         STATUS_PRIVILEGED_INSTRUCTION,
00932         (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
00933         0, 0, 0);
00934     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00935 }
00936 
00937 BOOLEAN
<a name="l00938"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a24">00938</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>(
00939     IN PKTRAP_FRAME Frame
00940     )
00941 {
00942     <span class="comment">//</span>
00943     <span class="comment">// Panic the system </span>
00944     <span class="comment">//</span>
00945 
00946     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a22">TRAP_CAUSE_UNKNOWN</a>, 
00947                  (ULONG_PTR)Frame, 
00948                  <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame), 
00949                  0, 0);
00950     <span class="comment">// Should never get here...</span>
00951     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00952 }
00953     
00954 
00955 
<a name="l00956"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a1">00956</a> BOOLEAN (*KiIA32ExceptionDispatchTable[])(PKTRAP_FRAME) = {
00957     <a class="code" href="../../d0/d4/ia32trap_8c.html#a5">KiIA32ExceptionDivide</a>,
00958     <a class="code" href="../../d0/d4/ia32trap_8c.html#a6">KiIA32ExceptionDebug</a>,
00959     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00960     <a class="code" href="../../d0/d4/ia32trap_8c.html#a7">KiIA32ExceptionBreak</a>,
00961     <a class="code" href="../../d0/d4/ia32trap_8c.html#a8">KiIA32ExceptionOverflow</a>,
00962     <a class="code" href="../../d0/d4/ia32trap_8c.html#a9">KiIA32ExceptionBound</a>,
00963     <a class="code" href="../../d0/d4/ia32trap_8c.html#a15">KiIA32ExceptionInvalidOp</a>,
00964     <a class="code" href="../../d0/d4/ia32trap_8c.html#a12">KiIA32ExceptionNoDevice</a>,
00965     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00966     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00967     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00968     <a class="code" href="../../d0/d4/ia32trap_8c.html#a13">KiIA32ExceptionSegmentNotPresent</a>,
00969     <a class="code" href="../../d0/d4/ia32trap_8c.html#a14">KiIA32ExceptionStack</a>,
00970     <a class="code" href="../../d0/d4/ia32trap_8c.html#a16">KiIA32ExceptionGPFault</a>,
00971     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00972     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00973     <a class="code" href="../../d0/d4/ia32trap_8c.html#a18">KiIA32ExceptionFPFault</a>,
00974     <a class="code" href="../../d0/d4/ia32trap_8c.html#a19">KiIA32ExceptionAlignmentFault</a>,
00975     <a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>,
00976     <a class="code" href="../../d0/d4/ia32trap_8c.html#a17">KiIA32ExceptionKNI</a>
00977 };
00978 
<a name="l00979"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a2">00979</a> BOOLEAN (*KiIA32InterceptionDispatchTable[])(PKTRAP_FRAME) = {
00980     <a class="code" href="../../d0/d4/ia32trap_8c.html#a11">KiIA32InterceptInstruction</a>,
00981     <a class="code" href="../../d0/d4/ia32trap_8c.html#a21">KiIA32InterceptGate</a>,
00982     <a class="code" href="../../d0/d4/ia32trap_8c.html#a22">KiIA32InterceptSystemFlag</a>,
00983     <a class="code" href="../../d0/d4/ia32trap_8c.html#a23">KiIA32InterceptLock</a>
00984 };
00985 
00986 BOOLEAN
<a name="l00987"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a25">00987</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a25">KiIA32InterceptionVectorHandler</a>(
00988     IN PKTRAP_FRAME Frame
00989     )
00990 <span class="comment">/*++</span>
00991 <span class="comment"></span>
00992 <span class="comment">Routine Description:</span>
00993 <span class="comment"></span>
00994 <span class="comment">    KiIA32InterceptionVectorHandler</span>
00995 <span class="comment"></span>
00996 <span class="comment">    Called by first label KiIA32InterceptionVector() to handle further iA32 </span>
00997 <span class="comment">    interception processing.</span>
00998 <span class="comment">   </span>
00999 <span class="comment">Arguments:</span>
01000 <span class="comment"></span>
01001 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
01002 <span class="comment"></span>
01003 <span class="comment">Return Value:</span>
01004 <span class="comment">    TRUE - go to dispatch exception</span>
01005 <span class="comment">    FALSE - Exception was handled, do an RFI</span>
01006 <span class="comment"></span>
01007 <span class="comment">--*/</span>
01008 {
01009 <span class="preprocessor">#if defined(IADBG)</span>
01010 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( INTERCEPTION )
01011        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IA32 Interception: ISRVector %x Frame %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame), Frame);
01012 <span class="preprocessor">#endif // IADBG</span>
01013 <span class="preprocessor"></span>
01014     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> == Frame-&gt;PreviousMode);
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">// Make sure we have an entry in the table for this interception</span>
01018     <span class="comment">//</span>
01019     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame) &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/ia32trap_8c.html#a2">KiIA32InterceptionDispatchTable</a>)&gt;&gt;2) 
01020         <span class="keywordflow">return</span> (*<a class="code" href="../../d0/d4/ia32trap_8c.html#a2">KiIA32InterceptionDispatchTable</a>[<a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame)])(Frame);
01021     <span class="keywordflow">else</span>
01022         <span class="keywordflow">return</span> (<a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>(Frame));
01023 }
01024 
01025 BOOLEAN
<a name="l01026"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a26">01026</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a26">KiIA32ExceptionVectorHandler</a>(
01027     IN PKTRAP_FRAME Frame
01028     )
01029 <span class="comment">/*++</span>
01030 <span class="comment"></span>
01031 <span class="comment">Routine Description:</span>
01032 <span class="comment"></span>
01033 <span class="comment">    KiIA32ExceptionVectorHandler</span>
01034 <span class="comment"></span>
01035 <span class="comment">    Called by first label KiIA32ExceptionVector() to handle further iA32 </span>
01036 <span class="comment">    interception processing.</span>
01037 <span class="comment">   </span>
01038 <span class="comment">Arguments:</span>
01039 <span class="comment"></span>
01040 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
01041 <span class="comment"></span>
01042 <span class="comment">Return Value:</span>
01043 <span class="comment">    TRUE - go to dispatch exception</span>
01044 <span class="comment">    FALSE - Exception was handled, do an RFI</span>
01045 <span class="comment"></span>
01046 <span class="comment">--*/</span>
01047 {
01048 <span class="preprocessor">#if defined(IADBG)</span>
01049 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( EXCEPTION )
01050        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IA32 Exception: ISRVector %x Frame %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame), Frame);
01051 <span class="preprocessor">#endif // IADBG</span>
01052 <span class="preprocessor"></span>
01053     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> == Frame-&gt;PreviousMode);
01054     <span class="comment">//</span>
01055     <span class="comment">// Make sure we have an entry in the table for this exception</span>
01056     <span class="comment">//</span>
01057     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame) &lt;= <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/ia32trap_8c.html#a1">KiIA32ExceptionDispatchTable</a>)&gt;&gt;2) 
01058         <span class="keywordflow">return</span> (*<a class="code" href="../../d0/d4/ia32trap_8c.html#a1">KiIA32ExceptionDispatchTable</a>[<a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame)])(Frame);
01059     <span class="keywordflow">else</span>
01060         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d4/ia32trap_8c.html#a24">KiIA32ExceptionPanic</a>(Frame));
01061 }
01062 
01063 BOOLEAN
<a name="l01064"></a><a class="code" href="../../d0/d4/ia32trap_8c.html#a27">01064</a> <a class="code" href="../../d0/d4/ia32trap_8c.html#a27">KiIA32InterruptionVectorHandler</a>(
01065     IN PKTRAP_FRAME Frame
01066     )
01067 <span class="comment">/*++</span>
01068 <span class="comment"></span>
01069 <span class="comment">Routine Description:</span>
01070 <span class="comment"></span>
01071 <span class="comment">    KiIA32InterruptionVectorHandler</span>
01072 <span class="comment"></span>
01073 <span class="comment">    Called by first label KiIA32InterruptionVector() to handle further iA32 </span>
01074 <span class="comment">    interruption processing. Only get here on INT xx instructions</span>
01075 <span class="comment">   </span>
01076 <span class="comment">Arguments:</span>
01077 <span class="comment"></span>
01078 <span class="comment">    Frame - iA32 TrapFrame that was saved in the memory stack</span>
01079 <span class="comment"></span>
01080 <span class="comment">Return Value:</span>
01081 <span class="comment">    TRUE - go to dispatch exception</span>
01082 <span class="comment">    FALSE - Exception was handled, do an RFI</span>
01083 <span class="comment"></span>
01084 <span class="comment">--*/</span>
01085 {
01086 <span class="preprocessor">#if defined(IADBG)</span>
01087 <span class="preprocessor"></span>    <a class="code" href="../../d8/d3/ia32def_8h.html#a129">IF_IA32TRAP_DEBUG</a>( INTERRUPTION )
01088        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IA32 Interruption: ISRVector %x Frame %x\n"</span>, <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame), Frame);
01089 <span class="preprocessor">#endif // IADBG</span>
01090 <span class="preprocessor"></span>
01091     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> == Frame-&gt;PreviousMode);
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">// Follow the ia32 way of INT xx as an Access Violation</span>
01095     <span class="comment">//</span>
01096     <span class="comment">// INT 3 should be handled via a debug exception and should</span>
01097     <span class="comment">// never get here...</span>
01098     <span class="comment">//</span>
01099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(3 != <a class="code" href="../../d8/d3/ia32def_8h.html#a128">ISRVector</a>(Frame));
01100     
01101     <a class="code" href="../../d0/d4/ia32trap_8c.html#a4">KiIA32CommonArgs</a>(Frame,
01102                      STATUS_ACCESS_VIOLATION,
01103                      (PVOID) <a class="code" href="../../d8/d3/ia32def_8h.html#a123">EIP</a>(Frame),
01104                      0, 0, 0);
01105     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01106 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
