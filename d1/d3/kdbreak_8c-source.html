<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdbreak.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdbreak.c</h1><a href="../../d0/d4/kdbreak_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    kdbreak.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements machine dependent functions to add and delete</span>
00012 <span class="comment">    breakpoints from the kernel debugger breakpoint table.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler 2-Aug-1990</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d7/kdp_8h.html">kdp.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">// Define external references.</span>
00026 <span class="comment">//</span>
00027 
00028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00029 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>(
00030     VOID
00031     );
00032 
00033 BOOLEAN
00034 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(
00035     ULONG Index
00036     );
00037 
00038 BOOLEAN
00039 <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(
00040     ULONG Index
00041     );
00042 
00043 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpAddBreakpoint)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpDeleteBreakpoint)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpDeleteBreakpointRange)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendBreakpoint)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendAllBreakpoints)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpRestoreAllBreakpoints)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpLowWriteContent)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpLowRestoreBreakpoint)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#if defined(_IA64_)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpSuspendBreakpointRange)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEKD, KdpRestoreBreakpointRange)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>
00058 
00059 ULONG
<a name="l00060"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a104">00060</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a104">KdpAddBreakpoint</a> (
00061     IN PVOID Address
00062     )
00063 
00064 <span class="comment">/*++</span>
00065 <span class="comment"></span>
00066 <span class="comment">Routine Description:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    This routine adds an entry to the breakpoint table and returns a handle</span>
00069 <span class="comment">    to the breakpoint table entry.</span>
00070 <span class="comment"></span>
00071 <span class="comment">Arguments:</span>
00072 <span class="comment"></span>
00073 <span class="comment">    Address - Supplies the address where to set the breakpoint.</span>
00074 <span class="comment"></span>
00075 <span class="comment">Return Value:</span>
00076 <span class="comment"></span>
00077 <span class="comment">    A value of zero is returned if the specified address is already in the</span>
00078 <span class="comment">    breakpoint table, there are no free entries in the breakpoint table, the</span>
00079 <span class="comment">    specified address is not correctly aligned, or the specified address is</span>
00080 <span class="comment">    not valid. Otherwise, the index of the assigned breakpoint table entry</span>
00081 <span class="comment">    plus one is returned as the function value.</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086 
00087     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
00088     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00089     BOOLEAN Accessible;
00090     ULONG_PTR Opaque;
00091 
00092     <span class="comment">//DPRINT(("KD: Setting breakpoint at 0x%08x\n", Address));</span>
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">// If the specified address is not properly aligned, then return zero.</span>
00096     <span class="comment">//</span>
00097 
00098     <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a5">KDP_BREAKPOINT_ALIGN</a>) != 0) {
00099         <span class="keywordflow">return</span> 0;
00100     }
00101 
00102 
00103     <span class="comment">//</span>
00104     <span class="comment">// Don't allow setting the same breakpoint twice.</span>
00105     <span class="comment">//</span>
00106 
00107     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00108         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) != 0 &amp;&amp;
00109             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> == Address) {
00110 
00111             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) != 0) {
00112 
00113                 <span class="comment">//</span>
00114                 <span class="comment">// Breakpoint was set, the page was written out and was not</span>
00115                 <span class="comment">// accessible when the breakpoint was cleared.  Now the breakpoint</span>
00116                 <span class="comment">// is being set again.  Just clear the defer flag:</span>
00117                 <span class="comment">//</span>
00118                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00119                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
00120 
00121             } <span class="keywordflow">else</span> {
00122 
00123                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: Attempt to set breakpoint %08x twice!\n"</span>, Address));
00124                 <span class="keywordflow">return</span> 0;
00125 
00126             }
00127         }
00128     }
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Search the breakpoint table for a free entry.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00135         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> == 0) {
00136             <span class="keywordflow">break</span>;
00137         }
00138     }
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">// If a free entry was found, then write breakpoint and return the handle</span>
00142     <span class="comment">// value plus one. Otherwise, return zero.</span>
00143     <span class="comment">//</span>
00144 
00145     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == BREAKPOINT_TABLE_SIZE) {
00146         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: ran out of breakpoints!\n"</span>));
00147         <span class="keywordflow">return</span> 0;
00148     }
00149 
00150 
00151     <span class="comment">//DPRINT(("KD: using Index %d\n", Index));</span>
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Get the instruction to be replaced. If the instruction cannot be read,</span>
00155     <span class="comment">// then mark breakpoint as not accessible.</span>
00156     <span class="comment">//</span>
00157 
00158     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00159             (PCHAR)&amp;Content,
00160             (PCHAR)Address,
00161             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00162         Accessible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163         <span class="comment">//DPRINT(("KD: memory inaccessible\n"));</span>
00164     } <span class="keywordflow">else</span> {
00165         <span class="comment">//DPRINT(("KD: memory readable...\n"));</span>
00166         Accessible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">// If the specified address is not write accessible, then return zero.</span>
00171     <span class="comment">//</span>
00172 
00173     <span class="keywordflow">if</span> (Accessible) {
00174         <span class="keywordflow">if</span>  (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a>((PVOID)Address, &amp;Opaque) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175             <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>((PVOID)Address, Opaque);
00176         } <span class="keywordflow">else</span> {
00177             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: memory not writable!\n"</span>));
00178             <span class="keywordflow">return</span> 0;
00179         }
00180     }
00181 
00182 <span class="preprocessor">#if defined(_IA64_)</span>
00183 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( Accessible ) {
00184         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00185         PVOID BundleAddress;
00186 
00187         <span class="comment">// change template to type 0 if current instruction is MLI</span>
00188 
00189         <span class="comment">// read in intruction template if current instruction is NOT slot 0.</span>
00190         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
00191         <span class="comment">// set break in slot 2 of MLI template.</span>
00192 
00193         <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; 0xf) != 0) {
00194             (ULONG_PTR)BundleAddress = (ULONG_PTR)Address &amp; ~(0xf);
00195             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00196                     (PCHAR)&amp;mBuf,
00197                     (PCHAR)BundleAddress,
00198                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00199                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00200                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read 0x%08x template failed\n"</span>, BundleAddress));
00201                 <span class="keywordflow">return</span> 0;
00202             } <span class="keywordflow">else</span> {
00203                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
00204                     <span class="keywordflow">if</span> (((ULONG_PTR)Address &amp; 0xf) == 4) {
00205                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
00206                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
00207                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
00208                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00209                                 (PCHAR)BundleAddress,
00210                                 (PCHAR)&amp;mBuf,
00211                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00212                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00213                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x template failed\n"</span>, BundleAddress));
00214                             <span class="keywordflow">return</span> 0;
00215                          }
00216                          <span class="keywordflow">else</span> {
00217                              <span class="comment">//DPRINT(("KD: change MLI template to type 0 at 0x%08x set\n", Address));</span>
00218                          }
00219                     } <span class="keywordflow">else</span> {
00220                          <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
00221                          <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal to set BP at slot 2 of MOVL at 0x%08x\n"</span>, BundleAddress));
00222                          <span class="keywordflow">return</span> 0;
00223                     }
00224                 }
00225             }
00226         }
00227 
00228         <span class="comment">// insert break instruction</span>
00229 
00230         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00231         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00232         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00233         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00234         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00235             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00236                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00237             }
00238             <span class="keywordflow">switch</span> ((ULONG_PTR)Address &amp; 0xf) {
00239             <span class="keywordflow">case</span> 0:
00240                 Content = (Content &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
00241                 <span class="keywordflow">break</span>;
00242 
00243             <span class="keywordflow">case</span> 4:
00244                 Content = (Content &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
00245                 <span class="keywordflow">break</span>;
00246 
00247             <span class="keywordflow">case</span> 8:
00248                 Content = (Content &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
00249                 <span class="keywordflow">break</span>;
00250 
00251             <span class="keywordflow">default</span>:
00252                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpAddBreakpoint bad instruction slot#\n"</span>));
00253                 <span class="keywordflow">return</span> 0;
00254             }
00255             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00256                     (PCHAR)Address,
00257                     (PCHAR)&amp;Content,
00258                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00259                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00260 
00261                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpMoveMemory failed writing BP!\n"</span>));
00262                 <span class="keywordflow">return</span> 0;
00263             }
00264             <span class="keywordflow">else</span> {
00265                 <span class="comment">//DPRINT(("KD: breakpoint at 0x%08x set\n", Address));</span>
00266             }
00267 
00268     } <span class="keywordflow">else</span> {  <span class="comment">// memory not accessible</span>
00269         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00270         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00271         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00272         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00273         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00274         <span class="comment">//DPRINT(("KD: breakpoint write deferred\n"));</span>
00275         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00276             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00277                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00278         }
00279     }
00280 <span class="preprocessor">#else</span>
00281 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( Accessible ) {
00282         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00283         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00284         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00285         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00286             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00287                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00288         }
00289         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00290                 (PCHAR)Address,
00291                 (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>,
00292                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00293                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00294 
00295             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpMoveMemory failed writing BP!\n"</span>));
00296         }
00297     } <span class="keywordflow">else</span> {
00298         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = Address;
00299         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00300         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00301         <span class="comment">//DPRINT(("KD: breakpoint write deferred\n"));</span>
00302         <span class="keywordflow">if</span> (Address &lt; (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) {
00303             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> =
00304                 <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0];
00305         }
00306     }
00307 <span class="preprocessor">#endif  // IA64</span>
00308 <span class="preprocessor"></span>
00309     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
00310 
00311 }
00312 
00313 
00314 
00315 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00316"></a><a class="code" href="../../d7/d3/kd_8h.html#a21">00316</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a0">KdSetOwedBreakpoints</a>(
00317     VOID
00318     )
00319 
00320 <span class="comment">/*++</span>
00321 <span class="comment"></span>
00322 <span class="comment">Routine Description:</span>
00323 <span class="comment"></span>
00324 <span class="comment">    This function is called after returning from memory management calls</span>
00325 <span class="comment">    that may cause an inpage.  Its purpose is to store pending</span>
00326 <span class="comment">    breakpoints in pages just made valid.</span>
00327 <span class="comment"></span>
00328 <span class="comment">Arguments:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    None.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Return Value:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    None.</span>
00335 <span class="comment"></span>
00336 <span class="comment">--*/</span>
00337 
00338 {
00339 
00340     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
00341     BOOLEAN Enable;
00342     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00343     ULONG_PTR Opaque;
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">// If we don't owe any breakpoints then return</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> ) {
00350         <span class="keywordflow">return</span>;
00351     }
00352 
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// Freeze all other processors, disable interrupts, and save debug</span>
00356     <span class="comment">// port state.</span>
00357     <span class="comment">//</span>
00358 
00359     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00360     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// Search the breakpoint table for breakpoints that need to be</span>
00364     <span class="comment">// written or replaced.</span>
00365     <span class="comment">//</span>
00366 
00367     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00368         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;
00369                 (<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) ) {
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// Breakpoint needs to be written</span>
00373             <span class="comment">//</span>
00374             <span class="comment">//DPRINT(("KD: Breakpoint %d at 0x%08x: trying to %s after page in.\n",</span>
00375             <span class="comment">//    Index,</span>
00376             <span class="comment">//    KdpBreakpointTable[Index].Address,</span>
00377             <span class="comment">//    (KdpBreakpointTable[Index].Flags &amp; KD_BREAKPOINT_NEEDS_WRITE) ?</span>
00378             <span class="comment">//        "set" : "clear"));</span>
00379 
00380             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= (PVOID)<a class="code" href="../../d0/d7/kdp_8h.html#a0">GLOBAL_BREAKPOINT_LIMIT</a>) ||
00381                 (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> ==
00382                  <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;DirectoryTableBase[0])) {
00383 
00384                 <span class="comment">//</span>
00385                 <span class="comment">// Check to see if we have write access to the memory</span>
00386                 <span class="comment">//</span>
00387                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/ppc_2debugsup_8c.html#a1">MmDbgWriteCheck</a>((PVOID)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,                                       &amp;Opaque) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00388                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00389                     <span class="comment">//DPRINT(("KD: address not writeable.\n"));</span>
00390                     <span class="keywordflow">break</span>;
00391                 }
00392 
00393                 <a class="code" href="../../d2/d6/ia64_2debugsup_8c.html#a2">MmDbgReleaseAddress</a>(
00394                         (PVOID)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00395                         Opaque
00396                         );
00397 
00398                 <span class="comment">//</span>
00399                 <span class="comment">// Breakpoint is global, or its directory base matches</span>
00400                 <span class="comment">//</span>
00401 
00402                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00403                         (PCHAR)&amp;Content,
00404                         (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00405                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00406                         ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00407 
00408                     <span class="comment">//</span>
00409                     <span class="comment">// Memory is still inaccessible (is this possible after</span>
00410                     <span class="comment">// the call above to MmDbgWriteCheck?)</span>
00411                     <span class="comment">//</span>
00412 
00413                     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read from 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00414 
00415                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00416 
00417                 } <span class="keywordflow">else</span> {
00418                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>) {
00419                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> = Content;
00420 <span class="preprocessor">#if defined(_IA64_)</span>
00421 <span class="preprocessor"></span>                        <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00422                         <span class="keywordflow">case</span> 0:
00423                             Content = (Content &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
00424                             <span class="keywordflow">break</span>;
00425 
00426                         <span class="keywordflow">case</span> 4:
00427                             Content = (Content &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
00428                             <span class="keywordflow">break</span>;
00429 
00430                         <span class="keywordflow">case</span> 8:
00431                             Content = (Content &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
00432                             <span class="keywordflow">break</span>;
00433 
00434                         <span class="keywordflow">default</span>:
00435                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal instruction address 0x%08x\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00436                             <span class="keywordflow">return</span>;
00437                         }
00438                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00439                                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00440                                 (PCHAR)&amp;Content,
00441                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00442                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00443                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00445                         }
00446 
00447                         <span class="comment">// read in intruction template if current instruction is NOT slot 0.</span>
00448                         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
00449                         <span class="comment">// set break in slot 2 of MLI template.</span>
00450 
00451                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) != 0) {
00452                             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00453                             PVOID BundleAddress;
00454 
00455                             (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a>  &amp; ~(0xf);
00456                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00457                                     (PCHAR)&amp;mBuf,
00458                                     (PCHAR)BundleAddress,
00459                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00460                                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00461                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462                                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read 0x%08x template failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00463                             } <span class="keywordflow">else</span> {
00464                                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
00465                                     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a>  &amp; 0xf) == 4) {
00466                                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
00467                                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
00468                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
00469                                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00470                                             (PCHAR)BundleAddress,
00471                                             (PCHAR)&amp;mBuf,
00472                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00473                                             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00474                                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475                                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x template failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00476                                         }
00477                                         <span class="keywordflow">else</span> {
00478                                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00479                                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00480                                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00481                                         }
00482                                     } <span class="keywordflow">else</span> {
00483                                         <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
00484                                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00485                                         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal attempt to set BP at slot 2 of 0x%08x\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00486                                     }
00487                                 }
00488                                 <span class="keywordflow">else</span> {
00489                                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~(<a class="code" href="../../d0/d7/kdp_8h.html#a5">KD_BREAKPOINT_STATE_MASK</a>);
00490                                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00491                                     <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00492                                 }
00493                             }
00494                         }
00495 <span class="preprocessor">#else</span>
00496 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00497                                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00498                                 (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>,
00499                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00500                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00501                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00502                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00503                         } <span class="keywordflow">else</span> {
00504                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00505                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x ok\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00506                         }
00507 <span class="preprocessor">#endif</span>
00508 <span class="preprocessor"></span>                    } <span class="keywordflow">else</span> {
00509 <span class="preprocessor">#if defined(_IA64_)</span>
00510 <span class="preprocessor"></span>
00511                         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00512                         PVOID BundleAddress;
00513 
00514                         <span class="comment">// restore original instruction content</span>
00515 
00516                         <span class="comment">// Read in memory since adjancent instructions in the same bundle may have</span>
00517                         <span class="comment">// been modified after we save them.</span>
00518                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00519                                 (PCHAR)&amp;mBuf,
00520                                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00521                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00522                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00523                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read 0x%08x template failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00524                         }
00525                         <span class="keywordflow">else</span> {
00526                             <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00527                             <span class="keywordflow">case</span> 0:
00528                                 mBuf = (mBuf &amp; ~(INST_SLOT0_MASK))
00529                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT0_MASK);
00530                                 <span class="keywordflow">break</span>;
00531 
00532                             <span class="keywordflow">case</span> 4:
00533                                 mBuf = (mBuf &amp; ~(INST_SLOT1_MASK))
00534                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT1_MASK);
00535                                 <span class="keywordflow">break</span>;
00536 
00537                             <span class="keywordflow">case</span> 8:
00538                                 mBuf = (mBuf &amp; ~(INST_SLOT2_MASK))
00539                                              | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT2_MASK);
00540                                 <span class="keywordflow">break</span>;
00541 
00542                             <span class="keywordflow">default</span>:
00543                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00544                                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal instruction address 0x%08x\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00545                             }
00546 
00547                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00548                                     (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00549                                     (PCHAR)&amp;mBuf,
00550                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00551                                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00552                                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00553                             }
00554                             <span class="keywordflow">else</span> {
00555                                  <span class="comment">// restore template to MLI if displaced instruction was MOVL</span>
00556 
00557                                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>) {
00558                                     (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; ~(0xf);
00559                                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00560                                             (PCHAR)&amp;mBuf,
00561                                             (PCHAR)BundleAddress,
00562                                             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00563                                             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00564                                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00565                                         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read template 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00566                                     }
00567                                     <span class="keywordflow">else</span> {
00568                                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1); <span class="comment">// set template to MLI</span>
00569                                         mBuf |= 0x4;
00570 
00571                                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00572                                               (PCHAR)BundleAddress,
00573                                               (PCHAR)&amp;mBuf,
00574                                               <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00575                                               ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00576                                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00577                                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write template to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00578                                         } <span class="keywordflow">else</span> {
00579                                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00580                                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00581                                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= (<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>);
00582                                             } <span class="keywordflow">else</span> {
00583                                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00584                                             }
00585                                         }
00586                                     }
00587                                 } <span class="keywordflow">else</span> {
00588                                     <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00589                                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00590                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= (<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>);
00591                                     } <span class="keywordflow">else</span> {
00592                                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00593                                     }
00594                                 }
00595                             }
00596                         }
00597 <span class="preprocessor">#else</span>
00598 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00599                                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00600                                 (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Content,
00601                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00602                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00603                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00604                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00605                         } <span class="keywordflow">else</span> {
00606                             <span class="comment">//DPRINT(("KD: write to 0x%08x ok\n", KdpBreakpointTable[Index].Address));</span>
00607                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00608                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a> | <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>;
00609                             } <span class="keywordflow">else</span> {
00610                                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00611                             }
00612                         }
00613 <span class="preprocessor">#endif // _IA64_</span>
00614 <span class="preprocessor"></span>
00615                     }
00616                 }
00617 
00618             } <span class="keywordflow">else</span> {
00619 
00620                 <span class="comment">//</span>
00621                 <span class="comment">// Breakpoint is local and its directory base does not match</span>
00622                 <span class="comment">//</span>
00623 
00624                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00625             }
00626         }
00627     }
00628 
00629     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00630     <span class="keywordflow">return</span>;
00631 }
00632 
00633 
00634 BOOLEAN
<a name="l00635"></a><a class="code" href="../../d0/d4/kdbreak_8c.html#a4">00635</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a> (
00636     IN ULONG Index
00637     )
00638 
00639 <span class="comment">/*++</span>
00640 <span class="comment"></span>
00641 <span class="comment">Routine Description:</span>
00642 <span class="comment"></span>
00643 <span class="comment">    This routine attempts to replace the code that a breakpoint is</span>
00644 <span class="comment">    written over.  This routine, KdpAddBreakpoint,</span>
00645 <span class="comment">    KdpLowRestoreBreakpoint and KdSetOwedBreakpoints are responsible</span>
00646 <span class="comment">    for getting data written as requested.  Callers should not</span>
00647 <span class="comment">    examine or use KdpOweBreakpoints, and they should not set the</span>
00648 <span class="comment">    NEEDS_WRITE or NEEDS_REPLACE flags.</span>
00649 <span class="comment"></span>
00650 <span class="comment">    Callers must still look at the return value from this function,</span>
00651 <span class="comment">    however: if it returns FALSE, the breakpoint record must not be</span>
00652 <span class="comment">    reused until KdSetOwedBreakpoints has finished with it.</span>
00653 <span class="comment"></span>
00654 <span class="comment">Arguments:</span>
00655 <span class="comment"></span>
00656 <span class="comment">    Index - Supplies the index of the breakpoint table entry</span>
00657 <span class="comment">        which is to be deleted.</span>
00658 <span class="comment"></span>
00659 <span class="comment">Return Value:</span>
00660 <span class="comment"></span>
00661 <span class="comment">    Returns TRUE if the breakpoint was removed, FALSE if it was deferred.</span>
00662 <span class="comment"></span>
00663 <span class="comment">--*/</span>
00664 
00665 {
00666 <span class="preprocessor">#if defined(_IA64_)</span>
00667 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
00668     PVOID BundleAddress;
00669 <span class="preprocessor">#endif</span>
00670 <span class="preprocessor"></span>
00671     <span class="comment">//</span>
00672     <span class="comment">// Do the contents need to be replaced at all?</span>
00673     <span class="comment">//</span>
00674 
00675     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>) {
00676 
00677         <span class="comment">//</span>
00678         <span class="comment">// The breakpoint was never written out.  Clear the flag</span>
00679         <span class="comment">// and we are done.</span>
00680         <span class="comment">//</span>
00681 
00682         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
00683         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x never written; flag cleared.\n",</span>
00684         <span class="comment">//    KdpBreakpointTable[Index].Address));</span>
00685         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00686     }
00687 
00688 <span class="preprocessor">#if !defined(_IA64_)</span>
00689 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
00690 
00691         <span class="comment">//</span>
00692         <span class="comment">// The instruction is a breakpoint anyway.</span>
00693         <span class="comment">//</span>
00694 
00695         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x; instr is really BP; flag cleared.\n",</span>
00696         <span class="comment">//    KdpBreakpointTable[Index].Address));</span>
00697 
00698         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00699     }
00700 <span class="preprocessor">#endif</span>
00701 <span class="preprocessor"></span>
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">// Restore the instruction contents.</span>
00705     <span class="comment">//</span>
00706 
00707 <span class="preprocessor">#if defined(_IA64_)</span>
00708 <span class="preprocessor"></span>    <span class="comment">// Read in memory since adjancent instructions in the same bundle may have</span>
00709     <span class="comment">// been modified after we save them.</span>
00710     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00711             (PCHAR)&amp;mBuf,
00712             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00713             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00714         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00715         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00716         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00717         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00718     }
00719     <span class="keywordflow">else</span> {
00720 
00721         <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
00722         <span class="keywordflow">case</span> 0:
00723             mBuf = (mBuf &amp; ~(INST_SLOT0_MASK))
00724                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT0_MASK);
00725             <span class="keywordflow">break</span>;
00726 
00727         <span class="keywordflow">case</span> 4:
00728             mBuf = (mBuf &amp; ~(INST_SLOT1_MASK))
00729                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT1_MASK);
00730             <span class="keywordflow">break</span>;
00731 
00732         <span class="keywordflow">case</span> 8:
00733             mBuf = (mBuf &amp; ~(INST_SLOT2_MASK))
00734                          | (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> &amp; INST_SLOT2_MASK);
00735             <span class="keywordflow">break</span>;
00736 
00737         <span class="keywordflow">default</span>:
00738             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00739             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal instruction address 0x%08x\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00740             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00741         }
00742 
00743         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00744                 (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00745                 (PCHAR)&amp;mBuf,
00746                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00747             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00748             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00749             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00750             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00751         }
00752         <span class="keywordflow">else</span> {
00753 <span class="preprocessor">#ifdef _GAMBIT_</span>
00754 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00755                     (PCHAR)&amp;mBuf,
00756                     (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00757                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) == <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00758                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"\tcontent after memory move = 0x%08x 0x%08x\n"</span>, (ULONG)(mBuf &gt;&gt; 32), (ULONG)mBuf));
00759             }
00760 <span class="preprocessor">#endif // _GAMBIT_</span>
00761 <span class="preprocessor"></span>
00762 
00763              <span class="comment">// restore template to MLI if displaced instruction was MOVL</span>
00764 
00765             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>) {
00766                 (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; ~(0xf);
00767                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00768                         (PCHAR)&amp;mBuf,
00769                         (PCHAR)BundleAddress,
00770                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00771                         ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00772                     <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00773                     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read template 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00774                     <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00775                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00776                 }
00777                 <span class="keywordflow">else</span> {
00778                     mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1); <span class="comment">// set template to MLI</span>
00779                     mBuf |= 0x4;
00780 
00781                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
00782                           (PCHAR)BundleAddress,
00783                           (PCHAR)&amp;mBuf,
00784                           <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
00785                           ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00786                         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00787                         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write template to 0x%08x failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
00788                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00789                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00790                     } <span class="keywordflow">else</span> {
00791                         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00792                          <span class="comment">//   KdpBreakpointTable[Index].Address));</span>
00793                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00794                     }
00795                 }
00796             }
00797             <span class="keywordflow">else</span> {   <span class="comment">// not MOVL</span>
00798                 <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00799                  <span class="comment">//  KdpBreakpointTable[Index].Address));</span>
00800                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00801             }
00802         }
00803     }
00804 <span class="preprocessor">#else</span>
00805 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>( (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
00806                         (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Content,
00807                         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
00808 
00809         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00810         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
00811         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x; unable to clear, flag set.\n",</span>
00812             <span class="comment">//KdpBreakpointTable[Index].Address));</span>
00813         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00814     } <span class="keywordflow">else</span> {
00815         <span class="comment">//DPRINT(("KD: Breakpoint at 0x%08x cleared.\n",</span>
00816             <span class="comment">//KdpBreakpointTable[Index].Address));</span>
00817         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00818     }
00819 <span class="preprocessor">#endif</span>
00820 <span class="preprocessor"></span>
00821 }
00822 
00823 
00824 
00825 BOOLEAN
<a name="l00826"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">00826</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a> (
00827     IN ULONG Handle
00828     )
00829 
00830 <span class="comment">/*++</span>
00831 <span class="comment"></span>
00832 <span class="comment">Routine Description:</span>
00833 <span class="comment"></span>
00834 <span class="comment">    This routine deletes an entry from the breakpoint table.</span>
00835 <span class="comment"></span>
00836 <span class="comment">Arguments:</span>
00837 <span class="comment"></span>
00838 <span class="comment">    Handle - Supplies the index plus one of the breakpoint table entry</span>
00839 <span class="comment">        which is to be deleted.</span>
00840 <span class="comment"></span>
00841 <span class="comment">Return Value:</span>
00842 <span class="comment"></span>
00843 <span class="comment">    A value of FALSE is returned if the specified handle is not a valid</span>
00844 <span class="comment">    value or the breakpoint cannot be deleted because the old instruction</span>
00845 <span class="comment">    cannot be replaced. Otherwise, a value of TRUE is returned.</span>
00846 <span class="comment"></span>
00847 <span class="comment">--*/</span>
00848 
00849 {
00850     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - 1;
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">// If the specified handle is not valid, then return FALSE.</span>
00854     <span class="comment">//</span>
00855 
00856     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == 0) || (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &gt; BREAKPOINT_TABLE_SIZE)) {
00857         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: Breakpoint %d invalid.\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>));
00858         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00859     }
00860 
00861     <span class="comment">//</span>
00862     <span class="comment">// If the specified breakpoint table entry is not valid, then return FALSE.</span>
00863     <span class="comment">//</span>
00864 
00865     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> == 0) {
00866         <span class="comment">//DPRINT(("KD: Breakpoint %d already clear.\n", Index));</span>
00867         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00868     }
00869 
00870     <span class="comment">//</span>
00871     <span class="comment">// If the breakpoint is already suspended, just delete it from the table.</span>
00872     <span class="comment">//</span>
00873 
00874     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
00875         <span class="comment">//DPRINT(("KD: Deleting suspended breakpoint %d \n", Index));</span>
00876         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) ) {
00877             <span class="comment">//DPRINT(("KD: already clear.\n"));</span>
00878             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00879             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00880         }
00881     }
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">// Replace the instruction contents.</span>
00885     <span class="comment">//</span>
00886 
00887     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>)) {
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Delete breakpoint table entry</span>
00891         <span class="comment">//</span>
00892 
00893         <span class="comment">//DPRINT(("KD: Breakpoint %d deleted successfully.\n", Index));</span>
00894         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00895     }
00896 
00897     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00898 }
00899 
00900 
00901 BOOLEAN
<a name="l00902"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">00902</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a106">KdpDeleteBreakpointRange</a> (
00903     IN PVOID Lower,
00904     IN PVOID Upper
00905     )
00906 
00907 <span class="comment">/*++</span>
00908 <span class="comment"></span>
00909 <span class="comment">Routine Description:</span>
00910 <span class="comment"></span>
00911 <span class="comment">    This routine deletes all breakpoints falling in a given range</span>
00912 <span class="comment">    from the breakpoint table.</span>
00913 <span class="comment"></span>
00914 <span class="comment">Arguments:</span>
00915 <span class="comment"></span>
00916 <span class="comment">    Lower - inclusive lower address of range from which to remove BPs.</span>
00917 <span class="comment"></span>
00918 <span class="comment">    Upper - include upper address of range from which to remove BPs.</span>
00919 <span class="comment"></span>
00920 <span class="comment">Return Value:</span>
00921 <span class="comment"></span>
00922 <span class="comment">    TRUE if any breakpoints removed, FALSE otherwise.</span>
00923 <span class="comment"></span>
00924 <span class="comment">--*/</span>
00925 
00926 {
00927     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00928     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">// Examine each entry in the table in turn</span>
00932     <span class="comment">//</span>
00933 
00934     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
00935 
00936         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
00937              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
00938               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
00939            ) {
00940 
00941             <span class="comment">//</span>
00942             <span class="comment">// Breakpoint is in use and falls in range, clear it.</span>
00943             <span class="comment">//</span>
00944 
00945             ReturnStatus = ReturnStatus || <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1);
00946         }
00947     }
00948 
00949     <span class="keywordflow">return</span> ReturnStatus;
00950 
00951 }
00952 
00953 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00954"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">00954</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a> (
00955     ULONG Handle
00956     )
00957 {
00958     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - 1;
00959 
00960     <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
00961         !(<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) ) {
00962 
00963         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
00964         <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a4">KdpLowWriteContent</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00965     }
00966 
00967     <span class="keywordflow">return</span>;
00968 
00969 } <span class="comment">// KdpSuspendBreakpoint</span>
00970 
00971 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00972"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a139">00972</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a139">KdpSuspendAllBreakpoints</a> (
00973     VOID
00974     )
00975 {
00976     ULONG <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00977 
00978     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00979 
00980     <span class="keywordflow">for</span> ( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 1; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt;= BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>++ ) {
00981         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00982     }
00983 
00984     <span class="keywordflow">return</span>;
00985 
00986 } <span class="comment">// KdpSuspendAllBreakpoints</span>
00987 
00988 <span class="preprocessor">#if defined(_IA64_)</span>
00989 <span class="preprocessor"></span>
00990 
00991 BOOLEAN
00992 KdpSuspendBreakpointRange (
00993     IN PVOID Lower,
00994     IN PVOID Upper
00995     )
00996 
00997 <span class="comment">/*++</span>
00998 <span class="comment"></span>
00999 <span class="comment">Routine Description:</span>
01000 <span class="comment"></span>
01001 <span class="comment">    This routine suspend all breakpoints falling in a given range</span>
01002 <span class="comment">    from the breakpoint table.</span>
01003 <span class="comment"></span>
01004 <span class="comment">Arguments:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    Lower - inclusive lower address of range from which to suspend BPs.</span>
01007 <span class="comment"></span>
01008 <span class="comment">    Upper - include upper address of range from which to suspend BPs.</span>
01009 <span class="comment"></span>
01010 <span class="comment">Return Value:</span>
01011 <span class="comment"></span>
01012 <span class="comment">    TRUE if any breakpoints suspended, FALSE otherwise.</span>
01013 <span class="comment"></span>
01014 <span class="comment">Notes:</span>
01015 <span class="comment">    The order of suspending breakpoints is opposite that of setting</span>
01016 <span class="comment">    them in KdpAddBreakpoint() in case of duplicate addresses.</span>
01017 <span class="comment"></span>
01018 <span class="comment">--*/</span>
01019 
01020 {
01021     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01022     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01023 
01024     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"\nKD: entering KdpSuspendBreakpointRange() at 0x%08x 0x%08x\n"</span>, Lower, Upper));
01025 
01026     <span class="comment">//</span>
01027     <span class="comment">// Examine each entry in the table in turn</span>
01028     <span class="comment">//</span>
01029 
01030     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = BREAKPOINT_TABLE_SIZE - 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != -1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--) {
01031 
01032         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01033              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
01034               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
01035            ) {
01036 
01037             <span class="comment">//</span>
01038             <span class="comment">// Breakpoint is in use and falls in range, suspend it.</span>
01039             <span class="comment">//</span>
01040 
01041             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a138">KdpSuspendBreakpoint</a>(Index+1);
01042             ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01043         }
01044     }
01045     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: exiting KdpSuspendBreakpointRange() return 0x%d\n"</span>, ReturnStatus));
01046 
01047     <span class="keywordflow">return</span> ReturnStatus;
01048 
01049 } <span class="comment">// KdpSuspendBreakpointRange</span>
01050 
01051 
01052 
01053 BOOLEAN
01054 KdpRestoreBreakpointRange (
01055     IN PVOID Lower,
01056     IN PVOID Upper
01057     )
01058 
01059 <span class="comment">/*++</span>
01060 <span class="comment"></span>
01061 <span class="comment">Routine Description:</span>
01062 <span class="comment"></span>
01063 <span class="comment">    This routine writes back breakpoints falling in a given range</span>
01064 <span class="comment">    from the breakpoint table.</span>
01065 <span class="comment"></span>
01066 <span class="comment">Arguments:</span>
01067 <span class="comment"></span>
01068 <span class="comment">    Lower - inclusive lower address of range from which to rewrite BPs.</span>
01069 <span class="comment"></span>
01070 <span class="comment">    Upper - include upper address of range from which to rewrite BPs.</span>
01071 <span class="comment"></span>
01072 <span class="comment">Return Value:</span>
01073 <span class="comment"></span>
01074 <span class="comment">    TRUE if any breakpoints written, FALSE otherwise.</span>
01075 <span class="comment"></span>
01076 <span class="comment">Notes:</span>
01077 <span class="comment">    The order of writing breakpoints is opposite that of removing</span>
01078 <span class="comment">    them in KdpSuspendBreakpointRange() in case of duplicate addresses.</span>
01079 <span class="comment"></span>
01080 <span class="comment">--*/</span>
01081 
01082 {
01083     ULONG   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01084     BOOLEAN ReturnStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01085 
01086     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"\nKD: entering KdpRestoreBreakpointRange() at 0x%08x 0x%08x\n"</span>, Lower, Upper));
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">// Examine each entry in the table in turn</span>
01090     <span class="comment">//</span>
01091 
01092     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
01093 
01094         <span class="keywordflow">if</span> ( (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01095              ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &gt;= Lower) &amp;&amp;
01096               (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &lt;= Upper))
01097            ) {
01098 
01099             <span class="comment">//</span>
01100             <span class="comment">// suspended breakpoint that falls in range, unsuspend it.</span>
01101             <span class="comment">//</span>
01102 
01103             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) {
01104 
01105                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
01106                 ReturnStatus = ReturnStatus || <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(Index);
01107             }
01108         }
01109     }
01110 
01111     <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: exiting KdpRestoreBreakpointRange() return 0x%d\n"</span>, ReturnStatus));
01112 
01113     <span class="keywordflow">return</span> ReturnStatus;
01114 
01115 } <span class="comment">// KdpRestoreBreakpointRange</span>
01116 
01117 <span class="preprocessor">#endif // _IA64_</span>
01118 <span class="preprocessor"></span>
01119 
01120 BOOLEAN
<a name="l01121"></a><a class="code" href="../../d0/d4/kdbreak_8c.html#a9">01121</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a> (
01122     IN ULONG Index
01123     )
01124 
01125 <span class="comment">/*++</span>
01126 <span class="comment"></span>
01127 <span class="comment">Routine Description:</span>
01128 <span class="comment"></span>
01129 <span class="comment">    This routine attempts to write a breakpoint instruction.</span>
01130 <span class="comment">    The old contents must have already been stored in the</span>
01131 <span class="comment">    breakpoint record.</span>
01132 <span class="comment"></span>
01133 <span class="comment">Arguments:</span>
01134 <span class="comment"></span>
01135 <span class="comment">    Index - Supplies the index of the breakpoint table entry</span>
01136 <span class="comment">        which is to be written.</span>
01137 <span class="comment"></span>
01138 <span class="comment">Return Value:</span>
01139 <span class="comment"></span>
01140 <span class="comment">    Returns TRUE if the breakpoint was written, FALSE if it was</span>
01141 <span class="comment">    not and has been marked for writing later.</span>
01142 <span class="comment"></span>
01143 <span class="comment">--*/</span>
01144 
01145 {
01146     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> Content;
01147 
01148 <span class="preprocessor">#if defined(_IA64_)</span>
01149 <span class="preprocessor"></span>    <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a> mBuf;
01150     PVOID BundleAddress;
01151 <span class="preprocessor">#endif</span>
01152 <span class="preprocessor"></span>    <span class="comment">//</span>
01153     <span class="comment">// Does the breakpoint need to be written at all?</span>
01154     <span class="comment">//</span>
01155 
01156     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>) {
01157 
01158         <span class="comment">//</span>
01159         <span class="comment">// The breakpoint was never removed.  Clear the flag</span>
01160         <span class="comment">// and we are done.</span>
01161         <span class="comment">//</span>
01162 
01163         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a4">KD_BREAKPOINT_NEEDS_REPLACE</a>;
01164         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01165     }
01166 
01167     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
01168 
01169         <span class="comment">//</span>
01170         <span class="comment">// The instruction is a breakpoint anyway.</span>
01171         <span class="comment">//</span>
01172 
01173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01174     }
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// Replace the instruction contents.</span>
01178     <span class="comment">//</span>
01179 
01180 <span class="preprocessor">#if !defined(_IA64_)</span>
01181 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o3">Content</a> == <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>) {
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">// The instruction is a breakpoint anyway.</span>
01185         <span class="comment">//</span>
01186 
01187         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01188     }
01189 <span class="preprocessor">#endif</span>
01190 <span class="preprocessor"></span>
01191     <span class="comment">//</span>
01192     <span class="comment">// Replace the instruction contents.</span>
01193     <span class="comment">//</span>
01194 
01195 <span class="preprocessor">#if defined(_IA64_)</span>
01196 <span class="preprocessor"></span>
01197     <span class="comment">// read in intruction in case the adjacent instruction has been modified.</span>
01198 
01199     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01200             (PCHAR)&amp;mBuf,
01201             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01202             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01203             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01204         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read 0x%p template failed\n"</span>, <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address));
01205         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01206         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01207         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01208     }
01209 
01210     <span class="keywordflow">switch</span> ((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) {
01211         <span class="keywordflow">case</span> 0:
01212             mBuf = (mBuf &amp; ~(INST_SLOT0_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 5);
01213             <span class="keywordflow">break</span>;
01214 
01215         <span class="keywordflow">case</span> 4:
01216             mBuf = (mBuf &amp; ~(INST_SLOT1_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 14);
01217             <span class="keywordflow">break</span>;
01218 
01219         <span class="keywordflow">case</span> 8:
01220             mBuf = (mBuf &amp; ~(INST_SLOT2_MASK)) | (<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> &lt;&lt; 23);
01221             <span class="keywordflow">break</span>;
01222 
01223         <span class="keywordflow">default</span>:
01224             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpAddBreakpoint bad instruction slot#\n"</span>));
01225             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01226     }
01227     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01228             (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01229             (PCHAR)&amp;mBuf,
01230             <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01231             ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01232 
01233         <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: KdpMoveMemory failed writing BP!\n"</span>));
01234         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01235         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01236         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01237     }
01238     <span class="keywordflow">else</span> {
01239 
01240         <span class="comment">// check for two-slot MOVL instruction. Reject request if attempt to</span>
01241         <span class="comment">// set break in slot 2 of MLI template.</span>
01242         <span class="comment">// change template to type 0 if current instruction is MLI</span>
01243 
01244         <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) != 0) {
01245             (ULONG_PTR)BundleAddress = (ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; ~(0xf);
01246             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01247                     (PCHAR)&amp;mBuf,
01248                     (PCHAR)BundleAddress,
01249                     <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01250                     ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01251                 <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: read template failed at 0x%08x\n"</span>, BundleAddress));
01252                 <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01253                 <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01254                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01255             }
01256             <span class="keywordflow">else</span> {
01257                 <span class="keywordflow">if</span> (((mBuf &amp; INST_TEMPL_MASK) &gt;&gt; 1) == 0x2) {
01258                     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> &amp; 0xf) == 4) {
01259                         <span class="comment">// if template= type 2 MLI, change to type 0</span>
01260                         mBuf &amp;= ~((INST_TEMPL_MASK &gt;&gt; 1) &lt;&lt; 1);
01261                         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a8">KD_BREAKPOINT_IA64_MOVL</a>;
01262                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(
01263                                 (PCHAR)BundleAddress,
01264                                 (PCHAR)&amp;mBuf,
01265                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)
01266                                 ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01267                             <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: write to 0x%08x template failed\n"</span>, BundleAddress));
01268                             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01269                             <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01270                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01271                         }
01272                         <span class="keywordflow">else</span> {
01273                              <span class="comment">//DPRINT(("KD: change MLI template to type 0 at 0x%08x set\n", Address));</span>
01274                         }
01275                     } <span class="keywordflow">else</span> {
01276                          <span class="comment">// set breakpoint at slot 2 of MOVL is illegal</span>
01277                          <a class="code" href="../../d0/d7/kdp_8h.html#a16">DPRINT</a>((<span class="stringliteral">"KD: illegal to set BP at slot 2 of MOVL at 0x%08x\n"</span>, BundleAddress));
01278                          <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01279                          <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01280                          <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01281                     }
01282                 }
01283             }
01284         }
01285         <span class="comment">//DPRINT(("KD: breakpoint at 0x%08x set\n", Address));</span>
01286         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01287     }
01288 
01289 <span class="preprocessor">#else</span>
01290 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>( (PCHAR)<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Address,
01291                        (PCHAR)&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a>,
01292                        <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>) ) != <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a4">KDP_BREAKPOINT_TYPE</a>)) {
01293 
01294         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> |= <a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01295         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01296         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01297 
01298     } <span class="keywordflow">else</span> {
01299 
01300         <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a2">KD_BREAKPOINT_NEEDS_WRITE</a>;
01301         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01302     }
01303 <span class="preprocessor">#endif</span>
01304 <span class="preprocessor"></span>
01305 }
01306 
01307 
01308 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01309"></a><a class="code" href="../../d1/d7/4_2kdp_8h.html#a140">01309</a> <a class="code" href="../../d1/d7/4_2kdp_8h.html#a140">KdpRestoreAllBreakpoints</a> (
01310     VOID
01311     )
01312 {
01313     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01314 
01315     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01316 
01317     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
01318 
01319         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a1">KD_BREAKPOINT_IN_USE</a>) &amp;&amp;
01320             (<a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp; <a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>) ) {
01321 
01322             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> &amp;= ~<a class="code" href="../../d0/d7/kdp_8h.html#a3">KD_BREAKPOINT_SUSPENDED</a>;
01323             <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a9">KdpLowRestoreBreakpoint</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
01324         }
01325     }
01326 
01327     <span class="keywordflow">return</span>;
01328 
01329 } <span class="comment">// KdpRestoreAllBreakpoints</span>
01330 
01331 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01332"></a><a class="code" href="../../d0/d4/kdbreak_8c.html#a11">01332</a> <a class="code" href="../../d1/d4/4_2kdbreak_8c.html#a11">KdDeleteAllBreakpoints</a>(
01333     VOID
01334     )
01335 {
01336     ULONG <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
01337 
01338     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01339         <span class="keywordflow">return</span>;
01340     }
01341 
01342     <a class="code" href="../../d8/d5/kddata_8c.html#a86">BreakpointsSuspended</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01343 
01344     <span class="keywordflow">for</span> ( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = 1; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> &lt;= BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>++ ) {
01345         <a class="code" href="../../d1/d7/4_2kdp_8h.html#a105">KdpDeleteBreakpoint</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
01346     }
01347 
01348     <span class="keywordflow">return</span>;
01349 } <span class="comment">// KdDeleteAllBreakpoints</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
