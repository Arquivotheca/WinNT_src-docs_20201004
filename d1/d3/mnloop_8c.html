<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mnloop.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mnloop.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d2/d2/mnloop_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/mnloop_8c.html#a0">xxxMNRemoveMessage</a> (UINT message1, UINT message2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/mnloop_8c.html#a1">xxxHandleMenuMessages</a> (LPMSG lpmsg, <a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/mnloop_8c.html#a2">xxxEndMenuLoop</a> (<a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, <a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/mnloop_8c.html#a3">xxxMNLoop</a> (<a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupmenu, <a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a> pMenuState, LPARAM lParam, BOOL fDblClk)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="mnloop.c::xxxEndMenuLoop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void xxxEndMenuLoop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pMenuState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ppopupmenu</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00584">584</a> of file <a class="el" href="../../d2/d2/mnloop_8c-source.html">mnloop.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02854">tagPOPUPMENU::fInCancel</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03206">tagMENUSTATE::fInEndMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02817">tagPOPUPMENU::fIsTrackPopup</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03210">tagMENUSTATE::fModelessMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03207">tagMENUSTATE::fUnderline</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00099">gpqForeground</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04719">IsRootPopupMenu()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05035">NCA_ACTIVE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05036">NCA_FORCEFRAMEOFF</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02863">tagPOPUPMENU::spwndNotify</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02267">WFFRAMEON</a>, <a class="el" href="../../d7/d1/mndraw_8c-source.html#l02082">xxxDrawMenuBarUnderlines()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l00696">xxxDWP_DoNCActivate()</a>, <a class="el" href="../../d3/d1/mnapi_8c-source.html#l00124">xxxEndMenu()</a>, and <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00036">xxxMNDismiss()</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03951">xxxCallHandleMenuMessages()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l04022">xxxMenuWindowProc()</a>, and <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>.
<p>
<pre class="fragment"><div>00585 {
00586 
00587     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu));
00588 
00589     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>) {
00590         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o19">fInCancel</a>) {
00591             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
00592         }
00593     } <span class="keywordflow">else</span> {
00594         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o6">fUnderline</a>) {
00595             <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00596             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwnd);
00597             <a class="code" href="../../d4/d1/userk_8h.html#a1317">xxxDrawMenuBarUnderlines</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, FALSE);
00598             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00599         }
00600         <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o5">fInEndMenu</a>) {
00601             <a class="code" href="../../d4/d1/userk_8h.html#a1397">xxxEndMenu</a>(pMenuState);
00602         }
00603     }
00604     <span class="comment">/*</span>
00605 <span class="comment">     * If this is a modeless menu, make sure that the notification</span>
00606 <span class="comment">     *  window caption is drawn in the proper state</span>
00607 <span class="comment">     */</span>
00608     <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00609         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
00610         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndNotify);
00611         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fFrameOn = (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>)
00612                             &amp;&amp; (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == pwndNotify);
00613         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify;
00614 
00615         <span class="keywordflow">if</span> (fFrameOn ^ !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNotify, WFFRAMEON)) {
00616             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwndNotify, &amp;tlpwndNotify);
00617             <a class="code" href="../../d4/d1/userk_8h.html#a1453">xxxDWP_DoNCActivate</a>(pwndNotify,
00618                                 (fFrameOn ? NCA_ACTIVE : NCA_FORCEFRAMEOFF),
00619                                 HRGN_FULL);
00620             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndNotify);
00621 
00622         }
00623     }
00624 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="mnloop.c::xxxHandleMenuMessages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxHandleMenuMessages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">LPMSG&nbsp;</td>
          <td class="mdname" nowrap> <em>lpmsg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pMenuState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ppopupmenu</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00043">43</a> of file <a class="el" href="../../d2/d2/mnloop_8c-source.html">mnloop.c</a>.
<p>
References <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04723">ExitMenuLoop()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03208">tagMENUSTATE::fButtonAlwaysDown</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03205">tagMENUSTATE::fButtonDown</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03212">tagMENUSTATE::fDragAndDrop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03209">tagMENUSTATE::fDragging</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02823">tagPOPUPMENU::fFirstClick</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02812">tagPOPUPMENU::fHasMenuBar</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03215">tagMENUSTATE::fIgnoreButtonUp</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03217">tagMENUSTATE::fInDoDragDrop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02808">tagPOPUPMENU::fIsMenuBar</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02816">tagPOPUPMENU::fIsSysMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03210">tagMENUSTATE::fModelessMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02829">tagPOPUPMENU::fNoNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02820">tagPOPUPMENU::fRightButton</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02821">tagPOPUPMENU::fToggle</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00143">GET_X_LPARAM</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00147">GET_Y_LPARAM</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00232">GetMenuStateWindow()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00235">gwinOldAppHackoMaticFlags</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00165">InflateRect()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03145">IsMFMWFPWindow()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02970">KEYBDHOLD</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03097">LockMFMWFPWindow()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02767">MFMWFP_ALTMENU</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02763">MFMWFP_NOITEM</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02761">MFMWFP_OFFMENU</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03224">tagMENUSTATE::mnFocus</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04747">MNIsItemSelected()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02969">MOUSEHOLD</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02901">tagPOPUPMENU::posSelectedItem</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03232">tagMENUSTATE::ptButtonDown</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00118">PtInRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03223">tagMENUSTATE::ptMouseLast</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01512">PtoH</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03031">QF_CAPTURELOCKED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02881">tagPOPUPMENU::spmenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02893">tagPOPUPMENU::spwndActivePopup</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02863">tagPOPUPMENU::spwndNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02868">tagPOPUPMENU::spwndPopupMenu</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00202">SYSMET</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03233">tagMENUSTATE::uButtonDownHitArea</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03234">tagMENUSTATE::uButtonDownIndex</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03128">UnlockMFMWFPWindow()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03236">tagMENUSTATE::vkButtonDown</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l01433">WM_SYSTIMER</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04016">WOAHACK_CHECKALTKEYSTATE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04017">WOAHACK_IGNOREALTKEYDOWN</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03533">xxxMNButtonDown()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03772">xxxMNButtonUp()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01011">xxxMNChar()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00036">xxxMNDismiss()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02697">xxxMNDoubleClick()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03180">xxxMNFindWindowFromPoint()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01251">xxxMNKeyDown()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03618">xxxMNMouseMove()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00022">xxxMNRemoveMessage()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00795">xxxMNSwitchToAlternateMenu()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, and <a class="el" href="../../d0/d9/keyconv_8c-source.html#l00028">xxxTranslateMessage()</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03951">xxxCallHandleMenuMessages()</a>, and <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">xxxMNLoop()</a>.
<p>
<pre class="fragment"><div>00047 {
00048     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> ch;
00049     ULONG_PTR cmdHitArea;
00050     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cmdItem;
00051     LPARAM lParam;
00052     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fThreadLock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00053     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndHitArea;
00054     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00055     POINT pt;
00056     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00057     RECT rc;
00058 
00059     <span class="comment">/*</span>
00060 <span class="comment">     * Paranoia. Let's bail up front if we don't have a menu.</span>
00061 <span class="comment">     * Some code checks for NULL spmenu, other parts assume it's always not NULL</span>
00062 <span class="comment">     * Use RIP_ERROR for a while to make sure this is OK</span>
00063 <span class="comment">     */</span>
00064     <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00065         RIPMSG2(RIP_ERROR, <span class="stringliteral">"xxxHandleMenuMessages NULL spmenu. pMenuSate:%p ppopupmenu:%p"</span>,
00066                 pMenuState, ppopupmenu);
00067         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00068     }
00069     <span class="comment">/*</span>
00070 <span class="comment">     * Get things out of the structure so that we can access them quicker.</span>
00071 <span class="comment">     */</span>
00072     ch = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lpmsg-&gt;wParam;
00073     lParam = lpmsg-&gt;lParam;
00074 
00075     <span class="comment">/*</span>
00076 <span class="comment">     * In this switch statement, we only look at messages we want to handle and</span>
00077 <span class="comment">     * swallow.  Messages we don't understand will get translated and</span>
00078 <span class="comment">     * dispatched.</span>
00079 <span class="comment">     */</span>
00080     <span class="keywordflow">switch</span> (lpmsg-&gt;message) {
00081     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
00082     <span class="keywordflow">case</span> WM_NCRBUTTONDOWN:
00083 
00084         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o6">fRightButton</a>) {
00085             <span class="keywordflow">goto</span> HandleButtonDown;
00086         }
00087         <span class="comment">/*</span>
00088 <span class="comment">         * Fall through</span>
00089 <span class="comment">         */</span>
00090     <span class="keywordflow">case</span> WM_RBUTTONDBLCLK:
00091     <span class="keywordflow">case</span> WM_NCRBUTTONDBLCLK:
00092         <span class="comment">/*</span>
00093 <span class="comment">         * Right click outside the menu dismisses the menu</span>
00094 <span class="comment">         * (we didn't use to do this for single right clicks on 4.0)</span>
00095 <span class="comment">         */</span>
00096         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a332">MOUSEHOLD</a>;
00097         cmdHitArea = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopupmenu, &amp;cmdItem, MAKEPOINTS(lParam));
00098         <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) {
00099             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
00100             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00101         }
00102         <span class="comment">/*</span>
00103 <span class="comment">         * Do nothing on right clicks on the menu</span>
00104 <span class="comment">         */</span>
00105         <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00106             <a class="code" href="../../d1/d3/mnloop_8c.html#a0">xxxMNRemoveMessage</a>(lpmsg-&gt;message, 0);
00107         }
00108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00109 
00110     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00111     <span class="keywordflow">case</span> WM_NCLBUTTONDOWN:
00112 <span class="comment">// Commented out due to TandyT whinings...</span>
00113 <span class="comment">// if ((ppopupmenu-&gt;trackPopupMenuFlags &amp; TPM_RIGHTBUTTON))</span>
00114 <span class="comment">// break;</span>
00115 
00116 HandleButtonDown:
00117 
00118         <span class="comment">/*</span>
00119 <span class="comment">         * Find out where this mouse down occurred.</span>
00120 <span class="comment">         */</span>
00121         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a332">MOUSEHOLD</a>;
00122         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam);
00123         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.y =  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam);
00124         cmdHitArea = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopupmenu, &amp;cmdItem, MAKEPOINTS(lParam));
00125 
00126 
00127         <span class="comment">/*</span>
00128 <span class="comment">         * Thread lock this if it is a pwnd.  This certainly isn't the way</span>
00129 <span class="comment">         * you'd implement this if you had locking to begin with.</span>
00130 <span class="comment">         */</span>
00131         fThreadLock = <a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(cmdHitArea);
00132         <span class="keywordflow">if</span> (fThreadLock) {
00133             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, &amp;tlpwndHitArea);
00134         }
00135 
00136         <span class="comment">/*</span>
00137 <span class="comment">         * If this is a drag and drop menu, remember the mouse</span>
00138 <span class="comment">         *  position and the hit test results.</span>
00139 <span class="comment">         */</span>
00140         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
00141             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o27">ptButtonDown</a> = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>;
00142             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o29">uButtonDownIndex</a> = cmdItem;
00143             <a class="code" href="../../d4/d1/userk_8h.html#a1376">LockMFMWFPWindow</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>, cmdHitArea);
00144         }
00145 
00146         <span class="comment">/*</span>
00147 <span class="comment">         * Modeless menus don't capture the mouse so we might not see</span>
00148 <span class="comment">         *  the button up. We also release capture when sending the</span>
00149 <span class="comment">         *  WM_MENUDODRAGDROP message. So we want to remember what</span>
00150 <span class="comment">         *  mouse button went down.</span>
00151 <span class="comment">         */</span>
00152         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a> || pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00153             <span class="keywordflow">if</span> (ch &amp; MK_RBUTTON) {
00154                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o30">vkButtonDown</a> = VK_RBUTTON;
00155             } <span class="keywordflow">else</span> {
00156                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o30">vkButtonDown</a> = VK_LBUTTON;
00157             }
00158         }
00159 
00160 
00161         <span class="keywordflow">if</span> ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) &amp;&amp; (cmdItem == 0)) {
00162             <span class="comment">//</span>
00163             <span class="comment">// Clicked in middle of nowhere, so terminate menus, and</span>
00164             <span class="comment">// let button pass through.</span>
00165 CancelOut:
00166             <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
00167             <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
00168         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> &amp;&amp; (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>)) {
00169             <span class="comment">//</span>
00170             <span class="comment">// Switching between menu bar &amp; popup</span>
00171             <span class="comment">//</span>
00172             <a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(ppopupmenu);
00173             cmdHitArea = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00174         }
00175 
00176         <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
00177             <span class="comment">//</span>
00178             <span class="comment">// On menu bar (system or main)</span>
00179             <span class="comment">//</span>
00180             <a class="code" href="../../d4/d1/userk_8h.html#a1368">xxxMNButtonDown</a>(ppopupmenu, pMenuState, cmdItem, TRUE);
00181         } <span class="keywordflow">else</span> {
00182             <span class="comment">// On popup window menu</span>
00183             UserAssert(cmdHitArea);
00184             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, MN_BUTTONDOWN, cmdItem, 0L);
00185         }
00186 
00187         <span class="comment">/*</span>
00188 <span class="comment">         * Swallow the message since we handled it.</span>
00189 <span class="comment">         */</span>
00190             <span class="comment">/*</span>
00191 <span class="comment">             * The excel guys change a wm_rbuttondown to a wm_lbuttondown message</span>
00192 <span class="comment">             * in their message filter hook.  Remove the message here or we'll</span>
00193 <span class="comment">             * get in a nasty loop.</span>
00194 <span class="comment">             *</span>
00195 <span class="comment">             * We need to swallow msg32.message ONLY.  It is possible for</span>
00196 <span class="comment">             * the LBUTTONDOWN to not be at the head of the input queue.</span>
00197 <span class="comment">             * If not, we will swallow a WM_MOUSEMOVE or something else like</span>
00198 <span class="comment">             * that.  The reason Peek() doesn't need to check the range</span>
00199 <span class="comment">             * is because we've already Peek(PM_NOYIELD'ed) before, which</span>
00200 <span class="comment">             * locked the sys queue.</span>
00201 <span class="comment">             */</span>
00202         <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00203             <a class="code" href="../../d1/d3/mnloop_8c.html#a0">xxxMNRemoveMessage</a>(lpmsg-&gt;message, WM_RBUTTONDOWN);
00204         }
00205         <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
00206 
00207     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00208     <span class="keywordflow">case</span> WM_NCMOUSEMOVE:
00209 
00210         <span class="comment">/*</span>
00211 <span class="comment">         * Is the user starting to drag?</span>
00212 <span class="comment">         */</span>
00213         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>
00214                 &amp;&amp; pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>
00215                 &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a>
00216                 &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o7">fButtonAlwaysDown</a>
00217                 &amp;&amp; (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>)) {
00218 
00219             <span class="comment">/*</span>
00220 <span class="comment">             * We expect the mouse to go down on a menu item before a drag can start</span>
00221 <span class="comment">             */</span>
00222             UserAssert(!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o9">fFirstClick</a>);
00223 
00224             <span class="comment">/*</span>
00225 <span class="comment">             * Calculate drag detect rectangle using the position the mouse went</span>
00226 <span class="comment">             *  down on</span>
00227 <span class="comment">             */</span>
00228             *(LPPOINT)&amp;rc.left = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o27">ptButtonDown</a>;
00229             *(LPPOINT)&amp;rc.right = pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o27">ptButtonDown</a>;
00230             <a class="code" href="../../d3/d6/rect_8c.html#a7">InflateRect</a>(&amp;rc, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXDRAG), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYDRAG));
00231 
00232             pt.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam);
00233             pt.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam);
00234 
00235             <span class="comment">/*</span>
00236 <span class="comment">             * If we've moved outside the drag rect, then the user is dragging</span>
00237 <span class="comment">             */</span>
00238             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rc, pt)) {
00239                 <span class="comment">/*</span>
00240 <span class="comment">                 * Post a message so we'll finish processing this message</span>
00241 <span class="comment">                 *  and get out of here before telling the app that the user</span>
00242 <span class="comment">                 *  is dragging</span>
00243 <span class="comment">                 */</span>
00244                 pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1359">GetMenuStateWindow</a>(pMenuState);
00245                 <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00246                     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00247                     <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, MN_DODRAGDROP, 0, 0);
00248                 } <span class="keywordflow">else</span> {
00249                     RIPMSG0(RIP_ERROR, <span class="stringliteral">"xxxMNMouseMove. Unble to post MN_DODGRAGDROP"</span>);
00250                 }
00251              }
00252         } <span class="comment">/* if (pMenuState-&gt;fDragAndDrop */</span>
00253 
00254         <a class="code" href="../../d4/d1/userk_8h.html#a1380">xxxMNMouseMove</a>(ppopupmenu, pMenuState, MAKEPOINTS(lParam));
00255         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00256 
00257     <span class="keywordflow">case</span> WM_RBUTTONUP:
00258     <span class="keywordflow">case</span> WM_NCRBUTTONUP:
00259         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o6">fRightButton</a>) {
00260             <span class="keywordflow">goto</span> HandleButtonUp;
00261         }
00262         <span class="comment">/*</span>
00263 <span class="comment">         * If the button is down, simply swallow this message</span>
00264 <span class="comment">         */</span>
00265         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
00266             <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00267                 <a class="code" href="../../d1/d3/mnloop_8c.html#a0">xxxMNRemoveMessage</a>(lpmsg-&gt;message, 0);
00268             }
00269             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00270         }
00271         <span class="comment">// New feature for shell start menu -- notify when a right click</span>
00272         <span class="comment">// occurs on a menu item, and open a window of opportunity for</span>
00273         <span class="comment">// menus to recurse, allowing them to popup a context-sensitive</span>
00274         <span class="comment">// menu for that item.      (jeffbog 9/28/95)</span>
00275         <span class="comment">//</span>
00276         <span class="comment">// BUGBUG: need to add check for Nashville+ app</span>
00277         <span class="keywordflow">if</span> ((lpmsg-&gt;message == WM_RBUTTONUP) &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>) {
00278                 <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopupActive;
00279 
00280                 <span class="keywordflow">if</span> ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00281                         &amp;&amp; (ppopupActive = ((<a class="code" href="../../d5/d1/structtagMENUWND.html">PMENUWND</a>)(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>))-&gt;ppopupmenu)
00282                         &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1325">MNIsItemSelected</a>(ppopupActive))
00283                 {
00284                     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndNotify;
00285                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>( ppopupActive-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndNotify );
00286                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupActive-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_MENURBUTTONUP,
00287                             ppopupActive-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o34">posSelectedItem</a>, (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(ppopupActive-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a>));
00288                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>( &amp;tlpwndNotify );
00289                 }
00290             }
00291         <span class="keywordflow">break</span>;
00292 
00293     <span class="keywordflow">case</span> WM_LBUTTONUP:
00294     <span class="keywordflow">case</span> WM_NCLBUTTONUP:
00295 <span class="comment">// Commented out due to TandyT whinings...</span>
00296 <span class="comment">// if ((ppopupmenu-&gt;trackPopupMenuFlags &amp; TPM_RIGHTBUTTON))</span>
00297 <span class="comment">// break;</span>
00298 
00299 HandleButtonUp:
00300         <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a>) {
00301 
00302             <span class="comment">/*</span>
00303 <span class="comment">             * Don't care about this mouse up since we never saw the button</span>
00304 <span class="comment">             * down for some reason.</span>
00305 <span class="comment">             */</span>
00306             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00307         }
00308 
00309         <span class="comment">/*</span>
00310 <span class="comment">         * Cancel the dragging state, if any.</span>
00311 <span class="comment">         */</span>
00312         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o11">fDragAndDrop</a>) {
00313 
00314             <a class="code" href="../../d4/d1/userk_8h.html#a1377">UnlockMFMWFPWindow</a>(&amp;pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o28">uButtonDownHitArea</a>);
00315             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00316 
00317             <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a>) {
00318                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> =
00319                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321             }
00322         }
00323 
00324         <span class="comment">/*</span>
00325 <span class="comment">         * Find out where this mouse up occurred.</span>
00326 <span class="comment">         */</span>
00327         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam);
00328         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam);
00329         cmdHitArea = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopupmenu, &amp;cmdItem, MAKEPOINTS(lParam));
00330 
00331 
00332         <span class="comment">/*</span>
00333 <span class="comment">         * If this is not true, some the code below won't work right.</span>
00334 <span class="comment">         */</span>
00335         UserAssert((cmdHitArea != MFMWFP_OFFMENU) || (cmdItem == 0));
00336         UserAssert(cmdHitArea != 0x0000FFFF);
00337 
00338         <span class="comment">/*</span>
00339 <span class="comment">         * Thread lock this if it is a pwnd.  This certainly isn't the way</span>
00340 <span class="comment">         * you'd implement this if you had locking to begin with.</span>
00341 <span class="comment">         */</span>
00342         fThreadLock = <a class="code" href="../../d4/d1/userk_8h.html#a1378">IsMFMWFPWindow</a>(cmdHitArea);
00343         <span class="keywordflow">if</span> (fThreadLock) {
00344             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, &amp;tlpwndHitArea);
00345         }
00346 
00347 
00348         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a>) {
00349             <span class="keywordflow">if</span> (((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) &amp;&amp; (cmdItem == 0)) ||
00350                     ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a> &amp;&amp; ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o7">fToggle</a>))
00351                     <span class="comment">// Button up occurred in some random spot.  Terminate</span>
00352                     <span class="comment">// menus and swallow the message.</span>
00353                     <span class="keywordflow">goto</span> CancelOut;
00354         } <span class="keywordflow">else</span> {
00355             <span class="keywordflow">if</span> ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) &amp;&amp; (cmdItem == 0)) {
00356                 <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o9">fFirstClick</a>) {
00357                     <span class="comment">//</span>
00358                     <span class="comment">// User upclicked in some random spot. Terminate</span>
00359                     <span class="comment">// menus and don't swallow the message.</span>
00360                     <span class="comment">//</span>
00361 
00362                     <span class="comment">//</span>
00363                     <span class="comment">// Don't do anything with HWND here cuz the window is</span>
00364                     <span class="comment">// destroyed after this SendMessage().</span>
00365                     <span class="comment">//</span>
00366 <span class="comment">//                    DONTREVALIDATE();</span>
00367                     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, &amp;tlpwndT);
00368                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>, MN_CANCELMENUS, 0, 0);
00369                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00370                     <span class="keywordflow">goto</span> <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
00371                 }
00372             }
00373 
00374             ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o9">fFirstClick</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375         }
00376 
00377         <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>) {
00378             <span class="comment">//</span>
00379             <span class="comment">// This is a system menu or a menu bar and the button up</span>
00380             <span class="comment">// occurred on the system menu or on a menu bar item.</span>
00381             <span class="comment">//</span>
00382             <a class="code" href="../../d4/d1/userk_8h.html#a1367">xxxMNButtonUp</a>(ppopupmenu, pMenuState, cmdItem, 0);
00383         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cmdHitArea != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) &amp;&amp; (cmdHitArea != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>)) {
00384             <span class="comment">//</span>
00385             <span class="comment">// Warning:  It's common for the popup to go away during the</span>
00386             <span class="comment">// processing of this message, so don't add any code that</span>
00387             <span class="comment">// messes with hwnd after this call!</span>
00388             <span class="comment">//</span>
00389 <span class="comment">//            DONTREVALIDATE();</span>
00390 
00391             <span class="comment">//</span>
00392             <span class="comment">// We send lParam (that has the mouse co-ords ) for the app</span>
00393             <span class="comment">// to get it in its SC_RESTORE/SC_MINIMIZE messages 3.0</span>
00394             <span class="comment">// compat</span>
00395             <span class="comment">//</span>
00396             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, MN_BUTTONUP, (DWORD)cmdItem, lParam);
00397         } <span class="keywordflow">else</span> {
00398             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> =
00399             pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o7">fButtonAlwaysDown</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400         }
00401 <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>:
00402         <span class="keywordflow">if</span> (fThreadLock)
00403             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHitArea);
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00405 
00406 
00407     <span class="keywordflow">case</span> WM_LBUTTONDBLCLK:
00408     <span class="keywordflow">case</span> WM_NCLBUTTONDBLCLK:
00409 
00410         <span class="comment">// Commented out due to TandyT whinings...</span>
00411         <span class="comment">//        if (ppopup-&gt;fRightButton)</span>
00412         <span class="comment">//            break;</span>
00413         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a332">MOUSEHOLD</a>;
00414         cmdHitArea = <a class="code" href="../../d4/d1/userk_8h.html#a1379">xxxMNFindWindowFromPoint</a>(ppopupmenu, &amp;cmdItem, MAKEPOINTS(lParam));
00415         <span class="keywordflow">if</span> ((cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a776">MFMWFP_OFFMENU</a>) &amp;&amp; (cmdItem == 0)) {
00416                 <span class="comment">// Dbl-clicked in middle of nowhere, so terminate menus, and</span>
00417                 <span class="comment">// let button pass through.</span>
00418                 <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
00419                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00420         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o1">fHasMenuBar</a> &amp;&amp; (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a782">MFMWFP_ALTMENU</a>)) {
00421             <span class="comment">//</span>
00422             <span class="comment">// BOGUS</span>
00423             <span class="comment">// TREAT LIKE BUTTON DOWN since we didn't dblclk on same item.</span>
00424             <span class="comment">//</span>
00425             <a class="code" href="../../d4/d1/userk_8h.html#a1370">xxxMNSwitchToAlternateMenu</a>(ppopupmenu);
00426             cmdHitArea =  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00427         }
00428 
00429         <span class="keywordflow">if</span> (cmdHitArea == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>)
00430             <a class="code" href="../../d4/d1/userk_8h.html#a1373">xxxMNDoubleClick</a>(pMenuState, ppopupmenu, cmdItem);
00431         <span class="keywordflow">else</span> {
00432             UserAssert(cmdHitArea);
00433 
00434             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, &amp;tlpwndHitArea);
00435             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>((<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>)cmdHitArea, MN_DBLCLK,
00436                     (DWORD)cmdItem, 0L);
00437             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndHitArea);
00438         }
00439         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00440 
00441     <span class="keywordflow">case</span> WM_KEYDOWN:
00442     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00443 
00444         <span class="comment">/*</span>
00445 <span class="comment">         * If mouse button is down, ignore keyboard input (fix #3899, IanJa)</span>
00446 <span class="comment">         */</span>
00447         <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o4">fButtonDown</a> &amp;&amp; (ch != VK_F1)) {
00448 
00449             <span class="comment">/*</span>
00450 <span class="comment">             * Check if the user wants to cancel dragging.</span>
00451 <span class="comment">             */</span>
00452             <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o8">fDragging</a> &amp;&amp; (ch == VK_ESCAPE)) {
00453                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"xxxHandleMenuMessages: ESC while dragging"</span>);
00454                 pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o14">fIgnoreButtonUp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00455             }
00456 
00457             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00458         }
00459         pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o22">mnFocus</a> = <a class="code" href="../../d4/d1/userk_8h.html#a333">KEYBDHOLD</a>;
00460         <span class="keywordflow">switch</span> (ch) {
00461         <span class="keywordflow">case</span> VK_UP:
00462         <span class="keywordflow">case</span> VK_DOWN:
00463         <span class="keywordflow">case</span> VK_LEFT:
00464         <span class="keywordflow">case</span> VK_RIGHT:
00465         <span class="keywordflow">case</span> VK_RETURN:
00466         <span class="keywordflow">case</span> VK_CANCEL:
00467         <span class="keywordflow">case</span> VK_ESCAPE:
00468         <span class="keywordflow">case</span> VK_MENU:
00469         <span class="keywordflow">case</span> VK_F10:
00470         <span class="keywordflow">case</span> VK_F1:
00471             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>) {
00472                 <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, &amp;tlpwndT);
00473                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, lpmsg-&gt;message,
00474                         ch, 0L);
00475                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00476             } <span class="keywordflow">else</span> {
00477                 <a class="code" href="../../d4/d1/userk_8h.html#a1372">xxxMNKeyDown</a>(ppopupmenu, pMenuState, (UINT)ch);
00478             }
00479             <span class="keywordflow">break</span>;
00480 
00481         <span class="keywordflow">case</span> VK_TAB:
00482             <span class="comment">/*</span>
00483 <span class="comment">             * People hit the ALT key now just to turn underlines ON in dialogs.</span>
00484 <span class="comment">             * This throws them into "invisible menu mode". If they hit any char</span>
00485 <span class="comment">             * at that point, we'll bail in xxxMNChar. But not so if they hit ctrl-tab,</span>
00486 <span class="comment">             * which is used to navigate property sheets. So let's help them out.</span>
00487 <span class="comment">             */</span>
00488             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00489                 <a class="code" href="../../d4/d1/userk_8h.html#a1354">xxxMNDismiss</a>(pMenuState);
00490                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00491             }
00492             <span class="comment">/*</span>
00493 <span class="comment">             * Fall through</span>
00494 <span class="comment">             */</span>
00495 
00496         <span class="keywordflow">default</span>:
00497 TranslateKey:
00498             <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00499                 <a class="code" href="../../d4/d1/userk_8h.html#a1646">xxxTranslateMessage</a>(lpmsg, 0);
00500             }
00501             <span class="keywordflow">break</span>;
00502         }
00503         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00504 
00505     <span class="keywordflow">case</span> WM_CHAR:
00506     <span class="keywordflow">case</span> WM_SYSCHAR:
00507         <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>) {
00508             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, &amp;tlpwndT);
00509             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, lpmsg-&gt;message,
00510                         ch, 0L);
00511             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00512         } <span class="keywordflow">else</span> {
00513             <a class="code" href="../../d4/d1/userk_8h.html#a1392">xxxMNChar</a>(ppopupmenu, pMenuState, (UINT)ch);
00514         }
00515         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00516 
00517     <span class="keywordflow">case</span> WM_SYSKEYUP:
00518 
00519         <span class="comment">/*</span>
00520 <span class="comment">         * Ignore ALT and F10 keyup messages since they are handled on</span>
00521 <span class="comment">         * the KEYDOWN message.</span>
00522 <span class="comment">         */</span>
00523         <span class="keywordflow">if</span> (ch == VK_MENU || ch == VK_F10) {
00524             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a491">WOAHACK_CHECKALTKEYSTATE</a>) {
00525                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a492">WOAHACK_IGNOREALTKEYDOWN</a>) {
00526                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a492">WOAHACK_IGNOREALTKEYDOWN</a>;
00527                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a491">WOAHACK_CHECKALTKEYSTATE</a>;
00528                 } <span class="keywordflow">else</span>
00529                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a101">gwinOldAppHackoMaticFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a492">WOAHACK_IGNOREALTKEYDOWN</a>;
00530             }
00531 
00532             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00533         }
00534 
00535         <span class="comment">/*</span>
00536 <span class="comment">         ** fall thru **</span>
00537 <span class="comment">         */</span>
00538 
00539     <span class="keywordflow">case</span> WM_KEYUP:
00540 
00541         <span class="comment">/*</span>
00542 <span class="comment">         * Do RETURNs on the up transition only</span>
00543 <span class="comment">         */</span>
00544         <span class="keywordflow">goto</span> TranslateKey;
00545 
00546       <span class="keywordflow">case</span> <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>:
00547 
00548         <span class="comment">/*</span>
00549 <span class="comment">         * Prevent the caret from flashing by eating all WM_SYSTIMER messages.</span>
00550 <span class="comment">         */</span>
00551         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00552 
00553       <span class="keywordflow">default</span>:
00554         <span class="keywordflow">break</span>;
00555     }
00556 
00557 <span class="preprocessor">#if DBG</span>
00558 <span class="preprocessor"></span>    <span class="comment">/*</span>
00559 <span class="comment">     * Nobody should be able to steal capture from modal menus.</span>
00560 <span class="comment">     */</span>
00561     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>
00562             &amp;&amp; !pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>
00563             &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, ppopupmenu) ) {
00564 
00565         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;QF_flags &amp; QF_CAPTURELOCKED);
00566         UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;spwndCapture == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00567     }
00568 <span class="preprocessor">#endif</span>
00569 <span class="preprocessor"></span>
00570     <span class="comment">/*</span>
00571 <span class="comment">     * We didn't handle this message</span>
00572 <span class="comment">     */</span>
00573     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="mnloop.c::xxxMNLoop" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int xxxMNLoop           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ppopupmenu</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d1/structtagMENUSTATE.html">PMENUSTATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pMenuState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fDblClk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00635">635</a> of file <a class="el" href="../../d2/d2/mnloop_8c-source.html">mnloop.c</a>.
<p>
References <a class="el" href="../../d2/d1/hooks_8c-source.html#l01210">_CallMsgFilter()</a>, <a class="el" href="../../d8/d8/keyboard_8c-source.html#l00027">_GetKeyState()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00583">_GetMenuState()</a>, <a class="el" href="../../d7/d8/rtl_2wow_8c-source.html#l00826">_IsChild()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00981">_PostMessage()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03225">tagMENUSTATE::cmdLast</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07019">DBGDecModalMenuCount</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l07053">DecSFWLockCount()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04723">ExitMenuLoop()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02846">tagPOPUPMENU::fFlushDelayedFree</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00019">FindNCHit()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03217">tagMENUSTATE::fInDoDragDrop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03204">tagMENUSTATE::fInsideMenuLoop</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02808">tagPOPUPMENU::fIsMenuBar</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02816">tagPOPUPMENU::fIsSysMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02817">tagPOPUPMENU::fIsTrackPopup</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03202">tagMENUSTATE::fMenuStarted</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03210">tagMENUSTATE::fModelessMenu</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02829">tagPOPUPMENU::fNoNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02820">tagPOPUPMENU::fRightButton</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03242">tagMENUSTATE::hdcWndAni</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04719">IsRootPopupMenu()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00091">MNFlushDestroyedPopups()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02969">MOUSEHOLD</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03377">tagTHREADINFO::ptLast</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03223">tagMENUSTATE::ptMouseLast</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03003">QF_ACTIVATIONCHANGE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03031">QF_CAPTURELOCKED</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03129">tagQ::QF_flags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03111">tagQ::spwndActive</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02893">tagPOPUPMENU::spwndActivePopup</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03109">tagQ::spwndCapture</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02863">tagPOPUPMENU::spwndNotify</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02868">tagPOPUPMENU::spwndPopupMenu</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02848">TIF_IGNOREPLAYBACKDELAY</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l04885">Validateppopupmenu</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l01433">WM_SYSTIMER</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00762">xxxDispatchMessage()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00584">xxxEndMenuLoop()</a>, <a class="el" href="../../d8/d6/menuc_8c-source.html#l00270">xxxGetSysMenuHandle()</a>, <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00043">xxxHandleMenuMessages()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00181">xxxMNReleaseCapture()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00677">xxxMNStartMenu()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05553">xxxPeekMessage</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01069">xxxSendNotifyMessage()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04382">xxxSleepThread()</a>, and <a class="el" href="../../d0/d9/keyconv_8c-source.html#l00028">xxxTranslateMessage()</a>.
<p>
Referenced by <a class="el" href="../../d1/d2/mnkey_8c-source.html#l00290">xxxMNKeyFilter()</a>, <a class="el" href="../../d5/d7/syscmd_8c-source.html#l00193">xxxSysCommand()</a>, and <a class="el" href="../../d3/d2/mnpopup_8c-source.html#l00052">xxxTrackPopupMenuEx()</a>.
<p>
<pre class="fragment"><div>00640 {
00641     <span class="keywordtype">int</span> hit;
00642     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00643     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSendIdle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00644     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInQueue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> menuState;
00646     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00647     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
00648 
00649     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a1318">IsRootPopupMenu</a>(ppopupmenu));
00650 
00651     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00652     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o23">cmdLast</a> = 0;
00653 
00654     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00655 
00656     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.x = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>.x;
00657     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o21">ptMouseLast</a>.y = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o38">ptLast</a>.y;
00658 
00659     <span class="comment">/*</span>
00660 <span class="comment">     * Set flag to false, so that we can track if windows have</span>
00661 <span class="comment">     * been activated since entering this loop.</span>
00662 <span class="comment">     */</span>
00663     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a861">QF_ACTIVATIONCHANGE</a>;
00664 
00665     <span class="comment">/*</span>
00666 <span class="comment">     * Were we called from xxxMenuKeyFilter? If not, simulate a LBUTTONDOWN</span>
00667 <span class="comment">     * message to bring up the popup.</span>
00668 <span class="comment">     */</span>
00669     <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o1">fMenuStarted</a>) {
00670         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o6">fRightButton</a>) ?
00671                         VK_RBUTTON : VK_LBUTTON)) &gt;= 0) {
00672 
00673             <span class="comment">/*</span>
00674 <span class="comment">             * We think the mouse button should be down but the call to get key</span>
00675 <span class="comment">             * state says different so we need to get outta menu mode.  This</span>
00676 <span class="comment">             * happens if clicking on the menu causes a sys modal message box to</span>
00677 <span class="comment">             * come up before we can enter this stuff.  For example, run</span>
00678 <span class="comment">             * winfile, click on drive a: to see its tree.  Activate some other</span>
00679 <span class="comment">             * app, then open drive a: and activate winfile by clicking on the</span>
00680 <span class="comment">             * menu.  This causes a sys modal msg box to come up just before</span>
00681 <span class="comment">             * entering menu mode.  The user may have the mouse button up but</span>
00682 <span class="comment">             * menu mode code thinks it is down...</span>
00683 <span class="comment">             */</span>
00684 
00685             <span class="comment">/*</span>
00686 <span class="comment">             * Need to notify the app we are exiting menu mode because we told</span>
00687 <span class="comment">             * it we were entering menu mode just before entering this function</span>
00688 <span class="comment">             * in xxxSysCommand()...</span>
00689 <span class="comment">             */</span>
00690             <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o11">fNoNotify</a>) {
00691                 <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
00692                 <a class="code" href="../../d4/d1/userk_8h.html#a1581">xxxSendNotifyMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_EXITMENULOOP,
00693                     ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a> &amp;&amp; !ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o2">fIsSysMenu</a>) ? TRUE : FALSE), 0);
00694                 <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00695             }
00696             <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00697         }
00698 
00699         <span class="comment">/*</span>
00700 <span class="comment">         * Simulate a WM_LBUTTONDOWN message.</span>
00701 <span class="comment">         */</span>
00702         <span class="keywordflow">if</span> (!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a>) {
00703 
00704             <span class="comment">/*</span>
00705 <span class="comment">             * For TrackPopupMenus, we do it in the TrackPopupMenu function</span>
00706 <span class="comment">             * itself so we don't want to do it again.</span>
00707 <span class="comment">             */</span>
00708             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1386">xxxMNStartMenu</a>(ppopupmenu, MOUSEHOLD)) {
00709                 <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00710             }
00711         }
00712 
00713         <span class="keywordflow">if</span> ((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o6">fRightButton</a>)) {
00714             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message = (fDblClk ? WM_RBUTTONDBLCLK : WM_RBUTTONDOWN);
00715             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam = MK_RBUTTON;
00716         } <span class="keywordflow">else</span> {
00717             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message = (fDblClk ? WM_LBUTTONDBLCLK : WM_LBUTTONDOWN);
00718             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam = MK_LBUTTON;
00719         }
00720         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam = lParam;
00721         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.hwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>);
00722         <a class="code" href="../../d4/d1/userk_8h.html#a1399">xxxHandleMenuMessages</a>(&amp;msg, pMenuState, ppopupmenu);
00723      }
00724 
00725     <span class="comment">/*</span>
00726 <span class="comment">     * If this is a modeless menu, release capture, mark it in the menu state</span>
00727 <span class="comment">     *   and return. Decrement foreground lock count.</span>
00728 <span class="comment">     */</span>
00729      <span class="keywordflow">if</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a>) {
00730          <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a>();
00731 
00732          <a class="code" href="../../d4/d1/userk_8h.html#a2028">DecSFWLockCount</a>();
00733          <a class="code" href="../../d4/d1/userk_8h.html#a742">DBGDecModalMenuCount</a>();
00734          <span class="keywordflow">return</span> 0;
00735      }
00736 
00737     <span class="keywordflow">while</span> (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a>) {
00738 
00739         <span class="comment">/*</span>
00740 <span class="comment">         * Is a message waiting for us?</span>
00741 <span class="comment">         */</span>
00742         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fPeek = <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, 0, 0, PM_NOYIELD | PM_NOREMOVE);
00743 
00744         <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
00745 
00746         <span class="keywordflow">if</span> (fPeek) {
00747             <span class="comment">/*</span>
00748 <span class="comment">             * Bail if we have been forced out of menu loop</span>
00749 <span class="comment">             */</span>
00750             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, ppopupmenu)) {
00751                 <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00752             }
00753 
00754             <span class="comment">/*</span>
00755 <span class="comment">             * Since we could have blocked in xxxWaitMessage (see last line</span>
00756 <span class="comment">             * of loop) or xxxPeekMessage, reset the cached copy of</span>
00757 <span class="comment">             * ptiCurrent()-&gt;pq: It could have changed if someone did a</span>
00758 <span class="comment">             * DetachThreadInput() while we were away.</span>
00759 <span class="comment">             */</span>
00760             <span class="keywordflow">if</span> ((!ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o3">fIsTrackPopup</a> &amp;&amp;
00761                     pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> &amp;&amp;
00762                     ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || !<a class="code" href="../../d6/d9/rtl_2wow_8c.html#a16">_IsChild</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>, ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>)))) {
00763 
00764                 <span class="comment">/*</span>
00765 <span class="comment">                 * End menu processing if we are no longer the active window.</span>
00766 <span class="comment">                 * This is needed in case a system modal dialog box pops up</span>
00767 <span class="comment">                 * while we are tracking the menu code for example.  It also</span>
00768 <span class="comment">                 * helps out Tracer if a macro is executed while a menu is down.</span>
00769 <span class="comment">                 */</span>
00770 
00771                 <span class="comment">/*</span>
00772 <span class="comment">                 * Also, end menu processing if we think the mouse button is</span>
00773 <span class="comment">                 * down but it really isn't.  (Happens if a sys modal dialog int</span>
00774 <span class="comment">                 * time dlg box comes up while we are in menu mode.)</span>
00775 <span class="comment">                 */</span>
00776 
00777                 <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00778             }
00779 
00780             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o0">fIsMenuBar</a> &amp;&amp; <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_LBUTTONDBLCLK) {
00781 
00782                 <span class="comment">/*</span>
00783 <span class="comment">                 * Was the double click on the system menu or caption?</span>
00784 <span class="comment">                 */</span>
00785                 hit = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a0">FindNCHit</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, (LONG)<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam);
00786                 <span class="keywordflow">if</span> (hit == HTCAPTION) {
00787                     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00788                     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu;
00789 
00790                     <span class="comment">/*</span>
00791 <span class="comment">                     * Get the message out of the queue since we're gonna</span>
00792 <span class="comment">                     * process it.</span>
00793 <span class="comment">                     */</span>
00794                     <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
00795                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, ppopupmenu)) {
00796                         <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00797                     } <span class="keywordflow">else</span> {
00798                         pwnd = ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>;
00799                         <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwndT);
00800                         pmenu = <a class="code" href="../../d4/d1/userk_8h.html#a1403">xxxGetSysMenuHandle</a>(pwnd);
00801                         UserAssert(pwnd == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00802 
00803                         menuState = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a11">_GetMenuState</a>(pmenu, SC_RESTORE &amp; 0x0000FFF0,
00804                                 MF_BYCOMMAND);
00805 
00806                         <span class="comment">/*</span>
00807 <span class="comment">                         * Only send the sys command if the item is valid.  If</span>
00808 <span class="comment">                         * the item doesn't exist or is disabled, then don't</span>
00809 <span class="comment">                         * post the syscommand.  Note that for win2 apps, we</span>
00810 <span class="comment">                         * always send the sys command if it is a child window.</span>
00811 <span class="comment">                         * This is so hosebag apps can change the sys menu.</span>
00812 <span class="comment">                         */</span>
00813                         <span class="keywordflow">if</span> (!(menuState &amp; MFS_GRAYED)) {
00814                             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, WM_SYSCOMMAND, SC_RESTORE, 0);
00815                         }
00816 
00817                         <span class="comment">/*</span>
00818 <span class="comment">                         * Get out of menu mode.</span>
00819 <span class="comment">                         */</span>
00820                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00821                         <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00822                     }
00823                 }
00824             }
00825 
00826             fInQueue = (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_LBUTTONDOWN ||
00827                         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_RBUTTONDOWN ||
00828                         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_NCLBUTTONDOWN ||
00829                         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_NCRBUTTONDOWN);
00830 
00831             <span class="keywordflow">if</span> (!fInQueue) {
00832 
00833                 <span class="comment">/*</span>
00834 <span class="comment">                 * Note that we call xxxPeekMessage() with the filter</span>
00835 <span class="comment">                 * set to the message we got from xxxPeekMessage() rather</span>
00836 <span class="comment">                 * than simply 0, 0.  This prevents problems when</span>
00837 <span class="comment">                 * xxxPeekMessage() returns something like a WM_TIMER,</span>
00838 <span class="comment">                 * and after we get here to remove it a WM_LBUTTONDOWN,</span>
00839 <span class="comment">                 * or some higher-priority input message, gets in the</span>
00840 <span class="comment">                 * queue and gets removed accidently.  Basically we want</span>
00841 <span class="comment">                 * to be sure we remove the right message in this case.</span>
00842 <span class="comment">                 * NT bug 3852 was caused by this problem.</span>
00843 <span class="comment">                 * Set the TIF_IGNOREPLAYBACKDELAY bit in case journal playback</span>
00844 <span class="comment">                 * is happening: this allows us to proceed even if the hookproc</span>
00845 <span class="comment">                 * incorrectly returns a delay now.  The bit will be cleared if</span>
00846 <span class="comment">                 * this happens, so we can see why the Peek-Remove below fails.</span>
00847 <span class="comment">                 * Lotus' Freelance Graphics tutorial does such bad journalling</span>
00848 <span class="comment">                 */</span>
00849 
00850                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>;
00851                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE)) {
00852                     <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>) {
00853                         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>;
00854                         <span class="comment">/*</span>
00855 <span class="comment">                         * It wasn't a bad journal playback: something else</span>
00856 <span class="comment">                         * made the previously peeked message disappear before</span>
00857 <span class="comment">                         * we could peek it again to remove it.</span>
00858 <span class="comment">                         */</span>
00859                         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Disappearing msg 0x%08lx"</span>, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message);
00860                         <span class="keywordflow">goto</span> NoMsg;
00861                     }
00862                 }
00863                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a814">TIF_IGNOREPLAYBACKDELAY</a>;
00864             }
00865 
00866             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1818">_CallMsgFilter</a>(&amp;msg, MSGF_MENU)) {
00867                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1399">xxxHandleMenuMessages</a>(&amp;msg, pMenuState, ppopupmenu)) {
00868                     <a class="code" href="../../d4/d1/userk_8h.html#a1646">xxxTranslateMessage</a>(&amp;msg, 0);
00869                     <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;msg);
00870                 }
00871 
00872                 <a class="code" href="../../d4/d1/userk_8h.html#a549">Validateppopupmenu</a>(ppopupmenu);
00873 
00874                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, ppopupmenu)) {
00875                     <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00876                 }
00877 
00878                 <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a861">QF_ACTIVATIONCHANGE</a>) {
00879 
00880                     <span class="comment">/*</span>
00881 <span class="comment">                     * Run away and exit menu mode if another window has become</span>
00882 <span class="comment">                     * active while a menu was up.</span>
00883 <span class="comment">                     */</span>
00884                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"Exiting menu mode: another window activated"</span>);
00885                     <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00886                 }
00887 
00888 <span class="preprocessor">#if DBG</span>
00889 <span class="preprocessor"></span>                <span class="comment">/*</span>
00890 <span class="comment">                 * Nobody should be able to still capture from us.</span>
00891 <span class="comment">                 */</span>
00892                 <span class="keywordflow">if</span> (!pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o16">fInDoDragDrop</a>) {
00893                     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> &amp; QF_CAPTURELOCKED);
00894                     UserAssert(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>);
00895                 }
00896 <span class="preprocessor">#endif</span>
00897 <span class="preprocessor"></span>
00898                 <span class="comment">/*</span>
00899 <span class="comment">                 * If we get a system timer, then it's like we're idle</span>
00900 <span class="comment">                 */</span>
00901                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>) {
00902                     <span class="keywordflow">goto</span> NoMsg;
00903                 }
00904 
00905                 <span class="comment">/*</span>
00906 <span class="comment">                 * Don't set fSendIdle if we got these messages</span>
00907 <span class="comment">                 */</span>
00908                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_TIMER) || (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_PAINT)) {
00909                     <span class="keywordflow">continue</span>;
00910                 }
00911 
00912             } <span class="keywordflow">else</span> {
00913                 <span class="keywordflow">if</span> (fInQueue)
00914                     <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message,
00915                             PM_REMOVE);
00916             }
00917 
00918             <span class="comment">/*</span>
00919 <span class="comment">             * Reenable WM_ENTERIDLE messages.</span>
00920 <span class="comment">             */</span>
00921             fSendIdle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00922 
00923         } <span class="keywordflow">else</span> {
00924 NoMsg:
00925             <span class="comment">/*</span>
00926 <span class="comment">             * Bail if we have been forced out of menu loop</span>
00927 <span class="comment">             */</span>
00928             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a> (pMenuState, ppopupmenu)) {
00929                 <span class="keywordflow">goto</span> <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>;
00930             }
00931 
00932             UserAssert((ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a> == NULL)
00933                     || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>, WFVISIBLE)));
00934 
00935 
00936             <span class="comment">/*</span>
00937 <span class="comment">             * If a hierarchical popup has been destroyed, this is a</span>
00938 <span class="comment">             *  good time to flush ppmDelayedFree</span>
00939 <span class="comment">             */</span>
00940             <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o17">fFlushDelayedFree</a>) {
00941                 <a class="code" href="../../d4/d1/userk_8h.html#a1346">MNFlushDestroyedPopups</a> (ppopupmenu, FALSE);
00942                 ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o17">fFlushDelayedFree</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00943             }
00944 
00945             <span class="comment">/*</span>
00946 <span class="comment">             * We need to send the WM_ENTERIDLE message only the first time</span>
00947 <span class="comment">             * there are no messages for us to process.  Subsequent times we</span>
00948 <span class="comment">             * need to yield via WaitMessage().  This will allow other tasks to</span>
00949 <span class="comment">             * get some time while we have a menu down.</span>
00950 <span class="comment">             */</span>
00951             <span class="keywordflow">if</span> (fSendIdle) {
00952                 <span class="keywordflow">if</span> (ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953                     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, &amp;tlpwndT);
00954                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o25">spwndNotify</a>, WM_ENTERIDLE, MSGF_MENU,
00955                         (LPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(ppopupmenu-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o31">spwndActivePopup</a>));
00956                     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00957                 }
00958                 fSendIdle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00959             } <span class="keywordflow">else</span> {
00960                 <span class="comment">/*</span>
00961 <span class="comment">                 * If we're animating, sleep only 1 ms to reduce the chance</span>
00962 <span class="comment">                 *  of jerky animation.</span>
00963 <span class="comment">                 * When not animating, this is the same as a xxxWaitMessage call</span>
00964 <span class="comment">                 */</span>
00965                 <a class="code" href="../../d4/d1/userk_8h.html#a1196">xxxSleepThread</a>(QS_ALLINPUT | QS_EVENT, (pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o34">hdcWndAni</a> != NULL), TRUE);
00966             }
00967 
00968         } <span class="comment">/* if (PeekMessage(&amp;msg, NULL, 0, 0, PM_NOYIELD)) else */</span>
00969 
00970     } <span class="comment">/* end while (fInsideMenuLoop) */</span>
00971 
00972 
00973 
00974 <a class="code" href="../../d4/d1/userk_8h.html#a1319">ExitMenuLoop</a>:
00975     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o3">fInsideMenuLoop</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00976     pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o9">fModelessMenu</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00977 
00978     <span class="comment">/*</span>
00979 <span class="comment">     * Make sure that the menu has been ended/canceled</span>
00980 <span class="comment">     */</span>
00981     <a class="code" href="../../d4/d1/userk_8h.html#a1400">xxxEndMenuLoop</a> (pMenuState, ppopupmenu);
00982 
00983     <a class="code" href="../../d2/d7/ntuser_2kernel_2menu_8c.html#a6">xxxMNReleaseCapture</a>();
00984 
00985     <span class="comment">// Throw in an extra peek here when we exit the menu loop to ensure that the input queue</span>
00986     <span class="comment">// for this thread gets unlocked if there is no more input left for him.</span>
00987     <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, WM_MOUSEMOVE, WM_MOUSEMOVE, PM_NOYIELD | PM_NOREMOVE);
00988     <span class="keywordflow">return</span>(pMenuState-&gt;<a class="code" href="../../d4/d1/structtagMENUSTATE.html#o23">cmdLast</a>);
00989 } <span class="comment">/* xxxMenuLoop() */</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="mnloop.c::xxxMNRemoveMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL xxxMNRemoveMessage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00022">22</a> of file <a class="el" href="../../d2/d2/mnloop_8c-source.html">mnloop.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l05553">xxxPeekMessage</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/mnloop_8c-source.html#l00043">xxxHandleMenuMessages()</a>.
<p>
<pre class="fragment"><div>00023 {
00024     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00025     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, 0, 0, PM_NOYIELD | PM_NOREMOVE)) {
00026         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00027     }
00028 
00029     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == message1) || (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == message2)) {
00030         UserAssert(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message != 0);
00031         <a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;msg, NULL, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, PM_REMOVE);
00032         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00033     } <span class="keywordflow">else</span> {
00034         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00035     }
00036 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:47 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
