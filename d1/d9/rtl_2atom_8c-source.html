<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: atom.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>atom.c</h1><a href="../../d0/d0/rtl_2atom_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    atom.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains the common code to implement atom tables.  It is called</span>
00012 <span class="comment">    by both the user mode Win32 Atom API functions (Local/GlobalxxxAtom) and</span>
00013 <span class="comment">    by the kernel mode window manager code to access global atoms.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Steve Wood (stevewo) 26-Oct-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00024 <span class="preprocessor">#include "atom.h"</span>
00025 
<a name="l00026"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a0">00026</a> ULONG <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a0">RtlpAtomAllocateTag</a>;
00027 
00028 PVOID
<a name="l00029"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a1">00029</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a1">RtlpAllocateAtom</a>(
00030     IN ULONG NumberOfBytes
00031     )
00032 {
00033 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00034 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, NumberOfBytes, <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a0">RtlpAtomAllocateTag</a> );
00035 <span class="preprocessor">#else</span>
00036 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a0">RtlpAtomAllocateTag</a>, NumberOfBytes );
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>}
00039 
00040 
00041 <span class="keywordtype">void</span>
<a name="l00042"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">00042</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>(
00043     IN PVOID p
00044     )
00045 {
00046 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00047 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( p );
00048 <span class="preprocessor">#else</span>
00049 <span class="preprocessor"></span>    <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, p );
00050 <span class="preprocessor">#endif</span>
00051 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00052 }
00053 
00054 
00055 <span class="keywordtype">void</span>
<a name="l00056"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a3">00056</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a3">RtlpInitializeLockAtomTable</a>(
00057     IN OUT PRTL_ATOM_TABLE AtomTable
00058     )
00059 {
00060 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00061 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;AtomTable-&gt;FastMutex );
00062 <span class="preprocessor">#else</span>
00063 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>( &amp;AtomTable-&gt;CriticalSection );
00064 <span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00066 }
00067 
00068 BOOLEAN
<a name="l00069"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">00069</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>(
00070     IN PRTL_ATOM_TABLE AtomTable
00071     )
00072 {
00073     <span class="keywordflow">if</span> (AtomTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || AtomTable-&gt;Signature != RTL_ATOM_TABLE_SIGNATURE) {
00074         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00075         }
00076 
00077 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00078 <span class="preprocessor"></span>    ExAcquireFastMutex( &amp;AtomTable-&gt;FastMutex );
00079 <span class="preprocessor">#else</span>
00080 <span class="preprocessor"></span>    RtlEnterCriticalSection( &amp;AtomTable-&gt;CriticalSection );
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>
00083     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00084 }
00085 
00086 <span class="keywordtype">void</span>
<a name="l00087"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">00087</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>(
00088     IN PRTL_ATOM_TABLE AtomTable
00089     )
00090 {
00091 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00092 <span class="preprocessor"></span>    ExReleaseFastMutex( &amp;AtomTable-&gt;FastMutex );
00093 <span class="preprocessor">#else</span>
00094 <span class="preprocessor"></span>    RtlLeaveCriticalSection( &amp;AtomTable-&gt;CriticalSection );
00095 <span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>}
00097 
00098 
00099 <span class="keywordtype">void</span>
<a name="l00100"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a6">00100</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a6">RtlpDestroyLockAtomTable</a>(
00101     IN OUT PRTL_ATOM_TABLE AtomTable
00102     )
00103 {
00104 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00106 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/dll_2resource_8c.html#a29">RtlDeleteCriticalSection</a>( &amp;AtomTable-&gt;CriticalSection );
00107 <span class="preprocessor">#endif</span>
00108 <span class="preprocessor"></span>}
00109 
00110 
00111 BOOLEAN
<a name="l00112"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a7">00112</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a7">RtlpInitializeHandleTableForAtomTable</a>(
00113     PRTL_ATOM_TABLE AtomTable
00114     )
00115 {
00116 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00117 <span class="preprocessor"></span>    AtomTable-&gt;ExHandleTable = <a class="code" href="../../d5/d8/ex_8h.html#a290">ExCreateHandleTable</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00118     <span class="keywordflow">if</span> (AtomTable-&gt;ExHandleTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00119         <span class="comment">//</span>
00120         <span class="comment">// Make sure atom handle tables are NOT part of object handle enumeration</span>
00121         <span class="comment">//</span>
00122 
00123         <a class="code" href="../../d5/d8/ex_8h.html#a291">ExRemoveHandleTable</a>( AtomTable-&gt;ExHandleTable );
00124         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00125         }
00126     <span class="keywordflow">else</span> {
00127         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128         }
00129 <span class="preprocessor">#else</span>
00130 <span class="preprocessor"></span>    <a class="code" href="../../d1/d8/rtl_2handle_8c.html#a0">RtlInitializeHandleTable</a>( (ULONG)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~RTL_ATOM_MAXIMUM_INTEGER_ATOM,
00131                               <span class="keyword">sizeof</span>( RTL_ATOM_HANDLE_TABLE_ENTRY ),
00132                               &amp;AtomTable-&gt;RtlHandleTable
00133                             );
00134     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00135 <span class="preprocessor">#endif</span>
00136 <span class="preprocessor"></span>}
00137 
00138 <span class="keywordtype">void</span>
<a name="l00139"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a8">00139</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a8">RtlpDestroyHandleTableForAtomTable</a>(
00140     PRTL_ATOM_TABLE AtomTable
00141     )
00142 {
00143 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00144 <span class="preprocessor"></span>    <a class="code" href="../../d5/d8/ex_8h.html#a292">ExDestroyHandleTable</a>( AtomTable-&gt;ExHandleTable, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00145 <span class="preprocessor">#else</span>
00146 <span class="preprocessor"></span>    <a class="code" href="../../d1/d8/rtl_2handle_8c.html#a1">RtlDestroyHandleTable</a>( &amp;AtomTable-&gt;RtlHandleTable );
00147 <span class="preprocessor">#endif</span>
00148 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00149 }
00150 
00151 PRTL_ATOM_TABLE_ENTRY
<a name="l00152"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">00152</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>(
00153     IN PRTL_ATOM_TABLE AtomTable,
00154     IN ULONG HandleIndex
00155     )
00156 {
00157 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00158 <span class="preprocessor"></span>    <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ExHandleEntry;
00159     PRTL_ATOM_TABLE_ENTRY a;
00160     <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> ExHandle;
00161 
00162     ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o1">Index</a> = HandleIndex;
00163 
00164     ExHandleEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( AtomTable-&gt;ExHandleTable,
00165                                           ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a>
00166                                         );
00167     <span class="keywordflow">if</span> (ExHandleEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00168         a = ExHandleEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>;
00169         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( AtomTable-&gt;ExHandleTable, ExHandleEntry );
00170         <span class="keywordflow">return</span> a;
00171         }
00172 <span class="preprocessor">#else</span>
00173 <span class="preprocessor"></span>    PRTL_ATOM_HANDLE_TABLE_ENTRY HandleEntry;
00174 
00175     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/rtl_2handle_8c.html#a5">RtlIsValidIndexHandle</a>( &amp;AtomTable-&gt;RtlHandleTable,
00176                                HandleIndex,
00177                                (PRTL_HANDLE_TABLE_ENTRY *)&amp;HandleEntry
00178                              )
00179        ) {
00180         <span class="keywordflow">return</span> HandleEntry-&gt;Atom;
00181         }
00182 <span class="preprocessor">#endif</span>
00183 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00184 }
00185 
00186 BOOLEAN
<a name="l00187"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a10">00187</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a10">RtlpCreateHandleForAtom</a>(
00188     PRTL_ATOM_TABLE p,
00189     PRTL_ATOM_TABLE_ENTRY a
00190     )
00191 {
00192 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00193 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> ExHandle;
00194     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ExHandleEntry;
00195 
00196     ExHandleEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = a;
00197     ExHandleEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = 0;
00198     ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( p-&gt;ExHandleTable, &amp;ExHandleEntry );
00199     <span class="keywordflow">if</span> (ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         a-&gt;HandleIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o1">Index</a>;
00201         a-&gt;Atom = (RTL_ATOM)((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)a-&gt;HandleIndex | RTL_ATOM_MAXIMUM_INTEGER_ATOM);
00202         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00203         }
00204 <span class="preprocessor">#else</span>
00205 <span class="preprocessor"></span>    PRTL_ATOM_HANDLE_TABLE_ENTRY HandleEntry;
00206     ULONG HandleIndex;
00207 
00208     HandleEntry = (PRTL_ATOM_HANDLE_TABLE_ENTRY)<a class="code" href="../../d1/d8/rtl_2handle_8c.html#a2">RtlAllocateHandle</a>( &amp;p-&gt;RtlHandleTable,
00209                                                                    &amp;HandleIndex
00210                                                                  );
00211     <span class="keywordflow">if</span> (HandleEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00212         <span class="keywordflow">if</span> (HandleIndex &lt; RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00213             a-&gt;HandleIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)HandleIndex;
00214             a-&gt;Atom = (RTL_ATOM)((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)HandleIndex | RTL_ATOM_MAXIMUM_INTEGER_ATOM);
00215             HandleEntry-&gt;Atom = a;
00216             HandleEntry-&gt;LockCount = 0;
00217             HandleEntry-&gt;Flags = RTL_HANDLE_ALLOCATED;
00218             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00219             }
00220 
00221         <a class="code" href="../../d1/d8/rtl_2handle_8c.html#a3">RtlFreeHandle</a>( &amp;p-&gt;RtlHandleTable, (PRTL_HANDLE_TABLE_ENTRY)HandleEntry );
00222         }
00223 <span class="preprocessor">#endif</span>
00224 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00225 }
00226 
00227 <span class="keywordtype">void</span>
<a name="l00228"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a11">00228</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a11">RtlpFreeHandleForAtom</a>(
00229     PRTL_ATOM_TABLE p,
00230     PRTL_ATOM_TABLE_ENTRY a
00231     )
00232 {
00233 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00234 <span class="preprocessor"></span>    <a class="code" href="../../d7/d8/struct__EXHANDLE.html">EXHANDLE</a> ExHandle;
00235 
00236     ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o1">Index</a> = a-&gt;HandleIndex;
00237     <a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>( p-&gt;ExHandleTable, ExHandle.<a class="code" href="../../d7/d8/struct__EXHANDLE.html#o2">GenericHandleOverlay</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00238 <span class="preprocessor">#else</span>
00239 <span class="preprocessor"></span>    PRTL_ATOM_HANDLE_TABLE_ENTRY HandleEntry;
00240 
00241     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/rtl_2handle_8c.html#a5">RtlIsValidIndexHandle</a>( &amp;p-&gt;RtlHandleTable,
00242                                a-&gt;HandleIndex,
00243                                (PRTL_HANDLE_TABLE_ENTRY *)&amp;HandleEntry
00244                              )
00245        ) {
00246         <a class="code" href="../../d1/d8/rtl_2handle_8c.html#a3">RtlFreeHandle</a>( &amp;p-&gt;RtlHandleTable, (PRTL_HANDLE_TABLE_ENTRY)HandleEntry );
00247         }
00248 <span class="preprocessor">#endif</span>
00249 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
00250 }
00251 
00252 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00253"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a12">00253</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a12">RtlInitializeAtomPackage</a>(
00254     IN ULONG AllocationTag
00255     )
00256 {
00257     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a0">RtlpAtomAllocateTag</a> = AllocationTag;
00258     <span class="keywordflow">return</span> STATUS_SUCCESS;
00259 }
00260 
00261 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00262"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a13">00262</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a13">RtlCreateAtomTable</a>(
00263     IN ULONG NumberOfBuckets,
00264     OUT PVOID *AtomTableHandle
00265     )
00266 {
00267     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00268     PRTL_ATOM_TABLE p;
00269     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00270 
00271     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00272     <span class="keywordflow">if</span> (*AtomTableHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273         <span class="keywordflow">if</span> (NumberOfBuckets &lt;= 1) {
00274             NumberOfBuckets = RTL_ATOM_TABLE_DEFAULT_NUMBER_OF_BUCKETS;
00275             }
00276 
00277         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>( RTL_ATOM_TABLE ) +
00278                (<span class="keyword">sizeof</span>( RTL_ATOM_TABLE_ENTRY ) * (NumberOfBuckets-1));
00279 
00280         p = (PRTL_ATOM_TABLE)<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a1">RtlpAllocateAtom</a>( <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00281         <span class="keywordflow">if</span> (p == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00282             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00283             }
00284         <span class="keywordflow">else</span> {
00285             RtlZeroMemory( p, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00286             p-&gt;NumberOfBuckets = NumberOfBuckets;
00287             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a7">RtlpInitializeHandleTableForAtomTable</a>( p )) {
00288                 <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a3">RtlpInitializeLockAtomTable</a>( p );
00289                 p-&gt;Signature = RTL_ATOM_TABLE_SIGNATURE;
00290                 *AtomTableHandle = p;
00291                 }
00292             <span class="keywordflow">else</span> {
00293                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00294                 <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( p );
00295                 }
00296             }
00297         }
00298 
00299     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00300 }
00301 
00302 
00303 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00304"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">00304</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a14">RtlDestroyAtomTable</a>(
00305     IN PVOID AtomTableHandle
00306     )
00307 {
00308     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00309     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00310     PRTL_ATOM_TABLE_ENTRY a, aNext, *pa;
00311     ULONG i;
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00314     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00315         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00316         }
00317     <span class="keywordflow">try</span> {
00318         pa = &amp;p-&gt;Buckets[ 0 ];
00319         <span class="keywordflow">for</span> (i=0; i&lt;p-&gt;NumberOfBuckets; i++) {
00320             aNext = *pa;
00321             *pa++ = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00322             <span class="keywordflow">while</span> ((a = aNext) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323                 aNext = a-&gt;HashLink;
00324                 a-&gt;HashLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00325                 <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( a );
00326                 }
00327             }
00328         p-&gt;Signature = 0;
00329         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00330 
00331         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a8">RtlpDestroyHandleTableForAtomTable</a>( p );
00332         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a6">RtlpDestroyLockAtomTable</a>( p );
00333         RtlZeroMemory( p, <span class="keyword">sizeof</span>( RTL_ATOM_TABLE ) );
00334         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( p );
00335         }
00336     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00337         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00338         }
00339 
00340     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00341 }
00342 
00343 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00344"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a15">00344</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a15">RtlEmptyAtomTable</a>(
00345     IN PVOID AtomTableHandle,
00346     IN BOOLEAN IncludePinnedAtoms
00347     )
00348 {
00349     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00350     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00351     PRTL_ATOM_TABLE_ENTRY a, aNext, *pa, *pa1;
00352     ULONG i;
00353 
00354     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00355     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00356         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00357         }
00358     <span class="keywordflow">try</span> {
00359         pa = &amp;p-&gt;Buckets[ 0 ];
00360         <span class="keywordflow">for</span> (i=0; i&lt;p-&gt;NumberOfBuckets; i++) {
00361             pa1 = pa++;
00362             <span class="keywordflow">while</span> ((a = *pa1) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00363                 <span class="keywordflow">if</span> (IncludePinnedAtoms || !(a-&gt;Flags &amp; RTL_ATOM_PINNED)) {
00364                     *pa1 = a-&gt;HashLink;
00365                     a-&gt;HashLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00366                     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a11">RtlpFreeHandleForAtom</a>( p, a );
00367                     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( a );
00368                     }
00369                 <span class="keywordflow">else</span> {
00370                     pa1 = &amp;a-&gt;HashLink;
00371                     }
00372                 }
00373             }
00374 
00375         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00376         }
00377     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00378         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00379         }
00380 
00381     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00382 }
00383 
00384 BOOLEAN
<a name="l00385"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a16">00385</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a16">RtlpGetIntegerAtom</a>(
00386     PWSTR Name,
00387     PRTL_ATOM Atom OPTIONAL
00388     )
00389 {
00390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00391     UNICODE_STRING UnicodeString;
00392     PWSTR s;
00393     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00394     RTL_ATOM Temp;
00395 
00396     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> &amp; -0x10000) == 0) {
00397         Temp = (RTL_ATOM)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PtrToUlong(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00398         <span class="keywordflow">if</span> (Temp &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00399             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00400             }
00401         <span class="keywordflow">else</span> {
00402             <span class="keywordflow">if</span> (Temp == RTL_ATOM_INVALID_ATOM) {
00403                 Temp = RTL_ATOM_MAXIMUM_INTEGER_ATOM;
00404                 }
00405 
00406             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00407                 *Atom = Temp;
00408                 }
00409 
00410             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00411             }
00412         }
00413     <span class="keywordflow">else</span>
00414     <span class="keywordflow">if</span> (*<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'#'</span>) {
00415         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00416         }
00417 
00418     s = ++<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00419     <span class="keywordflow">while</span> (*s != UNICODE_NULL) {
00420         <span class="keywordflow">if</span> (*s &lt; L'0' || *s &gt; <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>) {
00421             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00422             }
00423         <span class="keywordflow">else</span> {
00424             s++;
00425             }
00426         }
00427 
00428     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0;
00429     UnicodeString.Buffer = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00430     UnicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PCHAR)s - (PCHAR)<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00431     UnicodeString.MaximumLength = UnicodeString.Length;
00432     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>( &amp;UnicodeString, 10, &amp;<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> );
00433     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00434         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00435             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> == 0 || <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt; RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00436                 *Atom = RTL_ATOM_MAXIMUM_INTEGER_ATOM;
00437                 }
00438             <span class="keywordflow">else</span> {
00439                 *Atom = (RTL_ATOM)<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00440                 }
00441             }
00442 
00443         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444         }
00445     <span class="keywordflow">else</span> {
00446         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00447         }
00448 }
00449 
00450 PRTL_ATOM_TABLE_ENTRY
<a name="l00451"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a17">00451</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a17">RtlpHashStringToAtom</a>(
00452     IN PRTL_ATOM_TABLE p,
00453     IN PWSTR Name,
00454     OUT PRTL_ATOM_TABLE_ENTRY **PreviousAtom OPTIONAL,
00455     OUT PULONG NameLength
00456     )
00457 {
00458     ULONG Length, Hash;
00459     WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00460     PWCH s;
00461     RTL_ATOM Atom;
00462     PRTL_ATOM_TABLE_ENTRY *pa, a;
00463 
00464     <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> &amp; -0x10000) == 0) {
00465         Atom = (RTL_ATOM)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PtrToUlong(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00466         a = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         <span class="keywordflow">if</span> (Atom &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00468             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>( p,
00469                                               (ULONG)(Atom &amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~RTL_ATOM_MAXIMUM_INTEGER_ATOM)
00470                                             );
00471             }
00472 
00473         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PreviousAtom )) {
00474             *PreviousAtom = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475             }
00476 
00477         <span class="keywordflow">return</span> a;
00478         }
00479 
00480     s = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00481     Hash = 0;
00482     <span class="keywordflow">while</span> (*s != UNICODE_NULL) {
00483         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>( *s++ );
00484         Hash = Hash + (c &lt;&lt; 1) + (c &gt;&gt; 1) + <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00485         }
00486     Length = (ULONG) (s - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00487     <span class="keywordflow">if</span> (Length &gt; RTL_ATOM_MAXIMUM_NAME_LENGTH) {
00488         pa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00489         a = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00490         }
00491     <span class="keywordflow">else</span> {
00492         pa = &amp;p-&gt;Buckets[ Hash % p-&gt;NumberOfBuckets ];
00493         <span class="keywordflow">while</span> (a = *pa) {
00494             <span class="keywordflow">if</span> (a-&gt;NameLength == Length &amp;&amp; !_wcsicmp( a-&gt;Name, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> )) {
00495                 <span class="keywordflow">break</span>;
00496                 }
00497             <span class="keywordflow">else</span> {
00498                 pa = &amp;a-&gt;HashLink;
00499                 }
00500             }
00501         }
00502 
00503     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PreviousAtom )) {
00504         *PreviousAtom = pa;
00505         }
00506 
00507     <span class="keywordflow">if</span> (a == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ARGUMENT_PRESENT( NameLength )) {
00508         *NameLength = Length * <span class="keyword">sizeof</span>( WCHAR );
00509         }
00510 
00511     <span class="keywordflow">return</span> a;
00512 }
00513 
00514 
00515 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00516"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a18">00516</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a18">RtlAddAtomToAtomTable</a>(
00517     IN PVOID AtomTableHandle,
00518     IN PWSTR AtomName OPTIONAL,
00519     IN OUT PRTL_ATOM Atom OPTIONAL
00520     )
00521 {
00522     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00523     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00524     PRTL_ATOM_TABLE_ENTRY a, *pa;
00525     ULONG NameLength;
00526     RTL_ATOM Temp;
00527 
00528     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00529         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00530         }
00531     <span class="keywordflow">try</span> {
00532         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a16">RtlpGetIntegerAtom</a>( AtomName, &amp;Temp )) {
00533             <span class="keywordflow">if</span> (Temp &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00534                 Temp = RTL_ATOM_INVALID_ATOM;
00535                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00536                 }
00537             <span class="keywordflow">else</span> {
00538                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00539                 }
00540 
00541             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00542                 *Atom = Temp;
00543                 }
00544             }
00545         <span class="keywordflow">else</span>
00546         <span class="keywordflow">if</span> (*AtomName == UNICODE_NULL) {
00547             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00548             }
00549         <span class="keywordflow">else</span> {
00550             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a17">RtlpHashStringToAtom</a>( p, AtomName, &amp;pa, &amp;NameLength );
00551             <span class="keywordflow">if</span> (a == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00552                 <span class="keywordflow">if</span> (pa != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00553                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00554                     a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a1">RtlpAllocateAtom</a>( FIELD_OFFSET( RTL_ATOM_TABLE_ENTRY, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> ) +
00555                                           NameLength + <span class="keyword">sizeof</span>( UNICODE_NULL )
00556                                         );
00557                     <span class="keywordflow">if</span> (a != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00558                         a-&gt;HashLink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00559                         a-&gt;ReferenceCount = 1;
00560                         a-&gt;Flags = 0;
00561                         RtlMoveMemory( a-&gt;Name, AtomName, NameLength );
00562                         a-&gt;NameLength = (UCHAR)(NameLength / <span class="keyword">sizeof</span>( WCHAR ));
00563                         a-&gt;Name[ a-&gt;NameLength ] = UNICODE_NULL;
00564                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a10">RtlpCreateHandleForAtom</a>( p, a )) {
00565                             a-&gt;Atom = (RTL_ATOM)a-&gt;HandleIndex | RTL_ATOM_MAXIMUM_INTEGER_ATOM;
00566                             *pa = a;
00567                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00568                                 *Atom = a-&gt;Atom;
00569                                 }
00570 
00571                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00572                             }
00573                         <span class="keywordflow">else</span> {
00574                             <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( a );
00575                             }
00576                         }
00577                     }
00578                 <span class="keywordflow">else</span> {
00579                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00580                     }
00581                 }
00582             <span class="keywordflow">else</span> {
00583                 <span class="keywordflow">if</span> (!(a-&gt;Flags &amp; RTL_ATOM_PINNED)) {
00584                     <span class="keywordflow">if</span> (a-&gt;ReferenceCount == 0xFFFF) {
00585                         KdPrint(( <span class="stringliteral">"RTL: Pinning atom (%x) as reference count about to wrap\n"</span>, Atom ));
00586                         a-&gt;Flags |= RTL_ATOM_PINNED;
00587                         }
00588                     <span class="keywordflow">else</span> {
00589                         a-&gt;ReferenceCount += 1;
00590                         }
00591                     }
00592 
00593                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00594                     *Atom = a-&gt;Atom;
00595                     }
00596 
00597                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00598                 }
00599             }
00600         }
00601     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00602         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00603         }
00604 
00605     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00606 
00607     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00608 }
00609 
00610 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00611"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a19">00611</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a19">RtlLookupAtomInAtomTable</a>(
00612     IN PVOID AtomTableHandle,
00613     IN PWSTR AtomName,
00614     OUT PRTL_ATOM Atom OPTIONAL
00615     )
00616 {
00617     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00618     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00619     PRTL_ATOM_TABLE_ENTRY a;
00620     RTL_ATOM Temp;
00621 
00622     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00623         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00624         }
00625     <span class="keywordflow">try</span> {
00626         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a16">RtlpGetIntegerAtom</a>( AtomName, &amp;Temp )) {
00627             <span class="keywordflow">if</span> (Temp &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00628                 Temp = RTL_ATOM_INVALID_ATOM;
00629                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00630                 }
00631             <span class="keywordflow">else</span> {
00632                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00633                 }
00634 
00635             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00636                 *Atom = Temp;
00637                 }
00638             }
00639         <span class="keywordflow">else</span>
00640         <span class="keywordflow">if</span> (*AtomName == UNICODE_NULL) {
00641             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00642             }
00643         <span class="keywordflow">else</span> {
00644             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a17">RtlpHashStringToAtom</a>( p, AtomName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00645             <span class="keywordflow">if</span> (a == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00646                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00647                 }
00648             <span class="keywordflow">else</span> {
00649                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>( p, (ULONG)a-&gt;HandleIndex ) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00651                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Atom )) {
00652                         *Atom = a-&gt;Atom;
00653                         }
00654                     }
00655                 <span class="keywordflow">else</span> {
00656                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00657                     }
00658                 }
00659             }
00660         }
00661     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00662         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00663         }
00664 
00665     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00666 
00667     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00668 }
00669 
00670 
00671 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00672"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a20">00672</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a20">RtlDeleteAtomFromAtomTable</a>(
00673     IN PVOID AtomTableHandle,
00674     IN RTL_ATOM Atom
00675     )
00676 {
00677     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00678     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00679     PRTL_ATOM_TABLE_ENTRY a, *pa;
00680 
00681     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00682         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00683         }
00684     <span class="keywordflow">try</span> {
00685         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00686         <span class="keywordflow">if</span> (Atom &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00687             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>( p,
00688                                               (ULONG)(Atom &amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~RTL_ATOM_MAXIMUM_INTEGER_ATOM)
00689                                             );
00690             <span class="keywordflow">if</span> (a != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; a-&gt;Atom == Atom) {
00691                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00692                 <span class="keywordflow">if</span> (a-&gt;Flags &amp; RTL_ATOM_PINNED) {
00693                     KdPrint(( <span class="stringliteral">"RTL: Ignoring attempt to delete a pinned atom (%x)\n"</span>, Atom ));
00694                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_WAS_LOCKED;        <span class="comment">// This is a success status code!</span>
00695                     }
00696                 <span class="keywordflow">else</span>
00697                 <span class="keywordflow">if</span> (--a-&gt;ReferenceCount == 0) {
00698                     a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a17">RtlpHashStringToAtom</a>( p, a-&gt;Name, &amp;pa, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00699                     <span class="keywordflow">if</span> (a != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00700                         *pa = a-&gt;HashLink;
00701                         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a11">RtlpFreeHandleForAtom</a>( p, a );
00702                         <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a2">RtlpFreeAtom</a>( a );
00703                         }
00704                     }
00705                 }
00706             }
00707         <span class="keywordflow">else</span>
00708         <span class="keywordflow">if</span> (Atom != RTL_ATOM_INVALID_ATOM) {
00709             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00710             }
00711         }
00712     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00713         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00714         }
00715 
00716     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00717 
00718     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00719 }
00720 
00721 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00722"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a21">00722</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a21">RtlPinAtomInAtomTable</a>(
00723     IN PVOID AtomTableHandle,
00724     IN RTL_ATOM Atom
00725     )
00726 {
00727     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00728     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00729     PRTL_ATOM_TABLE_ENTRY a, *pa;
00730 
00731     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00732         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00733         }
00734     <span class="keywordflow">try</span> {
00735         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00736         <span class="keywordflow">if</span> (Atom &gt;= RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00737             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>( p,
00738                                               (ULONG)(Atom &amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~RTL_ATOM_MAXIMUM_INTEGER_ATOM)
00739                                             );
00740             <span class="keywordflow">if</span> (a != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; a-&gt;Atom == Atom) {
00741                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00742                 a-&gt;Flags |= RTL_ATOM_PINNED;
00743                 }
00744             }
00745         <span class="keywordflow">else</span>
00746         <span class="keywordflow">if</span> (Atom != RTL_ATOM_INVALID_ATOM) {
00747             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00748             }
00749         }
00750     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00751         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00752         }
00753 
00754     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00755 
00756     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00757 }
00758 
00759 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00760"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a22">00760</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a22">RtlQueryAtomInAtomTable</a>(
00761     IN PVOID AtomTableHandle,
00762     IN RTL_ATOM Atom,
00763     OUT PULONG AtomUsage OPTIONAL,
00764     OUT PULONG AtomFlags OPTIONAL,
00765     IN OUT PWSTR AtomName OPTIONAL,
00766     IN OUT PULONG AtomNameLength OPTIONAL
00767     )
00768 {
00769     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00770     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00771     PRTL_ATOM_TABLE_ENTRY a;
00772     WCHAR AtomNameBuffer[ 16 ];
00773     ULONG CopyLength;
00774 
00775     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00776         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00777         }
00778     <span class="keywordflow">try</span> {
00779         <span class="keywordflow">if</span> (Atom &lt; RTL_ATOM_MAXIMUM_INTEGER_ATOM) {
00780             <span class="keywordflow">if</span> (Atom == RTL_ATOM_INVALID_ATOM) {
00781                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00782                 }
00783             <span class="keywordflow">else</span> {
00784                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00785                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomUsage )) {
00786                     *AtomUsage = 1;
00787                     }
00788 
00789                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomFlags )) {
00790                     *AtomFlags = RTL_ATOM_PINNED;
00791                     }
00792 
00793                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00794                     CopyLength = _snwprintf( AtomNameBuffer,
00795                                              <span class="keyword">sizeof</span>( AtomNameBuffer ) / <span class="keyword">sizeof</span>( WCHAR ),
00796                                              <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"#%u"</span>,
00797                                              Atom
00798                                            ) * <span class="keyword">sizeof</span>( WCHAR );
00799                     <span class="keywordflow">if</span> (CopyLength &gt;= *AtomNameLength) {
00800                         <span class="keywordflow">if</span> (*AtomNameLength &gt;= <span class="keyword">sizeof</span>( UNICODE_NULL )) {
00801                             CopyLength = *AtomNameLength - <span class="keyword">sizeof</span>( UNICODE_NULL );
00802                             }
00803                         <span class="keywordflow">else</span> {
00804                             CopyLength = 0;
00805                             }
00806                         }
00807 
00808                     <span class="keywordflow">if</span> (CopyLength != 0) {
00809                         RtlMoveMemory( AtomName, AtomNameBuffer, CopyLength );
00810                         AtomName[ CopyLength / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00811                         *AtomNameLength = CopyLength;
00812                         }
00813                     <span class="keywordflow">else</span> {
00814                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00815                         }
00816                     }
00817                 }
00818             }
00819         <span class="keywordflow">else</span> {
00820             a = <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a9">RtlpAtomMapAtomToHandleEntry</a>( p,
00821                                               (ULONG)(Atom &amp; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)~RTL_ATOM_MAXIMUM_INTEGER_ATOM)
00822                                             );
00823             <span class="keywordflow">if</span> (a != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; a-&gt;Atom == Atom) {
00824                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00825                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomUsage )) {
00826                     *AtomUsage = a-&gt;ReferenceCount;
00827                     }
00828 
00829                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomFlags )) {
00830                     *AtomFlags = a-&gt;Flags;
00831                     }
00832 
00833                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AtomName )) {
00834                     <span class="comment">//</span>
00835                     <span class="comment">// Fill in as much of the atom string as possible, and</span>
00836                     <span class="comment">// always zero terminate. This is what win3.1 does.</span>
00837                     <span class="comment">//</span>
00838 
00839                     CopyLength = a-&gt;NameLength * <span class="keyword">sizeof</span>( WCHAR );
00840                     <span class="keywordflow">if</span> (CopyLength &gt;= *AtomNameLength) {
00841                         <span class="keywordflow">if</span> (*AtomNameLength &gt;= <span class="keyword">sizeof</span>( UNICODE_NULL )) {
00842                             CopyLength = *AtomNameLength - <span class="keyword">sizeof</span>( UNICODE_NULL );
00843                             }
00844                         <span class="keywordflow">else</span> {
00845                             *AtomNameLength = CopyLength;
00846                             CopyLength = 0;
00847                             }
00848                         }
00849                     <span class="keywordflow">if</span> (CopyLength != 0) {
00850                         RtlMoveMemory( AtomName, a-&gt;Name, CopyLength );
00851                         AtomName[ CopyLength / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00852                         *AtomNameLength = CopyLength;
00853                         }
00854                     <span class="keywordflow">else</span> {
00855                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00856                         }
00857                     }
00858                 }
00859             <span class="keywordflow">else</span> {
00860                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00861                 }
00862             }
00863         }
00864     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00865         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00866         }
00867 
00868     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00869 
00870     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00871 }
00872 
00873 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00874"></a><a class="code" href="../../d0/d0/rtl_2atom_8c.html#a23">00874</a> <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a23">RtlQueryAtomsInAtomTable</a>(
00875     IN PVOID AtomTableHandle,
00876     IN ULONG MaximumNumberOfAtoms,
00877     OUT PULONG NumberOfAtoms,
00878     OUT PRTL_ATOM Atoms
00879     )
00880 {
00881     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00882     PRTL_ATOM_TABLE p = (PRTL_ATOM_TABLE)AtomTableHandle;
00883     PRTL_ATOM_TABLE_ENTRY a;
00884     ULONG i;
00885     ULONG CurrentAtomIndex;
00886 
00887     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/rtl_2atom_8c.html#a4">RtlpLockAtomTable</a>( p )) {
00888         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00889         }
00890 
00891     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00892     <span class="keywordflow">try</span> {
00893         CurrentAtomIndex = 0;
00894         <span class="keywordflow">for</span> (i=0; i&lt;p-&gt;NumberOfBuckets; i++) {
00895             a = p-&gt;Buckets[ i ];
00896             <span class="keywordflow">while</span> (a) {
00897                 <span class="keywordflow">if</span> (CurrentAtomIndex &lt; MaximumNumberOfAtoms) {
00898                     Atoms[ CurrentAtomIndex ] = a-&gt;Atom;
00899                     }
00900                 <span class="keywordflow">else</span> {
00901                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
00902                     }
00903 
00904                 CurrentAtomIndex += 1;
00905                 a = a-&gt;HashLink;
00906                 }
00907             }
00908 
00909         *NumberOfAtoms = CurrentAtomIndex;
00910         }
00911     except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00912         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00913         }
00914 
00915     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a5">RtlpUnlockAtomTable</a>( p );
00916 
00917     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00918 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
