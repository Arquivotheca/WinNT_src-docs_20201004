<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heaptag.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heaptag.c</h1><a href="../../d0/d0/heaptag_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1992  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    heaptag.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the support routines needed for FLG_HEAP_ENABLE_TAG_BY_DLL</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 07-Apr-1995</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00022 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00023 <span class="preprocessor">#include &lt;<a class="code" href="../../d8/d6/stktrace_8h.html">stktrace.h</a>&gt;</span>
00024 <span class="preprocessor">#include &lt;<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>&gt;</span>
00025 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00026 
<a name="l00027"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a0">00027</a> <span class="preprocessor">#define LDRP_MAXIMUM_DLL_TAGS 64</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a2">00029</a> BOOLEAN <a class="code" href="../../d0/d0/heaptag_8c.html#a2">LdrpDllTagsInitialized</a>;
<a name="l00030"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a3">00030</a> ULONG <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a>;
<a name="l00031"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a4">00031</a> ULONG <a class="code" href="../../d0/d0/heaptag_8c.html#a4">LdrpBaseDllTag</a>;
<a name="l00032"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a5">00032</a> ULONG <a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a0">LDRP_MAXIMUM_DLL_TAGS</a> ];
00033 
<a name="l00034"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a1">00034</a> <span class="preprocessor">#define DEFINE_HEAPTAG_ENTRY( n ) \</span>
00035 <span class="preprocessor">PVOID LdrpTagAllocateHeap##n( PVOID h, ULONG f, ULONG s ) {return LdrpTagAllocateHeap( h, f, s, n ); }</span>
00036 <span class="preprocessor"></span>
00037 PVOID
<a name="l00038"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a8">00038</a> <a class="code" href="../../d0/d0/heaptag_8c.html#a8">LdrpTagAllocateHeap</a>(
00039     IN PVOID HeapHandle,
00040     IN ULONG Flags,
00041     IN ULONG Size,
00042     IN ULONG n
00043     )
00044 {
00045     <span class="keywordflow">if</span> ((Flags &amp; HEAP_TAG_MASK) == 0) {
00046         Flags |= <a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> ];
00047         }
00048 
00049     <span class="keywordflow">return</span> <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, Flags, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
00050 }
00051 
00052 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  0 );
00053 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  1 );
00054 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  2 );
00055 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  3 );
00056 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  4 );
00057 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  5 );
00058 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  6 );
00059 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  7 );
00060 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  8 );
00061 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>(  9 );
00062 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 10 );
00063 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 11 );
00064 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 12 );
00065 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 13 );
00066 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 14 );
00067 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 15 );
00068 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 16 );
00069 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 17 );
00070 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 18 );
00071 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 19 );
00072 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 20 );
00073 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 21 );
00074 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 22 );
00075 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 23 );
00076 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 24 );
00077 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 25 );
00078 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 26 );
00079 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 27 );
00080 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 28 );
00081 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 29 );
00082 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 30 );
00083 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 31 );
00084 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 32 );
00085 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 33 );
00086 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 34 );
00087 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 35 );
00088 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 36 );
00089 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 37 );
00090 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 38 );
00091 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 39 );
00092 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 40 );
00093 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 41 );
00094 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 42 );
00095 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 43 );
00096 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 44 );
00097 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 45 );
00098 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 46 );
00099 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 47 );
00100 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 48 );
00101 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 49 );
00102 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 50 );
00103 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 51 );
00104 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 52 );
00105 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 53 );
00106 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 54 );
00107 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 55 );
00108 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 56 );
00109 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 57 );
00110 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 58 );
00111 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 59 );
00112 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 60 );
00113 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 61 );
00114 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 62 );
00115 <a class="code" href="../../d0/d0/heaptag_8c.html#a1">DEFINE_HEAPTAG_ENTRY</a>( 63 );
00116 
<a name="l00117"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a6">00117</a> <span class="keyword">typedef</span> PVOID (*<a class="code" href="../../d0/d0/heaptag_8c.html#a6">PLDRP_DLL_TAG_PROCEDURE</a>)(
00118     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>,
00119     ULONG Flags,
00120     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00121     );
00122 
<a name="l00123"></a><a class="code" href="../../d0/d0/heaptag_8c.html#a7">00123</a> <span class="keyword">const</span> <a class="code" href="../../d0/d0/heaptag_8c.html#a6">PLDRP_DLL_TAG_PROCEDURE</a> <a class="code" href="../../d0/d0/heaptag_8c.html#a7">LdrpDllTagProcedures</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a0">LDRP_MAXIMUM_DLL_TAGS</a> ] = {
00124     LdrpTagAllocateHeap0,
00125     LdrpTagAllocateHeap1,
00126     LdrpTagAllocateHeap2,
00127     LdrpTagAllocateHeap3,
00128     LdrpTagAllocateHeap4,
00129     LdrpTagAllocateHeap5,
00130     LdrpTagAllocateHeap6,
00131     LdrpTagAllocateHeap7,
00132     LdrpTagAllocateHeap8,
00133     LdrpTagAllocateHeap9,
00134     LdrpTagAllocateHeap10,
00135     LdrpTagAllocateHeap11,
00136     LdrpTagAllocateHeap12,
00137     LdrpTagAllocateHeap13,
00138     LdrpTagAllocateHeap14,
00139     LdrpTagAllocateHeap15,
00140     LdrpTagAllocateHeap16,
00141     LdrpTagAllocateHeap17,
00142     LdrpTagAllocateHeap18,
00143     LdrpTagAllocateHeap19,
00144     LdrpTagAllocateHeap20,
00145     LdrpTagAllocateHeap21,
00146     LdrpTagAllocateHeap22,
00147     LdrpTagAllocateHeap23,
00148     LdrpTagAllocateHeap24,
00149     LdrpTagAllocateHeap25,
00150     LdrpTagAllocateHeap26,
00151     LdrpTagAllocateHeap27,
00152     LdrpTagAllocateHeap28,
00153     LdrpTagAllocateHeap29,
00154     LdrpTagAllocateHeap30,
00155     LdrpTagAllocateHeap31,
00156     LdrpTagAllocateHeap32,
00157     LdrpTagAllocateHeap33,
00158     LdrpTagAllocateHeap34,
00159     LdrpTagAllocateHeap35,
00160     LdrpTagAllocateHeap36,
00161     LdrpTagAllocateHeap37,
00162     LdrpTagAllocateHeap38,
00163     LdrpTagAllocateHeap39,
00164     LdrpTagAllocateHeap40,
00165     LdrpTagAllocateHeap41,
00166     LdrpTagAllocateHeap42,
00167     LdrpTagAllocateHeap43,
00168     LdrpTagAllocateHeap44,
00169     LdrpTagAllocateHeap45,
00170     LdrpTagAllocateHeap46,
00171     LdrpTagAllocateHeap47,
00172     LdrpTagAllocateHeap48,
00173     LdrpTagAllocateHeap49,
00174     LdrpTagAllocateHeap50,
00175     LdrpTagAllocateHeap51,
00176     LdrpTagAllocateHeap52,
00177     LdrpTagAllocateHeap53,
00178     LdrpTagAllocateHeap54,
00179     LdrpTagAllocateHeap55,
00180     LdrpTagAllocateHeap56,
00181     LdrpTagAllocateHeap57,
00182     LdrpTagAllocateHeap58,
00183     LdrpTagAllocateHeap59,
00184     LdrpTagAllocateHeap60,
00185     LdrpTagAllocateHeap61,
00186     LdrpTagAllocateHeap62,
00187     LdrpTagAllocateHeap63
00188 };
00189 
00190 PVOID
<a name="l00191"></a><a class="code" href="../../d9/d2/ldrp_8h.html#a87">00191</a> <a class="code" href="../../d9/d2/ldrp_8h.html#a87">LdrpDefineDllTag</a>(
00192     PWSTR TagName,
00193     PUSHORT TagIndex
00194     )
00195 {
00196     PVOID Result;
00197     WCHAR TagNameBuffer[ 260 ];
00198 
00199     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap( ), HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a> ));
00201         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00202             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203         }
00204     }
00205     
00206     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/heaptag_8c.html#a2">LdrpDllTagsInitialized</a>) {
00207         <span class="comment">//</span>
00208         <span class="comment">// Keep QUERY.C happy</span>
00209         <span class="comment">//</span>
00210         InitializeListHead( &amp;<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o21">VirtualAllocdBlocks</a> );
00211         <a class="code" href="../../d0/d0/heaptag_8c.html#a2">LdrpDllTagsInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00212         }
00213 
00214     Result = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00215     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> &lt; <a class="code" href="../../d0/d0/heaptag_8c.html#a0">LDRP_MAXIMUM_DLL_TAGS</a>) {
00216         memset( TagNameBuffer, 0, <span class="keyword">sizeof</span>( TagNameBuffer ) );
00217         wcscpy( TagNameBuffer, TagName );
00218         <a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] =
00219             <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00220                               0,
00221                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00222                               TagNameBuffer
00223                             );
00224 
00225         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] != 0) {
00226             Result = <a class="code" href="../../d0/d0/heaptag_8c.html#a7">LdrpDllTagProcedures</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ];
00227             }
00228 
00229         <span class="keywordflow">if</span> (Result != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00230             *TagIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] &gt;&gt; HEAP_TAG_SHIFT);
00231             <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> += 1;
00232             }
00233         }
00234 
00235     <span class="keywordflow">return</span> Result;
00236 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
