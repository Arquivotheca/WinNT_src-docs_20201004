<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: shutdown.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>shutdown.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d2/d8/shutdown_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/shutdown_8c.html#a2">MmReleaseAllMemory</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/shutdown_8c.html#a3">MmShutdownSystem</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/shutdown_8c.html#a0">MmSystemShutdown</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/shutdown_8c.html#a1">MmZeroPageFile</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="shutdown.c::MmReleaseAllMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmReleaseAllMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="shutdown.c::MmShutdownSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmShutdownSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">41</a> of file <a class="el" href="../../d2/d8/shutdown_8c-source.html">shutdown.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02559">_MMPAGING_FILE::Bitmap</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02114">_SUBSECTION::ControlArea</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02560">_MMPAGING_FILE::File</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02070">_CONTROL_AREA::FilePointer</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10957">IoSynchronousPageWrite()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01430">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01823">MiCheckControlArea()</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01177">MiRemoveZeroPage()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l00916">MiStartingOffset()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00121">MM_MAXIMUM_WRITE_CLUSTER</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00056">MmNumberOfPagingFiles</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05083">MmPagingFile</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l00094">MmSystemShutdown</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00214">MmTwentySeconds</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00114">MmZeroPageFile</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02062">_CONTROL_AREA::NumberOfMappedViews</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02061">_CONTROL_AREA::NumberOfPfnReferences</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02550">_MMPAGING_FILE::Size</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d8/d7/struct__CONTROL__AREA.html#o10">_CONTROL_AREA::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a217">WrPageOut</a>.
<p>
<pre class="fragment"><div>00047                    :
00048 
00049     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shutdown of memory management.  This
00050     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by writing <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all modified pages which are
00051     destined <span class="keywordflow">for</span> files other than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00052 
00053 Arguments:
00054 
00055     None.
00056 
00057 Return Value:
00058 
00059     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages were successfully written, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00060 
00061 --*/
00062 
00063 {
00064     PFN_NUMBER ModifiedPage;
00065     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00066     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00067     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00068     PPFN_NUMBER Page;
00069     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + <a class="code" href="../../d4/d8/mi_8h.html#a33">MM_MAXIMUM_WRITE_CLUSTER</a>];
00070     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00072     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> IoEvent;
00073     IO_STATUS_BLOCK IoStatus;
00074     KIRQL OldIrql;
00075     LARGE_INTEGER StartingOffset;
00076     ULONG count;
00077     PFN_NUMBER j;
00078     ULONG k;
00079     PFN_NUMBER first;
00080     ULONG write;
00081     <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a> PagingFile;
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// Don't do this more than once.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a>) {
00088 
00089         <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00090 
00091         Mdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)&amp;MdlHack;
00092         Page = (PPFN_NUMBER)(Mdl + 1);
00093 
00094         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;IoEvent, NotificationEvent, FALSE);
00095 
00096         <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl,
00097                         NULL,
00098                         PAGE_SIZE);
00099 
00100         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
00101 
00102         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00103 
00104         ModifiedPage = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00105         <span class="keywordflow">while</span> (ModifiedPage != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
00106 
00107             <span class="comment">//</span>
00108             <span class="comment">// There are modified pages.</span>
00109             <span class="comment">//</span>
00110 
00111             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ModifiedPage);
00112 
00113             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00114 
00115                 <span class="comment">//</span>
00116                 <span class="comment">// This page is destined for a file.</span>
00117                 <span class="comment">//</span>
00118 
00119                 Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
00120                 ControlArea = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>;
00121                 <span class="keywordflow">if</span> ((!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) &amp;&amp;
00122                    (!ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting)) {
00123 
00124                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
00125 
00126                     <span class="comment">//</span>
00127                     <span class="comment">// Issue the write.</span>
00128                     <span class="comment">//</span>
00129 
00130                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
00131 
00132                     <span class="comment">//</span>
00133                     <span class="comment">// Up the reference count for the physical page as there</span>
00134                     <span class="comment">// is I/O in progress.</span>
00135                     <span class="comment">//</span>
00136 
00137                     <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 26);
00138                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
00139 
00140                     *Page = ModifiedPage;
00141                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> += 1;
00142                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
00143 
00144                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00145 
00146                     StartingOffset.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection,
00147                                                                   Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>);
00148 
00149                     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)ULongToPtr(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor &lt;&lt; PAGE_SHIFT);
00150                     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
00151                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (
00152                                             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
00153                                             Mdl,
00154                                             &amp;StartingOffset,
00155                                             &amp;IoEvent,
00156                                             &amp;IoStatus );
00157 
00158                     <span class="comment">//</span>
00159                     <span class="comment">// Ignore all I/O failures - there is nothing that can be</span>
00160                     <span class="comment">// done at this point.</span>
00161                     <span class="comment">//</span>
00162 
00163                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00164                         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;IoEvent, 0, FALSE);
00165                     }
00166 
00167                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;IoEvent,
00168                                                     WrPageOut,
00169                                                     KernelMode,
00170                                                     FALSE,
00171                                                     (PLARGE_INTEGER)&amp;MmTwentySeconds);
00172 
00173                     <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
00174                         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
00175                     }
00176 
00177                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
00178 
00179                         <span class="comment">//</span>
00180                         <span class="comment">// The write did not complete in 20 seconds, assume</span>
00181                         <span class="comment">// that the file systems are hung and return an</span>
00182                         <span class="comment">// error.</span>
00183                         <span class="comment">//</span>
00184 
00185                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00186                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
00187                         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 27);
00188                         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (ModifiedPage);
00189                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00190                         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
00191 
00192                         <span class="comment">//</span>
00193                         <span class="comment">// This routine returns with the PFN lock released!</span>
00194                         <span class="comment">//</span>
00195 
00196                         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00197 
00198                         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00199 
00200                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201                     }
00202 
00203                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00204                     <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 27);
00205                     <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (ModifiedPage);
00206                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00207                     ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> -= 1;
00208 
00209                     <span class="comment">//</span>
00210                     <span class="comment">// This routine returns with the PFN lock released!</span>
00211                     <span class="comment">//</span>
00212 
00213                     <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, NULL, OldIrql);
00214                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00215 
00216                     <span class="comment">//</span>
00217                     <span class="comment">// Restart scan at the front of the list.</span>
00218                     <span class="comment">//</span>
00219 
00220                     ModifiedPage = <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a>;
00221                     <span class="keywordflow">continue</span>;
00222                 }
00223             }
00224             ModifiedPage = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
00225         }
00226 
00227         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00228 
00229         <span class="comment">//</span>
00230         <span class="comment">// If a high number of modified pages still exist, start the</span>
00231         <span class="comment">// modified page writer and wait for 5 seconds.</span>
00232         <span class="comment">//</span>
00233 
00234         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> * 2)) {
00235             LARGE_INTEGER FiveSeconds = {(ULONG)(-5 * 1000 * 1000 * 10), -1};
00236 
00237             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00238             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
00239                                     FALSE,
00240                                     (PLARGE_INTEGER)&amp;FiveSeconds);
00241         }
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// Indicate to the modified page writer that the system has</span>
00245         <span class="comment">// shutdown.</span>
00246         <span class="comment">//</span>
00247 
00248         <a class="code" href="../../d6/d3/modwrite_8c.html#a17">MmSystemShutdown</a> = 1;
00249 
00250         <span class="comment">//</span>
00251         <span class="comment">// Check to see if the paging file should be overwritten.</span>
00252         <span class="comment">// Only free blocks are written.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a58">MmZeroPageFile</a>) {
00256 
00257             <span class="comment">//</span>
00258             <span class="comment">// Get pages to complete the write request.</span>
00259             <span class="comment">//</span>
00260 
00261             Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00262             j = 0;
00263             k = 0;
00264             Page = (PPFN_NUMBER)(Mdl + 1);
00265 
00266             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00267 
00268             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (<a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a> + 20)) {
00269                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a>(OldIrql);
00270                 <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00271                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00272             }
00273 
00274             <span class="keywordflow">do</span> {
00275                 *Page = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> ((ULONG)j);
00276                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
00277                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
00278                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
00279                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00280                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
00281                 Page += 1;
00282                 j += 1;
00283             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00284 
00285             <span class="keywordflow">while</span> (k &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>) {
00286 
00287                 PagingFile = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[k];
00288 
00289                 count = 0;
00290                 write = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00291 
00292                 <span class="keywordflow">for</span> (j = 1; j &lt; PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>; j += 1) {
00293 
00294                     <span class="keywordflow">if</span> (RtlCheckBit (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">Bitmap</a>, j) == 0) {
00295 
00296                         <span class="keywordflow">if</span> (count == 0) {
00297                             first = j;
00298                         }
00299                         count += 1;
00300                         <span class="keywordflow">if</span> (count == <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) {
00301                             write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00302                         }
00303                     } <span class="keywordflow">else</span> {
00304                         <span class="keywordflow">if</span> (count != 0) {
00305 
00306                             <span class="comment">//</span>
00307                             <span class="comment">// Issue a write.</span>
00308                             <span class="comment">//</span>
00309 
00310                             write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311                         }
00312                     }
00313 
00314                     <span class="keywordflow">if</span> ((j == (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a> - 1)) &amp;&amp;
00315                         (count != 0)) {
00316                         write = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00317                     }
00318 
00319                     <span class="keywordflow">if</span> (write) {
00320 
00321                         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00322 
00323                         StartingOffset.QuadPart = (LONGLONG)first &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00324                         Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = count &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00325                         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;IoEvent);
00326 
00327                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a116">IoSynchronousPageWrite</a> (PagingFile-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>,
00328                                                          Mdl,
00329                                                          &amp;StartingOffset,
00330                                                          &amp;IoEvent,
00331                                                          &amp;IoStatus);
00332 
00333                         <span class="comment">//</span>
00334                         <span class="comment">// Ignore all I/O failures - there is nothing that can</span>
00335                         <span class="comment">// be done at this point.</span>
00336                         <span class="comment">//</span>
00337 
00338                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00339                             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;IoEvent, 0, FALSE);
00340                         }
00341 
00342                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;IoEvent,
00343                                                         WrPageOut,
00344                                                         KernelMode,
00345                                                         FALSE,
00346                                                         (PLARGE_INTEGER)&amp;MmTwentySeconds);
00347 
00348                         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
00349                             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
00350                         }
00351 
00352                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_TIMEOUT) {
00353 
00354                             <span class="comment">//</span>
00355                             <span class="comment">// The write did not complete in 20 seconds, assume</span>
00356                             <span class="comment">// that the file systems are hung and return an</span>
00357                             <span class="comment">// error.</span>
00358                             <span class="comment">//</span>
00359 
00360                             j = 0;
00361                             Page = (PPFN_NUMBER)(Mdl + 1);
00362                             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00363                             <span class="keywordflow">do</span> {
00364                                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
00365                                 Page += 1;
00366                                 j += 1;
00367                             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00368                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00369 
00370                             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00371                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00372                         }
00373 
00374                         count = 0;
00375                         write = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00376                         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00377                     }
00378                 }
00379                 k += 1;
00380             }
00381             j = 0;
00382             Page = (PPFN_NUMBER)(Mdl + 1);
00383             <span class="keywordflow">do</span> {
00384                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
00385                 Page += 1;
00386                 j += 1;
00387             } <span class="keywordflow">while</span> (j &lt; <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>);
00388             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00389         }
00390         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00391     }
00392     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00393 }
}
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="shutdown.c::MmSystemShutdown" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d9/shutdown_8c.html#a0">MmSystemShutdown</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00025">25</a> of file <a class="el" href="../../d2/d8/shutdown_8c-source.html">shutdown.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02669">MiModifiedPageWriter()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02831">MiModifiedPageWriterWorker()</a>, and <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="shutdown.c::MmZeroPageFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d9/shutdown_8c.html#a1">MmZeroPageFile</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00037">37</a> of file <a class="el" href="../../d2/d8/shutdown_8c-source.html">shutdown.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
