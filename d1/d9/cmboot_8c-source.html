<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmboot.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmboot.c</h1><a href="../../d0/d0/cmboot_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmboot.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This provides routines for determining driver load lists from the</span>
00012 <span class="comment">    registry.  The relevant drivers are extracted from the registry,</span>
00013 <span class="comment">    sorted by groups, and then dependencies are resolved.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    This module is used both by the OS Loader for determining the boot</span>
00016 <span class="comment">    driver list (CmScanRegistry) and by IoInitSystem for determining</span>
00017 <span class="comment">    the drivers to be loaded in Phase 1 Initialization</span>
00018 <span class="comment">    (CmGetSystemDriverList)</span>
00019 <span class="comment"></span>
00020 <span class="comment">Author:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    John Vert (jvert) 7-Apr-1992</span>
00023 <span class="comment"></span>
00024 <span class="comment">Environment:</span>
00025 <span class="comment"></span>
00026 <span class="comment">    OS Loader environment</span>
00027 <span class="comment">        or</span>
00028 <span class="comment">    kernel mode</span>
00029 <span class="comment"></span>
00030 <span class="comment">Revision History:</span>
00031 <span class="comment"></span>
00032 <span class="comment">--*/</span>
00033 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="../../d6/d7/profiles_8h.html">profiles.h</a>&gt;</span>
00035 
<a name="l00036"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a0">00036</a> <span class="preprocessor">#define LOAD_LAST 0xffffffff</span>
<a name="l00037"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a1">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define LOAD_NEXT_TO_LAST (LOAD_LAST-1)</span>
00038 <span class="preprocessor"></span>
00039 <span class="comment">//</span>
00040 <span class="comment">// Private function prototypes.</span>
00041 <span class="comment">//</span>
00042 BOOLEAN
00043 <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(
00044     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00045     IN HCELL_INDEX DriverCell,
00046     IN HCELL_INDEX GroupOrderCell,
00047     IN PUNICODE_STRING RegistryPath,
00048     IN PLIST_ENTRY BootDriverListHead
00049     );
00050 
00051 BOOLEAN
00052 <a class="code" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a>(
00053     IN PLIST_ENTRY DriverListHead,
00054     IN PUNICODE_STRING OrderList
00055     );
00056 
00057 ULONG
00058 <a class="code" href="../../d0/d0/cmboot_8c.html#a6">CmpFindTagIndex</a>(
00059     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00060     IN HCELL_INDEX TagCell,
00061     IN HCELL_INDEX GroupOrderCell,
00062     IN PUNICODE_STRING GroupName
00063     );
00064 
00065 BOOLEAN
00066 <a class="code" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a>(
00067     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00068     IN HCELL_INDEX Cell,
00069     IN SERVICE_LOAD_TYPE LoadType
00070     );
00071 
00072 BOOLEAN
00073 <a class="code" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a>(
00074     IN <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart,
00075     IN <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd
00076     );
00077 
<a name="l00078"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a2">00078</a> <span class="preprocessor">#define CmpValueToData(Hive,Value,realsize)              \</span>
00079 <span class="preprocessor">    (CmpIsHKeyValueSmall(realsize,Value-&gt;DataLength) ?          \</span>
00080 <span class="preprocessor">     ((struct _CELL_DATA *)(&amp;Value-&gt;Data)) : HvGetCell(Hive,Value-&gt;Data))</span>
00081 <span class="preprocessor"></span>
00082 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00083 <a class="code" href="../../d0/d0/cmboot_8c.html#a9">BlPrint</a>(
00084     PCHAR cp,
00085     ...
00086     );
00087 
00088 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindNLSData)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindDrivers)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpIsLoadType)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAddDriverToList)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSortDriverList)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpDoSort)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpResolveDriverDependencies)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSetCurrentProfile)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpOrderGroup)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindControlSet)</span>
00099 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindTagIndex)</span>
00100 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpFindProfileOption)</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
00102 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetBiosDateFromRegistry)</span>
00103 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00105 <span class="preprocessor"></span>
00106 
00107 BOOLEAN
<a name="l00108"></a><a class="code" href="../../d1/d2/cmp_8h.html#a298">00108</a> <a class="code" href="../../d1/d2/cmp_8h.html#a298">CmpFindNLSData</a>(
00109     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00110     IN HCELL_INDEX ControlSet,
00111     OUT PUNICODE_STRING AnsiFilename,
00112     OUT PUNICODE_STRING OemFilename,
00113     OUT PUNICODE_STRING CaseTableFilename,
00114     OUT PUNICODE_STRING OemHalFont
00115     )
00116 
00117 <span class="comment">/*++</span>
00118 <span class="comment"></span>
00119 <span class="comment">Routine Description:</span>
00120 <span class="comment"></span>
00121 <span class="comment">    Traverses a particular control set and determines the filenames for</span>
00122 <span class="comment">    the NLS data files that need to be loaded.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Arguments:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    Hive - Supplies the hive control structure for the SYSTEM hive.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the root of the control set.</span>
00129 <span class="comment"></span>
00130 <span class="comment">    AnsiFileName - Returns the name of the Ansi codepage file (c_1252.nls)</span>
00131 <span class="comment"></span>
00132 <span class="comment">    OemFileName -  Returns the name of the OEM codepage file  (c_437.nls)</span>
00133 <span class="comment"></span>
00134 <span class="comment">    CaseTableFileName - Returns the name of the Unicode upper/lowercase</span>
00135 <span class="comment">            table for the language (l_intl.nls)</span>
00136 <span class="comment"></span>
00137 <span class="comment">    OemHalfont - Returns the name of the font file to be used by the HAL.</span>
00138 <span class="comment"></span>
00139 <span class="comment">Return Value:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    TRUE - filenames successfully determined</span>
00142 <span class="comment"></span>
00143 <span class="comment">    FALSE - hive is corrupt</span>
00144 <span class="comment"></span>
00145 <span class="comment">--*/</span>
00146 
00147 {
00148     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00149     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00150     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Nls;
00151     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CodePage;
00152     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Language;
00153     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00154     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00155     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00157     ULONG realsize;
00158 
00159     <span class="comment">//</span>
00160     <span class="comment">// Find CONTROL node</span>
00161     <span class="comment">//</span>
00162     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control"</span>);
00163     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00164                                  (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ControlSet),
00165                                  &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00166     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00167         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// Find NLS node</span>
00172     <span class="comment">//</span>
00173     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NLS"</span>);
00174     Nls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00175                              (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Control),
00176                              &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00177     <span class="keywordflow">if</span> (Nls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00178         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Find CodePage node</span>
00183     <span class="comment">//</span>
00184     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CodePage"</span>);
00185     CodePage = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00186                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Nls),
00187                                   &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00188     <span class="keywordflow">if</span> (CodePage == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00189         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Find ACP value</span>
00194     <span class="comment">//</span>
00195     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ACP"</span>);
00196     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00197                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,CodePage),
00198                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00199     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00200         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00201     }
00202 
00203     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00204     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00205     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00206     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00207     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00208            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00209         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00210     }
00211 
00212     <span class="comment">//</span>
00213     <span class="comment">// Find ACP filename</span>
00214     <span class="comment">//</span>
00215     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00216                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,CodePage),
00217                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00218     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00219         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00220     }
00221 
00222     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00223     AnsiFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00224     AnsiFilename-&gt;Length = AnsiFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">// Find OEMCP node</span>
00228     <span class="comment">//</span>
00229     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OEMCP"</span>);
00230     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00231                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,CodePage),
00232                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00233     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00234         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00235     }
00236 
00237     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00238     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00239     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00240     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00241     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00242            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00243         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length += <span class="keyword">sizeof</span>(WCHAR);
00244     }
00245 
00246     <span class="comment">//</span>
00247     <span class="comment">// Find OEMCP filename</span>
00248     <span class="comment">//</span>
00249     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00250                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,CodePage),
00251                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00252     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00253         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00254     }
00255 
00256     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00257     OemFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Value,realsize);
00258     OemFilename-&gt;Length = OemFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Find Language node</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Language"</span>);
00264     Language = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00265                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Nls),
00266                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00267     <span class="keywordflow">if</span> (Language == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00268         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00269     }
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Find Default value</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Default"</span>);
00275     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00276                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Language),
00277                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00278     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00279             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280     }
00281 
00282     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00283     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Value,realsize);
00284     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00285     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length = 0;
00286 
00287     <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length&lt;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength) &amp;&amp;
00288            (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer[<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
00289         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length+=<span class="keyword">sizeof</span>(WCHAR);
00290     }
00291 
00292     <span class="comment">//</span>
00293     <span class="comment">// Find default filename</span>
00294     <span class="comment">//</span>
00295     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00296                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Language),
00297                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00298     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00299         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00300     }
00301 
00302     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00303     CaseTableFilename-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Value,realsize);
00304     CaseTableFilename-&gt;Length = CaseTableFilename-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00305 
00306     <span class="comment">//</span>
00307     <span class="comment">// Find OEMHAL filename</span>
00308     <span class="comment">//</span>
00309     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"OEMHAL"</span>);
00310     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00311                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,CodePage),
00312                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00313     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00314 <span class="preprocessor">#ifdef i386</span>
00315 <span class="preprocessor"></span>        OemHalFont-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00316         OemHalFont-&gt;Length = 0;
00317         OemHalFont-&gt;MaximumLength = 0;
00318         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319 <span class="preprocessor">#endif</span>
00320 <span class="preprocessor"></span>        <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00321     }
00322 
00323     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00324     OemHalFont-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00325     OemHalFont-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00326     OemHalFont-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00327 
00328     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00329 }
00330 
00331 
00332 BOOLEAN
<a name="l00333"></a><a class="code" href="../../d1/d2/cmp_8h.html#a297">00333</a> <a class="code" href="../../d1/d2/cmp_8h.html#a297">CmpFindDrivers</a>(
00334     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00335     IN HCELL_INDEX ControlSet,
00336     IN SERVICE_LOAD_TYPE LoadType,
00337     IN PWSTR BootFileSystem OPTIONAL,
00338     IN PLIST_ENTRY DriverListHead
00339     )
00340 
00341 <span class="comment">/*++</span>
00342 <span class="comment"></span>
00343 <span class="comment">Routine Description:</span>
00344 <span class="comment"></span>
00345 <span class="comment">    Traverses a particular control set and creates a list of boot drivers</span>
00346 <span class="comment">    to be loaded.  This list is unordered, but complete.</span>
00347 <span class="comment"></span>
00348 <span class="comment">Arguments:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    Hive - Supplies the hive control structure for the SYSTEM hive.</span>
00351 <span class="comment"></span>
00352 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the root of the control set.</span>
00353 <span class="comment"></span>
00354 <span class="comment">    LoadType - Supplies the type of drivers to be loaded (BootLoad,</span>
00355 <span class="comment">            SystemLoad, AutoLoad, etc)</span>
00356 <span class="comment"></span>
00357 <span class="comment">    BootFileSystem - If present, supplies the base name of the boot</span>
00358 <span class="comment">        filesystem, which is explicitly added to the driver list.</span>
00359 <span class="comment"></span>
00360 <span class="comment">    DriverListHead - Supplies a pointer to the head of the (empty) list</span>
00361 <span class="comment">            of boot drivers to load.</span>
00362 <span class="comment"></span>
00363 <span class="comment">Return Value:</span>
00364 <span class="comment"></span>
00365 <span class="comment">    TRUE - List successfully created.</span>
00366 <span class="comment"></span>
00367 <span class="comment">    FALSE - Hive is corrupt.</span>
00368 <span class="comment"></span>
00369 <span class="comment">--*/</span>
00370 
00371 {
00372     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Services;
00373     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Control;
00374     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00375     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DriverCell;
00376     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00377     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00378     <span class="keywordtype">int</span> i;
00379     UNICODE_STRING UnicodeString;
00380     UNICODE_STRING BasePath;
00381     WCHAR BaseBuffer[128];
00382     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> BootFileSystemNode;
00383     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ControlNode;
00384     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ServicesNode;
00385 
00386     <span class="comment">//</span>
00387     <span class="comment">// Find SERVICES node.</span>
00388     <span class="comment">//</span>
00389     ControlNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ControlSet);
00390     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Services"</span>);
00391     Services = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00392                                    ControlNode,
00393                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00394     <span class="keywordflow">if</span> (Services == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00395         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00396     }
00397     ServicesNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Services);
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find CONTROL node.</span>
00401     <span class="comment">//</span>
00402     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control"</span>);
00403     Control = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00404                                   ControlNode,
00405                                   &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00406     <span class="keywordflow">if</span> (Control == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00407         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Find GroupOrderList node.</span>
00412     <span class="comment">//</span>
00413     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"GroupOrderList"</span>);
00414     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00415                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Control),
00416                                      &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00417     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00418         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419     }
00420 
00421     BasePath.Length = 0;
00422     BasePath.MaximumLength = <span class="keyword">sizeof</span>(BaseBuffer);
00423     BasePath.Buffer = BaseBuffer;
00424     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Registry\\Machine\\System\\"</span>);
00425     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;BasePath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentControlSet\\Services\\"</span>);
00426 
00427     i=0;
00428     <span class="keywordflow">do</span> {
00429         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ServicesNode,i++);
00430         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00431             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DriverCell, LoadType)) {
00432                 <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00433                                    DriverCell,
00434                                    GroupOrder,
00435                                    &amp;BasePath,
00436                                    DriverListHead);
00437 
00438             }
00439         }
00440     } <span class="keywordflow">while</span> ( DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a> );
00441 
00442     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(BootFileSystem)) {
00443         <span class="comment">//</span>
00444         <span class="comment">// Add boot filesystem to boot driver list</span>
00445         <span class="comment">//</span>
00446 
00447         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, BootFileSystem);
00448         DriverCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00449                                          ServicesNode,
00450                                          &amp;UnicodeString);
00451         <span class="keywordflow">if</span> (DriverCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00452             <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00453                                DriverCell,
00454                                GroupOrder,
00455                                &amp;BasePath,
00456                                DriverListHead);
00457 
00458             <span class="comment">//</span>
00459             <span class="comment">// mark the Boot Filesystem critical</span>
00460             <span class="comment">//</span>
00461             BootFileSystemNode = CONTAINING_RECORD(DriverListHead-&gt;Flink,
00462                                                    <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00463                                                    ListEntry.Link);
00464             BootFileSystemNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = SERVICE_ERROR_CRITICAL;
00465         }
00466     }
00467     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00468 
00469 }
00470 
00471 
00472 BOOLEAN
<a name="l00473"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a7">00473</a> <a class="code" href="../../d0/d0/cmboot_8c.html#a7">CmpIsLoadType</a>(
00474     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00475     IN HCELL_INDEX Cell,
00476     IN SERVICE_LOAD_TYPE LoadType
00477     )
00478 
00479 <span class="comment">/*++</span>
00480 <span class="comment"></span>
00481 <span class="comment">Routine Description:</span>
00482 <span class="comment"></span>
00483 <span class="comment">    Determines if the driver is of a specified LoadType, based on its</span>
00484 <span class="comment">    node values.</span>
00485 <span class="comment"></span>
00486 <span class="comment">Arguments:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    Hive - Supplies a pointer to the hive control structure for the system</span>
00489 <span class="comment">           hive.</span>
00490 <span class="comment"></span>
00491 <span class="comment">    Cell - Supplies the cell index of the driver's node in the system hive.</span>
00492 <span class="comment"></span>
00493 <span class="comment">    LoadType - Supplies the type of drivers to be loaded (BootLoad,</span>
00494 <span class="comment">            SystemLoad, AutoLoad, etc)</span>
00495 <span class="comment"></span>
00496 <span class="comment">Return Value:</span>
00497 <span class="comment"></span>
00498 <span class="comment">    TRUE - Driver is the correct type and should be loaded.</span>
00499 <span class="comment"></span>
00500 <span class="comment">    FALSE - Driver is not the correct type and should not be loaded.</span>
00501 <span class="comment"></span>
00502 <span class="comment">--*/</span>
00503 
00504 {
00505     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00506     PLONG Data;
00507     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00508     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00509     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00510     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00511     ULONG realsize;
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">// Must have a Start=BootLoad value in order to be a boot driver, so</span>
00515     <span class="comment">// look for that first.</span>
00516     <span class="comment">//</span>
00517     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Start"</span>);
00518     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00519                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>),
00520                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00521     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00522         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00523     }
00524 
00525     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00526 
00527     Data = (PLONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00528 
00529     <span class="keywordflow">if</span> (*Data != LoadType) {
00530         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00531     }
00532 
00533     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00534 }
00535 
00536 
00537 BOOLEAN
<a name="l00538"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a4">00538</a> <a class="code" href="../../d0/d0/cmboot_8c.html#a4">CmpAddDriverToList</a>(
00539     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00540     IN HCELL_INDEX DriverCell,
00541     IN HCELL_INDEX GroupOrderCell,
00542     IN PUNICODE_STRING RegistryPath,
00543     IN PLIST_ENTRY BootDriverListHead
00544     )
00545 
00546 <span class="comment">/*++</span>
00547 <span class="comment"></span>
00548 <span class="comment">Routine Description:</span>
00549 <span class="comment"></span>
00550 <span class="comment">    This routine allocates a list entry node for a particular driver.</span>
00551 <span class="comment">    It initializes it with the registry path, filename, group name, and</span>
00552 <span class="comment">    dependency list.  Finally, it inserts the new node into the boot</span>
00553 <span class="comment">    driver list.</span>
00554 <span class="comment"></span>
00555 <span class="comment">    Note that this routine allocates memory by calling the Hive's</span>
00556 <span class="comment">    memory allocation procedure.</span>
00557 <span class="comment"></span>
00558 <span class="comment">Arguments:</span>
00559 <span class="comment"></span>
00560 <span class="comment">    Hive - Supplies a pointer to the hive control structure</span>
00561 <span class="comment"></span>
00562 <span class="comment">    DriverCell - Supplies the HCELL_INDEX of the driver's node in the hive.</span>
00563 <span class="comment"></span>
00564 <span class="comment">    GroupOrderCell - Supplies the HCELL_INDEX of the GroupOrderList key.</span>
00565 <span class="comment">        ( \Registry\Machine\System\CurrentControlSet\Control\GroupOrderList )</span>
00566 <span class="comment"></span>
00567 <span class="comment">    RegistryPath - Supplies the full registry path to the SERVICES node</span>
00568 <span class="comment">            of the current control set.</span>
00569 <span class="comment"></span>
00570 <span class="comment">    BootDriverListHead - Supplies the head of the boot driver list</span>
00571 <span class="comment"></span>
00572 <span class="comment">Return Value:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    TRUE - Driver successfully added to boot driver list.</span>
00575 <span class="comment"></span>
00576 <span class="comment">    FALSE - Could not add driver to boot driver list.</span>
00577 <span class="comment"></span>
00578 <span class="comment">--*/</span>
00579 
00580 {
00581     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Driver;
00582     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DriverNameLength;
00583     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
00584     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> DriverNode;
00585     <a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html">PBOOT_DRIVER_LIST_ENTRY</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>;
00586     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00587     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Tag;
00588     UNICODE_STRING UnicodeString;
00589     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00590     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00591     ULONG Length;
00592     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00593     ULONG   realsize;
00594 
00595     Driver = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DriverCell);
00596     DriverNode = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>),<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00597     <span class="keywordflow">if</span> (DriverNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00598         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00599     }
00600     <span class="keywordflow">if</span> (Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00601         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00602         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00603         <span class="keywordflow">if</span> (DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00604             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00605         }
00606         <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer,
00607                               DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length,
00608                               Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00609                               Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00610 
00611     } <span class="keywordflow">else</span> {
00612         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length = Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
00613         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Buffer = Driver-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
00614     }
00615     DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.MaximumLength = DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length;
00616     DriverNameLength = DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>.Length;
00617 
00618     <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> = &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>;
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">// Check for ImagePath value, which will override the default name</span>
00622     <span class="comment">// if it is present.</span>
00623     <span class="comment">//</span>
00624     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ImagePath"</span>);
00625     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00626                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,DriverCell),
00627                                    &amp;UnicodeString);
00628     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00629 
00630         <span class="comment">//</span>
00631         <span class="comment">// No ImagePath, so generate default filename.</span>
00632         <span class="comment">// Build up Unicode filename  ("system32\drivers&lt;nodename&gt;.sys");</span>
00633         <span class="comment">//</span>
00634 
00635         Length = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System32\\Drivers\\"</span>) +
00636                  DriverNameLength  +
00637                  <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".sys"</span>);
00638 
00639         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FilePath;
00640         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
00641         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00642         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (PWSTR)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(Length, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00643         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00644             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00645         }
00646         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"System32\\"</span>))) {
00647             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00648         }
00649         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Drivers\\"</span>))) {
00650             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00651         }
00652         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(
00653                 <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>,
00654                                                &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>))) {
00655             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00656         }
00657         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">".sys"</span>))) {
00658             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00659         }
00660 
00661     } <span class="keywordflow">else</span> {
00662         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ValueCell);
00663         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;FilePath;
00664         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00665         <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize;
00666     }
00667 
00668     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;RegistryPath;
00669     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = 0;
00670     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = RegistryPath-&gt;Length + DriverNameLength;
00671     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00672     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00673         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00674     }
00675     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, RegistryPath);
00676     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>, &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o2">Name</a>);
00677 
00678     InsertHeadList(BootDriverListHead, &amp;<a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a>-&gt;Link);
00679 
00680     <span class="comment">//</span>
00681     <span class="comment">// Find "ErrorControl" value</span>
00682     <span class="comment">//</span>
00683 
00684     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ErrorControl"</span>);
00685     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00686                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,DriverCell),
00687                                    &amp;UnicodeString);
00688     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00689         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = NormalError;
00690     } <span class="keywordflow">else</span> {
00691         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00692         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o4">ErrorControl</a> = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00693     }
00694 
00695     <span class="comment">//</span>
00696     <span class="comment">// Find "Group" value</span>
00697     <span class="comment">//</span>
00698     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"group"</span>);
00699     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00700                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,DriverCell),
00701                                    &amp;UnicodeString);
00702     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00703         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length = 0;
00704         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.MaximumLength = 0;
00705         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00706     } <span class="keywordflow">else</span> {
00707         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
00708         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Value,realsize);
00709         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize - <span class="keyword">sizeof</span>(WCHAR);
00710         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Length;
00711     }
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Calculate the tag value for the driver.  If the driver has no tag,</span>
00715     <span class="comment">// this defaults to 0xffffffff, so the driver is loaded last in the</span>
00716     <span class="comment">// group.</span>
00717     <span class="comment">//</span>
00718     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Tag"</span>);
00719     Tag = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00720                              (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,DriverCell),
00721                              &amp;UnicodeString);
00722     <span class="keywordflow">if</span> (Tag == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00723         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> = <a class="code" href="../../d0/d0/cmboot_8c.html#a0">LOAD_LAST</a>;
00724     } <span class="keywordflow">else</span> {
00725         <span class="comment">//</span>
00726         <span class="comment">// Now we have to find this tag in the tag list for the group.</span>
00727         <span class="comment">// If the tag is not in the tag list, then it defaults to 0xfffffffe,</span>
00728         <span class="comment">// so it is loaded after all the drivers in the tag list, but before</span>
00729         <span class="comment">// all the drivers without tags at all.</span>
00730         <span class="comment">//</span>
00731 
00732         DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> = <a class="code" href="../../d0/d0/cmboot_8c.html#a6">CmpFindTagIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00733                                           Tag,
00734                                           GroupOrderCell,
00735                                           &amp;DriverNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>);
00736     }
00737 
00738     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00739 
00740 }
00741 
00742 
00743 BOOLEAN
<a name="l00744"></a><a class="code" href="../../d1/d2/cmp_8h.html#a302">00744</a> <a class="code" href="../../d1/d2/cmp_8h.html#a302">CmpSortDriverList</a>(
00745     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00746     IN HCELL_INDEX ControlSet,
00747     IN PLIST_ENTRY DriverListHead
00748     )
00749 
00750 <span class="comment">/*++</span>
00751 <span class="comment"></span>
00752 <span class="comment">Routine Description:</span>
00753 <span class="comment"></span>
00754 <span class="comment">    Sorts the list of boot drivers by their groups based on the group</span>
00755 <span class="comment">    ordering in &lt;control_set&gt;\CONTROL\SERVICE_GROUP_ORDER:list</span>
00756 <span class="comment"></span>
00757 <span class="comment">    Does NOT do dependency ordering.</span>
00758 <span class="comment"></span>
00759 <span class="comment">Arguments:</span>
00760 <span class="comment"></span>
00761 <span class="comment">    Hive - Supplies the hive control structure for the SYSTEM hive.</span>
00762 <span class="comment"></span>
00763 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the root of the control set.</span>
00764 <span class="comment"></span>
00765 <span class="comment">    DriverListHead - Supplies a pointer to the head of the list of</span>
00766 <span class="comment">            boot drivers to be sorted.</span>
00767 <span class="comment"></span>
00768 <span class="comment">Return Value:</span>
00769 <span class="comment"></span>
00770 <span class="comment">    TRUE - List successfully sorted</span>
00771 <span class="comment"></span>
00772 <span class="comment">    FALSE - List is inconsistent and could not be sorted.</span>
00773 <span class="comment"></span>
00774 <span class="comment">--*/</span>
00775 
00776 {
00777     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Controls;
00778     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> GroupOrder;
00779     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ListCell;
00780     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00781     UNICODE_STRING DependList;
00782     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00783     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00784     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ListNode;
00785     ULONG realsize;
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">// Find "CONTROL" node.</span>
00789     <span class="comment">//</span>
00790     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control"</span>);
00791     Controls = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00792                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ControlSet),
00793                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00794     <span class="keywordflow">if</span> (Controls == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00795         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">// Find "SERVICE_GROUP_ORDER" subkey</span>
00800     <span class="comment">//</span>
00801     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ServiceGroupOrder"</span>);
00802     GroupOrder = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00803                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,Controls),
00804                                      &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00805     <span class="keywordflow">if</span> (GroupOrder == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00806         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">// Find "list" value</span>
00811     <span class="comment">//</span>
00812     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"list"</span>);
00813     ListCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00814                                   (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,GroupOrder),
00815                                   &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00816     <span class="keywordflow">if</span> (ListCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00817         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00818     }
00819     ListNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ListCell);
00820     <span class="keywordflow">if</span> (ListNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_MULTI_SZ) {
00821         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00822     }
00823 
00824     DependList.Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,ListNode,realsize);
00825     DependList.Length = DependList.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realsize - <span class="keyword">sizeof</span>(WCHAR);
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Dependency list is now pointed to by DependList-&gt;Buffer.  We need</span>
00829     <span class="comment">// to sort the driver entry list.</span>
00830     <span class="comment">//</span>
00831 
00832     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a>(DriverListHead, &amp;DependList));
00833 
00834 }
00835 
00836 BOOLEAN
<a name="l00837"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a5">00837</a> <a class="code" href="../../d0/d0/cmboot_8c.html#a5">CmpDoSort</a>(
00838     IN PLIST_ENTRY DriverListHead,
00839     IN PUNICODE_STRING OrderList
00840     )
00841 
00842 <span class="comment">/*++</span>
00843 <span class="comment"></span>
00844 <span class="comment">Routine Description:</span>
00845 <span class="comment"></span>
00846 <span class="comment">    Sorts the boot driver list based on the order list</span>
00847 <span class="comment"></span>
00848 <span class="comment">    Start with the last entry in the group order list and work towards</span>
00849 <span class="comment">    the beginning.  For each group entry, move all driver entries that</span>
00850 <span class="comment">    are members of the group to the front of the list.  Driver entries</span>
00851 <span class="comment">    with no groups, or with a group that does not match any in the</span>
00852 <span class="comment">    group list will be shoved to the end of the list.</span>
00853 <span class="comment"></span>
00854 <span class="comment">Arguments:</span>
00855 <span class="comment"></span>
00856 <span class="comment">    DriverListHead - Supplies a pointer to the head of the list of</span>
00857 <span class="comment">            boot drivers to be sorted.</span>
00858 <span class="comment"></span>
00859 <span class="comment">    OrderList - Supplies pointer to the order list</span>
00860 <span class="comment"></span>
00861 <span class="comment">Return Value:</span>
00862 <span class="comment"></span>
00863 <span class="comment">    TRUE - List successfully ordered</span>
00864 <span class="comment"></span>
00865 <span class="comment">    FALSE - List is inconsistent and could not be ordered.</span>
00866 <span class="comment"></span>
00867 <span class="comment">--*/</span>
00868 
00869 {
00870     PWSTR Current;
00871     PWSTR <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a>;
00872     PLIST_ENTRY Next;
00873     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> CurrentNode;
00874     UNICODE_STRING CurrentGroup;
00875 
00876 
00877     Current = (PWSTR) ((PUCHAR)(OrderList-&gt;Buffer)+OrderList-&gt;Length);
00878 
00879     <span class="keywordflow">while</span> (Current &gt; OrderList-&gt;Buffer) {
00880         <span class="keywordflow">do</span> {
00881             <span class="keywordflow">if</span> (*(Current) == UNICODE_NULL) {
00882                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> = Current;
00883             }
00884             --Current;
00885         } <span class="keywordflow">while</span> ((*(Current-1) != UNICODE_NULL) &amp;&amp;
00886                  ( Current != OrderList-&gt;Buffer));
00887 
00888         <span class="comment">//</span>
00889         <span class="comment">// Current now points to the beginning of the NULL-terminated</span>
00890         <span class="comment">// Unicode string.</span>
00891         <span class="comment">// End now points to the end of the string</span>
00892         <span class="comment">//</span>
00893         CurrentGroup.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PCHAR)<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a19">End</a> - (PCHAR)Current);
00894         CurrentGroup.MaximumLength = CurrentGroup.Length;
00895         CurrentGroup.Buffer = Current;
00896         Next = DriverListHead-&gt;Flink;
00897         <span class="keywordflow">while</span> (Next != DriverListHead) {
00898             CurrentNode = CONTAINING_RECORD(Next,
00899                                             <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00900                                             ListEntry.Link);
00901             Next = CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Flink;
00902             <span class="keywordflow">if</span> (CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00903                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;CurrentGroup, &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00904                     RemoveEntryList(&amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>);
00905                     InsertHeadList(DriverListHead,
00906                                    &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>);
00907                 }
00908             }
00909         }
00910         --Current;
00911 
00912     }
00913 
00914     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00915 
00916 }
00917 
00918 
00919 BOOLEAN
<a name="l00920"></a><a class="code" href="../../d1/d2/cmp_8h.html#a301">00920</a> <a class="code" href="../../d1/d2/cmp_8h.html#a301">CmpResolveDriverDependencies</a>(
00921     IN PLIST_ENTRY DriverListHead
00922     )
00923 
00924 <span class="comment">/*++</span>
00925 <span class="comment"></span>
00926 <span class="comment">Routine Description:</span>
00927 <span class="comment"></span>
00928 <span class="comment">    This routine orders driver nodes in a group based on their dependencies</span>
00929 <span class="comment">    on one another.  It removes any drivers that have circular dependencies</span>
00930 <span class="comment">    from the list.</span>
00931 <span class="comment"></span>
00932 <span class="comment">Arguments:</span>
00933 <span class="comment"></span>
00934 <span class="comment">    DriverListHead - Supplies a pointer to the head of the list of</span>
00935 <span class="comment">            boot drivers to be sorted.</span>
00936 <span class="comment"></span>
00937 <span class="comment">Return Value:</span>
00938 <span class="comment"></span>
00939 <span class="comment">    TRUE - Dependencies successfully resolved</span>
00940 <span class="comment"></span>
00941 <span class="comment">    FALSE - Corrupt hive.</span>
00942 <span class="comment"></span>
00943 <span class="comment">--*/</span>
00944 
00945 {
00946     PLIST_ENTRY CurrentEntry;
00947     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart;
00948     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd;
00949     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> CurrentNode;
00950 
00951     CurrentEntry = DriverListHead-&gt;Flink;
00952 
00953     <span class="keywordflow">while</span> (CurrentEntry != DriverListHead) {
00954         <span class="comment">//</span>
00955         <span class="comment">// The list is already ordered by groups.  Find the first and</span>
00956         <span class="comment">// last entry in each group, and order each of these sub-lists</span>
00957         <span class="comment">// based on their dependencies.</span>
00958         <span class="comment">//</span>
00959 
00960         GroupStart = CONTAINING_RECORD(CurrentEntry,
00961                                        <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00962                                        ListEntry.Link);
00963         <span class="keywordflow">do</span> {
00964             GroupEnd = CONTAINING_RECORD(CurrentEntry,
00965                                          <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00966                                          ListEntry.Link);
00967 
00968             CurrentEntry = CurrentEntry-&gt;Flink;
00969             CurrentNode = CONTAINING_RECORD(CurrentEntry,
00970                                             <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
00971                                             ListEntry.Link);
00972 
00973             <span class="keywordflow">if</span> (CurrentEntry == DriverListHead) {
00974                 <span class="keywordflow">break</span>;
00975             }
00976 
00977             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;GroupStart-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00978                                        &amp;CurrentNode-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o1">Group</a>,
00979                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00980                 <span class="keywordflow">break</span>;
00981             }
00982 
00983         } <span class="keywordflow">while</span> ( CurrentEntry != DriverListHead );
00984 
00985         <span class="comment">//</span>
00986         <span class="comment">// GroupStart now points to the first driver node in the group,</span>
00987         <span class="comment">// and GroupEnd points to the last driver node in the group.</span>
00988         <span class="comment">//</span>
00989         <a class="code" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a>(GroupStart, GroupEnd);
00990 
00991     }
00992     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00993 }
00994 
00995 
00996 BOOLEAN
<a name="l00997"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a8">00997</a> <a class="code" href="../../d0/d0/cmboot_8c.html#a8">CmpOrderGroup</a>(
00998     IN <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupStart,
00999     IN <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> GroupEnd
01000     )
01001 
01002 <span class="comment">/*++</span>
01003 <span class="comment"></span>
01004 <span class="comment">Routine Description:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    Reorders the nodes in a driver group based on their tag values.</span>
01007 <span class="comment"></span>
01008 <span class="comment">Arguments:</span>
01009 <span class="comment"></span>
01010 <span class="comment">    GroupStart - Supplies the first node in the group.</span>
01011 <span class="comment"></span>
01012 <span class="comment">    GroupEnd - Supplies the last node in the group.</span>
01013 <span class="comment"></span>
01014 <span class="comment">Return Value:</span>
01015 <span class="comment"></span>
01016 <span class="comment">    TRUE - Group successfully reordered</span>
01017 <span class="comment"></span>
01018 <span class="comment">    FALSE - Circular dependencies detected.</span>
01019 <span class="comment"></span>
01020 <span class="comment">--*/</span>
01021 
01022 {
01023     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> Current;
01024     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">PBOOT_DRIVER_NODE</a> Previous;
01025     PLIST_ENTRY ListEntry;
01026     BOOLEAN StartOver=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027 
01028     <span class="keywordflow">if</span> (GroupStart == GroupEnd) {
01029         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01030     }
01031 
01032     Current = GroupStart;
01033 
01034     <span class="keywordflow">do</span> {
01035         <span class="comment">//</span>
01036         <span class="comment">// If the driver before the current one has a lower tag, then</span>
01037         <span class="comment">// we do not need to move it.  If not, then remove the driver</span>
01038         <span class="comment">// from the list and scan backwards until we find a driver with</span>
01039         <span class="comment">// a tag that is &lt;= the current tag, or we reach the beginning</span>
01040         <span class="comment">// of the list.</span>
01041         <span class="comment">//</span>
01042         Previous = Current;
01043         ListEntry = Current-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Flink;
01044         Current = CONTAINING_RECORD(ListEntry,
01045                                     <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01046                                     ListEntry.Link);
01047 
01048         <span class="keywordflow">if</span> (Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> &gt; Current-&gt;Tag) {
01049             <span class="comment">//</span>
01050             <span class="comment">// Remove the Current driver from the list, and search</span>
01051             <span class="comment">// backwards until we find a tag that is &lt;= the current</span>
01052             <span class="comment">// driver's tag.  Reinsert the current driver there.</span>
01053             <span class="comment">//</span>
01054             <span class="keywordflow">if</span> (Current == GroupEnd) {
01055                 ListEntry = Current-&gt;ListEntry.Link.Blink;
01056                 GroupEnd = CONTAINING_RECORD(ListEntry,
01057                                              <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01058                                              ListEntry.Link);
01059             }
01060             RemoveEntryList(&amp;Current-&gt;ListEntry.Link);
01061             <span class="keywordflow">while</span> ( (Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o3">Tag</a> &gt; Current-&gt;Tag) &amp;&amp;
01062                     (Previous != GroupStart) ) {
01063                 ListEntry = Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>.Blink;
01064                 Previous = CONTAINING_RECORD(ListEntry,
01065                                              <a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html">BOOT_DRIVER_NODE</a>,
01066                                              ListEntry.Link);
01067             }
01068             InsertTailList(&amp;Previous-&gt;<a class="code" href="../../d5/d4/struct__BOOT__DRIVER__NODE.html#o0">ListEntry</a>.<a class="code" href="../../d4/d4/struct__BOOT__DRIVER__LIST__ENTRY.html#o0">Link</a>,
01069                            &amp;Current-&gt;ListEntry.Link);
01070             <span class="keywordflow">if</span> (Previous == GroupStart) {
01071                 GroupStart = Current;
01072             }
01073         }
01074 
01075     } <span class="keywordflow">while</span> ( Current != GroupEnd );
01076 
01077     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01078 }
01079 
01080 
01081 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l01082"></a><a class="code" href="../../d1/d2/cmp_8h.html#a296">01082</a> <a class="code" href="../../d1/d2/cmp_8h.html#a296">CmpFindControlSet</a>(
01083      IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SystemHive,
01084      IN HCELL_INDEX RootCell,
01085      IN PUNICODE_STRING SelectName,
01086      OUT PBOOLEAN AutoSelect
01087      )
01088 
01089 <span class="comment">/*++</span>
01090 <span class="comment"></span>
01091 <span class="comment">Routine Description:</span>
01092 <span class="comment"></span>
01093 <span class="comment">    This routines parses the SYSTEM hive and "Select" node</span>
01094 <span class="comment">    to locate the control set to be used for booting.</span>
01095 <span class="comment"></span>
01096 <span class="comment">    Note that this routines also updates the value of Current to reflect</span>
01097 <span class="comment">    the control set that was just found.  This is what we want to do</span>
01098 <span class="comment">    when this is called during boot.  During I/O initialization, this</span>
01099 <span class="comment">    is irrelevant, since we're just changing it to what it already is.</span>
01100 <span class="comment"></span>
01101 <span class="comment">Arguments:</span>
01102 <span class="comment"></span>
01103 <span class="comment">    SystemHive - Supplies the hive control structure for the SYSTEM hive.</span>
01104 <span class="comment"></span>
01105 <span class="comment">    RootCell - Supplies the HCELL_INDEX of the root cell of the hive.</span>
01106 <span class="comment"></span>
01107 <span class="comment">    SelectName - Supplies the name of the Select value to be used in</span>
01108 <span class="comment">            determining the control set.  This should be one of "Current"</span>
01109 <span class="comment">            "Default" or "LastKnownGood"</span>
01110 <span class="comment"></span>
01111 <span class="comment">    AutoSelect - Returns the value of the AutoSelect value under</span>
01112 <span class="comment">            the Select node.</span>
01113 <span class="comment"></span>
01114 <span class="comment">Return Value:</span>
01115 <span class="comment"></span>
01116 <span class="comment">    != HCELL_NIL - Cell Index of the control set to be used for booting.</span>
01117 <span class="comment">    == HCELL_NIL - Indicates the hive is corrupt or inconsistent</span>
01118 <span class="comment"></span>
01119 <span class="comment">--*/</span>
01120 
01121 {
01122     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> Select;
01123     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01124     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlSet;
01125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> AutoSelectCell;
01126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01127     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01128     ANSI_STRING AnsiString;
01129     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01130     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> Value;
01131     PULONG ControlSetIndex;
01132     PULONG CurrentControl;
01133     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> AsciiBuffer[128];
01134     WCHAR UnicodeBuffer[128];
01135     ULONG realsize;
01136 
01137     <span class="comment">//</span>
01138     <span class="comment">// Find \SYSTEM\SELECT node.</span>
01139     <span class="comment">//</span>
01140     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"select"</span>);
01141     Select = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01142                                 (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01143                                 &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01144     <span class="keywordflow">if</span> (Select == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01145         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01146     }
01147 
01148     <span class="comment">//</span>
01149     <span class="comment">// Find AutoSelect value</span>
01150     <span class="comment">//</span>
01151     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"AutoSelect"</span>);
01152     AutoSelectCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01153                                         (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01154                                         &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01155     <span class="keywordflow">if</span> (AutoSelectCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01156         <span class="comment">//</span>
01157         <span class="comment">// It's not there, we don't care.  Set autoselect to TRUE</span>
01158         <span class="comment">//</span>
01159         *AutoSelect = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160     } <span class="keywordflow">else</span> {
01161         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, AutoSelectCell);
01162         *AutoSelect = *(PBOOLEAN)(<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,Value,realsize));
01163     }
01164 
01165     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01166                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01167                                    SelectName);
01168     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01169         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01170     }
01171     Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01172     <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_DWORD) {
01173         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01174     }
01175 
01176     ControlSetIndex = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">// Find appropriate control set</span>
01180     <span class="comment">//</span>
01181 
01182     <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(AsciiBuffer, <span class="stringliteral">"ControlSet%03d"</span>, *ControlSetIndex);
01183     AnsiString.Length = AnsiString.MaximumLength = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(&amp;(AsciiBuffer[0]));
01184     AnsiString.Buffer = AsciiBuffer;
01185     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.MaximumLength = 128*<span class="keyword">sizeof</span>(WCHAR);
01186     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Buffer = UnicodeBuffer;
01187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
01188                                           &amp;AnsiString,
01189                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01190     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01191         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01192     }
01193     ControlSet = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01194                                      (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,RootCell),
01195                                      &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01196     <span class="keywordflow">if</span> (ControlSet == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01197         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01198     }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// Control set was successfully found, so update the value in "Current"</span>
01202     <span class="comment">// to reflect the control set we are going to use.</span>
01203     <span class="comment">//</span>
01204     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Current"</span>);
01205     ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01206                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,Select),
01207                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01208     <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01209         Value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01210         <span class="keywordflow">if</span> (Value-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01211             CurrentControl = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, Value,realsize);
01212             *CurrentControl = *ControlSetIndex;
01213         }
01214     }
01215     <span class="keywordflow">return</span>(ControlSet);
01216 
01217 }
01218 
01219 
01220 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01221"></a><a class="code" href="../../d1/d2/cmp_8h.html#a300">01221</a> <a class="code" href="../../d1/d2/cmp_8h.html#a300">CmpSetCurrentProfile</a>(
01222     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01223     IN HCELL_INDEX ControlSet,
01224     IN <a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">PCM_HARDWARE_PROFILE</a> Profile
01225     )
01226 
01227 <span class="comment">/*++</span>
01228 <span class="comment"></span>
01229 <span class="comment">Routine Description:</span>
01230 <span class="comment"></span>
01231 <span class="comment">    Edits the in-memory copy of the registry to reflect the hardware</span>
01232 <span class="comment">    profile that the system is booting from.</span>
01233 <span class="comment"></span>
01234 <span class="comment">Arguments:</span>
01235 <span class="comment"></span>
01236 <span class="comment">    Hive - Supplies a pointer to the hive control structure</span>
01237 <span class="comment"></span>
01238 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the current control set.</span>
01239 <span class="comment"></span>
01240 <span class="comment">    Profile - Supplies a pointer to the selected hardware profile</span>
01241 <span class="comment"></span>
01242 <span class="comment">Return Value:</span>
01243 <span class="comment"></span>
01244 <span class="comment">    None.</span>
01245 <span class="comment"></span>
01246 <span class="comment">--*/</span>
01247 
01248 {
01249     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> IDConfigDB;
01250     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> IDConfigNode;
01251     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> CurrentConfigCell;
01252     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> CurrentConfigValue;
01253     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01254     PULONG CurrentConfig;
01255     ULONG realsize;
01256 
01257     IDConfigDB = <a class="code" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01258                                       ControlSet,
01259                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01260                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01261                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01262     <span class="keywordflow">if</span> (IDConfigDB != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01263         IDConfigNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, IDConfigDB);
01264         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CurrentConfig"</span>);
01265         CurrentConfigCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01266                                                IDConfigNode,
01267                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01268         <span class="keywordflow">if</span> (CurrentConfigCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01269             CurrentConfigValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, CurrentConfigCell);
01270             <span class="keywordflow">if</span> (CurrentConfigValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> == REG_DWORD) {
01271                 CurrentConfig = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01272                                                        CurrentConfigValue,
01273                                                        realsize);
01274                 *CurrentConfig = Profile-&gt;Id;
01275             }
01276         }
01277     }
01278 
01279 
01280 }
01281 
01282 
01283 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>
<a name="l01284"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a16">01284</a> <a class="code" href="../../d1/d2/cmp_8h.html#a299">CmpFindProfileOption</a>(
01285      IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> SystemHive,
01286      IN HCELL_INDEX ControlSet,
01287      OUT OPTIONAL <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> *ReturnedProfileList,
01288      OUT OPTIONAL <a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> *ReturnedAliasList,
01289      OUT OPTIONAL PULONG ProfileTimeout
01290      )
01291 
01292 <span class="comment">/*++</span>
01293 <span class="comment"></span>
01294 <span class="comment">Routine Description:</span>
01295 <span class="comment"></span>
01296 <span class="comment">    This routines parses the SYSTEM hive and locates the</span>
01297 <span class="comment">    "CurrentControlSet\Control\IDConfigDB" node to determine the</span>
01298 <span class="comment">    hardware profile configuration settings.</span>
01299 <span class="comment"></span>
01300 <span class="comment">Arguments:</span>
01301 <span class="comment"></span>
01302 <span class="comment">    SystemHive - Supplies the hive control structure for the SYSTEM hive.</span>
01303 <span class="comment"></span>
01304 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the root cell of the hive.</span>
01305 <span class="comment"></span>
01306 <span class="comment">    ProfileList - Returns the list of available hardware profiles sorted</span>
01307 <span class="comment">                  by preference. Will be allocated by this routine if</span>
01308 <span class="comment">                  NULL is passed in, or a pointer to a CM_HARDWARE_PROFILE_LIST</span>
01309 <span class="comment">                  structure that is too small is passed in.</span>
01310 <span class="comment"></span>
01311 <span class="comment">    ProfileTimeout - Returns the timeout value for the config menu.</span>
01312 <span class="comment"></span>
01313 <span class="comment">Return Value:</span>
01314 <span class="comment"></span>
01315 <span class="comment">    != HCELL_NIL - Cell Index of the IDConfigDB node.</span>
01316 <span class="comment">    == HCELL_NIL - Indicates IDConfigDB does not exist</span>
01317 <span class="comment"></span>
01318 <span class="comment">--*/</span>
01319 {
01320     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ControlCell;
01321     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> IDConfigDB;
01322     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DefaultCell;
01323     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> TimeoutCell;
01324     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ProfileCell;
01325     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> AliasCell;
01326     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> HWCell;
01327     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> HWNode;
01328     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ProfileNode;
01329     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> AliasNode;
01330     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> ConfigDBNode;
01331     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Control;
01332     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> TimeoutValue;
01333     UNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
01334     ULONG realsize;
01335     <a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">PCM_HARDWARE_PROFILE_LIST</a> ProfileList;
01336     <a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html">PCM_HARDWARE_PROFILE_ALIAS_LIST</a> AliasList;
01337     ULONG ProfileCount;
01338     ULONG AliasCount;
01339     ULONG i,j;
01340     WCHAR NameBuf[20];
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">// Find Control node</span>
01344     <span class="comment">//</span>
01345     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Control"</span>);
01346     ControlCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01347                                       (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive,ControlSet),
01348                                       &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01349     <span class="keywordflow">if</span> (ControlCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01350         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01351     }
01352     Control = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ControlCell);
01353 
01354     <span class="comment">//</span>
01355     <span class="comment">// Find IDConfigDB node</span>
01356     <span class="comment">//</span>
01357     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"IDConfigDB"</span>);
01358     IDConfigDB = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01359                                      Control,
01360                                      &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01361     <span class="keywordflow">if</span> (IDConfigDB == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01362         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01363     }
01364     ConfigDBNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, IDConfigDB);
01365 
01366     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ProfileTimeout)) {
01367         <span class="comment">//</span>
01368         <span class="comment">// Find UserWaitInterval value. This is the timeout</span>
01369         <span class="comment">//</span>
01370         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"UserWaitInterval"</span>);
01371         TimeoutCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01372                                          ConfigDBNode,
01373                                          &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01374         <span class="keywordflow">if</span> (TimeoutCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01375             *ProfileTimeout = 0;
01376         } <span class="keywordflow">else</span> {
01377             TimeoutValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, TimeoutCell);
01378             <span class="keywordflow">if</span> (TimeoutValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_DWORD) {
01379                 *ProfileTimeout = 0;
01380             } <span class="keywordflow">else</span> {
01381                 *ProfileTimeout = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive, TimeoutValue, realsize);
01382             }
01383         }
01384     }
01385 
01386     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnedProfileList)) {
01387         ProfileList = *ReturnedProfileList;
01388         <span class="comment">//</span>
01389         <span class="comment">// Enumerate the keys under IDConfigDB\Hardware Profiles</span>
01390         <span class="comment">// and build the list of available hardware profiles.  The list</span>
01391         <span class="comment">// is built sorted by PreferenceOrder.  Therefore, when the</span>
01392         <span class="comment">// list is complete, the default hardware profile is at the</span>
01393         <span class="comment">// head of the list.</span>
01394         <span class="comment">//</span>
01395         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Hardware Profiles"</span>);
01396         ProfileCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01397                                           ConfigDBNode,
01398                                           &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01399         <span class="keywordflow">if</span> (ProfileCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01400             ProfileCount = 0;
01401             <span class="keywordflow">if</span> (ProfileList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01402                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = 0;
01403             }
01404         } <span class="keywordflow">else</span> {
01405             ProfileNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ProfileCell);
01406             ProfileCount = ProfileNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
01407             <span class="keywordflow">if</span> ((ProfileList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> &lt; ProfileCount)) {
01408                 <span class="comment">//</span>
01409                 <span class="comment">// Allocate a larger ProfileList</span>
01410                 <span class="comment">//</span>
01411                 ProfileList = (SystemHive-&gt;Allocate)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01412                                                      + (ProfileCount-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>),
01413                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01414                 <span class="keywordflow">if</span> (ProfileList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01415                     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01416                 }
01417                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a> = ProfileCount;
01418             }
01419             ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = 0;
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// Enumerate the keys and fill in the profile list.</span>
01423             <span class="comment">//</span>
01424             <span class="keywordflow">for</span> (i=0; i&lt;ProfileCount; i++) {
01425                 <a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a> TempProfile;
01426                 <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01427                 <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
01428                 UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01429                 ULONG realsize;
01430 
01431                 HWCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(SystemHive, ProfileNode, i);
01432                 <span class="keywordflow">if</span> (HWCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01433                     <span class="comment">//</span>
01434                     <span class="comment">// This should never happen.</span>
01435                     <span class="comment">//</span>
01436                     ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a> = i;
01437                     <span class="keywordflow">break</span>;
01438                 }
01439                 HWNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, HWCell);
01440                 <span class="keywordflow">if</span> (HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01441                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01442                                                            HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01443                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(NameBuf);
01444                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length) {
01445                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength;
01446                     }
01447                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = NameBuf;
01448                     <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer,
01449                                           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length,
01450                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01451                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01452                 } <span class="keywordflow">else</span> {
01453                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01454                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01455                 }
01456 
01457                 <span class="comment">//</span>
01458                 <span class="comment">// Fill in the temporary profile structure with this</span>
01459                 <span class="comment">// profile's data.</span>
01460                 <span class="comment">//</span>
01461                 <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, 0, &amp;TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>);
01462                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a140">CM_HARDWARE_PROFILE_STR_PREFERENCE_ORDER</a>);
01463                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01464                                                HWNode,
01465                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01466                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01467                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = (ULONG)-1;
01468                 } <span class="keywordflow">else</span> {
01469                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01470                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01471                                                                           ValueNode,
01472                                                                           realsize);
01473                 }
01474                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a141">CM_HARDWARE_PROFILE_STR_FRIENDLY_NAME</a>);
01475                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01476                                                HWNode,
01477                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01478                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01479                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"-------"</span>;
01480                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = wcslen(TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a>) * <span class="keyword">sizeof</span>(WCHAR);
01481                 } <span class="keywordflow">else</span> {
01482                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01483                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o1">FriendlyName</a> = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01484                                                                      ValueNode,
01485                                                                      realsize);
01486                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o0">NameLength</a> = realsize - <span class="keyword">sizeof</span>(WCHAR);
01487                 }
01488 
01489                 TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = 0;
01490 
01491                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a137">CM_HARDWARE_PROFILE_STR_ALIASABLE</a>);
01492                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01493                                                HWNode,
01494                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01495                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01496                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
01497                 } <span class="keywordflow">else</span> {
01498                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01499 
01500                     <span class="keywordflow">if</span> (*(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a> (SystemHive,
01501                                                  ValueNode,
01502                                                  realsize)) {
01503                         TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a147">CM_HP_FLAGS_ALIASABLE</a>;
01504                         <span class="comment">// NO other flags set.</span>
01505                     }
01506                 }
01507 
01508                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a139">CM_HARDWARE_PROFILE_STR_PRISTINE</a>);
01509                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01510                                                HWNode,
01511                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01512                 <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01513 
01514                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01515 
01516                     <span class="keywordflow">if</span> (*(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a> (SystemHive,
01517                                                  ValueNode,
01518                                                  realsize)) {
01519                         TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
01520                         <span class="comment">// NO other flags set.</span>
01521                     }
01522                 }
01523 
01524                 <span class="comment">//</span>
01525                 <span class="comment">// If we see a profile with the ID of zero (AKA an illegal)</span>
01526                 <span class="comment">// ID for a hardware profile to possess, then we know that this</span>
01527                 <span class="comment">// must be a pristine profile.</span>
01528                 <span class="comment">//</span>
01529                 <span class="keywordflow">if</span> (0 == TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o3">Id</a>) {
01530                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o4">Flags</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a149">CM_HP_FLAGS_PRISTINE</a>;
01531                     <span class="comment">// NO other flags set.</span>
01532 
01533                     TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> = -1; <span class="comment">// move to the end of the list.</span>
01534                 }
01535 
01536 
01537                 <span class="comment">//</span>
01538                 <span class="comment">// Insert this new profile into the appropriate spot in the</span>
01539                 <span class="comment">// profile array. Entries are sorted by preference order.</span>
01540                 <span class="comment">//</span>
01541                 <span class="keywordflow">for</span> (j=0; j&lt;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>; j++) {
01542                     <span class="keywordflow">if</span> (ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j].<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a> &gt;= TempProfile.<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html#o2">PreferenceOrder</a>) {
01543                         <span class="comment">//</span>
01544                         <span class="comment">// Insert at position j.</span>
01545                         <span class="comment">//</span>
01546                         RtlMoveMemory(&amp;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j+1],
01547                                       &amp;ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j],
01548                                       <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>)*(ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o0">MaxProfileCount</a>-j-1));
01549                         <span class="keywordflow">break</span>;
01550                     }
01551                 }
01552                 ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o2">Profile</a>[j] = TempProfile;
01553                 ++ProfileList-&gt;<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html#o1">CurrentProfileCount</a>;
01554             }
01555         }
01556         *ReturnedProfileList = ProfileList;
01557     }
01558 
01559     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnedAliasList)) {
01560         AliasList = *ReturnedAliasList;
01561         <span class="comment">//</span>
01562         <span class="comment">// Enumerate the keys under IDConfigDB\Alias</span>
01563         <span class="comment">// and build the list of available hardware profiles aliases.</span>
01564         <span class="comment">// So that if we know our docking state we can find it in the alias</span>
01565         <span class="comment">// table.</span>
01566         <span class="comment">//</span>
01567         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Alias"</span>);
01568         AliasCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(SystemHive,
01569                                         ConfigDBNode,
01570                                         &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01571         <span class="keywordflow">if</span> (AliasCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01572             AliasCount = 0;
01573             <span class="keywordflow">if</span> (AliasList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01574                 AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = 0;
01575             }
01576         } <span class="keywordflow">else</span> {
01577             AliasNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, AliasCell);
01578             AliasCount = AliasNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>];
01579             <span class="keywordflow">if</span> ((AliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o0">MaxAliasCount</a> &lt; AliasCount)) {
01580                 <span class="comment">//</span>
01581                 <span class="comment">// Allocate a larger AliasList</span>
01582                 <span class="comment">//</span>
01583                 AliasList = (SystemHive-&gt;Allocate)(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__CM__HARDWARE__PROFILE__LIST.html">CM_HARDWARE_PROFILE_LIST</a>)
01584                                                    + (AliasCount-1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d3/struct__CM__HARDWARE__PROFILE.html">CM_HARDWARE_PROFILE</a>),
01585                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01586                 <span class="keywordflow">if</span> (AliasList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01587                     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01588                 }
01589                 AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o0">MaxAliasCount</a> = AliasCount;
01590             }
01591             AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = 0;
01592 
01593             <span class="comment">//</span>
01594             <span class="comment">// Enumerate the keys and fill in the profile list.</span>
01595             <span class="comment">//</span>
01596             <span class="keywordflow">for</span> (i=0; i&lt;AliasCount; i++) {
01597 <span class="preprocessor">#define TempAlias AliasList-&gt;Alias[i]</span>
01598 <span class="preprocessor"></span>                <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01599                 <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
01600                 UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
01601                 ULONG realsize;
01602 
01603                 HWCell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(SystemHive, AliasNode, i);
01604                 <span class="keywordflow">if</span> (HWCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01605                     <span class="comment">//</span>
01606                     <span class="comment">// This should never happen.</span>
01607                     <span class="comment">//</span>
01608                     AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a> = i;
01609                     <span class="keywordflow">break</span>;
01610                 }
01611                 HWNode = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, HWCell);
01612                 <span class="keywordflow">if</span> (HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
01613                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d1/d2/cmp_8h.html#a320">CmpCompressedNameSize</a>(HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01614                                                            HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01615                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(NameBuf);
01616                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length) {
01617                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength;
01618                     }
01619                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = NameBuf;
01620                     <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer,
01621                                           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length,
01622                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
01623                                           HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
01624                 } <span class="keywordflow">else</span> {
01625                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>;
01626                     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = HWNode-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>;
01627                 }
01628 
01629                 <span class="comment">//</span>
01630                 <span class="comment">// Fill in the temporary profile structure with this</span>
01631                 <span class="comment">// profile's data.</span>
01632                 <span class="comment">//</span>
01633                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ProfileNumber"</span>);
01634                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01635                                                HWNode,
01636                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01637                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01638                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.ProfileNumber = 0;
01639                 } <span class="keywordflow">else</span> {
01640                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01641                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.ProfileNumber = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01642                                                                       ValueNode,
01643                                                                       realsize);
01644                 }
01645                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DockState"</span>);
01646                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01647                                                HWNode,
01648                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01649                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01650                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockState = 0;
01651                 } <span class="keywordflow">else</span> {
01652                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01653                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockState = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01654                                                                   ValueNode,
01655                                                                   realsize);
01656                 }
01657                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DockID"</span>);
01658                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01659                                                HWNode,
01660                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01661                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01662                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockID = 0;
01663                 } <span class="keywordflow">else</span> {
01664                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01665                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.DockID = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01666                                                                ValueNode,
01667                                                                realsize);
01668                 }
01669                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"SerialNumber"</span>);
01670                 ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(SystemHive,
01671                                                HWNode,
01672                                                &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01673                 <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01674                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.SerialNumber = 0;
01675                 } <span class="keywordflow">else</span> {
01676                     ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(SystemHive, ValueCell);
01677                     <a class="code" href="../../d0/d0/cmboot_8c.html#a3">TempAlias</a>.SerialNumber = *(PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(SystemHive,
01678                                                                      ValueNode,
01679                                                                      realsize);
01680                 }
01681 
01682                 ++AliasList-&gt;<a class="code" href="../../d9/d3/struct__CM__HARDWARE__PROFILE__ALIAS__LIST.html#o1">CurrentAliasCount</a>;
01683             }
01684         }
01685         *ReturnedAliasList = AliasList;
01686     }
01687 
01688     <span class="keywordflow">return</span>(IDConfigDB);
01689 }
01690 
01691 
01692 ULONG
<a name="l01693"></a><a class="code" href="../../d0/d0/cmboot_8c.html#a6">01693</a> <a class="code" href="../../d0/d0/cmboot_8c.html#a6">CmpFindTagIndex</a>(
01694     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01695     IN HCELL_INDEX TagCell,
01696     IN HCELL_INDEX GroupOrderCell,
01697     IN PUNICODE_STRING GroupName
01698     )
01699 
01700 <span class="comment">/*++</span>
01701 <span class="comment"></span>
01702 <span class="comment">Routine Description:</span>
01703 <span class="comment"></span>
01704 <span class="comment">    Calculates the tag index for a driver based on its tag value and</span>
01705 <span class="comment">    the GroupOrderList entry for its group.</span>
01706 <span class="comment"></span>
01707 <span class="comment">Arguments:</span>
01708 <span class="comment"></span>
01709 <span class="comment">    Hive - Supplies the hive control structure for the driver.</span>
01710 <span class="comment"></span>
01711 <span class="comment">    TagCell - Supplies the cell index of the driver's tag value cell.</span>
01712 <span class="comment"></span>
01713 <span class="comment">    GroupOrderCell - Supplies the cell index for the control set's</span>
01714 <span class="comment">            GroupOrderList:</span>
01715 <span class="comment"></span>
01716 <span class="comment">            \Registry\Machine\System\CurrentControlSet\Control\GroupOrderList</span>
01717 <span class="comment"></span>
01718 <span class="comment">    GroupName - Supplies the name of the group the driver belongs to.</span>
01719 <span class="comment">            Note that if a driver's group does not have an entry under</span>
01720 <span class="comment">            GroupOrderList, its tags will be ignored.  Also note that if</span>
01721 <span class="comment">            a driver belongs to no group (GroupName is NULL) its tags will</span>
01722 <span class="comment">            be ignored.</span>
01723 <span class="comment"></span>
01724 <span class="comment">Return Value:</span>
01725 <span class="comment"></span>
01726 <span class="comment">    The index that the driver should be sorted by.</span>
01727 <span class="comment"></span>
01728 <span class="comment">--*/</span>
01729 
01730 {
01731     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> TagValue;
01732     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> DriverTagValue;
01733     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OrderCell;
01734     PULONG OrderVector;
01735     PULONG DriverTag;
01736     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01737     ULONG CurrentTag;
01738     ULONG realsize;
01739 
01740 
01741     DriverTagValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TagCell);
01742     DriverTag = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DriverTagValue, realsize);
01743 
01744     OrderCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01745                                    (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,GroupOrderCell),
01746                                    GroupName);
01747     <span class="keywordflow">if</span> (OrderCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01748         <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/cmboot_8c.html#a1">LOAD_NEXT_TO_LAST</a>);
01749     }
01750 
01751     TagValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, OrderCell);
01752     OrderVector = (PULONG)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, TagValue,realsize);
01753 
01754     <span class="keywordflow">for</span> (CurrentTag=1; CurrentTag &lt;= OrderVector[0]; CurrentTag++) {
01755         <span class="keywordflow">if</span> (OrderVector[CurrentTag] == *DriverTag) {
01756             <span class="comment">//</span>
01757             <span class="comment">// We have found a matching tag in the OrderVector, so return</span>
01758             <span class="comment">// its index.</span>
01759             <span class="comment">//</span>
01760             <span class="keywordflow">return</span>(CurrentTag);
01761         }
01762     }
01763 
01764     <span class="comment">//</span>
01765     <span class="comment">// There was no matching tag in the OrderVector.</span>
01766     <span class="comment">//</span>
01767     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/cmboot_8c.html#a1">LOAD_NEXT_TO_LAST</a>);
01768 
01769 }
01770 
01771 <span class="preprocessor">#ifdef _WANT_MACHINE_IDENTIFICATION</span>
01772 <span class="preprocessor"></span>
01773 BOOLEAN
01774 CmpGetBiosDateFromRegistry(
01775     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01776     IN HCELL_INDEX ControlSet,
01777     OUT PUNICODE_STRING Date
01778     )
01779 
01780 <span class="comment">/*++</span>
01781 <span class="comment"></span>
01782 <span class="comment">Routine Description:</span>
01783 <span class="comment"></span>
01784 <span class="comment">    Reads and returns the BIOS date from the registry.</span>
01785 <span class="comment"></span>
01786 <span class="comment">Arguments:</span>
01787 <span class="comment"></span>
01788 <span class="comment">    Hive - Supplies the hive control structure for the driver.</span>
01789 <span class="comment"></span>
01790 <span class="comment">    ControlSet - Supplies the HCELL_INDEX of the root cell of the hive.</span>
01791 <span class="comment"></span>
01792 <span class="comment">    Date - Receives the date string in the format "mm/dd/yy".</span>
01793 <span class="comment">    </span>
01794 <span class="comment">Return Value:</span>
01795 <span class="comment"></span>
01796 <span class="comment">        TRUE iff successful, else FALSE.</span>
01797 <span class="comment">        </span>
01798 <span class="comment">--*/</span>
01799 
01800 {
01801     UNICODE_STRING  name;
01802     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>;
01803     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     biosInfo;
01804     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     valueCell;
01805     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>   value;
01806     ULONG           realSize;
01807 
01808     <span class="comment">//</span>
01809     <span class="comment">// Find CONTROL node</span>
01810     <span class="comment">//</span>
01811     
01812     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"Control"</span>);
01813     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(  Hive,
01814                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ControlSet),
01815                                     &amp;name);
01816     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01817     
01818         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01819     }
01820 
01821     <span class="comment">//</span>
01822     <span class="comment">// Find BIOSINFO node</span>
01823     <span class="comment">//</span>
01824     
01825     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"BIOSINFO"</span>);
01826     biosInfo = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>( Hive,
01827                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, control),
01828                                     &amp;name);
01829     <span class="keywordflow">if</span> (biosInfo == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01830     
01831         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01832     }
01833     
01834     <span class="comment">//</span>
01835     <span class="comment">// Find SystemBiosDate value</span>
01836     <span class="comment">//</span>
01837     
01838     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"SystemBiosDate"</span>);
01839     valueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>( Hive,
01840                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, biosInfo),
01841                                     &amp;name);
01842     <span class="keywordflow">if</span> (valueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01843     
01844         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01845     }
01846 
01847     value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, valueCell);
01848     Date-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, value, realSize);
01849     Date-&gt;MaximumLength=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realSize;
01850     Date-&gt;Length = 0;
01851     <span class="keywordflow">while</span> ( (Date-&gt;Length &lt; Date-&gt;MaximumLength) &amp;&amp;
01852             (Date-&gt;Buffer[Date-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
01853             
01854         Date-&gt;Length += <span class="keyword">sizeof</span>(WCHAR);
01855     }
01856 
01857     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01858 }
01859 
01860 BOOLEAN
01861 CmpGetBiosinfoFileNameFromRegistry(
01862     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01863     IN HCELL_INDEX ControlSet,
01864     OUT PUNICODE_STRING InfName
01865     )
01866 {
01867     UNICODE_STRING  name;
01868     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>;
01869     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     biosInfo;
01870     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     valueCell;
01871     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>   value;
01872     ULONG           realSize;
01873 
01874     <span class="comment">//</span>
01875     <span class="comment">// Find CONTROL node</span>
01876     <span class="comment">//</span>
01877     
01878     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"Control"</span>);
01879     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(  Hive,
01880                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ControlSet),
01881                                     &amp;name);
01882     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01883     
01884         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01885     }
01886 
01887     <span class="comment">//</span>
01888     <span class="comment">// Find BIOSINFO node</span>
01889     <span class="comment">//</span>
01890     
01891     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"BIOSINFO"</span>);
01892     biosInfo = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>( Hive,
01893                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, control),
01894                                     &amp;name);
01895     <span class="keywordflow">if</span> (biosInfo == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01896     
01897         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01898     }
01899     
01900     <span class="comment">//</span>
01901     <span class="comment">// Find InfName value</span>
01902     <span class="comment">//</span>
01903     
01904     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;name, L<span class="stringliteral">"InfName"</span>);
01905     valueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>( Hive,
01906                                     (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, biosInfo),
01907                                     &amp;name);
01908     <span class="keywordflow">if</span> (valueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01909     
01910         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01911     }
01912     
01913     value = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, valueCell);
01914     InfName-&gt;Buffer = (PWSTR)<a class="code" href="../../d0/d0/cmboot_8c.html#a2">CmpValueToData</a>(Hive, value, realSize);
01915     InfName-&gt;MaximumLength=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)realSize;
01916     InfName-&gt;Length = 0;
01917     <span class="keywordflow">while</span> ( (InfName-&gt;Length &lt; InfName-&gt;MaximumLength) &amp;&amp;
01918             (InfName-&gt;Buffer[InfName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)] != UNICODE_NULL)) {
01919             
01920         InfName-&gt;Length += <span class="keyword">sizeof</span>(WCHAR);
01921     }
01922 
01923     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01924 }
01925 
01926 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
