<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/alpha/kdtrap.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdtrap.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/4_2alpha_2kdtrap_8c.html#a0">KdpTrap</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/4_2alpha_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d9/4_2alpha_2kdtrap_8c.html#a2">KdpStub</a> (IN PKTRAP_FRAME TrapFrame, IN PKEXCEPTION_FRAME ExceptionFrame, IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, IN BOOLEAN SecondChance)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="4/alpha/kdtrap.c::KdIsThisAKdTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdIsThisAKdTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html#l00271">271</a> of file <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html">4/alpha/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00617">BREAKIN_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00616">KERNEL_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00279                    :
00280 
00281     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a user-mode exception occurs and
00282     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> might be a kernel debugger exception (Like DbgPrint/DbgPrompt ).
00283 
00284 Arguments:
00285 
00286     ExceptionRecord - Supplies a pointer to an exception record that
00287         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00288 
00289     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00290 
00291     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00292 
00293 Return Value:
00294 
00295     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger.
00296     Otherwise, a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00297 
00298 --*/
00299 
00300 {
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00304     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00305     <span class="comment">// of the exception record.</span>
00306     <span class="comment">//</span>
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// Switch on the breakpoint code.</span>
00310     <span class="comment">//</span>
00311 
00312     <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00313 
00314         <span class="comment">//</span>
00315         <span class="comment">// Kernel breakpoint code.</span>
00316         <span class="comment">//</span>
00317 
00318     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>:
00319     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00320 <span class="preprocessor">#if DEVL</span>
00321 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00322 <span class="preprocessor">#else</span>
00323 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00324             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00325 
00326         } <span class="keywordflow">else</span> {
00327             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328         }
00329 <span class="preprocessor">#endif</span>
00330 <span class="preprocessor"></span>
00331         <span class="comment">//</span>
00332         <span class="comment">// Debug print code.</span>
00333         <span class="comment">//</span>
00334 
00335     <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00336         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">// Debug prompt code.</span>
00340         <span class="comment">//</span>
00341     <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00342         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">// Debug stop code.</span>
00346         <span class="comment">//</span>
00347 
00348     <span class="keywordflow">case</span> DEBUG_STOP_BREAKPOINT:
00349 <span class="preprocessor">#if DEVL</span>
00350 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00351 <span class="preprocessor">#else</span>
00352 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00353             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00354 
00355         } <span class="keywordflow">else</span> {
00356             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00357         }
00358 <span class="preprocessor">#endif</span>
00359 <span class="preprocessor"></span>
00360         <span class="comment">//</span>
00361         <span class="comment">// Debug load symbols code.</span>
00362         <span class="comment">//</span>
00363 
00364     <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00365         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00366             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00367 
00368         } <span class="keywordflow">else</span> {
00369             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00370         }
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">// Debug unload symbols code.</span>
00374         <span class="comment">//</span>
00375 
00376     <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00377         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00378             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00379 
00380         } <span class="keywordflow">else</span> {
00381             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382         }
00383         <span class="comment">//</span>
00384         <span class="comment">// All other codes.</span>
00385         <span class="comment">//</span>
00386 
00387     <span class="keywordflow">default</span>:
00388         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00389     }
00390 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/alpha/kdtrap.c::KdpStub" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpStub           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html#l00393">393</a> of file <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html">4/alpha/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00616">KERNEL_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00404                    :
00405 
00406     This routine provides a kernel debugger stub routine that catchs debug
00407     prints in checked systems when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not active.
00408 
00409 Arguments:
00410 
00411     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00412         trap.
00413 
00414     ExceptionFrame - Supplies a pointer to a exception frame that describes
00415         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00416 
00417     ExceptionRecord - Supplies a pointer to an exception record that
00418         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00419 
00420     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00421 
00422     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00423 
00424     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00425         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00426 
00427 Return Value:
00428 
00429     A value of TRUE is returned if the exception is handled. Otherwise a
00430     value of FALSE is returned.
00431 
00432 --*/
00433 
00434 {
00435 
00436     ULONG_PTR BreakpointCode;
00437 
00438     <span class="comment">//</span>
00439     <span class="comment">// Isolate the breakpoint code from the breakpoint instruction which</span>
00440     <span class="comment">// is stored by the exception dispatch code in the information field</span>
00441     <span class="comment">// of the exception record.</span>
00442     <span class="comment">//</span>
00443 
00444     BreakpointCode = ExceptionRecord-&gt;ExceptionInformation[0];
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">// If the breakpoint is a debug print, debug load symbols, or debug</span>
00448     <span class="comment">// unload symbols, then return TRUE. Otherwise, return FALSE;</span>
00449     <span class="comment">//</span>
00450 
00451     <span class="keywordflow">if</span> ((BreakpointCode == DEBUG_PRINT_BREAKPOINT) ||
00452         (BreakpointCode == DEBUG_LOAD_SYMBOLS_BREAKPOINT) ||
00453         (BreakpointCode == DEBUG_UNLOAD_SYMBOLS_BREAKPOINT) ||
00454         (BreakpointCode == <a class="code" href="../../d6/d7/halmips_8h.html#a453">KERNEL_BREAKPOINT</a>)) {
00455         ContextRecord-&gt;Fir += 4;
00456         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00457     } <span class="keywordflow">else</span> {
00458         <span class="keywordflow">if</span> ( (BreakpointCode == DEBUG_STOP_BREAKPOINT) &amp;&amp;
00459              (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) ){
00460              ContextRecord-&gt;Fir += 4;
00461              <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00462         } <span class="keywordflow">else</span> {
00463             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00464         }
00465     }
00466 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="4/alpha/kdtrap.c::KdpTrap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdpTrap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKEXCEPTION_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SecondChance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html#l00028">28</a> of file <a class="el" href="../../d2/d8/4_2alpha_2kdtrap_8c-source.html">4/alpha/kdtrap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00617">BREAKIN_BREAKPOINT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00133">KdDebuggerNotPresent</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00277">KdEnterDebugger()</a>, <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l00355">KdExitDebugger()</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00414">KdLogDbgPrint()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00261">KdpControlCPressed</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00030">KdpPrintString()</a>, <a class="el" href="../../d1/d5/kddbgio_8c-source.html#l00110">KdpPromptString()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02351">KdpReportExceptionStateChange()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02434">KdpReportLoadSymbolsStateChange()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00039                    :
00040 
00041     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called whenever a exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dispatched and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel
00042     debugger <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> active.
00043 
00044 Arguments:
00045 
00046     TrapFrame - Supplies a pointer to a trap frame that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00047         trap.
00048 
00049     ExceptionFrame - Supplies a pointer to a exception frame that describes
00050         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap.
00051 
00052     ExceptionRecord - Supplies a pointer to an exception record that
00053         describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00054 
00055     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception.
00056 
00057     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous processor mode.
00058 
00059     SecondChance - Supplies a <span class="keywordtype">boolean</span> value that determines whether <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00060         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second chance (TRUE) that the exception has been raised.
00061 
00062 Return Value:
00063 
00064     A value of TRUE is returned if the exception is handled. Otherwise a
00065     value of FALSE is returned.
00066 
00067 --*/
00068 
00069 {
00070 
00071     BOOLEAN Completion;
00072     BOOLEAN Enable;
00073     BOOLEAN UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00074     STRING Input;
00075     ULONGLONG OldFir;
00076     STRING Output;
00077     PKPRCB Prcb;
00078 
00079     <span class="comment">//</span>
00080     <span class="comment">// Enter debugger and synchronize processor execution.</span>
00081     <span class="comment">//</span>
00082 
00083     <span class="comment">//</span>
00084     <span class="comment">// If this is a breakpoint instruction, then check to determine if is</span>
00085     <span class="comment">// an internal command.</span>
00086     <span class="comment">//</span>
00087 
00088     <span class="keywordflow">if</span> ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) &amp;&amp;
00089         (ExceptionRecord-&gt;ExceptionInformation[0] &gt;= DEBUG_PRINT_BREAKPOINT)){
00090 
00091         <span class="comment">//</span>
00092         <span class="comment">// Switch on the breakpoint code.</span>
00093         <span class="comment">//</span>
00094 
00095         <span class="keywordflow">switch</span> (ExceptionRecord-&gt;ExceptionInformation[0]) {
00096 
00097             <span class="comment">//</span>
00098             <span class="comment">// Print a debug string.</span>
00099             <span class="comment">//</span>
00100             <span class="comment">// Arguments:</span>
00101             <span class="comment">//</span>
00102             <span class="comment">//   a0 - Supplies a pointer to an output string buffer.</span>
00103             <span class="comment">//   a1 - Supplies the length of the output string buffer.</span>
00104             <span class="comment">//</span>
00105 
00106         <span class="keywordflow">case</span> DEBUG_PRINT_BREAKPOINT:
00107 
00108             ContextRecord-&gt;Fir += 4;
00109             Output.Buffer = (PCHAR)ContextRecord-&gt;IntA0;
00110             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntA1;
00111 
00112             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;Output);
00113 
00114             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00115 
00116                 Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00117                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/4_2kdp_8h.html#a102">KdpPrintString</a>(&amp;Output)) {
00118                     ContextRecord-&gt;IntV0 = (ULONG)STATUS_BREAKPOINT;
00119                 } <span class="keywordflow">else</span> {
00120                     ContextRecord-&gt;IntV0 = (ULONG)STATUS_SUCCESS;
00121                 }
00122                 <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00123 
00124             } <span class="keywordflow">else</span> {
00125                 ContextRecord-&gt;IntV0 = (ULONG)STATUS_DEVICE_NOT_CONNECTED;
00126             }
00127 
00128             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00129 
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">// Stop in the debugger</span>
00133             <span class="comment">//</span>
00134             <span class="comment">// As this is not a normal breakpoint we must increment the</span>
00135             <span class="comment">// context past the breakpoint instruction</span>
00136             <span class="comment">//</span>
00137 
00138         <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a454">BREAKIN_BREAKPOINT</a>:
00139 
00140             ContextRecord-&gt;Fir += 4;
00141             <span class="keywordflow">break</span>;
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">// Print a debug prompt string, then input a string.</span>
00145             <span class="comment">//</span>
00146             <span class="comment">//   a0 - Supplies a pointer to an output string buffer.</span>
00147             <span class="comment">//   a1 - Supplies the length of the output string buffer..</span>
00148             <span class="comment">//   a2 - supplies a pointer to an input string buffer.</span>
00149             <span class="comment">//   a3 - Supplies the length of the input string bufffer.</span>
00150             <span class="comment">//</span>
00151 
00152         <span class="keywordflow">case</span> DEBUG_PROMPT_BREAKPOINT:
00153 
00154             ContextRecord-&gt;Fir += 4;
00155             Output.Buffer = (PCHAR)ContextRecord-&gt;IntA0;
00156             Output.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntA1;
00157             Input.Buffer = (PCHAR)ContextRecord-&gt;IntA2;
00158             Input.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ContextRecord-&gt;IntA3;
00159 
00160             <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a>(&amp;Output);
00161 
00162             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00163 
00164             <a class="code" href="../../d1/d7/4_2kdp_8h.html#a103">KdpPromptString</a>(&amp;Output, &amp;Input);
00165 
00166             ContextRecord-&gt;IntV0 = Input.Length;
00167 
00168             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00169             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">// Load the symbolic information for an image.</span>
00173             <span class="comment">//</span>
00174             <span class="comment">// Arguments:</span>
00175             <span class="comment">//</span>
00176             <span class="comment">//    a0 - Supplies a pointer to an output string descriptor.</span>
00177             <span class="comment">//    a1 - Supplies a the base address of the image.</span>
00178             <span class="comment">//    a2 - Supplies the current process id.</span>
00179             <span class="comment">//</span>
00180 
00181         <span class="keywordflow">case</span> DEBUG_UNLOAD_SYMBOLS_BREAKPOINT:
00182 
00183             UnloadSymbols = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00184 
00185             <span class="comment">//</span>
00186             <span class="comment">// Fall through</span>
00187             <span class="comment">//</span>
00188 
00189         <span class="keywordflow">case</span> DEBUG_LOAD_SYMBOLS_BREAKPOINT:
00190 
00191             Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00192             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00193             OldFir = ContextRecord-&gt;Fir;
00194             RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00195                           ContextRecord,
00196                           <span class="keyword">sizeof</span>(CONTEXT));
00197 
00198             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00199 
00200                 <a class="code" href="../../d1/d7/4_2kdp_8h.html#a121">KdpReportLoadSymbolsStateChange</a>((PSTRING)ContextRecord-&gt;IntA0,
00201                                                 (<a class="code" href="../../d6/d5/struct__KD__SYMBOLS__INFO.html">PKD_SYMBOLS_INFO</a>) ContextRecord-&gt;IntA1,
00202                                                 UnloadSymbols,
00203                                                 &amp;Prcb-&gt;ProcessorState.ContextFrame);
00204 
00205             }
00206 
00207             RtlCopyMemory(ContextRecord,
00208                           &amp;Prcb-&gt;ProcessorState.ContextFrame,
00209                           <span class="keyword">sizeof</span>(CONTEXT));
00210 
00211             <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">// If the kernel debugger did not update the FIR, then increment</span>
00215             <span class="comment">// past the breakpoint instruction.</span>
00216             <span class="comment">//</span>
00217 
00218             <span class="keywordflow">if</span> (ContextRecord-&gt;Fir == OldFir) {
00219                 ContextRecord-&gt;Fir += 4;
00220             }
00221 
00222             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00223 
00224             <span class="comment">//</span>
00225             <span class="comment">// Unknown internal command.</span>
00226             <span class="comment">//</span>
00227 
00228         <span class="keywordflow">default</span>:
00229 
00230             <span class="keywordflow">break</span>;
00231         }
00232     }
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Report state change to kernel debugger on host machine.</span>
00236     <span class="comment">//</span>
00237 
00238     Enable = <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a17">KdEnterDebugger</a>(TrapFrame, ExceptionFrame);
00239     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00240 
00241     RtlCopyMemory(&amp;Prcb-&gt;ProcessorState.ContextFrame,
00242                     ContextRecord,
00243                     sizeof (CONTEXT));
00244 
00245     Completion = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a120">KdpReportExceptionStateChange</a>(ExceptionRecord,
00246                                                &amp;Prcb-&gt;ProcessorState.ContextFrame,
00247                                                SecondChance);
00248 
00249     RtlCopyMemory(ContextRecord,
00250                   &amp;Prcb-&gt;ProcessorState.ContextFrame,
00251                   <span class="keyword">sizeof</span>(CONTEXT));
00252 
00253     <a class="code" href="../../d9/d3/4_2kdapi_8c.html#a18">KdExitDebugger</a>(Enable);
00254 
00255     <a class="code" href="../../d8/d5/kddata_8c.html#a90">KdpControlCPressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Always return TRUE if this is the first chance to handle the</span>
00259     <span class="comment">// exception.  Otherwise, return the completion status of the</span>
00260     <span class="comment">// state change reporting.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span>( SecondChance ){
00264         <span class="keywordflow">return</span> Completion;
00265     } <span class="keywordflow">else</span> {
00266         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00267     }
00268 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
