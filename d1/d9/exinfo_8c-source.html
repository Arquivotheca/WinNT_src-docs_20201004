<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exinfo.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exinfo.c</h1><a href="../../d0/d0/exinfo_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    exinfo.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the NT set anmd query system information services.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Ken Reneris (kenr) 19-July-1994</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Kernel mode only.</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment">--*/</span>
00024 
00025 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00026 
00027 <span class="preprocessor">#if _PNP_POWER_</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpCheckSystemInformation)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpCheckSystemInfoWork)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif // _PNP_POWER_</span>
00032 <span class="preprocessor"></span>
00033 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00034 <a class="code" href="../../d4/d0/exp_8h.html#a36">ExpCheckSystemInformation</a> (
00035     PVOID       Context,
00036     PVOID       InformationClass,
00037     PVOID       Argument2
00038     )
00039 <span class="comment">/*++</span>
00040 <span class="comment"></span>
00041 <span class="comment">Routine Description:</span>
00042 <span class="comment"></span>
00043 <span class="comment">    Callback function invoked when something in the system information</span>
00044 <span class="comment">    may have changed.</span>
00045 <span class="comment"></span>
00046 <span class="comment">Arguments:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    Context - Where invoked from.</span>
00049 <span class="comment"></span>
00050 <span class="comment">    InformationClass - which class for the given context was set</span>
00051 <span class="comment">        (ignored for now)</span>
00052 <span class="comment"></span>
00053 <span class="comment">    Argument2</span>
00054 <span class="comment"></span>
00055 <span class="comment">Return Value:</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 {
00059     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a> (&amp;ExpCheckSystemInfoWorkItem, DelayedWorkQueue);
00060 }
00061 
00062 
00063 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00064 <a class="code" href="../../d4/d0/exp_8h.html#a34">ExpCheckSystemInfoWork</a> (
00065     IN PVOID Context
00066     )
00067 <span class="comment">/*++</span>
00068 <span class="comment"></span>
00069 <span class="comment">Routine Description:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Verifies registery data for various system information classes</span>
00072 <span class="comment">    is up to date.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Arguments:</span>
00075 <span class="comment"></span>
00076 <span class="comment">Return Value:</span>
00077 <span class="comment"></span>
00078 <span class="comment">--*/</span>
00079 {
00080     <span class="keyword">static</span> <span class="keyword">struct </span>{
00081         SYSTEM_INFORMATION_CLASS         InformationLevel;
00082         ULONG                            <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00083     } RegistryInformation[] = {
00084         SystemBasicInformation,          <span class="keyword">sizeof</span> (SYSTEM_BASIC_INFORMATION),
00085         SystemPowerInformation,          <span class="keyword">sizeof</span> (SYSTEM_POWER_INFORMATION),
00086         SystemProcessorSpeedInformation, <span class="keyword">sizeof</span> (SYSTEM_PROCESSOR_SPEED_INFORMATION),
00087         0,                               0
00088     };
00089 
00090     <span class="keyword">struct </span>{
00091         KEY_VALUE_PARTIAL_INFORMATION   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00092         <span class="keyword">union </span>{
00093             SYSTEM_BASIC_INFORMATION BasicInformation;
00094             SYSTEM_POWER_INFORMATION PowerSettings;
00095             SYSTEM_PROCESSOR_SPEED_INFORMATION  ProcessorSpeed;
00096         };
00097     } RegistryBuffer, QueryBuffer;
00098 
00099     ULONG               <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, disposition, length;
00100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00101     OBJECT_ATTRIBUTES   objectAttributes;
00102     UNICODE_STRING      unicodeString, ValueString;
00103     HANDLE              CurrentControlSet, SystemInformation, LevelInformation;
00104     LARGE_INTEGER       Interval;
00105     BOOLEAN             Rescan;
00106     WCHAR               wstr[10];
00107 
00108     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">// Only one worked needed at a time needed to update the SystemInformation</span>
00112     <span class="comment">// data in the registry</span>
00113     <span class="comment">//</span>
00114 
00115     <span class="keywordflow">if</span> (InterlockedIncrement (&amp;ExpCheckSystemInfoBusy) != 0) {
00116         <span class="keywordflow">return</span> ;
00117     }
00118 
00119     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;ValueString,  ExpWstrSystemInformationValue);
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">// Open CurrentControlSet</span>
00123     <span class="comment">//</span>
00124 
00125     InitializeObjectAttributes( &amp;objectAttributes,
00126                                 &amp;CmRegistryMachineSystemCurrentControlSet,
00127                                 OBJ_CASE_INSENSITIVE,
00128                                 NULL,
00129                                 NULL );
00130 
00131     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a> (&amp;CurrentControlSet,
00132                         KEY_READ | KEY_WRITE,
00133                         &amp;objectAttributes );
00134 
00135     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00136 
00137         <span class="comment">//</span>
00138         <span class="comment">// Open SystemInformation</span>
00139         <span class="comment">//</span>
00140 
00141         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, ExpWstrSystemInformation );
00142         InitializeObjectAttributes( &amp;objectAttributes,
00143                                     &amp;unicodeString,
00144                                     OBJ_CASE_INSENSITIVE,
00145                                     CurrentControlSet,
00146                                     NULL );
00147 
00148         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> ( &amp;SystemInformation,
00149                                KEY_READ | KEY_WRITE,
00150                                &amp;objectAttributes,
00151                                0,
00152                                NULL,
00153                                REG_OPTION_VOLATILE,
00154                                &amp;disposition );
00155 
00156         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (CurrentControlSet);
00157     }
00158 
00159     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00160         InterlockedDecrement (&amp;ExpCheckSystemInfoBusy);
00161         <span class="keywordflow">return</span> ;
00162     }
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Loop and check SystemInformation data in registry</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">do</span> {
00169         Rescan = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// Wait a moment</span>
00173         <span class="comment">//</span>
00174 
00175         Interval.QuadPart = -3000000;
00176         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;Interval);
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// For now just check each SystemInformation level and update</span>
00180         <span class="comment">// any level which is out of date</span>
00181         <span class="comment">//</span>
00182 
00183         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>=0; RegistryInformation[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].BufferSize; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
00184 
00185             <span class="comment">//</span>
00186             <span class="comment">// Initialize registry data buffer</span>
00187             <span class="comment">//</span>
00188 
00189             <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = RegistryInformation[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].BufferSize;
00190             RtlZeroMemory (RegistryBuffer.Key.Data, BufferSize);
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">// Open appropiate SystemInformation level key</span>
00194             <span class="comment">//</span>
00195 
00196             swprintf (wstr, L<span class="stringliteral">"%d"</span>, RegistryInformation[Index].InformationLevel);
00197             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;unicodeString, wstr);
00198             InitializeObjectAttributes( &amp;objectAttributes,
00199                                         &amp;unicodeString,
00200                                         OBJ_CASE_INSENSITIVE,
00201                                         SystemInformation,
00202                                         NULL );
00203 
00204             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a> ( &amp;LevelInformation,
00205                                    KEY_READ | KEY_WRITE,
00206                                    &amp;objectAttributes,
00207                                    0,
00208                                    NULL,
00209                                    REG_OPTION_VOLATILE,
00210                                    &amp;disposition );
00211 
00212             <span class="comment">//</span>
00213             <span class="comment">// If key opened, read current data value from the registry</span>
00214             <span class="comment">//</span>
00215 
00216             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00217                 <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a> (
00218                     LevelInformation,
00219                     &amp;ValueString,
00220                     KeyValuePartialInformation,
00221                     &amp;RegistryBuffer.Key,
00222                     sizeof (RegistryBuffer),
00223                     &amp;length
00224                     );
00225             }
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">// Query current SystemInformation data</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d8/sysinfo_8c.html#a49">NtQuerySystemInformation</a> (
00232                             RegistryInformation[Index].InformationLevel,
00233                             &amp;QueryBuffer.Key.Data,
00234                             BufferSize,
00235                             NULL
00236                         );
00237 
00238             <span class="comment">//</span>
00239             <span class="comment">// Check if current SystemInformation matches the registry</span>
00240             <span class="comment">// information</span>
00241             <span class="comment">//</span>
00242 
00243             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)  &amp;&amp;
00244                 !RtlEqualMemory (RegistryBuffer.Key.Data,
00245                                  QueryBuffer.Key.Data,
00246                                  BufferSize) ) {
00247 
00248                 <span class="comment">//</span>
00249                 <span class="comment">// Did not match - update registry to current SystemInfomration</span>
00250                 <span class="comment">//</span>
00251 
00252                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a> (
00253                             LevelInformation,
00254                             &amp;ValueString,
00255                             0L,
00256                             REG_BINARY,
00257                             QueryBuffer.Key.Data,
00258                             BufferSize
00259                             );
00260 
00261                 <span class="comment">//</span>
00262                 <span class="comment">// Make notificant that this information level has changed</span>
00263                 <span class="comment">//</span>
00264 
00265                 <a class="code" href="../../d5/d8/ex_8h.html#a323">ExNotifyCallback</a> (
00266                     ExCbSetSystemInformation,
00267                     (PVOID) RegistryInformation[Index].InformationLevel,
00268                     (PVOID) NULL
00269                 );
00270             }
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">// Close this InformatiobLevel and check the next one</span>
00274             <span class="comment">//</span>
00275 
00276             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (LevelInformation);
00277         }
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">// If no Rescan, remove our count from the busy flag</span>
00281         <span class="comment">//</span>
00282 
00283         <span class="keywordflow">if</span> (!Rescan &amp;&amp;
00284             InterlockedDecrement (&amp;ExpCheckSystemInfoBusy) &gt;= 0) {
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">// Some other worker thread attempted to perform a scan.  Reset</span>
00288             <span class="comment">// counter to 1 and loop</span>
00289             <span class="comment">//</span>
00290 
00291             ExInterlockedExchangeUlong ((PULONG) &amp;ExpCheckSystemInfoBusy, 0, &amp;ExpCheckSystemInfoLock);
00292             Rescan = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00293         }
00294 
00295     } <span class="keywordflow">while</span> (Rescan);
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">// Cleanup</span>
00299     <span class="comment">//</span>
00300 
00301     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (SystemInformation);
00302 }
00303 
00304 <span class="preprocessor">#endif  // _PNP_POWER_</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
