<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ex/profile.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>profile.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>

<p>
<a href="../../d0/d6/ex_2profile_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a0">ACTIVE_PROFILE_LIMIT</a>&nbsp;&nbsp;&nbsp;8</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a1">EPROFILE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a7">ExpProfileInitialization</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a8">ExpProfileDelete</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a9">NtCreateProfile</a> (OUT PHANDLE ProfileHandle, IN HANDLE Process OPTIONAL, IN PVOID RangeBase, IN SIZE_T RangeSize, IN ULONG BucketSize, IN PULONG <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG <a class="el" href="../../d7/d2/rtqval_8c.html#a7">BufferSize</a>, IN KPROFILE_SOURCE ProfileSource, IN KAFFINITY Affinity)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> (IN HANDLE ProfileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> (IN HANDLE ProfileHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a12">NtSetIntervalProfile</a> (IN ULONG Interval, IN KPROFILE_SOURCE Source)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a13">NtQueryIntervalProfile</a> (IN KPROFILE_SOURCE ProfileSource, OUT PULONG Interval)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a> (OUT PLARGE_INTEGER PerformanceCounter, OUT PLARGE_INTEGER PerformanceFrequency OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a5">ExpCurrentProfileUsage</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>GENERIC_MAPPING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d6/ex_2profile_8c.html#a6">ExpProfileMapping</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="ex/profile.c::ACTIVE_PROFILE_LIMIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ACTIVE_PROFILE_LIMIT&nbsp;&nbsp;&nbsp;8          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00064">64</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a1" doxytag="ex/profile.c::EPROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a>  <a class="el" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ex/profile.c::PEPROFILE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d4/struct__EPROFILE.html">_EPROFILE</a> * <a class="el" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">ExpProfileDelete()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a8" doxytag="ex/profile.c::ExpProfileDelete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ExpProfileDelete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">145</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00520">KeStopProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00040">_EPROFILE::LockedBufferAddress</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00041">_EPROFILE::Mdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00033">_EPROFILE::Process</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00039">_EPROFILE::ProfileObject</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">ExpProfileInitialization()</a>.
<p>
<pre class="fragment"><div>00151                    :
00152 
00153 
00154     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object management procedures whenever
00155     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last reference to a profile object has been removed.  This routine
00156     stops profiling, returns locked buffers and pages, dereferences <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00157     specified process and returns.
00158 
00159 Arguments:
00160 
00161     Object - a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile object.
00162 
00163 Return Value:
00164 
00165     None.
00166 
00167 --*/
00168 
00169 {
00170     <a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a> Profile;
00171     BOOLEAN   State;
00172     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessAddress;
00173 
00174     Profile = (<a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a>)Object;
00175 
00176     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// Stop profiling and unlock the buffers and deallocate pool.</span>
00180         <span class="comment">//</span>
00181 
00182         State = <a class="code" href="../../d0/d8/profobj_8c.html#a9">KeStopProfile</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00183         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != FALSE);
00184 
00185         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a>, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00186         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00188     }
00189 
00190     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         ProcessAddress = CONTAINING_RECORD(Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a>, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Pcb);
00192         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)ProcessAddress);
00193     }
00194 
00195     <span class="keywordflow">return</span>;
00196 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ex/profile.c::ExpProfileInitialization" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ExpProfileInitialization           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">79</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">ExpProfileDelete()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00057">ExpProfileMapping</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00053">ExpProfileStateMutex</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00051">ExProfileObjectType</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00099">KeInitializeMutex()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d9/exlevels_8h-source.html#l00013">MUTEX_LEVEL_EX_PROFILE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00084                    :
00085 
00086     This function creates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor at system
00087     initialization and stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor
00088     in global storage.
00089 
00090 Arguments:
00091 
00092     None.
00093 
00094 Return Value:
00095 
00096     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00097     successfully initialized. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00098 
00099 --*/
00100 
00101 {
00102 
00103     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00104     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00105     UNICODE_STRING TypeName;
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">// Initialize mutex for synchronizing start and stop operations.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d3/d5/mutntobj_8c.html#a2">KeInitializeMutex</a> (&amp;ExpProfileStateMutex, MUTEX_LEVEL_EX_PROFILE);
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">// Initialize string descriptor.</span>
00115     <span class="comment">//</span>
00116 
00117     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, L<span class="stringliteral">"Profile"</span>);
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Create event object type descriptor.</span>
00121     <span class="comment">//</span>
00122 
00123     RtlZeroMemory(&amp;ObjectTypeInitializer,<span class="keyword">sizeof</span>(ObjectTypeInitializer));
00124     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o0">Length</a> = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00125     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o3">InvalidAttributes</a> = OBJ_OPENLINK;
00126     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a> = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00127     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>);
00128     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> = PROFILE_ALL_ACCESS;
00129     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a> = <a class="code" href="../../d4/d0/exp_8h.html#a31">ExpProfileDelete</a>;
00130     ObjectTypeInitializer.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> = <a class="code" href="../../d9/d6/ex_2profile_8c.html#a6">ExpProfileMapping</a>;
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00133                                 &amp;ObjectTypeInitializer,
00134                                 (PSECURITY_DESCRIPTOR)NULL,
00135                                 &amp;ExProfileObjectType);
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// If the event object type descriptor was successfully created, then</span>
00139     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00140     <span class="comment">//</span>
00141 
00142     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status));
00143 }
<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ex/profile.c::NtCreateProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtCreateProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE Process&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>RangeBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>RangeSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BucketSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPROFILE_SOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KAFFINITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Affinity</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">199</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00045">BufferSize</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d6/ex_2profile_8c.html#a1">EPROFILE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00051">ExProfileObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01681">SeSystemProfilePrivilege</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/tprofile_8c-source.html#l00024">main()</a>.
<p>
<pre class="fragment"><div>00213                    :
00214 
00215     This function creates a profile object.
00216 
00217 Arguments:
00218 
00219     ProfileHandle - Supplies a pointer to a variable that will receive
00220                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile object handle.
00221 
00222     Process - Optionally, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose
00223               address space to profile.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> (0), then
00224               all address spaces are included in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile.
00225 
00226     RangeBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first byte of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address
00227                   space <span class="keywordflow">for</span> which profiling information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be collected.
00228 
00229 
00230     RangeSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range to profile in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00231                 address space.  RangeBase and RangeSize are interpreted
00232                 such that RangeBase &lt;= address &lt; RangeBase+RangeSize
00233                 will generate a profile hit.
00234 
00235     BucketSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LOG base 2 of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profiling
00236                  bucket.  Thus, BucketSize = 2 yields four-byte
00237                  buckets, BucketSize = 7 yields 128-byte buckets.
00238                  All profile hits in a given bucket will increment
00239                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding counter in <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  Buckets
00240                  cannot be smaller than a ULONG.  The acceptable range
00241                  of <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 2 to 30 inclusive.
00242 
00243     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies an array of ULONGs.  Each ULONG <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a hit counter,
00244              which records <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of hits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00245              bucket.
00246 
00247     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> in bytes of <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.
00248 
00249     ProfileSource - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile interrupt
00250 
00251     Affinity - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor set <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile interrupt
00252 
00253 Return Value:
00254 
00255     TBS
00256 
00257 --*/
00258 
00259 {
00260 
00261     <a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a> Profile;
00262     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00263     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00265     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessAddress;
00266     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00267     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00268     ULONG Segment = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00269     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PowerOf2;
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Verify that the base and size arguments are reasonable.</span>
00273     <span class="comment">//</span>
00274 
00275     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> == 0) {
00276         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_7;
00277     }
00278 
00279 <span class="preprocessor">#ifdef i386</span>
00280 <span class="preprocessor"></span>    <span class="comment">//</span>
00281     <span class="comment">//        sleazy use of bucket size.  If bucket size is zero, and</span>
00282     <span class="comment">//        RangeBase &lt; 64K, then create a profile object to attach</span>
00283     <span class="comment">//        to a non-flat code segment.  In this case, RangeBase is</span>
00284     <span class="comment">//        the non-flat CS for this profile object.</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> ((BucketSize == 0) &amp;&amp; (RangeBase &lt; (PVOID)(64 * 1024))) {
00288 
00289         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> &lt; <span class="keyword">sizeof</span>(ULONG)) {
00290             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_7;
00291         }
00292 
00293         Segment = (ULONG)RangeBase;
00294         RangeBase = 0;
00295         BucketSize = RangeSize / (<a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> / <span class="keyword">sizeof</span>(ULONG));
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">// Convert Bucket size of log2(BucketSize)</span>
00299         <span class="comment">//</span>
00300         PowerOf2 = 0;
00301         BucketSize = BucketSize - 1;
00302         <span class="keywordflow">while</span> (BucketSize &gt;&gt;= 1) {
00303             PowerOf2++;
00304         }
00305 
00306         BucketSize = PowerOf2 + 1;
00307 
00308         <span class="keywordflow">if</span> (BucketSize &lt; 2) {
00309             BucketSize = 2;
00310         }
00311     }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">if</span> ((BucketSize &gt; 31) || (BucketSize &lt; 2)) {
00315         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00316     }
00317 
00318     <span class="keywordflow">if</span> ((RangeSize &gt;&gt; (BucketSize - 2)) &gt; <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>) {
00319         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00320     }
00321 
00322     <span class="keywordflow">if</span> (((ULONG_PTR)RangeBase + RangeSize) &lt; RangeSize) {
00323         <span class="keywordflow">return</span> STATUS_BUFFER_OVERFLOW;
00324     }
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00328     <span class="comment">// attempt to create a profile object. If the probe fails, then return the</span>
00329     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00330     <span class="comment">// returned by the object insertion routine.</span>
00331     <span class="comment">//</span>
00332 
00333     <span class="keywordflow">try</span> {
00334         <span class="comment">//</span>
00335         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00336         <span class="comment">// necessary.</span>
00337         <span class="comment">//</span>
00338 
00339         PreviousMode = KeGetPreviousMode ();
00340 
00341         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00342             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(ProfileHandle);
00343 
00344             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(Buffer,
00345                           BufferSize,
00346                           <span class="keyword">sizeof</span>(ULONG));
00347         }
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00351     <span class="comment">// then always handle the exception and return the exception code as the</span>
00352     <span class="comment">// status value.</span>
00353     <span class="comment">//</span>
00354 
00355     } except (EXCEPTION_EXECUTE_HANDLER) {
00356         <span class="keywordflow">return</span> GetExceptionCode();
00357     }
00358 
00359 <span class="comment">//</span>
00360 <span class="comment">// TODO post NT5:</span>
00361 <span class="comment">//</span>
00362 <span class="comment">// Currently, if a process isn't specified, there is no privilege check if</span>
00363 <span class="comment">//   RangeBase &gt; MM_HIGHEST_USER_ADDRESS.</span>
00364 <span class="comment">// The check for user-space addresses is SeSystemProfilePrivilege.</span>
00365 <span class="comment">// Querying a specific process requires only PROCESS_QUERY_INFORMATION.</span>
00366 <span class="comment">//</span>
00367 <span class="comment">// The spec says:</span>
00368 <span class="comment">//</span>
00369 <span class="comment">//     Process - If specified, a handle to a process which describes the address space to profile.</span>
00370 <span class="comment">//     If not present, then all address spaces are included in the profile.</span>
00371 <span class="comment">//     Profiling a process requires PROCESS_QUERY_INFORMATION access to that process and</span>
00372 <span class="comment">//     SeProfileSingleProcessPrivilege privilege.</span>
00373 <span class="comment">//     Profiling all processes requires SeSystemProfilePrivilege privilege.</span>
00374 <span class="comment">//</span>
00375 <span class="comment">// So two changes appear needed.</span>
00376 <span class="comment">//   A check on SeProfileSingleProcessPrivilege needs to be added to the single process case,</span>
00377 <span class="comment">//   and SeSystemProfilePrivilege privilege should be required for both user and system address profiling.</span>
00378 <span class="comment">//</span>
00379 
00380 
00381     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(Process)) {
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Don't attach segmented profile objects to all processes</span>
00385         <span class="comment">//</span>
00386 
00387         <span class="keywordflow">if</span> (Segment) {
00388             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00389         }
00390 
00391         <span class="comment">//</span>
00392         <span class="comment">// Profile all processes. Make sure that the specified</span>
00393         <span class="comment">// address range is in system space, unless SeSystemProfilePrivilege.</span>
00394         <span class="comment">//</span>
00395 
00396         <span class="keywordflow">if</span> (RangeBase &lt;= MM_HIGHEST_USER_ADDRESS) {
00397 
00398             <span class="comment">//</span>
00399             <span class="comment">// Check for privilege before allowing a user to profile</span>
00400             <span class="comment">// all processes and USER addresses.</span>
00401             <span class="comment">//</span>
00402 
00403             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00404                 HasPrivilege =  <a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(
00405                                     SeSystemProfilePrivilege,
00406                                     PreviousMode
00407                                     );
00408 
00409                 <span class="keywordflow">if</span> (!HasPrivilege) {
00410 <span class="preprocessor">#if DBG</span>
00411 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SeSystemProfilePrivilege needed to profile all USER addresses.\n"</span>);
00412 <span class="preprocessor">#endif //DBG</span>
00413 <span class="preprocessor"></span>                    <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00414                 }
00415 
00416             }
00417         }
00418 
00419         ProcessAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00420 
00421 
00422     } <span class="keywordflow">else</span> {
00423 
00424         <span class="comment">//</span>
00425         <span class="comment">// Reference the specified process.</span>
00426         <span class="comment">//</span>
00427 
00428         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> ( Process,
00429                                              PROCESS_QUERY_INFORMATION,
00430                                              PsProcessType,
00431                                              PreviousMode,
00432                                              (PVOID *)&amp;ProcessAddress,
00433                                              NULL );
00434 
00435         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00436             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437         }
00438     }
00439 
00440     InitializeObjectAttributes( &amp;ObjectAttributes,
00441                                 NULL,
00442                                 OBJ_EXCLUSIVE,
00443                                 NULL,
00444                                 NULL );
00445 
00446     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( KernelMode,
00447                              ExProfileObjectType,
00448                              &amp;ObjectAttributes,
00449                              PreviousMode,
00450                              NULL,
00451                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__EPROFILE.html">EPROFILE</a>),
00452                              0,
00453                              <span class="keyword">sizeof</span>(EPROFILE) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>),
00454                              (PVOID *)&amp;Profile);
00455 
00456     <span class="comment">//</span>
00457     <span class="comment">// If the profile object was successfully allocated, initialize</span>
00458     <span class="comment">// the profile object.</span>
00459     <span class="comment">//</span>
00460     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00461 
00462 
00463         <span class="keywordflow">if</span> (ProcessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00464             Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a> = &amp;ProcessAddress-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>;
00465         } <span class="keywordflow">else</span> {
00466             Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468 
00469         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o1">RangeBase</a> = RangeBase;
00470         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o2">RangeSize</a> = RangeSize;
00471         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o3">Buffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00472         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o4">BufferSize</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
00473         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o5">BucketSize</a> = BucketSize;
00474         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00475         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o9">Segment</a> = Segment;
00476         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o10">ProfileSource</a> = ProfileSource;
00477         Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o11">Affinity</a> = Affinity;
00478 
00479         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>(Profile,
00480                                 NULL,
00481                                 PROFILE_CONTROL,
00482                                 0,
00483                                 (PVOID *)NULL,
00484                                 &amp;Handle);
00485         <span class="comment">//</span>
00486         <span class="comment">// If the profile object was successfully inserted in the current</span>
00487         <span class="comment">// process' handle table, then attempt to write the profile object</span>
00488         <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00489         <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00490         <span class="comment">// an access violation will occur.</span>
00491         <span class="comment">//</span>
00492         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00493             <span class="keywordflow">try</span> {
00494                 *ProfileHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00495             } except(EXCEPTION_EXECUTE_HANDLER) {
00496             }
00497         }
00498     }
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">// If we failed, remove our reference to the process object.</span>
00502     <span class="comment">//</span>
00503     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00504         <span class="keywordflow">if</span> (ProcessAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00505             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)ProcessAddress);
00506         }
00507     }
00508 
00509     <span class="comment">//</span>
00510     <span class="comment">// Return service status.</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00514 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ex/profile.c::NtQueryIntervalProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryIntervalProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN KPROFILE_SOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProfileSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Interval</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00788">788</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00163">KeQueryIntervalProfile()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, and <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>.
<p>
<pre class="fragment"><div>00795                    :
00796 
00797     This routine queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system-wide interval (and thus the profiling
00798     rate) <span class="keywordflow">for</span> profiling.
00799 
00800 Arguments:
00801 
00802     Source - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile source to be queried.
00803 
00804     Interval - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sampling interval in 100ns units.
00805 
00806 Return Value:
00807 
00808     TBS
00809 
00810 --*/
00811 
00812 {
00813     ULONG CapturedInterval;
00814     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00815 
00816     PreviousMode = KeGetPreviousMode ();
00817     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// Probe accessibility of user's buffer.</span>
00821         <span class="comment">//</span>
00822 
00823         <span class="keywordflow">try</span> {
00824             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a> (Interval);
00825 
00826         } except (EXCEPTION_EXECUTE_HANDLER) {
00827 
00828             <span class="comment">//</span>
00829             <span class="comment">// If an exception occurs during the probe or capture</span>
00830             <span class="comment">// of the initial values, then handle the exception and</span>
00831             <span class="comment">// return the exception code as the status value.</span>
00832             <span class="comment">//</span>
00833 
00834             <span class="keywordflow">return</span> GetExceptionCode();
00835         }
00836     }
00837 
00838     CapturedInterval = <a class="code" href="../../d0/d8/profobj_8c.html#a6">KeQueryIntervalProfile</a> (ProfileSource);
00839 
00840     <span class="keywordflow">try</span> {
00841         *Interval = CapturedInterval;
00842 
00843     } except (EXCEPTION_EXECUTE_HANDLER) {
00844         NOTHING;
00845     }
00846 
00847     <span class="keywordflow">return</span> STATUS_SUCCESS;
00848 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ex/profile.c::NtQueryPerformanceCounter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryPerformanceCounter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>PerformanceCounter</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER PerformanceFrequency&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">851</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, and <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d8/d7/ntnap_8c-source.html#l00061">NapDllInit()</a>, and <a class="el" href="../../d7/d8/heappage_8c-source.html#l01997">RtlpDebugPageHeapCreate()</a>.
<p>
<pre class="fragment"><div>00858                    :
00859 
00860     This function returns current value of performance counter and,
00861     optionally, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frequency of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> performance counter.
00862 
00863     Performance frequency <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frequency of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> performance counter
00864     in Hertz, i.e., counts/second.  Note that <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> implementation
00865     dependent.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> implementation does not have hardware to support
00866     performance timing, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0.
00867 
00868 Arguments:
00869 
00870     PerformanceCounter - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable to receive
00871         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Performance Counter value.
00872 
00873     PerformanceFrequency - Optionally, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a
00874         variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> performance counter frequency.
00875 
00876 Return Value:
00877 
00878     STATUS_ACCESS_VIOLATION or STATUS_SUCCESS.
00879 
00880 --*/
00881 
00882 {
00883     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00884     LARGE_INTEGER KernelPerformanceFrequency;
00885 
00886     PreviousMode = KeGetPreviousMode();
00887     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00888 
00889         <span class="comment">//</span>
00890         <span class="comment">// Probe accessibility of user's buffer.</span>
00891         <span class="comment">//</span>
00892 
00893         <span class="keywordflow">try</span> {
00894             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ( PerformanceCounter,
00895                             <span class="keyword">sizeof</span> (LARGE_INTEGER),
00896                             <span class="keyword">sizeof</span> (ULONG)
00897                           );
00898 
00899             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PerformanceFrequency)) {
00900                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a> ( PerformanceFrequency,
00901                                 <span class="keyword">sizeof</span> (LARGE_INTEGER),
00902                                 <span class="keyword">sizeof</span> (ULONG)
00903                               );
00904             }
00905 
00906         } except (EXCEPTION_EXECUTE_HANDLER) {
00907 
00908             <span class="comment">//</span>
00909             <span class="comment">// If an exception occurs during the probe or capture</span>
00910             <span class="comment">// of the initial values, then handle the exception and</span>
00911             <span class="comment">// return the exception code as the status value.</span>
00912             <span class="comment">//</span>
00913 
00914             <span class="keywordflow">return</span> GetExceptionCode();
00915         }
00916     }
00917 
00918     <span class="keywordflow">try</span> {
00919         *PerformanceCounter = <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a> (
00920                                   (PLARGE_INTEGER)&amp;KernelPerformanceFrequency );
00921         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PerformanceFrequency)) {
00922             *PerformanceFrequency = KernelPerformanceFrequency;
00923         }
00924     } except (EXCEPTION_EXECUTE_HANDLER) {
00925         <span class="keywordflow">return</span> GetExceptionCode();
00926     }
00927 
00928     <span class="keywordflow">return</span> STATUS_SUCCESS;
00929 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ex/profile.c::NtSetIntervalProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetIntervalProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Interval</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPROFILE_SOURCE&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00757">757</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d1/d7/profobj_8c-source.html#l00223">KeSetIntervalProfile()</a>.
<p>
<pre class="fragment"><div>00764                    :
00765 
00766     This routine allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system-wide interval (and thus the profiling
00767     rate) <span class="keywordflow">for</span> profiling to be set.
00768 
00769 Arguments:
00770 
00771     Interval - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sampling interval in 100ns units.
00772 
00773     Source - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile source to be set.
00774 
00775 Return Value:
00776 
00777     TBS
00778 
00779 --*/
00780 
00781 {
00782 
00783     <a class="code" href="../../d0/d8/profobj_8c.html#a7">KeSetIntervalProfile</a> (Interval, Source);
00784     <span class="keywordflow">return</span> STATUS_SUCCESS;
00785 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ex/profile.c::NtStartProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtStartProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProfileHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">517</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00064">ACTIVE_PROFILE_LIMIT</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00055">ExpCurrentProfileUsage</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00053">ExpProfileStateMutex</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00051">ExProfileObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00069">KeInitializeProfile()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00289">KeStartProfile()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">MmSizeOfMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/tprofile_8c-source.html#l00024">main()</a>.
<p>
<pre class="fragment"><div>00523                    :
00524 
00525     The <a class="code" href="../../d9/d6/ex_2profile_8c.html#a10">NtStartProfile</a> routine starts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> collecting data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00526     specified profile object.  This involved allocating nonpaged
00527     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer in memory, creating a kernel
00528     profile object and starting collecting on that profile object.
00529 
00530 Arguments:
00531 
00532     ProfileHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile handle to start profiling on.
00533 
00534 Return Value:
00535 
00536     TBS
00537 
00538 --*/
00539 
00540 {
00541 
00542     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00543     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00544     <a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a> Profile;
00545     <a class="code" href="../../d6/d7/struct__KPROFILE.html">PKPROFILE</a> <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>;
00546     PVOID LockedVa;
00547     BOOLEAN State;
00548 
00549     PreviousMode = KeGetPreviousMode();
00550 
00551     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( ProfileHandle,
00552                                         PROFILE_CONTROL,
00553                                         ExProfileObjectType,
00554                                         PreviousMode,
00555                                         (PVOID *)&amp;Profile,
00556                                         NULL);
00557     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00558         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00559     }
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">// Acquire the profile state mutex so two threads can't</span>
00563     <span class="comment">// operate on the same profile object simultaneously.</span>
00564     <span class="comment">//</span>
00565 
00566     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ExpProfileStateMutex,
00567                            Executive,
00568                            KernelMode,
00569                            FALSE,
00570                            (PLARGE_INTEGER)NULL);
00571 
00572     <span class="comment">//</span>
00573     <span class="comment">// Make sure profiling is not already enabled.</span>
00574     <span class="comment">//</span>
00575 
00576     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00577         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00578         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00579         <span class="keywordflow">return</span> STATUS_PROFILING_NOT_STOPPED;
00580     }
00581 
00582     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d6/ex_2profile_8c.html#a5">ExpCurrentProfileUsage</a> == <a class="code" href="../../d9/d6/ex_2profile_8c.html#a0">ACTIVE_PROFILE_LIMIT</a>) {
00583         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00584         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00585         <span class="keywordflow">return</span> STATUS_PROFILING_AT_LIMIT;
00586     }
00587 
00588     <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00589                                     <a class="code" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a>(Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o3">Buffer</a>,
00590                                                 Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o4">BufferSize</a>) +
00591                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__KPROFILE.html">KPROFILE</a>),
00592                                         'forP');
00593 
00594     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00595         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00596         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00597         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00598     }
00599 
00600     Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)(<a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a> + 1);
00601     Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a> = <a class="code" href="../../d4/d9/ke_8h.html#a402a180">ProfileObject</a>;
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">// Probe and lock the specified buffer.</span>
00605     <span class="comment">//</span>
00606 
00607     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o3">Buffer</a>, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o4">BufferSize</a>);
00608 
00609     <span class="keywordflow">try</span> {
00610 
00611         LockedVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00612 
00613         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>,
00614                              PreviousMode,
00615                              IoWriteAccess );
00616 
00617         LockedVa = (PVOID)43;  <span class="comment">// flag to notice MmMapLockedPages failed.</span>
00618 
00619         LockedVa = <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>,
00620                                                  KernelMode,
00621                                                  MmCached,
00622                                                  NULL,
00623                                                  FALSE,
00624                                                  NormalPagePriority);
00625 
00626     } except (EXCEPTION_EXECUTE_HANDLER) {
00627 
00628         <span class="keywordflow">if</span> (LockedVa == (PVOID)43 ) {
00629             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00630         }
00631         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileObject);
00632         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00633         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00634         <span class="keywordflow">return</span> GetExceptionCode();
00635     }
00636 
00637     <span class="keywordflow">if</span> (LockedVa == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00639         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileObject);
00640         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00641         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00642         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00643     }
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">// Initialize the profile object.</span>
00647     <span class="comment">//</span>
00648 
00649     <a class="code" href="../../d0/d8/profobj_8c.html#a5">KeInitializeProfile</a> (ProfileObject,
00650                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o0">Process</a>,
00651                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o1">RangeBase</a>,
00652                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o2">RangeSize</a>,
00653                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o5">BucketSize</a>,
00654                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o9">Segment</a>,
00655                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o10">ProfileSource</a>,
00656                          Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o11">Affinity</a>);
00657     <span class="keywordflow">try</span> {
00658         State = <a class="code" href="../../d0/d8/profobj_8c.html#a8">KeStartProfile</a> (ProfileObject, LockedVa);
00659         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != FALSE);
00660 
00661     } except (EXCEPTION_EXECUTE_HANDLER) {
00662 
00663         <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00664         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (LockedVa, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00665         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ProfileObject);
00666         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00667         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00668         <span class="keywordflow">return</span> GetExceptionCode();
00669     }
00670 
00671     Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> = LockedVa;
00672 
00673     <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00674     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00675 
00676     <span class="keywordflow">return</span> STATUS_SUCCESS;
00677 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ex/profile.c::NtStopProfile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtStopProfile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ProfileHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">680</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00053">ExpProfileStateMutex</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00051">ExProfileObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d7/profobj_8c-source.html#l00520">KeStopProfile()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d9/d6/ex_2profile_8c.html#a2">PEPROFILE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/tprofile_8c-source.html#l00024">main()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     The <a class="code" href="../../d9/d6/ex_2profile_8c.html#a11">NtStopProfile</a> routine stops collecting data <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00689     specified profile object.  This involves stopping <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data
00690     collection on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile object, unlocking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locked buffers,
00691     and deallocating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> and profile object.
00692 
00693 Arguments:
00694 
00695     ProfileHandle - Supplies a <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> profile handle to stop profiling.
00696 
00697 Return Value:
00698 
00699     TBS
00700 
00701 --*/
00702 
00703 {
00704 
00705     <a class="code" href="../../d5/d4/struct__EPROFILE.html">PEPROFILE</a> Profile;
00706     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00707     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00708     BOOLEAN State;
00709 
00710     PreviousMode = KeGetPreviousMode();
00711 
00712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( ProfileHandle,
00713                                         PROFILE_CONTROL,
00714                                         ExProfileObjectType,
00715                                         PreviousMode,
00716                                         (PVOID *)&amp;Profile,
00717                                         NULL);
00718 
00719     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00720         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00721     }
00722 
00723     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ExpProfileStateMutex,
00724                            Executive,
00725                            KernelMode,
00726                            FALSE,
00727                            (PLARGE_INTEGER)NULL);
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// Check to see if profiling is not active.</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00734         <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00735         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00736         <span class="keywordflow">return</span> STATUS_PROFILING_NOT_STARTED;
00737     }
00738 
00739     <span class="comment">//</span>
00740     <span class="comment">// Stop profiling and unlock the buffer.</span>
00741     <span class="comment">//</span>
00742 
00743     State = <a class="code" href="../../d0/d8/profobj_8c.html#a9">KeStopProfile</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00744     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (State != FALSE);
00745 
00746     <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a>, Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00747     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o8">Mdl</a>);
00748     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o6">ProfileObject</a>);
00749     Profile-&gt;<a class="code" href="../../d5/d4/struct__EPROFILE.html#o7">LockedBufferAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00750     <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a> (&amp;ExpProfileStateMutex, FALSE);
00751 
00752     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> ((PVOID)Profile);
00753     <span class="keywordflow">return</span> STATUS_SUCCESS;
00754 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a5" doxytag="ex/profile.c::ExpCurrentProfileUsage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d6/ex_2profile_8c.html#a5">ExpCurrentProfileUsage</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00055">55</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ex/profile.c::ExpProfileMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> GENERIC_MAPPING <a class="el" href="../../d9/d6/ex_2profile_8c.html#a6">ExpProfileMapping</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Initial value:</b><pre class="fragment"><div> {
    STANDARD_RIGHTS_READ | PROFILE_CONTROL,
    STANDARD_RIGHTS_WRITE | PROFILE_CONTROL,
    STANDARD_RIGHTS_EXECUTE | PROFILE_CONTROL,
    PROFILE_ALL_ACCESS
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00057">57</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">ExpProfileInitialization()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ex/profile.c::ExpProfileStateMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTEX</a> <a class="el" href="../../d9/d6/ex_2profile_8c.html#a4">ExpProfileStateMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00053">53</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">ExpProfileInitialization()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ex/profile.c::ExProfileObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d9/d6/ex_2profile_8c.html#a3">ExProfileObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00051">51</a> of file <a class="el" href="../../d0/d6/ex_2profile_8c-source.html">ex/profile.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00079">ExpProfileInitialization()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00199">NtCreateProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
