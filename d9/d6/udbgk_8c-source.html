<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udbgk.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>udbgk.c</h1><a href="../../d8/d7/udbgk_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    udbg.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Usermode test for debugger</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky (markl) 19-Jan-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00022 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00023 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00024 <span class="preprocessor">#include &lt;ntdbg.h&gt;</span>
00025 
<a name="l00026"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a0">00026</a> HANDLE <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
00027 
00028 
00029 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00030"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a1">00030</a> <a class="code" href="../../d8/d7/udbgk_8c.html#a1">ThreadThatExits</a> (
00031     IN PVOID ThreadParameter
00032     )
00033 {
00034     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(NtCurrentThread(),(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) ThreadParameter );
00035 }
00036 
00037 ULONG
<a name="l00038"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a2">00038</a> <a class="code" href="../../d2/d3/utxcpt4_8c.html#a3">foo</a>(PULONG l)
00039 {
00040     <span class="comment">//ULONG x;</span>
00041     <span class="comment">//x = *l;</span>
00042     <span class="comment">//return x + 1;</span>
00043 
00044     <span class="keywordflow">return</span> *l;
00045 
00046 }
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00049"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a3">00049</a> <a class="code" href="../../d8/d7/udbgk_8c.html#a3">ThreadThatExcepts</a> (
00050     IN PVOID ThreadParameter
00051     )
00052 {
00053     <a class="code" href="../../d2/d3/utxcpt4_8c.html#a3">foo</a>((PULONG)0x00000001);
00054     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(NtCurrentThread(),(<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) ThreadParameter );
00055 }
00056 
00057 
00058 
00059 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00060"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a4">00060</a> <a class="code" href="../../d8/d7/udbgk_8c.html#a4">ThreadThatSpins</a> (
00061     IN PVOID ThreadParameter
00062     )
00063 {
00064     <span class="keywordflow">for</span>(;;);
00065     <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(NtCurrentThread(),STATUS_SUCCESS);
00066 }
00067 
00068 
<a name="l00069"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a5">00069</a> <a class="code" href="../../d8/d7/udbgk_8c.html#a5">UdbgTest1</a>()
00070 {
00071     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00072     HANDLE ExitThread, SpinThread, DebugProcess;
00073     CLIENT_ID ExitClientId, SpinClientId;
00074     DBGKM_APIMSG m;
00075     PDBGKM_CREATE_THREAD CreateThreadArgs;
00076     PDBGKM_CREATE_PROCESS CreateProcessArgs;
00077     PDBGKM_EXIT_THREAD ExitThreadArgs;
00078     PDBGKM_EXIT_PROCESS ExitProcessArgs;
00079     ULONG Psp;
00080 
00081     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (1)...\n"</span>);
00082 
00083         <span class="comment">//</span>
00084         <span class="comment">// Verify that a process can be created with a debug</span>
00085         <span class="comment">// port.</span>
00086         <span class="comment">//</span>
00087 
00088         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a14">NtCreateProcess</a>(
00089                 &amp;DebugProcess,
00090                 PROCESS_ALL_ACCESS,
00091                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00092                 NtCurrentProcess(),
00093                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00094                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00095                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00096                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00097                 );
00098         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00099 
00100         st = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
00101                 DebugProcess,
00102                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00103                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00104                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00105                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00106                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00107                 <a class="code" href="../../d8/d7/udbgk_8c.html#a1">ThreadThatExits</a>,
00108                 (PVOID) STATUS_ABANDONED,
00109                 &amp;ExitThread,
00110                 &amp;ExitClientId
00111                 );
00112         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00113 
00114         st = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
00115                 DebugProcess,
00116                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00117                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00118                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00119                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00120                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00121                 <a class="code" href="../../d8/d7/udbgk_8c.html#a4">ThreadThatSpins</a>,
00122                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00123                 &amp;SpinThread,
00124                 &amp;SpinClientId
00125                 );
00126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00127 
00128     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (2)...\n"</span>);
00129 
00130         <span class="comment">//</span>
00131         <span class="comment">// Verify that CreateProcess Messages Arrive, and that</span>
00132         <span class="comment">// they are correct</span>
00133         <span class="comment">//</span>
00134 
00135         st = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(SpinThread,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00136         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00137 
00138         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00139                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00140                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00141                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00142                 (PPORT_MESSAGE)&amp;m
00143                 );
00144         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00145         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmCreateProcessApi);
00146 
00147         CreateThreadArgs = &amp;m.u.CreateProcess.InitialThread;
00148         CreateProcessArgs = &amp;m.u.CreateProcess;
00149         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CreateThreadArgs-&gt;SubSystemKey == 0 &amp;&amp; CreateThreadArgs-&gt;StartAddress == (PVOID)<a class="code" href="../../d8/d7/udbgk_8c.html#a4">ThreadThatSpins</a> );
00150         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CreateProcessArgs-&gt;SubSystemKey == 0);
00151 
00152     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (3)...\n"</span>);
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">// Verify that other threads in the process are properly suspended</span>
00156         <span class="comment">//</span>
00157 
00158         st = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(ExitThread,&amp;Psp);
00159         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; Psp == 2);
00160 
00161         st = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(ExitThread,&amp;Psp);
00162         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; Psp == 3);
00163 
00164         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00165         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00166 
00167 
00168     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (4)...\n"</span>);
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// Verify that CreateThread Messages Arrive, and that</span>
00172         <span class="comment">// they are correct</span>
00173         <span class="comment">//</span>
00174 
00175         st = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(ExitThread,&amp;Psp);
00176         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00177 
00178         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00179                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00180                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00181                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00182                 (PPORT_MESSAGE)&amp;m
00183                 );
00184         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00185         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmCreateThreadApi);
00186 
00187         CreateThreadArgs = &amp;m.u.CreateThread;
00188         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CreateThreadArgs-&gt;SubSystemKey == 0 &amp;&amp; CreateThreadArgs-&gt;StartAddress == (PVOID)<a class="code" href="../../d8/d7/udbgk_8c.html#a1">ThreadThatExits</a> );
00189 
00190         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00191         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00192 
00193     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (5)...\n"</span>);
00194 
00195         <span class="comment">//</span>
00196         <span class="comment">// Verify that ExitThread Messages Arrive, and that</span>
00197         <span class="comment">// they are correct</span>
00198         <span class="comment">//</span>
00199 
00200         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00201                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00202                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00203                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00204                 (PPORT_MESSAGE)&amp;m
00205                 );
00206         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00207         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExitThreadApi);
00208 
00209         ExitThreadArgs = &amp;m.u.ExitThread;
00210         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExitThreadArgs-&gt;ExitStatus == STATUS_ABANDONED );
00211 
00212         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00213         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00214 
00215         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(ExitThread,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00216         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00217 
00218     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (6)...\n"</span>);
00219 
00220         <span class="comment">//</span>
00221         <span class="comment">// Verify that ExitThread Messages Arrive, and that</span>
00222         <span class="comment">// they are correct</span>
00223         <span class="comment">//</span>
00224 
00225         st = <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(DebugProcess,STATUS_REPARSE);
00226         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00227 
00228         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00229                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00230                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00231                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00232                 (PPORT_MESSAGE)&amp;m
00233                 );
00234         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00235         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExitThreadApi);
00236 
00237         ExitThreadArgs = &amp;m.u.ExitThread;
00238         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExitThreadArgs-&gt;ExitStatus == STATUS_REPARSE );
00239 
00240         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00241         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00242 
00243     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: (7)...\n"</span>);
00244 
00245         <span class="comment">//</span>
00246         <span class="comment">// Verify that ExitProcess Messages Arrive, and that</span>
00247         <span class="comment">// they are correct</span>
00248         <span class="comment">//</span>
00249 
00250         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00251                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00252                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00253                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00254                 (PPORT_MESSAGE)&amp;m
00255                 );
00256         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00257         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExitProcessApi);
00258 
00259         ExitProcessArgs = &amp;m.u.ExitProcess;
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExitProcessArgs-&gt;ExitStatus == STATUS_REPARSE );
00261 
00262         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00263         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00264 
00265 
00266         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(ExitThread,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00267         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00268 
00269         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(DebugProcess,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00270         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00271 
00272     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ExitThread);
00273     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(SpinThread);
00274     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DebugProcess);
00275 
00276     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest1: END OF TEST ***\n"</span>);
00277 
00278 }
00279 
<a name="l00280"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a6">00280</a> <a class="code" href="../../d8/d7/udbgk_8c.html#a6">UdbgTest2</a>()
00281 {
00282     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00283     HANDLE ExceptionThread, DebugProcess;
00284     DBGKM_APIMSG m;
00285     PDBGKM_CREATE_THREAD CreateThreadArgs;
00286     PDBGKM_CREATE_PROCESS CreateProcessArgs;
00287     PDBGKM_EXIT_THREAD ExitThreadArgs;
00288     PDBGKM_EXIT_PROCESS ExitProcessArgs;
00289     PDBGKM_EXCEPTION ExceptionArgs;
00290     ULONG Psp;
00291 
00292     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: (1)...\n"</span>);
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// Verify that a process can be created with a debug</span>
00296         <span class="comment">// port.</span>
00297         <span class="comment">//</span>
00298 
00299         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a14">NtCreateProcess</a>(
00300                 &amp;DebugProcess,
00301                 PROCESS_ALL_ACCESS,
00302                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00303                 NtCurrentProcess(),
00304                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00305                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00306                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00307                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00308                 );
00309         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00310 
00311         st = <a class="code" href="../../d0/d2/rtlexec_8c.html#a13">RtlCreateUserThread</a>(
00312                 DebugProcess,
00313                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00314                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00315                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00316                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00317                 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00318                 <a class="code" href="../../d8/d7/udbgk_8c.html#a3">ThreadThatExcepts</a>,
00319                 (PVOID) STATUS_ABANDONED,
00320                 &amp;ExceptionThread,
00321                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00322                 );
00323         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00324 
00325     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: (2)...\n"</span>);
00326 
00327         <span class="comment">//</span>
00328         <span class="comment">// Verify that CreateThread Messages Arrive, and that</span>
00329         <span class="comment">// they are correct</span>
00330         <span class="comment">//</span>
00331 
00332         st = <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(ExceptionThread,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00333         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00334 
00335         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00336                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00337                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00338                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00339                 (PPORT_MESSAGE)&amp;m
00340                 );
00341         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00342         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmCreateProcessApi);
00343 
00344         CreateThreadArgs = &amp;m.u.CreateProcess.InitialThread;
00345         CreateProcessArgs = &amp;m.u.CreateProcess;
00346         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CreateThreadArgs-&gt;SubSystemKey == 0 &amp;&amp; CreateThreadArgs-&gt;StartAddress == (PVOID)<a class="code" href="../../d8/d7/udbgk_8c.html#a3">ThreadThatExcepts</a> );
00347         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CreateProcessArgs-&gt;SubSystemKey == 0);
00348 
00349         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00350         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00351 
00352     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: (3)...\n"</span>);
00353 
00354         <span class="comment">//</span>
00355         <span class="comment">// Verify that First Chance Exception Messages Arrive, and that</span>
00356         <span class="comment">// they are correct</span>
00357         <span class="comment">//</span>
00358 
00359         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00360                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00361                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00362                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00363                 (PPORT_MESSAGE)&amp;m
00364                 );
00365         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00366         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExceptionApi);
00367 
00368         ExceptionArgs = &amp;m.u.Exception;
00369         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExceptionArgs-&gt;FirstChance == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00370 
00371         m.ReturnedStatus = DBG_EXCEPTION_NOT_HANDLED;
00372 
00373         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00374         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00375 
00376     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: (4)...\n"</span>);
00377 
00378         <span class="comment">//</span>
00379         <span class="comment">// Verify that First Chance Exception Messages Arrive, and that</span>
00380         <span class="comment">// they are correct</span>
00381         <span class="comment">//</span>
00382 
00383         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00384                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00385                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00386                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00387                 (PPORT_MESSAGE)&amp;m
00388                 );
00389         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00390         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExceptionApi);
00391 
00392         ExceptionArgs = &amp;m.u.Exception;
00393         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExceptionArgs-&gt;FirstChance == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00394 
00395         m.ReturnedStatus = DBG_EXCEPTION_HANDLED;
00396 skip4:
00397         st = <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(DebugProcess,STATUS_REPARSE);
00398         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00399 
00400         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00401         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00402 
00403         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00404                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00405                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00406                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00407                 (PPORT_MESSAGE)&amp;m
00408                 );
00409         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00410         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExitThreadApi);
00411 
00412         ExitThreadArgs = &amp;m.u.ExitThread;
00413         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExitThreadArgs-&gt;ExitStatus == STATUS_REPARSE );
00414 
00415         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00416         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00417 
00418     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: (5)...\n"</span>);
00419 
00420         <span class="comment">//</span>
00421         <span class="comment">// Verify that ExitProcess Messages Arrive, and that</span>
00422         <span class="comment">// they are correct</span>
00423         <span class="comment">//</span>
00424 
00425         st = <a class="code" href="../../d4/d7/lpcrecv_8c.html#a0">NtReplyWaitReceivePort</a>(
00426                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00427                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00428                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00429                 (PPORT_MESSAGE)&amp;m
00430                 );
00431         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00432         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(m.ApiNumber == DbgKmExitProcessApi);
00433 
00434         ExitProcessArgs = &amp;m.u.ExitProcess;
00435         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ExitProcessArgs-&gt;ExitStatus == STATUS_REPARSE );
00436 
00437         st = <a class="code" href="../../d5/d7/lpcreply_8c.html#a1">NtReplyPort</a>(<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,(PPORT_MESSAGE)&amp;m);
00438         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00439 
00440 
00441         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(ExceptionThread,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00442         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00443 
00444         st = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>(DebugProcess,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00445         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00446 
00447     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(ExceptionThread);
00448     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(DebugProcess);
00449 
00450     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"UdbgTest2: END OF TEST ***\n"</span>);
00451 }
00452 
<a name="l00453"></a><a class="code" href="../../d8/d7/udbgk_8c.html#a7">00453</a> <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>()
00454 {
00455     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00456     OBJECT_ATTRIBUTES Obja;
00457 
00458     InitializeObjectAttributes(&amp;Obja, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00459 
00460     st = <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a>(
00461             &amp;<a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>,
00462             &amp;Obja,
00463             0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
00464             256,
00465             256 * 16
00466             );
00467     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st));
00468 
00469     <a class="code" href="../../d8/d7/udbgk_8c.html#a6">UdbgTest2</a>();
00470     <a class="code" href="../../d8/d7/udbgk_8c.html#a5">UdbgTest1</a>();
00471 
00472 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
