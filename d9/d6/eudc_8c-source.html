<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: eudc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>eudc.c</h1><a href="../../d8/d7/eudc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    eudc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">Author:</span>
00012 <span class="comment"></span>
00013 <span class="comment">    KazuM Apr.19.1996</span>
00014 <span class="comment"></span>
00015 <span class="comment">Revision History:</span>
00016 <span class="comment"></span>
00017 <span class="comment">--*/</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00020 <span class="preprocessor">#pragma hdrstop</span>
00021 <span class="preprocessor"></span>
00022 
00023 <span class="preprocessor">#if defined(FE_SB)</span>
00024 <span class="preprocessor"></span>
00025 
00026 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00027 <a class="code" href="../../d9/d7/eudc_8h.html#a3">CreateEUDC</a>(
00028     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00029     )
00030 {
00031     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo;
00032 
00033     EudcInfo = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( EUDC_TAG ), <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">EUDC_INFORMATION</a>));
00034     <span class="keywordflow">if</span> (EudcInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00035         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00036     }
00037     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o0">LocalVDMEudcMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00038     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o1">LocalKeisenEudcMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00039     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00040     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00041     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00042     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.X = <a class="code" href="../../d0/d3/dbcs_8h.html#a2">DEFAULT_EUDCSIZE</a>;
00043     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.Y = <a class="code" href="../../d0/d3/dbcs_8h.html#a2">DEFAULT_EUDCSIZE</a>;
00044 
00045     RtlZeroMemory(&amp;EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o7">EudcRange</a>,<span class="keyword">sizeof</span>(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o7">EudcRange</a>));
00046     EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o6">EudcRangeSize</a> = <a class="code" href="../../d9/d7/eudc_8h.html#a10">GetSystemEUDCRangeW</a>(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o7">EudcRange</a>, EUDC_RANGE_SIZE);
00047     <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o6">EudcRangeSize</a>)
00048         EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o6">EudcRangeSize</a>--;    <span class="comment">// remove terminator</span>
00049 
00050     Console-&gt;EudcInformation = (PVOID)EudcInfo;
00051 
00052     <span class="keywordflow">return</span> STATUS_SUCCESS;
00053 }
00054 
00055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00056 <a class="code" href="../../d9/d7/eudc_8h.html#a4">DeleteEUDC</a>(
00057     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00058     )
00059 {
00060     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo = Console-&gt;EudcInformation;
00061 
00062     <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>) {
00063          <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(NULL, EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>);
00064          DeleteObject(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>);
00065     }
00066 }
00067 
00068 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00069 <a class="code" href="../../d9/d7/eudc_8h.html#a5">RegisterLocalEUDC</a>(
00070     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00071     IN WCHAR wChar,
00072     IN COORD FontSize,
00073     IN PCHAR FontFace
00074     )
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077     PCHAR TmpBuff;
00078     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> BuffSize;
00079     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo = Console-&gt;EudcInformation;
00080 
00081     <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00082         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a23">CreateFontCache</a>(&amp;(<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a>);
00083         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00084             RIPMSG1(RIP_WARNING, <span class="stringliteral">"RegisterLocalEUDC: failed in CreateFontCache, Status is %08x"</span>, Status);
00085             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00086         }
00087     }
00088 
00089     BuffSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize, BYTE_ALIGN);
00090     TmpBuff = FontFace;
00091     <span class="keywordflow">while</span>(BuffSize--)
00092         *TmpBuff++ = ~(*TmpBuff);
00093 
00094     <span class="keywordflow">return</span> (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a>,
00095                                   wChar,
00096                                   FontSize,
00097                                   BYTE_ALIGN,
00098                                   FontFace
00099                                  );
00100 }
00101 
00102 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00103 <a class="code" href="../../d9/d7/eudc_8h.html#a6">FreeLocalEUDC</a>(
00104     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console
00105     )
00106 {
00107     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo = Console-&gt;EudcInformation;
00108 
00109     <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00110         <a class="code" href="../../d6/d6/foncache_8h.html#a24">DestroyFontCache</a>((<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a>);
00111     }
00112 
00113     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Console-&gt;EudcInformation);
00114 }
00115 
00116 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00117 <a class="code" href="../../d9/d7/eudc_8h.html#a7">GetFitLocalEUDCFont</a>(
00118     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00119     IN WCHAR wChar
00120     )
00121 {
00122     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00123     COORD FontSize;
00124     <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> *FontFace;
00125     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> BuffSize;
00126     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo;
00127     <a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a> FontCacheInfo;
00128 
00129     EudcInfo = (<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)Console-&gt;EudcInformation;
00130     FontCacheInfo = (<a class="code" href="../../d1/d9/struct__FONT__CACHE__INFORMATION.html">PFONT_CACHE_INFORMATION</a>)EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o4">EudcFontCacheInformation</a>;
00131 
00132     FontSize = <a class="code" href="../../d8/d5/consrv_8h.html#a29">CON_FONTSIZE</a>(Console);
00133     <span class="keywordflow">if</span> (IsConsoleFullWidth(Console-&gt;hDC,Console-&gt;OutputCP,wChar)) {
00134         FontSize.X *= 2;
00135     }
00136 
00137     <span class="keywordflow">if</span> ((EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.X != FontSize.X) ||
00138         (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.Y != FontSize.Y)   ) {
00139         <a class="code" href="../../d3/d8/client_8c.html#a45">ReleaseDC</a>(NULL, EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>);
00140         DeleteObject(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>);
00141         EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a> = CreateCompatibleDC(Console-&gt;hDC);
00142         EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a> = CreateBitmap(FontSize.X, FontSize.Y, BITMAP_PLANES, BITMAP_BITS_PIXEL, NULL);
00143         SelectObject(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o2">hDCLocalEudc</a>, EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>);
00144         EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.X = FontSize.X;
00145         EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o5">LocalEudcSize</a>.Y = FontSize.Y;
00146     }
00147 
00148     BuffSize = <a class="code" href="../../d6/d6/foncache_8h.html#a29">CalcBitmapBufferSize</a>(FontSize,WORD_ALIGN);
00149     FontFace = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ), BuffSize);
00150     <span class="keywordflow">if</span> (FontFace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00151         RIPMSG0(RIP_WARNING, <span class="stringliteral">"GetFitLocalEUDCFont: failed to allocate FontFace."</span>);
00152         <span class="keywordflow">return</span>;
00153     }
00154 
00155     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(FontCacheInfo,
00156                                     wChar,
00157                                     FontSize,
00158                                     WORD_ALIGN,
00159                                     FontFace
00160                                    );
00161     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00162 
00163         <span class="keywordflow">if</span> ((Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a>) &amp;&amp;
00164             FontSize.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X * 2       &amp;&amp;
00165             FontSize.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y           &amp;&amp;
00166             FontSize.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a3">VDM_EUDC_FONT_SIZE_X</a>        &amp;&amp;
00167             FontSize.Y - 2 == <a class="code" href="../../d0/d3/dbcs_8h.html#a4">VDM_EUDC_FONT_SIZE_Y</a>      ) {
00168 
00169             COORD TmpFontSize = FontSize;
00170 
00171             TmpFontSize.Y -= 2;
00172             RtlFillMemory((PVOID)FontFace,BuffSize,0xff);
00173             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a25">GetFontImage</a>(FontCacheInfo,
00174                                             wChar,
00175                                             TmpFontSize,
00176                                             WORD_ALIGN,
00177                                             FontFace
00178                                            );
00179             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00180                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a26">GetStretchedFontImage</a>(FontCacheInfo,
00181                                                          wChar,
00182                                                          FontSize,
00183                                                          WORD_ALIGN,
00184                                                          FontFace
00185                                                         );
00186                 <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00187                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00188                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontFace);
00189                     <span class="keywordflow">return</span>;
00190                 }
00191             }
00192         }
00193         <span class="keywordflow">else</span> {
00194             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a26">GetStretchedFontImage</a>(FontCacheInfo,
00195                                                      wChar,
00196                                                      FontSize,
00197                                                      WORD_ALIGN,
00198                                                      FontFace
00199                                                     );
00200             <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00201                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00202                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontFace);
00203                 <span class="keywordflow">return</span>;
00204             }
00205         }
00206 
00207         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d6/d6/foncache_8h.html#a28">SetFontImage</a>(FontCacheInfo,
00208                                         wChar,
00209                                         FontSize,
00210                                         WORD_ALIGN,
00211                                         FontFace
00212                                        );
00213         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00214             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00215             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontFace);
00216             <span class="keywordflow">return</span>;
00217         }
00218     }
00219 
00220     SetBitmapBits(EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o3">hBmpLocalEudc</a>, BuffSize, (PBYTE)FontFace);
00221 
00222     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(FontFace);
00223 }
00224 
00225 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00226 <a class="code" href="../../d9/d7/eudc_8h.html#a8">IsEudcRange</a>(
00227     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00228     IN WCHAR ch
00229     )
00230 {
00231     <a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a> EudcInfo;
00232     <span class="keywordtype">int</span> i;
00233 
00234     EudcInfo = (<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)Console-&gt;EudcInformation;
00235 
00236     <span class="keywordflow">for</span> (i=0; i &lt; EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o6">EudcRangeSize</a>; i+=2)
00237     {
00238         <span class="keywordflow">if</span> (EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o7">EudcRange</a>[i] &lt;= ch &amp;&amp; ch &lt;= EudcInfo-&gt;<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html#o7">EudcRange</a>[i+1])
00239             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00240     }
00241     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00242 }
00243 
00244 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00245 <a class="code" href="../../d9/d7/eudc_8h.html#a9">CheckEudcRangeInString</a>(
00246     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
00247     IN  PWCHAR string,
00248     IN  SHORT  len,
00249     OUT SHORT  *find_pos
00250     )
00251 {
00252     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
00253 
00254     <span class="keywordflow">for</span> (i = 0; i &lt; len; i++,string++)
00255     {
00256         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/eudc_8h.html#a8">IsEudcRange</a>(Console, *string))
00257         {
00258             *find_pos = i;
00259             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00260         }
00261     }
00262     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00263 }
00264 
00265 LPWSTR
00266 SkipWhite(
00267     LPWSTR lpch
00268     )
00269 {
00270     <span class="keywordflow">if</span>( lpch == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00271         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00272 
00273     <span class="keywordflow">for</span> ( ; ; lpch++ )
00274     {
00275         <span class="keywordflow">switch</span> (*lpch)
00276         {
00277             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>:
00278             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\t'</span>:
00279             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\r'</span>:
00280             <span class="keywordflow">case</span> <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\n'</span>:
00281                 <span class="keywordflow">break</span>;
00282 
00283             <span class="keywordflow">default</span>:
00284                 <span class="keywordflow">return</span>(lpch);
00285         }
00286     }
00287 }
00288 
00289 WORD
00290 <a class="code" href="../../d9/d7/eudc_8h.html#a11">ConvertStringToHex</a>(
00291     LPWSTR lpch,
00292     LPWSTR *endptr
00293     )
00294 {
00295     WCHAR ch;
00296     WORD val = 0;
00297 
00298     <span class="keywordflow">while</span> ( (ch=*lpch) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)
00299     {
00300         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &lt;= ch &amp;&amp; ch &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>)
00301             val = (val &lt;&lt; 4) + (ch - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00302         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span> &lt;= ch &amp;&amp; ch &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'F'</span>)
00303             val = (val &lt;&lt; 4) + (ch - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span> + 10);
00304         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> &lt;= ch &amp;&amp; ch &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'f'</span>)
00305             val = (val &lt;&lt; 4) + (ch - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'a'</span> + 10);
00306         <span class="keywordflow">else</span>
00307             <span class="keywordflow">break</span>;
00308 
00309         lpch++;
00310     }
00311 
00312     <span class="keywordflow">if</span> (endptr)
00313         *endptr = lpch;
00314     <span class="keywordflow">return</span> val;
00315 }
00316 
00317 WORD
00318 <a class="code" href="../../d9/d7/eudc_8h.html#a12">ConvertStringToDec</a>(
00319     LPWSTR lpch,
00320     LPWSTR *endptr
00321     )
00322 {
00323     WCHAR ch;
00324     WORD val = 0;
00325 
00326     <span class="keywordflow">while</span> ( (ch=*lpch) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>)
00327     {
00328         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span> &lt;= ch &amp;&amp; ch &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'9'</span>)
00329             val = (val * 10) + (ch - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'0'</span>);
00330         <span class="keywordflow">else</span>
00331             <span class="keywordflow">break</span>;
00332 
00333         lpch++;
00334     }
00335 
00336     <span class="keywordflow">if</span> (endptr)
00337         *endptr = lpch;
00338     <span class="keywordflow">return</span> val;
00339 }
00340 
00341 <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>
00342 <a class="code" href="../../d9/d7/eudc_8h.html#a10">GetSystemEUDCRangeW</a>(
00343     WORD  *pwEUDCCharTable,
00344     UINT   cjSize
00345     )
00346 {
00347     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00348     HKEY     hkRegistry;
00349     UNICODE_STRING SystemACPString;
00350     WCHAR    awcACP[10];
00351     WCHAR    awchBuffer[ 512 ];
00352     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>      iEntry = 0;
00353 
00354     <span class="comment">/*</span>
00355 <span class="comment">     * Check parameter</span>
00356 <span class="comment">     *</span>
00357 <span class="comment">     * If pwEUDCWideCharTable == NULL &amp;&amp; cjSize == 0</span>
00358 <span class="comment">     * We have to return the needed buffer size to store data</span>
00359 <span class="comment">     */</span>
00360     <span class="keywordflow">if</span>( ( pwEUDCCharTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; cjSize != 0 ) ||
00361         ( pwEUDCCharTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; cjSize == 0 )
00362       )
00363     {
00364         <span class="keywordflow">return</span> 0;
00365     }
00366 
00367     <span class="comment">/*</span>
00368 <span class="comment">     * Open registry key</span>
00369 <span class="comment">     */</span>
00370     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d7/server_2server_8c.html#a44">MyRegOpenKey</a>(NULL,
00371                           MACHINE_REGISTRY_EUDC,
00372                           &amp;hkRegistry);
00373     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00374         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV:GetSystemEUDCRangeW() RegOpenKeyExW( %ws ) fail\n"</span>, MACHINE_REGISTRY_EUDC));
00375         <span class="keywordflow">return</span> 0;
00376     }
00377 
00378     <span class="comment">/*</span>
00379 <span class="comment">     * Convert ACP to Unicode string..</span>
00380 <span class="comment">     */</span>
00381     SystemACPString.Length        = 0;
00382     SystemACPString.MaximumLength = <span class="keyword">sizeof</span>(awcACP)/<span class="keyword">sizeof</span>(WCHAR);
00383     SystemACPString.Buffer        = awcACP;
00384     <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>( WINDOWSCP, 10, &amp;SystemACPString );
00385 
00386     <span class="comment">/*</span>
00387 <span class="comment">     * Read registry data</span>
00388 <span class="comment">     */</span>
00389     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/srvinit_8c.html#a41">MyRegQueryValue</a>(hkRegistry,
00390                              awcACP,
00391                              <span class="keyword">sizeof</span>(awchBuffer), (PBYTE)&amp;awchBuffer);
00392     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00393         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV:GetSystemEUDCRangeW NtQueryValueKey failed %ws\n"</span>, awcACP));
00394     }
00395     <span class="keywordflow">else</span> {
00396         LPWSTR pwszBuf = awchBuffer;
00397 
00398         <span class="comment">/*</span>
00399 <span class="comment">         *  Perse the data</span>
00400 <span class="comment">         */</span>
00401         <span class="keywordflow">while</span>( pwszBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; *pwszBuf != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> )
00402         {
00403             WORD ch1,ch2;
00404 
00405             <span class="comment">// Get Start Range value</span>
00406 
00407             pwszBuf = SkipWhite( pwszBuf );
00408             ch1 = <a class="code" href="../../d9/d7/eudc_8h.html#a11">ConvertStringToHex</a>( pwszBuf, &amp;pwszBuf );
00409 
00410             pwszBuf = SkipWhite( pwszBuf );
00411             <span class="keywordflow">if</span> (*pwszBuf != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'-'</span>)
00412             {
00413                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV:GetSystemEUDCRangeW() Invalid format\n"</span>));
00414                 <span class="keywordflow">return</span>( 0 );
00415             }
00416 
00417             <span class="comment">// Get End Range value</span>
00418 
00419             pwszBuf = SkipWhite( pwszBuf+1 );
00420             ch2 = <a class="code" href="../../d9/d7/eudc_8h.html#a11">ConvertStringToHex</a>( pwszBuf, &amp;pwszBuf );
00421 
00422             <span class="comment">// Confirm the data sort order is correct</span>
00423 
00424             <span class="keywordflow">if</span>( ch1 &gt; ch2 )
00425             {
00426                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONSRV:GetSystemEUDCRangeW() Sort order is incorrect\n"</span>));
00427                 <span class="keywordflow">return</span>( 0 );
00428             }
00429 
00430             <span class="comment">// Move pointer to next</span>
00431 
00432             pwszBuf = SkipWhite( pwszBuf );
00433             <span class="keywordflow">if</span>( *pwszBuf == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">','</span> )
00434                 pwszBuf = SkipWhite( pwszBuf+1 );
00435 
00436             <span class="comment">// Above , if pwszBuf is NULL , We reach the EOD</span>
00437 
00438             iEntry ++;
00439 
00440             <span class="comment">// If caller buffer is enough to store the data , store it.</span>
00441             <span class="comment">// If even not so, We have to continue perse data to compute the number of entry.</span>
00442 
00443             <span class="comment">// 3 - Because we have to store NULL as a mark of EOD</span>
00444 
00445             <span class="keywordflow">if</span>( cjSize &gt;= 3 )
00446             {
00447                 *pwEUDCCharTable++ = ch1;
00448                 *pwEUDCCharTable++ = ch2;
00449                 cjSize -= 2;
00450             }
00451         }
00452 
00453         *pwEUDCCharTable = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00454 
00455 
00456         iEntry = iEntry * 2 + 1;
00457 
00458     }
00459 
00460     <span class="comment">/*</span>
00461 <span class="comment">     * Close registry handle</span>
00462 <span class="comment">     */</span>
00463     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hkRegistry );
00464 
00465     <span class="keywordflow">return</span> (iEntry);
00466 }
00467 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
