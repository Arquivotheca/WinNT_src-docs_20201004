<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: country3.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>country3.c</h1><a href="../../d8/d7/country3_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">// Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00002 <span class="comment">//</span>
00003 <span class="comment">//  MODULE:   country3.c</span>
00004 <span class="comment">//</span>
00005 <span class="comment">//  PURPOSE:   Console IME control.</span>
00006 <span class="comment">//             FarEast country specific module for conime.</span>
00007 <span class="comment">//</span>
00008 <span class="comment">//  PLATFORMS: Windows NT-FE 3.51</span>
00009 <span class="comment">//</span>
00010 <span class="comment">//  FUNCTIONS:</span>
00011 <span class="comment">//    GetCompositionStr() - routine for Get Composition String</span>
00012 <span class="comment">//    ReDisplayCompositionStr() - foutine for re-Display Composition String</span>
00013 <span class="comment">//</span>
00014 <span class="comment">//  History:</span>
00015 <span class="comment">//</span>
00016 <span class="comment">//  17.Jul.1996 v-HirShi (Hirotoshi Shimizu)    Created for TAIWAN &amp; KOREA &amp; PRC</span>
00017 <span class="comment">//</span>
00018 <span class="comment">//  COMMENTS:</span>
00019 <span class="comment">//</span>
00020 <span class="preprocessor">#include "<a class="code" href="../../d5/d3/w32_2ntcon_2conime_2precomp_8h.html">precomp.h</a>"</span>
00021 <span class="preprocessor">#pragma hdrstop</span>
00022 <span class="preprocessor"></span>
00023 <span class="comment">//**********************************************************************</span>
00024 <span class="comment">//</span>
00025 <span class="comment">// void GetCompositionStr()</span>
00026 <span class="comment">//</span>
00027 <span class="comment">// This handles WM_IME_COMPOSITION message with GCS_COMPSTR flag on.</span>
00028 <span class="comment">//</span>
00029 <span class="comment">//**********************************************************************</span>
00030 
00031 <span class="keywordtype">void</span>
<a name="l00032"></a><a class="code" href="../../d8/d7/country3_8c.html#a0">00032</a> <a class="code" href="../../d8/d7/country3_8c.html#a0">GetCompositionStr</a>(
00033     HWND hwnd,
00034     LPARAM CompFlag,
00035     WPARAM CompChar
00036     )
00037 {
00038     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00039 
00040     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: GetCompositionStr\n"</span>));
00041 
00042     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
00043     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00044         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00045         <span class="keywordflow">return</span>;
00046     }
00047 
00048     <span class="keywordflow">switch</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o10">ConsoleOutputCP</a>)
00049     {
00050         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a64">JAPAN_CODEPAGE</a>:
00051             <a class="code" href="../../d8/d7/country3_8c.html#a1">GetCompStrJapan</a>(hwnd, ConTbl, CompFlag);
00052             <span class="keywordflow">break</span>;
00053         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a67">TAIWAN_CODEPAGE</a>:
00054             <a class="code" href="../../d8/d7/country3_8c.html#a2">GetCompStrTaiwan</a>(hwnd, ConTbl, CompFlag);
00055             <span class="keywordflow">break</span>;
00056         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a65">PRC_CODEPAGE</a>:
00057             <a class="code" href="../../d8/d7/country3_8c.html#a3">GetCompStrPRC</a>(hwnd, ConTbl, CompFlag);
00058             <span class="keywordflow">break</span>;
00059         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a66">KOREA_CODEPAGE</a>:
00060             <a class="code" href="../../d8/d7/country3_8c.html#a4">GetCompStrKorea</a>(hwnd, ConTbl, CompFlag, CompChar);
00061             <span class="keywordflow">break</span>;
00062         <span class="keywordflow">default</span>:
00063             <span class="keywordflow">break</span>;
00064     }
00065     <span class="keywordflow">return</span>;
00066 
00067 }
00068 
00069 <span class="keywordtype">void</span>
<a name="l00070"></a><a class="code" href="../../d8/d7/country3_8c.html#a1">00070</a> <a class="code" href="../../d8/d7/country3_8c.html#a1">GetCompStrJapan</a>(
00071     HWND hwnd,
00072     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00073     LPARAM CompFlag
00074     )
00075 {
00076     HIMC        hIMC;                   <span class="comment">// Input context handle.</span>
00077     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLen;               <span class="comment">// Stogare for len. of composition str</span>
00078     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLenAttr;
00079     COPYDATASTRUCT CopyData;
00080     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       SizeToAlloc;
00081     PWCHAR      TempBuf;
00082     PUCHAR      TempBufA;
00083     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00084     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       CursorPos;
00085     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// If fail to get input context handle then do nothing.</span>
00089     <span class="comment">// Applications should call ImmGetContext API to get</span>
00090     <span class="comment">// input context handle.</span>
00091     <span class="comment">//</span>
00092     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
00093     <span class="keywordflow">if</span> ( hIMC == 0 )
00094          <span class="keywordflow">return</span>;
00095 
00096     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00097     {
00098         <span class="comment">//</span>
00099         <span class="comment">// Determines how much memory space to store the composition string.</span>
00100         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00101         <span class="comment">// GCS_COMPSTR flag on, buffer length zero, to get the bullfer</span>
00102         <span class="comment">// length.</span>
00103         <span class="comment">//</span>
00104         dwBufLen = ImmGetCompositionString( hIMC, GCS_COMPSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a>*)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00105         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00106             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00107             <span class="keywordflow">return</span>;
00108         }
00109         <span class="keywordflow">if</span> ( CompFlag &amp; GCS_COMPATTR )
00110         {
00111             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"                           GCS_COMPATTR\n"</span>));
00112             dwBufLenAttr = ImmGetCompositionString( hIMC, GCS_COMPATTR,( <span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00113             <span class="keywordflow">if</span> ( dwBufLenAttr &lt; 0 ) {
00114                 dwBufLenAttr = 0;
00115             }
00116         }
00117         <span class="keywordflow">else</span> {
00118             dwBufLenAttr = 0;
00119         }
00120     }
00121     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00122     {
00123         <span class="comment">//</span>
00124         <span class="comment">// Determines how much memory space to store the result string.</span>
00125         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00126         <span class="comment">// GCS_RESULTSTR flag on, buffer length zero, to get the bullfer</span>
00127         <span class="comment">// length.</span>
00128         <span class="comment">//</span>
00129         dwBufLen = ImmGetCompositionString( hIMC, GCS_RESULTSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00130         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00131             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00132             <span class="keywordflow">return</span>;
00133         }
00134         dwBufLenAttr = 0;
00135     }
00136     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00137     {
00138         dwBufLen = 0;
00139         dwBufLenAttr = 0;
00140     }
00141 
00142     SizeToAlloc = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)( <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00143                           dwBufLen     + <span class="keyword">sizeof</span>(WCHAR) +
00144                           dwBufLenAttr + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)   );
00145 
00146     <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00147          SizeToAlloc &gt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>
00148        )
00149     {
00150         LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> );
00151         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00152     }
00153 
00154     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00155         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = (<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a>)LocalAlloc(LPTR, SizeToAlloc );
00156         <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00157             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00158             <span class="keywordflow">return</span>;
00159         }
00160         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> = SizeToAlloc;
00161     }
00162 
00163     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
00164     RtlZeroMemory(&amp;lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>,
00165                   lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> - <span class="keyword">sizeof</span>(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>)
00166                  );
00167 
00168     TempBuf  = (PWCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>));
00169     TempBufA = (PUCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00170                        dwBufLen +  <span class="keyword">sizeof</span>(WCHAR));
00171 
00172     CopyMemory(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o7">CompAttrColor</a> , ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a> , 8 * <span class="keyword">sizeof</span>(WCHAR));
00173 
00174     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
00175     CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
00176     CopyData.lpData = lpCompStrMem;
00177 
00178     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00179     {
00180         <span class="comment">//</span>
00181         <span class="comment">// Reads in the composition string.</span>
00182         <span class="comment">//</span>
00183         ImmGetCompositionString( hIMC, GCS_COMPSTR, TempBuf, dwBufLen );
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Null terminated.</span>
00187         <span class="comment">//</span>
00188         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">// If GCS_COMPATTR flag is on, then we need to take care of it.</span>
00192         <span class="comment">//</span>
00193         <span class="keywordflow">if</span> ( dwBufLenAttr != 0 )
00194         {
00195             ImmGetCompositionString( hIMC,
00196                                      GCS_COMPATTR,
00197                                      TempBufA,
00198                                      dwBufLenAttr );
00199             TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00200         }
00201 
00202         CursorPos = ImmGetCompositionString( hIMC, GCS_CURSORPOS, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0 );
00203         <span class="keywordflow">if</span> (CursorPos == 0)
00204             TempBufA[ CursorPos ]   |= (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0x20;
00205         <span class="keywordflow">else</span>
00206             TempBufA[ CursorPos-1 ] |= (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0x10;
00207 
00208 <span class="preprocessor">#ifdef DEBUG_INFO</span>
00209 <span class="preprocessor"></span>        <span class="comment">//</span>
00210         <span class="comment">// Display new composition chars.</span>
00211         <span class="comment">//</span>
00212         xPos = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwBufLen;
00213         xPosLast = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwBufLen;
00214 
00215         <a class="code" href="../../d4/d5/conimep_8h.html#a115">DisplayCompString</a>( hwnd, dwBufLen / <span class="keyword">sizeof</span>(WCHAR), TempBuf, TempBufA );
00216 <span class="preprocessor">#endif</span>
00217 <span class="preprocessor"></span>
00218         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00219         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>)
00220             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o4">dwCompStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00221 
00222         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00223         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>)
00224             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o2">dwCompAttrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) + dwBufLen +  <span class="keyword">sizeof</span>(WCHAR);
00225     }
00226     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00227     {
00228         <span class="comment">//</span>
00229         <span class="comment">// Reads in the result string.</span>
00230         <span class="comment">//</span>
00231         ImmGetCompositionString( hIMC, GCS_RESULTSTR, TempBuf, dwBufLen );
00232 
00233         <span class="comment">//</span>
00234         <span class="comment">// Null terminated.</span>
00235         <span class="comment">//</span>
00236         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00237 
00238 <span class="preprocessor">#ifdef DEBUG_INFO</span>
00239 <span class="preprocessor"></span>        <span class="comment">//</span>
00240         <span class="comment">// Displays the result string.</span>
00241         <span class="comment">//</span>
00242         <a class="code" href="../../d4/d5/conimep_8h.html#a116">DisplayResultString</a>( hwnd, TempBuf );
00243 <span class="preprocessor">#endif</span>
00244 <span class="preprocessor"></span>
00245         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00246         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>)
00247             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o6">dwResultStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00248     }
00249     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00250     {
00251         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00252         TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00253         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00254         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00255         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00256     }
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// send character to Console</span>
00260     <span class="comment">//</span>
00261     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00262                            (WPARAM)hwnd,
00263                            (LPARAM)&amp;CopyData
00264                           );
00265 
00266     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00267 
00268 }
00269 
00270 
00271 <span class="keywordtype">void</span>
<a name="l00272"></a><a class="code" href="../../d8/d7/country3_8c.html#a2">00272</a> <a class="code" href="../../d8/d7/country3_8c.html#a2">GetCompStrTaiwan</a>(
00273     HWND hwnd,
00274     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00275     LPARAM CompFlag
00276     )
00277 {
00278     HIMC        hIMC;                   <span class="comment">// Input context handle.</span>
00279     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLen;               <span class="comment">// Stogare for len. of composition str</span>
00280     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLenAttr;
00281     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       SizeToAlloc;
00282     PWCHAR      TempBuf;
00283     PUCHAR      TempBufA;
00284     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00285     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       CursorPos;
00286     COPYDATASTRUCT CopyData;
00287     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
00288     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">// If fail to get input context handle then do nothing.</span>
00292     <span class="comment">// Applications should call ImmGetContext API to get</span>
00293     <span class="comment">// input context handle.</span>
00294     <span class="comment">//</span>
00295     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
00296     <span class="keywordflow">if</span> ( hIMC == 0 )
00297         <span class="keywordflow">return</span>;
00298 
00299     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
00300     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00301         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00302         <span class="keywordflow">return</span>;
00303     }
00304 
00305     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00306     {
00307         <span class="comment">//</span>
00308         <span class="comment">// Determines how much memory space to store the composition string.</span>
00309         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00310         <span class="comment">// GCS_COMPSTR flag on, buffer length zero, to get the bullfer</span>
00311         <span class="comment">// length.</span>
00312         <span class="comment">//</span>
00313         dwBufLen = ImmGetCompositionString( hIMC, GCS_COMPSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a>*)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00314         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00315             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00316             <span class="keywordflow">return</span>;
00317         }
00318         <span class="keywordflow">if</span> ( CompFlag &amp; GCS_COMPATTR )
00319         {
00320             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"                           GCS_COMPATTR\n"</span>));
00321             dwBufLenAttr = ImmGetCompositionString( hIMC, GCS_COMPATTR,( <span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00322             <span class="keywordflow">if</span> ( dwBufLenAttr &lt; 0 ) {
00323                 dwBufLenAttr = 0;
00324             }
00325         }
00326         <span class="keywordflow">else</span> {
00327             dwBufLenAttr = 0;
00328         }
00329     }
00330     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00331     {
00332         <span class="comment">//</span>
00333         <span class="comment">// Determines how much memory space to store the result string.</span>
00334         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00335         <span class="comment">// GCS_RESULTSTR flag on, buffer length zero, to get the bullfer</span>
00336         <span class="comment">// length.</span>
00337         <span class="comment">//</span>
00338         dwBufLen = ImmGetCompositionString( hIMC, GCS_RESULTSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00339         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00340             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00341             <span class="keywordflow">return</span>;
00342         }
00343         dwBufLenAttr = 0;
00344     }
00345     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00346     {
00347         dwBufLen = 0;
00348         dwBufLenAttr = 0;
00349     }
00350 
00351     SizeToAlloc = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)( <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00352                           dwBufLen     + <span class="keyword">sizeof</span>(WCHAR) +
00353                           dwBufLenAttr + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)   );
00354 
00355     <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00356          SizeToAlloc &gt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>
00357        )
00358     {
00359         LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> );
00360         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361     }
00362 
00363     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00364         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = (<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a>)LocalAlloc(LPTR, SizeToAlloc );
00365         <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00366             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00367             <span class="keywordflow">return</span>;
00368         }
00369         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> = SizeToAlloc;
00370     }
00371 
00372     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
00373     RtlZeroMemory(&amp;lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>,
00374                   lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> - <span class="keyword">sizeof</span>(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>)
00375                  );
00376 
00377     TempBuf  = (PWCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>));
00378     TempBufA = (PUCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00379                        dwBufLen +  <span class="keyword">sizeof</span>(WCHAR));
00380 
00381     CopyMemory(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o7">CompAttrColor</a> , ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a> , 8 * <span class="keyword">sizeof</span>(WCHAR));
00382 
00383     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00384     {
00385         <span class="comment">//</span>
00386         <span class="comment">// Reads in the composition string.</span>
00387         <span class="comment">//</span>
00388         ImmGetCompositionString( hIMC, GCS_COMPSTR, TempBuf, dwBufLen );
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">// Null terminated.</span>
00392         <span class="comment">//</span>
00393         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// If GCS_COMPATTR flag is on, then we need to take care of it.</span>
00397         <span class="comment">//</span>
00398         <span class="keywordflow">if</span> ( dwBufLenAttr != 0 )
00399         {
00400             ImmGetCompositionString( hIMC,
00401                                      GCS_COMPATTR,
00402                                      TempBufA,
00403                                      dwBufLenAttr );
00404             TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00405         }
00406 
00407         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00408         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>)
00409             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o4">dwCompStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00410 
00411         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00412         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>)
00413             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o2">dwCompAttrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) + dwBufLen +  <span class="keyword">sizeof</span>(WCHAR);
00414         <span class="comment">//</span>
00415         <span class="comment">// Display character to Console</span>
00416         <span class="comment">//</span>
00417         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00418         CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00419         CopyData.lpData = lpModeInfo;
00420 
00421         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a19">MakeInfoStringTaiwan</a>(ConTbl, lpModeInfo) ) {
00422             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00423                                    (WPARAM)hwnd,
00424                                    (LPARAM)&amp;CopyData
00425                                  );
00426         }
00427     }
00428     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00429     {
00430         <span class="comment">//</span>
00431         <span class="comment">// Reads in the result string.</span>
00432         <span class="comment">//</span>
00433         ImmGetCompositionString( hIMC, GCS_RESULTSTR, TempBuf, dwBufLen );
00434 
00435         <span class="comment">//</span>
00436         <span class="comment">// Null terminated.</span>
00437         <span class="comment">//</span>
00438         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00439 
00440         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00441         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>)
00442             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o6">dwResultStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00443         <span class="comment">//</span>
00444         <span class="comment">// send character to Console</span>
00445         <span class="comment">//</span>
00446         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
00447         CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
00448         CopyData.lpData = lpCompStrMem;
00449         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00450                                (WPARAM)hwnd,
00451                                (LPARAM)&amp;CopyData
00452                               );
00453 
00454     }
00455     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00456     {
00457         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00458         TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00459         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00460         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00461         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00462         <span class="comment">//</span>
00463         <span class="comment">// Display character to Console</span>
00464         <span class="comment">//</span>
00465         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00466         CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00467         CopyData.lpData = lpModeInfo;
00468 
00469         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a19">MakeInfoStringTaiwan</a>(ConTbl, lpModeInfo) ) {
00470             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00471                                    (WPARAM)hwnd,
00472                                    (LPARAM)&amp;CopyData
00473                                  );
00474         }
00475     }
00476 
00477 
00478     LocalFree( lpModeInfo );
00479 
00480     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00481     <span class="keywordflow">return</span>;
00482 
00483 }
00484 
00485 <span class="keywordtype">void</span>
<a name="l00486"></a><a class="code" href="../../d8/d7/country3_8c.html#a3">00486</a> <a class="code" href="../../d8/d7/country3_8c.html#a3">GetCompStrPRC</a>(
00487     HWND hwnd,
00488     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00489     LPARAM CompFlag
00490     )
00491 {
00492     HIMC        hIMC;                   <span class="comment">// Input context handle.</span>
00493     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLen;               <span class="comment">// Stogare for len. of composition str</span>
00494     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLenAttr;
00495     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       SizeToAlloc;
00496     PWCHAR      TempBuf;
00497     PUCHAR      TempBufA;
00498     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00499     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       CursorPos;
00500     COPYDATASTRUCT CopyData;
00501     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
00502     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
00503 
00504     <span class="comment">//</span>
00505     <span class="comment">// If fail to get input context handle then do nothing.</span>
00506     <span class="comment">// Applications should call ImmGetContext API to get</span>
00507     <span class="comment">// input context handle.</span>
00508     <span class="comment">//</span>
00509     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
00510     <span class="keywordflow">if</span> ( hIMC == 0 )
00511         <span class="keywordflow">return</span>;
00512 
00513     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
00514     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00515         <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00516         <span class="keywordflow">return</span>;
00517     }
00518 
00519     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00520     {
00521         <span class="comment">//</span>
00522         <span class="comment">// Determines how much memory space to store the composition string.</span>
00523         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00524         <span class="comment">// GCS_COMPSTR flag on, buffer length zero, to get the bullfer</span>
00525         <span class="comment">// length.</span>
00526         <span class="comment">//</span>
00527         dwBufLen = ImmGetCompositionString( hIMC, GCS_COMPSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a>*)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00528         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00529             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00530             <span class="keywordflow">return</span>;
00531         }
00532         <span class="keywordflow">if</span> ( CompFlag &amp; GCS_COMPATTR )
00533         {
00534             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"                           GCS_COMPATTR\n"</span>));
00535             dwBufLenAttr = ImmGetCompositionString( hIMC, GCS_COMPATTR,( <span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00536             <span class="keywordflow">if</span> ( dwBufLenAttr &lt; 0 ) {
00537                 dwBufLenAttr = 0;
00538             }
00539         }
00540         <span class="keywordflow">else</span> {
00541             dwBufLenAttr = 0;
00542         }
00543     }
00544     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00545     {
00546         <span class="comment">//</span>
00547         <span class="comment">// Determines how much memory space to store the result string.</span>
00548         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00549         <span class="comment">// GCS_RESULTSTR flag on, buffer length zero, to get the bullfer</span>
00550         <span class="comment">// length.</span>
00551         <span class="comment">//</span>
00552         dwBufLen = ImmGetCompositionString( hIMC, GCS_RESULTSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00553         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00554             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00555             <span class="keywordflow">return</span>;
00556         }
00557         dwBufLenAttr = 0;
00558     }
00559     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00560     {
00561         dwBufLen = 0;
00562         dwBufLenAttr = 0;
00563     }
00564 
00565     SizeToAlloc = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)( <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00566                           dwBufLen     + <span class="keyword">sizeof</span>(WCHAR) +
00567                           dwBufLenAttr + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)   );
00568 
00569     <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00570          SizeToAlloc &gt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>
00571        )
00572     {
00573         LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> );
00574         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00575     }
00576 
00577     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00578         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = (<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a>)LocalAlloc(LPTR, SizeToAlloc );
00579         <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00580             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00581             <span class="keywordflow">return</span>;
00582         }
00583         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> = SizeToAlloc;
00584     }
00585 
00586     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
00587     RtlZeroMemory(&amp;lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>,
00588                   lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> - <span class="keyword">sizeof</span>(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>)
00589                  );
00590 
00591     TempBuf  = (PWCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>));
00592     TempBufA = (PUCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00593                        dwBufLen +  <span class="keyword">sizeof</span>(WCHAR));
00594 
00595     CopyMemory(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o7">CompAttrColor</a> , ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a> , 8 * <span class="keyword">sizeof</span>(WCHAR));
00596 
00597     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00598     {
00599         <span class="comment">//</span>
00600         <span class="comment">// Reads in the composition string.</span>
00601         <span class="comment">//</span>
00602         ImmGetCompositionString( hIMC, GCS_COMPSTR, TempBuf, dwBufLen );
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Null terminated.</span>
00606         <span class="comment">//</span>
00607         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00608 
00609         <span class="comment">//</span>
00610         <span class="comment">// If GCS_COMPATTR flag is on, then we need to take care of it.</span>
00611         <span class="comment">//</span>
00612         <span class="keywordflow">if</span> ( dwBufLenAttr != 0 )
00613         {
00614             ImmGetCompositionString( hIMC,
00615                                      GCS_COMPATTR,
00616                                      TempBufA,
00617                                      dwBufLenAttr );
00618             TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00619         }
00620 
00621         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00622         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>)
00623             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o4">dwCompStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00624 
00625         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00626         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>)
00627             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o2">dwCompAttrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) + dwBufLen +  <span class="keyword">sizeof</span>(WCHAR);
00628         <span class="comment">//</span>
00629         <span class="comment">// Display character to Console</span>
00630         <span class="comment">//</span>
00631         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00632         CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00633         CopyData.lpData = lpModeInfo;
00634 
00635         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a25">MakeInfoStringPRC</a>(ConTbl, lpModeInfo) ) {
00636             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00637                                    (WPARAM)hwnd,
00638                                    (LPARAM)&amp;CopyData
00639                                  );
00640         }
00641     }
00642     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00643     {
00644         <span class="comment">//</span>
00645         <span class="comment">// Reads in the result string.</span>
00646         <span class="comment">//</span>
00647         ImmGetCompositionString( hIMC, GCS_RESULTSTR, TempBuf, dwBufLen );
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// Null terminated.</span>
00651         <span class="comment">//</span>
00652         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00653 
00654         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00655         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>)
00656             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o6">dwResultStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00657         <span class="comment">//</span>
00658         <span class="comment">// send character to Console</span>
00659         <span class="comment">//</span>
00660         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
00661         CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
00662         CopyData.lpData = lpCompStrMem;
00663         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00664                                (WPARAM)hwnd,
00665                                (LPARAM)&amp;CopyData
00666                               );
00667 
00668     }
00669     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00670     {
00671         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00672         TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00673         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00674         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00675         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00676         <span class="comment">//</span>
00677         <span class="comment">// Display character to Console</span>
00678         <span class="comment">//</span>
00679         CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00680         CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
00681         CopyData.lpData = lpModeInfo;
00682 
00683         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a25">MakeInfoStringPRC</a>(ConTbl, lpModeInfo) ) {
00684             <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00685                                    (WPARAM)hwnd,
00686                                    (LPARAM)&amp;CopyData
00687                                  );
00688         }
00689     }
00690 
00691 
00692     LocalFree( lpModeInfo );
00693 
00694     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00695     <span class="keywordflow">return</span>;
00696 
00697 }
00698 
00699 <span class="keywordtype">void</span>
<a name="l00700"></a><a class="code" href="../../d8/d7/country3_8c.html#a4">00700</a> <a class="code" href="../../d8/d7/country3_8c.html#a4">GetCompStrKorea</a>(
00701     HWND hwnd,
00702     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl,
00703     LPARAM CompFlag,
00704     WPARAM CompChar
00705     )
00706 {
00707     HIMC        hIMC;                   <span class="comment">// Input context handle.</span>
00708     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLen;               <span class="comment">// Stogare for len. of composition str</span>
00709     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwBufLenAttr;
00710     COPYDATASTRUCT CopyData;
00711     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       SizeToAlloc;
00712     PWCHAR      TempBuf;
00713     PUCHAR      TempBufA;
00714     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       i;
00715     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       CursorPos;
00716     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// If fail to get input context handle then do nothing.</span>
00720     <span class="comment">// Applications should call ImmGetContext API to get</span>
00721     <span class="comment">// input context handle.</span>
00722     <span class="comment">//</span>
00723     hIMC = <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a5">ImmGetContext</a>( hwnd );
00724     <span class="keywordflow">if</span> ( hIMC == 0 )
00725          <span class="keywordflow">return</span>;
00726 
00727 <span class="comment">//    if (CompFlag &amp; CS_INSERTCHAR)</span>
00728 <span class="comment">//    {</span>
00729 <span class="comment">//        dwBufLen = 1;</span>
00730 <span class="comment">//        dwBufLenAttr = 1;</span>
00731 <span class="comment">//    }</span>
00732 <span class="comment">//    else</span>
00733     <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00734     {
00735         <span class="comment">//</span>
00736         <span class="comment">// Determines how much memory space to store the composition string.</span>
00737         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00738         <span class="comment">// GCS_COMPSTR flag on, buffer length zero, to get the bullfer</span>
00739         <span class="comment">// length.</span>
00740         <span class="comment">//</span>
00741         dwBufLen = ImmGetCompositionString( hIMC, GCS_COMPSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a>*)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00742         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00743             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00744             <span class="keywordflow">return</span>;
00745         }
00746         <span class="keywordflow">if</span> ( CompFlag &amp; GCS_COMPATTR )
00747         {
00748             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"                           GCS_COMPATTR\n"</span>));
00749             dwBufLenAttr = ImmGetCompositionString( hIMC, GCS_COMPATTR,( <span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00750             <span class="keywordflow">if</span> ( dwBufLenAttr &lt; 0 ) {
00751                 dwBufLenAttr = 0;
00752             }
00753         }
00754         <span class="keywordflow">else</span> {
00755             dwBufLenAttr = dwBufLen;
00756         }
00757     }
00758     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00759     {
00760         <span class="comment">//</span>
00761         <span class="comment">// Determines how much memory space to store the result string.</span>
00762         <span class="comment">// Applications should call ImmGetCompositionString with</span>
00763         <span class="comment">// GCS_RESULTSTR flag on, buffer length zero, to get the bullfer</span>
00764         <span class="comment">// length.</span>
00765         <span class="comment">//</span>
00766         dwBufLen = ImmGetCompositionString( hIMC, GCS_RESULTSTR, (<span class="keywordtype">void</span> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0l );
00767         <span class="keywordflow">if</span> ( dwBufLen &lt; 0 ) {
00768             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00769             <span class="keywordflow">return</span>;
00770         }
00771         dwBufLenAttr = 0;
00772     }
00773     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00774     {
00775         dwBufLen = 0;
00776         dwBufLenAttr = 0;
00777     }
00778     <span class="keywordflow">else</span>
00779     {
00780         <span class="keywordflow">return</span>;
00781     }
00782 
00783     SizeToAlloc = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)( <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00784                           dwBufLen     + <span class="keyword">sizeof</span>(WCHAR) +
00785                           dwBufLenAttr + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)   );
00786 
00787     <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00788          SizeToAlloc &gt; ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>
00789        )
00790     {
00791         LocalFree( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> );
00792         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00793     }
00794 
00795     <span class="keywordflow">if</span> (ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00796         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> = (<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a>)LocalAlloc(LPTR, SizeToAlloc );
00797         <span class="keywordflow">if</span> ( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00798             <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00799             <span class="keywordflow">return</span>;
00800         }
00801         ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> = SizeToAlloc;
00802     }
00803 
00804     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
00805     RtlZeroMemory(&amp;lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>,
00806                   lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a> - <span class="keyword">sizeof</span>(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>)
00807                  );
00808 
00809     TempBuf  = (PWCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>));
00810     TempBufA = (PUCHAR)((PUCHAR)lpCompStrMem + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) +
00811                        dwBufLen +  <span class="keyword">sizeof</span>(WCHAR));
00812 
00813     CopyMemory(lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o7">CompAttrColor</a> , ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o15">CompAttrColor</a> , 8 * <span class="keyword">sizeof</span>(WCHAR));
00814 
00815     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
00816     CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
00817     CopyData.lpData = lpCompStrMem;
00818 
00819     <span class="keywordflow">if</span> (CompFlag &amp; CS_INSERTCHAR)
00820     {
00821         *TempBuf = (WORD)CompChar;
00822         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00823         *TempBufA = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)ATTR_TARGET_CONVERTED;
00824         TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00825     }
00826     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_COMPSTR)
00827     {
00828         <span class="comment">//</span>
00829         <span class="comment">// Reads in the composition string.</span>
00830         <span class="comment">//</span>
00831         ImmGetCompositionString( hIMC, GCS_COMPSTR, TempBuf, dwBufLen );
00832 
00833         <span class="comment">//</span>
00834         <span class="comment">// Null terminated.</span>
00835         <span class="comment">//</span>
00836         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00837 
00838         <span class="comment">//</span>
00839         <span class="comment">// If GCS_COMPATTR flag is on, then we need to take care of it.</span>
00840         <span class="comment">//</span>
00841         <span class="keywordflow">if</span> ( dwBufLenAttr != 0 )
00842         {
00843             <span class="keywordflow">if</span> ( CompFlag &amp; GCS_COMPATTR )
00844             {
00845                 ImmGetCompositionString( hIMC,
00846                                          GCS_COMPATTR,
00847                                          TempBufA,
00848                                          dwBufLenAttr );
00849                 TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00850             }
00851             <span class="keywordflow">else</span>
00852             {
00853                 <span class="keywordflow">for</span> (i = 0; i &lt;= dwBufLenAttr; i++)
00854                     TempBufA[ i ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)1;
00855             }
00856         }
00857 
00858 <span class="comment">// Korean  NT does not need IME cursor. v-hirshi</span>
00859 <span class="comment">//        CursorPos = ImmGetCompositionString( hIMC, GCS_CURSORPOS, NULL, 0 );</span>
00860 <span class="comment">//        if (CursorPos == 0)</span>
00861 <span class="comment">//            TempBufA[ CursorPos ]   |= (BYTE)0x20;</span>
00862 <span class="comment">//        else</span>
00863 <span class="comment">//            TempBufA[ CursorPos-1 ] |= (BYTE)0x10;</span>
00864 
00865 <span class="preprocessor">#ifdef DEBUG_INFO</span>
00866 <span class="preprocessor"></span>        <span class="comment">//</span>
00867         <span class="comment">// Display new composition chars.</span>
00868         <span class="comment">//</span>
00869         xPos = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwBufLen;
00870         xPosLast = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)dwBufLen;
00871 
00872         <a class="code" href="../../d4/d5/conimep_8h.html#a115">DisplayCompString</a>( hwnd, dwBufLen / <span class="keyword">sizeof</span>(WCHAR), TempBuf, TempBufA );
00873 <span class="preprocessor">#endif</span>
00874 <span class="preprocessor"></span>
00875         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00876         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>)
00877             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o4">dwCompStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00878 
00879         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00880         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>)
00881             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o2">dwCompAttrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>) + dwBufLen +  <span class="keyword">sizeof</span>(WCHAR);
00882     }
00883     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag &amp; GCS_RESULTSTR)
00884     {
00885         <span class="comment">//</span>
00886         <span class="comment">// Reads in the result string.</span>
00887         <span class="comment">//</span>
00888         ImmGetCompositionString( hIMC, GCS_RESULTSTR, TempBuf, dwBufLen );
00889 
00890         <span class="comment">//</span>
00891         <span class="comment">// Null terminated.</span>
00892         <span class="comment">//</span>
00893         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00894 
00895 <span class="preprocessor">#ifdef DEBUG_INFO</span>
00896 <span class="preprocessor"></span>        <span class="comment">//</span>
00897         <span class="comment">// Displays the result string.</span>
00898         <span class="comment">//</span>
00899         <a class="code" href="../../d4/d5/conimep_8h.html#a116">DisplayResultString</a>( hwnd, TempBuf );
00900 <span class="preprocessor">#endif</span>
00901 <span class="preprocessor"></span>
00902         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00903         <span class="keywordflow">if</span> (lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>)
00904             lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o6">dwResultStrOffset</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">CONIME_UICOMPMESSAGE</a>);
00905     }
00906     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CompFlag == 0)
00907     {
00908         TempBuf[ dwBufLen / <span class="keyword">sizeof</span>(WCHAR) ] = TEXT(<span class="charliteral">'\0'</span>);
00909         TempBufA[ dwBufLenAttr ] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)0;
00910         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o5">dwResultStrLen</a>    = dwBufLen;
00911         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o3">dwCompStrLen</a>      = dwBufLen;
00912         lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o1">dwCompAttrLen</a>     = dwBufLenAttr;
00913     }
00914 
00915     <span class="comment">//</span>
00916     <span class="comment">// send character to Console</span>
00917     <span class="comment">//</span>
00918     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00919                            (WPARAM)hwnd,
00920                            (LPARAM)&amp;CopyData
00921                           );
00922 
00923     <a class="code" href="../../d7/d6/w32_2ntuser_2imm_2context_8c.html#a7">ImmReleaseContext</a>( hwnd, hIMC );
00924 
00925 }
00926 
00927 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00928"></a><a class="code" href="../../d8/d7/country3_8c.html#a5">00928</a> <a class="code" href="../../d8/d7/country3_8c.html#a5">ReDisplayCompositionStr</a> (
00929     HWND hwnd
00930     )
00931 {
00932     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl;
00933 
00934     ConTbl = <a class="code" href="../../d4/d5/conimep_8h.html#a100">SearchConsole</a>(<a class="code" href="../../d0/d5/ntcon_2conime_2conime_8c.html#a3">LastConsole</a>);
00935     <span class="keywordflow">if</span> (ConTbl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00936         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>((<span class="stringliteral">"CONIME: Error! Cannot found registed Console\n"</span>));
00937         <span class="keywordflow">return</span>;
00938     }
00939 
00940     <span class="keywordflow">if</span> (! ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o13">fInComposition</a>)
00941        <span class="keywordflow">return</span>;
00942 
00943     <span class="keywordflow">switch</span> ( <a class="code" href="../../d4/d5/conimep_8h.html#a50">HKL_TO_LANGID</a>(ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o3">hklActive</a>))
00944     {
00945         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a43">LANG_ID_JAPAN</a>:
00946             <a class="code" href="../../d8/d7/country3_8c.html#a6">ReDisplayCompStrJapan</a>(hwnd, ConTbl);
00947             <span class="keywordflow">break</span>;
00948         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a42">LANG_ID_TAIWAN</a>:
00949             <a class="code" href="../../d8/d7/country3_8c.html#a7">ReDisplayCompStrTaiwan</a>(hwnd, ConTbl);
00950             <span class="keywordflow">break</span>;
00951         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a45">LANG_ID_PRC</a>:
00952             <a class="code" href="../../d8/d7/country3_8c.html#a8">ReDisplayCompStrPRC</a>(hwnd, ConTbl);
00953             <span class="keywordflow">break</span>;
00954         <span class="keywordflow">case</span>    <a class="code" href="../../d4/d5/conimep_8h.html#a44">LANG_ID_KOREA</a>:
00955             <a class="code" href="../../d8/d7/country3_8c.html#a9">ReDisplayCompStrKorea</a>(hwnd, ConTbl);
00956             <span class="keywordflow">break</span>;
00957         <span class="keywordflow">default</span>:
00958             <span class="keywordflow">break</span>;
00959     }
00960     <span class="keywordflow">return</span>;
00961 }
00962 
00963 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00964"></a><a class="code" href="../../d8/d7/country3_8c.html#a6">00964</a> <a class="code" href="../../d8/d7/country3_8c.html#a6">ReDisplayCompStrJapan</a>(
00965     HWND hwnd,
00966     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl
00967     )
00968 {
00969     COPYDATASTRUCT CopyData;
00970     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
00971 
00972     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
00973     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
00974     CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
00975     CopyData.lpData = lpCompStrMem;
00976     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
00977                            (WPARAM)hwnd,
00978                            (LPARAM)&amp;CopyData
00979                           );
00980 }
00981 
00982 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00983"></a><a class="code" href="../../d8/d7/country3_8c.html#a7">00983</a> <a class="code" href="../../d8/d7/country3_8c.html#a7">ReDisplayCompStrTaiwan</a>(
00984     HWND hwnd,
00985     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl
00986     )
00987 {
00988     COPYDATASTRUCT CopyData;
00989     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
00990 
00991     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
00992     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993         <span class="keywordflow">return</span>;
00994     }
00995     <span class="comment">//</span>
00996     <span class="comment">// Display character to Console</span>
00997     <span class="comment">//</span>
00998     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
00999     CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
01000     CopyData.lpData = lpModeInfo;
01001 
01002     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a19">MakeInfoStringTaiwan</a>(ConTbl, lpModeInfo) ) {
01003         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01004                                (WPARAM)hwnd,
01005                                (LPARAM)&amp;CopyData
01006                              );
01007     }
01008 
01009     LocalFree( lpModeInfo );
01010 }
01011 
01012 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01013"></a><a class="code" href="../../d8/d7/country3_8c.html#a8">01013</a> <a class="code" href="../../d8/d7/country3_8c.html#a8">ReDisplayCompStrPRC</a>(
01014     HWND hwnd,
01015     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl
01016     )
01017 {
01018     COPYDATASTRUCT CopyData;
01019     <a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a> lpModeInfo;
01020 
01021     lpModeInfo = (<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">LPCONIME_UIMODEINFO</a>)LocalAlloc(LPTR, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__CONIME__UIMODEINFO.html">CONIME_UIMODEINFO</a>) );
01022     <span class="keywordflow">if</span> ( lpModeInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01023         <span class="keywordflow">return</span>;
01024     }
01025     <span class="comment">//</span>
01026     <span class="comment">// Display character to Console</span>
01027     <span class="comment">//</span>
01028     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a5">CI_CONIMEMODEINFO</a>;
01029     CopyData.cbData = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d5/conime_8h.html#a42">CONIME_UIMODEINFO</a>);
01030     CopyData.lpData = lpModeInfo;
01031 
01032     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/country_8c.html#a25">MakeInfoStringPRC</a>(ConTbl, lpModeInfo) ) {
01033         <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01034                                (WPARAM)hwnd,
01035                                (LPARAM)&amp;CopyData
01036                              );
01037     }
01038     LocalFree( lpModeInfo );
01039 }
01040 
01041 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01042"></a><a class="code" href="../../d8/d7/country3_8c.html#a9">01042</a> <a class="code" href="../../d8/d7/country3_8c.html#a9">ReDisplayCompStrKorea</a>(
01043     HWND hwnd,
01044     <a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html">PCONSOLE_TABLE</a> ConTbl
01045     )
01046 {
01047 
01048     COPYDATASTRUCT CopyData;
01049     <a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html">LPCONIME_UICOMPMESSAGE</a> lpCompStrMem;
01050 
01051     lpCompStrMem = ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o14">lpCompStrMem</a>;
01052     CopyData.dwData = <a class="code" href="../../d3/d5/conime_8h.html#a4">CI_CONIMECOMPOSITION</a>;
01053     CopyData.cbData = lpCompStrMem-&gt;<a class="code" href="../../d9/d8/struct__CONIME__UICOMPMESSAGE.html#o0">dwSize</a>;
01054     CopyData.lpData = lpCompStrMem;
01055     <a class="code" href="../../d4/d5/conimep_8h.html#a109">ConsoleImeSendMessage</a>( ConTbl-&gt;<a class="code" href="../../d0/d7/struct__CONSOLE__TABLE.html#o1">hWndCon</a>,
01056                            (WPARAM)hwnd,
01057                            (LPARAM)&amp;CopyData
01058                           );
01059 
01060 }
01061 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:34 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
