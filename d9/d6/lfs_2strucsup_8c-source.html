<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: strucsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>strucsup.c</h1><a href="../../d8/d7/lfs_2strucsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    StrucSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module provides support routines for creation and deletion</span>
00012 <span class="comment">    of Lfs structures.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Brian Andrew    [BrianAn]   20-June-1991</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/lfsprocs_8h.html">lfsprocs.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The debug trace level</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a0">00028</a> <span class="preprocessor">#define Dbg                              (DEBUG_TRACE_STRUC_SUP)</span>
00029 <span class="preprocessor"></span>
00030 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsAllocateLbcb)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsAllocateLfcb)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsDeallocateLbcb)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsDeallocateLfcb)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsAllocateLcb)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, LfsDeallocateLcb)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a>
<a name="l00041"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a1">00041</a> <a class="code" href="../../d0/d4/lfsprocs_8h.html#a65">LfsAllocateLfcb</a> (
00042     )
00043 
00044 <span class="comment">/*++</span>
00045 <span class="comment"></span>
00046 <span class="comment">Routine Description:</span>
00047 <span class="comment"></span>
00048 <span class="comment">    This routine allocates and initializes a log file control block.</span>
00049 <span class="comment"></span>
00050 <span class="comment">Arguments:</span>
00051 <span class="comment"></span>
00052 <span class="comment">Return Value:</span>
00053 <span class="comment"></span>
00054 <span class="comment">    PLFCB - A pointer to the log file control block just</span>
00055 <span class="comment">                              allocated and initialized.</span>
00056 <span class="comment"></span>
00057 <span class="comment">--*/</span>
00058 
00059 {
00060     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00062     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00063     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00064 
00065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00066 
00067     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsAllocateLfcb:  Entered\n"</span>, 0 );
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00071     <span class="comment">//</span>
00072 
00073     <span class="keywordflow">try</span> {
00074 
00075         <span class="comment">//</span>
00076         <span class="comment">//  Allocate and zero the structure for the Lfcb.</span>
00077         <span class="comment">//</span>
00078 
00079         Lfcb = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d0/struct__LFCB.html">LFCB</a> ));
00080 
00081         <span class="comment">//</span>
00082         <span class="comment">//  Zero out the structure initially.</span>
00083         <span class="comment">//</span>
00084 
00085         RtlZeroMemory( Lfcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d4/lfsstruc_8h.html#a34">LFCB</a> ));
00086 
00087         <span class="comment">//</span>
00088         <span class="comment">//  Initialize the log file control block.</span>
00089         <span class="comment">//</span>
00090 
00091         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a4">LFS_NTC_LFCB</a>;
00092         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d4/lfsstruc_8h.html#a34">LFCB</a> );
00093 
00094         <span class="comment">//</span>
00095         <span class="comment">//  Initialize the client links.</span>
00096         <span class="comment">//</span>
00097 
00098         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o3">LchLinks</a> );
00099 
00100         <span class="comment">//</span>
00101         <span class="comment">//  Initialize the Lbcb links.</span>
00102         <span class="comment">//</span>
00103 
00104         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o25">LbcbWorkque</a> );
00105         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o26">LbcbActive</a> );
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">//  Initialize and allocate the spare Lbcb queue.</span>
00109         <span class="comment">//</span>
00110 
00111         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a> );
00112 
00113         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++) {
00114 
00115             NextLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00116 
00117             <span class="keywordflow">if</span> (NextLbcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00118 
00119                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o56">SpareLbcbList</a>, (PLIST_ENTRY) NextLbcb );
00120                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o55">SpareLbcbCount</a> += 1;
00121             }
00122         }
00123 
00124         <span class="comment">//</span>
00125         <span class="comment">//  Initialize and allocate the spare Lcb queue.</span>
00126         <span class="comment">//</span>
00127 
00128         InitializeListHead( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a> );
00129 
00130         <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++)  {
00131 
00132             NextLcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );
00133 
00134             <span class="keywordflow">if</span> (NextLcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135 
00136                 InsertHeadList( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o58">SpareLcbList</a>, (PLIST_ENTRY) NextLcb );
00137                 Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o57">SpareLcbCount</a> += 1;
00138             }
00139         }
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">//  Allocate the Lfcb synchronization event.</span>
00143         <span class="comment">//</span>
00144 
00145         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a> = <a class="code" href="../../d5/d5/cc_8h.html#a8">FsRtlAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d0/struct__LFCB__SYNC.html">LFCB_SYNC</a> ));
00146 
00147         <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o0">Resource</a> );
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">//  Initialize the pseudo Lsn for the restart Lbcb's</span>
00151         <span class="comment">//</span>
00152 
00153         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o37">NextRestartLsn</a> = <a class="code" href="../../d7/d3/lfsdata_8c.html#a3">LfsLi1</a>;
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">//  Initialize the event to the signalled state.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o1">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00160 
00161         Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o2">UserCount</a> = 0;
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">//  Initialize the spare list mutex</span>
00165         <span class="comment">//</span>
00166 
00167         <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;(Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o59">Sync</a>-&gt;<a class="code" href="../../d2/d0/struct__LFCB__SYNC.html#o3">SpareListMutex</a>) );
00168 
00169     } finally {
00170 
00171         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsAllocateFileControlBlock );
00172 
00173         <span class="keywordflow">if</span> (AbnormalTermination()
00174             &amp;&amp; Lfcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00175 
00176             <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a>( Lfcb, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00177             Lfcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00178         }
00179 
00180         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsAllocateLfcb:  Exit -&gt; %08lx\n"</span>, Lfcb );
00181     }
00182 
00183     <span class="keywordflow">return</span> Lfcb;
00184 }
00185 
00186 
00187 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00188"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">00188</a> <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a2">LfsDeallocateLfcb</a> (
00189     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00190     IN BOOLEAN CompleteTeardown
00191     )
00192 
00193 <span class="comment">/*++</span>
00194 <span class="comment"></span>
00195 <span class="comment">Routine Description:</span>
00196 <span class="comment"></span>
00197 <span class="comment">    This routine releases the resources associated with a log file control</span>
00198 <span class="comment">    block.</span>
00199 <span class="comment"></span>
00200 <span class="comment">Arguments:</span>
00201 <span class="comment"></span>
00202 <span class="comment">    Lfcb - Supplies a pointer to the log file control block.</span>
00203 <span class="comment"></span>
00204 <span class="comment">    CompleteTeardown - Indicates if we are to completely remove this Lfcb.</span>
00205 <span class="comment"></span>
00206 <span class="comment">Return Value:</span>
00207 <span class="comment"></span>
00208 <span class="comment">    None</span>
00209 <span class="comment"></span>
00210 <span class="comment">--*/</span>
00211 
00212 {
00213     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NextLbcb;
00214     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>  NextLcb;
00215 
00216     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00217 
00218     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsDeallocateLfcb:  Entered\n"</span>, 0 );
00219     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Lfcb  -&gt; %08lx\n"</span>, Lfcb );
00220 
00221     <span class="comment">//</span>
00222     <span class="comment">//  Check that there are no buffer blocks.</span>
00223     <span class="comment">//</span>
00224 
00225     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbActive ));
00226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LbcbWorkque ));
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">//  Check that we have no clients.</span>
00230     <span class="comment">//</span>
00231 
00232     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Lfcb-&gt;LchLinks ));
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">//  If there is a restart area we deallocate it.</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (Lfcb-&gt;RestartArea != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00239 
00240         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lfcb-&gt;RestartArea );
00241     }
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">//  If there are any of the tail Lbcb's, deallocate them now.</span>
00245     <span class="comment">//</span>
00246 
00247     <span class="keywordflow">if</span> (Lfcb-&gt;ActiveTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00248 
00249         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;ActiveTail );
00250         Lfcb-&gt;ActiveTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00251     }
00252 
00253     <span class="keywordflow">if</span> (Lfcb-&gt;PrevTail != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00254 
00255         <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a>( Lfcb, Lfcb-&gt;PrevTail );
00256         Lfcb-&gt;PrevTail = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00257     }
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">//  Only do the following if we are to remove the Lfcb completely.</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (CompleteTeardown) {
00264 
00265         <span class="comment">//</span>
00266         <span class="comment">//  If there is a resource structure we deallocate it.</span>
00267         <span class="comment">//</span>
00268 
00269         <span class="keywordflow">if</span> (Lfcb-&gt;Sync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270 
00271             <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Lfcb-&gt;Sync-&gt;Resource );
00272 
00273             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb-&gt;Sync );
00274         }
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Deallocate all of the spare Lbcb's.</span>
00279     <span class="comment">//</span>
00280 
00281     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLbcbList )) {
00282 
00283         NextLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00284 
00285         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00286 
00287         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLbcb );
00288     }
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Deallocate all of the spare Lcb's.</span>
00292     <span class="comment">//</span>
00293 
00294     <span class="keywordflow">while</span> (!IsListEmpty( &amp;Lfcb-&gt;SpareLcbList )) {
00295 
00296         NextLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;
00297 
00298         RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );
00299 
00300         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NextLcb );
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">//  Discard the Lfcb structure.</span>
00305     <span class="comment">//</span>
00306 
00307     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lfcb );
00308 
00309     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"LfsDeallocateLfcb:  Exit\n"</span>, 0 );
00310     <span class="keywordflow">return</span>;
00311 }
00312 
00313 
00314 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00315"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">00315</a> <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a3">LfsAllocateLbcb</a> (
00316     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00317     OUT <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> *Lbcb
00318     )
00319 
00320 <span class="comment">/*++</span>
00321 <span class="comment"></span>
00322 <span class="comment">Routine Description:</span>
00323 <span class="comment"></span>
00324 <span class="comment">    This routine will allocate the next Lbcb.  If the pool allocation fails</span>
00325 <span class="comment">    we will look at the private queue of Lbcb's.</span>
00326 <span class="comment"></span>
00327 <span class="comment">Arguments:</span>
00328 <span class="comment"></span>
00329 <span class="comment">    Lfcb - Supplies a pointer to the log file control block.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    Lbcb - Address to store the allocated Lbcb.</span>
00332 <span class="comment"></span>
00333 <span class="comment">Return Value:</span>
00334 <span class="comment"></span>
00335 <span class="comment">    None</span>
00336 <span class="comment"></span>
00337 <span class="comment">--*/</span>
00338 
00339 {
00340     <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> NewLbcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341 
00342     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">//  If there are enough entries on the look-aside list then get one from</span>
00346     <span class="comment">//  there.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &gt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a15">LFCB_RESERVE_LBCB_COUNT</a>) {
00350 
00351         NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00352 
00353         Lfcb-&gt;SpareLbcbCount -= 1;
00354         RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">//  Otherwise try to allocate from pool.</span>
00358     <span class="comment">//</span>
00359 
00360     } <span class="keywordflow">else</span> {
00361 
00362         NewLbcb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ), ' sfL' );
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If we didn't get one then look at the look-aside list.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="keywordflow">if</span> (NewLbcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370 
00371         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount != 0) {
00372 
00373             NewLbcb = (<a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a>) Lfcb-&gt;SpareLbcbList.Flink;
00374 
00375             Lfcb-&gt;SpareLbcbCount -= 1;
00376             RemoveHeadList( &amp;Lfcb-&gt;SpareLbcbList );
00377 
00378         } <span class="keywordflow">else</span> {
00379 
00380             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );
00381         }
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  Initialize the structure.</span>
00386     <span class="comment">//</span>
00387 
00388     RtlZeroMemory( NewLbcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__LBCB.html">LBCB</a> ));
00389     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a3">LFS_NTC_LBCB</a>;
00390     NewLbcb-&gt;<a class="code" href="../../d4/d9/struct__LBCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d4/lfsstruc_8h.html#a31">LBCB</a> );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  Return it to the user.</span>
00394     <span class="comment">//</span>
00395 
00396     *Lbcb = NewLbcb;
00397     <span class="keywordflow">return</span>;
00398 }
00399 
00400 
00401 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00402"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">00402</a> <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a4">LfsDeallocateLbcb</a> (
00403     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00404     IN <a class="code" href="../../d4/d9/struct__LBCB.html">PLBCB</a> Lbcb
00405     )
00406 
00407 <span class="comment">/*++</span>
00408 <span class="comment"></span>
00409 <span class="comment">Routine Description:</span>
00410 <span class="comment"></span>
00411 <span class="comment">    This routine will deallocate the Lbcb.  If we need one for the look-aside</span>
00412 <span class="comment">    list we will put it there.</span>
00413 <span class="comment"></span>
00414 <span class="comment">Arguments:</span>
00415 <span class="comment"></span>
00416 <span class="comment">    Lfcb - Supplies a pointer to the log file control block.</span>
00417 <span class="comment"></span>
00418 <span class="comment">    Lbcb - This is the Lbcb to deallocate.</span>
00419 <span class="comment"></span>
00420 <span class="comment">Return Value:</span>
00421 <span class="comment"></span>
00422 <span class="comment">    None</span>
00423 <span class="comment"></span>
00424 <span class="comment">--*/</span>
00425 
00426 {
00427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">//  Deallocate any restart area attached to this Lbcb.</span>
00431     <span class="comment">//</span>
00432 
00433     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lbcb-&gt;LbcbFlags, <a class="code" href="../../d1/d4/lfsstruc_8h.html#a4">LBCB_RESTART_LBCB</a> ) &amp;&amp;
00434         (Lbcb-&gt;PageHeader != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00435 
00436         <a class="code" href="../../d0/d4/lfsprocs_8h.html#a19">LfsDeallocateRestartArea</a>( Lbcb-&gt;PageHeader );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">//  Put this in the Lbcb queue if it is short.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (Lfcb-&gt;SpareLbcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a16">LFCB_MAX_LBCB_COUNT</a>) {
00444 
00445         InsertHeadList( &amp;Lfcb-&gt;SpareLbcbList, (PLIST_ENTRY) Lbcb );
00446         Lfcb-&gt;SpareLbcbCount += 1;
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">//  Otherwise just free the pool block.</span>
00450     <span class="comment">//</span>
00451 
00452     } <span class="keywordflow">else</span> {
00453 
00454         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lbcb );
00455     }
00456 
00457     <span class="keywordflow">return</span>;
00458 }
00459 
00460 
00461 
00462 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00463"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a5">00463</a> <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a5">LfsAllocateLcb</a> (
00464     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00465     OUT <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> *NewLcb
00466     )
00467 <span class="comment">/*++</span>
00468 <span class="comment"></span>
00469 <span class="comment">Routine Description:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    This routine will allocate an Lcb. If the pool fails we will fall back</span>
00472 <span class="comment">    on our spare list. A failure then will result in an exception</span>
00473 <span class="comment">    </span>
00474 <span class="comment">Arguments:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    Lfcb - Supplies a pointer to the log file control block.</span>
00477 <span class="comment"></span>
00478 <span class="comment">    Lcb - This will contain the new lcb </span>
00479 <span class="comment"></span>
00480 <span class="comment">Return Value:</span>
00481 <span class="comment"></span>
00482 <span class="comment">    None</span>
00483 <span class="comment"></span>
00484 <span class="comment">--*/</span>
00485 {
00486 
00487     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00488     
00489     <span class="keywordflow">try</span> {
00490         
00491         *NewLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00492         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a17">LFCB_RESERVE_LCB_COUNT</a>) {                   
00493             (*NewLcb) = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), ' sfL' );  
00494         }
00495         
00496         <span class="keywordflow">if</span> ((*NewLcb) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                                                   
00497             <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &gt; 0) {                                    
00498                 *NewLcb = (<a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a>) Lfcb-&gt;SpareLcbList.Flink;                     
00499                 Lfcb-&gt;SpareLcbCount -= 1;                                     
00500                 RemoveHeadList( &amp;Lfcb-&gt;SpareLcbList );                        
00501             } <span class="keywordflow">else</span> {                                                           
00502                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INSUFFICIENT_RESOURCES );                 
00503             }                                                                   
00504         }                                                                       
00505         
00506         RtlZeroMemory( (*NewLcb), <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) );                      
00507         (*NewLcb)-&gt;NodeTypeCode = <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a1">LFS_NTC_LCB</a>;                         
00508         (*NewLcb)-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d4/lfsstruc_8h.html#a25">LCB</a> );                       
00509     
00510     } finally {
00511         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00512     }
00513 }
00514 
00515 
00516 
00517 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00518"></a><a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">00518</a> <a class="code" href="../../d8/d7/lfs_2strucsup_8c.html#a6">LfsDeallocateLcb</a> (
00519     IN <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb,
00520     IN <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb
00521     )
00522 <span class="comment">/*++</span>
00523 <span class="comment"></span>
00524 <span class="comment">Routine Description:</span>
00525 <span class="comment"></span>
00526 <span class="comment">    This routine will deallocate an Lcb. We'll cache the old lcb if there</span>
00527 <span class="comment">    aren't too many already on the spare list</span>
00528 <span class="comment">    </span>
00529 <span class="comment">Arguments:</span>
00530 <span class="comment"></span>
00531 <span class="comment">    Lfcb - Supplies a pointer to the log file control block.</span>
00532 <span class="comment"></span>
00533 <span class="comment">    Lcb - This will contain the lcb to release</span>
00534 <span class="comment"></span>
00535 <span class="comment">Return Value:</span>
00536 <span class="comment"></span>
00537 <span class="comment">    None</span>
00538 <span class="comment"></span>
00539 <span class="comment">--*/</span>
00540 
00541 {
00542     <span class="keywordflow">if</span> (Lcb-&gt;RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                               
00543         <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( Lcb-&gt;RecordHeaderBcb );                          
00544     }                                                                   
00545     <span class="keywordflow">if</span> ((Lcb-&gt;CurrentLogRecord != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; Lcb-&gt;AuxilaryBuffer) {                             
00546         <a class="code" href="../../d6/d5/logpgsup_8c.html#a4">LfsFreeSpanningBuffer</a>( Lcb-&gt;CurrentLogRecord );                          
00547     }                                                                   
00548 
00549     ExAcquireFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );
00550 
00551     <span class="keywordflow">try</span> {
00552         <span class="keywordflow">if</span> (Lfcb-&gt;SpareLcbCount &lt; <a class="code" href="../../d1/d4/lfsstruc_8h.html#a18">LFCB_MAX_LCB_COUNT</a>) {                   
00553             InsertHeadList( &amp;Lfcb-&gt;SpareLcbList, (PLIST_ENTRY) Lcb );   
00554             Lfcb-&gt;SpareLcbCount += 1;                                     
00555         } <span class="keywordflow">else</span> {                                                            
00556             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lcb );                                              
00557         }                                                                   
00558     } finally {
00559         ExReleaseFastMutex( &amp;(Lfcb-&gt;Sync-&gt;SpareListMutex) );    
00560     }
00561 }
00562 
00563 
00564 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:53 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
