<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cleanup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cleanup.c</h1><a href="../../d8/d7/udfs_2cleanup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Cleanup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Cleanup routine for Udfs called by the</span>
00012 <span class="comment">    dispatch driver.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     31-Oct-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d8/d7/udfs_2cleanup_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_CLEANUP)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d8/d7/udfs_2cleanup_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_CLEANUP)</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonCleanup)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span>
00040 
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00042"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a251">00042</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a> (
00043     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00044     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00045     )
00046 
00047 <span class="comment">/*++</span>
00048 <span class="comment"></span>
00049 <span class="comment">Routine Description:</span>
00050 <span class="comment"></span>
00051 <span class="comment">    This is the common routine for cleanup of a file/directory called by both</span>
00052 <span class="comment">    the fsd and fsp threads.</span>
00053 <span class="comment"></span>
00054 <span class="comment">    Cleanup is invoked whenever the last handle to a file object is closed.</span>
00055 <span class="comment">    This is different than the Close operation which is invoked when the last</span>
00056 <span class="comment">    reference to a file object is deleted.</span>
00057 <span class="comment"></span>
00058 <span class="comment">    The function of cleanup is to essentially "cleanup" the file/directory</span>
00059 <span class="comment">    after a user is done with it.  The Fcb/Dcb remains around (because MM</span>
00060 <span class="comment">    still has the file object referenced) but is now available for another</span>
00061 <span class="comment">    user to open (i.e., as far as the user is concerned the is now closed).</span>
00062 <span class="comment"></span>
00063 <span class="comment">    See close for a more complete description of what close does.</span>
00064 <span class="comment"></span>
00065 <span class="comment">    We do no synchronization in this routine until we get to the point</span>
00066 <span class="comment">    where we modify the counts, share access and volume lock field.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    We need to update the Fcb and Vcb to show that a user handle has been closed.</span>
00069 <span class="comment">    The following structures and fields are affected.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    Vcb:</span>
00072 <span class="comment"></span>
00073 <span class="comment">        VolumeLockFileObject - Did the user lock the volume with this file object.</span>
00074 <span class="comment">        VcbState - Check if we are unlocking the volume here.</span>
00075 <span class="comment">        VcbCleanup - Count of outstanding handles on the volume.</span>
00076 <span class="comment">        DirNotifyQueue - If this file object has pending DirNotify Irps.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Fcb:</span>
00079 <span class="comment"></span>
00080 <span class="comment">        ShareAccess - If this is a user handle.</span>
00081 <span class="comment">        FcbCleanup - Count of outstanding handles on this Fcb.</span>
00082 <span class="comment">        Oplock - Any outstanding oplocks on this file object.</span>
00083 <span class="comment">        FileLock - Any outstanding filelocks on this file object.</span>
00084 <span class="comment"></span>
00085 <span class="comment">Arguments:</span>
00086 <span class="comment"></span>
00087 <span class="comment">    Irp - Supplies the Irp to process</span>
00088 <span class="comment"></span>
00089 <span class="comment">Return Value:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    NTSTATUS - The return status for the operation.</span>
00092 <span class="comment"></span>
00093 <span class="comment">--*/</span>
00094 
00095 {
00096     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00097     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00098 
00099     BOOLEAN SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00100     BOOLEAN AttemptTeardown;
00101 
00102     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00103     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00104     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00105 
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00109     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  If we were called with our file system device object instead of a</span>
00113     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00117 
00118         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00119         <span class="keywordflow">return</span> STATUS_SUCCESS;
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  Get the file object out of the Irp and decode the type of open.</span>
00124     <span class="comment">//</span>
00125 
00126     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject;
00127 
00128     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject,
00129                                       &amp;Fcb,
00130                                       &amp;Ccb );
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  No work here for either an UnopenedFile object or a StreamFileObject.</span>
00134     <span class="comment">//</span>
00135 
00136     <span class="keywordflow">if</span> (TypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>) {
00137 
00138         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00139 
00140         <span class="keywordflow">return</span> STATUS_SUCCESS;
00141     }
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">//  Keep a local pointer to the Vcb.</span>
00145     <span class="comment">//</span>
00146 
00147     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Acquire the current file.</span>
00151     <span class="comment">//</span>
00152 
00153     <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, Fcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00157     <span class="comment">//</span>
00158 
00159     <span class="keywordflow">try</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">//  Set the flag in the FileObject to indicate that cleanup is complete.</span>
00163         <span class="comment">//</span>
00164 
00165         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, <a class="code" href="../../d0/d5/io_8h.html#a164">FO_CLEANUP_COMPLETE</a> );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Case on the type of open that we are trying to cleanup.</span>
00169         <span class="comment">//</span>
00170 
00171         <span class="keywordflow">switch</span> (TypeOfOpen) {
00172 
00173         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>:
00174 
00175             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00176                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x DIR\n"</span>,
00177                          Fcb,
00178                          FileObject ));
00179             
00180             <span class="comment">//</span>
00181             <span class="comment">//  Check if we need to complete any dir notify Irps on this file object.</span>
00182             <span class="comment">//</span>
00183 
00184             <a class="code" href="../../d1/d8/fsrtl_8h.html#a175">FsRtlNotifyCleanup</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o29">NotifySync</a>,
00185                                 &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o30">DirNotifyList</a>,
00186                                 Ccb );
00187 
00188             <span class="keywordflow">break</span>;
00189 
00190         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>:
00191 
00192             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00193                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x FILE\n"</span>,
00194                          Fcb,
00195                          FileObject ));
00196             
00197             <span class="comment">//</span>
00198             <span class="comment">//  Coordinate the cleanup operation with the oplock state.</span>
00199             <span class="comment">//  Oplock cleanup operations can always cleanup immediately so no</span>
00200             <span class="comment">//  need to check for STATUS_PENDING.</span>
00201             <span class="comment">//</span>
00202 
00203             <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00204                               <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>,
00205                               IrpContext,
00206                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00207                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">//  Unlock all outstanding file locks.</span>
00211             <span class="comment">//</span>
00212 
00213             <span class="keywordflow">if</span> (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214 
00215                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( Fcb-&gt;FileLock,
00216                                     FileObject,
00217                                     <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> ),
00218                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00219             }
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Cleanup the cache map.</span>
00223             <span class="comment">//</span>
00224 
00225             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  Check the fast io state.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00232             Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00233             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00234 
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a> :
00238 
00239             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00240                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x VOL\n"</span>,
00241                          Fcb,
00242                          FileObject ));
00243 
00244             <span class="keywordflow">break</span>;
00245 
00246         <span class="keywordflow">default</span> :
00247 
00248             <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( TypeOfOpen, 0, 0 );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Now lock the Vcb in order to modify the fields in the in-memory</span>
00253         <span class="comment">//  structures.</span>
00254         <span class="comment">//</span>
00255 
00256         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">//  Decrement the cleanup counts in the Vcb and Fcb.</span>
00260         <span class="comment">//</span>
00261 
00262         <a class="code" href="../../d3/d8/udfprocs_8h.html#a97">UdfDecrementCleanupCounts</a>( IrpContext, Fcb );
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">//  If the cleanup count hit zero and the volume is not mounted, we</span>
00266         <span class="comment">//  will want to try to spark teardown.</span>
00267         <span class="comment">//</span>
00268 
00269         AttemptTeardown = (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0 &amp;&amp; Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>);
00270         
00271         <span class="comment">//</span>
00272         <span class="comment">//  If this file object has locked the volume then perform the unlock operation.</span>
00273         <span class="comment">//</span>
00274 
00275         <span class="keywordflow">if</span> (FileObject == Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a>) {
00276 
00277             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a5">VCB_STATE_LOCKED</a> );
00278             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00279             SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280         }
00281 
00282         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We must clean up the share access at this time, since we may not</span>
00286         <span class="comment">//  get a Close call for awhile if the file was mapped through this</span>
00287         <span class="comment">//  File Object.</span>
00288         <span class="comment">//</span>
00289 
00290         <a class="code" href="../../d4/d6/iosubs_8c.html#a103">IoRemoveShareAccess</a>( FileObject, &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a> );
00291 
00292     } finally {
00293 
00294         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, Fcb );
00295 
00296         <span class="keywordflow">if</span> (SendUnlockNotification) {
00297 
00298             <a class="code" href="../../d1/d8/fsrtl_8h.html#a168">FsRtlNotifyVolumeEvent</a>( FileObject, <a class="code" href="../../d1/d8/fsrtl_8h.html#a43">FSRTL_VOLUME_UNLOCK</a> );
00299         }
00300     }
00301 
00302     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00303                  <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x -&gt; SUCCESS\n"</span>,
00304                  Fcb,
00305                  FileObject ));
00306     
00307     <span class="comment">//</span>
00308     <span class="comment">//  If appropriate, try to spark teardown by purging the volume.  Should</span>
00309     <span class="comment">//  this very fileobject we were cleaning up be the last reason for the</span>
00310     <span class="comment">//  volume to remain, teardown will commence on completion of this Irp.</span>
00311     <span class="comment">//</span>
00312     
00313     <span class="keywordflow">if</span> (AttemptTeardown) {
00314 
00315         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00316 
00317         <span class="keywordflow">try</span> {
00318             
00319             <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00320 
00321         } finally {
00322 
00323             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00324         }
00325     }
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">//  If this is a normal termination then complete the request</span>
00329     <span class="comment">//</span>
00330 
00331     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00332 
00333     <span class="keywordflow">return</span> STATUS_SUCCESS;
00334 }
00335 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
