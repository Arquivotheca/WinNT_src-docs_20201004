<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: reader.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>reader.c</h1><a href="../../d8/d5/reader_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: reader.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Implements support reader-mode routines for auto-scrolling and panning.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 31-Jan-1997   vadimg    created</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d8/d5/reader_8c.html#a0">00015</a> <span class="preprocessor">#define TIMERID 1</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d8/d5/reader_8c.html#a3">00017</a> __inline <a class="code" href="../../d8/d5/reader_8c.html#a3">FReader2Dim</a>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr)
00018 {
00019     <span class="keywordflow">return</span> ((prdr-&gt;dwFlags &amp; (<a class="code" href="../../d6/d0/usercli_8h.html#a285">RDRMODE_HORZ</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a284">RDRMODE_VERT</a>)) == 
00020             (<a class="code" href="../../d6/d0/usercli_8h.html#a285">RDRMODE_HORZ</a> | <a class="code" href="../../d6/d0/usercli_8h.html#a284">RDRMODE_VERT</a>));
00021 }
<a name="l00022"></a><a class="code" href="../../d8/d5/reader_8c.html#a4">00022</a> __inline <a class="code" href="../../d8/d5/reader_8c.html#a4">FReaderVert</a>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr)
00023 {
00024     <span class="keywordflow">return</span> (prdr-&gt;dwFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a284">RDRMODE_VERT</a>);
00025 }
<a name="l00026"></a><a class="code" href="../../d8/d5/reader_8c.html#a5">00026</a> __inline <a class="code" href="../../d8/d5/reader_8c.html#a5">FReaderHorz</a>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr)
00027 {
00028     <span class="keywordflow">return</span> (prdr-&gt;dwFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a285">RDRMODE_HORZ</a>);
00029 }
<a name="l00030"></a><a class="code" href="../../d8/d5/reader_8c.html#a6">00030</a> __inline <a class="code" href="../../d8/d5/reader_8c.html#a6">FReaderDiag</a>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr)
00031 {
00032     <span class="keywordflow">return</span> (prdr-&gt;dwFlags &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a286">RDRMODE_DIAG</a>);
00033 }
00034 
00035 <span class="comment">/***************************************************************************\</span>
00036 <span class="comment">* ReaderSetCursor</span>
00037 <span class="comment">*</span>
00038 <span class="comment">\***************************************************************************/</span>
00039 
<a name="l00040"></a><a class="code" href="../../d8/d5/reader_8c.html#a7">00040</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d5/reader_8c.html#a7">ReaderSetCursor</a>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr, UINT uCursor)
00041 {
00042     <span class="keywordflow">if</span> (prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o3">uCursor</a> != uCursor) {
00043         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a224">NtUserSetCursor</a>(LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, MAKEINTRESOURCE(uCursor)));
00044         prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o3">uCursor</a> = uCursor;
00045     }
00046 }
00047 
00048 <span class="comment">/***************************************************************************\</span>
00049 <span class="comment">* ReaderMouseMove</span>
00050 <span class="comment">*</span>
00051 <span class="comment">* Calculate dx and dy based on the flags passed in.  Provide visual </span>
00052 <span class="comment">* feedback for the reader mode by setting the correct cursor.</span>
00053 <span class="comment">*</span>
00054 <span class="comment">* 2-Feb-1997   vadimg   created</span>
00055 <span class="comment">\***************************************************************************/</span>
00056 
<a name="l00057"></a><a class="code" href="../../d8/d5/reader_8c.html#a8">00057</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d5/reader_8c.html#a8">ReaderMouseMove</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr, LPARAM lParam)
00058 {
00059     <span class="keywordtype">int</span> dx = 0, dy = 0;
00060     LPRECT prc = &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00061     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uCursor;
00062     POINT pt = {<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam), <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam)};
00063     
00064     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(pwnd, &amp;pt);
00065 
00066     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a4">FReaderVert</a>(prdr)) {
00067         <span class="keywordflow">if</span> (pt.y &lt; prc-&gt;top) {
00068             dy = pt.y - prc-&gt;top;
00069         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pt.y &gt; prc-&gt;bottom) {
00070             dy = pt.y - prc-&gt;bottom;
00071         }
00072     }
00073 
00074     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a5">FReaderHorz</a>(prdr)) {
00075         <span class="keywordflow">if</span> (pt.x &lt; prc-&gt;left) {
00076             dx = pt.x - prc-&gt;left;
00077         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pt.x &gt; prc-&gt;right) {
00078             dx = pt.x - prc-&gt;right;
00079         }
00080     }
00081     
00082     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a3">FReader2Dim</a>(prdr)) {
00083         <span class="keywordflow">if</span> (dx == 0 &amp;&amp; dy == 0) {
00084             <a class="code" href="../../d8/d5/reader_8c.html#a7">ReaderSetCursor</a>(prdr, OCR_RDR2DIM);
00085             <span class="keywordflow">goto</span> Exit;
00086         }
00087         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/reader_8c.html#a6">FReaderDiag</a>(prdr)) {
00088             <span class="keywordflow">if</span> (prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o2">dy</a> != 0) {
00089                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(dx) &gt; <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o2">dy</a>)) {
00090                     dy = 0;
00091                 } <span class="keywordflow">else</span> {
00092                     dx = 0;
00093                 }
00094             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o1">dx</a> != 0) {
00095                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(dy) &gt; <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o1">dx</a>)) {
00096                     dx = 0;
00097                 } <span class="keywordflow">else</span> {
00098                     dy = 0;
00099                 }
00100             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dy != 0) {
00101                 dx = 0;
00102             }
00103         }
00104     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a4">FReaderVert</a>(prdr) &amp;&amp; dy == 0) {
00105         <a class="code" href="../../d8/d5/reader_8c.html#a7">ReaderSetCursor</a>(prdr, OCR_RDRVERT);
00106         <span class="keywordflow">goto</span> Exit;
00107     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a5">FReaderHorz</a>(prdr) &amp;&amp; dx == 0) {
00108         <a class="code" href="../../d8/d5/reader_8c.html#a7">ReaderSetCursor</a>(prdr, OCR_RDRHORZ);
00109         <span class="keywordflow">goto</span> Exit;
00110     }
00111 
00112     <span class="keywordflow">if</span> (dx == 0) {
00113         uCursor = (dy &gt; 0) ? OCR_RDRSOUTH : OCR_RDRNORTH;
00114     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dx &gt; 0) {
00115         <span class="keywordflow">if</span> (dy == 0) {
00116             uCursor = OCR_RDREAST;
00117         } <span class="keywordflow">else</span> {
00118             uCursor = (dy &gt; 0) ? OCR_RDRSOUTHEAST : OCR_RDRNORTHEAST;
00119         }
00120     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dx &lt; 0) {
00121         <span class="keywordflow">if</span> (dy == 0) {
00122             uCursor = OCR_RDRWEST;
00123         } <span class="keywordflow">else</span> {
00124             uCursor = (dy &gt; 0) ? OCR_RDRSOUTHWEST : OCR_RDRNORTHWEST;
00125         }
00126     }
00127 
00128     <a class="code" href="../../d8/d5/reader_8c.html#a7">ReaderSetCursor</a>(prdr, uCursor);
00129 
00130 Exit:
00131     prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o1">dx</a> = dx;
00132     prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o2">dy</a> = dy;
00133 }
00134 
00135 <span class="comment">/***************************************************************************\</span>
00136 <span class="comment">* ReaderFeedback</span>
00137 <span class="comment">*</span>
00138 <span class="comment">* 2-Feb-1997   vadimg   created</span>
00139 <span class="comment">\***************************************************************************/</span>
00140 
<a name="l00141"></a><a class="code" href="../../d8/d5/reader_8c.html#a9">00141</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d5/reader_8c.html#a9">ReaderFeedback</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr)
00142 {
00143     <span class="keywordflow">if</span> (prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o1">dx</a> == 0 &amp;&amp; prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o2">dy</a> == 0)
00144         <span class="keywordflow">return</span>;
00145 
00146     <span class="keywordflow">if</span> (prdr-&gt;pfnReaderModeProc(prdr-&gt;lParam, <a class="code" href="../../d6/d0/usercli_8h.html#a288">RDRCODE_SCROLL</a>, 
00147             prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o1">dx</a>, prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o2">dy</a>) == 0) {
00148         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a448">PtoH</a>(pwnd));
00149     }
00150 }
00151 
00152 <span class="comment">/***************************************************************************\</span>
00153 <span class="comment">* ReaderWndProc</span>
00154 <span class="comment">*</span>
00155 <span class="comment">* 31-Jan-1997   vadimg   created</span>
00156 <span class="comment">\***************************************************************************/</span>
00157 
<a name="l00158"></a><a class="code" href="../../d8/d5/reader_8c.html#a10">00158</a> LRESULT CALLBACK <a class="code" href="../../d8/d5/reader_8c.html#a10">ReaderWndProc</a>(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)
00159 {
00160     HDC hdc, hdcMem;
00161     HPEN hpen, hpenOld;
00162     HBRUSH hbrOld;
00163     HRGN hrgn;
00164     RECT rc;
00165     POINT pt;
00166     <span class="keywordtype">int</span> nBitmap, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00167     <a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a> prdr;
00168     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00169     LPCREATESTRUCT <a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a>;
00170     <a class="code" href="../../d0/d5/structtagREADERMODE.html">PREADERMODE</a> prdrm;
00171     BITMAP bmp;
00172 
00173     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00174         <span class="keywordflow">return</span> 0;
00175 
00176     prdr = ((<a class="code" href="../../d1/d5/structtagREADERWND.html">PREADERWND</a>)pwnd)-&gt;prdr;
00177 
00178     <span class="keywordflow">switch</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00179     <span class="keywordflow">case</span> WM_TIMER:
00180         <a class="code" href="../../d8/d5/reader_8c.html#a9">ReaderFeedback</a>(pwnd, prdr);
00181         <span class="keywordflow">return</span> 0;
00182 
00183     <span class="keywordflow">case</span> WM_MOUSEWHEEL:
00184     <span class="keywordflow">case</span> WM_LBUTTONUP:
00185     <span class="keywordflow">case</span> WM_RBUTTONUP:
00186     <span class="keywordflow">case</span> WM_XBUTTONUP:
00187     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00188     <span class="keywordflow">case</span> WM_RBUTTONDOWN:
00189     <span class="keywordflow">case</span> WM_MBUTTONDOWN:
00190     <span class="keywordflow">case</span> WM_XBUTTONDOWN:
00191     <span class="keywordflow">case</span> WM_KEYDOWN:
00192         <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
00193         <span class="keywordflow">return</span> 0;
00194 
00195     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00196         <a class="code" href="../../d8/d5/reader_8c.html#a8">ReaderMouseMove</a>(pwnd, prdr, lParam);
00197         <span class="keywordflow">return</span> 0;
00198 
00199     <span class="keywordflow">case</span> WM_MBUTTONUP:
00200         pt.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a7">GET_X_LPARAM</a>(lParam);
00201         pt.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a8">GET_Y_LPARAM</a>(lParam);
00202         <a class="code" href="../../d3/d9/client_2wow_8c.html#a24">GetClientRect</a>(hwnd, &amp;rc);
00203         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rc, pt)) {
00204             <a class="code" href="../../d3/d8/client_8c.html#a124">ReleaseCapture</a>();
00205         }
00206         <span class="keywordflow">return</span> 0;
00207 
00208     <span class="keywordflow">case</span> WM_CAPTURECHANGED:
00209         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a159">NtUserDestroyWindow</a>(hwnd);
00210         <span class="keywordflow">return</span> 0;
00211 
00212     <span class="keywordflow">case</span> WM_NCDESTROY:
00213         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a208">NtUserKillTimer</a>(hwnd, <a class="code" href="../../d8/d5/reader_8c.html#a0">TIMERID</a>);
00214         
00215         prdr-&gt;pfnReaderModeProc(prdr-&gt;lParam, <a class="code" href="../../d6/d0/usercli_8h.html#a289">RDRCODE_END</a>, 0, 0);
00216         
00217         <span class="keywordflow">if</span> (prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o4">hbm</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00218             DeleteObject(prdr-&gt;<a class="code" href="../../d9/d4/structtagREADERINFO.html#o4">hbm</a>);
00219         }
00220         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(prdr);
00221         <span class="keywordflow">return</span> 0;
00222 
00223     <span class="keywordflow">case</span> WM_CREATE:
00224         <span class="keywordflow">if</span> ((prdr = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">READERINFO</a>))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00225             <span class="keywordflow">return</span> -1;
00226 
00227         <a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a> = (LPCREATESTRUCT)lParam;
00228         prdrm = (<a class="code" href="../../d0/d5/structtagREADERMODE.html">PREADERMODE</a>)<a class="code" href="../../d7/d3/monitor_8c.html#a2">pcs</a>-&gt;lpCreateParams;
00229         RtlCopyMemory(prdr, prdrm, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/structtagREADERMODE.html">READERMODE</a>));
00230         <a class="code" href="../../d5/d9/cltxt_8h.html#a12">SetWindowLongPtr</a>(hwnd, 0, (LONG_PTR)prdr);
00231 
00232         <span class="keywordflow">if</span> (prdr-&gt;pfnReaderModeProc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00233             <span class="keywordflow">return</span> -1;
00234         }
00235 
00236         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a3">FReader2Dim</a>(prdr)) {
00237             nBitmap = OBM_RDR2DIM;
00238         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a4">FReaderVert</a>(prdr)) {
00239             nBitmap = OBM_RDRVERT;
00240         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a5">FReaderHorz</a>(prdr)) {
00241             nBitmap = OBM_RDRHORZ;
00242         } <span class="keywordflow">else</span> {
00243             <span class="keywordflow">return</span> -1;
00244         }
00245 
00246         SetWindowLong(hwnd, GWL_EXSTYLE, WS_EX_TOOLWINDOW);
00247         SetWindowLong(hwnd, GWL_STYLE, WS_POPUP | WS_CLIPSIBLINGS);
00248 
00249         prdr-&gt;hbm = LoadBitmap(<a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, MAKEINTRESOURCE(nBitmap));
00250         <span class="keywordflow">if</span> (prdr-&gt;hbm == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || 
00251                 GetObject(prdr-&gt;hbm, <span class="keyword">sizeof</span>(BITMAP), &amp;bmp) == 0) {
00252             <span class="keywordflow">return</span> -1;
00253         }
00254 
00255         <span class="keywordflow">if</span> (prdr-&gt;pfnReaderModeProc(prdr-&gt;lParam, <a class="code" href="../../d6/d0/usercli_8h.html#a287">RDRCODE_START</a>, 0, 0) == 0) {
00256             <span class="keywordflow">return</span> -1;
00257         }
00258 
00259         prdr-&gt;dxBmp = bmp.bmWidth;
00260         prdr-&gt;dyBmp = bmp.bmHeight;
00261 
00262         cx = bmp.bmWidth + 1;
00263         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = bmp.bmHeight + 1;
00264 
00265         <a class="code" href="../../d3/d9/client_2wow_8c.html#a25">GetCursorPos</a>(&amp;pt);
00266         pt.x -= cx/2;
00267         pt.y -= <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>/2;
00268 
00269         <span class="keywordflow">if</span> ((hrgn = CreateEllipticRgn(0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00270             <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(hwnd, hrgn, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00271         }
00272 
00273         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a115">NtUserSetWindowPos</a>(hwnd, HWND_TOPMOST, pt.x, pt.y, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00274                 SWP_SHOWWINDOW | SWP_NOACTIVATE);
00275 
00276         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a221">NtUserSetCapture</a>(hwnd);
00277         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a225">NtUserSetFocus</a>(hwnd);
00278         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a230">NtUserSetTimer</a>(hwnd, <a class="code" href="../../d8/d5/reader_8c.html#a0">TIMERID</a>, 10, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00279         <span class="keywordflow">return</span> 0;
00280 
00281     <span class="keywordflow">case</span> WM_ERASEBKGND:
00282         hdc = (HDC)wParam;
00283     
00284         <span class="keywordflow">if</span> ((hdcMem = CreateCompatibleDC(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00285             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00286 
00287         SelectObject(hdcMem, prdr-&gt;hbm);
00288         hpen = CreatePen(PS_SOLID, 1, RGB(0, 0, 0));
00289         hpenOld = (HPEN)SelectObject(hdc, hpen);
00290         hbrOld = (HBRUSH)SelectObject(hdc, GetStockObject(NULL_BRUSH));
00291         
00292         BitBlt(hdc, 0, 0, prdr-&gt;dxBmp, prdr-&gt;dyBmp, hdcMem, 0, 0, SRCCOPY);
00293         Ellipse(hdc, 0, 0, prdr-&gt;dxBmp, prdr-&gt;dyBmp);
00294         
00295         SelectObject(hdc, hpenOld);
00296         SelectObject(hdc, hbrOld);
00297 
00298         DeleteObject(hpen);
00299         DeleteObject(hdcMem);
00300         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00301     }
00302 
00303     <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/cltxt_8h.html#a15">DefWindowProc</a>(hwnd, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, wParam, lParam);
00304 }
00305 
00306 <span class="comment">/***************************************************************************\</span>
00307 <span class="comment">* ReaderProcInternal</span>
00308 <span class="comment">*</span>
00309 <span class="comment">\***************************************************************************/</span>
00310 
<a name="l00311"></a><a class="code" href="../../d8/d5/reader_8c.html#a11">00311</a> LONG <a class="code" href="../../d8/d5/reader_8c.html#a11">ReaderProcInternal</a>(LPARAM lParam, <span class="keywordtype">int</span> nCode, <span class="keywordtype">int</span> dx, <span class="keywordtype">int</span> dy)
00312 {
00313     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDelay;
00314     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uMsg, uCode;
00315     <span class="keywordtype">int</span> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, nAbs;
00316 
00317     <span class="keywordflow">if</span> (nCode != <a class="code" href="../../d6/d0/usercli_8h.html#a288">RDRCODE_SCROLL</a>)
00318         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00319 
00320     <span class="keywordflow">if</span> (dy != 0) {
00321         uCode = SB_LINEUP;
00322         uMsg = WM_VSCROLL;
00323         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = dy;
00324     } <span class="keywordflow">else</span> {
00325         uCode = SB_LINELEFT;
00326         uMsg = WM_HSCROLL;
00327         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = dx;
00328     }
00329 
00330     nAbs = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>);
00331     <span class="keywordflow">if</span> (nAbs &gt;= 120) {
00332         uCode += 2;
00333         dwDelay = 0;
00334     } <span class="keywordflow">else</span> {
00335         dwDelay = 1000 - (nAbs / 2) * 15;
00336     }
00337 
00338     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &gt; 0) {
00339         uCode += 1;
00340     }
00341 
00342     <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>((HWND)lParam, uMsg, MAKELONG(uCode, dwDelay), 0);
00343     <a class="code" href="../../d3/d8/client_8c.html#a140">UpdateWindow</a>((HWND)lParam);
00344     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00345 }
00346 
00347 <span class="comment">/***************************************************************************\</span>
00348 <span class="comment">* EnterReaderMode</span>
00349 <span class="comment">*</span>
00350 <span class="comment">\***************************************************************************/</span>
00351 
<a name="l00352"></a><a class="code" href="../../d8/d5/reader_8c.html#a1">00352</a> <span class="preprocessor">#define READERCLASS L"User32_ReaderMode"</span>
<a name="l00353"></a><a class="code" href="../../d8/d5/reader_8c.html#a2">00353</a> <span class="preprocessor"></span>ATOM <a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a32">gatomReaderMode</a> = 0;
00354 
<a name="l00355"></a><a class="code" href="../../d8/d5/reader_8c.html#a12">00355</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d5/reader_8c.html#a12">EnterReaderMode</a>(<a class="code" href="../../d0/d5/structtagREADERMODE.html">PREADERMODE</a> prdrm)
00356 {
00357     WNDCLASSEX wce;
00358 
00359     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/winmgrc_8c.html#a12">GetCapture</a>() != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00360         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00361 
00362     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a32">gatomReaderMode</a> == 0) {
00363         wce.cbSize = <span class="keyword">sizeof</span>(wce);
00364         wce.style = CS_DBLCLKS | CS_HREDRAW | CS_VREDRAW;
00365         wce.lpfnWndProc = <a class="code" href="../../d8/d5/reader_8c.html#a10">ReaderWndProc</a>;
00366         wce.cbClsExtra = 0;
00367         wce.cbWndExtra = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/structtagREADERINFO.html">PREADERINFO</a>);
00368         wce.hInstance = <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>;
00369         wce.hIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00370         wce.hCursor = LoadCursor(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, IDC_ARROW);
00371         wce.hbrBackground = GetStockObject(WHITE_BRUSH);
00372         wce.lpszMenuName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00373         wce.lpszClassName = <a class="code" href="../../d8/d5/reader_8c.html#a1">READERCLASS</a>;
00374         wce.hIconSm = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00375 
00376         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d6/ntuser_2client_2globals_8h.html#a32">gatomReaderMode</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a636">RegisterClassExWOWW</a>(&amp;wce, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a225">FNID_DDE_BIT</a>)) == 0) {
00377             RIPMSG0(RIP_WARNING, <span class="stringliteral">"EnterReaderMode: failed to register ReaderMode"</span>);
00378             <span class="keywordflow">return</span> 0;
00379         }
00380     }
00381 
00382     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a624">_CreateWindowEx</a>(0, <a class="code" href="../../d8/d5/reader_8c.html#a1">READERCLASS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, 0, 0, 0,
00383             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a6">hmodUser</a>, (PVOID)prdrm, 0) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00384 }
00385 
00386 <span class="comment">/***************************************************************************\</span>
00387 <span class="comment">* FScrollEnabled</span>
00388 <span class="comment">*</span>
00389 <span class="comment">\***************************************************************************/</span>
00390 
<a name="l00391"></a><a class="code" href="../../d8/d5/reader_8c.html#a13">00391</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d5/reader_8c.html#a13">FScrollEnabled</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fVert)
00392 {
00393     <a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a> pw;
00394     <span class="keywordtype">int</span> nFlags;
00395 
00396     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, fVert ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a551">WFVPRESENT</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a552">WFHPRESENT</a>))
00397         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00398 
00399     <span class="keywordflow">if</span> ((pw = (<a class="code" href="../../d5/d5/structtagSBINFO.html">PSBINFO</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a24">REBASEALWAYS</a>(pwnd, pSBInfo)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00400         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00401 
00402     nFlags = fVert ? (pw-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o0">WSBflags</a> &gt;&gt; 2) : pw-&gt;<a class="code" href="../../d5/d5/structtagSBINFO.html#o0">WSBflags</a>;
00403 
00404     <span class="keywordflow">if</span> ((nFlags &amp; SB_DISABLE_MASK) == SB_DISABLE_MASK)
00405         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00406 
00407     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00408 }
00409 
00410 <span class="comment">/***************************************************************************\</span>
00411 <span class="comment">* EnterReaderModeHelper</span>
00412 <span class="comment">*</span>
00413 <span class="comment">\***************************************************************************/</span>
00414 
<a name="l00415"></a><a class="code" href="../../d6/d0/usercli_8h.html#a782">00415</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a782">EnterReaderModeHelper</a>(HWND hwnd)
00416 {
00417     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00418     <a class="code" href="../../d0/d5/structtagREADERMODE.html">READERMODE</a> rdrm;
00419 
00420     rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o0">cbSize</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/structtagREADERMODE.html">READERMODE</a>);
00421     rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o2">pfnReaderModeProc</a> = <a class="code" href="../../d8/d5/reader_8c.html#a11">ReaderProcInternal</a>;
00422     rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o3">lParam</a> = (LPARAM)hwnd;
00423     rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o1">dwFlags</a> = 0;
00424 
00425     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a13">FScrollEnabled</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00426         rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o1">dwFlags</a> |= <a class="code" href="../../d6/d0/usercli_8h.html#a284">RDRMODE_VERT</a>;
00427     }
00428     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/reader_8c.html#a13">FScrollEnabled</a>(pwnd, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00429         rdrm.<a class="code" href="../../d0/d5/structtagREADERMODE.html#o1">dwFlags</a> |= <a class="code" href="../../d6/d0/usercli_8h.html#a285">RDRMODE_HORZ</a>;
00430     }
00431 
00432     <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/reader_8c.html#a12">EnterReaderMode</a>(&amp;rdrm);
00433 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
