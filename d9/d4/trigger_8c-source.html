<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: trigger.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>trigger.c</h1><a href="../../d8/d5/trigger_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1993  Digital Equipment Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    trigger.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements functions that handle synchronous and asynchronous</span>
00012 <span class="comment">    arithmetic exceptions. The Alpha SRM specifies certain code generation</span>
00013 <span class="comment">    rules which if followed allow this code (in conjunction with internal</span>
00014 <span class="comment">    processor register state) to effect a precise, synchronous exception</span>
00015 <span class="comment">    given an imprecise, asynchronous exception. This capability is required</span>
00016 <span class="comment">    for software emulation of the IEEE single and double floating operations.</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Thomas Van Baak (tvb) 5-Mar-1993</span>
00021 <span class="comment"></span>
00022 <span class="comment">Environment:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Kernel mode only.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00031 <span class="preprocessor">#pragma hdrstop</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include "alphaops.h"</span>
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Define forward referenced function prototypes.</span>
00036 <span class="comment">//</span>
00037 
00038 BOOLEAN
00039 <a class="code" href="../../d8/d5/trigger_8c.html#a10">KiLocateTriggerPc</a> (
00040     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00041     IN OUT PKTRAP_FRAME TrapFrame
00042     );
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">// Define debugging macros.</span>
00046 <span class="comment">//</span>
00047 
00048 <span class="preprocessor">#if DBG</span>
00049 <span class="preprocessor"></span>
00050 <span class="keyword">extern</span> ULONG RtlDebugFlags;
00051 <span class="preprocessor">#define DBGPRINT ((RtlDebugFlags &amp; 0x4) != 0) &amp;&amp; DbgPrint</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#else</span>
00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="../../d8/d5/trigger_8c.html#a0">00055</a> <span class="preprocessor">#define DBGPRINT 0 &amp;&amp; DbgPrint</span>
00056 <span class="preprocessor"></span>
00057 <span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 <span class="comment">//</span>
00060 <span class="comment">// Define non-IEEE (a/k/a `high performance') arithmetic exception types.</span>
00061 <span class="comment">// The PALcode exception record is extended by one word and the 4th word</span>
00062 <span class="comment">// contains the reason the arithmetic exception is not an IEEE exception.</span>
00063 <span class="comment">//</span>
00064 
<a name="l00065"></a><a class="code" href="../../d8/d5/trigger_8c.html#a1">00065</a> <span class="preprocessor">#define NON_IEEE(ExceptionRecord, Reason) \</span>
00066 <span class="preprocessor">    (ExceptionRecord)-&gt;NumberParameters = 4; \</span>
00067 <span class="preprocessor">    (ExceptionRecord)-&gt;ExceptionInformation[3] = (Reason);</span>
00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d8/d5/trigger_8c.html#a2">00069</a> <span class="preprocessor">#define TRIGGER_FLOATING_REGISTER_MASK_CLEAR 1</span>
<a name="l00070"></a><a class="code" href="../../d8/d5/trigger_8c.html#a3">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_INTEGER_REGISTER_MASK_SET 2</span>
<a name="l00071"></a><a class="code" href="../../d8/d5/trigger_8c.html#a4">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_NO_SOFTWARE_COMPLETION 3</span>
<a name="l00072"></a><a class="code" href="../../d8/d5/trigger_8c.html#a5">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_INVALID_INSTRUCTION_FOUND 4</span>
<a name="l00073"></a><a class="code" href="../../d8/d5/trigger_8c.html#a6">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_INSTRUCTION_FETCH_ERROR 5</span>
<a name="l00074"></a><a class="code" href="../../d8/d5/trigger_8c.html#a7">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_INSTRUCTION_NOT_FOUND 6</span>
<a name="l00075"></a><a class="code" href="../../d8/d5/trigger_8c.html#a8">00075</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_SOURCE_IS_DESTINATION 7</span>
<a name="l00076"></a><a class="code" href="../../d8/d5/trigger_8c.html#a9">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define TRIGGER_WRONG_INSTRUCTION 8</span>
00077 <span class="preprocessor"></span>
00078 BOOLEAN
<a name="l00079"></a><a class="code" href="../../d8/d5/trigger_8c.html#a11">00079</a> <a class="code" href="../../d8/d5/trigger_8c.html#a11">KiFloatingException</a> (
00080     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00081     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00082     IN OUT PKTRAP_FRAME TrapFrame,
00083     IN BOOLEAN ImpreciseTrap,
00084     IN OUT PULONG SoftFpcrCopy
00085     )
00086 
00087 <span class="comment">/*++</span>
00088 <span class="comment"></span>
00089 <span class="comment">Routine Description:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    This function is called to emulate a floating operation and convert the</span>
00092 <span class="comment">    exception status to the proper value. If the exception is a fault, the</span>
00093 <span class="comment">    faulting floating point instruction is emulated. If the exception is an</span>
00094 <span class="comment">    imprecise trap, an attempt is made to locate and to emulate the original</span>
00095 <span class="comment">    trapping floating point instruction.</span>
00096 <span class="comment"></span>
00097 <span class="comment">Arguments:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00100 <span class="comment"></span>
00101 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00104 <span class="comment"></span>
00105 <span class="comment">    ImpreciseTrap - Supplies a boolean value that specifies whether the</span>
00106 <span class="comment">        exception is an imprecise trap.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    SoftFpcrCopy - Supplies a pointer to a longword variable that receives</span>
00109 <span class="comment">        a copy of the software FPCR.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    A value of TRUE is returned if the floating exception is successfully</span>
00114 <span class="comment">    emulated. Otherwise, a value of FALSE is returned.</span>
00115 <span class="comment"></span>
00116 <span class="comment">--*/</span>
00117 
00118 {
00119 
00120     BOOLEAN <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00121     PSW_FPCR SoftwareFpcr;
00122     PTEB Teb;
00123 
00124     <span class="keywordflow">try</span> {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Obtain a copy of the software FPCR longword from the TEB.</span>
00128         <span class="comment">//</span>
00129 
00130         Teb = NtCurrentTeb();
00131         *SoftFpcrCopy = Teb-&gt;FpSoftwareStatusRegister;
00132         SoftwareFpcr = (PSW_FPCR)SoftFpcrCopy;
00133         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: SoftFpcr = %.8lx\n"</span>, *SoftFpcrCopy);
00134 
00135 <span class="preprocessor">#if DBG</span>
00136 <span class="preprocessor"></span>        <span class="comment">//</span>
00137         <span class="comment">// If the floating emulation inhibit flag is set, then bypass all</span>
00138         <span class="comment">// software emulation by the kernel and return FALSE to raise the</span>
00139         <span class="comment">// original PALcode exception.</span>
00140         <span class="comment">//</span>
00141         <span class="comment">// N.B. This is for user-mode development and testing and is not</span>
00142         <span class="comment">//      part of the API.</span>
00143         <span class="comment">//</span>
00144 
00145         <span class="keywordflow">if</span> (SoftwareFpcr-&gt;NoSoftwareEmulation != 0) {
00146             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: NoSoftwareEmulation\n"</span>);
00147             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00148         }
00149 <span class="preprocessor">#endif</span>
00150 <span class="preprocessor"></span>
00151         <span class="comment">//</span>
00152         <span class="comment">// If the arithmetic exception is an imprecise trap, the address of</span>
00153         <span class="comment">// the trapping instruction is somewhere before the exception address.</span>
00154         <span class="comment">//</span>
00155         <span class="comment">// Otherwise the exception is a fault and the address of the faulting</span>
00156         <span class="comment">// instruction is the exception address.</span>
00157         <span class="comment">//</span>
00158 
00159         <span class="keywordflow">if</span> (ImpreciseTrap != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00160 
00161             <span class="comment">//</span>
00162             <span class="comment">// If the arithmetic trap ignore mode is enabled, then do not</span>
00163             <span class="comment">// spend time to locate or to emulate the trapping instruction,</span>
00164             <span class="comment">// leave unpredictable results in the destination register, do</span>
00165             <span class="comment">// not set correct IEEE sticky bits in the software FPCR, leave</span>
00166             <span class="comment">// the hardware FPCR sticky status bits as they are, and return</span>
00167             <span class="comment">// TRUE to continue execution. It is assumed that user code will</span>
00168             <span class="comment">// check the hardware FPCR exception status bits to determine if</span>
00169             <span class="comment">// the instruction succeeded or not (Insignia SoftPc feature).</span>
00170             <span class="comment">//</span>
00171 
00172             <span class="keywordflow">if</span> (SoftwareFpcr-&gt;ArithmeticTrapIgnore != 0) {
00173                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00174             }
00175 
00176             <span class="comment">//</span>
00177             <span class="comment">// Attempt to locate the trapping instruction. If the instruction</span>
00178             <span class="comment">// stream is such that this is not possible or was not intended,</span>
00179             <span class="comment">// then set an exception code that best reflects the exception</span>
00180             <span class="comment">// summary register bits and return FALSE to raise the exception.</span>
00181             <span class="comment">//</span>
00182             <span class="comment">// Otherwise emulate the trigger instruction in order to compute</span>
00183             <span class="comment">// the correct destination result value, the correct IEEE status</span>
00184             <span class="comment">// bits, and raise any enabled IEEE exceptions.</span>
00185             <span class="comment">//</span>
00186 
00187             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/trigger_8c.html#a10">KiLocateTriggerPc</a>(ExceptionRecord, TrapFrame) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00188                 <a class="code" href="../../d8/d5/trigger_8c.html#a12">KiSetFloatingStatus</a>(ExceptionRecord);
00189                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00190             }
00191             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d4/mips_2floatem_8c.html#a32">KiEmulateFloating</a>(ExceptionRecord,
00192                                        ExceptionFrame,
00193                                        TrapFrame,
00194                                        SoftwareFpcr);
00195 
00196         } <span class="keywordflow">else</span> {
00197 
00198             <span class="comment">//</span>
00199             <span class="comment">// Attempt to emulate the faulting instruction in order to perform</span>
00200             <span class="comment">// floating operations not supported by EV4, to compute the correct</span>
00201             <span class="comment">// destination result value, the correct IEEE status bits, and</span>
00202             <span class="comment">// raise any enabled IEEE exceptions.</span>
00203             <span class="comment">//</span>
00204 
00205             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d4/mips_2floatem_8c.html#a32">KiEmulateFloating</a>(ExceptionRecord,
00206                                        ExceptionFrame,
00207                                        TrapFrame,
00208                                        SoftwareFpcr);
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">// If the emulation resulted in a floating point exception and</span>
00212             <span class="comment">// the arithmetic trap ignore mode is enabled, then set the return</span>
00213             <span class="comment">// value to TRUE to suppress the exception and continue execution.</span>
00214             <span class="comment">//</span>
00215 
00216             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00217                 (SoftwareFpcr-&gt;ArithmeticTrapIgnore != 0) &amp;&amp;
00218                 (ExceptionRecord-&gt;ExceptionCode != STATUS_ILLEGAL_INSTRUCTION)) {
00219                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00220             }
00221         }
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">// Store the updated software FPCR longword in the TEB.</span>
00225         <span class="comment">//</span>
00226 
00227         Teb-&gt;FpSoftwareStatusRegister = *SoftFpcrCopy;
00228         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiFloatingException: SoftFpcr = %.8lx\n"</span>, *SoftFpcrCopy);
00229 
00230     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00231 
00232         <span class="comment">//</span>
00233         <span class="comment">// An exception occurred accessing the TEB.</span>
00234         <span class="comment">//</span>
00235 
00236         ExceptionRecord-&gt;ExceptionCode = GetExceptionCode();
00237         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     }
00239 
00240     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00241 }
00242 
00243 BOOLEAN
<a name="l00244"></a><a class="code" href="../../d8/d5/trigger_8c.html#a10">00244</a> <a class="code" href="../../d8/d5/trigger_8c.html#a10">KiLocateTriggerPc</a> (
00245     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00246     IN OUT PKTRAP_FRAME TrapFrame
00247     )
00248 
00249 <span class="comment">/*++</span>
00250 <span class="comment"></span>
00251 <span class="comment">Routine Description:</span>
00252 <span class="comment"></span>
00253 <span class="comment">    This function is called to try to determine the precise location of the</span>
00254 <span class="comment">    instruction that caused an arithmetic exception. The instruction that</span>
00255 <span class="comment">    caused the trap to occur is known as the trigger instruction. On entry,</span>
00256 <span class="comment">    the actual address of the trigger instruction is unknown and the exception</span>
00257 <span class="comment">    address is the continuation address. The continuation address is the</span>
00258 <span class="comment">    address of the instruction that would have executed had the trap not</span>
00259 <span class="comment">    occurred. The instructions following the trigger instruction up to the</span>
00260 <span class="comment">    continuation address are known as the trap shadow of the trigger</span>
00261 <span class="comment">    instruction.</span>
00262 <span class="comment"></span>
00263 <span class="comment">    Alpha AXP produces imprecise, asynchronous arithmetic exceptions. The</span>
00264 <span class="comment">    exceptions are imprecise because the exception address when a trap is</span>
00265 <span class="comment">    taken may be more than one instruction beyond the address of the</span>
00266 <span class="comment">    instruction that actually caused the trap to occur.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    The arithmetic exceptions are traps (rather than faults) because the</span>
00269 <span class="comment">    exception address is not the address of the trapping instruction</span>
00270 <span class="comment">    itself, but the address of the next instruction to execute, which is</span>
00271 <span class="comment">    always (at least) one instruction beyond the address of the trapping</span>
00272 <span class="comment">    instruction.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    It is possible for multiple exceptions to occur and result in a single</span>
00275 <span class="comment">    trap. This function only determines the address of the first trapping</span>
00276 <span class="comment">    instruction.</span>
00277 <span class="comment"></span>
00278 <span class="comment">    Unpredictable values may have been stored in the destination register</span>
00279 <span class="comment">    of trapping instructions. Thus to insure that the trigger instruction</span>
00280 <span class="comment">    can be located, and that the trigger instruction and any instructions</span>
00281 <span class="comment">    in the trap shadow can be re-executed, certain restrictions are placed</span>
00282 <span class="comment">    on the type of instructions or the mix of operands in the trap shadow.</span>
00283 <span class="comment"></span>
00284 <span class="comment">    The code generation rules serve only to guarantee that the instruction</span>
00285 <span class="comment">    backup algorithm and subsequent re-execution can always be successful.</span>
00286 <span class="comment">    Hence the restrictions on such constructs as branches, jumps, and the</span>
00287 <span class="comment">    re-use of source or destination operands within the trap shadow.</span>
00288 <span class="comment"></span>
00289 <span class="comment">Arguments:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00292 <span class="comment"></span>
00293 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00294 <span class="comment"></span>
00295 <span class="comment">Return Value:</span>
00296 <span class="comment"></span>
00297 <span class="comment">    If the trigger PC was precisely determined, the exception address in</span>
00298 <span class="comment">    the exception record is set to the trigger PC, the continuation address</span>
00299 <span class="comment">    in the trap frame is updated, and a value of TRUE is returned. Otherwise</span>
00300 <span class="comment">    no values are stored and a value of FALSE is returned.</span>
00301 <span class="comment"></span>
00302 <span class="comment">--*/</span>
00303 
00304 {
00305 
00306     PEXC_SUM ExceptionSummary;
00307     ULONG Fa;
00308     ULONG Fb;
00309     ULONG Fc;
00310     ULONG FloatRegisterTrashMask;
00311     ULONG FloatRegisterWriteMask;
00312     ALPHA_INSTRUCTION Instruction;
00313     ULONG IntegerRegisterWriteMask;
00314     ULONG Opcode;
00315     ULONG_PTR TrapShadowLowLimit;
00316     ULONG_PTR TriggerPc;
00317     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00318 
00319     <span class="comment">//</span>
00320     <span class="comment">// Obtain a copy of the float and integer register write mask registers</span>
00321     <span class="comment">// and the exception summary register from the exception record built by</span>
00322     <span class="comment">// PALcode.</span>
00323     <span class="comment">//</span>
00324 
00325     FloatRegisterWriteMask = (ULONG)ExceptionRecord-&gt;ExceptionInformation[0];
00326     IntegerRegisterWriteMask = (ULONG)ExceptionRecord-&gt;ExceptionInformation[1];
00327     ExceptionSummary = (PEXC_SUM)&amp;(ExceptionRecord-&gt;ExceptionInformation[2]);
00328     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: WriteMask %.8lx.%.8lx, ExceptionSummary %.8lx\n"</span>,
00329              FloatRegisterWriteMask, IntegerRegisterWriteMask,
00330              *(PULONG)ExceptionSummary);
00331 
00332     <span class="comment">//</span>
00333     <span class="comment">// Capture previous mode from trap frame not current thread.</span>
00334     <span class="comment">//</span>
00335 
00336     PreviousMode = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(((<a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> *)(&amp;TrapFrame-&gt;Psr))-&gt;MODE);
00337 
00338     <span class="keywordflow">if</span> (FloatRegisterWriteMask == 0) {
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// It should not be possible to have a floating point exception without</span>
00342         <span class="comment">// at least one of the destination float register bits set. The trap</span>
00343         <span class="comment">// shadow is invalid.</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: FloatRegisterWriteMask clear\n"</span>);
00347         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a2">TRIGGER_FLOATING_REGISTER_MASK_CLEAR</a>);
00348         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349     }
00350     <span class="keywordflow">if</span> (IntegerRegisterWriteMask != 0) {
00351 
00352         <span class="comment">//</span>
00353         <span class="comment">// It is not possible to precisely locate the trigger instruction</span>
00354         <span class="comment">// when the integer overflow bit is set. The trap shadow is invalid.</span>
00355         <span class="comment">//</span>
00356 
00357         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: IntegerRegisterMask set.\n"</span>);
00358         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a3">TRIGGER_INTEGER_REGISTER_MASK_SET</a>);
00359         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00360     }
00361     <span class="keywordflow">if</span> (ExceptionSummary-&gt;SoftwareCompletion == 0) {
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">// The exception summary software completion bit is the AND of the</span>
00365         <span class="comment">// /S bits of all trapping instructions in the trap shadow. Since</span>
00366         <span class="comment">// the software completion bit is not set, it can be assumed the</span>
00367         <span class="comment">// code that was executing does not want precise exceptions, or if</span>
00368         <span class="comment">// it does, the code does not comply with the Alpha AXP guidelines</span>
00369         <span class="comment">// for locating the trigger PC. The trap shadow is invalid.</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: SoftwareCompletion clear\n"</span>);
00373         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a4">TRIGGER_NO_SOFTWARE_COMPLETION</a>);
00374         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00375     }
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Search for the trigger instruction starting with the instruction before</span>
00379     <span class="comment">// the continuation PC (the instruction pointed to by Fir either did not</span>
00380     <span class="comment">// complete or did not even start). Limit the search to the arbitrary</span>
00381     <span class="comment">// limit of N instructions back from the current PC to prevent unbounded</span>
00382     <span class="comment">// searches. The search is complete when all trapping destination register</span>
00383     <span class="comment">// bits in the float write mask register have been accounted for.</span>
00384     <span class="comment">//</span>
00385 
00386     FloatRegisterTrashMask = 0;
00387     TriggerPc = (ULONG_PTR)TrapFrame-&gt;Fir;
00388     TrapShadowLowLimit = TriggerPc - (500 * <span class="keyword">sizeof</span>(ULONG));
00389 
00390     <span class="keywordflow">try</span> {
00391         <span class="keywordflow">do</span> {
00392             TriggerPc -= 4;
00393             <span class="keywordflow">if</span> (TriggerPc &lt; TrapShadowLowLimit) {
00394 
00395                 <span class="comment">//</span>
00396                 <span class="comment">// The trigger PC is too far away from the exception PC to</span>
00397                 <span class="comment">// be reasonable. The trap shadow is invalid.</span>
00398                 <span class="comment">//</span>
00399 
00400                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trap shadow too long\n"</span>);
00401                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a7">TRIGGER_INSTRUCTION_NOT_FOUND</a>);
00402                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00403             }
00404 
00405             <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00406                 Instruction.Long = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>((PULONG)TriggerPc);
00407             } <span class="keywordflow">else</span> {
00408                 Instruction.Long = *((PULONG)TriggerPc);
00409             }
00410 
00411             <span class="comment">//</span>
00412             <span class="comment">// Examine the opcode of this instruction to determine if the</span>
00413             <span class="comment">// trap shadow is invalid.</span>
00414             <span class="comment">//</span>
00415 
00416             Opcode = Instruction.Memory.Opcode;
00417             <span class="keywordflow">if</span> (Opcode == JMP_OP) {
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">// This is one of the jump instructions: jump, return, or</span>
00421                 <span class="comment">// either form of jsr. The trap shadow is invalid.</span>
00422                 <span class="comment">//</span>
00423 
00424                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Jump within Trap Shadow\n"</span>);
00425                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a5">TRIGGER_INVALID_INSTRUCTION_FOUND</a>);
00426                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00427 
00428             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Opcode &gt;= BR_OP) &amp;&amp; (Opcode &lt;= BGT_OP)) {
00429 
00430                 <span class="comment">//</span>
00431                 <span class="comment">// The instruction is one of 16 branch opcodes that consists</span>
00432                 <span class="comment">// of BR, the 6 floating point branch, BSR, and the 8 integer</span>
00433                 <span class="comment">// branch instructions. The trap shadow is invalid.</span>
00434                 <span class="comment">//</span>
00435 
00436                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Branch within Trap Shadow\n"</span>);
00437                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a5">TRIGGER_INVALID_INSTRUCTION_FOUND</a>);
00438                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00439 
00440             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Instruction.Memory.Opcode == MEMSPC_OP) &amp;&amp;
00441                 ((Instruction.Memory.MemDisp == TRAPB_FUNC) ||
00442                  (Instruction.Memory.MemDisp == EXCB_FUNC))) {
00443 
00444                 <span class="comment">//</span>
00445                 <span class="comment">// The instruction is a type of TRAPB instruction. The trap</span>
00446                 <span class="comment">// shadow is invalid.</span>
00447                 <span class="comment">//</span>
00448 
00449                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trapb within Trap Shadow\n"</span>);
00450                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a5">TRIGGER_INVALID_INSTRUCTION_FOUND</a>);
00451                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00452 
00453             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Opcode == CALLPAL_OP) {
00454 
00455                 <span class="comment">//</span>
00456                 <span class="comment">// The instruction is a Call PAL. The trap shadow is invalid.</span>
00457                 <span class="comment">//</span>
00458 
00459                 <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Call PAL within Trap Shadow\n"</span>);
00460                 <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a5">TRIGGER_INVALID_INSTRUCTION_FOUND</a>);
00461                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00462 
00463             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Opcode == IEEEFP_OP) || (Opcode == FPOP_OP)) {
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// The instruction is an IEEE floating point instruction.</span>
00467                 <span class="comment">// Decode the destination register of the floating point</span>
00468                 <span class="comment">// instruction in order to check against the register mask.</span>
00469                 <span class="comment">//</span>
00470 
00471                 Fc = Instruction.FpOp.Fc;
00472                 <span class="keywordflow">if</span> (Fc != FZERO_REG) {
00473                     FloatRegisterTrashMask |= (1 &lt;&lt; Fc);
00474                 }
00475                 FloatRegisterWriteMask &amp;= ~(1 &lt;&lt; Fc);
00476             }
00477 
00478         } <span class="keywordflow">while</span> (FloatRegisterWriteMask != 0);
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// If the instruction thought to be the trigger instruction does not</span>
00482         <span class="comment">// have the /S bit set, then the trap shadow is invalid (some other</span>
00483         <span class="comment">// instruction must have caused software completion bit to be set).</span>
00484         <span class="comment">//</span>
00485 
00486         <span class="keywordflow">if</span> ((Instruction.FpOp.Function &amp; FP_TRAP_ENABLE_S) == 0) {
00487             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Trigger instruction missing /S\n"</span>);
00488             <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a9">TRIGGER_WRONG_INSTRUCTION</a>);
00489             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00490         }
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">// If either of the operand registers of the trigger instruction is</span>
00494         <span class="comment">// also the destination register of the trigger instruction or any</span>
00495         <span class="comment">// instruction in the trap shadow, then the trap shadow in invalid.</span>
00496         <span class="comment">// This is because the original value of the operand register(s) may</span>
00497         <span class="comment">// have been destroyed making it impossible to re-execute the trigger</span>
00498         <span class="comment">// instruction.</span>
00499         <span class="comment">//</span>
00500 
00501         Fa = Instruction.FpOp.Fa;
00502         Fb = Instruction.FpOp.Fb;
00503         <span class="keywordflow">if</span> ((FloatRegisterTrashMask &amp; ((1 &lt;&lt; Fa) | (1 &lt;&lt; Fb))) != 0) {
00504             <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Source is destination\n"</span>);
00505             <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a8">TRIGGER_SOURCE_IS_DESTINATION</a>);
00506             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00507         }
00508 
00509     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">// An exception occurred while fetching the value of the</span>
00513         <span class="comment">// next previous instruction. The trap shadow is invalid.</span>
00514         <span class="comment">//</span>
00515 
00516         <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Instruction fetch error\n"</span>);
00517         <a class="code" href="../../d8/d5/trigger_8c.html#a1">NON_IEEE</a>(ExceptionRecord, <a class="code" href="../../d8/d5/trigger_8c.html#a6">TRIGGER_INSTRUCTION_FETCH_ERROR</a>);
00518         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519     }
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">// The trigger instruction was successfully located. Set the precise</span>
00523     <span class="comment">// exception address in the exception record, set the new continuation</span>
00524     <span class="comment">// address in the trap frame, and return a value of TRUE.</span>
00525     <span class="comment">//</span>
00526 
00527     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiLocateTriggerPc: Exception PC = %p, Trigger PC = %p\n"</span>,
00528              ExceptionRecord-&gt;ExceptionAddress, TriggerPc);
00529     ExceptionRecord-&gt;ExceptionAddress = (PVOID)TriggerPc;
00530     TrapFrame-&gt;Fir = (ULONGLONG)(LONG_PTR)(TriggerPc + 4);
00531     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00532 }
00533 
00534 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00535"></a><a class="code" href="../../d8/d5/trigger_8c.html#a12">00535</a> <a class="code" href="../../d8/d5/trigger_8c.html#a12">KiSetFloatingStatus</a> (
00536     IN OUT PEXCEPTION_RECORD ExceptionRecord
00537     )
00538 
00539 <span class="comment">/*++</span>
00540 <span class="comment"></span>
00541 <span class="comment">Routine Description:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    This function is called to convert the exception summary register bits</span>
00544 <span class="comment">    into a status code value.</span>
00545 <span class="comment"></span>
00546 <span class="comment">Arguments:</span>
00547 <span class="comment"></span>
00548 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00549 <span class="comment"></span>
00550 <span class="comment">Return Value:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    None.</span>
00553 <span class="comment"></span>
00554 <span class="comment">--*/</span>
00555 
00556 {
00557 
00558     PEXC_SUM ExceptionSummary;
00559 
00560     <span class="comment">//</span>
00561     <span class="comment">// Perform the following triage on the exception summary register to</span>
00562     <span class="comment">// report the type of exception, even if though the PC reported is</span>
00563     <span class="comment">// imprecise.</span>
00564     <span class="comment">//</span>
00565 
00566     <a class="code" href="../../d6/d5/ioep_8h.html#a21">DBGPRINT</a>(<span class="stringliteral">"KiSetFloatingStatus: ExceptionSummary = %.8lx\n"</span>,
00567              ExceptionRecord-&gt;ExceptionInformation[2]);
00568 
00569     ExceptionSummary = (PEXC_SUM)(&amp;ExceptionRecord-&gt;ExceptionInformation[2]);
00570     <span class="keywordflow">if</span> (ExceptionSummary-&gt;InvalidOperation != 0) {
00571         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00572 
00573     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;DivisionByZero != 0) {
00574         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00575 
00576     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;Overflow != 0) {
00577         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00578 
00579     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;Underflow != 0) {
00580         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00581 
00582     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;InexactResult != 0) {
00583         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00584 
00585     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionSummary-&gt;IntegerOverflow != 0) {
00586         ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_OVERFLOW;
00587 
00588     } <span class="keywordflow">else</span> {
00589         ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_STACK_CHECK;
00590     }
00591 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
