<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: alignrec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>alignrec.c</h1><a href="../../d8/d5/alignrec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: mergerec.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Contains all the code to reposition rectangles</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* NOTES:</span>
00009 <span class="comment">*</span>
00010 <span class="comment">* History:</span>
00011 <span class="comment">*</span>
00012 <span class="comment">\**************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d1/d4/w32_2ntuser_2rtl_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a0">00017</a> <span class="preprocessor">#define MONITORS_MAX 10</span>
00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a1">00019</a> <span class="preprocessor">#define RectCenterX(prc)    ((prc)-&gt;left+((prc)-&gt;right-(prc)-&gt;left)/2)</span>
<a name="l00020"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a2">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define RectCenterY(prc)    ((prc)-&gt;top+((prc)-&gt;bottom-(prc)-&gt;top)/2)</span>
00021 <span class="preprocessor"></span>
00022 <span class="comment">// ----------------------------------------------------------------------------</span>
00023 <span class="comment">//</span>
00024 <span class="comment">//  INTERSECTION_AXIS()</span>
00025 <span class="comment">//      This macro tells us how a particular set of overlapping rectangles</span>
00026 <span class="comment">//  should be adjusted to remove the overlap.  It is basically a condensed</span>
00027 <span class="comment">//  version of a lookup table that does the same job.  The parameters for the</span>
00028 <span class="comment">//  macro are two rectangles, where one is the intersection of the other with</span>
00029 <span class="comment">//  a third (unspecified) rectangle.  The macro compares the edges of the</span>
00030 <span class="comment">//  rectangles to determine which sides of the intersection were "caused" by</span>
00031 <span class="comment">//  the source rectangle.  In the pre-condensed version of this macro, the</span>
00032 <span class="comment">//  results of these comparisons (4 bits) would be used to index into a 16</span>
00033 <span class="comment">//  entry table which specifies the way to resolve the overlap.  However, this</span>
00034 <span class="comment">//  is highly redundant, as the table would actually represents several rotated</span>
00035 <span class="comment">//  and/or inverted instances of a few basic relationships:</span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Horizontal Vertical  Diagonal  Contained       Crossing</span>
00038 <span class="comment">//      *--*    *-----*   *---*     *-----*         *----*</span>
00039 <span class="comment">//   *--+* |    | *-* |   | *-+-*   | *-* |       *-+----+-*</span>
00040 <span class="comment">//   |  || |    *-+-+-*   | | | |   | | | |  and  | |    | |</span>
00041 <span class="comment">//   *--+* |      | |     *-+-* |   | *-* |       *-+----+-*</span>
00042 <span class="comment">//      *--*      *-*       *---*   *-----*         *----*</span>
00043 <span class="comment">//</span>
00044 <span class="comment">//  What we are really interested in determining is whether we "should" move</span>
00045 <span class="comment">//  the rectangles horizontally or vertically to resolve the overlap, hence we</span>
00046 <span class="comment">//  are testing for three states: Horizontal, Vertical and Don't Know.</span>
00047 <span class="comment">//</span>
00048 <span class="comment">//  The macro gives us these three states by XORing the high and low bits of</span>
00049 <span class="comment">//  of the comparison to reduce the table to 4 cases where 1 and 2 are</span>
00050 <span class="comment">//  vertical and horizontal respectively, and then subtracting 1 so that the</span>
00051 <span class="comment">//  2 bit signifies "unknown-ness."</span>
00052 <span class="comment">//</span>
00053 <span class="comment">//  Note that there are some one-off cases in the comparisons because we are</span>
00054 <span class="comment">//  not actually looking at the third rectangle.  However this greatly reduces</span>
00055 <span class="comment">//  the complexity so these small errors are acceptible given the scale of the</span>
00056 <span class="comment">//  rectangles we are comparing.</span>
00057 <span class="comment">//</span>
00058 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00059"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a3">00059</a> <span class="preprocessor">#define INTERSECTION_AXIS(a, b) \</span>
00060 <span class="preprocessor">    (((((a-&gt;left == b-&gt;left) &lt;&lt; 1) | (a-&gt;top == b-&gt;top)) ^ \</span>
00061 <span class="preprocessor">    (((a-&gt;right == b-&gt;right) &lt;&lt; 1) | (a-&gt;bottom == b-&gt;bottom))) - 1)</span>
00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a4">00063</a> <span class="preprocessor">#define INTERSECTION_AXIS_VERTICAL      (0)</span>
<a name="l00064"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a5">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define INTERSECTION_AXIS_HORIZONTAL    (1)</span>
<a name="l00065"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a6">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define INTERSECTION_AXIS_UNKNOWN(code) (code &amp; 2)</span>
00066 <span class="preprocessor"></span>
00067 <span class="comment">// ----------------------------------------------------------------------------</span>
00068 <span class="comment">//</span>
00069 <span class="comment">//  CenterRectangles()</span>
00070 <span class="comment">//      Move all the rectangles so their origin is the center of their union.</span>
00071 <span class="comment">//</span>
00072 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00073"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a7">00073</a> <span class="keywordtype">void</span> NEAR PASCAL <a class="code" href="../../d8/d5/alignrec_8c.html#a7">CenterRectangles</a>(LPRECT arc, UINT count)
00074 {
00075     LPRECT lprc, lprcL;
00076     RECT rcUnion;
00077 
00078     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcUnion, arc);
00079 
00080     lprcL = arc + count;
00081     <span class="keywordflow">for</span> (lprc = arc + 1; lprc &lt; lprcL; lprc++)
00082     {
00083         <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUnion, &amp;rcUnion, lprc);
00084     }
00085 
00086     <span class="keywordflow">for</span> (lprc = arc; count; count--)
00087     {
00088         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, -<a class="code" href="../../d8/d5/alignrec_8c.html#a1">RectCenterX</a>(&amp;rcUnion), -<a class="code" href="../../d8/d5/alignrec_8c.html#a2">RectCenterY</a>(&amp;rcUnion));
00089         lprc++;
00090     }
00091 }
00092 
00093 <span class="comment">// ----------------------------------------------------------------------------</span>
00094 <span class="comment">//</span>
00095 <span class="comment">//  RemoveOverlap()</span>
00096 <span class="comment">//    This is called from RemoveOverlaps to resolve conflicts when two</span>
00097 <span class="comment">//  rectangles overlap.  It returns the PMONITOR for the monitor it decided to</span>
00098 <span class="comment">//  move.  This routine always moves rectangles away from the origin so it can</span>
00099 <span class="comment">//  be used to converge on a zero-overlap configuration.</span>
00100 <span class="comment">//</span>
00101 <span class="comment">//  This function will bias slightly toward moving lprc2 (all other things</span>
00102 <span class="comment">//  being equal).</span>
00103 <span class="comment">//</span>
00104 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00105"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a8">00105</a> LPRECT NEAR PASCAL <a class="code" href="../../d8/d5/alignrec_8c.html#a8">RemoveOverlap</a>(LPRECT lprc1, LPRECT lprc2, LPRECT lprcI)
00106 {
00107     LPRECT lprcMove, lprcStay;
00108     POINT ptC1, ptC2;
00109     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNegative;
00110     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fC1Neg;
00111     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fC2Neg;
00112     <span class="keywordtype">int</span> dC1, dC2;
00113     <span class="keywordtype">int</span> xOffset;
00114     <span class="keywordtype">int</span> yOffset;
00115     <span class="keywordtype">int</span> nAxis;
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">// Compute the centers of both rectangles.  We will need them later.</span>
00119     <span class="comment">//</span>
00120     ptC1.x = <a class="code" href="../../d8/d5/alignrec_8c.html#a1">RectCenterX</a>(lprc1);
00121     ptC1.y = <a class="code" href="../../d8/d5/alignrec_8c.html#a2">RectCenterY</a>(lprc1);
00122     ptC2.x = <a class="code" href="../../d8/d5/alignrec_8c.html#a1">RectCenterX</a>(lprc2);
00123     ptC2.y = <a class="code" href="../../d8/d5/alignrec_8c.html#a2">RectCenterY</a>(lprc2);
00124 
00125     <span class="comment">//</span>
00126     <span class="comment">// Decide whether we should move things horizontally or vertically.  All</span>
00127     <span class="comment">// this goop is here so it will "feel" right when the system needs to</span>
00128     <span class="comment">// move a monitor on you.</span>
00129     <span class="comment">//</span>
00130     nAxis = <a class="code" href="../../d8/d5/alignrec_8c.html#a3">INTERSECTION_AXIS</a>(lprcI, lprc1);
00131 
00132     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/alignrec_8c.html#a6">INTERSECTION_AXIS_UNKNOWN</a>(nAxis))
00133     {
00134         <span class="comment">//</span>
00135         <span class="comment">// Is this a "big" intersection between the two rectangles?</span>
00136         <span class="comment">//</span>
00137         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(lprcI, ptC1) || <a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(lprcI, ptC2))
00138         {
00139             <span class="comment">//</span>
00140             <span class="comment">// This is a "big" overlap.  Decide if the rectangles</span>
00141             <span class="comment">// are aligned more "horizontal-ish" or "vertical-ish."</span>
00142             <span class="comment">//</span>
00143             xOffset = ptC1.x - ptC2.x;
00144             <span class="keywordflow">if</span> (xOffset &lt; 0)
00145                 xOffset *= -1;
00146             yOffset = ptC1.y - ptC2.y;
00147             <span class="keywordflow">if</span> (yOffset &lt; 0)
00148                 yOffset *= -1;
00149 
00150             <span class="keywordflow">if</span> (xOffset &gt;= yOffset)
00151                 nAxis = <a class="code" href="../../d8/d5/alignrec_8c.html#a5">INTERSECTION_AXIS_HORIZONTAL</a>;
00152             <span class="keywordflow">else</span>
00153                 nAxis = <a class="code" href="../../d8/d5/alignrec_8c.html#a4">INTERSECTION_AXIS_VERTICAL</a>;
00154         }
00155         <span class="keywordflow">else</span>
00156         {
00157             <span class="comment">//</span>
00158             <span class="comment">// This is a "small" overlap.  Move the rectangles the</span>
00159             <span class="comment">// smallest distance that will fix the overlap.</span>
00160             <span class="comment">//</span>
00161             <span class="keywordflow">if</span> ((lprcI-&gt;right - lprcI-&gt;left) &lt;= (lprcI-&gt;bottom - lprcI-&gt;top))
00162                 nAxis = <a class="code" href="../../d8/d5/alignrec_8c.html#a5">INTERSECTION_AXIS_HORIZONTAL</a>;
00163             <span class="keywordflow">else</span>
00164                 nAxis = <a class="code" href="../../d8/d5/alignrec_8c.html#a4">INTERSECTION_AXIS_VERTICAL</a>;
00165         }
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">// We now need to pick the rectangle to move.  Move the one</span>
00170     <span class="comment">// that is further from the origin along the axis of motion.</span>
00171     <span class="comment">//</span>
00172     <span class="keywordflow">if</span> (nAxis == <a class="code" href="../../d8/d5/alignrec_8c.html#a5">INTERSECTION_AXIS_HORIZONTAL</a>)
00173     {
00174         dC1 = ptC1.x;
00175         dC2 = ptC2.x;
00176     }
00177     <span class="keywordflow">else</span>
00178     {
00179         dC1 = ptC1.y;
00180         dC2 = ptC2.y;
00181     }
00182 
00183     <span class="keywordflow">if</span> ((fC1Neg = (dC1 &lt; 0)) != 0)
00184         dC1 *= -1;
00185 
00186     <span class="keywordflow">if</span> ((fC2Neg = (dC2 &lt; 0)) != 0)
00187         dC2 *= -1;
00188 
00189     <span class="keywordflow">if</span> (dC2 &lt; dC1)
00190     {
00191         lprcMove     = lprc1;
00192         lprcStay     = lprc2;
00193         fNegative    = fC1Neg;
00194     }
00195     <span class="keywordflow">else</span>
00196     {
00197         lprcMove     = lprc2;
00198         lprcStay     = lprc1;
00199         fNegative    = fC2Neg;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Compute a new home for the rectangle and put it there.</span>
00204     <span class="comment">//</span>
00205     <span class="keywordflow">if</span> (nAxis == <a class="code" href="../../d8/d5/alignrec_8c.html#a5">INTERSECTION_AXIS_HORIZONTAL</a>)
00206     {
00207         <span class="keywordtype">int</span> xPos;
00208 
00209         <span class="keywordflow">if</span> (fNegative)
00210             xPos = lprcStay-&gt;left - (lprcMove-&gt;right - lprcMove-&gt;left);
00211         <span class="keywordflow">else</span>
00212             xPos = lprcStay-&gt;right;
00213 
00214         xOffset = xPos - lprcMove-&gt;left;
00215         yOffset = 0;
00216     }
00217     <span class="keywordflow">else</span>
00218     {
00219         <span class="keywordtype">int</span> yPos;
00220 
00221         <span class="keywordflow">if</span> (fNegative)
00222             yPos = lprcStay-&gt;top - (lprcMove-&gt;bottom - lprcMove-&gt;top);
00223         <span class="keywordflow">else</span>
00224             yPos = lprcStay-&gt;bottom;
00225 
00226         yOffset = yPos - lprcMove-&gt;top;
00227         xOffset = 0;
00228     }
00229 
00230     <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcMove, xOffset, yOffset);
00231     <span class="keywordflow">return</span> lprcMove;
00232 }
00233 
00234 <span class="comment">// ----------------------------------------------------------------------------</span>
00235 <span class="comment">//</span>
00236 <span class="comment">//  RemoveOverlaps()</span>
00237 <span class="comment">//    This is called from CleanupDesktopRectangles make sure the monitor array</span>
00238 <span class="comment">//  is non-overlapping.</span>
00239 <span class="comment">//</span>
00240 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00241"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a9">00241</a> <span class="keywordtype">void</span> NEAR PASCAL <a class="code" href="../../d8/d5/alignrec_8c.html#a9">RemoveOverlaps</a>(LPRECT arc, UINT count)
00242 {
00243     LPRECT lprc1, lprc2, lprcL;
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Center the rectangles around a common origin.  We will move them outward</span>
00247     <span class="comment">// when there are conflicts so centering (a) reduces running time and</span>
00248     <span class="comment">// hence (b) reduces the chances of totally mangling the positions.</span>
00249     <span class="comment">//</span>
00250     <a class="code" href="../../d8/d5/alignrec_8c.html#a7">CenterRectangles</a>(arc, count);
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">// Now loop through the array fixing any overlaps.</span>
00254     <span class="comment">//</span>
00255     lprcL = arc + count;
00256     lprc2 = arc + 1;
00257 
00258 ReScan:
00259     <span class="keywordflow">while</span> (lprc2 &lt; lprcL)
00260     {
00261         <span class="comment">//</span>
00262         <span class="comment">// Scan all rectangles before this one looking for intersections.</span>
00263         <span class="comment">//</span>
00264         <span class="keywordflow">for</span> (lprc1 = arc; lprc1 &lt; lprc2; lprc1++)
00265         {
00266             RECT rcI;
00267 
00268             <span class="comment">//</span>
00269             <span class="comment">// Move one of the rectanges if there is an intersection.</span>
00270             <span class="comment">//</span>
00271             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcI, lprc1, lprc2))
00272             {
00273                 <span class="comment">//</span>
00274                 <span class="comment">// Move one of the rectangles out of the way and then restart</span>
00275                 <span class="comment">// the scan for overlaps with that rectangle (since moving it</span>
00276                 <span class="comment">// may have created new overlaps).</span>
00277                 <span class="comment">//</span>
00278                 lprc2 = <a class="code" href="../../d8/d5/alignrec_8c.html#a8">RemoveOverlap</a>(lprc1, lprc2, &amp;rcI);
00279                 <span class="keywordflow">goto</span> ReScan;
00280             }
00281         }
00282 
00283         lprc2++;
00284     }
00285 }
00286 
00287 <span class="comment">// ----------------------------------------------------------------------------</span>
00288 <span class="comment">//</span>
00289 <span class="comment">//  AddNextContiguousRectangle()</span>
00290 <span class="comment">//    This is called from RemoveGaps to find the next contiguous rectangle</span>
00291 <span class="comment">//  in the array.  If there are no more contiguous rectangles it picks the</span>
00292 <span class="comment">//  closest rectangle and moves it so it is contiguous.</span>
00293 <span class="comment">//</span>
00294 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00295"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a10">00295</a> LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> * NEAR PASCAL <a class="code" href="../../d8/d5/alignrec_8c.html#a10">AddNextContiguousRectangle</a>(LPRECT FAR *aprc,
00296     LPRECT FAR *pprcSplit, UINT count)
00297 {
00298     LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcL;
00299     LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcTest;
00300     LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcAxis;
00301     LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcDiag;
00302     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> dAxis = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00303     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> dDiag = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00304     POINT dpAxis;
00305     POINT dpDiag;
00306     POINT dpMove;
00307 
00308     pprcL = aprc + count;
00309 
00310     <span class="keywordflow">for</span> (pprcTest = aprc; pprcTest &lt; pprcSplit; pprcTest++)
00311     {
00312         LPRECT lprcTest = *pprcTest;
00313         LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcScan;
00314 
00315         <span class="keywordflow">for</span> (pprcScan = pprcSplit; pprcScan &lt; pprcL; pprcScan++)
00316         {
00317             RECT rcCheckOverlap;
00318             LPRECT lprcScan = *pprcScan;
00319             LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcCheckOverlap;
00320             LPRECT <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *<a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pppBest;
00321             LPPOINT pdpBest;
00322             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pdBest;
00323             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> dX, dY;
00324             <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> dTotal;
00325 
00326             <span class="comment">//</span>
00327             <span class="comment">// Figure out how far the rectangle may be along both axes.</span>
00328             <span class="comment">// Note some of these numbers could be garbage at this point but</span>
00329             <span class="comment">// the code below will take care of it.</span>
00330             <span class="comment">//</span>
00331             <span class="keywordflow">if</span> (lprcScan-&gt;right &lt;= lprcTest-&gt;left)
00332                 dpMove.x = dX = lprcTest-&gt;left - lprcScan-&gt;right;
00333             <span class="keywordflow">else</span>
00334                 dpMove.x = -(<span class="keywordtype">int</span>)(dX = (lprcScan-&gt;left - lprcTest-&gt;right));
00335 
00336             <span class="keywordflow">if</span> (lprcScan-&gt;bottom &lt;= lprcTest-&gt;top)
00337                 dpMove.y = dY = lprcTest-&gt;top - lprcScan-&gt;bottom;
00338             <span class="keywordflow">else</span>
00339                 dpMove.y = -(<span class="keywordtype">int</span>)(dY = (lprcScan-&gt;top - lprcTest-&gt;bottom));
00340 
00341             <span class="comment">//</span>
00342             <span class="comment">// Figure out whether the rectangles are vertical, horizontal or</span>
00343             <span class="comment">// diagonal to each other and pick the measurements we will test.</span>
00344             <span class="comment">//</span>
00345             <span class="keywordflow">if</span> ((lprcScan-&gt;top &lt; lprcTest-&gt;bottom) &amp;&amp;
00346                 (lprcScan-&gt;bottom &gt; lprcTest-&gt;top))
00347             {
00348                 <span class="comment">// The rectangles are somewhat horizontally aligned.</span>
00349                 dpMove.y = dY = 0;
00350                 pppBest = &amp;pprcAxis;
00351                 pdpBest = &amp;dpAxis;
00352                 pdBest = &amp;dAxis;
00353             }
00354             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lprcScan-&gt;left &lt; lprcTest-&gt;right) &amp;&amp;
00355                 (lprcScan-&gt;right &gt; lprcTest-&gt;left))
00356             {
00357                 <span class="comment">// The rectangles are somewhat vertically aligned.</span>
00358                 dpMove.x = dX = 0;
00359                 pppBest = &amp;pprcAxis;
00360                 pdpBest = &amp;dpAxis;
00361                 pdBest = &amp;dAxis;
00362             }
00363             <span class="keywordflow">else</span>
00364             {
00365                 <span class="comment">// The rectangles are somewhat diagonally aligned.</span>
00366                 pppBest = &amp;pprcDiag;
00367                 pdpBest = &amp;dpDiag;
00368                 pdBest = &amp;dDiag;
00369             }
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// Make sure there aren't other rectangles in the way.  We only</span>
00373             <span class="comment">// need to check the upper array since that is the pool of</span>
00374             <span class="comment">// semi-placed rectangles.  Any rectangles in the lower array that</span>
00375             <span class="comment">// are "in the way" will be found in a different iteration of the</span>
00376             <span class="comment">// enclosing loop.</span>
00377             <span class="comment">//</span>
00378 
00379             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcCheckOverlap, lprcScan);
00380             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcCheckOverlap, dpMove.x, dpMove.y);
00381 
00382             <span class="keywordflow">for</span> (pprcCheckOverlap = pprcScan + 1; pprcCheckOverlap &lt; pprcL;
00383                 pprcCheckOverlap++)
00384             {
00385                 RECT rc;
00386                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, *pprcCheckOverlap, &amp;rcCheckOverlap))
00387                     <span class="keywordflow">break</span>;
00388             }
00389             <span class="keywordflow">if</span> (pprcCheckOverlap &lt; pprcL)
00390             {
00391                 <span class="comment">// There was another rectangle in the way; don't use this one.</span>
00392                 <span class="keywordflow">continue</span>;
00393             }
00394 
00395             <span class="comment">//</span>
00396             <span class="comment">// If it is closer than the one we already had, use it instead.</span>
00397             <span class="comment">//</span>
00398             dTotal = dX + dY;
00399             <span class="keywordflow">if</span> (dTotal &lt; *pdBest)
00400             {
00401                 *pdBest = dTotal;
00402                 *pdpBest = dpMove;
00403                 *pppBest = pprcScan;
00404             }
00405         }
00406     }
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">// If we found anything along an axis use that otherwise use a diagonal.</span>
00410     <span class="comment">//</span>
00411     <span class="keywordflow">if</span> (dAxis != (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1)
00412     {
00413         pprcSplit = pprcAxis;
00414         dpMove = dpAxis;
00415     }
00416     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dDiag != (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1)
00417     {
00418         <span class="comment">// BUGBUG: consider moving the rectangle to a side in this case.</span>
00419         <span class="comment">// (that, of course would add a lot of code to avoid collisions)</span>
00420         pprcSplit = pprcDiag;
00421         dpMove = dpDiag;
00422     }
00423     <span class="keywordflow">else</span>
00424         dpMove.x = dpMove.y = 0;
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Move the monitor into place and return it as the one we chose.</span>
00428     <span class="comment">//</span>
00429     <span class="keywordflow">if</span> (dpMove.x || dpMove.y)
00430         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(*pprcSplit, dpMove.x, dpMove.y);
00431 
00432     <span class="keywordflow">return</span> pprcSplit;
00433 }
00434 
00435 <span class="comment">// ----------------------------------------------------------------------------</span>
00436 <span class="comment">//</span>
00437 <span class="comment">//  RemoveGaps()</span>
00438 <span class="comment">//    This is called from CleanupDesktopRectangles to make sure the monitor</span>
00439 <span class="comment">//  array is contiguous.  It assumes that the array is already non-overlapping.</span>
00440 <span class="comment">//</span>
00441 <span class="comment">// ----------------------------------------------------------------------------</span>
<a name="l00442"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a11">00442</a> <span class="keywordtype">void</span> NEAR PASCAL <a class="code" href="../../d8/d5/alignrec_8c.html#a11">RemoveGaps</a>(LPRECT arc, UINT count)
00443 {
00444     LPRECT aprc[<a class="code" href="../../d8/d5/alignrec_8c.html#a0">MONITORS_MAX</a>];
00445     LPRECT lprc, lprcL, lprcSwap, <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprc, <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *pprcNearest;
00446     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uNearest;
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">// We will need to find the rectangle closest to the center of the group.</span>
00450     <span class="comment">// We don't really need to center the array here but it doesn't hurt and</span>
00451     <span class="comment">// saves us some code below.</span>
00452     <span class="comment">//</span>
00453     <a class="code" href="../../d8/d5/alignrec_8c.html#a7">CenterRectangles</a>(arc, count);
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Build an array of LPRECTs we can shuffle around with relative ease while</span>
00457     <span class="comment">// not disturbing the order of the passed array.  Also take note of which</span>
00458     <span class="comment">// one is closest to the center so we start with it and pull the rest of</span>
00459     <span class="comment">// the rectangles inward.  This can make a big difference in placement when</span>
00460     <span class="comment">// there are more than 2 rectangles.</span>
00461     <span class="comment">//</span>
00462     uNearest = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1;
00463     pprc = aprc;
00464     lprcL = (lprc = arc) + count;
00465 
00466     <span class="keywordflow">while</span> (lprc &lt; lprcL)
00467     {
00468         <span class="keywordtype">int</span> x, y;
00469         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> u;
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">// Fill in the array.</span>
00473         <span class="comment">//</span>
00474         *pprc = lprc;
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">// Check if this one is closer to the center of the group.</span>
00478         <span class="comment">//</span>
00479         x = <a class="code" href="../../d8/d5/alignrec_8c.html#a1">RectCenterX</a>(lprc);
00480         y = <a class="code" href="../../d8/d5/alignrec_8c.html#a2">RectCenterY</a>(lprc);
00481         <span class="keywordflow">if</span> (x &lt; 0) x *= -1;
00482         <span class="keywordflow">if</span> (y &lt; 0) y *= -1;
00483 
00484         u = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)x + (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)y;
00485         <span class="keywordflow">if</span> (u &lt; uNearest)
00486         {
00487             uNearest    = u;
00488             pprcNearest = pprc;
00489         }
00490 
00491         pprc++;
00492         lprc++;
00493     }
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Now make sure we move everything toward the centermost rectangle.</span>
00497     <span class="comment">//</span>
00498     <span class="keywordflow">if</span> (pprcNearest != aprc)
00499     {
00500         lprcSwap     = *pprcNearest;
00501         *pprcNearest = *aprc;
00502         *aprc        = lprcSwap;
00503     }
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// Finally, loop through the array closing any gaps.</span>
00507     <span class="comment">//</span>
00508     pprc = aprc + 1;
00509     <span class="keywordflow">for</span> (lprc = arc + 1; lprc &lt; lprcL; pprc++, lprc++)
00510     {
00511         <span class="comment">//</span>
00512         <span class="comment">// Find the next suitable rectangle to combine into the group and move</span>
00513         <span class="comment">// it into position.</span>
00514         <span class="comment">//</span>
00515         pprcNearest = <a class="code" href="../../d8/d5/alignrec_8c.html#a10">AddNextContiguousRectangle</a>(aprc, pprc, count);
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// If the rectangle that was added is not the next in our array, swap.</span>
00519         <span class="comment">//</span>
00520         <span class="keywordflow">if</span> (pprcNearest != pprc)
00521         {
00522             lprcSwap     = *pprcNearest;
00523             *pprcNearest = *pprc;
00524             *pprc        = lprcSwap;
00525         }
00526     }
00527 }
00528 
00529 <span class="comment">// ----------------------------------------------------------------------------</span>
00530 <span class="comment">//</span>
00531 <span class="comment">//  CleanUpDesktopRectangles()</span>
00532 <span class="comment">//    This is called by CleanUpMonitorRectangles (etc) to force a set of</span>
00533 <span class="comment">//  rectangles into a contiguous, non-overlapping arrangement.</span>
00534 <span class="comment">//</span>
00535 <span class="comment">// ----------------------------------------------------------------------------</span>
00536 
00537 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00538"></a><a class="code" href="../../d8/d5/alignrec_8c.html#a12">00538</a> <a class="code" href="../../d8/d5/alignrec_8c.html#a12">AlignRects</a>(LPRECT arc, DWORD cCount, DWORD iPrimary, DWORD dwFlags)
00539 {
00540     LPRECT lprc, lprcL;
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Limit for loops.</span>
00544     <span class="comment">//</span>
00545 
00546     lprcL = arc + cCount;
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// We don't need to get all worked up if there is only one rectangle.</span>
00550     <span class="comment">//</span>
00551 
00552     <span class="keywordflow">if</span> (cCount &gt; <a class="code" href="../../d8/d5/alignrec_8c.html#a0">MONITORS_MAX</a>)
00553     {
00554         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00555     }
00556 
00557 
00558     <span class="keywordflow">if</span> (cCount &gt; 1)
00559     {
00560         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CUDR_NOSNAPTOGRID))
00561         {
00562             <span class="comment">//</span>
00563             <span class="comment">// Align monitors on 8 pixel boundaries so GDI can use the same</span>
00564             <span class="comment">// brush realization on compatible devices (BIG performance win).</span>
00565             <span class="comment">// Note that we assume the size of a monitor will be in multiples</span>
00566             <span class="comment">// of 8 pixels on X and Y.  We cannot do this for the work areas so</span>
00567             <span class="comment">// we convert them to be relative to the origins of their monitors</span>
00568             <span class="comment">// for the time being.</span>
00569             <span class="comment">//</span>
00570             <span class="comment">// The way we do this alignment is to just do the overlap/gap</span>
00571             <span class="comment">// resoluton in 8 pixel space (ie divide everything by 8 beforehand</span>
00572             <span class="comment">// and multiply it by 8 afterward).</span>
00573             <span class="comment">//</span>
00574             <span class="comment">// Note: WE CAN'T USE MULTDIV HERE because it introduces one-off</span>
00575             <span class="comment">// errors when monitors span the origin.  These become eight-off</span>
00576             <span class="comment">// errors when we scale things back up and we end up trying to</span>
00577             <span class="comment">// create DCs with sizes like 632x472 etc (not too good).  It also</span>
00578             <span class="comment">// handles rounding the wierdly in both positive and negative space</span>
00579             <span class="comment">// and we just want to snap things to a grid so we compensate for</span>
00580             <span class="comment">// truncation differently here.</span>
00581             <span class="comment">//</span>
00582             <span class="keywordflow">for</span> (lprc = arc; lprc &lt; lprcL; lprc++)
00583             {
00584                 RECT rc;
00585                 <span class="keywordtype">int</span> d;
00586 
00587 
00588                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, lprc);
00589 
00590                 d = rc.right - rc.left;
00591 
00592                 <span class="keywordflow">if</span> (rc.left &lt; 0)
00593                     rc.left -= 4;
00594                 <span class="keywordflow">else</span>
00595                     rc.left += 3;
00596 
00597                 rc.left /= 8;
00598                 rc.right = rc.left + (d / 8);
00599 
00600                 d = rc.bottom - rc.top;
00601 
00602                 <span class="keywordflow">if</span> (rc.top &lt; 0)
00603                     rc.top -= 4;
00604                 <span class="keywordflow">else</span>
00605                     rc.top += 3;
00606 
00607                 rc.top /= 8;
00608                 rc.bottom = rc.top + (d / 8);
00609 
00610                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(lprc, &amp;rc);
00611             }
00612         }
00613 
00614         <span class="comment">//</span>
00615         <span class="comment">// RemoveGaps is designed assuming that none of the rectangles that it</span>
00616         <span class="comment">// is passed will overlap.  Thus we cannot safely call it if we have</span>
00617         <span class="comment">// skipped the call to RemoveOverlaps or it might loop forever.</span>
00618         <span class="comment">//</span>
00619         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CUDR_NORESOLVEPOSITIONS))
00620         {
00621             <a class="code" href="../../d8/d5/alignrec_8c.html#a9">RemoveOverlaps</a>(arc, cCount);
00622 
00623             <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CUDR_NOCLOSEGAPS))
00624             {
00625                 <a class="code" href="../../d8/d5/alignrec_8c.html#a11">RemoveGaps</a>(arc, cCount);
00626             }
00627         }
00628 
00629         <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CUDR_NOSNAPTOGRID))
00630         {
00631             <span class="comment">//</span>
00632             <span class="comment">// Now return the monitor rectangles to pixel units this is a</span>
00633             <span class="comment">// simple multiply and MultDiv doesn't offer us any code size</span>
00634             <span class="comment">// advantage so (I guess that assumes a bit about the compiler,</span>
00635             <span class="comment">// but...) just do it right here.</span>
00636             <span class="comment">//</span>
00637             <span class="keywordflow">for</span> (lprc = arc; lprc &lt; lprcL; lprc++)
00638             {
00639                 lprc-&gt;left   *= 8;
00640                 lprc-&gt;top    *= 8;
00641                 lprc-&gt;right  *= 8;
00642                 lprc-&gt;bottom *= 8;
00643             }
00644         }
00645     }
00646 
00647     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CUDR_NOPRIMARY))
00648     {
00649         <span class="comment">//</span>
00650         <span class="comment">// Reset all the coordinates based on the primaries position,</span>
00651         <span class="comment">// so that it is always located at 0,0</span>
00652         <span class="comment">//</span>
00653 
00654         LONG dx = -((arc + iPrimary)-&gt;left);
00655         LONG dy = -((arc + iPrimary)-&gt;top);
00656 
00657         <span class="keywordflow">for</span> (lprc = arc; lprc &lt; lprcL; lprc++)
00658         {
00659             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprc, dx, dy);
00660         }
00661     }
00662 
00663     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00664 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:14 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
