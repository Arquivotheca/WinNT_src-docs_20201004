<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kdcomio.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdcomio.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d0/d4/kdcomio_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a0">KdpComputeChecksum</a> (IN PUCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a1">KdpReceiveString</a> (OUT PCHAR Destination, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a2">KdpSendString</a> (IN PCHAR Source, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a3">KdpSendControlPacket</a> (IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> PacketType, IN ULONG PacketId OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a4">KdpReceivePacketLeader</a> (IN ULONG PacketType, OUT PULONG PacketLeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a5">KdpReceivePacket</a> (IN ULONG PacketType, OUT PSTRING MessageHeader, OUT PSTRING MessageData, OUT PULONG DataLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/kdcomio_8c.html#a6">KdpSendPacket</a> (IN ULONG PacketType, IN PSTRING MessageHeader, IN PSTRING MessageData OPTIONAL)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="kdcomio.c::KdpComputeChecksum" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpComputeChecksum           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00060">60</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string passed in.
00070 
00071 Arguments:
00072 
00073     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string.
00074 
00075     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string.
00076 
00077 Return Value:
00078 
00079     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> ULONG <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">return</span> as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> checksum <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string.
00080 
00081 --*/
00082 
00083 {
00084 
00085     ULONG Checksum = 0;
00086 
00087     <span class="keywordflow">while</span> (Length &gt; 0) {
00088         Checksum = Checksum + (ULONG)*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00089         Length--;
00090     }
00091     <span class="keywordflow">return</span> Checksum;
00092 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="kdcomio.c::KdpReceivePacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpReceivePacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DataLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00342">342</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
<pre class="fragment"><div>00351                    :
00352 
00353     This routine receives a packet from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host machine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running
00354     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger <a class="code" href="../../d1/d9/icmui_8def.html#a6">UI</a>.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ALWAYS called after packet being
00355     sent by caller.  It first waits <span class="keywordflow">for</span> ACK packet <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet sent and
00356     then waits <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet desired.
00357 
00358     N.B. If caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> KdPrintString, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parameter PacketType <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00359        PACKET_TYPE_KD_ACKNOWLEDGE.  In <span class="keyword">this</span> <span class="keywordflow">case</span>, <span class="keyword">this</span> routine will <span class="keywordflow">return</span>
00360        right after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ack packet <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> received.
00361 
00362 Arguments:
00363 
00364     PacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> excepted.
00365 
00366     MessageHeader - Supplies a pointer to a string descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input
00367         message.
00368 
00369     MessageData - Supplies a pointer to a string descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input data.
00370 
00371     DataLength - Supplies pointer to ULONG to receive length of recv. data.
00372 
00373 Return Value:
00374 
00375     <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a> - <span class="keywordflow">if</span> resend <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
00376     KDP_PAKCET_TIMEOUT - <span class="keywordflow">if</span> timeout.
00377     <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a> - <span class="keywordflow">if</span> packet received.
00378 
00379 --*/
00380 
00381 {
00382 
00383     UCHAR Input;
00384     ULONG MessageLength;
00385     KD_PACKET PacketHeader;
00386     ULONG ReturnCode;
00387     ULONG Checksum;
00388 
00389 WaitForPacketLeader:
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Read Packet Leader</span>
00393     <span class="comment">//</span>
00394 
00395     ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a148">KdpReceivePacketLeader</a>(PacketType, &amp;PacketHeader.PacketLeader);
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">// If we can successfully read packet leader, it has high possibility that</span>
00399     <span class="comment">// kernel debugger is alive.  So reset count.</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00403         <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00404     }
00405     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>) {
00406         <span class="keywordflow">return</span> ReturnCode;
00407     }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">// Read packet type.</span>
00411     <span class="comment">//</span>
00412 
00413     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketType,
00414                                   <span class="keyword">sizeof</span>(PacketHeader.PacketType));
00415     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00416         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00417     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00418         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00419 
00420             <span class="comment">//</span>
00421             <span class="comment">// If read error and it is for a control packet, simply</span>
00422             <span class="comment">// preptend that we have not seen this packet.  Hopefully</span>
00423             <span class="comment">// we will receive the packet we desire which automatically acks</span>
00424             <span class="comment">// the packet we just sent.</span>
00425             <span class="comment">//</span>
00426 
00427             <span class="keywordflow">goto</span> WaitForPacketLeader;
00428         } <span class="keywordflow">else</span> {
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">// if read error while reading data packet, we have to ask</span>
00432             <span class="comment">// kernel debugger to resend us the packet.</span>
00433             <span class="comment">//</span>
00434 
00435             <span class="keywordflow">goto</span> SendResendPacket;
00436         }
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// if the packet we received is a resend request, we return true and</span>
00441     <span class="comment">// let caller resend the packet.</span>
00442     <span class="comment">//</span>
00443 
00444     <span class="keywordflow">if</span> ( PacketHeader.PacketLeader == CONTROL_PACKET_LEADER &amp;&amp;
00445          PacketHeader.PacketType == PACKET_TYPE_KD_RESEND ) {
00446         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00447     }
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Read data length.</span>
00451     <span class="comment">//</span>
00452 
00453     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.ByteCount,
00454                                   <span class="keyword">sizeof</span>(PacketHeader.ByteCount));
00455     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00456         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00457     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00458         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00459             <span class="keywordflow">goto</span> WaitForPacketLeader;
00460         } <span class="keywordflow">else</span> {
00461             <span class="keywordflow">goto</span> SendResendPacket;
00462         }
00463     }
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">// Read Packet Id.</span>
00467     <span class="comment">//</span>
00468 
00469     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.PacketId,
00470                                   <span class="keyword">sizeof</span>(PacketHeader.PacketId));
00471 
00472     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00473         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00474     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00475         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00476             <span class="keywordflow">goto</span> WaitForPacketLeader;
00477         } <span class="keywordflow">else</span> {
00478             <span class="keywordflow">goto</span> SendResendPacket;
00479         }
00480     }
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Read packet checksum.</span>
00484     <span class="comment">//</span>
00485 
00486     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>((PCHAR)&amp;PacketHeader.Checksum,
00487                                   <span class="keyword">sizeof</span>(PacketHeader.Checksum));
00488     <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00489         <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00490     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00491         <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER) {
00492             <span class="keywordflow">goto</span> WaitForPacketLeader;
00493         } <span class="keywordflow">else</span> {
00494             <span class="keywordflow">goto</span> SendResendPacket;
00495         }
00496     }
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">// A complete packet header is received.  Check its validity and</span>
00500     <span class="comment">// perform appropriate action depending on packet type.</span>
00501     <span class="comment">//</span>
00502 
00503     <span class="keywordflow">if</span> (PacketHeader.PacketLeader == CONTROL_PACKET_LEADER ) {
00504         <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_ACKNOWLEDGE ) {
00505 
00506             <span class="comment">//</span>
00507             <span class="comment">// If we received an expected ACK packet and we are not</span>
00508             <span class="comment">// waiting for any new packet, update outgoing packet id</span>
00509             <span class="comment">// and return.  If we are NOT waiting for ACK packet</span>
00510             <span class="comment">// we will keep on waiting.  If the ACK packet</span>
00511             <span class="comment">// is not for the packet we send, ignore it and keep on waiting.</span>
00512             <span class="comment">//</span>
00513 
00514             <span class="keywordflow">if</span> (PacketHeader.PacketId !=
00515                 (<a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp; ~SYNC_PACKET_ID))  {
00516                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00517             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00518                 <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00519                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00520             } <span class="keywordflow">else</span> {
00521                 <span class="keywordflow">goto</span> WaitForPacketLeader;
00522             }
00523         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESET) {
00524 
00525             <span class="comment">//</span>
00526             <span class="comment">// if we received Reset packet, reset the packet control variables</span>
00527             <span class="comment">// and resend earlier packet.</span>
00528             <span class="comment">//</span>
00529 
00530             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID;
00531             <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00532             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESET, 0L);
00533             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00534         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketHeader.PacketType == PACKET_TYPE_KD_RESEND) {
00535             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00536         } <span class="keywordflow">else</span> {
00537 
00538             <span class="comment">//</span>
00539             <span class="comment">// Invalid packet header, ignore it.</span>
00540             <span class="comment">//</span>
00541 
00542             <span class="keywordflow">goto</span> WaitForPacketLeader;
00543         }
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">// The packet header is for data packet (not control packet).</span>
00547     <span class="comment">//</span>
00548 
00549     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_ACKNOWLEDGE) {
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">// if we are waiting for ACK packet ONLY</span>
00553         <span class="comment">// and we receive a data packet header, check if the packet id</span>
00554         <span class="comment">// is what we expected.  If yes, assume the acknowledge is lost (but</span>
00555         <span class="comment">// sent), ask sender to resend and return with PACKET_RECEIVED.</span>
00556         <span class="comment">//</span>
00557 
00558         <span class="keywordflow">if</span> (PacketHeader.PacketId == <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00559             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0L);
00560             <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> ^= 1;
00561             <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00562         } <span class="keywordflow">else</span> {
00563             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00564                                  PacketHeader.PacketId
00565                                  );
00566             <span class="keywordflow">goto</span> WaitForPacketLeader;
00567         }
00568     }
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">// we are waiting for data packet and we received the packet header</span>
00572     <span class="comment">// for data packet. Perform the following checkings to make sure</span>
00573     <span class="comment">// it is the packet we are waiting for.</span>
00574     <span class="comment">//</span>
00575 
00576     <span class="comment">//</span>
00577     <span class="comment">// Check ByteCount received is valid</span>
00578     <span class="comment">//</span>
00579 
00580     MessageLength = MessageHeader-&gt;MaximumLength;
00581     <span class="keywordflow">if</span> ((PacketHeader.ByteCount &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PACKET_MAX_SIZE) ||
00582         (PacketHeader.ByteCount &lt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength)) {
00583         <span class="keywordflow">goto</span> SendResendPacket;
00584     }
00585     *DataLength = PacketHeader.ByteCount - MessageLength;
00586 
00587     <span class="comment">//</span>
00588     <span class="comment">// Read the message header.</span>
00589     <span class="comment">//</span>
00590 
00591     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageHeader-&gt;Buffer, MessageLength);
00592     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00593         <span class="keywordflow">goto</span> SendResendPacket;
00594     }
00595     MessageHeader-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MessageLength;
00596 
00597     <span class="comment">//</span>
00598     <span class="comment">// Read the message data.</span>
00599     <span class="comment">//</span>
00600 
00601     ReturnCode = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a1">KdpReceiveString</a>(MessageData-&gt;Buffer, *DataLength);
00602     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00603         <span class="keywordflow">goto</span> SendResendPacket;
00604     }
00605     MessageData-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*DataLength;
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// Read packet trailing byte</span>
00609     <span class="comment">//</span>
00610 
00611     ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00612     <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a> || Input != PACKET_TRAILING_BYTE) {
00613         <span class="keywordflow">goto</span> SendResendPacket;
00614     }
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">// Check PacketType is what we are waiting for.</span>
00618     <span class="comment">//</span>
00619 
00620     <span class="keywordflow">if</span> (PacketType != PacketHeader.PacketType) {
00621         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00622                              PacketHeader.PacketId
00623                              );
00624         <span class="keywordflow">goto</span> WaitForPacketLeader;
00625     }
00626 
00627     <span class="comment">//</span>
00628     <span class="comment">// Check PacketId is valid.</span>
00629     <span class="comment">//</span>
00630 
00631     <span class="keywordflow">if</span> (PacketHeader.PacketId == INITIAL_PACKET_ID ||
00632         PacketHeader.PacketId == (INITIAL_PACKET_ID ^ 1)) {
00633         <span class="keywordflow">if</span> (PacketHeader.PacketId != <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a>) {
00634             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00635                                  PacketHeader.PacketId
00636                                  );
00637             <span class="keywordflow">goto</span> WaitForPacketLeader;
00638         }
00639     } <span class="keywordflow">else</span> {
00640         <span class="keywordflow">goto</span> SendResendPacket;
00641     }
00642 
00643     <span class="comment">//</span>
00644     <span class="comment">// Check checksum is valid.</span>
00645     <span class="comment">//</span>
00646 
00647     Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00648                             MessageHeader-&gt;Buffer,
00649                             MessageHeader-&gt;Length
00650                             );
00651 
00652     Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00653                             MessageData-&gt;Buffer,
00654                             MessageData-&gt;Length
00655                             );
00656     <span class="keywordflow">if</span> (Checksum != PacketHeader.Checksum) {
00657         <span class="keywordflow">goto</span> SendResendPacket;
00658     }
00659 
00660     <span class="comment">//</span>
00661     <span class="comment">// Send Acknowledge byte and the Id of the packet received.</span>
00662     <span class="comment">// Then, update the ExpectId for next incoming packet.</span>
00663     <span class="comment">//</span>
00664 
00665     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_ACKNOWLEDGE,
00666                          PacketHeader.PacketId
00667                          );
00668 
00669     <span class="comment">//</span>
00670     <span class="comment">// We have successfully received the packet so update the</span>
00671     <span class="comment">// packet control variables and return sucess.</span>
00672     <span class="comment">//</span>
00673 
00674     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> ^= 1;
00675     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00676 
00677 SendResendPacket:
00678     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a3">KdpSendControlPacket</a>(PACKET_TYPE_KD_RESEND, 0L);
00679     <span class="keywordflow">goto</span> WaitForPacketLeader;
00680 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="kdcomio.c::KdpReceivePacketLeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> KdpReceivePacketLeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketLeader</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00095">95</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
<pre class="fragment"><div>00102                    :
00103 
00104     This routine waits <span class="keywordflow">for</span> a packet header leader.
00105 
00106 Arguments:
00107 
00108     PacketType - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet we are expecting.
00109 
00110     PacketLeader - supplies a pointer to a ulong variable to receive
00111                    packet leader bytes.
00112 
00113 Return Value:
00114 
00115     <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a> - <span class="keywordflow">if</span> resend <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required.
00116     KDP_PAKCET_TIMEOUT - <span class="keywordflow">if</span> timeout.
00117     <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a> - <span class="keywordflow">if</span> packet received.
00118 
00119 --*/
00120 
00121 {
00122 
00123     UCHAR Input, PreviousByte = 0;
00124     ULONG PacketId = 0;
00125     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00126     ULONG ReturnCode;
00127     BOOLEAN BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// NOTE - With all the interrupts being off, it is very hard</span>
00131     <span class="comment">// to implement the actual timeout code. (Maybe, by reading the CMOS.)</span>
00132     <span class="comment">// Here we use a loop count to wait about 3 seconds.  The CpGetByte</span>
00133     <span class="comment">// will return with error code = CP_GET_NODATA if it cannot find data</span>
00134     <span class="comment">// byte within 1 second. Kernel debugger's timeout period is 5 seconds.</span>
00135     <span class="comment">//</span>
00136 
00137     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00138     <span class="keywordflow">do</span> {
00139         ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00140         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a>) {
00141             <span class="keywordflow">if</span> (BreakinDetected) {
00142                 <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00143                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a11">KDP_PACKET_RESEND</a>;
00144             } <span class="keywordflow">else</span> {
00145                 <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>;
00146             }
00147         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a>) {
00148             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00149             <span class="keywordflow">continue</span>;
00150         } <span class="keywordflow">else</span> {                    <span class="comment">// if (ReturnCode == CP_GET_SUCCESS)</span>
00151             <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ||
00152                  Input == CONTROL_PACKET_LEADER_BYTE ) {
00153                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == 0 ) {
00154                     PreviousByte = Input;
00155                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00156                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Input == PreviousByte ) {
00157                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++;
00158                 } <span class="keywordflow">else</span> {
00159                     PreviousByte = Input;
00160                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1;
00161                 }
00162             } <span class="keywordflow">else</span> {
00163 
00164                 <span class="comment">//</span>
00165                 <span class="comment">// If we detect breakin character, we need to verify it</span>
00166                 <span class="comment">// validity.  (It is possible that we missed a packet leader</span>
00167                 <span class="comment">// and the breakin character is simply a data byte in the</span>
00168                 <span class="comment">// packet.)</span>
00169                 <span class="comment">// Since kernel debugger send out breakin character ONLY</span>
00170                 <span class="comment">// when it is waiting for State Change packet.  The breakin</span>
00171                 <span class="comment">// character should not be followed by any other character</span>
00172                 <span class="comment">// except packet leader byte.</span>
00173                 <span class="comment">//</span>
00174 
00175                 <span class="keywordflow">if</span> ( Input == BREAKIN_PACKET_BYTE ) {
00176                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00177                 } <span class="keywordflow">else</span> {
00178 
00179                     <span class="comment">//</span>
00180                     <span class="comment">// The following statement is ABSOLUTELY necessary.</span>
00181                     <span class="comment">//</span>
00182 
00183                     BreakinDetected = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00184                 }
00185                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00186             }
00187         }
00188     } <span class="keywordflow">while</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; 4 );
00189 
00190     <span class="keywordflow">if</span> (BreakinDetected) {
00191         <a class="code" href="../../d8/d5/kddata_8c.html#a89">KdpControlCPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00192     }
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">// return the packet leader and FALSE to indicate no resend is needed.</span>
00196     <span class="comment">//</span>
00197 
00198     <span class="keywordflow">if</span> ( Input == PACKET_LEADER_BYTE ) {
00199         *PacketLeader = PACKET_LEADER;
00200     } <span class="keywordflow">else</span> {
00201         *PacketLeader = CONTROL_PACKET_LEADER;
00202     }
00203 
00204     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>;
00206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kdcomio.c::KdpReceiveString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG KdpReceiveString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00209">209</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
References <a class="el" href="../../d8/d2/kd_8h-source.html#l00030">CP_GET_SUCCESS</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte()</a>.
<p>
<pre class="fragment"><div>00216                    :
00217 
00218     This routine reads a string from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger port.
00219 
00220 Arguments:
00221 
00222     Destination - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input string.
00223 
00224     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string to be read.
00225 
00226 Return Value:
00227 
00228     <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successfully read from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00229         kernel debugger line.
00230     <a class="code" href="../../d7/d3/kd_8h.html#a2">CP_GET_ERROR</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> error encountered during reading.
00231     <a class="code" href="../../d7/d3/kd_8h.html#a1">CP_GET_NODATA</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> timeout.
00232 
00233 --*/
00234 
00235 {
00236 
00237     UCHAR Input;
00238     ULONG ReturnCode;
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Read bytes until either a error is encountered or the entire string</span>
00242     <span class="comment">// has been read.</span>
00243     <span class="comment">//</span>
00244     <span class="keywordflow">while</span> (Length &gt; 0) {
00245         ReturnCode = <a class="code" href="../../d2/d7/hal_8h.html#a200">KdPortGetByte</a>(&amp;Input);
00246         <span class="keywordflow">if</span> (ReturnCode != <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>) {
00247             <span class="keywordflow">return</span> ReturnCode;
00248         } <span class="keywordflow">else</span> {
00249             *Destination++ = Input;
00250             Length -= 1;
00251         }
00252     }
00253     <span class="keywordflow">return</span> <a class="code" href="../../d7/d3/kd_8h.html#a0">CP_GET_SUCCESS</a>;
00254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="kdcomio.c::KdpSendControlPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendControlPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG PacketId&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00297">297</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
References <a class="el" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString()</a>.
<p>
<pre class="fragment"><div>00304                    :
00305 
00306     This routine sends a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> packet to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host machine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00307     kernel debugger and waits <span class="keywordflow">for</span> an ACK.
00308 
00309 Arguments:
00310 
00311     PacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet to send.
00312 
00313     PacketId - Supplies packet <span class="keywordtype">id</span>, optionally.
00314 
00315 Return Value:
00316 
00317     None.
00318 
00319 --*/
00320 
00321 {
00322 
00323     KD_PACKET PacketHeader;
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Initialize and send the packet header.</span>
00327     <span class="comment">//</span>
00328 
00329     PacketHeader.PacketLeader = CONTROL_PACKET_LEADER;
00330     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PacketId)) {
00331         PacketHeader.PacketId = PacketId;
00332     }
00333     PacketHeader.ByteCount = 0;
00334     PacketHeader.Checksum = 0;
00335     PacketHeader.PacketType = PacketType;
00336     <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>((PCHAR)&amp;PacketHeader, <span class="keyword">sizeof</span>(KD_PACKET));
00337 
00338     <span class="keywordflow">return</span>;
00339 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="kdcomio.c::KdpSendPacket" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendPacket           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>PacketType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>MessageHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING MessageData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00683">683</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
<pre class="fragment"><div>00691                    :
00692 
00693     This routine sends a packet to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> host machine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00694     kernel debugger and waits <span class="keywordflow">for</span> an ACK.
00695 
00696 Arguments:
00697 
00698     PacketType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of packet to send.
00699 
00700     MessageHeader - Supplies a pointer to a string descriptor that describes
00701         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message information.
00702 
00703     MessageData - Supplies a pointer to a string descriptor that describes
00704         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optional message data.
00705 
00706 Return Value:
00707 
00708     None.
00709 
00710 --*/
00711 
00712 {
00713 
00714     KD_PACKET PacketHeader;
00715     ULONG MessageDataLength;
00716     ULONG ReturnCode;
00717     PDBGKD_DEBUG_IO DebugIo;
00718     PDBGKD_WAIT_STATE_CHANGE StateChange;
00719 
00720     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(MessageData) ) {
00721         MessageDataLength = MessageData-&gt;Length;
00722         PacketHeader.Checksum = <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a>(
00723                                         MessageData-&gt;Buffer,
00724                                         MessageData-&gt;Length
00725                                         );
00726     } <span class="keywordflow">else</span> {
00727         MessageDataLength = 0;
00728         PacketHeader.Checksum = 0;
00729     }
00730 
00731     PacketHeader.Checksum += <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a0">KdpComputeChecksum</a> (
00732                                     MessageHeader-&gt;Buffer,
00733                                     MessageHeader-&gt;Length
00734                                     );
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">// Initialize and send the packet header.</span>
00738     <span class="comment">//</span>
00739 
00740     PacketHeader.PacketLeader = PACKET_LEADER;
00741     PacketHeader.ByteCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(MessageHeader-&gt;Length + MessageDataLength);
00742     PacketHeader.PacketType = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PacketType;
00743     <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a>;
00744     <span class="keywordflow">do</span> {
00745         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a> == 0) {
00746 
00747             <span class="comment">//</span>
00748             <span class="comment">// If the packet is not for reporting exception, we give up</span>
00749             <span class="comment">// and declare debugger not present.</span>
00750             <span class="comment">//</span>
00751 
00752             <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_DEBUG_IO) {
00753                 DebugIo = (PDBGKD_DEBUG_IO)MessageHeader-&gt;Buffer;
00754                 <span class="keywordflow">if</span> (DebugIo-&gt;ApiNumber == DbgKdPrintStringApi) {
00755                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00756                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00757                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00758                     <span class="keywordflow">return</span>;
00759                 }
00760             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PacketType == PACKET_TYPE_KD_STATE_CHANGE) {
00761                 StateChange = (PDBGKD_WAIT_STATE_CHANGE)MessageHeader-&gt;Buffer;
00762                 <span class="keywordflow">if</span> (StateChange-&gt;NewState == DbgKdLoadSymbolsStateChange) {
00763                     <a class="code" href="../../d7/d3/kd_8h.html#a12">KdDebuggerNotPresent</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764                     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00765                     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00766                     <span class="keywordflow">return</span>;
00767                 }
00768             }
00769         }
00770 
00771         <span class="comment">//</span>
00772         <span class="comment">// Setting PacketId has to be in the do loop in case Packet Id was</span>
00773         <span class="comment">// reset.</span>
00774         <span class="comment">//</span>
00775 
00776         PacketHeader.PacketId = <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a>;
00777         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>((PCHAR)&amp;PacketHeader, <span class="keyword">sizeof</span>(KD_PACKET));
00778 
00779         <span class="comment">//</span>
00780         <span class="comment">// Output message header.</span>
00781         <span class="comment">//</span>
00782 
00783         <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageHeader-&gt;Buffer, MessageHeader-&gt;Length);
00784 
00785         <span class="comment">//</span>
00786         <span class="comment">// Output message data.</span>
00787         <span class="comment">//</span>
00788 
00789         <span class="keywordflow">if</span> ( MessageDataLength ) {
00790             <a class="code" href="../../d0/d5/4_2kdcomio_8c.html#a2">KdpSendString</a>(MessageData-&gt;Buffer, MessageData-&gt;Length);
00791         }
00792 
00793         <span class="comment">//</span>
00794         <span class="comment">// Output a packet trailing byte</span>
00795         <span class="comment">//</span>
00796 
00797         <a class="code" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte</a>(PACKET_TRAILING_BYTE);
00798 
00799         <span class="comment">//</span>
00800         <span class="comment">// Wait for the Ack Packet</span>
00801         <span class="comment">//</span>
00802 
00803         ReturnCode = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a112">KdpReceivePacket</a>(
00804                          PACKET_TYPE_KD_ACKNOWLEDGE,
00805                          NULL,
00806                          NULL,
00807                          NULL
00808                          );
00809         <span class="keywordflow">if</span> (ReturnCode == <a class="code" href="../../d0/d7/kdp_8h.html#a10">KDP_PACKET_TIMEOUT</a>) {
00810             <a class="code" href="../../d8/d5/kddata_8c.html#a88">KdpNumberRetries</a>--;
00811         }
00812     } <span class="keywordflow">while</span> (ReturnCode != <a class="code" href="../../d0/d7/kdp_8h.html#a9">KDP_PACKET_RECEIVED</a>);
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Reset Sync bit in packet id.  The packet we sent may have Sync bit set</span>
00816     <span class="comment">//</span>
00817 
00818     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> &amp;= ~SYNC_PACKET_ID;
00819 
00820     <span class="comment">//</span>
00821     <span class="comment">// Since we are able to talk to debugger, the retrycount is set to</span>
00822     <span class="comment">// maximum value.</span>
00823     <span class="comment">//</span>
00824 
00825     <a class="code" href="../../d8/d5/kddata_8c.html#a87">KdpRetryCount</a> = <a class="code" href="../../d3/d7/class_8h.html#a1">MAXIMUM_RETRIES</a>;
00826 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="kdcomio.c::KdpSendString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdpSendString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/kdcomio_8c-source.html#l00257">257</a> of file <a class="el" href="../../d0/d4/kdcomio_8c-source.html">kdcomio.c</a>.
<p>
References <a class="el" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte()</a>.
<p>
<pre class="fragment"><div>00264                    :
00265 
00266     This routine writes a string to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel debugger port.
00267 
00268 Arguments:
00269 
00270     Source - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output string.
00271 
00272     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string to be written.
00273 
00274 Return Value:
00275 
00276     None.
00277 
00278 --*/
00279 
00280 {
00281 
00282     UCHAR Output;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Write bytes to the kernel debugger port.</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="keywordflow">while</span> (Length &gt; 0) {
00289         Output = *Source++;
00290         <a class="code" href="../../d2/d7/hal_8h.html#a202">KdPortPutByte</a>(Output);
00291         Length -= 1;
00292     }
00293     <span class="keywordflow">return</span>;
00294 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
