<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: adtinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>adtinit.c File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include "<a class="el" href="../../d7/d5/sep_8h-source.html">sep.h</a>"</code><br>
<code>#include "<a class="el" href="../../d8/d3/adt_8h-source.html">adt.h</a>"</code><br>
<code>#include "<a class="el" href="../../d2/d4/adtp_8h-source.html">adtp.h</a>"</code><br>

<p>
<a href="../../d0/d4/adtinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a0">SepAdtValidateAuditBounds</a> (ULONG Upper, ULONG Lower)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a1">SepAdtInitializePhase1</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a2">SepAdtInitializeBounds</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a3">SepAdtInitializeCrashOnFail</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a4">SepAdtInitializePrivilegeAuditing</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/adtinit_8c.html#a5">SepAdtInitializeAuditingOptions</a> (VOID)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="adtinit.c::SepAdtInitializeAuditingOptions" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtInitializeAuditingOptions           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00425">425</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00320">_SEP_AUDIT_OPTIONS::DoNotAuditCloseObjectEvents</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00323">SepAuditOptions</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>.
<p>
<pre class="fragment"><div>00431                    :
00432 
00433     Initialize options that <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> auditing.
00434     (please refer to note in adtp.h near <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> def. of <a class="code" href="../../d4/d1/struct__SEP__AUDIT__OPTIONS.html">SEP_AUDIT_OPTIONS</a>)
00435 
00436 Arguments:
00437 
00438     None
00439 
00440 Return Value:
00441 
00442     None
00443 
00444 --*/
00445 
00446 {
00447     HANDLE KeyHandle;
00448     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00450     OBJECT_ATTRIBUTES Obja;
00451     ULONG ResultLength;
00452     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00453     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00454     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00455 
00456     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// Query the registry </span>
00460     <span class="comment">//</span>
00461     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa\\AuditingOptions"</span>);
00462 
00463     InitializeObjectAttributes( &amp;Obja,
00464                                 &amp;KeyName,
00465                                 OBJ_CASE_INSENSITIVE,
00466                                 NULL,
00467                                 NULL
00468                                 );
00469 
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00471                  &amp;KeyHandle,
00472                  KEY_QUERY_VALUE,
00473                  &amp;Obja
00474                  );
00475 
00476 
00477     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00478 
00479         <span class="keywordflow">goto</span> Cleanup;
00480     }
00481 
00482     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, L<span class="stringliteral">"DoNotAuditCloseObjectEvents"</span> );
00483 
00484     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00485                  KeyHandle,
00486                  &amp;ValueName,
00487                  KeyValuePartialInformation,
00488                  KeyInfo,
00489                  <span class="keyword">sizeof</span>(KeyInfo),
00490                  &amp;ResultLength
00491                  );
00492 
00493     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00495 
00496     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00497         <span class="comment">//</span>
00498         <span class="comment">// we check for the presence of this value, its value does not matter</span>
00499         <span class="comment">//</span>
00500         <a class="code" href="../../d1/d5/adtp_8h.html#a14">SepAuditOptions</a>.<a class="code" href="../../d4/d1/struct__SEP__AUDIT__OPTIONS.html#o0">DoNotAuditCloseObjectEvents</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501     }
00502 
00503 Cleanup:
00504 
00505     <span class="keywordflow">return</span>;
00506 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="adtinit.c::SepAdtInitializeBounds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepAdtInitializeBounds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">117</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00047">_SEP_AUDIT_BOUNDS::LowerBound</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d5/adtp_8h.html#a8">PSEP_AUDIT_BOUNDS</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d5/adtp_8h.html#a7">SEP_AUDIT_BOUNDS</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00037">SepAdtMaxListLength</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00038">SepAdtMinListLength</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00039">SepAdtValidateAuditBounds()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00046">_SEP_AUDIT_BOUNDS::UpperBound</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/rmaudit_8c-source.html#l00051">SepRmSetAuditEventWrkr()</a>.
<p>
<pre class="fragment"><div>00123                    :
00124 
00125     Queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> and <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> water mark values <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00126     audit log.  If they are not found or are unacceptable, returns without
00127     modifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current values, which are statically initialized.
00128 
00129 Arguments:
00130 
00131     None.
00132 
00133 Return Value:
00134 
00135     None.
00136 
00137 --*/
00138 
00139 {
00140 
00141     HANDLE KeyHandle;
00142     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00143     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00144     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00146     <a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">PSEP_AUDIT_BOUNDS</a> AuditBounds;
00147     PKEY_VALUE_PARTIAL_INFORMATION KeyValueInformation;
00148     ULONG Length;
00149 
00150     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// Get the high and low water marks out of the registry.</span>
00154     <span class="comment">//</span>
00155 
00156     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00157 
00158     InitializeObjectAttributes(
00159         &amp;ObjectAttributes,
00160         &amp;KeyName,
00161         OBJ_CASE_INSENSITIVE,
00162         NULL,
00163         NULL
00164         );
00165 
00166     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00167                  &amp;KeyHandle,
00168                  KEY_QUERY_VALUE,
00169                  &amp;ObjectAttributes
00170                  );
00171 
00172     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00173 
00174         <span class="comment">//</span>
00175         <span class="comment">// Didn't work, take the defaults</span>
00176         <span class="comment">//</span>
00177 
00178         <span class="keywordflow">return</span>;
00179     }
00180 
00181     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, L<span class="stringliteral">"Bounds"</span>);
00182 
00183     Length = <span class="keyword">sizeof</span>( KEY_VALUE_PARTIAL_INFORMATION ) - <span class="keyword">sizeof</span>( UCHAR ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">SEP_AUDIT_BOUNDS</a> );
00184 
00185     KeyValueInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, Length );
00186 
00187     <span class="keywordflow">if</span> ( KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00188 
00189         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
00190         <span class="keywordflow">return</span>;
00191     }
00192 
00193     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00194                  KeyHandle,
00195                  &amp;ValueName,
00196                  KeyValuePartialInformation,
00197                  (PVOID)KeyValueInformation,
00198                  Length,
00199                  &amp;Length
00200                  );
00201 
00202     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( KeyHandle );
00203 
00204     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00205 
00206         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00207         <span class="keywordflow">return</span>;
00208     }
00209 
00210 
00211     AuditBounds = (<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html">PSEP_AUDIT_BOUNDS</a>) &amp;KeyValueInformation-&gt;Data;
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Sanity check what we got back</span>
00215     <span class="comment">//</span>
00216 
00217     <span class="keywordflow">if</span>(!<a class="code" href="../../d6/d6/sep_8h.html#a70">SepAdtValidateAuditBounds</a>( AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o0">UpperBound</a>, AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o1">LowerBound</a> )) {
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">// The values we got back are not to our liking.  Use the defaults.</span>
00221         <span class="comment">//</span>
00222 
00223         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00224         <span class="keywordflow">return</span>;
00225     }
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// Take what we got from the registry.</span>
00229     <span class="comment">//</span>
00230 
00231     <a class="code" href="../../d1/d5/adtp_8h.html#a5">SepAdtMaxListLength</a> = AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o0">UpperBound</a>;
00232     <a class="code" href="../../d1/d5/adtp_8h.html#a6">SepAdtMinListLength</a> = AuditBounds-&gt;<a class="code" href="../../d3/d1/struct__SEP__AUDIT__BOUNDS.html#o1">LowerBound</a>;
00233 
00234     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( KeyValueInformation );
00235 
00236     <span class="keywordflow">return</span>;
00237 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="adtinit.c::SepAdtInitializeCrashOnFail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepAdtInitializeCrashOnFail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00242">242</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00077">SepCrashOnAuditFail</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>.
<p>
<pre class="fragment"><div>00248                    :
00249 
00250     Reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user has told us to crash <span class="keywordflow">if</span> an audit fails.
00251 
00252 Arguments:
00253 
00254     None.
00255 
00256 Return Value:
00257 
00258     STATUS_SUCCESS
00259 
00260 --*/
00261 
00262 {
00263     HANDLE KeyHandle;
00264     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00265     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00266     OBJECT_ATTRIBUTES Obja;
00267     ULONG ResultLength;
00268     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00269     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00270     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00271     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
00272 
00273     <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Check the value of the CrashOnAudit flag in the registry.</span>
00277     <span class="comment">//</span>
00278 
00279     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00280 
00281     InitializeObjectAttributes( &amp;Obja,
00282                                 &amp;KeyName,
00283                                 OBJ_CASE_INSENSITIVE,
00284                                 NULL,
00285                                 NULL
00286                                 );
00287 
00288     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00289                  &amp;KeyHandle,
00290                  KEY_QUERY_VALUE | KEY_SET_VALUE,
00291                  &amp;Obja
00292                  );
00293 
00294     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00295         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00296     }
00297 
00298     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, CRASH_ON_AUDIT_FAIL_VALUE );
00299 
00300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00301                  KeyHandle,
00302                  &amp;ValueName,
00303                  KeyValuePartialInformation,
00304                  KeyInfo,
00305                  <span class="keyword">sizeof</span>(KeyInfo),
00306                  &amp;ResultLength
00307                  );
00308 
00309     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00310     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// If the key isn't there, don't turn on CrashOnFail.</span>
00314     <span class="comment">//</span>
00315 
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00317 
00318         pKeyInfo = (PKEY_VALUE_PARTIAL_INFORMATION)KeyInfo;
00319         <span class="keywordflow">if</span> ((UCHAR) *(pKeyInfo-&gt;Data) == LSAP_CRASH_ON_AUDIT_FAIL) {
00320             <a class="code" href="../../d1/d5/adtp_8h.html#a12">SepCrashOnAuditFail</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00321         }
00322     }
00323 
00324     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00325 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="adtinit.c::SepAdtInitializePhase1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtInitializePhase1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00085">85</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01711">SeSubsystemName</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>.
<p>
<pre class="fragment"><div>00089                    :
00090 
00091     This function performs Phase 1 Initialization <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Auditing subcomponent
00092     of Security.  Global variables are initialized within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Nt <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>
00093     and Auditing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> turned off.
00094 
00095 Arguments:
00096 
00097     None
00098 
00099 Return Value:
00100 
00101     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> Auditing has been initialized correctly, <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00102 
00103 --*/
00104 
00105 {
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SeSubsystemName, L<span class="stringliteral">"Security"</span> );
00109 
00110     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00111 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="adtinit.c::SepAdtInitializePrivilegeAuditing" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtInitializePrivilegeAuditing           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">329</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d4/adtp_8h-source.html#l00083">FULL_PRIVILEGE_AUDITING</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l02187">NtQueryValueKey()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l04556">SepInitializePrivilegeFilter()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
Referenced by <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00060">SeRmInitPhase1()</a>.
<p>
<pre class="fragment"><div>00335                    :
00336 
00337     Checks to see <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry telling us to <span class="keywordflow">do</span> full privilege auditing
00338     (which currently means audit everything we normall audit, plus backup and restore privileges).
00339 
00340 Arguments:
00341 
00342     None
00343 
00344 Return Value:
00345 
00346     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> Auditing has been initialized correctly, <span class="keywordflow">else</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00347 
00348 --*/
00349 
00350 {
00351     HANDLE KeyHandle;
00352     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> TmpStatus;
00354     OBJECT_ATTRIBUTES Obja;
00355     ULONG ResultLength;
00356     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00357     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00358     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> KeyInfo[<span class="keyword">sizeof</span>(KEY_VALUE_PARTIAL_INFORMATION) + <span class="keyword">sizeof</span>(BOOLEAN)];
00359     PKEY_VALUE_PARTIAL_INFORMATION pKeyInfo;
00360     BOOLEAN Verbose;
00361 
00362     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// Query the registry to set up the privilege auditing filter.</span>
00366     <span class="comment">//</span>
00367 
00368     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyName, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\Lsa"</span>);
00369 
00370     InitializeObjectAttributes( &amp;Obja,
00371                                 &amp;KeyName,
00372                                 OBJ_CASE_INSENSITIVE,
00373                                 NULL,
00374                                 NULL
00375                                 );
00376 
00377     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00378                  &amp;KeyHandle,
00379                  KEY_QUERY_VALUE | KEY_SET_VALUE,
00380                  &amp;Obja
00381                  );
00382 
00383 
00384     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00385 
00386         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
00387 
00388             <span class="keywordflow">return</span> ( <a class="code" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a>( FALSE ));
00389 
00390         } <span class="keywordflow">else</span> {
00391 
00392             <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00393         }
00394     }
00395 
00396     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ValueName, FULL_PRIVILEGE_AUDITING );
00397 
00398     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(
00399                  KeyHandle,
00400                  &amp;ValueName,
00401                  KeyValuePartialInformation,
00402                  KeyInfo,
00403                  <span class="keyword">sizeof</span>(KeyInfo),
00404                  &amp;ResultLength
00405                  );
00406 
00407     TmpStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(KeyHandle);
00408     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(TmpStatus));
00409 
00410     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00411 
00412         Verbose = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413 
00414     } <span class="keywordflow">else</span> {
00415 
00416         pKeyInfo = (PKEY_VALUE_PARTIAL_INFORMATION)KeyInfo;
00417         Verbose = (BOOLEAN) *(pKeyInfo-&gt;Data);
00418     }
00419 
00420     <span class="keywordflow">return</span> ( <a class="code" href="../../d3/d5/seaudit_8c.html#a33">SepInitializePrivilegeFilter</a>( Verbose ));
00421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="adtinit.c::SepAdtValidateAuditBounds" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN SepAdtValidateAuditBounds           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Upper</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lower</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00039">39</a> of file <a class="el" href="../../d0/d4/adtinit_8c-source.html">adtinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">SepAdtInitializeBounds()</a>.
<p>
<pre class="fragment"><div>00046                    :
00047 
00048     Examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit queue <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> and <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> water mark values and performs
00049     a general sanity check on them.
00050 
00051 Arguments:
00052 
00053     Upper - High water mark.
00054 
00055     Lower - Low water mark.
00056 
00057 Return Value:
00058 
00059     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - values are acceptable.
00060 
00061     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - values are unacceptable.
00062 
00063 
00064 --*/
00065 
00066 {
00067     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00068 
00069     <span class="keywordflow">if</span> ( Lower &gt;= Upper ) {
00070         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00071     }
00072 
00073     <span class="keywordflow">if</span> ( Lower &lt; 16 ) {
00074         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00075     }
00076 
00077     <span class="keywordflow">if</span> ( (Upper - Lower) &lt; 16 ) {
00078         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00079     }
00080 
00081     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00082 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
