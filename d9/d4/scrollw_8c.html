<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: scrollw.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>scrollw.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d0/d4/scrollw_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/scrollw_8c.html#a0">GetTrueClipRgn</a> (HDC hdc, HRGN hrgnClip)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/scrollw_8c.html#a1">InternalScrollDC</a> (HDC hdc, int dx, int dy, RECT *prcSrc, RECT *prcClip, HRGN hrgnInvalid, HRGN hrgnUpdate, LPRECT prcUpdate, BOOL fLogUnits)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/scrollw_8c.html#a2">_ScrollDC</a> (HDC hdc, int dx, int dy, LPRECT prcSrc, LPRECT prcClip, HRGN hrgnUpdate, LPRECT prcUpdate)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/scrollw_8c.html#a3">xxxScrollWindowEx</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, int dx, int dy, RECT *prcScroll, RECT *prcClip, HRGN hrgnUpdate, LPRECT prcUpdate, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flags)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="scrollw.c::_ScrollDC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _ScrollDC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HDC&nbsp;</td>
          <td class="mdname" nowrap> <em>hdc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dy</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>prcSrc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>prcClip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnUpdate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>prcUpdate</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00653">653</a> of file <a class="el" href="../../d0/d4/scrollw_8c-source.html">scrollw.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l02022">FastWindowFromDC()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01757">tagWND::hrgnUpdate</a>, <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00067">InternalScrollDC()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00139">OffsetRect()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01839">tagWND::rcClient</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d5/rect_8c-source.html#l00241">UnionRect()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l06824">NtUserScrollDC()</a>, and <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00808">xxxPaintIconsInSwitchWindow()</a>.
<p>
<pre class="fragment"><div>00661 {
00662     RECT rcSrc;
00663     RECT rcSpb;
00664     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00665     HRGN hrgnInvalid;
00666     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRet;
00667 
00668     <span class="comment">/*</span>
00669 <span class="comment">     * ScrollDC does not scroll update region. Under WinNT, an app calling</span>
00670 <span class="comment">     * GetUpdateRgn() then ScrollDC() then InvalidateRgn() will not get</span>
00671 <span class="comment">     * any new update region that happened between the Get and Scroll. Under</span>
00672 <span class="comment">     * Win3.1, that was not a problem because no other app ran during this</span>
00673 <span class="comment">     * time. So pass hrgnInvalid - this will affect the hrgnUpdate and</span>
00674 <span class="comment">     * prcUpdate values being returned from ScrollDC with the update region.</span>
00675 <span class="comment">     */</span>
00676     hrgnInvalid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00677     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1704">FastWindowFromDC</a>(hdc)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00678 
00679         hrgnInvalid = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>;
00680 
00681         <span class="keywordflow">if</span> (hrgnInvalid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00682 
00683             <span class="comment">/*</span>
00684 <span class="comment">             * This is a fix for winhell, a performance testing app</span>
00685 <span class="comment">             * written by some guy working for a windows magazine.</span>
00686 <span class="comment">             * this app scrolls it's window while it is completely</span>
00687 <span class="comment">             * invalid.  We normaly won't scroll invalid bits but</span>
00688 <span class="comment">             * but we make the exception here</span>
00689 <span class="comment">             */</span>
00690             hrgnInvalid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00691         }
00692     }
00693 
00694     fRet = <a class="code" href="../../d9/d4/scrollw_8c.html#a1">InternalScrollDC</a>(hdc,
00695                             dx,
00696                             dy,
00697                             prcSrc,
00698                             prcClip,
00699                             hrgnInvalid,
00700                             hrgnUpdate,
00701                             prcUpdate,
00702                             TRUE) != ERROR;
00703 
00704     <span class="comment">/*</span>
00705 <span class="comment">     * InternalScrollDC() only scrolls those areas inside the visible region.</span>
00706 <span class="comment">     * This means it does no operations on parts of the window if the window</span>
00707 <span class="comment">     * isn't visible. This means SPBs don't get properly invalidated. This</span>
00708 <span class="comment">     * could be seen by starting a dir, then moving another window with the</span>
00709 <span class="comment">     * mouse (and keeping the mouse down until the dir finished). The</span>
00710 <span class="comment">     * screen is remembered with an SPB, and the dir window doesn't get</span>
00711 <span class="comment">     * properly invalidated because of this.</span>
00712 <span class="comment">     */</span>
00713     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
00714 
00715         <span class="keywordflow">if</span> (prcSrc) {
00716 
00717             rcSrc = *prcSrc;
00718             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcSrc, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00719 
00720             rcSpb = rcSrc;
00721             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcSpb, dx, dy);
00722             <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcSpb, &amp;rcSpb, &amp;rcSrc);
00723 
00724         } <span class="keywordflow">else</span> {
00725             rcSpb = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
00726         }
00727 
00728         <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;rcSpb, 0);
00729     }
00730 
00731     <span class="keywordflow">return</span> fRet;
00732 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="scrollw.c::GetTrueClipRgn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int GetTrueClipRgn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HDC&nbsp;</td>
          <td class="mdname" nowrap> <em>hdc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnClip</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00030">30</a> of file <a class="el" href="../../d0/d4/scrollw_8c-source.html">scrollw.c</a>.
<p>
References <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00513">ghrgnScrl2</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02219">IntersectRgn</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00067">InternalScrollDC()</a>.
<p>
<pre class="fragment"><div>00033 {
00034     POINT pt;
00035     <span class="keywordtype">int</span>   code;
00036 
00037     code = GreCopyVisRgn(hdc, hrgnClip);
00038 
00039     <span class="comment">/*</span>
00040 <span class="comment">     * NOTE!!! The global ghrgnScrl2 is used in this routine!</span>
00041 <span class="comment">     */</span>
00042     GreGetDCOrg(hdc, &amp;pt);
00043 
00044     <span class="keywordflow">if</span> (GreGetRandomRgn(hdc, ghrgnScrl2, 1)) {
00045         GreOffsetRgn(ghrgnScrl2, pt.x, pt.y);
00046         code = <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnClip, hrgnClip, ghrgnScrl2);
00047     }
00048 
00049     <span class="comment">/*</span>
00050 <span class="comment">     * Finally convert the result to DC coordinates</span>
00051 <span class="comment">     */</span>
00052     GreOffsetRgn(hrgnClip, -pt.x, -pt.y);
00053 
00054     <span class="keywordflow">return</span> code;
00055 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="scrollw.c::InternalScrollDC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int InternalScrollDC           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HDC&nbsp;</td>
          <td class="mdname" nowrap> <em>hdc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dy</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>RECT *&nbsp;</td>
          <td class="mdname" nowrap> <em>prcSrc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>RECT *&nbsp;</td>
          <td class="mdname" nowrap> <em>prcClip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnInvalid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnUpdate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>prcUpdate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fLogUnits</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00067">67</a> of file <a class="el" href="../../d0/d4/scrollw_8c-source.html">scrollw.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00243">CopyRect</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02217">CopyRgn</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00057">CreateEmptyRgn()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00244">EqualRect</a>, <a class="el" href="../../d2/d9/tdisp_8c-source.html#l00009">ErrorExit()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l02066">GetDCOrgOnScreen()</a>, <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00030">GetTrueClipRgn()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00512">ghrgnScrl1</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00513">ghrgnScrl2</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00516">ghrgnScrlDst</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00515">ghrgnScrlSrc</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00517">ghrgnScrlValid</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00514">ghrgnScrlVis</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00464">gpDispInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02094">tagDISPLAYINFO::hDev</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02219">IntersectRgn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00097">SetEmptyRgn()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00245">SetRectEmpty</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00327">SubtractRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02221">SubtractRgn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00241">UnionRect()</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l02223">UnionRgn</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00653">_ScrollDC()</a>, and <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00741">xxxScrollWindowEx()</a>.
<p>
<pre class="fragment"><div>00077 {
00078     RECT  rcVis;
00079     RECT  rcSrc;
00080     RECT  rcClip;
00081     RECT  rcUnclippedSrc;
00082     RECT  rcDst;
00083     RECT  rcUpdate;
00084     RECT  rcValid;
00085     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fSrcNotEmpty;
00086     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fHaveVisRgn;
00087     POINT rgpt[2];
00088     <span class="keywordtype">int</span>   dxLog;
00089     <span class="keywordtype">int</span>   dyLog;
00090     <span class="keywordtype">int</span>   wClip;
00091     <span class="keywordtype">int</span>   wClipValid;
00092 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
00093 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bMirroredDC=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00094 <span class="preprocessor">#endif</span>
00095 <span class="preprocessor"></span>
00096     fHaveVisRgn = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00097 
00098     <span class="comment">/*</span>
00099 <span class="comment">     * Enter a critical region to ensure that no one changes visrgns</span>
00100 <span class="comment">     * or update regions while we scroll bits around.</span>
00101 <span class="comment">     */</span>
00102     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00103 
00104     <span class="keywordflow">if</span> ((wClip = GreGetClipBox(hdc, &amp;rcVis, TRUE)) == ERROR) {
00105 
00106 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
00107 
00108         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00109         <span class="keywordflow">return</span> ERROR;
00110     }
00111 
00112     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcSrc, (prcSrc) ? prcSrc : &amp;rcVis);
00113     <span class="keywordflow">if</span> (prcClip) {
00114         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcClip, prcClip);
00115     }
00116 
00117     dxLog = dx;
00118     dyLog = dy;
00119 
00120     <span class="keywordflow">if</span> (fLogUnits) {
00121 
00122         <span class="comment">/*</span>
00123 <span class="comment">         * Convert input parameters to device coordinates</span>
00124 <span class="comment">         */</span>
00125         GreLPtoDP(hdc, (LPPOINT)&amp;rcVis, 2);
00126         GreLPtoDP(hdc, (LPPOINT)&amp;rcSrc, 2);
00127 
00128 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
00129 <span class="preprocessor"></span>        <span class="comment">//</span>
00130         <span class="comment">// Since this is a mirrored DC, then the resulting</span>
00131         <span class="comment">// device coord will be flowing from right to left</span>
00132         <span class="comment">// (i.e. rc.right &lt; rc.left) so they should be flipped.</span>
00133         <span class="comment">// [samera]</span>
00134         <span class="comment">//</span>
00135         <span class="keywordflow">if</span> (GreGetLayout(hdc) &amp; LAYOUT_RTL) {
00136             <span class="keywordtype">int</span> iTemp   = rcVis.left;
00137             rcVis.left  = rcVis.right;
00138             rcVis.right = iTemp;
00139 
00140             iTemp       = rcSrc.left;
00141             rcSrc.left  = rcSrc.right;
00142             rcSrc.right = iTemp;
00143 
00144             bMirroredDC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00145         }
00146 <span class="preprocessor">#endif</span>
00147 <span class="preprocessor"></span>
00148         <span class="keywordflow">if</span> (prcClip) {
00149             GreLPtoDP(hdc, (LPPOINT)&amp;rcClip, 2);
00150 
00151 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
00152 <span class="preprocessor"></span>            <span class="comment">//</span>
00153             <span class="comment">// Since this is a mirrored DC, then the resulting</span>
00154             <span class="comment">// device coord will be flowing from right to left</span>
00155             <span class="comment">// (i.e. rc.right &lt; rc.left) so they should be flipped.</span>
00156             <span class="comment">// [samera]</span>
00157             <span class="comment">//</span>
00158             <span class="keywordflow">if</span> (bMirroredDC) {
00159                 <span class="keywordtype">int</span> iTemp    = rcClip.left;
00160                 rcClip.left  = rcClip.right;
00161                 rcClip.right = iTemp;
00162             }
00163 <span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>        }
00165 
00166         <span class="comment">/*</span>
00167 <span class="comment">         * The delta values must be treated as a vector from</span>
00168 <span class="comment">         * the point (0, 0) to (dx, dy).  Scale it as such, then</span>
00169 <span class="comment">         * compute the difference.  This handles flipped coordinate systems.</span>
00170 <span class="comment">         */</span>
00171         rgpt[0].x = rgpt[0].y = 0;
00172         rgpt[1].x = dx;
00173         rgpt[1].y = dy;
00174 
00175         GreLPtoDP(hdc, rgpt, 2);
00176 
00177         dx = rgpt[1].x - rgpt[0].x;
00178         dy = rgpt[1].y - rgpt[0].y;
00179     }
00180 
00181     <span class="keywordflow">switch</span> (wClip) {
00182     <span class="keywordflow">case</span> NULLREGION:
00183 
00184 NullExit:
00185 
00186         <span class="keywordflow">if</span> (hrgnUpdate &amp;&amp; !<a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgnUpdate))
00187             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00188 
00189         <span class="keywordflow">if</span> (prcUpdate) {
00190             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(prcUpdate);
00191         }
00192 
00193         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00194         <span class="keywordflow">return</span> NULLREGION;
00195 
00196     <span class="keywordflow">case</span> COMPLEXREGION:
00197         <a class="code" href="../../d9/d4/scrollw_8c.html#a0">GetTrueClipRgn</a>(hdc, ghrgnScrlVis);
00198         fHaveVisRgn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00199         <span class="keywordflow">break</span>;
00200     }
00201 
00202     <span class="comment">/*</span>
00203 <span class="comment">     * First compute the source and destination rectangles.</span>
00204 <span class="comment">     *</span>
00205 <span class="comment">     * rcDst = Offset(rcSrc, dx, dy)</span>
00206 <span class="comment">     */</span>
00207     rcDst.left   = rcSrc.left   + dx;
00208     rcDst.right  = rcSrc.right  + dx;
00209     rcDst.top    = rcSrc.top    + dy;
00210     rcDst.bottom = rcSrc.bottom + dy;
00211 
00212     <span class="comment">/*</span>
00213 <span class="comment">     * If necessary, intersect with caller-supplied clip rect.</span>
00214 <span class="comment">     */</span>
00215     <span class="keywordflow">if</span> (prcClip) {
00216 
00217         <span class="keywordflow">if</span> ((wClip == SIMPLEREGION) &amp;&amp;
00218             ((hrgnInvalid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (hrgnInvalid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>))) {
00219 
00220             <span class="comment">/*</span>
00221 <span class="comment">             * Simple clip region: just a rect intersection</span>
00222 <span class="comment">             */</span>
00223             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcVis, &amp;rcVis, &amp;rcClip))
00224                 <span class="keywordflow">goto</span> NullExit;
00225 
00226         } <span class="keywordflow">else</span> {
00227 
00228             <span class="keywordflow">if</span> (!fHaveVisRgn) {
00229 
00230                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d4/scrollw_8c.html#a0">GetTrueClipRgn</a>(hdc, ghrgnScrlVis) == ERROR)
00231                     <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00232 
00233                 fHaveVisRgn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00234             }
00235 
00236             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnScrl1, &amp;rcClip);
00237             wClip = <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(ghrgnScrlVis, ghrgnScrl1, ghrgnScrlVis);
00238             <span class="keywordflow">switch</span> (wClip) {
00239             <span class="keywordflow">case</span> ERROR:
00240                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00241 
00242             <span class="keywordflow">case</span> NULLREGION:
00243                 <span class="keywordflow">goto</span> NullExit;
00244 
00245             <span class="keywordflow">case</span> SIMPLEREGION:
00246 
00247                 <span class="comment">/*</span>
00248 <span class="comment">                 * If the clipped region is simple, we're back in fat</span>
00249 <span class="comment">                 * rect city.</span>
00250 <span class="comment">                 */</span>
00251                 GreGetRgnBox(ghrgnScrlVis, &amp;rcVis);
00252                 <span class="keywordflow">break</span>;
00253 
00254             <span class="keywordflow">case</span> COMPLEXREGION:
00255                 <span class="keywordflow">break</span>;
00256             }
00257         }
00258     }
00259 
00260     <span class="comment">/*</span>
00261 <span class="comment">     * Time for basic scrolling area calculations:</span>
00262 <span class="comment">     *</span>
00263 <span class="comment">     * Dst    = Offset(Src, dx, dy) &amp; Vis</span>
00264 <span class="comment">     * Src    = Src &amp; Vis</span>
00265 <span class="comment">     * Valid  = Offset(Src, dx, dy) &amp; Dst</span>
00266 <span class="comment">     * Valid  = Valid &amp; Invalid &amp; Offset(Invalid, dx, dy)</span>
00267 <span class="comment">     * Update = (Src | Dst) - Valid</span>
00268 <span class="comment">     *</span>
00269 <span class="comment">     * If the vis region is simple, then we know that the valid region</span>
00270 <span class="comment">     * will be rectangular.</span>
00271 <span class="comment">     *</span>
00272 <span class="comment">     * The rectangular calculation case can only deal with</span>
00273 <span class="comment">     * ghrgnInvalid == NULL or (HRGN)1: the region case is handled the hard way.</span>
00274 <span class="comment">     */</span>
00275     <span class="keywordflow">if</span> ((wClip == SIMPLEREGION) &amp;&amp;
00276             ((hrgnInvalid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (hrgnInvalid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>))) {
00277 
00278         <span class="comment">/*</span>
00279 <span class="comment">         * Save a copy of this for update rect calc optimization.</span>
00280 <span class="comment">         */</span>
00281         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcUnclippedSrc, &amp;rcSrc);
00282 
00283         <span class="comment">/*</span>
00284 <span class="comment">         * Dst = Offset(Src, dx, dy) &amp; Vis.</span>
00285 <span class="comment">         */</span>
00286         <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcDst, &amp;rcDst, &amp;rcVis);
00287 
00288         <span class="comment">/*</span>
00289 <span class="comment">         * Src = Src &amp; Vis.</span>
00290 <span class="comment">         */</span>
00291         fSrcNotEmpty = <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcSrc, &amp;rcSrc, &amp;rcVis);
00292 
00293         <span class="comment">/*</span>
00294 <span class="comment">         * Valid = Offset(Src, dx, dy) &amp; Dst.</span>
00295 <span class="comment">         */</span>
00296         <span class="keywordflow">if</span> (hrgnInvalid == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00297             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rcValid);
00298         } <span class="keywordflow">else</span> {
00299 
00300             rcValid.left   = rcSrc.left   + dx;
00301             rcValid.right  = rcSrc.right  + dx;
00302             rcValid.top    = rcSrc.top    + dy;
00303             rcValid.bottom = rcSrc.bottom + dy;
00304 
00305             <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcValid, &amp;rcValid, &amp;rcDst);
00306         }
00307 
00308         <span class="comment">/*</span>
00309 <span class="comment">         * Now calculate the update area.</span>
00310 <span class="comment">         *</span>
00311 <span class="comment">         * There are two cases where the result will be a rectangle:</span>
00312 <span class="comment">         *</span>
00313 <span class="comment">         * 1) The source rectangle lies completely within the visrgn,</span>
00314 <span class="comment">         *    and the source and destination don't overlap.  In this</span>
00315 <span class="comment">         *    case the update region is equal to the source rect.</span>
00316 <span class="comment">         *</span>
00317 <span class="comment">         * 2) The clipped source rectangle is empty, in which case</span>
00318 <span class="comment">         *    the update region is equal to the clipped dest rect.</span>
00319 <span class="comment">         *</span>
00320 <span class="comment">         * 3) We're scrolling in one dimension only, and the source</span>
00321 <span class="comment">         *    and destination DO overlap.  In this case we can use</span>
00322 <span class="comment">         *    UnionRect() and SubtractRect() to do the area arithmetic.</span>
00323 <span class="comment">         */</span>
00324         <span class="keywordflow">if</span> (!fSrcNotEmpty) {
00325 
00326             <span class="comment">/*</span>
00327 <span class="comment">             * Clipped source is empty.  Update area is the clipped dest.</span>
00328 <span class="comment">             */</span>
00329             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcUpdate, &amp;rcDst);
00330             <span class="keywordflow">goto</span> RectUpdate;
00331 
00332         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcUpdate, &amp;rcSrc, &amp;rcDst)) {
00333 
00334             <span class="comment">/*</span>
00335 <span class="comment">             * They overlap.  If we're scrolling in one dimension only</span>
00336 <span class="comment">             * then we can use rect arithmetic...</span>
00337 <span class="comment">             */</span>
00338             <span class="keywordflow">if</span> (dx == 0 || dy == 0) {
00339 
00340                 <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcUpdate, &amp;rcSrc, &amp;rcDst);
00341                 <a class="code" href="../../d3/d6/rect_8c.html#a11">SubtractRect</a>(&amp;rcUpdate, &amp;rcUpdate, &amp;rcValid);
00342                 <span class="keywordflow">goto</span> RectUpdate;
00343             }
00344 
00345         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;rcSrc, &amp;rcUnclippedSrc)) {
00346 
00347             <span class="comment">/*</span>
00348 <span class="comment">             * They don't overlap, and the source lies completely</span>
00349 <span class="comment">             * within the visible region.  Update region is the source.</span>
00350 <span class="comment">             */</span>
00351             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcUpdate, &amp;rcSrc);
00352 RectUpdate:
00353             <span class="keywordflow">if</span> (prcUpdate) {
00354                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(prcUpdate, &amp;rcUpdate);
00355             }
00356 
00357             <span class="keywordflow">if</span> (hrgnUpdate &amp;&amp; !<a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgnUpdate, &amp;rcUpdate)) {
00358                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00359             }
00360 
00361             wClip = SIMPLEREGION;
00362             <span class="keywordflow">if</span> (rcUpdate.left &gt;= rcUpdate.right ||
00363                 rcUpdate.top &gt;= rcUpdate.bottom)
00364 
00365                 wClip = NULLREGION;
00366 
00367             <span class="keywordflow">goto</span> DoRectBlt;
00368         }
00369 
00370         <span class="comment">/*</span>
00371 <span class="comment">         * The update region isn't rectangular.  Need to do our</span>
00372 <span class="comment">         * area calculations with region calls.  Skip all this</span>
00373 <span class="comment">         * if the caller doesn't care about the update region.</span>
00374 <span class="comment">         *</span>
00375 <span class="comment">         * If he wants a rectangle but no region, use ghrgnScrl2 as a temp.</span>
00376 <span class="comment">         */</span>
00377         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; prcUpdate) {
00378             hrgnUpdate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a200">ghrgnScrl2</a>;
00379         }
00380 
00381         <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00382 
00383             <span class="comment">/*</span>
00384 <span class="comment">             * hrgnUpdateCalc = (rcSrc | rcDst) - rcBltDst</span>
00385 <span class="comment">             */</span>
00386             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnScrl1, &amp;rcSrc);
00387             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgnUpdate, &amp;rcDst);
00388             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(hrgnUpdate, hrgnUpdate, ghrgnScrl1) == ERROR)
00389                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00390 
00391             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnScrl1, &amp;rcValid);
00392             wClip = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnUpdate, hrgnUpdate, ghrgnScrl1);
00393             <span class="keywordflow">if</span> (wClip == ERROR)
00394                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00395 
00396             <span class="keywordflow">if</span> (prcUpdate) {
00397                 GreGetRgnBox(hrgnUpdate, prcUpdate);
00398             }
00399         }
00400 
00401 DoRectBlt:
00402 
00403         <span class="comment">/*</span>
00404 <span class="comment">         * If the valid rectangle's not empty, then copy those bits...</span>
00405 <span class="comment">         */</span>
00406         <span class="keywordflow">if</span> (rcValid.left &lt; rcValid.right &amp;&amp; rcValid.top &lt; rcValid.bottom) {
00407 
00408             <span class="comment">/*</span>
00409 <span class="comment">             * If the DC is in a funny map mode, then be sure to map from</span>
00410 <span class="comment">             * device to logical coordinates for BLT call...</span>
00411 <span class="comment">             */</span>
00412             <span class="keywordflow">if</span> (fLogUnits)
00413                 GreDPtoLP(hdc, (LPPOINT)&amp;rcValid, 2);
00414 
00415             GreBitBlt(hdc,
00416                       rcValid.left,
00417                       rcValid.top,
00418                       rcValid.right - rcValid.left,
00419                       rcValid.bottom - rcValid.top,
00420                       hdc,
00421                       rcValid.left - dxLog,
00422                       rcValid.top - dyLog,
00423                       SRCCOPY,
00424                       0);
00425         }
00426 
00427     } <span class="keywordflow">else</span> {
00428 
00429         <span class="comment">/*</span>
00430 <span class="comment">         * Get the true visrgn if we haven't already.</span>
00431 <span class="comment">         */</span>
00432         <span class="keywordflow">if</span> (!fHaveVisRgn) {
00433 
00434             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d4/scrollw_8c.html#a0">GetTrueClipRgn</a>(hdc, ghrgnScrlVis) == ERROR)
00435                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00436 
00437             fHaveVisRgn = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00438         }
00439 
00440         <span class="comment">/*</span>
00441 <span class="comment">         * The visrgn is not empty.  Need to do all our calculations</span>
00442 <span class="comment">         * with regions.</span>
00443 <span class="comment">         *</span>
00444 <span class="comment">         * hrgnSrc = hrgnSrc &amp; ghrgnScrlVis</span>
00445 <span class="comment">         */</span>
00446         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnScrlSrc, &amp;rcSrc);
00447         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(ghrgnScrlSrc, ghrgnScrlSrc, ghrgnScrlVis) == ERROR)
00448             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00449 
00450         <span class="comment">/*</span>
00451 <span class="comment">         * hrgnDst = hrgnDst &amp; ghrgnScrlVis</span>
00452 <span class="comment">         */</span>
00453         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnScrlDst, &amp;rcDst);
00454         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(ghrgnScrlDst, ghrgnScrlDst, ghrgnScrlVis) == ERROR)
00455             <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00456 
00457         <span class="comment">/*</span>
00458 <span class="comment">         * Now compute the valid region:</span>
00459 <span class="comment">         *</span>
00460 <span class="comment">         * Valid = Offset(Src, dx, dy) &amp; Dst.</span>
00461 <span class="comment">         * Valid = Valid &amp; Invalid &amp; Offset(Invalid, dx, dy)</span>
00462 <span class="comment">         *</span>
00463 <span class="comment">         * If hrgnInvalid is (HRGN)1, then the valid area is empty.</span>
00464 <span class="comment">         */</span>
00465         wClipValid = NULLREGION;
00466         <span class="keywordflow">if</span> (hrgnInvalid != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00467 
00468             <span class="comment">/*</span>
00469 <span class="comment">             * Valid = Offset(Src, dx, dy) &amp; Dst</span>
00470 <span class="comment">             */</span>
00471             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(ghrgnScrlValid, ghrgnScrlSrc) == ERROR)
00472                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00473 
00474             GreOffsetRgn(ghrgnScrlValid, dx, dy);
00475             wClipValid = <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(ghrgnScrlValid,
00476                                       ghrgnScrlValid,
00477                                       ghrgnScrlDst);
00478 
00479             <span class="comment">/*</span>
00480 <span class="comment">             * Valid = Valid - Invalid - Offset(Invalid, dx, dy)</span>
00481 <span class="comment">             * We need bother only if hrgnInvalid is a real region.</span>
00482 <span class="comment">             */</span>
00483             <span class="keywordflow">if</span> (hrgnInvalid &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00484 
00485                 <span class="keywordflow">if</span> (wClipValid != ERROR &amp;&amp; wClipValid != NULLREGION) {
00486                     POINT pt;
00487 
00488                     <a class="code" href="../../d4/d1/userk_8h.html#a1708">GetDCOrgOnScreen</a>(hdc, &amp;pt);
00489             
00490                     <span class="comment">/*</span>
00491 <span class="comment">                     * hrgnInvalid is in screen coordinates: map to dc coords</span>
00492 <span class="comment">                     */</span>
00493                     <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(ghrgnScrl2, hrgnInvalid);
00494                     GreOffsetRgn(ghrgnScrl2, -pt.x, -pt.y);
00495 
00496                     wClipValid = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(ghrgnScrlValid,
00497                                              ghrgnScrlValid,
00498                                              ghrgnScrl2);
00499                 }
00500 
00501                 <span class="keywordflow">if</span> (wClipValid != ERROR &amp;&amp; wClipValid != NULLREGION) {
00502                     GreOffsetRgn(ghrgnScrl2, dx, dy);
00503 
00504                     wClipValid = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(ghrgnScrlValid,
00505                                              ghrgnScrlValid,
00506                                              ghrgnScrl2);
00507                 }
00508             }
00509 
00510             <span class="keywordflow">if</span> (wClipValid == ERROR)
00511                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00512         }
00513 
00514         <span class="comment">/*</span>
00515 <span class="comment">         * If he wants a rectangle but no region, use ghrgnScrl2 as a temp.</span>
00516 <span class="comment">         */</span>
00517         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; prcUpdate) {
00518             hrgnUpdate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a200">ghrgnScrl2</a>;
00519         }
00520 
00521         <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00522 
00523             <span class="comment">/*</span>
00524 <span class="comment">             * Update = (Src | Dst) - Valid.</span>
00525 <span class="comment">             */</span>
00526             wClip = <a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(hrgnUpdate, ghrgnScrlDst, ghrgnScrlSrc);
00527             <span class="keywordflow">if</span> (wClip == ERROR)
00528                 <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
00529 
00530             <span class="keywordflow">if</span> (wClipValid != NULLREGION) {
00531                 wClip = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnUpdate, hrgnUpdate, ghrgnScrlValid);
00532             }
00533 
00534             <span class="keywordflow">if</span> (prcUpdate) {
00535                 GreGetRgnBox(hrgnUpdate, prcUpdate);
00536             }
00537         }
00538 
00539         <span class="keywordflow">if</span> (wClipValid != NULLREGION) {
00540 
00541 <span class="preprocessor">            #ifdef LATER</span>
00542 <span class="preprocessor"></span>
00543                 <span class="comment">/*</span>
00544 <span class="comment">                 * don't use the visrgn here</span>
00545 <span class="comment">                 */</span>
00546                 HRGN hrgnSaveVis = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00547                 <span class="keywordflow">if</span> (hrgnSaveVis != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00548 
00549                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fClipped;
00550 
00551                     fClipped = (GreGetRandomRgn(hdc, hrgnSaveVis, 1) == 1);
00552                     GreExtSelectClipRgn(hdc, ghrgnScrlValid, RGN_COPY);
00553 
00554                     <span class="comment">/*</span>
00555 <span class="comment">                     * If the DC is in a funny map mode, then be sure to</span>
00556 <span class="comment">                     * map from device to logical coordinates for BLT call...</span>
00557 <span class="comment">                     */</span>
00558                     <span class="keywordflow">if</span> (fLogUnits)
00559                         GreDPtoLP(hdc, (LPPOINT)&amp;rcDst, 2);
00560 
00561                     <span class="comment">/*</span>
00562 <span class="comment">                     * Gdi can take along time to process this call if</span>
00563 <span class="comment">                     * it's a printer DC</span>
00564 <span class="comment">                     */</span>
00565                     GreBitBlt(hdc,
00566                               rcDst.left,
00567                               rcDst.top,
00568                               rcDst.right - rcDst.left,
00569                               rcDst.bottom - rcDst.top,
00570                               hdc,
00571                               rcDst.left - dxLog,
00572                               rcDst.top - dyLog,
00573                               SRCCOPY,
00574                               0);
00575 
00576                     GreExtSelectClipRgn(hdc,
00577                                         (fClipped ? hrgnSaveVis : NULL),
00578                                         RGN_COPY);
00579 
00580                     GreDeleteObject(hrgnSaveVis);
00581                 }
00582 
00583 <span class="preprocessor">            #else</span>
00584 <span class="preprocessor"></span>
00585                 <span class="comment">/*</span>
00586 <span class="comment">                 * Visrgn is expected in DC surface coordinates: offset</span>
00587 <span class="comment">                 * as appropriate.</span>
00588 <span class="comment">                 */</span>
00589                 POINT pt;
00590                 GreGetDCOrg(hdc, &amp;pt);
00591 
00592                 GreOffsetRgn(ghrgnScrlValid, pt.x, pt.y);
00593 
00594                 <span class="comment">/*</span>
00595 <span class="comment">                 * Select in the temporary vis rgn, saving the old</span>
00596 <span class="comment">                 */</span>
00597 
00598                 GreSelectVisRgn(hdc, ghrgnScrlValid, SVR_SWAP);
00599 
00600                 <span class="comment">/*</span>
00601 <span class="comment">                 * If the DC is in a funny map mode, then be sure to map from</span>
00602 <span class="comment">                 * device to logical coordinates for BLT call...</span>
00603 <span class="comment">                 */</span>
00604                 <span class="keywordflow">if</span> (fLogUnits)
00605                     GreDPtoLP(hdc, (LPPOINT)&amp;rcDst, 2);
00606 
00607                 <span class="comment">/*</span>
00608 <span class="comment">                 * Gdi can take along time to process this call if it's</span>
00609 <span class="comment">                 * a printer DC.</span>
00610 <span class="comment">                 */</span>
00611                 GreBitBlt(hdc,
00612                           rcDst.left,
00613                           rcDst.top,
00614                           rcDst.right - rcDst.left,
00615                           rcDst.bottom - rcDst.top,
00616                           hdc,
00617                           rcDst.left - dxLog,
00618                           rcDst.top - dyLog,
00619                           SRCCOPY,
00620                           0);
00621 
00622                 <span class="comment">/*</span>
00623 <span class="comment">                 * Restore the old vis rgn, leaving ghrgnScrlValid with</span>
00624 <span class="comment">                 * a valid rgn</span>
00625 <span class="comment">                 */</span>
00626                 GreSelectVisRgn(hdc, ghrgnScrlValid, SVR_SWAP);
00627 
00628 <span class="preprocessor">            #endif</span>
00629 <span class="preprocessor"></span>        }
00630     }
00631 
00632     <span class="comment">/*</span>
00633 <span class="comment">     * If necessary, convert the resultant update rect back</span>
00634 <span class="comment">     * to logical coordinates.</span>
00635 <span class="comment">     */</span>
00636     <span class="keywordflow">if</span> (fLogUnits &amp;&amp; prcUpdate) {
00637         GreDPtoLP(hdc, (LPPOINT)prcUpdate, 2);
00638     }
00639 
00640     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00641 
00642     <span class="keywordflow">return</span> wClip;
00643 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="scrollw.c::xxxScrollWindowEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int xxxScrollWindowEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dx</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>dy</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>RECT *&nbsp;</td>
          <td class="mdname" nowrap> <em>prcScroll</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>RECT *&nbsp;</td>
          <td class="mdname" nowrap> <em>prcClip</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnUpdate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPRECT&nbsp;</td>
          <td class="mdname" nowrap> <em>prcUpdate</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00741">741</a> of file <a class="el" href="../../d0/d4/scrollw_8c-source.html">scrollw.c</a>.
<p>
References <a class="el" href="../../d9/d2/dc_8c-source.html#l00608">_GetDCEx()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00513">_IsDescendant()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00183">_ReleaseDC()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03657">AnySpbs</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03124">tagQ::caret</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01593">CFCLASSDC</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01592">CFOWNDC</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00073">CopyOffsetRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00243">CopyRect</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02217">CopyRgn</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03081">tagCARET::cx</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03080">tagCARET::cy</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/aug98_2dll32_2icmdll_8h-source.html#l00010">FAR</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l02066">GetDCOrgOnScreen()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00856">GetRect()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00511">ghrgnSW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03420">GRECT_CLIENT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03424">GRECT_CLIENTCOORDS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01757">tagWND::hrgnUpdate</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02233">IDC_CHILDRENONLY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02234">IDC_CLIENTONLY</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d0/d4/scrollw_8c-source.html#l00067">InternalScrollDC()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d3/d7/rtl_2winmgr_8c-source.html#l00537">IsVisible()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06472">IsWinEventNotifyDeferredOK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l05543">OffsetChildren()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00139">OffsetRect()</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a1091">PCARET</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03321">tagTHREADINFO::pq</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01839">tagWND::rcClient</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00097">SetEmptyRgn()</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00027">SetRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00245">SetRectEmpty</a>, <a class="el" href="../../d2/d3/spb_8c-source.html#l01081">SpbCheckRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02901">tagCARET::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01609">TestCF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01342">ThreadLockExchangeAlways()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01247">ThreadLockNever</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00241">UnionRect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02416">WFCLIPCHILDREN</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02420">WFMINIMIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02318">WFWIN31COMPAT</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03078">tagCARET::x</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l00299">xxxRedrawWindow()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00688">xxxSendMessage()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03079">tagCARET::y</a>, <a class="el" href="../../d5/d4/caret_8c-source.html#l00376">zzzInternalHideCaret()</a>, <a class="el" href="../../d5/d4/caret_8c-source.html#l00331">zzzInternalShowCaret()</a>, and <a class="el" href="../../d9/d2/dc_8c-source.html#l01812">zzzInvalidateDCCache()</a>.
<p>
<pre class="fragment"><div>00750 {
00751     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    code;
00752     HDC    hdc;
00753     <span class="keywordtype">int</span>    dxDev;
00754     <span class="keywordtype">int</span>    dyDev;
00755     RECT   rcSrcDev;
00756     RECT   rcSpb, rcSrc;
00757     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  flagsDCX;
00758     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fHideCaret;
00759     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fRcScroll = (prcScroll != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00760     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   fInvisible = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00761     <a class="code" href="../../d6/d9/structtagCARET.html">PCARET</a> pcaret;
00762     POINT  pt;
00763     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>     tlpwndChild;
00764     HRGN   hrgnInvalid;
00765     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00766 
00767     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00768     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00769 
00770 
00771     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00772         pwnd = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>;       <span class="comment">// pwndDesktop</span>
00773 
00774 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00775 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00776         dx = -dx;
00777 
00778         MirrorRegion(pwnd, hrgnUpdate, TRUE);
00779 
00780         <span class="keywordflow">if</span>(prcScroll) {
00781             MirrorRect(pwnd, prcScroll);
00782         }
00783 
00784         <span class="keywordflow">if</span> (prcClip) {
00785             MirrorRect(pwnd, prcClip);
00786         }
00787     }
00788 <span class="preprocessor">#endif</span>
00789 <span class="preprocessor"></span>
00790     <span class="comment">/*</span>
00791 <span class="comment">     * If nothing's moving, nothing to do.</span>
00792 <span class="comment">     */</span>
00793     <span class="keywordflow">if</span> ((dx | dy) == 0 ) {
00794 
00795         <span class="keywordflow">goto</span> DoNothing;
00796 
00797     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwnd)) {
00798 
00799         <span class="comment">/* We want to offset our children if we're not minimized.  IsVisible()</span>
00800 <span class="comment">         * will return FALSE if we're minimized, invisible, or the child of</span>
00801 <span class="comment">         * a minimized/invisible ancestore.</span>
00802 <span class="comment">         */</span>
00803         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFMINIMIZED) &amp;&amp;
00804           (flags &amp; SW_SCROLLCHILDREN) &amp;&amp;
00805           !fRcScroll) {
00806 
00807             fInvisible = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00808             flags &amp;= ~SW_INVALIDATE;
00809         }
00810 
00811 DoNothing:
00812 
00813         <span class="keywordflow">if</span> (hrgnUpdate) {
00814             <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgnUpdate);
00815         }
00816 
00817         <span class="keywordflow">if</span> (prcUpdate) {
00818             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(prcUpdate);
00819         }
00820 
00821         <span class="keywordflow">if</span> (!fInvisible)
00822             <span class="keywordflow">return</span> NULLREGION;
00823     }
00824 
00825     <span class="comment">/*</span>
00826 <span class="comment">     * Hide the caret.</span>
00827 <span class="comment">     */</span>
00828     fHideCaret = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00829 
00830     <span class="keywordflow">if</span> (!fInvisible) {
00831         pcaret = &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o18">caret</a>;
00832         <span class="keywordflow">if</span> (pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a5">_IsDescendant</a>(pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>, pwnd)) {
00833             fHideCaret = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00834             <a class="code" href="../../d4/d5/caret_8c.html#a6">zzzInternalHideCaret</a>();
00835         }
00836     }
00837 
00838     <span class="comment">/*</span>
00839 <span class="comment">     * If scrollwindow, and window is clipchildren, use a cache entry.</span>
00840 <span class="comment">     * Otherwise, always use a</span>
00841 <span class="comment">     *</span>
00842 <span class="comment">     * Determine what kind of DC we'll be needing.  If the DCX_CACHE bit</span>
00843 <span class="comment">     * isn't set, it means that we'll be operating in logical coordinates.</span>
00844 <span class="comment">     */</span>
00845     <span class="keywordflow">if</span> (flags &amp; SW_SCROLLWINDOW) {
00846 
00847         <span class="comment">/*</span>
00848 <span class="comment">         *  ScrollWindow() call: use the cache if not OWNDC or CLASSDC.</span>
00849 <span class="comment">         */</span>
00850         flagsDCX = DCX_USESTYLE;
00851         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, CFOWNDC) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, CFCLASSDC))
00852             flagsDCX |= DCX_CACHE;
00853 
00854         <span class="comment">/*</span>
00855 <span class="comment">         * If SW_SCROLLCHILDREN (i.e., lprcScroll == NULL) and CLIPCHILDREN,</span>
00856 <span class="comment">         * then use the cache and don't clip children.</span>
00857 <span class="comment">         * This is screwy, but 3.0 backward compatible.</span>
00858 <span class="comment">         */</span>
00859         <span class="keywordflow">if</span> ((flags &amp; SW_SCROLLCHILDREN) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCLIPCHILDREN))
00860             flagsDCX |= DCX_NOCLIPCHILDREN | DCX_CACHE;
00861 
00862     } <span class="keywordflow">else</span> {
00863 
00864         <span class="comment">/*</span>
00865 <span class="comment">         * ScrollWindowEx() call: always use the cache</span>
00866 <span class="comment">         */</span>
00867         flagsDCX = DCX_USESTYLE | DCX_CACHE;
00868 
00869         <span class="comment">/*</span>
00870 <span class="comment">         * if SW_SCROLLCHILDREN, always use noclipchildren.</span>
00871 <span class="comment">         */</span>
00872         <span class="keywordflow">if</span> (flags &amp; SW_SCROLLCHILDREN)
00873             flagsDCX |= DCX_NOCLIPCHILDREN;
00874     }
00875 
00876 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00877 <span class="preprocessor"></span>    flagsDCX |= DCX_NOMIRROR;
00878 <span class="preprocessor">#endif</span>
00879 <span class="preprocessor"></span>
00880     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, NULL, flagsDCX);
00881 
00882     <span class="keywordflow">if</span> (flags &amp; SW_INVALIDATE) {
00883 
00884         <span class="comment">/*</span>
00885 <span class="comment">         * Get device origin while DC is valid, for later offsetting</span>
00886 <span class="comment">         */</span>
00887         <a class="code" href="../../d4/d1/userk_8h.html#a1708">GetDCOrgOnScreen</a>(hdc, &amp;pt);
00888 
00889         <span class="comment">/*</span>
00890 <span class="comment">         * If the user didn't give us a region to use, use ghrgnSW.</span>
00891 <span class="comment">         */</span>
00892         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00893             hrgnUpdate = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a198">ghrgnSW</a>;
00894     }
00895 
00896     <span class="comment">/*</span>
00897 <span class="comment">     * The DC will be in some logical coordinate system if OWNDC or CLASSDC.</span>
00898 <span class="comment">     */</span>
00899     <span class="keywordflow">if</span> (!fRcScroll) {
00900         prcScroll = &amp;rcSrc;
00901 
00902         <span class="comment">/*</span>
00903 <span class="comment">         * IMPORTANT:</span>
00904 <span class="comment">         * We have to use CopyOffsetRect() here because GetClientRect() gives</span>
00905 <span class="comment">         * unreliable results for minimized windows.  3.1 dudes get told that</span>
00906 <span class="comment">         * their client is non-empty, for compatibility reasons.</span>
00907 <span class="comment">         */</span>
00908         <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a12">GetRect</a>(pwnd, &amp;rcSrc, GRECT_CLIENT | GRECT_CLIENTCOORDS);
00909 
00910         <span class="comment">/*</span>
00911 <span class="comment">         * If the DC might be a screwy one, then map the</span>
00912 <span class="comment">         * rect to logical units.</span>
00913 <span class="comment">         */</span>
00914         <span class="keywordflow">if</span> (!(flagsDCX &amp; DCX_CACHE))
00915             GreDPtoLP(hdc, (LPPOINT)&amp;rcSrc, 2);
00916     }
00917 
00918     <span class="comment">/*</span>
00919 <span class="comment">     * If the DC is in logical coordinates, map *prcScroll and dx, dy</span>
00920 <span class="comment">     * to device units for use later.</span>
00921 <span class="comment">     */</span>
00922     dxDev = dx;
00923     dyDev = dy;
00924     rcSrcDev = *prcScroll;
00925 
00926     <span class="keywordflow">if</span> (!(flagsDCX &amp; DCX_CACHE)) {
00927 
00928         POINT rgpt[2];
00929 
00930         GreLPtoDP(hdc, (POINT FAR*)&amp;rcSrcDev, 2);
00931 
00932         <span class="comment">/*</span>
00933 <span class="comment">         * The delta values must be treated as a vector from</span>
00934 <span class="comment">         * the point (0, 0) to (dx, dy).  Scale it as such, then</span>
00935 <span class="comment">         * compute the difference.  This handles flipped coordinate systems.</span>
00936 <span class="comment">         */</span>
00937         rgpt[0].x = rgpt[0].y = 0;
00938         rgpt[1].x = dx;
00939         rgpt[1].y = dy;
00940 
00941         GreLPtoDP(hdc, rgpt, 2);
00942 
00943         dxDev = rgpt[1].x - rgpt[0].x;
00944         dyDev = rgpt[1].y - rgpt[0].y;
00945     }
00946 
00947     <span class="keywordflow">if</span> (fInvisible)
00948         code = NULLREGION;
00949     <span class="keywordflow">else</span> {
00950         hrgnInvalid = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>;
00951         <span class="keywordflow">if</span> ((flags &amp; SW_SCROLLWINDOW) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWIN31COMPAT)) {
00952             <span class="comment">/*</span>
00953 <span class="comment">             * 3.0 Backward compatibility hack:</span>
00954 <span class="comment">             * The following incorrect code is what 3.0 used to do, and</span>
00955 <span class="comment">             * there are apps such as Finale and Scrapbook+ that have worked</span>
00956 <span class="comment">             * around this bug in ways that don't work with the "correct" code.</span>
00957 <span class="comment">             */</span>
00958             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00959                 RECT rc;
00960 
00961                 GreGetRgnBox(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>, &amp;rc);
00962                 <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc,
00963                            dxDev - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
00964                            dyDev - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00965 
00966                 <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(pwnd,
00967                                 &amp;rc, NULL,
00968                                 RDW_INVALIDATE | RDW_ERASE | RDW_ALLCHILDREN);
00969             }
00970             hrgnInvalid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00971         }
00972 
00973         code = <a class="code" href="../../d9/d4/scrollw_8c.html#a1">InternalScrollDC</a>(hdc,
00974                                 dx,
00975                                 dy,
00976                                 prcScroll,
00977                                 prcClip,
00978                                 hrgnInvalid,
00979                                 hrgnUpdate,
00980                                 prcUpdate,
00981                                 !(flagsDCX &amp; DCX_CACHE));
00982 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00983 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (prcUpdate &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00984             MirrorRect(pwnd, prcUpdate);
00985         }
00986 <span class="preprocessor">#endif</span>
00987 <span class="preprocessor"></span>    }
00988 
00989     <span class="comment">/*</span>
00990 <span class="comment">     * Release the hdc we used.</span>
00991 <span class="comment">     */</span>
00992     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00993 
00994     <span class="comment">/*</span>
00995 <span class="comment">     * Check the union of the src and dst rectangle against any SPBs.</span>
00996 <span class="comment">     * We do this because the window</span>
00997 <span class="comment">     * might be completely obscured by some window with an SPB, but</span>
00998 <span class="comment">     * since we're completely covered no BitBlt call will be made</span>
00999 <span class="comment">     * to accumulate bounds in that area.</span>
01000 <span class="comment">     */</span>
01001     <span class="keywordflow">if</span> (!fInvisible &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
01002 
01003         <span class="keywordflow">if</span> (fRcScroll) {
01004             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01005                 rcSrc = rcSrcDev;
01006             } <span class="keywordflow">else</span> {
01007                 <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(
01008                         &amp;rcSrc,
01009                         &amp;rcSrcDev,
01010                         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
01011                         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
01012             }
01013 
01014             rcSpb = rcSrc;
01015             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rcSpb, dxDev, dyDev);
01016             <a class="code" href="../../d3/d6/rect_8c.html#a9">UnionRect</a>(&amp;rcSpb, &amp;rcSpb, &amp;rcSrc);
01017 
01018         } <span class="keywordflow">else</span> {
01019 
01020             <span class="comment">/*</span>
01021 <span class="comment">             * Use the entire client area.</span>
01022 <span class="comment">             */</span>
01023             rcSpb = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
01024         }
01025 
01026         <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;rcSpb, 0);
01027     }
01028 
01029     <span class="comment">/*</span>
01030 <span class="comment">     * If this guy wants to scroll his children, go at it.  Only scroll those</span>
01031 <span class="comment">     * children intersecting prcScroll.  Then invalidate any vis rgns</span>
01032 <span class="comment">     * calculated for these child windows.</span>
01033 <span class="comment">     */</span>
01034     <span class="keywordflow">if</span> (flags &amp; SW_SCROLLCHILDREN) {
01035 
01036         RECT rc;
01037 
01038         <span class="comment">/*</span>
01039 <span class="comment">         * If this window has the caret then offset it if:</span>
01040 <span class="comment">         * a) The whole window is scrolling</span>
01041 <span class="comment">         * b) The rectangle scrolled contains the caret rectangle</span>
01042 <span class="comment">         */</span>
01043         <span class="keywordflow">if</span> (!fInvisible &amp;&amp; (pwnd == pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o0">spwnd</a>)) {
01044 
01045             <span class="keywordflow">if</span> (fRcScroll)
01046                 <a class="code" href="../../d3/d6/rect_8c.html#a1">SetRect</a>(&amp;rc,
01047                         pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o4">x</a>,
01048                         pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o5">y</a>,
01049                         pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o4">x</a> + pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o7">cx</a>,
01050                         pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o5">y</a> + pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o6">cy</a>);
01051 
01052             <span class="keywordflow">if</span> (!fRcScroll || <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;rcSrcDev)) {
01053                 pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o4">x</a> += dxDev;
01054                 pcaret-&gt;<a class="code" href="../../d6/d9/structtagCARET.html#o5">y</a> += dyDev;
01055             }
01056         }
01057 
01058         <span class="keywordflow">if</span> (fRcScroll) {
01059 
01060             <span class="comment">/*</span>
01061 <span class="comment">             * Create a copy of prcScroll and map to absolute coordinates...</span>
01062 <span class="comment">             */</span>
01063             <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01064                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;rcSrcDev);
01065             } <span class="keywordflow">else</span> {
01066                 <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(
01067                         &amp;rc,
01068                         &amp;rcSrcDev,
01069                         pwnd-&gt;rcClient.left,
01070                         pwnd-&gt;rcClient.top);
01071             }
01072         }
01073 
01074         <span class="keywordflow">if</span> (pwnd-&gt;spwndChild) {
01075 
01076             <a class="code" href="../../d4/d1/userk_8h.html#a1507">OffsetChildren</a>(pwnd,
01077                            dxDev,
01078                            dyDev,
01079                            (fRcScroll ? (LPRECT)&amp;rc : NULL));
01080 
01081             <span class="comment">/*</span>
01082 <span class="comment">             * If we're clipchildren, then shuffling our children</span>
01083 <span class="comment">             * will affect our client visrgn (but not our window visrgn).</span>
01084 <span class="comment">             * Otherwise, only our children's</span>
01085 <span class="comment">             * visrgns were affected by the scroll.</span>
01086 <span class="comment">             * No need to DeferWinEventNotify() judging by xxxInternalInvalidate() below</span>
01087 <span class="comment">             */</span>
01088             <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(pwnd,
01089                               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCLIPCHILDREN) ?
01090                                   IDC_CLIENTONLY : IDC_CHILDRENONLY);
01091 
01092         }
01093     }
01094 
01095     <span class="keywordflow">if</span> (flags &amp; SW_INVALIDATE) {
01096 
01097         <span class="comment">/*</span>
01098 <span class="comment">         * If the caller supplied a region, invalidate using a copy,</span>
01099 <span class="comment">         * because InternalInvalidate may trash the passed-in region.</span>
01100 <span class="comment">         */</span>
01101         <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a198">ghrgnSW</a>)
01102             <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(ghrgnSW, hrgnUpdate);
01103 
01104         <span class="comment">/*</span>
01105 <span class="comment">         * Make ghrgnSW screen-relative before invalidation...</span>
01106 <span class="comment">         */</span>
01107         GreOffsetRgn(ghrgnSW, pt.x, pt.y);
01108 
01109         <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(
01110                 pwnd,
01111                 ghrgnSW,
01112                 (flags &amp; SW_ERASE) ?
01113                     (RDW_INVALIDATE | RDW_ALLCHILDREN | RDW_ERASE) :
01114                     (RDW_INVALIDATE | RDW_ALLCHILDREN));
01115     }
01116 
01117     <span class="comment">/*</span>
01118 <span class="comment">     * Send child move messages if needed.</span>
01119 <span class="comment">     */</span>
01120     <span class="keywordflow">if</span> (flags &amp; SW_SCROLLCHILDREN) {
01121 
01122         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndChild;
01123         RECT rc;
01124         RECT rcScrolledChildren;
01125 
01126         <span class="comment">/*</span>
01127 <span class="comment">         * NOTE: the following code will send MOVE messages</span>
01128 <span class="comment">         * to windows that didn't move but were in the source rectangle.</span>
01129 <span class="comment">         * This is not a big deal, and definitely not worth fixing.</span>
01130 <span class="comment">         */</span>
01131         <span class="keywordflow">if</span> (fRcScroll) {
01132             <span class="keywordflow">if</span> (pwnd-&gt;spwndParent == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01133                 <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rcScrolledChildren, &amp;rcSrcDev, dxDev, dyDev);
01134             } <span class="keywordflow">else</span> {
01135                 <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(
01136                         &amp;rcScrolledChildren,
01137                         &amp;rcSrcDev,
01138                         dxDev + pwnd-&gt;spwndParent-&gt;rcClient.left,
01139                         dyDev + pwnd-&gt;spwndParent-&gt;rcClient.top);
01140             }
01141         }
01142 
01143         <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwndChild);
01144         pwndChild = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01145         <span class="keywordflow">while</span> (pwndChild != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01146 
01147             <span class="keywordflow">if</span> (    !fRcScroll ||
01148                     <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rcScrolledChildren, &amp;pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
01149 
01150                 <span class="comment">/*</span>
01151 <span class="comment">                 * NOTE: Win 3.0 and below passed wParam == TRUE here.</span>
01152 <span class="comment">                 * This was not documented or used, so it was changed</span>
01153 <span class="comment">                 * to be consistent with the documentation.</span>
01154 <span class="comment">                 */</span>
01155                 <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwndChild, &amp;tlpwndChild);
01156                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(
01157                         pwndChild,
01158                         WM_MOVE,
01159                         0,
01160                         (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) ?
01161                             MAKELONG(pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top) :
01162                             MAKELONG(pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left - pwnd-&gt;rcClient.left,
01163                                      pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top - pwnd-&gt;rcClient.top));
01164             }
01165 
01166             pwndChild = pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01167         }
01168 
01169         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
01170     }
01171 
01172     <span class="keywordflow">if</span> (fHideCaret) {
01173 
01174         <span class="comment">/*</span>
01175 <span class="comment">         * Show the caret again.</span>
01176 <span class="comment">         */</span>
01177         <a class="code" href="../../d4/d5/caret_8c.html#a5">zzzInternalShowCaret</a>();
01178     }
01179 
01180     <span class="comment">/*</span>
01181 <span class="comment">     * Return the region code.</span>
01182 <span class="comment">     */</span>
01183     <span class="keywordflow">return</span> code;
01184 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
