<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: vdmints.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>vdmints.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include "<a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html">vdmp.h</a>"</code><br>

<p>
<a href="../../d0/d4/vdmints_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a0">VDM_HWINT_INCREMENT</a>&nbsp;&nbsp;&nbsp;EVENT_INCREMENT</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a3">VdmpQueueIntApcRoutine</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a4">VdmpQueueIntNormalRoutine</a> (IN PVOID NormalContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a5">VdmpDelayIntDpcRoutine</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a6">VdmpDelayIntApcRoutine</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a7">RestartDelayedInterrupts</a> (PVDMICAUSERDATA pIcaUserData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a8">IcaScan</a> (PVDMICAUSERDATA pIcaUserData, PVDMVIRTUALICA pIcaAdapter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a9">IcaAccept</a> (PVDMICAUSERDATA pIcaUserData, PVDMVIRTUALICA pIcaAdapter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a10">GetIretHookAddress</a> (PKTRAP_FRAME TrapFrame, PVDMICAUSERDATA pIcaUserData, int IrqNum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a11">PushRmInterrupt</a> (PKTRAP_FRAME TrapFrame, ULONG IretHookAddress, <a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib, ULONG InterruptNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a12">PushPmInterrupt</a> (PKTRAP_FRAME TrapFrame, ULONG IretHookAddress, <a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib, ULONG InterruptNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a13">VdmpNullRundownRoutine</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a> (IN PEXCEPTION_POINTERS ExceptionInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a15">VdmpQueueInterrupt</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a16">VdmDispatchInterrupts</a> (PKTRAP_FRAME TrapFrame, <a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a> VdmTib)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a17">VdmpDelayInterrupt</a> (PVDMDELAYINTSDATA pdsd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a18">VdmpDispatchableIntPending</a> (ULONG EFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a19">VdmpIsThreadTerminating</a> (HANDLE ThreadId)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a1">ExSemaphoreObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d4/vdmints_8c.html#a2">ExEventObjectType</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="vdmints.c::VDM_HWINT_INCREMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define VDM_HWINT_INCREMENT&nbsp;&nbsp;&nbsp;EVENT_INCREMENT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00031">31</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a10" doxytag="vdmints.c::GetIretHookAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG GetIretHookAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVDMICAUSERDATA&nbsp;</td>
          <td class="mdname" nowrap> <em>pIcaUserData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>IrqNum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00897">897</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.
<p>
<pre class="fragment"><div>00904                    :
00905 
00906     Retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IretHookAddress from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real mode\protect mode
00907     iret hook bop table. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equivalent to
00908     softpc\base\system\ica.c - ica_iret_hook_needed()
00909 
00910 Arguments:
00911 
00912     TrapFrame       - address of current trapframe
00913     pIcaUserData    - addr of ica data
00914     IrqNum          - IrqLineNum
00915 
00916 Return Value:
00917 
00918     ULONG IretHookAddress. seg:offset or sel:offset Iret Hook,
00919                            0 if none
00920 --*/
00921 {
00922     ULONG  IrqMask;
00923     ULONG  AddrBopTable;
00924     <span class="keywordtype">int</span>    IretBopSize;
00925 
00926     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00927 
00928     IrqMask = 1 &lt;&lt; IrqNum;
00929     <span class="keywordflow">if</span> (!(IrqMask &amp; *pIcaUserData-&gt;pIretHooked) ||
00930         !*pIcaUserData-&gt;pAddrIretBopTable )
00931       {
00932         <span class="keywordflow">return</span> 0;
00933         }
00934 
00935     <span class="keywordflow">if</span> (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) {
00936         AddrBopTable = *pIcaUserData-&gt;pAddrIretBopTable;
00937         IretBopSize  = VDM_RM_IRETBOPSIZE;
00938         }
00939     <span class="keywordflow">else</span> {
00940         AddrBopTable = (VDM_PM_IRETBOPSEG &lt;&lt; 16) | VDM_PM_IRETBOPOFF;
00941         IretBopSize  = VDM_PM_IRETBOPSIZE;
00942         }
00943 
00944     *pIcaUserData-&gt;pDelayIret |= IrqMask;
00945 
00946     <span class="keywordflow">return</span> AddrBopTable + IretBopSize * IrqNum;
00947 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="vdmints.c::IcaAccept" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int IcaAccept           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMICAUSERDATA&nbsp;</td>
          <td class="mdname" nowrap> <em>pIcaUserData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVDMVIRTUALICA&nbsp;</td>
          <td class="mdname" nowrap> <em>pIcaAdapter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00831">831</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00750">IcaScan()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.
<p>
<pre class="fragment"><div>00837                    :
00838 
00839    Does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> equivalent of a cpu IntAck cycle retrieving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Irql Line Num
00840    <span class="keywordflow">for</span> interrupt dispatch, and setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ica state to reflect that
00841    <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interrupt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in service.
00842 
00843    Similar to softpc\base\system\ica.c - ica_accept() scan_irr(),
00844    except that this code rejects interrupt dispatching if the ica
00845    is in Auto-EOI as this may involve a new interrupt cycle, and
00846    eoi hooks to be activated.
00847 
00848 Arguments:
00849     PVDMICAUSERDATA  pIcaUserData   - addr of ica userdata
00850     PVDMVIRTUALICA   pIcaAdapter    - addr of ica adapter
00851 
00852 
00853 Return Value:
00854 
00855     ULONG IrqLineNum for the specific adapter (0 to 7)
00856     returns -1 if there are no interrupts to generate (spurious ints
00857                are normally done on line 7
00858 
00859 --*/
00860 {
00861     <span class="keywordtype">int</span> line;
00862     UCHAR bit;
00863 
00864     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00865 
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Drop the INT line, and scan the ica</span>
00869     <span class="comment">//</span>
00870     pIcaAdapter-&gt;ica_cpu_int = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00871 
00872     line = <a class="code" href="../../d9/d4/vdmints_8c.html#a8">IcaScan</a>(pIcaUserData, pIcaAdapter);
00873 
00874     <span class="keywordflow">if</span> (line &lt; 0) {
00875         <span class="keywordflow">return</span> -1;
00876         }
00877 
00878     bit = (1 &lt;&lt; line);
00879     pIcaAdapter-&gt;ica_isr |= bit;
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">// decrement the count and clear the IRR bit</span>
00883         <span class="comment">// ensure the count doesn't wrap past zero.</span>
00884         <span class="comment">//</span>
00885     <span class="keywordflow">if</span> (--(pIcaAdapter-&gt;ica_count[line]) &lt;= 0)  {
00886         pIcaAdapter-&gt;ica_irr &amp;= ~bit;
00887         pIcaAdapter-&gt;ica_count[line] = 0;
00888         }
00889 
00890 
00891     <span class="keywordflow">return</span>(line);
00892 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="vdmints.c::IcaScan" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int IcaScan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMICAUSERDATA&nbsp;</td>
          <td class="mdname" nowrap> <em>pIcaUserData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVDMVIRTUALICA&nbsp;</td>
          <td class="mdname" nowrap> <em>pIcaAdapter</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00750">750</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00831">IcaAccept()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00715">RestartDelayedInterrupts()</a>.
<p>
<pre class="fragment"><div>00756                    :
00757 
00758    Similar to softpc\base\system\ica.c - scan_irr(),
00759 
00760    Check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRR, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IMR and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ISR to determine which interrupt
00761    should be delivered.
00762 
00763    <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> bit set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRR will generate an interrupt <span class="keywordflow">if</span>:
00764      IMR bit, DelayIret bit, DelayIrq bit AND ISR higher priority bits
00765      are clear (unless Special Mask Mode, in which <span class="keywordflow">case</span> ISR is ignored)
00766 
00767    If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no bit set, then <span class="keywordflow">return</span> -1
00768 
00769 
00770 Arguments:
00771     PVDMICAUSERDATA  pIcaUserData   - addr of ica userdata
00772     PVDMVIRTUALICA   pIcaAdapter    - addr of ica adapter
00773 
00774 
00775 Return Value:
00776 
00777     <span class="keywordtype">int</span> IrqLineNum <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specific adapter (0 to 7)
00778     -1 <span class="keywordflow">for</span> none
00779 
00780 --*/
00781 {
00782    <span class="keywordtype">int</span>   i,line;
00783    UCHAR bit;
00784    ULONG IrrImrDelay;
00785    ULONG ActiveIsr;
00786 
00787    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00788 
00789    IrrImrDelay = *pIcaUserData-&gt;pDelayIrq | *pIcaUserData-&gt;pDelayIret;
00790    <span class="keywordflow">if</span> (pIcaAdapter == pIcaUserData-&gt;pIcaSlave) {
00791        IrrImrDelay &gt;&gt;= 8;
00792        }
00793 
00794    IrrImrDelay = pIcaAdapter-&gt;ica_irr &amp; ~(pIcaAdapter-&gt;ica_imr | (UCHAR)IrrImrDelay);
00795 
00796    <span class="keywordflow">if</span> (IrrImrDelay)  {
00797 
00798         <span class="comment">/*</span>
00799 <span class="comment">         * Does the current mode require the ica to prevent</span>
00800 <span class="comment">         * interrupts if that line is still active (ie in the isr)?</span>
00801 <span class="comment">         *</span>
00802 <span class="comment">         * Normal Case: Used by DOS and Win3.1/S the isr prevents interrupts.</span>
00803 <span class="comment">         * Special Mask Mode, Special Fully Nested Mode do not block</span>
00804 <span class="comment">         * interrupts using bits in the isr. SMM is the mode used</span>
00805 <span class="comment">         * by Windows95 and Win3.1/E.</span>
00806 <span class="comment">         *</span>
00807 <span class="comment">         */</span>
00808        ActiveIsr = (pIcaAdapter-&gt;ica_mode &amp; (ICA_SMM|ICA_SFNM))
00809                       ? 0 : pIcaAdapter-&gt;ica_isr;
00810 
00811        <span class="keywordflow">for</span>(i = 0; i &lt; 8; i++)  {
00812            line = (pIcaAdapter-&gt;ica_hipri + i) &amp; 7;
00813            bit = 1 &lt;&lt; line;
00814            <span class="keywordflow">if</span> (ActiveIsr &amp; bit) {
00815                <span class="keywordflow">break</span>;            <span class="comment">/* No nested interrupt possible */</span>
00816                }
00817 
00818            <span class="keywordflow">if</span> (IrrImrDelay &amp; bit) {
00819                <span class="keywordflow">return</span> line;
00820                }
00821            }
00822        }
00823 
00824   <span class="keywordflow">return</span> -1;
00825 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="vdmints.c::PushPmInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PushPmInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IretHookAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VdmTib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InterruptNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01045">1045</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00047">_Vdm_InterruptHandler::CsSelector</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00048">_Vdm_InterruptHandler::Eip</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00055">_Vdm_Tib::Flags</a>, <a class="el" href="../../d8/d4/vdmint21_8c.html#a6">Ki386GetSelectorParameters()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00073">SEL_TYPE_2GIG</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00071">SEL_TYPE_BIG</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00072">SEL_TYPE_ED</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00056">_Vdm_Tib::VdmInterruptHandlers</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.
<p>
<pre class="fragment"><div>01053                    :
01054 
01055     Pushes ProtectMode interrupt frame onto <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> stack in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TrapFrame
01056     Raises an exception <span class="keywordflow">if</span> an invalid stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found
01057 
01058 Arguments:
01059 
01060     TrapFrame       - address of current trapframe
01061     IretHookAddress - address of Iret Hook, 0 <span class="keywordflow">if</span> none
01062     VdmTib          - address of current vdm tib
01063     InterruptNumber - interrupt number to reflect
01064 
01065 Return Value:
01066 
01067     None.
01068 
01069 --*/
01070 {
01071     ULONG   Flags,Base,Limit;
01072     ULONG   VdmSp, VdmSpOrg;
01073     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> VdmStackPointer;
01074     ULONG   StackOffset;
01075     BOOLEAN Frame32 = (BOOLEAN) VdmTib-&gt;DpmiInfo.<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o1">Flags</a>;
01076 
01077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01078 
01079     <span class="comment">//</span>
01080     <span class="comment">// Switch to "locked" dpmi stack if lock count is zero</span>
01081     <span class="comment">// This emulates the win3.1 Begin_Use_Locked_PM_Stack function.</span>
01082     <span class="comment">//</span>
01083 
01084     <span class="keywordflow">if</span> (!VdmTib-&gt;DpmiInfo.LockCount++) {
01085         VdmTib-&gt;DpmiInfo.SaveEsp        = TrapFrame-&gt;HardwareEsp;
01086         VdmTib-&gt;DpmiInfo.SaveEip        = TrapFrame-&gt;Eip;
01087         VdmTib-&gt;DpmiInfo.SaveSsSelector = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;HardwareSegSs;
01088         TrapFrame-&gt;HardwareEsp       = 0x1000;
01089         TrapFrame-&gt;HardwareSegSs     = (ULONG) VdmTib-&gt;DpmiInfo.SsSelector | 0x7;
01090     }
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// Use Sp or Esp ?</span>
01094     <span class="comment">//</span>
01095     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/vdmint21_8c.html#a6">Ki386GetSelectorParameters</a>((USHORT)TrapFrame-&gt;HardwareSegSs,
01096                                    &amp;Flags, &amp;Base, &amp;Limit))
01097        {
01098         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01099         }
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Adjust the limit for page granularity</span>
01103     <span class="comment">//</span>
01104     Limit++;
01105     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a10">SEL_TYPE_2GIG</a>) {
01106         Limit = (Limit &lt;&lt; 12) | 0xfff;
01107         }
01108 
01109     VdmSp = (Flags &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a8">SEL_TYPE_BIG</a>) ? TrapFrame-&gt;HardwareEsp
01110                                    : (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;HardwareEsp;
01111 
01112     <span class="comment">//</span>
01113     <span class="comment">// Get pointer to current stack</span>
01114     <span class="comment">//</span>
01115     VdmStackPointer = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(Base + VdmSp);
01116 
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Create enough room for iret hook frame</span>
01120     <span class="comment">//</span>
01121     VdmSpOrg = VdmSp;
01122     <span class="keywordflow">if</span> (IretHookAddress) {
01123         <span class="keywordflow">if</span> (Frame32) {
01124             VdmSp -= 3*<span class="keyword">sizeof</span>(ULONG);
01125         } <span class="keywordflow">else</span> {
01126             VdmSp -= 3*<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
01127         }
01128     }
01129 
01130     <span class="comment">//</span>
01131     <span class="comment">// Create enough room for 2 iret frames</span>
01132     <span class="comment">//</span>
01133 
01134     <span class="keywordflow">if</span> (Frame32) {
01135         VdmSp -= 6*<span class="keyword">sizeof</span>(ULONG);
01136     } <span class="keywordflow">else</span> {
01137         VdmSp -= 6*<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>);
01138     }
01139 
01140     <span class="comment">//</span>
01141     <span class="comment">// Set Final Value of Sp\Esp, do this before checking stack</span>
01142     <span class="comment">// limits so that invalid esp is visible to debuggers</span>
01143     <span class="comment">//</span>
01144     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a8">SEL_TYPE_BIG</a>) {
01145         TrapFrame-&gt;HardwareEsp = VdmSp;
01146         }
01147     <span class="keywordflow">else</span> {
01148         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;HardwareEsp = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)VdmSp;
01149         }
01150 
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// Check stack limits</span>
01154     <span class="comment">// If any of the following conditions are TRUE</span>
01155     <span class="comment">//    - New stack pointer wraps (not enuf space)</span>
01156     <span class="comment">//    - If normal stack and Sp not below limit</span>
01157     <span class="comment">//    - If Expand Down stack and Sp not above limit</span>
01158     <span class="comment">//</span>
01159     <span class="comment">// Then raise a Stack Fault</span>
01160     <span class="comment">//</span>
01161     <span class="keywordflow">if</span> ( VdmSp &gt;= VdmSpOrg ||
01162          !(Flags &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a9">SEL_TYPE_ED</a>) &amp;&amp; VdmSpOrg &gt; Limit ||
01163          (Flags &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a9">SEL_TYPE_ED</a>) &amp;&amp; VdmSp &lt; Limit )
01164        {
01165         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01166         }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Build the Hw Int iret frame</span>
01170     <span class="comment">//</span>
01171 
01172     <span class="keywordflow">if</span> (Frame32) {
01173 
01174        *(--(PULONG)VdmStackPointer)          = TrapFrame-&gt;EFlags;
01175        *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(--(PULONG)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;SegCs;
01176        *(--(PULONG)VdmStackPointer)          = TrapFrame-&gt;Eip;
01177        *(--(PULONG)VdmStackPointer)          = TrapFrame-&gt;EFlags &amp; ~EFLAGS_TF_MASK;
01178        *(--(PULONG)VdmStackPointer)          = VdmTib-&gt;DpmiInfo.DosxIntIretD &gt;&gt; 16;
01179        *(--(PULONG)VdmStackPointer)          = VdmTib-&gt;DpmiInfo.DosxIntIretD &amp; 0xffff;
01180 
01181     } <span class="keywordflow">else</span> {
01182 
01183        *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;EFlags;
01184        *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;SegCs;
01185        *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;Eip;
01186        *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(TrapFrame-&gt;EFlags &amp; ~EFLAGS_TF_MASK);
01187        *(--(PULONG)VdmStackPointer)          = VdmTib-&gt;DpmiInfo.DosxIntIret;
01188 
01189     }
01190 
01191     <span class="comment">//</span>
01192     <span class="comment">// Point cs and ip at interrupt handler</span>
01193     <span class="comment">//</span>
01194     TrapFrame-&gt;SegCs = VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o2">VdmInterruptHandlers</a>[InterruptNumber].<a class="code" href="../../d9/d5/struct__Vdm__InterruptHandler.html#o0">CsSelector</a> | 0x7;
01195     TrapFrame-&gt;Eip   = VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o2">VdmInterruptHandlers</a>[InterruptNumber].<a class="code" href="../../d9/d5/struct__Vdm__InterruptHandler.html#o1">Eip</a>;
01196 
01197     <span class="comment">//</span>
01198     <span class="comment">// Turn off trace bit so we don't trace the iret hook</span>
01199     <span class="comment">//</span>
01200     TrapFrame-&gt;EFlags &amp;= ~EFLAGS_TF_MASK;
01201 
01202     <span class="comment">//</span>
01203     <span class="comment">// Build the Irethook Iret frame, if one exists</span>
01204     <span class="comment">//</span>
01205     <span class="keywordflow">if</span> (IretHookAddress) {
01206         ULONG SegCs, Eip;
01207 
01208         <span class="comment">//</span>
01209         <span class="comment">// Point cs and eip at the iret hook, so when we build</span>
01210         <span class="comment">// the frame below, the correct contents are set</span>
01211         <span class="comment">//</span>
01212         SegCs = IretHookAddress &gt;&gt; 16;
01213         Eip   = IretHookAddress &amp; 0xFFFF;
01214 
01215         <span class="keywordflow">if</span> (Frame32) {
01216 
01217            *(--(PULONG)VdmStackPointer)          = TrapFrame-&gt;EFlags;
01218            *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(--(PULONG)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SegCs;
01219            *(--(PULONG)VdmStackPointer)          = Eip;
01220 
01221         } <span class="keywordflow">else</span> {
01222 
01223            *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;EFlags;
01224            *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SegCs;
01225            *(--(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)VdmStackPointer) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Eip;
01226 
01227         }
01228     }
01229     <span class="keywordflow">return</span> STATUS_SUCCESS;
01230 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="vdmints.c::PushRmInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PushRmInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IretHookAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VdmTib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InterruptNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00953">953</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00056">_Vdm_Tib::VdmInterruptHandlers</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.
<p>
<pre class="fragment"><div>00961                    :
00962 
00963     Pushes RealMode interrupt frame onto <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> stack in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TrapFrame
00964 
00965 Arguments:
00966 
00967     TrapFrame          - address of current trapframe
00968     IretHookAddress    - address of Iret Hook, 0 <span class="keywordflow">if</span> none
00969     VdmTib             - address of current vdm tib
00970     InterruptNumber    - interrupt number to reflect
00971 
00972 
00973 Return Value:
00974 
00975     None.
00976 
00977 --*/
00978 {
00979     ULONG      UserSS;
00980     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>     UserSP;
00981     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>     NewCS;
00982     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>     NewIP;
00983 
00984     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00985 
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">// Get pointers to current stack</span>
00989     <span class="comment">//</span>
00990     UserSS  = TrapFrame-&gt;HardwareSegSs &lt;&lt; 4;
00991     UserSP  = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;HardwareEsp;
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">//  load interrupt stack frame, pushing flags, Cs and ip</span>
00995     <span class="comment">//</span>
00996     UserSP -= 2;
00997     *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;EFlags;
00998     UserSP -= 2;
00999     *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;SegCs;
01000     UserSP -= 2;
01001     *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrapFrame-&gt;Eip;
01002 
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">// load IretHook stack frame if one exists</span>
01006     <span class="comment">//</span>
01007     <span class="keywordflow">if</span> (IretHookAddress) {
01008        UserSP -= 2;
01009        *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(TrapFrame-&gt;EFlags &amp; ~EFLAGS_TF_MASK);
01010        UserSP -= 2;
01011        *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(IretHookAddress &gt;&gt; 16);
01012        UserSP -= 2;
01013        *(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)(UserSS + UserSP) = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)IretHookAddress;
01014        }
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">//  Set new sp, ip, and cs.</span>
01018     <span class="comment">//</span>
01019 
01020     <span class="keywordflow">if</span> (VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o2">VdmInterruptHandlers</a>[InterruptNumber].Flags &amp; VDM_INT_HOOKED) {
01021         NewCS = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (VdmTib-&gt;DpmiInfo.DosxRmReflector &gt;&gt; 16);
01022         NewIP = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) VdmTib-&gt;DpmiInfo.DosxRmReflector;
01023         <span class="comment">//</span>
01024         <span class="comment">// now encode the interrupt number into CS</span>
01025         <span class="comment">//</span>
01026         NewCS -= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) InterruptNumber;
01027         NewIP += (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (InterruptNumber*16);
01028 
01029     } <span class="keywordflow">else</span> {
01030         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> pIvtEntry = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) (InterruptNumber * 4);
01031 
01032         NewIP = *pIvtEntry++;
01033         NewCS = *pIvtEntry;
01034     }
01035 
01036     TrapFrame-&gt;HardwareEsp =  UserSP;
01037     TrapFrame-&gt;Eip         =  NewIP;
01038     TrapFrame-&gt;SegCs       =  NewCS;
01039 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="vdmints.c::RestartDelayedInterrupts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int RestartDelayedInterrupts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMICAUSERDATA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pIcaUserData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00715">715</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00750">IcaScan()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>.
<p>
<pre class="fragment"><div>00718 {
00719    <span class="keywordtype">int</span> line;
00720 
00721 
00722    <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00723 
00724    *pIcaUserData-&gt;pUndelayIrq = 0;
00725 
00726    line = <a class="code" href="../../d9/d4/vdmints_8c.html#a8">IcaScan</a>(pIcaUserData, pIcaUserData-&gt;pIcaSlave);
00727    <span class="keywordflow">if</span> (line != -1) {
00728        <span class="comment">// set the slave</span>
00729        pIcaUserData-&gt;pIcaSlave-&gt;ica_int_line = line;
00730        pIcaUserData-&gt;pIcaSlave-&gt;ica_cpu_int = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00731 
00732        <span class="comment">// set the master cascade</span>
00733        line = pIcaUserData-&gt;pIcaSlave-&gt;ica_ssr;
00734        pIcaUserData-&gt;pIcaMaster-&gt;ica_irr |= 1 &lt;&lt; line;
00735        pIcaUserData-&gt;pIcaMaster-&gt;ica_count[line]++;
00736        }
00737 
00738    line = <a class="code" href="../../d9/d4/vdmints_8c.html#a8">IcaScan</a>(pIcaUserData, pIcaUserData-&gt;pIcaMaster);
00739    <span class="keywordflow">if</span> (line != -1) {
00740        pIcaUserData-&gt;pIcaMaster-&gt;ica_cpu_int = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00741        pIcaUserData-&gt;pIcaMaster-&gt;ica_int_line = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00742        }
00743 
00744    <span class="keywordflow">return</span> line;
00745 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="vdmints.c::VdmDispatchInterrupts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmDispatchInterrupts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VdmTib</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">477</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00036">_VdmEventInfo::Event</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00059">_Vdm_Tib::EventInfo</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00897">GetIretHookAddress()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00831">IcaAccept()</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00037">_VdmEventInfo::InstructionSize</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00459">KeBoostPriorityThread()</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02688">KeI386VdmIoplAllowed</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02689">KeI386VirtualIntExtensions</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01045">PushPmInterrupt()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00953">PushRmInterrupt()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00715">RestartDelayedInterrupts()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00031">VDM_HWINT_INCREMENT</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00004">VDM_VIRTUAL_INTERRUPTS</a>, <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00224">VdmEndExecution()</a>, <a class="el" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a11">VDMEVENTCLASS</a>, <a class="el" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a8">VdmpEnterIcaLock()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01996">VdmpExceptionHandler()</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a9">VdmpLeaveIcaLock()</a>, and <a class="el" href="../../d6/d5/vdmtrace_8c.html#a0">VdmTraceEvent()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00040">VdmpStartExecution()</a>.
<p>
<pre class="fragment"><div>00483                    :
00484 
00485     This routine dispatches interrupts to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vdm.
00486     Assumes that we are in application mode and NOT <a class="code" href="../../d0/d2/structtagMONITOR.html">MONITOR</a> context.
00487     This routine may <span class="keywordflow">switch</span> from application context back to monitor
00488     context, <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> cannot handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interrupt (Ica in AEOI, or timer
00489     <span class="keywordtype">int</span> pending).
00490 
00491 Arguments:
00492 
00493     TrapFrame address of current trapframe
00494     VdmTib    address of current vdm tib
00495 
00496 Return Value:
00497 
00498     None.
00499 
00500 --*/
00501 {
00502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00503     ULONG      IretHookAddress;
00504     ULONG      InterruptNumber;
00505     <span class="keywordtype">int</span>        IrqLineNum;
00506     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>     IcaRotate = 0;
00507     PVDMICAUSERDATA  pIcaUserData;
00508     PVDMVIRTUALICA   pIcaAdapter;
00509     <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a11">VDMEVENTCLASS</a>  VdmEvent = VdmMaxEvent;
00510 
00511     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00512 
00513     <span class="keywordflow">try</span> {
00514 
00515        <span class="comment">//</span>
00516        <span class="comment">// Probe pointers in IcaUserData which will be touched</span>
00517        <span class="comment">//</span>
00518        pIcaUserData = ((PVDM_PROCESS_OBJECTS)<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VdmObjects)
00519                       -&gt;pIcaUserData;
00520 
00521 
00522        <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(pIcaUserData-&gt;pAddrIretBopTable,
00523                      (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)
00524                          ? VDM_RM_IRETBOPSIZE*16 : VDM_PM_IRETBOPSIZE*16,
00525                      <span class="keyword">sizeof</span>(ULONG)
00526                      );
00527 
00528        <span class="comment">//</span>
00529        <span class="comment">// Take the Ica Lock, if this fails raise status as we can't</span>
00530        <span class="comment">// safely recover the critical section state</span>
00531        <span class="comment">//</span>
00532        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a8">VdmpEnterIcaLock</a>(pIcaUserData-&gt;pIcaLock);
00533        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00534            <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
00535            }
00536 
00537 
00538        <span class="keywordflow">if</span> (*pIcaUserData-&gt;pUndelayIrq)
00539            <a class="code" href="../../d9/d4/vdmints_8c.html#a7">RestartDelayedInterrupts</a>(pIcaUserData);
00540 VDIretry:
00541 
00542 
00543        <span class="comment">//</span>
00544        <span class="comment">// Clear the VIP bit</span>
00545        <span class="comment">//</span>
00546        <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; V86_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00547             (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) ||
00548            ((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; PM_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00549             !(TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) )
00550           {
00551             TrapFrame-&gt;EFlags &amp;= ~EFLAGS_VIP;
00552            }
00553 
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">// Mark the vdm state as hw int dispatched. Must use the lock as</span>
00557         <span class="comment">// kernel mode DelayedIntApcRoutine changes the bit as well</span>
00558         <span class="comment">//</span>
00559         _asm {
00560             mov  eax,FIXED_NTVDMSTATE_LINEAR
00561             lock and dword ptr [eax], ~VDM_INT_HARDWARE
00562             }
00563 
00564        pIcaAdapter = pIcaUserData-&gt;pIcaMaster;
00565        IrqLineNum = <a class="code" href="../../d9/d4/vdmints_8c.html#a9">IcaAccept</a>(pIcaUserData, pIcaAdapter);
00566        <span class="keywordflow">if</span> (IrqLineNum &gt;= 0) {
00567            UCHAR bit = 1 &lt;&lt; IrqLineNum;
00568 
00569            <span class="keywordflow">if</span> (pIcaUserData-&gt;pIcaMaster-&gt;ica_ssr &amp; bit) {
00570                pIcaAdapter = pIcaUserData-&gt;pIcaSlave;
00571                IrqLineNum = <a class="code" href="../../d9/d4/vdmints_8c.html#a9">IcaAccept</a>(pIcaUserData, pIcaAdapter);
00572                <span class="keywordflow">if</span> (IrqLineNum &lt; 0) {
00573                    pIcaUserData-&gt;pIcaMaster-&gt;ica_isr &amp;= ~bit;
00574                    }
00575                }
00576            }
00577 
00578        <span class="comment">//</span>
00579        <span class="comment">// Skip spurious ints</span>
00580        <span class="comment">//</span>
00581        <span class="keywordflow">if</span> (IrqLineNum &lt; 0)  {
00582           <span class="comment">//</span>
00583           <span class="comment">// Check for delayed interrupts which need to be restarted</span>
00584           <span class="comment">//</span>
00585           <span class="keywordflow">if</span> (*pIcaUserData-&gt;pUndelayIrq &amp;&amp;
00586               <a class="code" href="../../d9/d4/vdmints_8c.html#a7">RestartDelayedInterrupts</a>(pIcaUserData) != -1)
00587              {
00588               <span class="keywordflow">goto</span> VDIretry;
00589               }
00590 
00591           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a9">VdmpLeaveIcaLock</a>(pIcaUserData-&gt;pIcaLock);
00592           <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00593               <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
00594               }
00595 
00596           <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00597           }
00598 
00599 
00600        <span class="comment">//</span>
00601        <span class="comment">// Capture the AutoEoi mode case for special handling</span>
00602        <span class="comment">//</span>
00603        <span class="keywordflow">if</span> (pIcaAdapter-&gt;ica_mode &amp; ICA_AEOI) {
00604            VdmEvent = <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>;
00605            VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.IntAckInfo = (ULONG)IcaRotate | VDMINTACK_AEOI;
00606            <span class="keywordflow">if</span> (pIcaAdapter == pIcaUserData-&gt;pIcaSlave) {
00607                VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.IntAckInfo |= VDMINTACK_SLAVE;
00608                }
00609            }
00610 
00611 
00612        InterruptNumber = IrqLineNum + pIcaAdapter-&gt;ica_base;
00613 
00614        <span class="comment">//</span>
00615        <span class="comment">// Get the IretHookAddress ... if any</span>
00616        <span class="comment">//</span>
00617        <span class="keywordflow">if</span> (pIcaAdapter == pIcaUserData-&gt;pIcaSlave) {
00618            IrqLineNum += 8;
00619            }
00620 
00621 
00622        IretHookAddress = <a class="code" href="../../d9/d4/vdmints_8c.html#a10">GetIretHookAddress</a>( TrapFrame,
00623                                              pIcaUserData,
00624                                              IrqLineNum
00625                                              );
00626 
00627        <span class="keywordflow">if</span> (*pNtVDMState &amp; VDM_TRACE_HISTORY) {
00628             <a class="code" href="../../d6/d5/vdmtrace_8c.html#a0">VdmTraceEvent</a>(VDMTR_KERNEL_HW_INT,
00629                           (USHORT)InterruptNumber,
00630                           0,
00631                           TrapFrame);
00632        }
00633 
00634        <span class="comment">//</span>
00635        <span class="comment">// Push the interrupt frames</span>
00636        <span class="comment">//</span>
00637        <span class="keywordflow">if</span> (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) {
00638           <a class="code" href="../../d9/d4/vdmints_8c.html#a11">PushRmInterrupt</a>(TrapFrame,
00639                           IretHookAddress,
00640                           VdmTib,
00641                           InterruptNumber
00642                           );
00643           }
00644        <span class="keywordflow">else</span>  {
00645           <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d4/vdmints_8c.html#a12">PushPmInterrupt</a>(
00646                           TrapFrame,
00647                           IretHookAddress,
00648                           VdmTib,
00649                           InterruptNumber
00650                           );
00651 
00652           <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00653               <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a9">VdmpLeaveIcaLock</a>(pIcaUserData-&gt;pIcaLock);
00654               <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
00655               }
00656           }
00657 
00658         <span class="comment">//</span>
00659         <span class="comment">// Disable interrupts and the trap flag</span>
00660         <span class="comment">//</span>
00661 
00662 
00663         <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; V86_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00664              (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) ||
00665             ((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; PM_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00666              !(TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) )
00667            {
00668             TrapFrame-&gt;EFlags &amp;= ~EFLAGS_VIF;
00669             }
00670         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d3/i386_8h.html#a19">KeI386VdmIoplAllowed</a> ||
00671                  !(TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK))
00672            {
00673             *pNtVDMState &amp;= ~<a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a3">VDM_VIRTUAL_INTERRUPTS</a>;
00674             }
00675         <span class="keywordflow">else</span> {
00676             TrapFrame-&gt;EFlags &amp;= ~EFLAGS_INTERRUPT_MASK;
00677             }
00678 
00679         TrapFrame-&gt;EFlags &amp;= ~(EFLAGS_NT_MASK | EFLAGS_TF_MASK);
00680 
00681         <a class="code" href="../../d9/d1/thredobj_8c.html#a4">KeBoostPriorityThread</a>(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(), VDM_HWINT_INCREMENT);
00682 
00683 
00684         <span class="comment">//</span>
00685         <span class="comment">// Release the ica lock</span>
00686         <span class="comment">//</span>
00687         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a9">VdmpLeaveIcaLock</a>(pIcaUserData-&gt;pIcaLock);
00688         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00689             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(Status);
00690             }
00691 
00692         <span class="comment">//</span>
00693         <span class="comment">// check to see if we are supposed to switch back to monitor context</span>
00694         <span class="comment">//</span>
00695         <span class="keywordflow">if</span> (VdmEvent != VdmMaxEvent) {
00696             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o1">Event</a> = <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>;
00697             VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o2">InstructionSize</a> = 0;
00698             <a class="code" href="../../d7/d7/strtexec_8c.html#a1">VdmEndExecution</a>(TrapFrame, VdmTib);
00699             }
00700         }
00701     except(<a class="code" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a>(GetExceptionInformation())) {
00702         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00703         VdmDispatchException(TrapFrame,
00704                              Status,
00705                              (PVOID)TrapFrame-&gt;Eip,
00706                              0,0,0,0   <span class="comment">// no parameters</span>
00707                              );
00708         }
00709 
00710     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00711 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="vdmints.c::VdmpDelayIntApcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmpDelayIntApcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01709">1709</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01437">Ke386VdmClearApcObject()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01996">VdmpExceptionHandler()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">VdmpNullRundownRoutine()</a>.
<p>
<pre class="fragment"><div>01719                    :
01720 
01721     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special APC routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to
01722     dispatch a delayed interupt. This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> clears <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrqLine
01723     bit. <a class="code" href="../../d9/d4/vdmints_8c.html#a3">VdmpQueueIntApcRoutine</a> will restart interrupts.
01724 
01725 Arguments:
01726 
01727     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object used to invoke <span class="keyword">this</span> routine.
01728 
01729     NormalRoutine - Supplies a pointer to a pointer to an optional
01730         normal routine, which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed when wow <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blocked.
01731 
01732     NormalContext - Supplies a pointer to a pointer to an arbitrary data
01733         structure that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01734         NOT USED.
01735 
01736     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
01737         two arguments that contain untyped data that are
01738         NOT USED.
01739 
01740 Return Value:
01741 
01742     None.
01743 
01744 --*/
01745 
01746 {
01747     KIRQL    OldIrql;
01748     PLIST_ENTRY  Next;
01749     PDELAYINTIRQ pDelayIntIrq;
01750     PVDM_PROCESS_OBJECTS pVdmObjects;
01751     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>  ProcessorMode;
01752     PULONG           pDelayIrq;
01753     PULONG           pUndelayIrq;
01754     PULONG           pDelayIret;
01755     ULONG            IrqLine;
01756     BOOLEAN          FreeIrqLine;
01757 
01758 
01759     <span class="comment">//</span>
01760     <span class="comment">// Get a pointer to pVdmObjects</span>
01761     <span class="comment">//</span>
01762     pVdmObjects = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VdmObjects;
01763     ExAcquireFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01764     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, &amp;OldIrql);
01765 
01766     <a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a21">Ke386VdmClearApcObject</a>(Apc);
01767 
01768     FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01769 
01770     <span class="keywordflow">try</span> {
01771 
01772        <span class="comment">//</span>
01773        <span class="comment">// Search the DelayedIntList for the pDelayIntIrq.</span>
01774        <span class="comment">//</span>
01775        Next = pVdmObjects-&gt;DelayIntListHead.Flink;
01776        <span class="keywordflow">while</span> (Next != &amp;pVdmObjects-&gt;DelayIntListHead) {
01777            pDelayIntIrq = CONTAINING_RECORD(Next,DELAYINTIRQ,DelayIntListEntry);
01778            <span class="keywordflow">if</span> (&amp;pDelayIntIrq-&gt;Apc == Apc) {
01779                <span class="keywordflow">break</span>;
01780                }
01781            Next = Next-&gt;Flink;
01782            }
01783 
01784        <span class="keywordflow">if</span> (Next == &amp;pVdmObjects-&gt;DelayIntListHead) {
01785            pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01786            }
01787 
01788        <span class="comment">//</span>
01789        <span class="comment">// If we found the IrqLine in the DelayedIntList,</span>
01790        <span class="comment">// restart interrupts.</span>
01791        <span class="comment">//</span>
01792        <span class="keywordflow">if</span> (pDelayIntIrq &amp;&amp; pDelayIntIrq-&gt;InUse) {
01793            pDelayIntIrq-&gt;InUse  = VDMDELAY_NOTINUSE;
01794            IrqLine = pDelayIntIrq-&gt;IrqLine;
01795            FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01796            }
01797 
01798        }
01799     except(<a class="code" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a>(GetExceptionInformation())) {
01800        ; <span class="comment">// fall thru</span>
01801        }
01802 
01803 
01804     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, OldIrql);
01805 
01806 
01807     <span class="keywordflow">try</span> {
01808 
01809         <span class="keywordflow">if</span> (!FreeIrqLine) {
01810             leave;
01811             }
01812 
01813         pDelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pDelayIrq;
01814         pUndelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pUndelayIrq;
01815         pDelayIret = pVdmObjects-&gt;pIcaUserData-&gt;pDelayIret;
01816 
01817         <span class="comment">//</span>
01818         <span class="comment">// These variables are being modified without holding the</span>
01819         <span class="comment">// ICA lock. This should be OK because none of the ntvdm</span>
01820         <span class="comment">// devices (timer, mouse etc. should ever do a delayed int</span>
01821         <span class="comment">// while a previous delayed interrupt is still pending.</span>
01822         <span class="comment">//</span>
01823 
01824         *pDelayIrq &amp;= ~IrqLine;
01825         _asm {
01826            mov eax, pUndelayIrq
01827            mov ebx, IrqLine
01828            lock or [eax], ebx
01829            }
01830 
01831         <span class="comment">//</span>
01832         <span class="comment">// If we are waiting for an iret hook we have nothing left to do</span>
01833         <span class="comment">// since the iret hook will restart interrupts.</span>
01834         <span class="comment">//</span>
01835         <span class="keywordflow">if</span> (!(IrqLine &amp; *pDelayIret)) {
01836 
01837            <span class="comment">//</span>
01838            <span class="comment">// set hardware int pending</span>
01839            <span class="comment">//</span>
01840            _asm {
01841                mov  eax,FIXED_NTVDMSTATE_LINEAR
01842                lock or dword ptr [eax], VDM_INT_HARDWARE
01843                }
01844 
01845            <span class="comment">//</span>
01846            <span class="comment">// Queue a UserModeApc to dispatch interrupts</span>
01847            <span class="comment">//</span>
01848            <span class="keywordflow">if</span> (NormalRoutine) {
01849                ProcessorMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
01850                <a class="code" href="../../d9/d4/vdmints_8c.html#a3">VdmpQueueIntApcRoutine</a>(Apc,
01851                                       NormalRoutine,
01852                                       (PVOID *)&amp;ProcessorMode,
01853                                       SystemArgument1,
01854                                       SystemArgument2
01855                                       );
01856                }
01857            }
01858         }
01859     except(<a class="code" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a>(GetExceptionInformation())) {
01860        ; <span class="comment">// fall thru</span>
01861        }
01862 
01863     ExReleaseFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01864 
01865     <span class="keywordflow">return</span>;
01866 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="vdmints.c::VdmpDelayIntDpcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmpDelayIntDpcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">1583</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01257">Ke386VdmInsertQueueApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00031">VDM_HWINT_INCREMENT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01709">VdmpDelayIntApcRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">VdmpNullRundownRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">VdmpDelayInterrupt()</a>.
<p>
<pre class="fragment"><div>01592                    :
01593 
01594     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DPC routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a DelayedInterrupt
01595     timer expires. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> associated APC into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01596     target thread's APC queue.
01597 
01598 Arguments:
01599 
01600     Dpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
01601 
01602     DeferredContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Target EProcess
01603 
01604     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to
01605         two arguments that contain untyped data that are
01606         NOT USED.
01607 
01608 
01609 Return Value:
01610 
01611     None.
01612 
01613 --*/
01614 
01615 {
01616 
01617     PVDM_PROCESS_OBJECTS pVdmObjects;
01618     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>    Process;
01619     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>     Thread, MainThread;
01620     PLIST_ENTRY  Next;
01621     PDELAYINTIRQ pDelayIntIrq;
01622     KIRQL        OldIrql;
01623 
01624     <span class="comment">//</span>
01625     <span class="comment">// Get address of Process VdmObjects</span>
01626     <span class="comment">//</span>
01627     Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)DeferredContext;
01628     pVdmObjects = (PVDM_PROCESS_OBJECTS)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
01629 
01630 
01631     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, &amp;OldIrql);
01632 
01633 
01634     <span class="comment">//</span>
01635     <span class="comment">// Search the DelayedIntList for the matching Dpc.</span>
01636     <span class="comment">//</span>
01637     Next = pVdmObjects-&gt;DelayIntListHead.Flink;
01638     <span class="keywordflow">while</span> (Next != &amp;pVdmObjects-&gt;DelayIntListHead) {
01639         pDelayIntIrq = CONTAINING_RECORD(Next,DELAYINTIRQ,DelayIntListEntry);
01640         <span class="keywordflow">if</span> (&amp;pDelayIntIrq-&gt;Dpc == Dpc) {
01641             <span class="keywordflow">break</span>;
01642             }
01643         Next = Next-&gt;Flink;
01644         }
01645 
01646     <span class="keywordflow">if</span> (Next == &amp;pVdmObjects-&gt;DelayIntListHead) {
01647         pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01648         MainThread = Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01649         }
01650     <span class="keywordflow">else</span> {
01651         Thread = pDelayIntIrq-&gt;Thread;
01652         pDelayIntIrq-&gt;Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01653         MainThread = pDelayIntIrq-&gt;MainThread;
01654         pDelayIntIrq-&gt;MainThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01655         }
01656 
01657 
01658     <span class="keywordflow">if</span> (pDelayIntIrq &amp;&amp; pDelayIntIrq-&gt;InUse) {
01659         <span class="keywordflow">if</span> ((Thread &amp;&amp;
01660              <a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a20">Ke386VdmInsertQueueApc</a>(&amp;pDelayIntIrq-&gt;Apc,
01661                                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01662                                     KernelMode,
01663                                     VdmpDelayIntApcRoutine,
01664                                     VdmpNullRundownRoutine,    <span class="comment">// rundown</span>
01665                                     VdmpQueueIntNormalRoutine, <span class="comment">// normal routine</span>
01666                                     NULL,                      <span class="comment">// NormalContext</span>
01667                                     VDM_HWINT_INCREMENT
01668                                     ))
01669             ||
01670             (MainThread &amp;&amp;
01671              <a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a20">Ke386VdmInsertQueueApc</a>(&amp;pDelayIntIrq-&gt;Apc,
01672                                     &amp;MainThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01673                                     KernelMode,
01674                                     VdmpDelayIntApcRoutine,
01675                                     VdmpNullRundownRoutine,    <span class="comment">// rundown</span>
01676                                     VdmpQueueIntNormalRoutine, <span class="comment">// normal routine</span>
01677                                     NULL,                      <span class="comment">// NormalContext</span>
01678                                     VDM_HWINT_INCREMENT
01679                                     )))
01680            {
01681             pDelayIntIrq-&gt;InUse  = VDMDELAY_KAPC;
01682             }
01683         <span class="keywordflow">else</span> {
01684             <span class="comment">// This hwinterrupt line is blocked forever.</span>
01685             pDelayIntIrq-&gt;InUse  = VDMDELAY_NOTINUSE;
01686             }
01687         }
01688 
01689 
01690     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, OldIrql);
01691 
01692     <span class="keywordflow">if</span> (Thread) {
01693         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01694         }
01695 
01696     <span class="keywordflow">if</span> (MainThread) {
01697         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MainThread);
01698         }
01699 
01700     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01701 
01702 
01703     <span class="keywordflow">return</span>;
01704 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="vdmints.c::VdmpDelayInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpDelayInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVDMDELAYINTSDATA&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pdsd</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00013">Delay</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">KeInitializeTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02775">KeMinimumIncrement</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02813">KeTimeIncrement</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>01241                    :
01242 
01243     Sets a timer to dispatch <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed interrupt through <a class="code" href="../../d4/d9/ke_8h.html#a345">KeSetTimer</a>.
01244     When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer fires a user mode APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> interrupt.
01245 
01246     This function uses lazy allocation <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> to allocate internal
01247     data structures (nonpaged pool) on a per Irq basis, and needs to
01248     be notified when specific Irq Lines no longer need Delayed
01249     Interrupt services.
01250 
01251     The caller must own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IcaLock to synchronize access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01252     Irq lists.
01253 
01254     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a4">WARNING</a>: - Until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Delayed interrupt fires or <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cancelled,
01255                <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specific Irq line will not generate any interrupts.
01256 
01257              - The APC routine, does not take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HostIca lock, when
01258                unblocking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrqLine. Devices which use delayed Interrupts
01259                should not queue ANY additional interrupts <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <a class="code" href="../../d5/d5/vdmprint_8h.html#a7">IRQ</a>
01260                line until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed interrupt has fired or been cancelled.
01261 
01262 Arguments:
01263 
01264     pdsd.Delay         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> Interval in usecs
01265                        <span class="keywordflow">if</span> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0xFFFFFFFF then per Irq Line nonpaged
01266                            data structures are freed. No Timers are set.
01267                        <span class="keywordflow">else</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer delay.
01268 
01269     pdsd.DelayIrqLine  IrqLine Number
01270 
01271     pdsd.hThread       Thread <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> of CurrentMonitorTeb
01272 
01273 
01274 Return Value:
01275 
01276     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
01277 
01278 --*/
01279 
01280 {
01281     PVDM_PROCESS_OBJECTS pVdmObjects;
01282     PLIST_ENTRY   Next;
01283     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>     Process;
01284     PDELAYINTIRQ  pDelayIntIrq;
01285     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>      Thread, MainThread;
01286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01287     KIRQL         OldIrql;
01288     ULONG         IrqLine;
01289     ULONG         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a>;
01290     PULONG        pDelayIrq;
01291     PULONG        pUndelayIrq;
01292     LARGE_INTEGER liDelay;
01293     BOOLEAN       FreeIrqLine, AlreadyInUse;
01294 
01295 
01296 
01297     <span class="comment">//</span>
01298     <span class="comment">// Get a pointer to pVdmObjects</span>
01299     <span class="comment">//</span>
01300     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01301     pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
01302     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || !pVdmObjects) {
01303         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
01304         }
01305 
01306     ExAcquireFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01307 
01308     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01309     Thread = MainThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01310     FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01311     AlreadyInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01312 
01313     <span class="keywordflow">try</span> {
01314 
01315         <span class="comment">//</span>
01316         <span class="comment">// Probe the parameters</span>
01317         <span class="comment">//</span>
01318         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(pdsd, <span class="keyword">sizeof</span>(VDMDELAYINTSDATA), <span class="keyword">sizeof</span>(ULONG));
01319 
01320         <span class="comment">//</span>
01321         <span class="comment">// Form a BitMask for the IrqLine Number</span>
01322         <span class="comment">//</span>
01323         IrqLine = 1 &lt;&lt; pdsd-&gt;DelayIrqLine;
01324         <span class="keywordflow">if</span> (!IrqLine) {
01325             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
01326             <span class="keywordflow">goto</span> VidEarlyExit;
01327             }
01328 
01329         pDelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pDelayIrq;
01330         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pDelayIrq);
01331         pUndelayIrq = pVdmObjects-&gt;pIcaUserData-&gt;pUndelayIrq;
01332         <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(pUndelayIrq);
01333 
01334 
01335         <span class="comment">//</span>
01336         <span class="comment">// Copy out the Delay parameter, and convert hundreths nanosecs</span>
01337         <span class="comment">//</span>
01338         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> = pdsd-&gt;Delay;
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// Check to see if we need to reset the timer resolution</span>
01342         <span class="comment">//</span>
01343         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> == 0xFFFFFFFF) {
01344             ZwSetTimerResolution(KeMaximumIncrement, FALSE, &amp;Delay);
01345             <span class="keywordflow">goto</span> VidEarlyExit;
01346             }
01347 
01348 
01349          FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01350 
01351             <span class="comment">// convert delay to hundreths of nanosecs</span>
01352             <span class="comment">// and ensure min delay of 1 msec</span>
01353             <span class="comment">//</span>
01354          <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; 1000 ? 10000 : <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> * 10;
01355 
01356             <span class="comment">//</span>
01357             <span class="comment">// If the delay time is close to the system's clock rate</span>
01358             <span class="comment">// then adjust the system's clock rate and if needed</span>
01359             <span class="comment">// the delay time so that the timer will fire before the</span>
01360             <span class="comment">// the due time.</span>
01361             <span class="comment">//</span>
01362          <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; 150000) {
01363              ULONG ul = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &gt;&gt; 1;
01364 
01365              <span class="keywordflow">if</span> (ul &lt; KeTimeIncrement &amp;&amp; KeTimeIncrement &gt; <a class="code" href="../../d4/d9/ke_8h.html#a132">KeMinimumIncrement</a>) {
01366                  ZwSetTimerResolution(ul, TRUE, (PULONG)&amp;liDelay.LowPart);
01367                  }
01368 
01369              <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a>) {
01370                  <span class="comment">// can't set system clock rate low enuf, so use half delay</span>
01371                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &gt;&gt;= 1;
01372                  }
01373              <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> &lt; (<a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> &lt;&lt; 1)) {
01374                  <span class="comment">// Real close to the system clock rate, lower delay</span>
01375                  <span class="comment">// proportionally, to avoid missing clock cycles.</span>
01376                  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> -= <a class="code" href="../../d4/d9/ke_8h.html#a153">KeTimeIncrement</a> &gt;&gt; 1;
01377                  }
01378              }
01379 
01380          <span class="comment">//</span>
01381          <span class="comment">// Reference the Target Thread</span>
01382          <span class="comment">//</span>
01383          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01384                           pdsd-&gt;hThread,
01385                           THREAD_QUERY_INFORMATION,
01386                           PsThreadType,
01387                           KeGetPreviousMode(),
01388                           &amp;Thread,
01389                           NULL
01390                           );
01391          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01392              Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01393              <span class="keywordflow">goto</span> VidEarlyExit;
01394              }
01395 
01396 
01397          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(
01398                           pVdmObjects-&gt;MainThread,
01399                           THREAD_QUERY_INFORMATION,
01400                           PsThreadType,
01401                           KernelMode
01402                           );
01403          <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01404              MainThread = pVdmObjects-&gt;MainThread;
01405              }
01406          <span class="keywordflow">else</span> {
01407              <span class="keywordflow">goto</span> VidEarlyExit;
01408              }
01409 
01410 VidEarlyExit:;
01411         }
01412    except(EXCEPTION_EXECUTE_HANDLER) {
01413         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01414         }
01415 
01416    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01417        ExReleaseFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01418        <span class="keywordflow">if</span> (Thread) {
01419            <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01420            }
01421 
01422        <span class="keywordflow">if</span> (MainThread) {
01423            <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MainThread);
01424            }
01425 
01426        <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01427        }
01428 
01429 
01430 
01431    <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, &amp;OldIrql);
01432 
01433    <span class="keywordflow">try</span> {
01434 
01435         <span class="comment">//</span>
01436         <span class="comment">// Search the DelayedIntList for a matching Irq Line.</span>
01437         <span class="comment">//</span>
01438         Next = pVdmObjects-&gt;DelayIntListHead.Flink;
01439         <span class="keywordflow">while</span> (Next != &amp;pVdmObjects-&gt;DelayIntListHead) {
01440             pDelayIntIrq = CONTAINING_RECORD(Next, DELAYINTIRQ, DelayIntListEntry);
01441             <span class="keywordflow">if</span> (pDelayIntIrq-&gt;IrqLine == IrqLine) {
01442                 <span class="keywordflow">break</span>;
01443                 }
01444             Next = Next-&gt;Flink;
01445             }
01446 
01447         <span class="keywordflow">if</span> (Next == &amp;pVdmObjects-&gt;DelayIntListHead) {
01448             pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01449             }
01450 
01451 
01452         <span class="keywordflow">if</span> (!pDelayIntIrq) {
01453             <span class="keywordflow">if</span> (FreeIrqLine) {
01454                 <span class="keywordflow">goto</span> VidExit;
01455                 }
01456 
01457             <span class="comment">//</span>
01458             <span class="comment">// If a DelayIntIrq does not exist for this irql, allocate from nonpaged</span>
01459             <span class="comment">// pool and initialize it</span>
01460             <span class="comment">//</span>
01461 
01462             pDelayIntIrq = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool,
01463                                                  <span class="keyword">sizeof</span>(DELAYINTIRQ),
01464                                                  ' MDV');
01465 
01466             <span class="keywordflow">if</span> (!pDelayIntIrq) {
01467                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
01468                 <span class="keywordflow">goto</span> VidExit;
01469                 }
01470 
01471 
01472             <span class="keywordflow">try</span> {
01473                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process, NonPagedPool, <span class="keyword">sizeof</span>(DELAYINTIRQ));
01474                 }
01475             except(EXCEPTION_EXECUTE_HANDLER) {
01476                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01477                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDelayIntIrq);
01478                 <span class="keywordflow">goto</span> VidExit;
01479                 }
01480             RtlZeroMemory(pDelayIntIrq, <span class="keyword">sizeof</span>(DELAYINTIRQ));
01481             pDelayIntIrq-&gt;IrqLine = IrqLine;
01482 
01483             <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;pDelayIntIrq-&gt;Timer);
01484 
01485             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;pDelayIntIrq-&gt;Dpc,
01486                             VdmpDelayIntDpcRoutine,
01487                             Process
01488                             );
01489 
01490             InsertTailList(&amp;pVdmObjects-&gt;DelayIntListHead,
01491                            &amp;pDelayIntIrq-&gt;DelayIntListEntry
01492                            );
01493             }
01494 
01495 
01496          <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a2">Delay</a> == 0xFFFFFFFF) {
01497              <span class="keywordflow">if</span> (pDelayIntIrq-&gt;InUse == VDMDELAY_KTIMER) {
01498                  pDelayIntIrq-&gt;InUse = VDMDELAY_NOTINUSE;
01499                  pDelayIntIrq = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500                  }
01501              }
01502          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pDelayIntIrq-&gt;InUse == VDMDELAY_NOTINUSE) {
01503              liDelay = RtlEnlargedIntegerMultiply(Delay, -1);
01504              <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(&amp;pDelayIntIrq-&gt;Timer, liDelay, &amp;pDelayIntIrq-&gt;Dpc);
01505              <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
01506              }
01507 
01508 VidExit:;
01509         }
01510     except(EXCEPTION_EXECUTE_HANDLER)  {
01511         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01512         }
01513 
01514     <span class="keywordflow">if</span> (pDelayIntIrq &amp;&amp; !pDelayIntIrq-&gt;InUse) {
01515 
01516         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01517             <span class="comment">//</span>
01518             <span class="comment">// Save PETHREAD of Target thread for the dpc routine</span>
01519             <span class="comment">// the DPC routine will deref the threads.</span>
01520             <span class="comment">//</span>
01521             pDelayIntIrq-&gt;InUse = VDMDELAY_KTIMER;
01522             pDelayIntIrq-&gt;Thread = Thread;
01523             Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01524             pDelayIntIrq-&gt;MainThread = MainThread;
01525             MainThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01526             }
01527         <span class="keywordflow">else</span> {
01528             pDelayIntIrq-&gt;InUse = VDMDELAY_NOTINUSE;
01529             pDelayIntIrq-&gt;Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01530             FreeIrqLine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01531             }
01532         }
01533     <span class="keywordflow">else</span> {
01534         AlreadyInUse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01535         }
01536 
01537 
01538 
01539     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;pVdmObjects-&gt;DelayIntSpinLock, OldIrql);
01540 
01541     <span class="keywordflow">try</span> {
01542         <span class="keywordflow">if</span> (FreeIrqLine) {
01543             *pDelayIrq &amp;= ~IrqLine;
01544             _asm {
01545                mov eax, pUndelayIrq
01546                mov ebx, IrqLine
01547                lock or [eax], ebx
01548                }
01549             }
01550         <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!AlreadyInUse) {  <span class="comment">// TakeIrqLine</span>
01551             *pDelayIrq |= IrqLine;
01552             _asm {
01553                mov eax, pUndelayIrq
01554                mov ebx, IrqLine
01555                not ebx
01556                lock and [eax], ebx
01557                }
01558             }
01559         }
01560     except(EXCEPTION_EXECUTE_HANDLER)  {
01561         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01562         }
01563 
01564     ExReleaseFastMutex(&amp;pVdmObjects-&gt;DelayIntFastMutex);
01565 
01566     <span class="keywordflow">if</span> (Thread) {
01567         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01568         }
01569 
01570     <span class="keywordflow">if</span> (MainThread) {
01571         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(MainThread);
01572         }
01573 
01574     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01575 
01576 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="vdmints.c::VdmpDispatchableIntPending" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN VdmpDispatchableIntPending           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>EFlags</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01870">1870</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02688">KeI386VdmIoplAllowed</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02689">KeI386VirtualIntExtensions</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00004">VDM_VIRTUAL_INTERRUPTS</a>.
<p>
<pre class="fragment"><div>01875                    :
01876 
01877     This routine determines whether or not there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dispatchable
01878     <span class="keyword">virtual</span> interrupt to dispatch.
01879 
01880 Arguments:
01881 
01882     EFlags -- supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EFlags to be checked
01883 
01884 Return Value:
01885 
01886     True -- a <span class="keyword">virtual</span> interrupt should be dispatched
01887     False -- no <span class="keyword">virtual</span> interrupt should be dispatched
01888 
01889 --*/
01890 {
01891     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01892     <span class="comment">//</span>
01893     <span class="comment">// Insure that we are not trying to run with IOPL and pentium extensions</span>
01894     <span class="comment">//</span>
01895     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((!(KeI386VdmIoplAllowed &amp;&amp;
01896         (KeI386VirtualIntExtensions &amp; (V86_VIRTUAL_INT_EXTENSIONS |
01897         PM_VIRTUAL_INT_EXTENSIONS)))));
01898 
01899     <span class="keywordflow">if</span> (EFlags &amp; EFLAGS_V86_MASK) {
01900         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; V86_VIRTUAL_INT_EXTENSIONS) {
01901             <span class="keywordflow">return</span>(0 != (EFlags &amp; EFLAGS_VIF));
01902         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a19">KeI386VdmIoplAllowed</a>) {
01903             <span class="keywordflow">return</span> (0 != (EFlags &amp; EFLAGS_INTERRUPT_MASK));
01904         } <span class="keywordflow">else</span> {
01905             <span class="keywordflow">return</span> (0 != (*pNtVDMState &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a3">VDM_VIRTUAL_INTERRUPTS</a>));
01906         }
01907     } <span class="keywordflow">else</span> {
01908         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; PM_VIRTUAL_INT_EXTENSIONS) {
01909             <span class="keywordflow">return</span>(0 != (EFlags &amp; EFLAGS_VIF));
01910         } <span class="keywordflow">else</span> {
01911             <span class="keywordflow">return</span> (0 != (*pNtVDMState &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a3">VDM_VIRTUAL_INTERRUPTS</a>));
01912         }
01913     }
01914 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="vdmints.c::VdmpExceptionHandler" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int VdmpExceptionHandler           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionInfo</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01996">1996</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01709">VdmpDelayIntApcRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>.
<p>
<pre class="fragment"><div>01999 {
02000 <span class="preprocessor">#if DBG</span>
02001 <span class="preprocessor"></span>    PEXCEPTION_RECORD ExceptionRecord;
02002     PCONTEXT ContextRecord;
02003     ULONG NumberParameters;
02004     PULONG ExceptionInformation;
02005 <span class="preprocessor">#endif</span>
02006 <span class="preprocessor"></span>
02007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02008 
02009 <span class="preprocessor">#if DBG</span>
02010 <span class="preprocessor"></span>
02011     ExceptionRecord = ExceptionInfo-&gt;ExceptionRecord;
02012     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"VdmExRecord ExCode %x Flags %x Address %x\n"</span>,
02013              ExceptionRecord-&gt;ExceptionCode,
02014              ExceptionRecord-&gt;ExceptionFlags,
02015              ExceptionRecord-&gt;ExceptionAddress
02016              );
02017 
02018     NumberParameters = ExceptionRecord-&gt;NumberParameters;
02019     <span class="keywordflow">if</span> (NumberParameters) {
02020         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"VdmExRecord Parameters:\n"</span>);
02021 
02022         ExceptionInformation = ExceptionRecord-&gt;ExceptionInformation;
02023         <span class="keywordflow">while</span> (NumberParameters--) {
02024            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\t%x\n"</span>, *ExceptionInformation);
02025            }
02026         }
02027 
02028 <span class="preprocessor">#endif</span>
02029 <span class="preprocessor"></span>
02030     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
02031 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="vdmints.c::VdmpIsThreadTerminating" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpIsThreadTerminating           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01922">1922</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00875">PsIsThreadTerminating</a>, <a class="el" href="../../d2/d9/pscid_8c-source.html#l00027">PsLookupProcessThreadByCid()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01927                    :
01928 
01929     This routine determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminating or not.
01930 
01931 Arguments:
01932 
01933 Return Value:
01934 
01935     True --
01936     False -
01937 
01938 --*/
01939 {
01940     CLIENT_ID     Cid;
01941     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>      Thread;
01942     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01943 
01944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">// If the owning thread juest exited the IcaLock the</span>
01948         <span class="comment">// OwningThread Tid may be NULL, return success, since</span>
01949         <span class="comment">// we don't know what the owning threads state was.</span>
01950         <span class="comment">//</span>
01951     <span class="keywordflow">if</span> (!ThreadId) {
01952         <span class="keywordflow">return</span> STATUS_SUCCESS;
01953         }
01954 
01955     Cid.UniqueProcess = NtCurrentTeb()-&gt;ClientId.UniqueProcess;
01956     Cid.UniqueThread  = ThreadId;
01957 
01958     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/pscid_8c.html#a0">PsLookupProcessThreadByCid</a>(&amp;Cid, NULL, &amp;Thread);
01959     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01960         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(Thread) ? STATUS_THREAD_IS_TERMINATING
01961                                                : STATUS_SUCCESS;
01962         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01963         }
01964 
01965     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01966 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="vdmints.c::VdmpNullRundownRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmpNullRundownRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">1969</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01709">VdmpDelayIntApcRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">VdmpQueueInterrupt()</a>.
<p>
<pre class="fragment"><div>01974                    :
01975 
01976     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used as a rundown routine <span class="keywordflow">for</span> our APC.
01977     Attempts to clear <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed <span class="keywordtype">int</span> state
01978 
01979 Arguments:
01980 
01981     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Apc to run down.
01982 
01983 Return Value:
01984 
01985     None.
01986 
01987 --*/
01988 {
01989    <a class="code" href="../../d9/d4/vdmints_8c.html#a6">VdmpDelayIntApcRoutine</a>( Apc, NULL, NULL, NULL, NULL);
01990 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="vdmints.c::VdmpQueueIntApcRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmpQueueIntApcRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">232</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00036">_VdmEventInfo::Event</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00059">_Vdm_Tib::EventInfo</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00037">_VdmEventInfo::InstructionSize</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01437">Ke386VdmClearApcObject()</a>, <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01257">Ke386VdmInsertQueueApc()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02689">KeI386VirtualIntExtensions</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00875">PsIsThreadTerminating</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00031">VDM_HWINT_INCREMENT</a>, <a class="el" href="../../d3/d4/ke_2i386_2vdmp_8h-source.html#l00002">VDM_INTERRUPT_PENDING</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00477">VdmDispatchInterrupts()</a>, <a class="el" href="../../d8/d6/strtexec_8c-source.html#l00224">VdmEndExecution()</a>, <a class="el" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a10">VdmpDispatchableIntPending()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01996">VdmpExceptionHandler()</a>, <a class="el" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">VdmpNullRundownRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d4/d4/vdm_2i386_2vdmp_8h-source.html#l00200">VDMTIB_KPROBE</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01709">VdmpDelayIntApcRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">VdmpQueueInterrupt()</a>.
<p>
<pre class="fragment"><div>00242                    :
00243 
00244     Kernel and User mode Special Apc routine to dispatchvirtual
00245     interrupts to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vdm.
00246 
00247     For <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> routine:
00248         <span class="keywordflow">if</span> vdm <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running in application mode
00249            queue a UserModeApc to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same thread
00250         <span class="keywordflow">else</span> <span class="keywordflow">do</span> nothing
00251 
00252     For <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> routine
00253         <span class="keywordflow">if</span> vdm <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> running in application mode dispatch <span class="keyword">virtual</span> interrupts
00254         <span class="keywordflow">else</span> <span class="keywordflow">do</span> nothing
00255 
00256 Arguments:
00257 
00258     Apc -
00259         Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object used to invoke <span class="keyword">this</span> routine.
00260 
00261     NormalRoutine -
00262         Supplies a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal routine
00263         function that was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized.
00264 
00265     NormalContext - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode
00266         specifying that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a Kernel Mode or <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> apc
00267 
00268     SystemArgument1 -
00269 
00270     SystemArgument2 - NOT USED
00271         Supplies a set of two pointers to two arguments that contain
00272         untyped data.
00273 
00274 Return Value:
00275 
00276     None.
00277 
00278 --*/
00279 
00280 {
00281     PVDM_PROCESS_OBJECTS pVdmObjects;
00282     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00283     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>     Thread;
00284     PKTRAP_FRAME TrapFrame;
00285     <a class="code" href="../../d0/d6/struct__Vdm__Tib.html">PVDM_TIB</a>     VdmTib;
00286 
00287     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00288 
00289     <a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a21">Ke386VdmClearApcObject</a>(Apc);
00290 
00291 
00292     <span class="keywordflow">try</span> {
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// Get the trap frame for the current thread</span>
00296         <span class="comment">//</span>
00297         Thread    = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00298 
00299         <span class="comment">//</span>
00300         <span class="comment">// If the thread is dying, bail out</span>
00301         <span class="comment">//</span>
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(Thread))
00303             <span class="keywordflow">return</span>;
00304 
00305         <span class="comment">//</span>
00306         <span class="comment">// if no pending interrupts, ignore this APC.</span>
00307         <span class="comment">//</span>
00308         <span class="keywordflow">if</span> (!(*pNtVDMState &amp; <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a1">VDM_INTERRUPT_PENDING</a>)) {
00309             <span class="keywordflow">return</span>;
00310             }
00311 
00312         TrapFrame = VdmGetTrapFrame(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00313 
00314         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a10">VdmpDispatchableIntPending</a>(TrapFrame-&gt;EFlags))
00315           {
00316             pVdmObjects = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VdmObjects;
00317                 <span class="comment">//</span>
00318                 <span class="comment">// if we are in v86 mode or segmented protected mode</span>
00319                 <span class="comment">// then queue the UserMode Apc, which will dispatch</span>
00320                 <span class="comment">// the hardware interrupt</span>
00321                 <span class="comment">//</span>
00322             <span class="keywordflow">if</span> ((TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK) ||
00323                  TrapFrame-&gt;SegCs != (KGDT_R3_CODE | RPL_MASK))
00324               {
00325                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)*NormalContext == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00326 
00327                      <a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a20">Ke386VdmInsertQueueApc</a>(
00328                              &amp;pVdmObjects-&gt;QueuedIntUserApc,
00329                              &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00330                              UserMode,
00331                              VdmpQueueIntApcRoutine,
00332                              VdmpNullRundownRoutine,<span class="comment">// rundown</span>
00333                              NULL,                  <span class="comment">// normal routine</span>
00334                              (PVOID)UserMode,       <span class="comment">// NormalContext</span>
00335                              (*pNtVDMState &amp; VDM_INT_HARDWARE) <span class="comment">// PrBoost</span>
00336                               ? VDM_HWINT_INCREMENT : 0
00337                              );
00338 
00339                     }
00340                 <span class="keywordflow">else</span>  {
00341                      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*NormalContext == (PVOID)UserMode);
00342 
00343                      <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/vdm_2i386_2vdmp_8h.html#a18">VdmpGetVdmTib</a>(&amp;VdmTib, VDMTIB_KPROBE);
00344                      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00345                         <span class="keywordflow">return</span>;
00346                      }
00347 
00348 
00349                      <span class="comment">//VdmTib = (PsGetCurrentProcess()-&gt;VdmObjects)-&gt;VdmTib;</span>
00350                      <span class="comment">// VdmTib =</span>
00351                      <span class="comment">//    ((PVDM_PROCESS_OBJECTS)(PsGetCurrentProcess()-&gt;VdmObjects))-&gt;VdmTib;</span>
00352 
00353                         <span class="comment">//</span>
00354                         <span class="comment">// If there are no hardware ints, dispatch timer ints</span>
00355                         <span class="comment">// else dispatch hw interrupts</span>
00356                         <span class="comment">//</span>
00357                      <span class="keywordflow">if</span> (*pNtVDMState &amp; VDM_INT_TIMER &amp;&amp;
00358                          !(*pNtVDMState &amp; VDM_INT_HARDWARE))
00359                        {
00360                          VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o1">Event</a> = <a class="code" href="../../d2/d5/ke_2i386_2vdmp_8h.html#a33a28">VdmIntAck</a>;
00361                          VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.<a class="code" href="../../d1/d6/struct__VdmEventInfo.html#o2">InstructionSize</a> = 0;
00362                          VdmTib-&gt;<a class="code" href="../../d0/d6/struct__Vdm__Tib.html#o5">EventInfo</a>.IntAckInfo = 0;
00363                          <a class="code" href="../../d7/d7/strtexec_8c.html#a1">VdmEndExecution</a>(TrapFrame, VdmTib);
00364                          }
00365                      <span class="keywordflow">else</span> {
00366                          <a class="code" href="../../d9/d4/vdmints_8c.html#a16">VdmDispatchInterrupts</a>(TrapFrame, VdmTib);
00367                          }
00368                      }
00369                 }
00370 
00371                 <span class="comment">//</span>
00372                 <span class="comment">// If we are not in application mode and wow is all blocked</span>
00373                 <span class="comment">// then Wake up WowExec by setting the wow idle event</span>
00374                 <span class="comment">//</span>
00375             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*NormalRoutine &amp;&amp;
00376                      !(*pNtVDMState &amp; VDM_WOWBLOCKED))
00377                {
00378                 *NormalRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00379                 }
00380 
00381             }
00382         <span class="comment">// WARNING this may set VIP for flat if VPI is ever set in CR4</span>
00383         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; V86_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00384                   (TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) ||
00385                  ((<a class="code" href="../../d5/d3/i386_8h.html#a20">KeI386VirtualIntExtensions</a> &amp; PM_VIRTUAL_INT_EXTENSIONS) &amp;&amp;
00386                   !(TrapFrame-&gt;EFlags &amp; EFLAGS_V86_MASK)) )
00387            {
00388             <span class="comment">// The CPU traps EVERY instruction if VIF and VIP are both ON.</span>
00389             <span class="comment">// Make sure that you set VIP ON only when  there are pending</span>
00390             <span class="comment">// interrupts, i.e. (*pNtVDMState &amp; VDM_INTERRUPT_PENDING) != 0.</span>
00391             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*pNtVDMState &amp; VDM_INTERRUPT_PENDING);
00392 
00393             TrapFrame-&gt;EFlags |= EFLAGS_VIP;
00394             }
00395         }
00396     except(<a class="code" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a>(GetExceptionInformation()))  {
00397         VdmDispatchException(TrapFrame,
00398                              GetExceptionCode(),
00399                              (PVOID)TrapFrame-&gt;Eip,
00400                              0,0,0,0   <span class="comment">// no parameters</span>
00401                              );
00402         <span class="keywordflow">return</span>;
00403         }
00404 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="vdmints.c::VdmpQueueInterrupt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS VdmpQueueInterrupt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ThreadHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">146</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d0/d3/ke_2i386_2vdm_8c-source.html#l01257">Ke386VdmInsertQueueApc()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00441">_ETHREAD::ThreadsProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00258">_EPROCESS::VdmObjects</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01969">VdmpNullRundownRoutine()</a>, <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00232">VdmpQueueIntApcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">VdmpQueueIntNormalRoutine()</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/vdmentry_8c-source.html#l00051">NtVdmControl()</a>.
<p>
<pre class="fragment"><div>00152                    :
00153 
00154     Queues a user mode APC to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed application thread
00155     which will dispatch an interrupt.
00156 
00157     <span class="keywordflow">if</span> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already queued to specified thread
00158        does nothing
00159 
00160     <span class="keywordflow">if</span> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrong thread
00161        dequeue <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00162 
00163     Reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user APC <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed thread
00164 
00165     Insert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> queue <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specifed thread
00166 
00167 Arguments:
00168 
00169     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - handle of thread to insert QueueIntApcRoutine
00170 
00171 Return Value:
00172 
00173     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>.
00174 
00175 --*/
00176 
00177 {
00178 
00179     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>    Process;
00180     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>     Thread;
00181     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00182     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>      PrevMode;
00183     PVDM_PROCESS_OBJECTS pVdmObjects;
00184 
00185     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00186 
00187 
00188     PrevMode = KeGetPreviousMode();
00189 
00190     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(ThreadHandle,
00191                                        THREAD_QUERY_INFORMATION,
00192                                        PsThreadType,
00193                                        PrevMode,
00194                                        &amp;Thread,
00195                                        NULL
00196                                        );
00197     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00198         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00199         }
00200 
00201     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00202     <span class="keywordflow">if</span> (Process != Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o28">ThreadsProcess</a> || Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.VdmFlag != <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00203       {
00204         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_1;
00205         }
00206     <span class="keywordflow">else</span> {
00207         pVdmObjects = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
00208 
00209         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/ke_2i386_2vdm_8c.html#a20">Ke386VdmInsertQueueApc</a>(&amp;pVdmObjects-&gt;QueuedIntApc,
00210                                     &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00211                                     KernelMode,
00212                                     VdmpQueueIntApcRoutine,
00213                                     VdmpNullRundownRoutine, <span class="comment">// rundown</span>
00214                                     VdmpQueueIntNormalRoutine, <span class="comment">// normal routine</span>
00215                                     (PVOID)KernelMode,      <span class="comment">// NormalContext</span>
00216                                     0
00217                                     ))
00218            {
00219             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00220             }
00221         <span class="keywordflow">else</span> {
00222             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00223             }
00224         }
00225 
00226     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00227     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00228 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="vdmints.c::VdmpQueueIntNormalRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID VdmpQueueIntNormalRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00408">408</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00034">EVENT_INCREMENT</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00030">ExEventObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01996">VdmpExceptionHandler()</a>.
<p>
Referenced by <a class="el" href="../../d0/d4/vdmints_8c-source.html#l01583">VdmpDelayIntDpcRoutine()</a>, and <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00146">VdmpQueueInterrupt()</a>.
<p>
<pre class="fragment"><div>00415                    :
00416 
00417 
00418 
00419 Arguments:
00420 
00421 
00422 Return Value:
00423 
00424     None.
00425 
00426 --*/
00427 {
00428     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00429     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>  <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00430     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00431     PKTRAP_FRAME TrapFrame;
00432     PVDM_PROCESS_OBJECTS pVdmObjects;
00433 
00434 
00435     <span class="keywordflow">try</span> {
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">// Wake up WowExec by setting the wow idle event</span>
00439         <span class="comment">//</span>
00440 
00441         pVdmObjects = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;VdmObjects;
00442 
00443         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00444                          *pVdmObjects-&gt;pIcaUserData-&gt;phWowIdleEvent,
00445                          EVENT_MODIFY_STATE,
00446                          ExEventObjectType,
00447                          UserMode,
00448                          &amp;Event,
00449                          NULL
00450                          );
00451 
00452         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00453             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(Event, EVENT_INCREMENT, FALSE);
00454             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Event);
00455             }
00456 
00457         }
00458     except(<a class="code" href="../../d9/d4/vdmints_8c.html#a14">VdmpExceptionHandler</a>(GetExceptionInformation()))  {
00459         Thread    = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00460         TrapFrame = VdmGetTrapFrame(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00461         VdmDispatchException(TrapFrame,
00462                              GetExceptionCode(),
00463                              (PVOID)TrapFrame-&gt;Eip,
00464                              0,0,0,0   <span class="comment">// no parameters</span>
00465                              );
00466         <span class="keywordflow">return</span>;
00467         }
00468 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="vdmints.c::ExEventObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d4/d1/userk_8h.html#a786">ExEventObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00143">143</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="vdmints.c::ExSemaphoreObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d9/d4/vdmints_8c.html#a1">ExSemaphoreObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d4/vdmints_8c-source.html#l00142">142</a> of file <a class="el" href="../../d0/d4/vdmints_8c-source.html">vdmints.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/semphore_8c-source.html#l00064">ExpSemaphoreInitialization()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00123">NtCreateSemaphore()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00260">NtOpenSemaphore()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00360">NtQuerySemaphore()</a>, <a class="el" href="../../d3/d5/semphore_8c-source.html#l00494">NtReleaseSemaphore()</a>, and <a class="el" href="../../d2/d1/obwait_8c-source.html#l00038">NtSignalAndWaitForSingleObject()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
