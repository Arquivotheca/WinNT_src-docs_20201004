<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ldrp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ldrp.h File Reference</h1><code>#include &lt;nt.h&gt;</code><br>
<code>#include &lt;ntrtl.h&gt;</code><br>
<code>#include &lt;nturtl.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include "wdbgexts.h"</code><br>
<code>#include &lt;ntdbg.h&gt;</code><br>

<p>
<a href="../../d0/d2/ldrp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">_LDRP_PATH_CACHE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">_LDRP_TLS_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a0">NOEXTAPI</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a1">LDRP_MAX_KNOWN_PATH</a>&nbsp;&nbsp;&nbsp;128</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a2">NATIVE_PAGE_SIZE</a>&nbsp;&nbsp;&nbsp;PAGE_SIZE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a3">NATIVE_PAGE_SHIFT</a>&nbsp;&nbsp;&nbsp;PAGE_SHIFT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a4">NATIVE_BYTES_TO_PAGES</a>(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)&nbsp;&nbsp;&nbsp;BYTES_TO_PAGES(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a5">LDRP_HASH_TABLE_SIZE</a>&nbsp;&nbsp;&nbsp;32</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a6">LDRP_HASH_MASK</a>&nbsp;&nbsp;&nbsp;(LDRP_HASH_TABLE_SIZE-1)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a7">LDRP_COMPUTE_HASH_INDEX</a>(wch)&nbsp;&nbsp;&nbsp;( (RtlUpcaseUnicodeChar((wch)) - (WCHAR)'A') &amp; LDRP_HASH_MASK )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a8">LDRP_BAD_DLL</a>&nbsp;&nbsp;&nbsp;LongToPtr(0xffbadd11)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(lde)&nbsp;&nbsp;&nbsp;LdrpUpdateLoadCount( lde, TRUE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a10">LdrpDereferenceLoadedDll</a>(lde)&nbsp;&nbsp;&nbsp;LdrpUpdateLoadCount( lde, FALSE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>(t)&nbsp;&nbsp;&nbsp;(RTL_HEAP_MAKE_TAG( <a class="el" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a>, t ))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a12">CSR_TAG</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a13">LDR_TAG</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a14">CURDIR_TAG</a>&nbsp;&nbsp;&nbsp;2</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a15">TLS_TAG</a>&nbsp;&nbsp;&nbsp;3</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a16">DBG_TAG</a>&nbsp;&nbsp;&nbsp;4</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a17">SE_TAG</a>&nbsp;&nbsp;&nbsp;5</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a18">TEMP_TAG</a>&nbsp;&nbsp;&nbsp;6</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a19">ATOM_TAG</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine, DllHandle, Reason, Context)&nbsp;&nbsp;&nbsp;(InitRoutine)((DllHandle), (Reason), (Context))</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">_LDRP_PATH_CACHE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a28">LDRP_PATH_CACHE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">_LDRP_PATH_CACHE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a29">PLDRP_PATH_CACHE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">_LDRP_TLS_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a49">LDRP_TLS_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">_LDRP_TLS_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a50">PLDRP_TLS_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a54">LdrpSnapIAT</a> (IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry_Export, IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry_Import, IN PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor, IN BOOLEAN SnapForwardersOnly)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a55">LdrpSnapLinksToDllHandle</a> (IN PVOID DllHandle, IN ULONG NumberOfThunks, IN OUT PIMAGE_THUNK_DATA FirstThunk)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a56">LdrpSnapThunk</a> (IN PVOID DllBase, IN PVOID ImageBase, IN PIMAGE_THUNK_DATA OriginalThunk, IN OUT PIMAGE_THUNK_DATA Thunk, IN PIMAGE_EXPORT_DIRECTORY ExportDirectory, IN ULONG ExportSize, IN BOOLEAN StaticSnap, IN PSZ DllName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a57">LdrpNameToOrdinal</a> (IN PSZ <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN ULONG NumberOfNames, IN PVOID DllBase, IN PULONG NameTableBase, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a58">LdrpAllocateDataTableEntry</a> (IN PVOID DllBase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a59">LdrpCheckForLoadedDll</a> (IN PWSTR DllPath OPTIONAL, IN PUNICODE_STRING DllName, IN BOOLEAN StaticLink, IN BOOLEAN Wx86KnownDll, OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a60">LdrpCheckForLoadedDllHandle</a> (IN PVOID DllHandle, OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a61">LdrpMapDll</a> (IN PWSTR DllPath OPTIONAL, IN PWSTR DllName, IN PULONG DllCharacteristics OPTIONAL, IN BOOLEAN StaticLink, IN BOOLEAN Wx86KnownDll, OUT PLDR_DATA_TABLE_ENTRY *LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a62">LdrpWalkImportDescriptor</a> (IN PWSTR DllPath OPTIONAL, IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a63">LdrpRunInitializeRoutines</a> (IN PCONTEXT Context OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a64">LdrpUpdateLoadCount</a> (IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry, IN BOOLEAN IncrementCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a65">LdrpInitializeProcess</a> (IN PCONTEXT Context OPTIONAL, IN PVOID SystemDllBase, IN PUNICODE_STRING UnicodeImageName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a66">LdrpInitialize</a> (IN PCONTEXT Context, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a67">LdrpInsertMemoryTableEntry</a> (IN PLDR_DATA_TABLE_ENTRY LdrDataTableEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a68">LdrpResolveDllName</a> (IN PWSTR DllPath OPTIONAL, IN PWSTR DllName, OUT PUNICODE_STRING FullDllName, OUT PUNICODE_STRING BaseDllName, OUT PHANDLE DllFile)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a69">LdrpCreateDllSection</a> (IN PUNICODE_STRING FullDllName, IN HANDLE DllFile, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a6">BaseName</a>, IN PULONG DllCharacteristics OPTIONAL, OUT PHANDLE SectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a70">LdrpInitializePathCache</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a71">LdrpFetchAddressOfEntryPoint</a> (IN PVOID Base)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a72">xRtlDosPathNameToNtPathName</a> (IN PSZ DosFileName, OUT PSTRING NtFileName, OUT PSZ *FilePart OPTIONAL, OUT PRTL_RELATIVE_NAME <a class="el" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a73">xRtlDosSearchPath</a> (PSZ lpPath, PSZ lpFileName, PSZ lpExtension, ULONG nBufferLength, PSZ lpBuffer, PSZ *lpFilePart OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a74">xRtlGetFullPathName</a> (PSZ lpFileName, ULONG nBufferLength, PSZ lpBuffer, PSZ *lpFilePart OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSZ&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a75">UnicodeToAnsii</a> (IN PWSTR <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a76">LdrpCheckForKnownDll</a> (IN PWSTR DllName, OUT PUNICODE_STRING FullDllName, OUT PUNICODE_STRING BaseDllName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a77">LdrpSetProtection</a> (IN PVOID Base, IN BOOLEAN Reset, IN BOOLEAN StaticLink)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a78">LdrpInitializeTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a79">LdrpAllocateTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a80">LdrpFreeTls</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a> (PVOID DllBase, ULONG Reason)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a82">LdrpLoadDll</a> (IN PWSTR DllPath OPTIONAL, IN PULONG DllCharacteristics OPTIONAL, IN PUNICODE_STRING DllName, OUT PVOID *DllHandle, IN BOOLEAN RunInitRoutines)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a83">LdrpGetProcedureAddress</a> (IN PVOID DllHandle, IN PANSI_STRING ProcedureName OPTIONAL, IN ULONG ProcedureNumber OPTIONAL, OUT PVOID *ProcedureAddress, IN BOOLEAN RunInitRoutines)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a84">RtlpLockProcessHeapsList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a85">RtlpUnlockProcessHeapsList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a86">RtlpSerializeHeap</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a87">LdrpDefineDllTag</a> (PWSTR TagName, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a> TagIndex)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a21">LdrpImageHasTls</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a> [LDRP_MAX_KNOWN_PATH]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a26">LdrpHashTable</a> [LDRP_HASH_TABLE_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a27">LdrpDefaultPathCache</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a36">LdrpShutdownInProgress</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a37">LdrpInLdrInit</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a38">LdrpLdrDatabaseIsSetup</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a39">LdrpVerifyDlls</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a40">LdrpImageEntry</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>RTL_CRITICAL_SECTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a46">FastPebLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>HANDLE&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a47">LdrpShutdownThreadId</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a19" doxytag="ldrp.h::ATOM_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ATOM_TAG&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00466">466</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ldrp.h::CSR_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CSR_TAG&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00459">459</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, and <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="ldrp.h::CURDIR_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CURDIR_TAG&nbsp;&nbsp;&nbsp;2          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00461">461</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="ldrp.h::DBG_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBG_TAG&nbsp;&nbsp;&nbsp;4          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00463">463</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00517">DbgSsHandleKmApiMsg()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="ldrp.h::LDR_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDR_TAG&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">460</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">LdrpAllocateDataTableEntry()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ldrp.h::LDRP_BAD_DLL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_BAD_DLL&nbsp;&nbsp;&nbsp;LongToPtr(0xffbadd11)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00166">166</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="ldrp.h::LDRP_COMPUTE_HASH_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_COMPUTE_HASH_INDEX          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">wch&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;( (RtlUpcaseUnicodeChar((wch)) - (WCHAR)'A') &amp; LDRP_HASH_MASK )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00161">161</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">LdrpInsertMemoryTableEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ldrp.h::LDRP_HASH_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_HASH_MASK&nbsp;&nbsp;&nbsp;(LDRP_HASH_TABLE_SIZE-1)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00160">160</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ldrp.h::LDRP_HASH_TABLE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_HASH_TABLE_SIZE&nbsp;&nbsp;&nbsp;32          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00159">159</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ldrp.h::LDRP_MAX_KNOWN_PATH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LDRP_MAX_KNOWN_PATH&nbsp;&nbsp;&nbsp;128          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00035">35</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="ldrp.h::LdrpCallInitRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LdrpCallInitRoutine          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">InitRoutine,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>DllHandle,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Reason,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Context&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(InitRoutine)((DllHandle), (Reason), (Context))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">484</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ldrp.h::LdrpDereferenceLoadedDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LdrpDereferenceLoadedDll          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">lde&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;LdrpUpdateLoadCount( lde, FALSE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00254">254</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ldrp.h::LdrpReferenceLoadedDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LdrpReferenceLoadedDll          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">lde&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;LdrpUpdateLoadCount( lde, TRUE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00253">253</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ldrp.h::MAKE_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAKE_TAG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">t&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(RTL_HEAP_MAKE_TAG( <a class="el" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a>, t ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">457</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00483">AddAlias()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04744">AddCommand()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00329">AddExeAliasList()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00080">AddFaceNode()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01683">AllocateCommandHistory()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02609">AllocateScrollBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01817">BeginPopup()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00705">ConsoleAddProcessRoutine()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01091">ConsoleClientConnectRoutine()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01508">ConvertOutputToOem()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01384">ConvertOutputToUnicode()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01237">CookedRead()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l05870">CreateDbcsScreenBuffer()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00103">CreateInputBuffer()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l00485">CreateScreenBuffer()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00106">CsrClientConnectToServer()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00517">DbgSsHandleKmApiMsg()</a>, <a class="el" href="../../d8/d7/ntcon_2server_2clipbrd_8c-source.html#l00835">DoStringPaste()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04346">DrawCommandListPopup()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00515">EnumerateFonts()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01676">FalseUnicodeToRealUnicode()</a>, <a class="el" href="../../d0/d2/__priv_8h-source.html#l00041">FE_WriteRegionToScreenHW()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00394">FindExe()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01637">FindExeCommandHistory()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00401">FlushAllButKeys()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00152">FontEnum()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00223">GrowConsoleHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01234">GrowIoHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00561">InheritIoHandleTable()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l01335">InitializeInputHandle()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02631">InitializeScrollBuffer()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">LdrpAllocateDataTableEntry()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01105">MatchandCopyAlias()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l01124">MergeAttrStrings()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01670">MyRegQueryValue()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01410">PrependInputBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l02287">ProcessCommandListInput()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03865">ProcessCtrlEvents()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04267">QueueConsoleMessage()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01860">QueueThreadMessage()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l00471">RawReadWaitRoutine()</a>, <a class="el" href="../../d1/d6/server_2stream_8c-source.html#l01778">ReadChars()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l01795">ReadOutputString()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l01597">ReallocCommandHistory()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l01573">RealUnicodeToFalseUnicode()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l05985">ReCreateDbcsScreenBuffer()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00524">ReplaceAlias()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02231">ResizeScreenBuffer()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01021">RtlCopySecurityDescriptor()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00516">SetInputBufferSize()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03336">SetRAMFont()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l03175">SetRAMFontCodePage()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00608">SrvAddConsoleAlias()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01537">SrvAllocConsole()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l00731">SrvGetConsoleAlias()</a>, <a class="el" href="../../d4/d0/server_2cmdline_8c-source.html#l04929">SrvSetConsoleTitle()</a>, <a class="el" href="../../d3/d4/srvvdm_8c-source.html#l00024">SrvVDMConsoleOperation()</a>, <a class="el" href="../../d3/d7/directio_8c-source.html#l01284">SrvWriteConsoleOutput()</a>, <a class="el" href="../../d8/d7/ntcon_2server_2clipbrd_8c-source.html#l00452">StoreSelection()</a>, <a class="el" href="../../d5/d9/w32_2ntcon_2server_2misc_8c-source.html#l00881">StoreTextBufferFontInfo()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01831">TranslateConsoleTitle()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l02674">UpdateComplexRegion()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l00248">WaitForMoreToRead()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l01020">WWSB_DoSrvWriteConsole()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l00809">WWSB_DoWriteConsole()</a>, <a class="el" href="../../d1/d2/__stream_8h-source.html#l00203">WWSB_WriteChars()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l01002">WWSB_WriteOutputString()</a>, <a class="el" href="../../d9/d1/__output_8h-source.html#l00187">WWSB_WriteRectToScreenBuffer()</a>, and <a class="el" href="../../d9/d1/__output_8h-source.html#l00552">WWSB_WriteRegionToScreen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ldrp.h::NATIVE_BYTES_TO_PAGES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NATIVE_BYTES_TO_PAGES          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;BYTES_TO_PAGES(<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00155">155</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ldrp.h::NATIVE_PAGE_SHIFT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NATIVE_PAGE_SHIFT&nbsp;&nbsp;&nbsp;PAGE_SHIFT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00154">154</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="ldrp.h::NATIVE_PAGE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NATIVE_PAGE_SIZE&nbsp;&nbsp;&nbsp;PAGE_SIZE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00153">153</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ldrp.h::NOEXTAPI" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NOEXTAPI          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00028">28</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="ldrp.h::SE_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SE_TAG&nbsp;&nbsp;&nbsp;5          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00464">464</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01021">RtlCopySecurityDescriptor()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01260">RtlCreateAndSetSD()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l07461">RtlpConvertAclToAutoInherit()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l06520">RtlpConvertToAutoInheritSecurityObject()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08588">RtlpCreateServerAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l05153">RtlpInheritAcl()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l09057">RtlpNewSecurityObject()</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="ldrp.h::TEMP_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TEMP_TAG&nbsp;&nbsp;&nbsp;6          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">465</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="ldrp.h::TLS_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define TLS_TAG&nbsp;&nbsp;&nbsp;3          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00462">462</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a28" doxytag="ldrp.h::LDRP_PATH_CACHE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">_LDRP_PATH_CACHE</a>  <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">LDRP_PATH_CACHE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="ldrp.h::LDRP_TLS_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">_LDRP_TLS_ENTRY</a>  <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">LDRP_TLS_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="ldrp.h::PLDRP_PATH_CACHE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">_LDRP_PATH_CACHE</a> * <a class="el" href="../../d7/d9/struct__LDRP__PATH__CACHE.html">PLDRP_PATH_CACHE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="ldrp.h::PLDRP_TLS_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">_LDRP_TLS_ENTRY</a> * <a class="el" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a58" doxytag="ldrp.h::LdrpAllocateDataTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY LdrpAllocateDataTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DllBase</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">3043</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">LDR_TAG</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, and <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03049                    :
03050 
03051     This function allocates an entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03052     table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to overflow, then a <span class="keyword">new</span> table <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated.
03053 
03054 Arguments:
03055 
03056     DllBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL Image.
03057         be added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table.
03058 
03059 Return Value:
03060 
03061     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated loader data table entry
03062 
03063 --*/
03064 
03065 {
03066     PLDR_DATA_TABLE_ENTRY Entry;
03067     PIMAGE_NT_HEADERS NtHeaders;
03068 
03069     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase);
03070 
03071     Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03072     <span class="keywordflow">if</span> ( NtHeaders ) {
03073         Entry = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ) | HEAP_ZERO_MEMORY,<span class="keyword">sizeof</span>( *Entry ));
03074         <span class="keywordflow">if</span> ( Entry ) {
03075             Entry-&gt;DllBase = DllBase;
03076             Entry-&gt;SizeOfImage = NtHeaders-&gt;OptionalHeader.SizeOfImage;
03077             Entry-&gt;TimeDateStamp = NtHeaders-&gt;FileHeader.TimeDateStamp;
03078             }
03079         }
03080     <span class="keywordflow">return</span> Entry;
03081 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="ldrp.h::LdrpAllocateTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpAllocateTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">2071</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d2/ldrp_8h.html#a49">LDRP_TLS_ENTRY</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00401">LdrpNumberOfTlsEntries</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00397">_LDRP_TLS_ENTRY::Tls</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00462">TLS_TAG</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.
<p>
<pre class="fragment"><div>02074 {
02075     PTEB Teb;
02076     PLIST_ENTRY Head, Next;
02077     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
02078     PVOID *TlsVector;
02079 
02080     Teb = NtCurrentTeb();
02081 
02082     <span class="comment">//</span>
02083     <span class="comment">// Allocate the array of thread local storage pointers</span>
02084     <span class="comment">//</span>
02085 
02086     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a> ) {
02087         TlsVector = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),<span class="keyword">sizeof</span>(PVOID)*LdrpNumberOfTlsEntries);
02088         <span class="keywordflow">if</span> ( !TlsVector ) {
02089             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02090             }
02091 
02092         Teb-&gt;ThreadLocalStoragePointer = TlsVector;
02093         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a>;
02094         Next = Head-&gt;Flink;
02095 
02096         <span class="keywordflow">while</span> ( Next != Head ) {
02097             TlsEntry = CONTAINING_RECORD(Next, <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">LDRP_TLS_ENTRY</a>, Links);
02098             Next = Next-&gt;Flink;
02099             TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
02100                                                         RtlProcessHeap(),
02101                                                         <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),
02102                                                         TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.EndAddressOfRawData - TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData
02103                                                         );
02104             <span class="keywordflow">if</span> (!TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] ) {
02105                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02106                 }
02107 
02108             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02109                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: TlsVector %x Index %d = %x copied from %x to %x\n"</span>,
02110                     TlsVector,
02111                     TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics,
02112                     &amp;TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics],
02113                     TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData,
02114                     TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics]
02115                     );
02116                 }
02117 
02118             RtlCopyMemory(
02119                 TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics],
02120                 (PVOID)TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData,
02121                 TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.EndAddressOfRawData - TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.StartAddressOfRawData
02122                 );
02123 
02124             <span class="comment">//</span>
02125             <span class="comment">// Do the TLS Callouts</span>
02126             <span class="comment">//</span>
02127 
02128             }
02129         }
02130     <span class="keywordflow">return</span> STATUS_SUCCESS;
02131 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="ldrp.h::LdrpCallTlsInitializers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpCallTlsInitializers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reason</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">2178</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.
<p>
<pre class="fragment"><div>02182 {
02183     PIMAGE_TLS_DIRECTORY TlsImage;
02184     ULONG TlsSize;
02185     PIMAGE_TLS_CALLBACK *CallBackArray;
02186     PIMAGE_TLS_CALLBACK InitRoutine;
02187 
02188     TlsImage = (PIMAGE_TLS_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02189                        DllBase,
02190                        TRUE,
02191                        IMAGE_DIRECTORY_ENTRY_TLS,
02192                        &amp;TlsSize
02193                        );
02194 
02195 
02196     <span class="keywordflow">try</span> {
02197         <span class="keywordflow">if</span> ( TlsImage ) {
02198             CallBackArray = (PIMAGE_TLS_CALLBACK *)TlsImage-&gt;AddressOfCallBacks;
02199             <span class="keywordflow">if</span> ( CallBackArray ) {
02200                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02201                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Tls Callbacks Found. Imagebase %lx Tls %lx CallBacks %lx\n"</span>,
02202                                 DllBase,
02203                                 TlsImage,
02204                                 CallBackArray
02205                             );
02206                     }
02207 
02208                 <span class="keywordflow">while</span>(*CallBackArray){
02209                     InitRoutine = *CallBackArray++;
02210 
02211                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02212                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Calling Tls Callback Imagebase %lx Function %lx\n"</span>,
02213                                     DllBase,
02214                                     InitRoutine
02215                                 );
02216                         }
02217 
02218 <span class="preprocessor">#if defined (WX86)</span>
02219 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!Wx86ProcessInit ||
02220                         LdrpRunWx86DllEntryPoint(
02221                              (PDLL_INIT_ROUTINE)InitRoutine,
02222                              NULL,
02223                              DllBase,
02224                              Reason,
02225                              NULL
02226                              ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
02227 <span class="preprocessor">#endif</span>
02228 <span class="preprocessor"></span>                       {
02229                         <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>((PDLL_INIT_ROUTINE)InitRoutine,
02230                                             DllBase,
02231                                             Reason,
02232                                             0);
02233                         }
02234 
02235                     }
02236                 }
02237             }
02238         }
02239     except (EXCEPTION_EXECUTE_HANDLER) {
02240         ;
02241         }
02242 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="ldrp.h::LdrpCheckForKnownDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE LdrpCheckForKnownDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseDllName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">3283</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">LDR_TAG</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00034">LdrpKnownDllObjectDirectory</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00037">LdrpKnownDllPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l04250">NtOpenSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00844">Unicode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03291                    :
03292 
03293     This function checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DLL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a known DLL.
03294     It assumes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called <span class="keywordflow">for</span> <span class="keyword">static</span> DLL's, and when
03295     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> know DLL directory structure has been set up.
03296 
03297 Arguments:
03298 
03299     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
03300 
03301     FullDllName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fully qualified pathname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03302         DLL. The <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> field of <span class="keyword">this</span> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dynamically
03303         allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes heap.
03304 
03305     BaseDLLName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base dll name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll.  The base name
03306         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trailing
03307         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>. The <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> field of <span class="keyword">this</span> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dynamically
03308         allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes heap.
03309 
03310 Return Value:
03311 
03312     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section associated with
03313         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
03314 
03315     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The DLL <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not known.
03316 
03317 --*/
03318 
03319 {
03320 
03321     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
03322     HANDLE Section;
03323     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03324     OBJECT_ATTRIBUTES Obja;
03325     PSZ p;
03326     PWSTR pw;
03327 
03328     Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03329 
03330     <span class="comment">//</span>
03331     <span class="comment">// calculate base name</span>
03332     <span class="comment">//</span>
03333 
03334     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,DllName);
03335 
03336 
03337     BaseDllName-&gt;Length = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length;
03338     BaseDllName-&gt;MaximumLength = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength;
03339     BaseDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
03340                             RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ),
03341                             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength
03342                             );
03343     <span class="keywordflow">if</span> ( !BaseDllName-&gt;Buffer ) {
03344         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03345         }
03346 
03347     RtlMoveMemory(BaseDllName-&gt;Buffer,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Buffer,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength);
03348 
03349     <span class="comment">//</span>
03350     <span class="comment">// now compute the full name for the dll</span>
03351     <span class="comment">//</span>
03352 
03353     FullDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length +  <span class="comment">// path prefix</span>
03354                                    (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(WCHAR)   +  <span class="comment">// seperator</span>
03355                                    BaseDllName-&gt;Length        <span class="comment">// base</span>
03356                                   );
03357 
03358     FullDllName-&gt;MaximumLength = FullDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03359     FullDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
03360                             RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ),
03361                             FullDllName-&gt;MaximumLength
03362                             );
03363     <span class="keywordflow">if</span> ( !FullDllName-&gt;Buffer ) {
03364         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,BaseDllName-&gt;Buffer);
03365         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03366         }
03367 
03368     p = (PSZ)FullDllName-&gt;Buffer;
03369     RtlMoveMemory(p,<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Buffer,<a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length);
03370     p += <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length;
03371     pw = (PWSTR)p;
03372     *pw++ = (WCHAR)<span class="charliteral">'\\'</span>;
03373     p = (PSZ)pw;
03374 
03375     <span class="comment">//</span>
03376     <span class="comment">// This is the relative name of the section</span>
03377     <span class="comment">//</span>
03378 
03379     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Buffer = (PWSTR)p;
03380     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length = BaseDllName-&gt;Length;       <span class="comment">// base</span>
03381     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.MaximumLength = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03382 
03383     RtlMoveMemory(p,BaseDllName-&gt;Buffer,BaseDllName-&gt;MaximumLength);
03384 
03385     <span class="comment">//</span>
03386     <span class="comment">// open the section object</span>
03387     <span class="comment">//</span>
03388 
03389     InitializeObjectAttributes(
03390         &amp;Obja,
03391         &amp;Unicode,
03392         OBJ_CASE_INSENSITIVE,
03393         LdrpKnownDllObjectDirectory,
03394         NULL
03395         );
03396 
03397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d8/creasect_8c.html#a24">NtOpenSection</a>(
03398             &amp;Section,
03399             SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE,
03400             &amp;Obja
03401             );
03402 
03403     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
03404         Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03405         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,BaseDllName-&gt;Buffer);
03406         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,FullDllName-&gt;Buffer);
03407         }
03408 <span class="preprocessor">#if DBG</span>
03409 <span class="preprocessor"></span>    <span class="keywordflow">else</span> {
03410         LdrpSectionOpens++;
03411         }
03412 <span class="preprocessor">#endif // DBG</span>
03413 <span class="preprocessor"></span>    <span class="keywordflow">return</span> Section;
03414 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="ldrp.h::LdrpCheckForLoadedDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LdrpCheckForLoadedDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StaticLink</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wx86KnownDll</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLDR_DATA_TABLE_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">832</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00161">LDRP_COMPUTE_HASH_INDEX</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">LdrpDefaultPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00162">LdrpHashTable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l02965">NtAreMappedFilesTheSame()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d5/d1/open_8c-source.html#l00034">NtOpenFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01763">RtlCopyUnicodeString()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l01717">RtlDosPathNameToNtPathName_U()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02156">RtlDosSearchPath_U()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03710">LdrpDphDetectSnapRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03970">LdrpDphInitializeTargetDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00140">LdrpLoadImportModule()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02802">LdrpUpdateLoadCount()</a>.
<p>
<pre class="fragment"><div>00842                    :
00843 
00844     This function scans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table looking to see <span class="keywordflow">if</span>
00845     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DLL has already been mapped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image. If
00846     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll has been loaded, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of its data table entry
00847     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00848 
00849 Arguments:
00850 
00851     DllPath - Supplies an optional search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00852 
00853     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to search <span class="keywordflow">for</span>.
00854 
00855     StaticLink - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> performing a <span class="keyword">static</span> link.
00856 
00857     Wx86KnownDll - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, treat Importer as x86
00858 
00859     LdrDataTableEntry - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table
00860         entry that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first dll section that implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00861         dll.
00862 
00863 Return Value:
00864 
00865     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>- The dll <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already loaded.  The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data table
00866         entries that implement <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of data table
00867         entries are returned.
00868 
00869     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The dll <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already mapped.
00870 
00871 --*/
00872 
00873 {
00874     BOOLEAN Result;
00875     PLDR_DATA_TABLE_ENTRY Entry;
00876     PLIST_ENTRY Head, Next;
00877     UNICODE_STRING FullDllName;
00878     HANDLE DllFile;
00879     BOOLEAN HardCodedPath;
00880     PWCH p;
00881     WCHAR wch;
00882     ULONG i;
00883     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> FullDllNameBuffer[530+<span class="keyword">sizeof</span>(UNICODE_NULL)];
00884     ULONG Length = 0;
00885     PWCH src,dest;
00886 
00887 
00888 
00889     <span class="keywordflow">if</span> (!DllName-&gt;Buffer || !DllName-&gt;Buffer[0]) {
00890         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891         }
00892 
00893 <span class="preprocessor">#if defined (WX86)</span>
00894 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wx86ProcessInit) {
00895 
00896         FullDllName.Buffer = (PWCHAR)FullDllNameBuffer;
00897         FullDllName.MaximumLength = <span class="keyword">sizeof</span>(FullDllNameBuffer);
00898         FullDllName.Length = 0;
00899 
00900         Entry = LdrpWx86CheckForLoadedDll(DllPath,
00901                                           DllName,
00902                                           Wx86KnownDll,
00903                                           &amp;FullDllName
00904                                           );
00905 
00906         <span class="keywordflow">if</span> (Entry) {
00907             <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(DllName, &amp;FullDllName);
00908             *LdrDataTableEntry = Entry;
00909             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910             }
00911         <span class="keywordflow">else</span> {
00912             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00913             }
00914         }
00915 
00916 <span class="preprocessor">#endif</span>
00917 <span class="preprocessor"></span>
00918 
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">// for static links, just go to the hash table</span>
00922     <span class="comment">//</span>
00923 staticlink:
00924     <span class="keywordflow">if</span> ( StaticLink ) {
00925 
00926         i = <a class="code" href="../../d9/d2/ldrp_8h.html#a7">LDRP_COMPUTE_HASH_INDEX</a>(DllName-&gt;Buffer[0]);
00927         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a26">LdrpHashTable</a>[i];
00928         Next = Head-&gt;Flink;
00929         <span class="keywordflow">while</span> ( Next != Head ) {
00930             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, HashLinks);
00931 <span class="preprocessor">#if DBG</span>
00932 <span class="preprocessor"></span>            LdrpCompareCount++;
00933 <span class="preprocessor">#endif</span>
00934 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(DllName,
00935                         &amp;Entry-&gt;BaseDllName,
00936                         TRUE
00937                         )) {
00938 
00939                 *LdrDataTableEntry = Entry;
00940                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00941                 }
00942             Next = Next-&gt;Flink;
00943             }
00944         }
00945 
00946     <span class="keywordflow">if</span> ( StaticLink ) {
00947         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00948         }
00949 
00950 
00951     <span class="comment">//</span>
00952     <span class="comment">// If the dll name contained a hard coded path</span>
00953     <span class="comment">// (dynamic link only), then the fully qualified</span>
00954     <span class="comment">// name needs to be compared to make sure we</span>
00955     <span class="comment">// have the correct dll.</span>
00956     <span class="comment">//</span>
00957 
00958     p = DllName-&gt;Buffer;
00959     HardCodedPath = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00960     <span class="keywordflow">while</span> (*p) {
00961         wch = *p++;
00962         <span class="keywordflow">if</span> (wch == (WCHAR)<span class="charliteral">'\\'</span> || wch == (WCHAR)<span class="charliteral">'/'</span> ) {
00963 
00964             HardCodedPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00965 
00966             <span class="comment">//</span>
00967             <span class="comment">// We have a hard coded path, so we have to search path</span>
00968             <span class="comment">// for the DLL. We need the full DLL name so we can</span>
00969 
00970             FullDllName.Buffer = (WCHAR *)FullDllNameBuffer;
00971 
00972             Length = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(
00973                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
00974                         DllName-&gt;Buffer,
00975                         NULL,
00976                         <span class="keyword">sizeof</span>(FullDllNameBuffer)-<span class="keyword">sizeof</span>(UNICODE_NULL),
00977                         FullDllName.Buffer,
00978                         NULL
00979                         );
00980             <span class="keywordflow">if</span> ( !Length || Length &gt; <span class="keyword">sizeof</span>(FullDllNameBuffer)-<span class="keyword">sizeof</span>(UNICODE_NULL) ) {
00981 
00982                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00983                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpCheckForLoadedDll - Unable To Locate "</span>);
00984                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ws from %ws\n"</span>,
00985                         DllName-&gt;Buffer,
00986                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer
00987                         );
00988                     }
00989 
00990                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00991                 }
00992 
00993             FullDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00994             FullDllName.MaximumLength = FullDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
00995             <span class="keywordflow">break</span>;
00996             }
00997         }
00998 
00999     <span class="comment">//</span>
01000     <span class="comment">// if this is a dynamic load lib, and there is not a hard</span>
01001     <span class="comment">// coded path, then go to the static lib hash table for resolution</span>
01002     <span class="comment">//</span>
01003 
01004     <span class="keywordflow">if</span> ( !HardCodedPath ) {
01005 
01006         StaticLink = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01007 
01008         <span class="keywordflow">goto</span> staticlink;
01009         }
01010 
01011 
01012     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01013     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01014     Next = Head-&gt;Flink;
01015 
01016     <span class="keywordflow">while</span> ( Next != Head ) {
01017         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01018         Next = Next-&gt;Flink;
01019 
01020         <span class="comment">//</span>
01021         <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01022         <span class="comment">// this is used to skip the entry pending list removal.</span>
01023         <span class="comment">//</span>
01024 
01025         <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01026             <span class="keywordflow">continue</span>;
01027         }
01028 
01029 
01030         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(
01031                 &amp;FullDllName,
01032                 &amp;Entry-&gt;FullDllName,
01033                 TRUE
01034                 ) ) {
01035 
01036                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01037                 *LdrDataTableEntry = Entry;
01038                 <span class="keywordflow">break</span>;
01039             }
01040         }
01041 
01042     <span class="keywordflow">if</span> ( !Result ) {
01043 
01044         <span class="comment">//</span>
01045         <span class="comment">// no names matched. This might be a long short name mismatch or</span>
01046         <span class="comment">// any kind of alias pathname. Deal with this by opening and mapping</span>
01047         <span class="comment">// full dll name and then repeat the scan this time checking for</span>
01048         <span class="comment">// timedatestamp matches</span>
01049         <span class="comment">//</span>
01050 
01051         HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
01052         HANDLE Section;
01053         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01054         OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
01055         IO_STATUS_BLOCK IoStatus;
01056         PVOID ViewBase;
01057         SIZE_T ViewSize;
01058         PIMAGE_NT_HEADERS NtHeadersSrc,NtHeadersE;
01059         UNICODE_STRING NtFileName;
01060 
01061 
01062         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/curdir_8c.html#a29">RtlDosPathNameToNtPathName_U</a>( FullDllName.Buffer,
01063                                            &amp;NtFileName,
01064                                            NULL,
01065                                            NULL
01066                                          )
01067            ) {
01068             <span class="keywordflow">goto</span> alldone;
01069             }
01070 
01071         InitializeObjectAttributes(
01072             &amp;ObjectAttributes,
01073             &amp;NtFileName,
01074             OBJ_CASE_INSENSITIVE,
01075             NULL,
01076             NULL
01077             );
01078 
01079         st = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
01080                 &amp;File,
01081                 SYNCHRONIZE | FILE_EXECUTE,
01082                 &amp;ObjectAttributes,
01083                 &amp;IoStatus,
01084                 FILE_SHARE_READ | FILE_SHARE_DELETE,
01085                 FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT
01086                 );
01087         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NtFileName.Buffer);
01088 
01089         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01090             <span class="keywordflow">goto</span> alldone;
01091             }
01092 
01093         st = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
01094                 &amp;Section,
01095                 SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE,
01096                 NULL,
01097                 NULL,
01098                 PAGE_EXECUTE,
01099                 SEC_COMMIT,
01100                 File
01101                 );
01102         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( File );
01103 
01104         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01105             <span class="keywordflow">goto</span> alldone;
01106             }
01107 
01108         ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01109         ViewSize = 0;
01110         st = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01111                 Section,
01112                 NtCurrentProcess(),
01113                 (PVOID *)&amp;ViewBase,
01114                 0L,
01115                 0L,
01116                 NULL,
01117                 &amp;ViewSize,
01118                 ViewShare,
01119                 0L,
01120                 PAGE_EXECUTE
01121                 );
01122         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01123         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01124             <span class="keywordflow">goto</span> alldone;
01125             }
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// The section is mapped. Now find the headers</span>
01129         <span class="comment">//</span>
01130         NtHeadersSrc = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01131         <span class="keywordflow">if</span> ( !NtHeadersSrc ) {
01132             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01133             <span class="keywordflow">goto</span> alldone;
01134             }
01135         Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01136         Next = Head-&gt;Flink;
01137 
01138         <span class="keywordflow">while</span> ( Next != Head ) {
01139             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01140             Next = Next-&gt;Flink;
01141 
01142             <span class="comment">//</span>
01143             <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01144             <span class="comment">// this is used to skip the entry pending list removal.</span>
01145             <span class="comment">//</span>
01146 
01147             <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01148                 <span class="keywordflow">continue</span>;
01149             }
01150 
01151             <span class="keywordflow">try</span> {
01152                 <span class="keywordflow">if</span> ( Entry-&gt;TimeDateStamp == NtHeadersSrc-&gt;FileHeader.TimeDateStamp &amp;&amp;
01153                      Entry-&gt;SizeOfImage == NtHeadersSrc-&gt;OptionalHeader.SizeOfImage ) {
01154 
01155                     <span class="comment">//</span>
01156                     <span class="comment">// there is a very good chance we have an image match. Check the</span>
01157                     <span class="comment">// entire file header and optional header. If they match, declare</span>
01158                     <span class="comment">// this a match</span>
01159                     <span class="comment">//</span>
01160 
01161                     NtHeadersE = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Entry-&gt;DllBase);
01162 
01163                     <span class="keywordflow">if</span> ( RtlCompareMemory(NtHeadersE,NtHeadersSrc,<span class="keyword">sizeof</span>(*NtHeadersE)) ) {
01164 
01165                         <span class="comment">//</span>
01166                         <span class="comment">// Now that it looks like we have a match, compare</span>
01167                         <span class="comment">// volume serial number's and file index's</span>
01168                         <span class="comment">//</span>
01169 
01170                         st = <a class="code" href="../../d3/d5/mapview_8c.html#a26">NtAreMappedFilesTheSame</a>(Entry-&gt;DllBase,ViewBase);
01171 
01172                         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01173                             <span class="keywordflow">continue</span>;
01174                             }
01175                         <span class="keywordflow">else</span> {
01176                             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01177                             *LdrDataTableEntry = Entry;
01178                             <span class="keywordflow">break</span>;
01179                             }
01180                         }
01181                     }
01182                 }
01183             except (EXCEPTION_EXECUTE_HANDLER) {
01184                 <span class="keywordflow">break</span>;
01185                 }
01186             }
01187         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01188         }
01189 
01190 alldone:
01191     <span class="keywordflow">return</span> Result;
01192 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="ldrp.h::LdrpCheckForLoadedDllHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LdrpCheckForLoadedDllHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLDR_DATA_TABLE_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">1196</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00385">LdrpLoadedDllHandleCache</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.
<p>
<pre class="fragment"><div>01203                    :
01204 
01205     This function scans <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table looking to see <span class="keywordflow">if</span>
01206     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified DLL has already been mapped into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image address
01207     space. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll has been loaded, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of its data table
01208     entry that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
01209 
01210 Arguments:
01211 
01212     DllHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DllHandle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL being searched <span class="keywordflow">for</span>.
01213 
01214     LdrDataTableEntry - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table
01215         entry that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll.
01216 
01217 Return Value:
01218 
01219     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>- The dll <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loaded.  The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data table entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01220         returned.
01221 
01222     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The dll <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not loaded.
01223 
01224 --*/
01225 
01226 {
01227     PLDR_DATA_TABLE_ENTRY Entry;
01228     PLIST_ENTRY Head,Next;
01229 
01230     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> &amp;&amp;
01231         (PVOID) <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a>-&gt;DllBase == DllHandle ) {
01232         *LdrDataTableEntry = <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a>;
01233         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01234         }
01235 
01236     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01237     Next = Head-&gt;Flink;
01238 
01239     <span class="keywordflow">while</span> ( Next != Head ) {
01240         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01241         Next = Next-&gt;Flink;
01242         <span class="comment">//</span>
01243         <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01244         <span class="comment">// this is used to skip the entry pending list removal.</span>
01245         <span class="comment">//</span>
01246 
01247         <span class="keywordflow">if</span> ( !Entry-&gt;InMemoryOrderLinks.Flink ) {
01248             <span class="keywordflow">continue</span>;
01249         }
01250 
01251         <span class="keywordflow">if</span> (DllHandle == (PVOID)Entry-&gt;DllBase ){
01252             <a class="code" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a> = Entry;
01253             *LdrDataTableEntry = Entry;
01254             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01255         }
01256     }
01257     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01258 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="ldrp.h::LdrpCreateDllSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpCreateDllSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DllFile</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>SectionHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">2150</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d8/icmui_8def-source.html#l00004">File</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00386">LdrpFatalHardErrorCount</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l00134">NtCreateSection()</a>, <a class="el" href="../../d5/d1/open_8c-source.html#l00034">NtOpenFile()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00532">NtRaiseHardError()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00027">ObjectAttributes</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>02157 {
02158     HANDLE <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a>;
02159     HANDLE Section;
02160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02161     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
02162     IO_STATUS_BLOCK IoStatus;
02163 
02164     <span class="keywordflow">if</span> ( !DllFile ) {
02165         <span class="comment">//</span>
02166         <span class="comment">// Since ntsdk does not search paths well, we can't use</span>
02167         <span class="comment">// relative object names</span>
02168         <span class="comment">//</span>
02169 
02170         InitializeObjectAttributes(
02171             &amp;ObjectAttributes,
02172             NtFullDllName,
02173             OBJ_CASE_INSENSITIVE,
02174             NULL,
02175             NULL
02176             );
02177 
02178         st = <a class="code" href="../../d4/d2/open_8c.html#a0">NtOpenFile</a>(
02179                 &amp;File,
02180                 SYNCHRONIZE | FILE_EXECUTE,
02181                 &amp;ObjectAttributes,
02182                 &amp;IoStatus,
02183                 FILE_SHARE_READ | FILE_SHARE_DELETE,
02184                 FILE_NON_DIRECTORY_FILE | FILE_SYNCHRONOUS_IO_NONALERT
02185                 );
02186         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02187 
02188 <span class="preprocessor">#if DBG</span>
02189 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrCreateDllSection - NtOpenFile( %wZ ) failed. Status == %X\n"</span>,
02190                 NtFullDllName,
02191                 st
02192                 );
02193 <span class="preprocessor">#endif</span>
02194 <span class="preprocessor"></span>            *SectionHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02195             <span class="keywordflow">return</span> st;
02196         }
02197 
02198 
02199     } <span class="keywordflow">else</span> {
02200              <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> = DllFile;
02201            }
02202 
02203 
02204     st = <a class="code" href="../../d0/d8/creasect_8c.html#a19">NtCreateSection</a>(
02205             SectionHandle,
02206             SECTION_MAP_READ | SECTION_MAP_EXECUTE | SECTION_MAP_WRITE | SECTION_QUERY,
02207             NULL,
02208             NULL,
02209             PAGE_EXECUTE,
02210             SEC_IMAGE,
02211             File
02212             );
02213     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( File );
02214 
02215     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02216 
02217         <span class="comment">//</span>
02218         <span class="comment">// hard error time</span>
02219         <span class="comment">//</span>
02220 
02221         ULONG_PTR ErrorParameters[1];
02222         ULONG ErrorResponse;
02223 
02224         *SectionHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02225         ErrorParameters[0] = (ULONG_PTR)NtFullDllName;
02226 
02227         <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
02228           STATUS_INVALID_IMAGE_FORMAT,
02229           1,
02230           1,
02231           ErrorParameters,
02232           OptionOk,
02233           &amp;ErrorResponse
02234           );
02235 
02236         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
02237             <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
02238             }
02239 
02240 
02241 <span class="preprocessor">#if DBG</span>
02242 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (st != STATUS_INVALID_IMAGE_NE_FORMAT &amp;&amp;
02243             st != STATUS_INVALID_IMAGE_LE_FORMAT &amp;&amp;
02244             st != STATUS_INVALID_IMAGE_WIN_16
02245            ) {
02246             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrCreateDllSection - NtCreateSection %wZ failed. Status == %X\n"</span>,
02247                      NtFullDllName,
02248                      st
02249                     );
02250         }
02251 <span class="preprocessor">#endif</span>
02252 <span class="preprocessor"></span>    }
02253 
02254     <span class="keywordflow">return</span> st;
02255 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="ldrp.h::LdrpDefineDllTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID LdrpDefineDllTag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>TagName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TagIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00191">191</a> of file <a class="el" href="../../d1/d9/heaptag_8c-source.html">heaptag.c</a>.
<p>
References <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00027">LDRP_MAXIMUM_DLL_TAGS</a>, <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00123">LdrpDllTagProcedures</a>, <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00032">LdrpDllTags</a>, <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00029">LdrpDllTagsInitialized</a>, <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00030">LdrpNumberOfDllTags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00462">RtlpGlobalTagHeap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00353">_HEAP::VirtualAllocdBlocks</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">LdrpWalkImportDescriptor()</a>.
<p>
<pre class="fragment"><div>00195 {
00196     PVOID Result;
00197     WCHAR TagNameBuffer[ 260 ];
00198 
00199     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200         <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap( ), HEAP_ZERO_MEMORY, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__HEAP.html">HEAP</a> ));
00201         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00202             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203         }
00204     }
00205     
00206     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/heaptag_8c.html#a2">LdrpDllTagsInitialized</a>) {
00207         <span class="comment">//</span>
00208         <span class="comment">// Keep QUERY.C happy</span>
00209         <span class="comment">//</span>
00210         InitializeListHead( &amp;<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o21">VirtualAllocdBlocks</a> );
00211         <a class="code" href="../../d0/d0/heaptag_8c.html#a2">LdrpDllTagsInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00212         }
00213 
00214     Result = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00215     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> &lt; <a class="code" href="../../d0/d0/heaptag_8c.html#a0">LDRP_MAXIMUM_DLL_TAGS</a>) {
00216         memset( TagNameBuffer, 0, <span class="keyword">sizeof</span>( TagNameBuffer ) );
00217         wcscpy( TagNameBuffer, TagName );
00218         <a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] =
00219             <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( NULL,
00220                               0,
00221                               NULL,
00222                               TagNameBuffer
00223                             );
00224 
00225         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] != 0) {
00226             Result = <a class="code" href="../../d0/d0/heaptag_8c.html#a7">LdrpDllTagProcedures</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ];
00227             }
00228 
00229         <span class="keywordflow">if</span> (Result != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00230             *TagIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d0/d0/heaptag_8c.html#a5">LdrpDllTags</a>[ <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> ] &gt;&gt; HEAP_TAG_SHIFT);
00231             <a class="code" href="../../d0/d0/heaptag_8c.html#a3">LdrpNumberOfDllTags</a> += 1;
00232             }
00233         }
00234 
00235     <span class="keywordflow">return</span> Result;
00236 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="ldrp.h::LdrpFetchAddressOfEntryPoint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID LdrpFetchAddressOfEntryPoint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Base</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03249">3249</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03255                    :
03256 
03257     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization routine.
03258 
03259 Arguments:
03260 
03261     Base - Base of image.
03262 
03263 Return Value:
03264 
03265     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
03266 
03267 --*/
03268 
03269 {
03270     PIMAGE_NT_HEADERS NtHeaders;
03271     ULONG_PTR ep;
03272 
03273     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
03274     ep = NtHeaders-&gt;OptionalHeader.AddressOfEntryPoint;
03275     <span class="keywordflow">if</span> (ep) {
03276         ep += (ULONG_PTR)Base;
03277     }
03278 
03279     <span class="keywordflow">return</span> (PVOID)ep;
03280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="ldrp.h::LdrpFreeTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpFreeTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02134">2134</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00397">_LDRP_TLS_ENTRY::Tls</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.
<p>
<pre class="fragment"><div>02137 {
02138     PTEB Teb;
02139     PLIST_ENTRY Head, Next;
02140     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
02141     PVOID *TlsVector;
02142 
02143     Teb = NtCurrentTeb();
02144 
02145     TlsVector = Teb-&gt;ThreadLocalStoragePointer;
02146 
02147     <span class="keywordflow">if</span> ( TlsVector ) {
02148         Head = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a>;
02149         Next = Head-&gt;Flink;
02150 
02151         <span class="keywordflow">while</span> ( Next != Head ) {
02152             TlsEntry = CONTAINING_RECORD(Next, <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">LDRP_TLS_ENTRY</a>, Links);
02153             Next = Next-&gt;Flink;
02154 
02155             <span class="comment">//</span>
02156             <span class="comment">// Do the TLS callouts</span>
02157             <span class="comment">//</span>
02158 
02159             <span class="keywordflow">if</span> ( TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics] ) {
02160                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(
02161                     RtlProcessHeap(),
02162                     0,
02163                     TlsVector[TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics]
02164                     );
02165 
02166                 }
02167             }
02168 
02169         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(
02170             RtlProcessHeap(),
02171             0,
02172             TlsVector
02173             );
02174         }
02175 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="ldrp.h::LdrpGetProcedureAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI LdrpGetProcedureAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PANSI_STRING ProcedureName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ProcedureNumber&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcedureAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RunInitRoutines</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">851</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">LdrpCheckForLoadedDllHandle()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">TEMP_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">LdrGetProcedureAddress()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.
<p>
<pre class="fragment"><div>00861                    :
00862 
00863     This function locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00864     specified DLL and returns its address.
00865 
00866 Arguments:
00867 
00868     DllHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00869         looked up in.
00870 
00871     ProcedureName - Supplies that address of a string that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00872         name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to lookup in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00873         not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ProcedureNumber <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used.
00874 
00875     ProcedureNumber - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> number to lookup.  If
00876         ProcedureName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00877         Otherwise, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> ordinal number to locate
00878         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00879 
00880     ProcedureAddress - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> found in
00881         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00882 
00883 Return Value:
00884 
00885     TBD
00886 
00887 --*/
00888 
00889 {
00890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00891     UCHAR FunctionNameBuffer[64];
00892     PUCHAR src, dst;
00893     ULONG cb, ExportSize;
00894     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00895     IMAGE_THUNK_DATA Thunk;
00896     PVOID ImageBase;
00897     PIMAGE_IMPORT_BY_NAME FunctionName;
00898     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
00899     PLIST_ENTRY Next;
00900 <span class="preprocessor">#if defined (WX86)</span>
00901 <span class="preprocessor"></span>    PTEB Teb;
00902     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00903 <span class="preprocessor">#endif</span>
00904 <span class="preprocessor"></span>
00905     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00906         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrGetProcedureAddress by "</span>);
00907     }
00908 
00909 <span class="preprocessor">#if defined (WX86)</span>
00910 <span class="preprocessor"></span>    Teb = NtCurrentTeb();
00911     <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.UseKnownWx86Dll) {
00912         Wx86KnownDll = Teb-&gt;Wx86Thread.UseKnownWx86Dll;
00913         Teb-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00914         }
00915 <span class="preprocessor">#endif</span>
00916 <span class="preprocessor"></span>    
00917     FunctionName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00918     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ProcedureName) ) {
00919 
00920         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00921             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"NAME - %s\n"</span>, ProcedureName-&gt;Buffer);
00922         }
00923 
00924         <span class="comment">//</span>
00925         <span class="comment">// BUGBUG need STRING to PSZ</span>
00926         <span class="comment">//</span>
00927 
00928 
00929         <span class="keywordflow">if</span> (ProcedureName-&gt;Length &gt;= <span class="keyword">sizeof</span>( FunctionNameBuffer )-1 ) {
00930             FunctionName = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TEMP_TAG ),ProcedureName-&gt;Length+1+<span class="keyword">sizeof</span>(USHORT));
00931             <span class="keywordflow">if</span> ( !FunctionName ) {
00932                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00933                 }
00934         } <span class="keywordflow">else</span> {
00935             FunctionName = (PIMAGE_IMPORT_BY_NAME) FunctionNameBuffer;
00936         }
00937 
00938         FunctionName-&gt;Hint = 0;
00939 
00940         cb = ProcedureName-&gt;Length;
00941         src = ProcedureName-&gt;Buffer;
00942         dst = FunctionName-&gt;Name;
00943 
00944         <span class="keywordflow">while</span> (cb--) {
00945             *dst++ = *src++;
00946         }
00947         *dst = <span class="charliteral">'\0'</span>;
00948 
00949         <span class="comment">//</span>
00950         <span class="comment">// Make sure we don't pass in address with high bit set so we</span>
00951         <span class="comment">// can still use it as ordinal flag</span>
00952         <span class="comment">//</span>
00953 
00954         ImageBase = FunctionName;
00955         Thunk.u1.AddressOfData = 0;
00956 
00957     } <span class="keywordflow">else</span> {
00958             ImageBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00959              <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00960                  <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ORDINAL - %lx\n"</span>, ProcedureNumber);
00961              }
00962 
00963              <span class="keywordflow">if</span> (ProcedureNumber) {
00964                  Thunk.u1.Ordinal = ProcedureNumber | IMAGE_ORDINAL_FLAG;
00965              } <span class="keywordflow">else</span> {
00966                       <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00967                     }
00968           }
00969 
00970     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00971         RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00972         }
00973     <span class="keywordflow">try</span> {
00974 
00975         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/ldrsnap_8c.html#a45">LdrpCheckForLoadedDllHandle</a>(DllHandle, &amp;LdrDataTableEntry)) {
00976             st = STATUS_DLL_NOT_FOUND;
00977             <span class="keywordflow">return</span> st;
00978         }
00979 
00980         ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00981                            LdrDataTableEntry-&gt;DllBase,
00982                            TRUE,
00983                            IMAGE_DIRECTORY_ENTRY_EXPORT,
00984                            &amp;ExportSize
00985                            );
00986 
00987         <span class="keywordflow">if</span> (!ExportDirectory) {
00988             <span class="keywordflow">return</span> STATUS_PROCEDURE_NOT_FOUND;
00989         }
00990 
00991         st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry-&gt;DllBase,
00992                            ImageBase,
00993                            &amp;Thunk,
00994                            &amp;Thunk,
00995                            ExportDirectory,
00996                            ExportSize,
00997                            FALSE,
00998                            NULL
00999                           );
01000 
01001         <span class="keywordflow">if</span> ( RunInitRoutines ) {
01002             PLDR_DATA_TABLE_ENTRY LdrInitEntry;
01003 
01004             <span class="comment">//</span>
01005             <span class="comment">// Look at last entry in init order list. If entry processed</span>
01006             <span class="comment">// flag is not set, then a forwarded dll was loaded during the</span>
01007             <span class="comment">// getprocaddr call and we need to run init routines</span>
01008             <span class="comment">//</span>
01009 
01010             Next = NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList.Blink;
01011             LdrInitEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
01012             <span class="keywordflow">if</span> ( !(LdrInitEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) ) {
01013                 <span class="keywordflow">try</span> {
01014                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(NULL);
01015                     }
01016                 except( EXCEPTION_EXECUTE_HANDLER ) {
01017                     st = GetExceptionCode();
01018                     }
01019 
01020                 }
01021             }
01022 
01023         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01024             *ProcedureAddress = (PVOID)Thunk.u1.Function;
01025 <span class="preprocessor">#if defined (WX86)</span>
01026 <span class="preprocessor"></span>            <span class="comment">// For dlls loaded as a Wx86 plugin ...</span>
01027 
01028             <span class="keywordflow">if</span> (Wx86ProcessInit &amp;&amp; (LdrDataTableEntry-&gt;Flags &amp; LDRP_WX86_PLUGIN)) {
01029                 PVOID ExportThunk = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01030                 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MachineType = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase)-&gt;FileHeader.Machine;
01031 
01032                 <span class="comment">// and the GetProcAddress call is cross-architecture ...</span>
01033 
01034                 <span class="keywordflow">if</span> ((!Wx86KnownDll &amp;&amp; (MachineType == IMAGE_FILE_MACHINE_I386))
01035                   || (Wx86KnownDll &amp;&amp; (MachineType != IMAGE_FILE_MACHINE_I386))) {
01036     
01037                     <span class="comment">// Thunk the export</span>
01038 
01039                     st = Wx86ThunkPluginExport(LdrDataTableEntry-&gt;DllBase,
01040                                                FunctionName? FunctionName-&gt;Name : NULL,
01041                                                ProcedureNumber,
01042                                                (PVOID)(Thunk.u1.Function),
01043                                                &amp;ExportThunk
01044                                                );
01045                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; ExportThunk) {
01046                         *ProcedureAddress = ExportThunk;
01047                     } <span class="keywordflow">else</span> {
01048                         <span class="comment">// Don't let unthunked cross-architecture addresses get out</span>
01049                         *ProcedureAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01050                         st = STATUS_INVALID_IMAGE_FORMAT;
01051                         }
01052                     }
01053                 }
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>            }
01056     } finally {
01057         <span class="keywordflow">if</span> ( FunctionName &amp;&amp; (FunctionName != (PIMAGE_IMPORT_BY_NAME) FunctionNameBuffer) ) {
01058             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,FunctionName);
01059             }
01060         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
01061             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
01062             }
01063     }
01064     <span class="keywordflow">return</span> st;
01065 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="ldrp.h::LdrpInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">186</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">LoaderLockInitialized</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d8/d5/delay_8c-source.html#l00033">NtDelayExecution()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00345">NtTestAlert()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00189">RtlpDebugPageHeap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00047">RtlpDisableHeapLookaside</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00242">RtlpDphDllRangeEnd</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00241">RtlpDphDllRangeStart</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00231">RtlpDphGlobalFlags</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00243">RtlpDphRandomProbability</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00240">RtlpDphSizeRangeEnd</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00239">RtlpDphSizeRangeStart</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00244">RtlpDphTargetDlls</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00194                    :
00195 
00196     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called as a User-Mode APC routine as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first
00197     user-mode code executed by a <span class="keyword">new</span> thread. It's function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to initialize
00198     loader context, perform module initialization callouts...
00199 
00200 Arguments:
00201 
00202     Context - Supplies an optional context buffer that will be restore
00203               after all DLL initialization has been completed.  If <span class="keyword">this</span>
00204               parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dynamic snap of <span class="keyword">this</span> module.
00205               Otherwise <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> snap prior to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user process
00206               gaining <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00207 
00208     SystemArgument1 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> System Dll.
00209 
00210     SystemArgument2 - not used.
00211 
00212 Return Value:
00213 
00214     None.
00215 
00216 --*/
00217 
00218 {
00219     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st, InitStatus;
00220     PPEB Peb;
00221     PTEB Teb;
00222     UNICODE_STRING UnicodeImageName;
00223     MEMORY_BASIC_INFORMATION MemInfo;
00224     BOOLEAN AlreadyFailed;
00225     LARGE_INTEGER DelayValue;
00226 <span class="preprocessor">#if defined(_WIN64)</span>
00227 <span class="preprocessor"></span>    PIMAGE_NT_HEADERS NtHeader;
00228 <span class="preprocessor">#endif</span>
00229 <span class="preprocessor"></span>
00230     SystemArgument2;
00231 
00232     AlreadyFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00233     Peb = NtCurrentPeb();
00234     Teb = NtCurrentTeb();
00235 
00236     <span class="keywordflow">if</span> (!Peb-&gt;Ldr) {
00237 <span class="preprocessor">#if defined(_ALPHA_)</span>
00238 <span class="preprocessor"></span>        ULONG temp;
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// Set GP register</span>
00242         <span class="comment">//</span>
00243 
00244         LdrpGpValue = (ULONG_PTR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00245                 Peb-&gt;ImageBaseAddress,
00246                 TRUE,
00247                 IMAGE_DIRECTORY_ENTRY_GLOBALPTR,
00248                 &amp;temp
00249                 );
00250         <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00251             LdrpSetGp( LdrpGpValue );
00252             Context-&gt;IntGp = LdrpGpValue;
00253         }
00254 <span class="preprocessor">#endif // ALPHA</span>
00255 <span class="preprocessor"></span>
00256 <span class="comment">//#if DBG</span>
00257         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
00258 <span class="comment">//#else</span>
00259 <span class="comment">//        if (Peb-&gt;BeingDebugged || Peb-&gt;ReadImageFileExecOptions)</span>
00260 <span class="comment">//#endif</span>
00261         {
00262             PWSTR pw;
00263 
00264             pw = (PWSTR)Peb-&gt;ProcessParameters-&gt;ImagePathName.Buffer;
00265             <span class="keywordflow">if</span> (!(Peb-&gt;ProcessParameters-&gt;Flags &amp; RTL_USER_PROC_PARAMS_NORMALIZED)) {
00266                 pw = (PWSTR)((PCHAR)pw + (ULONG_PTR)(Peb-&gt;ProcessParameters));
00267                 }
00268             UnicodeImageName.Buffer = pw;
00269             UnicodeImageName.Length = Peb-&gt;ProcessParameters-&gt;ImagePathName.Length;
00270             UnicodeImageName.MaximumLength = UnicodeImageName.Length;
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">//  Hack for NT4 SP4.  So we don't overload another GlobalFlag</span>
00274             <span class="comment">//  bit that we have to be "compatible" with for NT5, look for</span>
00275             <span class="comment">//  another value named "DisableHeapLookaside".</span>
00276             <span class="comment">//</span>
00277 
00278             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;UnicodeImageName,
00279                                                L<span class="stringliteral">"DisableHeapLookaside"</span>,
00280                                                REG_DWORD,
00281                                                &amp;RtlpDisableHeapLookaside,
00282                                                <span class="keyword">sizeof</span>( RtlpDisableHeapLookaside ),
00283                                                NULL
00284                                              );
00285 
00286             st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;UnicodeImageName,
00287                                                     L<span class="stringliteral">"GlobalFlag"</span>,
00288                                                     REG_DWORD,
00289                                                     &amp;Peb-&gt;NtGlobalFlag,
00290                                                     <span class="keyword">sizeof</span>( Peb-&gt;NtGlobalFlag ),
00291                                                     NULL
00292                                                   );
00293             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
00294 
00295                 <span class="keywordflow">if</span> (Peb-&gt;BeingDebugged) {
00296                     Peb-&gt;NtGlobalFlag |= FLG_HEAP_ENABLE_FREE_CHECK |
00297                                          FLG_HEAP_ENABLE_TAIL_CHECK |
00298                                          FLG_HEAP_VALIDATE_PARAMETERS;
00299                     }
00300                 }
00301 
00302 <span class="preprocessor">#if defined(_WIN64)</span>
00303 <span class="preprocessor"></span>            NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Peb-&gt;ImageBaseAddress);
00304             <span class="keywordflow">if</span> (NtHeader &amp;&amp; NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
00305                 UseWOW64 = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00306             }
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>        }
00309 
00310         <span class="keywordflow">if</span> ( Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_PAGE_ALLOCS ) {
00311 
00312             <span class="comment">//</span>
00313             <span class="comment">// We will enable page heap (RtlpDebugPageHeap) only after</span>
00314             <span class="comment">// all other initializations for page heap are finished.</span>
00315             <span class="comment">//</span>
00316 
00317             <span class="comment">//</span>
00318             <span class="comment">// If page heap is enabled we need to disable any flag that</span>
00319             <span class="comment">// might force creation of debug heaps for normal NT heaps.</span>
00320             <span class="comment">// This is due to a dependency between page heap and NT heap</span>
00321             <span class="comment">// where the page heap within PageHeapCreate tries to create</span>
00322             <span class="comment">// a normal NT heap to accomodate some of the allocations.</span>
00323             <span class="comment">// If we do not disable these flags we will get an infinite</span>
00324             <span class="comment">// recursion between RtlpDebugPageHeapCreate and RtlCreateHeap.</span>
00325             <span class="comment">//</span>
00326 
00327             Peb-&gt;NtGlobalFlag &amp;= ~( FLG_HEAP_ENABLE_TAGGING      |
00328                 FLG_HEAP_ENABLE_TAG_BY_DLL   |
00329                 FLG_HEAP_ENABLE_TAIL_CHECK   |
00330                 FLG_HEAP_ENABLE_FREE_CHECK   |
00331                 FLG_HEAP_VALIDATE_PARAMETERS |
00332                 FLG_HEAP_VALIDATE_ALL        |
00333                 FLG_USER_STACK_TRACE_DB      );
00334 
00335             <span class="comment">//</span>
00336             <span class="comment">// Read page heap per process global flags. If we fail</span>
00337             <span class="comment">// to read a value, the default ones are kept.</span>
00338             <span class="comment">//</span>
00339 
00340             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00341                 &amp;UnicodeImageName,
00342                 L<span class="stringliteral">"PageHeapFlags"</span>,
00343                 REG_DWORD,
00344                 &amp;RtlpDphGlobalFlags,
00345                 <span class="keyword">sizeof</span>(RtlpDphGlobalFlags),
00346                 NULL
00347                 );
00348 
00349             <span class="comment">//</span>
00350             <span class="comment">// Read several page heap parameters.</span>
00351             <span class="comment">//</span>
00352 
00353             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00354                 &amp;UnicodeImageName,
00355                 L<span class="stringliteral">"PageHeapSizeRangeStart"</span>,
00356                 REG_DWORD,
00357                 &amp;RtlpDphSizeRangeStart,
00358                 <span class="keyword">sizeof</span>(RtlpDphSizeRangeStart),
00359                 NULL
00360                 );
00361 
00362             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00363                 &amp;UnicodeImageName,
00364                 L<span class="stringliteral">"PageHeapSizeRangeEnd"</span>,
00365                 REG_DWORD,
00366                 &amp;RtlpDphSizeRangeEnd,
00367                 <span class="keyword">sizeof</span>(RtlpDphSizeRangeEnd),
00368                 NULL
00369                 );
00370 
00371             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00372                 &amp;UnicodeImageName,
00373                 L<span class="stringliteral">"PageHeapRandomProbability"</span>,
00374                 REG_DWORD,
00375                 &amp;RtlpDphRandomProbability,
00376                 <span class="keyword">sizeof</span>(RtlpDphRandomProbability),
00377                 NULL
00378                 );
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">// The two values below should be read as PVOIDs so that</span>
00382             <span class="comment">// this works on 64-bit architetures. However since this</span>
00383             <span class="comment">// feature relies on good stack traces and since we can get</span>
00384             <span class="comment">// reliable stack traces only on X86 architectures we will</span>
00385             <span class="comment">// leave it as it is.</span>
00386             <span class="comment">//</span>
00387 
00388             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00389                 &amp;UnicodeImageName,
00390                 L<span class="stringliteral">"PageHeapDllRangeStart"</span>,
00391                 REG_DWORD,       
00392                 &amp;RtlpDphDllRangeStart,
00393                 <span class="keyword">sizeof</span>(RtlpDphDllRangeStart),
00394                 NULL
00395                 );
00396 
00397             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00398                 &amp;UnicodeImageName,
00399                 L<span class="stringliteral">"PageHeapDllRangeEnd"</span>,
00400                 REG_DWORD,       
00401                 &amp;RtlpDphDllRangeEnd,
00402                 <span class="keyword">sizeof</span>(RtlpDphDllRangeEnd),
00403                 NULL
00404                 );
00405 
00406             <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>(
00407                 &amp;UnicodeImageName,
00408                 L<span class="stringliteral">"PageHeapTargetDlls"</span>,
00409                 REG_SZ,
00410                 &amp;RtlpDphTargetDlls,
00411                 512,
00412                 NULL
00413                 );
00414 
00415             <span class="comment">//</span>
00416             <span class="comment">//  Turn on BOOLEAN RtlpDebugPageHeap to indicate that</span>
00417             <span class="comment">//  new heaps should be created with debug page heap manager</span>
00418             <span class="comment">//  when possible.</span>
00419             <span class="comment">//</span>
00420 
00421             <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00422         }
00423     }
00424 <span class="preprocessor">#if defined(_ALPHA_)</span>
00425 <span class="preprocessor"></span>    <span class="keywordflow">else</span>
00426     <span class="keywordflow">if</span> (Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00427         LdrpSetGp( LdrpGpValue );
00428         Context-&gt;IntGp = LdrpGpValue;
00429     }
00430 <span class="preprocessor">#endif // ALPHA</span>
00431 <span class="preprocessor"></span>
00432     <span class="comment">//</span>
00433     <span class="comment">// Serialize for here on out</span>
00434     <span class="comment">//</span>
00435 
00436     Peb-&gt;LoaderLock = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>;
00437 
00438     <span class="keywordflow">if</span> ( !RtlTryEnterCriticalSection(&amp;LoaderLock) ) {
00439         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> ) {
00440             RtlEnterCriticalSection(&amp;LoaderLock);
00441             }
00442         <span class="keywordflow">else</span> {
00443 
00444             <span class="comment">//</span>
00445             <span class="comment">// drop into a 30ms delay loop</span>
00446             <span class="comment">//</span>
00447 
00448             DelayValue.QuadPart = Int32x32To64( 30, -10000 );
00449             <span class="keywordflow">while</span> ( !<a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> ) {
00450                 <a class="code" href="../../d7/d6/delay_8c.html#a0">NtDelayExecution</a>(FALSE,&amp;DelayValue);
00451                 }
00452             RtlEnterCriticalSection(&amp;LoaderLock);
00453             }
00454         }
00455 
00456     <span class="keywordflow">if</span> (Teb-&gt;DeallocationStack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457         st = <a class="code" href="../../d5/d3/queryvm_8c.html#a4">NtQueryVirtualMemory</a>(
00458                 NtCurrentProcess(),
00459                 Teb-&gt;NtTib.StackLimit,
00460                 MemoryBasicInformation,
00461                 (PVOID)&amp;MemInfo,
00462                 <span class="keyword">sizeof</span>(MemInfo),
00463                 NULL
00464                 );
00465         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00466             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(st);
00467             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(st);
00468             <span class="keywordflow">return</span>;
00469             }
00470         <span class="keywordflow">else</span> {
00471             Teb-&gt;DeallocationStack = MemInfo.AllocationBase;
00472 <span class="preprocessor">#if defined(_IA64_)</span>
00473 <span class="preprocessor"></span>            Teb-&gt;DeallocationBStore = (PVOID)((ULONG_PTR)MemInfo.AllocationBase + MemInfo.RegionSize);
00474 <span class="preprocessor">#endif // defined(_IA64_)</span>
00475 <span class="preprocessor"></span>        }
00476     }
00477 
00478     InitStatus = STATUS_SUCCESS;
00479     <span class="keywordflow">try</span> {
00480         <span class="keywordflow">if</span> (!Peb-&gt;Ldr) {
00481             <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00482 <span class="preprocessor">#if DBG</span>
00483 <span class="preprocessor"></span>            <span class="comment">//</span>
00484             <span class="comment">// Time the load.</span>
00485             <span class="comment">//</span>
00486 
00487             <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
00488                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;BeginTime, NULL);
00489             }
00490 <span class="preprocessor">#endif // DBG</span>
00491 <span class="preprocessor"></span>
00492             <span class="keywordflow">try</span> {
00493                 InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a65">LdrpInitializeProcess</a>( Context,
00494                                                     SystemArgument1,
00495                                                     &amp;UnicodeImageName
00496                                                   );
00497                 }
00498             except ( EXCEPTION_EXECUTE_HANDLER ) {
00499                 InitStatus = GetExceptionCode();
00500                 AlreadyFailed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501                 <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(GetExceptionCode());
00502                 }
00503 
00504 <span class="preprocessor">#if DBG</span>
00505 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
00506                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;EndTime, NULL);
00507                 <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;ElapsedTime, &amp;Interval);
00508                 ElapsedTime.QuadPart = EndTime.QuadPart - BeginTime.QuadPart;
00509                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nLoadTime %ld In units of %ld cycles/second \n"</span>,
00510                     ElapsedTime.LowPart,
00511                     Interval.LowPart
00512                     );
00513 
00514                 ElapsedTime.QuadPart = EndTime.QuadPart - InitbTime.QuadPart;
00515                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"InitTime %ld\n"</span>,
00516                     ElapsedTime.LowPart
00517                     );
00518                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Compares %d Bypasses %d Normal Snaps %d\nSecOpens %d SecCreates %d Maps %d Relocates %d\n"</span>,
00519                     LdrpCompareCount,
00520                     LdrpSnapBypass,
00521                     LdrpNormalSnap,
00522                     LdrpSectionOpens,
00523                     LdrpSectionCreates,
00524                     LdrpSectionMaps,
00525                     LdrpSectionRelocates
00526                     );
00527             }
00528 <span class="preprocessor">#endif // DBG</span>
00529 <span class="preprocessor"></span>
00530 
00531         } <span class="keywordflow">else</span> {
00532             <span class="keywordflow">if</span> ( Peb-&gt;InheritedAddressSpace ) {
00533                 InitStatus = <a class="code" href="../../d8/d2/ldrinit_8c.html#a15">LdrpForkProcess</a>();
00534                 }
00535             <span class="keywordflow">else</span> {
00536 
00537 <span class="preprocessor">#if defined (WX86)</span>
00538 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Teb-&gt;Vdm) {
00539                     InitStatus = LdrpInitWx86(Teb-&gt;Vdm, Context, TRUE);
00540                     }
00541 <span class="preprocessor">#endif</span>
00542 <span class="preprocessor"></span>
00543 <span class="preprocessor">#if defined(_WIN64)</span>
00544 <span class="preprocessor"></span>                <span class="comment">//</span>
00545                 <span class="comment">// Load in WOW64 if the image is supposed to run simulated</span>
00546                 <span class="comment">//</span>
00547                 <span class="keywordflow">if</span> (UseWOW64) {
00548                     RtlLeaveCriticalSection(&amp;LoaderLock);
00549                     (*Wow64LdrpInitialize)(Context);
00550                     <span class="comment">// This never returns.  It will destroy the process.</span>
00551                 }
00552 <span class="preprocessor">#endif</span>
00553 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/ldrinit_8c.html#a16">LdrpInitializeThread</a>(Context);
00554                 }
00555         }
00556     } finally {
00557         <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00558         RtlLeaveCriticalSection(&amp;LoaderLock);
00559         }
00560 
00561     <a class="code" href="../../d1/d2/psspnd_8c.html#a4">NtTestAlert</a>();
00562 
00563     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InitStatus)) {
00564 
00565         <span class="keywordflow">if</span> ( AlreadyFailed == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00566             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>(InitStatus);
00567             }
00568         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(InitStatus);
00569     }
00570 
00571 
00572 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="ldrp.h::LdrpInitializePathCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInitializePathCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="ldrp.h::LdrpInitializeProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpInitializeProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemDllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeImageName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">616</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00466">ATOM_TAG</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00314">CommandLine</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00388">FastPebLock</a>, <a class="el" href="../../d2/d0/theap_8c-source.html#l00055">HeapParameters</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00036">InitTableInfo</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">LDR_TAG</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00838">LdrGetProcedureAddress()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00035">LdrLoadDll()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00159">LDRP_HASH_TABLE_SIZE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">LdrpAllocateDataTableEntry()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">LdrpDefaultPath</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03249">LdrpFetchAddressOfEntryPoint()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00162">LdrpHashTable</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00390">LdrpImageEntry</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">LdrpInsertMemoryTableEntry()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00034">LdrpKnownDllObjectDirectory</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00037">LdrpKnownDllPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00036">LdrpKnownDllPathBuffer</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00034">LdrpLdrDatabaseIsSetup</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00391">LdrpNumberOfProcessors</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00253">LdrpReferenceLoadedDll</a>, <a class="el" href="../../d6/d1/alpha_2ldrctx_8c-source.html#l00028">LdrpRelocateStartContext()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">LdrpSetProtection()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00033">LdrpVerifyDlls</a>, <a class="el" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00146">LoaderLockInitialized</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00153">NATIVE_PAGE_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00045">NtDllBase</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00455">NtdllBaseTag</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00121">NtdllpAllocateStringRoutine()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00129">NtdllpFreeStringRoutine()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/init_8h-source.html#l00028">NtSystemRoot</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00136">RtlAllocateStringRoutine</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01883">RtlAppendUnicodeStringToString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">RtlCriticalSectionList</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00137">RtlFreeStringRoutine</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d1/d9/rtl_2atom_8c-source.html#l00253">RtlInitializeAtomPackage()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01210">RtlInitializeCriticalSection()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l02438">RtlInitNlsTables()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l00395">RtlNormalizeProcessParams()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00189">RtlpDebugPageHeap</a>, <a class="el" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">RtlpTimeout</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00368">RtlpTimoutDisable</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l02454">RtlResetRtlTranslations()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00225">RtlSetCurrentDirectory_U()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00138">TlsBitMap</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00139">TlsExpansionBitMap</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00844">Unicode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>.
<p>
<pre class="fragment"><div>00624                    :
00625 
00626     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process.
00627     This includes:
00628 
00629         - Initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table
00630 
00631         - Connecting to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader subsystem
00632 
00633         - Initializing all staticly linked DLLs
00634 
00635 Arguments:
00636 
00637     Context - Supplies an optional context buffer that will be restore
00638               after all DLL initialization has been completed.  If <span class="keyword">this</span>
00639               parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a dynamic snap of <span class="keyword">this</span> module.
00640               Otherwise <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> snap prior to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user process
00641               gaining <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00642 
00643     SystemDllBase - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system dll.
00644 
00645 Return Value:
00646 
00647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00648 
00649 --*/
00650 
00651 {
00652     PPEB Peb;
00653     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00654     PWCH p, pp;
00655     UNICODE_STRING CurDir;
00656     UNICODE_STRING FullImageName;
00657     UNICODE_STRING <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a>;
00658     ULONG DebugProcessHeapOnly = 0 ;
00659     HANDLE LinkHandle;
00660     WCHAR SystemDllPathBuffer[DOS_MAX_PATH_LENGTH];
00661     UNICODE_STRING SystemDllPath;
00662     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00663     PRTL_USER_PROCESS_PARAMETERS ProcessParameters;
00664     UNICODE_STRING <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>;
00665     OBJECT_ATTRIBUTES Obja;
00666     BOOLEAN StaticCurDir = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00667     ULONG i;
00668     PIMAGE_NT_HEADERS NtHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( NtCurrentPeb()-&gt;ImageBaseAddress );
00669     PIMAGE_LOAD_CONFIG_DIRECTORY ImageConfigData;
00670     ULONG ProcessHeapFlags;
00671     RTL_HEAP_PARAMETERS <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>;
00672     NLSTABLEINFO <a class="code" href="../../d8/d1/init_8h.html#a10">InitTableInfo</a>;
00673     LARGE_INTEGER LongTimeout;
00674     UNICODE_STRING <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>;
00675     LONG_PTR Diff;
00676     ULONG_PTR OldBase;
00677 
00678     <a class="code" href="../../d8/d2/ldrinit_8c.html#a5">NtDllBase</a> = SystemDllBase;
00679 
00680     <span class="keywordflow">if</span> (
00681 <span class="preprocessor">#if defined(_WIN64)</span>
00682 <span class="preprocessor"></span>        NtHeader-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC &amp;&amp;
00683 <span class="preprocessor">#endif</span>
00684 <span class="preprocessor"></span>        NtHeader-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_NATIVE ) {
00685 
00686         <span class="comment">//</span>
00687         <span class="comment">// Native subsystems load slower, but validate their DLLs</span>
00688         <span class="comment">// This is to help CSR detect bad images faster</span>
00689         <span class="comment">//</span>
00690 
00691         <a class="code" href="../../d8/d2/ldrinit_8c.html#a2">LdrpVerifyDlls</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00692 
00693         }
00694 
00695 
00696     Peb = NtCurrentPeb();
00697 
00698 <span class="preprocessor">#if defined(BUILD_WOW6432)</span>
00699 <span class="preprocessor"></span>    {
00700         <span class="comment">//</span>
00701         <span class="comment">// The process is running in WOW64.  Sort out the optional header</span>
00702         <span class="comment">// format and reformat the image if its page size is smaller than</span>
00703         <span class="comment">// the native page size.</span>
00704         <span class="comment">//</span>
00705         PIMAGE_NT_HEADERS32 NtHeader32 = (PIMAGE_NT_HEADERS32)NtHeader;
00706 
00707         <span class="keywordflow">if</span> (NtHeader32-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386 &amp;&amp;
00708             NtHeader32-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d9/d2/ldrp_8h.html#a2">NATIVE_PAGE_SIZE</a> &amp;&amp;
00709             !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st = LdrpWx86FormatVirtualImage(NtHeader32,
00710                                  NtCurrentPeb()-&gt;ImageBaseAddress
00711                                  <span class="comment">//bugbug: should be:  (PVOID)NtHeader32-&gt;OptionalHeader.ImageBase</span>
00712                                  ))) {
00713             <span class="keywordflow">return</span> st;
00714         }
00715     }
00716 <span class="preprocessor">#elif defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00717 <span class="preprocessor"></span>     <span class="comment">//</span>
00718      <span class="comment">// Deal with the native page size which is larger than x86</span>
00719      <span class="comment">// This needs to be done before any code reads beyond the file headers.</span>
00720      <span class="comment">//</span>
00721     <span class="keywordflow">if</span> (NtHeader-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386 &amp;&amp;
00722         NtHeader-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &amp;&amp;
00723         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st = LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeader,
00724                              (PVOID)NtHeader-&gt;OptionalHeader.ImageBase
00725                              )))
00726       {
00727         <span class="keywordflow">return</span> st;
00728         }
00729 <span class="preprocessor">#endif</span>
00730 <span class="preprocessor"></span>
00731 
00732     <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> = Peb-&gt;NumberOfProcessors;
00733     <a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a> = Peb-&gt;CriticalSectionTimeout;
00734     LongTimeout.QuadPart = Int32x32To64( 3600, -10000000 );
00735 
00736     <span class="keywordflow">if</span> (ProcessParameters = <a class="code" href="../../d0/d2/rtlexec_8c.html#a10">RtlNormalizeProcessParams</a>(Peb-&gt;ProcessParameters)) {
00737         FullImageName = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;ImagePathName;
00738         <a class="code" href="../../d2/d5/editreg_8c.html#a48">CommandLine</a> = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;CommandLine;
00739         }
00740     <span class="keywordflow">else</span> {
00741         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;FullImageName, NULL );
00742         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CommandLine, NULL );
00743         }
00744 
00745 
00746     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a46">RtlInitNlsTables</a>(
00747         Peb-&gt;AnsiCodePageData,
00748         Peb-&gt;OemCodePageData,
00749         Peb-&gt;UnicodeCaseTableData,
00750         &amp;InitTableInfo
00751         );
00752 
00753     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a47">RtlResetRtlTranslations</a>(&amp;InitTableInfo);
00754 
00755 <span class="preprocessor">#if defined(_WIN64)</span>
00756 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (UseWOW64) {
00757         <span class="comment">//</span>
00758         <span class="comment">// Ignore image config data when initializing the 64-bit loader.</span>
00759         <span class="comment">// The 32-bit loader in ntdll32 will look at the config data</span>
00760         <span class="comment">// and do the right thing.</span>
00761         <span class="comment">//</span>
00762         ImageConfigData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00763     } <span class="keywordflow">else</span>
00764 <span class="preprocessor">#endif</span>
00765 <span class="preprocessor"></span>    {
00766 
00767         ImageConfigData = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( Peb-&gt;ImageBaseAddress,
00768                                                         TRUE,
00769                                                         IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG,
00770                                                         &amp;i
00771                                                       );
00772     }
00773 
00774     RtlZeroMemory( &amp;HeapParameters, <span class="keyword">sizeof</span>( HeapParameters ) );
00775     ProcessHeapFlags = HEAP_GROWABLE | HEAP_CLASS_0;
00776     <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.Length = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a> );
00777     <span class="keywordflow">if</span> (ImageConfigData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; i == <span class="keyword">sizeof</span>( *ImageConfigData )) {
00778         Peb-&gt;NtGlobalFlag &amp;= ~ImageConfigData-&gt;GlobalFlagsClear;
00779         Peb-&gt;NtGlobalFlag |= ImageConfigData-&gt;GlobalFlagsSet;
00780 
00781         <span class="keywordflow">if</span> (ImageConfigData-&gt;CriticalSectionDefaultTimeout != 0) {
00782             <span class="comment">//</span>
00783             <span class="comment">// Convert from milliseconds to NT time scale (100ns)</span>
00784             <span class="comment">//</span>
00785             <a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>.QuadPart = Int32x32To64( (LONG)ImageConfigData-&gt;CriticalSectionDefaultTimeout,
00786                                                  -10000
00787                                                );
00788 
00789             }
00790 
00791         <span class="keywordflow">if</span> (ImageConfigData-&gt;ProcessHeapFlags != 0) {
00792             ProcessHeapFlags = ImageConfigData-&gt;ProcessHeapFlags;
00793             }
00794 
00795         <span class="keywordflow">if</span> (ImageConfigData-&gt;DeCommitFreeBlockThreshold != 0) {
00796             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.DeCommitFreeBlockThreshold = ImageConfigData-&gt;DeCommitFreeBlockThreshold;
00797             }
00798 
00799         <span class="keywordflow">if</span> (ImageConfigData-&gt;DeCommitTotalFreeThreshold != 0) {
00800             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.DeCommitTotalFreeThreshold = ImageConfigData-&gt;DeCommitTotalFreeThreshold;
00801             }
00802 
00803         <span class="keywordflow">if</span> (ImageConfigData-&gt;MaximumAllocationSize != 0) {
00804             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.MaximumAllocationSize = ImageConfigData-&gt;MaximumAllocationSize;
00805             }
00806 
00807         <span class="keywordflow">if</span> (ImageConfigData-&gt;VirtualMemoryThreshold != 0) {
00808             <a class="code" href="../../d1/d1/theap_8c.html#a9">HeapParameters</a>.VirtualMemoryThreshold = ImageConfigData-&gt;VirtualMemoryThreshold;
00809             }
00810         }
00811 
00812 <span class="comment">//    //</span>
00813 <span class="comment">//    // Check if the image has the fast heap flag set</span>
00814 <span class="comment">//    //</span>
00815 <span class="comment">//</span>
00816 <span class="comment">//    if (NtHeader-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_FAST_HEAP) {</span>
00817 <span class="comment">//        RtlpDisableHeapLookaside = 0;</span>
00818 <span class="comment">//    } else {</span>
00819 <span class="comment">//        RtlpDisableHeapLookaside = 1;</span>
00820 <span class="comment">//    }</span>
00821 
00822     <a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a> = (BOOLEAN)(FLG_SHOW_LDR_SNAPS &amp; Peb-&gt;NtGlobalFlag);
00823 
00824 
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// This field is non-zero if the image file that was used to create this</span>
00828     <span class="comment">// process contained a non-zero value in its image header.  If so, then</span>
00829     <span class="comment">// set the affinity mask for the process using this value.  It could also</span>
00830     <span class="comment">// be non-zero if the parent process created us suspended and poked our</span>
00831     <span class="comment">// PEB with a non-zero value before resuming.</span>
00832     <span class="comment">//</span>
00833     <span class="keywordflow">if</span> (Peb-&gt;ImageProcessAffinityMask) {
00834         st = <a class="code" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a>( NtCurrentProcess(),
00835                                       ProcessAffinityMask,
00836                                       &amp;Peb-&gt;ImageProcessAffinityMask,
00837                                       <span class="keyword">sizeof</span>( Peb-&gt;ImageProcessAffinityMask )
00838                                     );
00839         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
00840             KdPrint(( <span class="stringliteral">"LDR: Using ProcessAffinityMask of 0x%x from image.\n"</span>,
00841                       Peb-&gt;ImageProcessAffinityMask
00842                    ));
00843             }
00844         <span class="keywordflow">else</span> {
00845             KdPrint(( <span class="stringliteral">"LDR: Failed to set ProcessAffinityMask of 0x%x from image (Status == %08x).\n"</span>,
00846                       Peb-&gt;ImageProcessAffinityMask, st
00847                    ));
00848             }
00849         }
00850 
00851     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>.QuadPart &lt; LongTimeout.QuadPart) {
00852         <a class="code" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00853         }
00854 
00855     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00856         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: PID: 0x%x started - '%wZ'\n"</span>,
00857                   NtCurrentTeb()-&gt;ClientId.UniqueProcess,
00858                   &amp;CommandLine
00859                 );
00860     }
00861 
00862     <span class="keywordflow">for</span>(i=0;i&lt;<a class="code" href="../../d9/d2/ldrp_8h.html#a5">LDRP_HASH_TABLE_SIZE</a>;i++) {
00863         InitializeListHead(&amp;LdrpHashTable[i]);
00864     }
00865 
00866     <span class="comment">//</span>
00867     <span class="comment">// Initialize the critical section package.</span>
00868     <span class="comment">//</span>
00869 
00870     <a class="code" href="../../d7/d8/dll_2resource_8c.html#a11">RtlpInitDeferedCriticalSection</a>();
00871 
00872     Peb-&gt;TlsBitmap = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a9">TlsBitMap</a>;
00873     Peb-&gt;TlsExpansionBitmap = (PVOID)&amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a10">TlsExpansionBitMap</a>;
00874 
00875     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a> (
00876         &amp;TlsBitMap,
00877         &amp;Peb-&gt;TlsBitmapBits[0],
00878         TLS_MINIMUM_AVAILABLE
00879         );
00880 
00881     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a> (
00882         &amp;TlsExpansionBitMap,
00883         &amp;Peb-&gt;TlsExpansionBitmapBits[0],
00884         TLS_EXPANSION_SLOTS
00885         );
00886 
00887     InsertTailList(&amp;RtlCriticalSectionList, &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;ProcessLocksList);
00888     <a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>.DebugInfo-&gt;CriticalSection = &amp;<a class="code" href="../../d8/d2/ldrinit_8c.html#a12">LoaderLock</a>;
00889     <a class="code" href="../../d8/d2/ldrinit_8c.html#a13">LoaderLockInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// Initialize the stack trace data base if requested</span>
00893     <span class="comment">//</span>
00894 
00895 <span class="preprocessor">#if i386</span>
00896 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_USER_STACK_TRACE_DB) {
00897         PVOID BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00898         ULONG ReserveSize = 2 * 1024 * 1024;
00899 
00900         st = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00901                                       (PVOID *)&amp;BaseAddress,
00902                                       0,
00903                                       &amp;ReserveSize,
00904                                       MEM_RESERVE,
00905                                       PAGE_READWRITE
00906                                     );
00907         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00908             st = RtlInitializeStackTraceDataBase( BaseAddress,
00909                                                   0,
00910                                                   ReserveSize
00911                                                 );
00912             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st ) ) {
00913                 <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
00914                                      (PVOID *)&amp;BaseAddress,
00915                                      &amp;ReserveSize,
00916                                      MEM_RELEASE
00917                                    );
00918                 }
00919             <span class="keywordflow">else</span> {
00920                 Peb-&gt;NtGlobalFlag |= FLG_HEAP_VALIDATE_PARAMETERS;
00921                 }
00922             }
00923         }
00924 <span class="preprocessor">#endif // i386</span>
00925 <span class="preprocessor"></span>
00926     <span class="comment">//</span>
00927     <span class="comment">// Initialize the loader data based in the PEB.</span>
00928     <span class="comment">//</span>
00929 
00930     st = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;FastPebLock);
00931     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00932         <span class="keywordflow">return</span> st;
00933         }
00934     Peb-&gt;FastPebLock = &amp;<a class="code" href="../../d9/d2/ldrp_8h.html#a46">FastPebLock</a>;
00935     Peb-&gt;FastPebLockRoutine = (PVOID)&amp;RtlEnterCriticalSection;
00936     Peb-&gt;FastPebUnlockRoutine = (PVOID)&amp;RtlLeaveCriticalSection;
00937 
00938     <a class="code" href="../../d5/d9/heapdll_8c.html#a20">RtlInitializeHeapManager</a>();
00939 <span class="preprocessor">#if defined(_WIN64)</span>
00940 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (UseWOW64) {
00941         <span class="comment">//</span>
00942         <span class="comment">// Create a heap using all defaults.  The 32-bit process heap</span>
00943         <span class="comment">// will be created later by ntdll32 using the parameters from the exe.</span>
00944         <span class="comment">//</span>
00945         Peb-&gt;ProcessHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( ProcessHeapFlags,
00946                                           NULL,
00947                                           0,
00948                                           0,
00949                                           NULL,
00950                                           &amp;HeapParameters
00951                                         );
00952     } <span class="keywordflow">else</span>
00953 <span class="preprocessor">#endif</span>
00954 <span class="preprocessor"></span>    {
00955 
00956         <span class="keywordflow">if</span> (NtHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 &amp;&amp;
00957             NtHeader-&gt;OptionalHeader.MinorSubsystemVersion &lt; 51
00958            ) {
00959             ProcessHeapFlags |= HEAP_CREATE_ALIGN_16;
00960             }
00961 
00962         Peb-&gt;ProcessHeap = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a15">RtlCreateHeap</a>( ProcessHeapFlags,
00963                                           NULL,
00964                                           NtHeader-&gt;OptionalHeader.SizeOfHeapReserve,
00965                                           NtHeader-&gt;OptionalHeader.SizeOfHeapCommit,
00966                                           NULL,             <span class="comment">// Lock to use for serialization</span>
00967                                           &amp;HeapParameters
00968                                         );
00969     }
00970     <span class="keywordflow">if</span> (Peb-&gt;ProcessHeap == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00971         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00972     }
00973 
00974     <a class="code" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a> = <a class="code" href="../../d5/d9/heapdll_8c.html#a28">RtlCreateTagHeap</a>( Peb-&gt;ProcessHeap,
00975                                      0,
00976                                      L<span class="stringliteral">"NTDLL!"</span>,
00977                                      L<span class="stringliteral">"!Process\0"</span>                  <span class="comment">// Heap Name</span>
00978                                      L<span class="stringliteral">"CSRSS Client\0"</span>
00979                                      L<span class="stringliteral">"LDR Database\0"</span>
00980                                      L<span class="stringliteral">"Current Directory\0"</span>
00981                                      L<span class="stringliteral">"TLS Storage\0"</span>
00982                                      L<span class="stringliteral">"DBGSS Client\0"</span>
00983                                      L<span class="stringliteral">"SE Temporary\0"</span>
00984                                      L<span class="stringliteral">"Temporary\0"</span>
00985                                      L<span class="stringliteral">"LocalAtom\0"</span>
00986                                    );
00987 
00988     <a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a23">NtdllpAllocateStringRoutine</a>;
00989     <a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a24">NtdllpFreeStringRoutine</a>;
00990 
00991     <a class="code" href="../../d0/d0/rtl_2atom_8c.html#a12">RtlInitializeAtomPackage</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( ATOM_TAG ) );
00992 
00993     <span class="comment">//</span>
00994     <span class="comment">// Allow only the process heap to have page allocations turned on</span>
00995     <span class="comment">//</span>
00996 
00997     st = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( UnicodeImageName,
00998                                             L<span class="stringliteral">"DebugProcessHeapOnly"</span>,
00999                                             REG_DWORD,
01000                                             &amp;DebugProcessHeapOnly,
01001                                             <span class="keyword">sizeof</span>( DebugProcessHeapOnly ),
01002                                             NULL
01003                                           );
01004     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
01005 
01006         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> &amp;&amp;
01007              ( DebugProcessHeapOnly != 0 ) ) {
01008 
01009             <a class="code" href="../../d6/d9/heappage_8c.html#a36">RtlpDebugPageHeap</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ;
01010 
01011             }
01012 
01013         }
01014 
01015     SystemDllPath.Buffer = SystemDllPathBuffer;
01016     SystemDllPath.Length = 0;
01017     SystemDllPath.MaximumLength = <span class="keyword">sizeof</span>( SystemDllPathBuffer );
01018     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;NtSystemRoot, USER_SHARED_DATA-&gt;NtSystemRoot );
01019     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;SystemDllPath, &amp;NtSystemRoot );
01020     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;SystemDllPath, L<span class="stringliteral">"\\System32\\"</span> );
01021 
01022     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,L<span class="stringliteral">"\\KnownDlls"</span>);
01023     InitializeObjectAttributes( &amp;Obja,
01024                                   &amp;Unicode,
01025                                   OBJ_CASE_INSENSITIVE,
01026                                   NULL,
01027                                   NULL
01028                                 );
01029     st = <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a>(
01030             &amp;LdrpKnownDllObjectDirectory,
01031             DIRECTORY_QUERY | DIRECTORY_TRAVERSE,
01032             &amp;Obja
01033             );
01034     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01035         <a class="code" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01036         <span class="comment">// KnownDlls directory doesn't exist - assume it's system32.</span>
01037         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;LdrpKnownDllPath, SystemDllPath.Buffer);
01038         <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length -= <span class="keyword">sizeof</span>(WCHAR);    <span class="comment">// remove trailing '\'</span>
01039         }
01040     <span class="keywordflow">else</span> {
01041 
01042         <span class="comment">//</span>
01043         <span class="comment">// Open up the known dll pathname link</span>
01044         <span class="comment">// and query its value</span>
01045         <span class="comment">//</span>
01046 
01047         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Unicode,L<span class="stringliteral">"KnownDllPath"</span>);
01048         InitializeObjectAttributes( &amp;Obja,
01049                                       &amp;Unicode,
01050                                       OBJ_CASE_INSENSITIVE,
01051                                       LdrpKnownDllObjectDirectory,
01052                                       NULL
01053                                     );
01054         st = <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a>( &amp;LinkHandle,
01055                                        SYMBOLIC_LINK_QUERY,
01056                                        &amp;Obja
01057                                      );
01058         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( st )) {
01059             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Length = 0;
01060             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a>);
01061             <a class="code" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>.Buffer = <a class="code" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a>;
01062             st = <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a>( LinkHandle,
01063                                             &amp;LdrpKnownDllPath,
01064                                             NULL
01065                                           );
01066             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(LinkHandle);
01067             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01068                 <span class="keywordflow">return</span> st;
01069                 }
01070             }
01071         <span class="keywordflow">else</span> {
01072             <span class="keywordflow">return</span> st;
01073             }
01074         }
01075 
01076     <span class="keywordflow">if</span> (ProcessParameters) {
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// If the process was created with process parameters,</span>
01080         <span class="comment">// than extract:</span>
01081         <span class="comment">//</span>
01082         <span class="comment">//      - Library Search Path</span>
01083         <span class="comment">//</span>
01084         <span class="comment">//      - Starting Current Directory</span>
01085         <span class="comment">//</span>
01086 
01087         <span class="keywordflow">if</span> (ProcessParameters-&gt;DllPath.Length) {
01088             <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a> = *(PUNICODE_STRING)&amp;ProcessParameters-&gt;DllPath;
01089             }
01090         <span class="keywordflow">else</span> {
01091             <a class="code" href="../../d8/d2/ldrinit_8c.html#a25">LdrpInitializationFailure</a>( STATUS_INVALID_PARAMETER );
01092             }
01093 
01094         StaticCurDir = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01095         CurDir = ProcessParameters-&gt;CurrentDirectory.DosPath;
01096         <span class="keywordflow">if</span> (CurDir.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CurDir.Buffer[ 0 ] == UNICODE_NULL || CurDir.Length == 0) {
01097             CurDir.Buffer = (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( (3+1) * <span class="keyword">sizeof</span>( WCHAR ) );
01098             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CurDir.Buffer != NULL);
01099             RtlMoveMemory( CurDir.Buffer,
01100                            USER_SHARED_DATA-&gt;NtSystemRoot,
01101                            3 * <span class="keyword">sizeof</span>( WCHAR )
01102                          );
01103             CurDir.Buffer[ 3 ] = UNICODE_NULL;
01104             }
01105         }
01106 
01107     <span class="comment">//</span>
01108     <span class="comment">// Make sure the module data base is initialized before we take any</span>
01109     <span class="comment">// exceptions.</span>
01110     <span class="comment">//</span>
01111 
01112     Peb-&gt;Ldr = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ), <span class="keyword">sizeof</span>(PEB_LDR_DATA));
01113     <span class="keywordflow">if</span> ( !Peb-&gt;Ldr ) {
01114         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_NO_MEMORY);
01115         }
01116 
01117     Peb-&gt;Ldr-&gt;Length = <span class="keyword">sizeof</span>(PEB_LDR_DATA);
01118     Peb-&gt;Ldr-&gt;Initialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01119     Peb-&gt;Ldr-&gt;SsHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01120     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InLoadOrderModuleList);
01121     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InMemoryOrderModuleList);
01122     InitializeListHead(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList);
01123 
01124     <span class="comment">//</span>
01125     <span class="comment">// Allocate the first data table entry for the image. Since we</span>
01126     <span class="comment">// have already mapped this one, we need to do the allocation by hand.</span>
01127     <span class="comment">// Its characteristics identify it as not a Dll, but it is linked</span>
01128     <span class="comment">// into the table so that pc correlation searching doesn't have to</span>
01129     <span class="comment">// be special cased.</span>
01130     <span class="comment">//</span>
01131 
01132     LdrDataTableEntry = <a class="code" href="../../d9/d2/ldrp_8h.html#a40">LdrpImageEntry</a> = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(Peb-&gt;ImageBaseAddress);
01133     LdrDataTableEntry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
01134     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(LdrDataTableEntry-&gt;DllBase);
01135     LdrDataTableEntry-&gt;FullDllName = FullImageName;
01136     LdrDataTableEntry-&gt;Flags = 0;
01137 
01138     <span class="comment">// p = strrchr(FullImageName, '\\');</span>
01139     pp = UNICODE_NULL;
01140     p = FullImageName.Buffer;
01141     <span class="keywordflow">while</span> (*p) {
01142         <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'\\'</span>) {
01143             pp = p;
01144         }
01145     }
01146 
01147     LdrDataTableEntry-&gt;FullDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)FullImageName.Buffer);
01148     LdrDataTableEntry-&gt;FullDllName.MaximumLength = LdrDataTableEntry-&gt;FullDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
01149 
01150     <span class="keywordflow">if</span> (pp) {
01151        LdrDataTableEntry-&gt;BaseDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)pp);
01152        LdrDataTableEntry-&gt;BaseDllName.MaximumLength = LdrDataTableEntry-&gt;BaseDllName.Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
01153        LdrDataTableEntry-&gt;BaseDllName.Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(Peb-&gt;ProcessHeap, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ),
01154                                                                LdrDataTableEntry-&gt;BaseDllName.MaximumLength
01155                                                               );
01156        RtlMoveMemory(LdrDataTableEntry-&gt;BaseDllName.Buffer,
01157                      pp,
01158                      LdrDataTableEntry-&gt;BaseDllName.MaximumLength
01159                     );
01160     }  <span class="keywordflow">else</span> {
01161               LdrDataTableEntry-&gt;BaseDllName = LdrDataTableEntry-&gt;FullDllName;
01162             }
01163     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(LdrDataTableEntry);
01164     LdrDataTableEntry-&gt;Flags |= LDRP_ENTRY_PROCESSED;
01165 
01166     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01167         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: NEW PROCESS\n"</span> );
01168         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Image Path: %wZ (%wZ)\n"</span>,
01169                   &amp;LdrDataTableEntry-&gt;FullDllName,
01170                   &amp;LdrDataTableEntry-&gt;BaseDllName
01171                 );
01172         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Current Directory: %wZ\n"</span>, &amp;CurDir );
01173         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"     Search Path: %wZ\n"</span>, &amp;LdrpDefaultPath );
01174     }
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">// The process references the system DLL, so map this one next. Since</span>
01178     <span class="comment">// we have already mapped this one, we need to do the allocation by</span>
01179     <span class="comment">// hand. Since every application will be statically linked to the</span>
01180     <span class="comment">// system Dll, we'll keep the LoadCount initialized to 0.</span>
01181     <span class="comment">//</span>
01182 
01183     LdrDataTableEntry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(SystemDllBase);
01184     LdrDataTableEntry-&gt;Flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)LDRP_IMAGE_DLL;
01185     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(LdrDataTableEntry-&gt;DllBase);
01186     LdrDataTableEntry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
01187 
01188     LdrDataTableEntry-&gt;BaseDllName.Length = SystemDllPath.Length;
01189     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;SystemDllPath, L<span class="stringliteral">"ntdll.dll"</span> );
01190     LdrDataTableEntry-&gt;BaseDllName.Length = SystemDllPath.Length - LdrDataTableEntry-&gt;BaseDllName.Length;
01191     LdrDataTableEntry-&gt;BaseDllName.MaximumLength = LdrDataTableEntry-&gt;BaseDllName.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
01192 
01193     LdrDataTableEntry-&gt;FullDllName.Buffer =
01194         (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( SystemDllPath.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ) );
01195     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LdrDataTableEntry-&gt;FullDllName.Buffer != NULL);
01196     RtlMoveMemory( LdrDataTableEntry-&gt;FullDllName.Buffer,
01197                    SystemDllPath.Buffer,
01198                    SystemDllPath.Length
01199                  );
01200     LdrDataTableEntry-&gt;FullDllName.Buffer[ SystemDllPath.Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
01201     LdrDataTableEntry-&gt;FullDllName.Length = SystemDllPath.Length;
01202     LdrDataTableEntry-&gt;FullDllName.MaximumLength = SystemDllPath.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
01203     LdrDataTableEntry-&gt;BaseDllName.Buffer = (PWSTR)
01204         ((PCHAR)(LdrDataTableEntry-&gt;FullDllName.Buffer) +
01205          LdrDataTableEntry-&gt;FullDllName.Length -
01206          LdrDataTableEntry-&gt;BaseDllName.Length
01207         );
01208     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(LdrDataTableEntry);
01209 
01210     <span class="comment">//</span>
01211     <span class="comment">// Add init routine to list</span>
01212     <span class="comment">//</span>
01213 
01214     InsertHeadList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
01215                    &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// Inherit the current directory</span>
01219     <span class="comment">//</span>
01220 
01221     st = <a class="code" href="../../d5/d1/curdir_8c.html#a22">RtlSetCurrentDirectory_U</a>(&amp;CurDir);
01222     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01223         <span class="keywordflow">if</span> ( !StaticCurDir ) {
01224             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;CurDir);
01225             }
01226         CurDir = <a class="code" href="../../d8/d1/init_8h.html#a3">NtSystemRoot</a>;
01227         st = <a class="code" href="../../d5/d1/curdir_8c.html#a22">RtlSetCurrentDirectory_U</a>(&amp;CurDir);
01228         }
01229     <span class="keywordflow">else</span> {
01230         <span class="keywordflow">if</span> ( !StaticCurDir ) {
01231             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;CurDir);
01232             }
01233         }
01234 
01235 <span class="preprocessor">#if defined(WX86)</span>
01236 <span class="preprocessor"></span>
01237     <span class="comment">//</span>
01238     <span class="comment">// Load in x86 emulator for risc (Wx86.dll)</span>
01239     <span class="comment">//</span>
01240 
01241     <span class="keywordflow">if</span> (NtHeader-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386) {
01242         st = LdrpLoadWx86Dll(Context);
01243         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01244             <span class="keywordflow">return</span> st;
01245             }
01246         }
01247 
01248 <span class="preprocessor">#endif</span>
01249 <span class="preprocessor"></span>
01250 <span class="preprocessor">#if defined(_WIN64)</span>
01251 <span class="preprocessor"></span>    <span class="comment">//</span>
01252     <span class="comment">// Load in WOW64 if the image is supposed to run simulated</span>
01253     <span class="comment">//</span>
01254     <span class="keywordflow">if</span> (UseWOW64) {
01255         UNICODE_STRING Wow64Name;
01256         ANSI_STRING ProcName;
01257         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;Wow64Name, L<span class="stringliteral">"wow64.dll"</span>);
01258         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a2">LdrLoadDll</a>(NULL, NULL, &amp;Wow64Name, &amp;Wow64Handle);
01259         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01260             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01261                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"wow64.dll not found.  Status=%x\n"</span>, st);
01262             }
01263             <span class="keywordflow">return</span> st;
01264         }
01265 
01266         <span class="comment">//</span>
01267         <span class="comment">// Get the entrypoints.  They are roughly cloned from ntos\ps\psinit.c</span>
01268         <span class="comment">// PspInitSystemDll().</span>
01269         <span class="comment">//</span>
01270         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ProcName, <span class="stringliteral">"Wow64LdrpInitialize"</span>);
01271         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(Wow64Handle,
01272                                     &amp;ProcName,
01273                                     0,
01274                                     (PVOID *)&amp;Wow64LdrpInitialize);
01275         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01276             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01277                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wow64LdrpInitialize not found.  Status=%x\n"</span>, st);
01278             }
01279             <span class="keywordflow">return</span> st;
01280         }
01281 
01282         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ProcName, <span class="stringliteral">"Wow64PrepareForException"</span>);
01283         st = <a class="code" href="../../d4/d2/ldrapi_8c.html#a7">LdrGetProcedureAddress</a>(Wow64Handle,
01284                                     &amp;ProcName,
01285                                     0,
01286                                     (PVOID *)&amp;Wow64PrepareForException);
01287         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01288             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01289                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Wow64PrepareForException not found.  Status=%x\n"</span>, st);
01290             }
01291             <span class="keywordflow">return</span> st;
01292         }
01293 
01294         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING:  PROCESS HAS BEEN CONVERTED TO WOW64!!!\n"</span>);
01295         <span class="keywordflow">if</span> (Peb-&gt;ProcessParameters) {
01296            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CommandLine: %wZ\n"</span>, &amp;Peb-&gt;ProcessParameters-&gt;CommandLine);
01297            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"ImagePathName: %wZ\n"</span>, &amp;Peb-&gt;ProcessParameters-&gt;ImagePathName);
01298         }
01299 
01300         <span class="comment">//</span>
01301         <span class="comment">// Now that all DLLs are loaded, if the process is being debugged,</span>
01302         <span class="comment">// signal the debugger with an exception</span>
01303         <span class="comment">//</span>
01304 
01305         <span class="keywordflow">if</span> ( Peb-&gt;BeingDebugged ) {
01306              DbgBreakPoint();
01307         }
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// Release the loaderlock now - this thread doesn't need it any more.</span>
01311         <span class="comment">//</span>
01312         RtlLeaveCriticalSection(&amp;LoaderLock);
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// Call wow64 to load and run 32-bit ntdll.dll.</span>
01316         <span class="comment">//</span>
01317         (*Wow64LdrpInitialize)(Context);
01318         <span class="comment">// This never returns.  It will destroy the process.</span>
01319     }
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>
01322 
01323     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a>(
01324             <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
01325             LdrpImageEntry
01326             );
01327 
01328     <span class="keywordflow">if</span> ((PVOID)NtHeader-&gt;OptionalHeader.ImageBase != NtCurrentPeb()-&gt;ImageBaseAddress ) {
01329 
01330         <span class="comment">//</span>
01331         <span class="comment">// The executable is not at its original address.  It must be</span>
01332         <span class="comment">// relocated now.</span>
01333         <span class="comment">//</span>
01334 
01335         PVOID ViewBase;
01336         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01337 
01338         ViewBase = NtCurrentPeb()-&gt;ImageBaseAddress;
01339 
01340         status = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, FALSE, TRUE);
01341 
01342         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01343             <span class="keywordflow">return</span> status;
01344         }
01345 
01346         status = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(ViewBase,
01347                     <span class="stringliteral">"LDR"</span>,
01348                     (ULONG)STATUS_SUCCESS,
01349                     (ULONG)STATUS_CONFLICTING_ADDRESSES,
01350                     (ULONG)STATUS_INVALID_IMAGE_FORMAT
01351                     );
01352 
01353         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01354             <span class="keywordflow">return</span> status;
01355         }
01356 
01357         <span class="comment">//</span>
01358         <span class="comment">// Update the initial thread context record as per the relocation.</span>
01359         <span class="comment">//</span>
01360 
01361         <span class="keywordflow">if</span> (Context) {
01362 
01363             OldBase = NtHeader-&gt;OptionalHeader.ImageBase;
01364             Diff = (PCHAR)ViewBase - (PCHAR)OldBase;
01365 
01366             <a class="code" href="../../d8/d2/ldrinit_8c.html#a14">LdrpRelocateStartContext</a>(Context, Diff);
01367         }
01368 
01369         status = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, TRUE, TRUE);
01370 
01371         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01372             <span class="keywordflow">return</span> status;
01373         }
01374     }
01375 
01376 <span class="preprocessor">#if defined (_ALPHA_)</span>
01377 <span class="preprocessor"></span>
01378     <span class="comment">//</span>
01379     <span class="comment">// Find and apply Alpha architecture fixups for this image</span>
01380     <span class="comment">//</span>
01381 
01382     AlphaFindArchitectureFixups(NtHeader, NtCurrentPeb()-&gt;ImageBaseAddress, TRUE);
01383 <span class="preprocessor">#endif</span>
01384 <span class="preprocessor"></span>
01385     <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrpImageEntry);
01386 
01387     <span class="comment">//</span>
01388     <span class="comment">// Lock the loaded DLLs to prevent dlls that back link to the exe to</span>
01389     <span class="comment">// cause problems when they are unloaded.</span>
01390     <span class="comment">//</span>
01391 
01392     {
01393         PLDR_DATA_TABLE_ENTRY Entry;
01394         PLIST_ENTRY Head,Next;
01395 
01396         Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01397         Next = Head-&gt;Flink;
01398 
01399         <span class="keywordflow">while</span> ( Next != Head ) {
01400             Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01401             Entry-&gt;LoadCount = 0xffff;
01402             Next = Next-&gt;Flink;
01403         }
01404     }
01405 
01406     <span class="comment">//</span>
01407     <span class="comment">// All static DLLs are now pinned in place. No init routines have been run yet</span>
01408     <span class="comment">//</span>
01409 
01410     <a class="code" href="../../d8/d2/ldrinit_8c.html#a3">LdrpLdrDatabaseIsSetup</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01411 
01412 
01413     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01414 <span class="preprocessor">#if DBG</span>
01415 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Initialize of image failed. Returning Error Status\n"</span>);
01416 <span class="preprocessor">#endif</span>
01417 <span class="preprocessor"></span>        <span class="keywordflow">return</span> st;
01418     }
01419 
01420     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a78">LdrpInitializeTls</a>()) ) {
01421         <span class="keywordflow">return</span> st;
01422         }
01423 
01424     <span class="comment">//</span>
01425     <span class="comment">// Now that all DLLs are loaded, if the process is being debugged,</span>
01426     <span class="comment">// signal the debugger with an exception</span>
01427     <span class="comment">//</span>
01428 
01429     <span class="keywordflow">if</span> ( Peb-&gt;BeingDebugged ) {
01430          DbgBreakPoint();
01431          <a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a> = (BOOLEAN)(FLG_SHOW_LDR_SNAPS &amp; Peb-&gt;NtGlobalFlag);
01432     }
01433 
01434 <span class="preprocessor">#if defined (_X86_)</span>
01435 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> &gt; 1 ) {
01436         LdrpValidateImageForMp(LdrDataTableEntry);
01437         }
01438 <span class="preprocessor">#endif</span>
01439 <span class="preprocessor"></span>
01440 <span class="preprocessor">#if DBG</span>
01441 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01442         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;InitbTime, NULL);
01443     }
01444 <span class="preprocessor">#endif // DBG</span>
01445 <span class="preprocessor"></span>
01446     <span class="comment">//</span>
01447     <span class="comment">// Get all application goo here (hacks, flags, etc.)</span>
01448     <span class="comment">//</span>
01449     <a class="code" href="../../d8/d2/ldrinit_8c.html#a19">LdrQueryApplicationCompatibilityGoo</a>(UnicodeImageName);
01450 
01451     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(Context);
01452 
01453     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) &amp;&amp; Peb-&gt;PostProcessInitRoutine ) {
01454         (Peb-&gt;PostProcessInitRoutine)();
01455         }
01456 
01457     <span class="keywordflow">return</span> st;
01458 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="ldrp.h::LdrpInitializeTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpInitializeTls           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">1978</a> of file <a class="el" href="../../d9/d1/ldrinit_8c-source.html">ldrinit.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00401">LdrpNumberOfTlsEntries</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">LdrpTlsList</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d9/d2/ldrp_8h.html#a50">PLDRP_TLS_ENTRY</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00462">TLS_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.
<p>
<pre class="fragment"><div>01981 {
01982     PLDR_DATA_TABLE_ENTRY Entry;
01983     PLIST_ENTRY Head,Next;
01984     PIMAGE_TLS_DIRECTORY TlsImage;
01985     <a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html">PLDRP_TLS_ENTRY</a> TlsEntry;
01986     ULONG TlsSize;
01987     BOOLEAN FirstTimeThru = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01988 
01989     InitializeListHead(&amp;LdrpTlsList);
01990 
01991     <span class="comment">//</span>
01992     <span class="comment">// Walk through the loaded modules an look for TLS. If we find TLS,</span>
01993     <span class="comment">// lock in the module and add to the TLS chain.</span>
01994     <span class="comment">//</span>
01995 
01996     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01997     Next = Head-&gt;Flink;
01998 
01999     <span class="keywordflow">while</span> ( Next != Head ) {
02000         Entry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
02001         Next = Next-&gt;Flink;
02002 
02003         TlsImage = (PIMAGE_TLS_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02004                            Entry-&gt;DllBase,
02005                            TRUE,
02006                            IMAGE_DIRECTORY_ENTRY_TLS,
02007                            &amp;TlsSize
02008                            );
02009 
02010         <span class="comment">//</span>
02011         <span class="comment">// mark whether or not the image file has TLS</span>
02012         <span class="comment">//</span>
02013 
02014         <span class="keywordflow">if</span> ( FirstTimeThru ) {
02015             FirstTimeThru = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02016             <span class="keywordflow">if</span> ( TlsImage &amp;&amp; !<a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a>) {
02017                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a11">RtlpSerializeHeap</a>( RtlProcessHeap() );
02018                 <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02019                 }
02020             }
02021 
02022         <span class="keywordflow">if</span> ( TlsImage ) {
02023             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02024                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Tls Found in %wZ at %lx\n"</span>,
02025                             &amp;Entry-&gt;BaseDllName,
02026                             TlsImage
02027                         );
02028                 }
02029 
02030             TlsEntry = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TLS_TAG ),<span class="keyword">sizeof</span>(*TlsEntry));
02031             <span class="keywordflow">if</span> ( !TlsEntry ) {
02032                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02033                 }
02034 
02035             <span class="comment">//</span>
02036             <span class="comment">// Since this DLL has TLS, lock it in</span>
02037             <span class="comment">//</span>
02038 
02039             Entry-&gt;LoadCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
02040 
02041             <span class="comment">//</span>
02042             <span class="comment">// Mark this as having thread local storage</span>
02043             <span class="comment">//</span>
02044 
02045             Entry-&gt;TlsIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
02046 
02047             TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a> = *TlsImage;
02048             InsertTailList(&amp;LdrpTlsList,&amp;TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o0">Links</a>);
02049 
02050             <span class="comment">//</span>
02051             <span class="comment">// Update the index for this dll's thread local storage</span>
02052             <span class="comment">//</span>
02053 
02054 
02055             *(PLONG)TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.AddressOfIndex = <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a>;
02056             TlsEntry-&gt;<a class="code" href="../../d8/d9/struct__LDRP__TLS__ENTRY.html#o1">Tls</a>.Characteristics = <a class="code" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a>++;
02057             }
02058         }
02059 
02060     <span class="comment">//</span>
02061     <span class="comment">// We now have walked through all static DLLs and know</span>
02062     <span class="comment">// all DLLs that reference thread local storage. Now we</span>
02063     <span class="comment">// just have to allocate the thread local storage for the current</span>
02064     <span class="comment">// thread and for all subsequent threads</span>
02065     <span class="comment">//</span>
02066 
02067     <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/ldrp_8h.html#a79">LdrpAllocateTls</a>();
02068 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="ldrp.h::LdrpInsertMemoryTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpInsertMemoryTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LdrDataTableEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">3084</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00161">LDRP_COMPUTE_HASH_INDEX</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00162">LdrpHashTable</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03090                    :
03091 
03092     This function inserts a loader data table entry into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03093     list of loaded modules <span class="keywordflow">for</span> <span class="keyword">this</span> process. The insertion <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03094     done in <span class="stringliteral">"image memory base order"</span>.
03095 
03096 Arguments:
03097 
03098     LdrDataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader data table
03099         entry to insert in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of loaded modules <span class="keywordflow">for</span> <span class="keyword">this</span> process.
03100 
03101 Return Value:
03102 
03103     None.
03104 
03105 --*/
03106 
03107 {
03108     PPEB_LDR_DATA Ldr;
03109     ULONG i;
03110 
03111     Ldr = NtCurrentPeb()-&gt;Ldr;
03112 
03113     i = <a class="code" href="../../d9/d2/ldrp_8h.html#a7">LDRP_COMPUTE_HASH_INDEX</a>(LdrDataTableEntry-&gt;BaseDllName.Buffer[0]);
03114     InsertTailList(&amp;LdrpHashTable[i],&amp;LdrDataTableEntry-&gt;HashLinks);
03115     InsertTailList(&amp;Ldr-&gt;InLoadOrderModuleList, &amp;LdrDataTableEntry-&gt;InLoadOrderLinks);
03116     InsertTailList(&amp;Ldr-&gt;InMemoryOrderModuleList, &amp;LdrDataTableEntry-&gt;InMemoryOrderLinks);
03117 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="ldrp.h::LdrpLoadDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NTAPI LdrpLoadDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RunInitRoutines</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">70</a> of file <a class="el" href="../../d5/d1/ldrapi_8c-source.html">ldrapi.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00026">DLLEXTENSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00622">LdrpClearLoadInProgress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00034">LdrpLdrDatabaseIsSetup</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00253">LdrpReferenceLoadedDll</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00142">LoaderLock</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00035">LdrLoadDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.
<p>
<pre class="fragment"><div>00078 {
00079     PPEB Peb;
00080     PTEB Teb;
00081     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00082     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00083     PWSTR ActualDllName;
00084     PWCH p, pp;
00085     UNICODE_STRING ActualDllNameStr;
00086     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00087     WCHAR FreeBuffer[266];
00088 
00089     Peb = NtCurrentPeb();
00090     Teb = NtCurrentTeb();
00091 
00092     st = STATUS_SUCCESS;
00093 
00094     <span class="keywordflow">try</span> {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">// Grab Peb lock and Snap All Links to specified DLL</span>
00098         <span class="comment">//</span>
00099 
00100         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00101             RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00102             }
00103 
00104 
00105 
00106 <span class="preprocessor">#if defined (WX86)</span>
00107 <span class="preprocessor"></span>
00108         <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.UseKnownWx86Dll) {
00109             Wx86KnownDll = Teb-&gt;Wx86Thread.UseKnownWx86Dll;
00110             Teb-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00111             }
00112 <span class="preprocessor">#endif</span>
00113 <span class="preprocessor"></span>
00114 
00115 
00116         p = DllName-&gt;Buffer;
00117         pp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00118         <span class="keywordflow">while</span> (*p) {
00119             <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'.'</span>) {
00120                 <span class="comment">//</span>
00121                 <span class="comment">// pp will point to first character after last '.'</span>
00122                 <span class="comment">//</span>
00123                 pp = p;
00124                 }
00125             }
00126 
00127 
00128         ActualDllName = FreeBuffer;
00129         <span class="keywordflow">if</span> ( DllName-&gt;Length &gt;= <span class="keyword">sizeof</span>(FreeBuffer)) {
00130             <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00131             }
00132         RtlMoveMemory(ActualDllName, DllName-&gt;Buffer, DllName-&gt;Length);
00133 
00134 
00135         <span class="keywordflow">if</span> (!pp || *pp == (WCHAR)<span class="charliteral">'\\'</span>) {
00136             <span class="comment">//</span>
00137             <span class="comment">// No extension found (just ..\)</span>
00138             <span class="comment">//</span>
00139             <span class="keywordflow">if</span> ( DllName-&gt;Length+10 &gt;= <span class="keyword">sizeof</span>(FreeBuffer) ) {
00140                 <span class="keywordflow">return</span> STATUS_NAME_TOO_LONG;
00141                 }
00142 
00143             RtlMoveMemory((PCHAR)ActualDllName+DllName-&gt;Length, DLLEXTENSION, 10);
00144             }
00145         <span class="keywordflow">else</span> {
00146             ActualDllName[DllName-&gt;Length &gt;&gt; 1] = UNICODE_NULL;
00147             }
00148 
00149         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00150             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrLoadDll, loading %ws from %ws\n"</span>,
00151                      ActualDllName,
00152                      ARGUMENT_PRESENT(DllPath) ? DllPath : L<span class="stringliteral">""</span>
00153                      );
00154             }
00155 
00156 
00157         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ActualDllNameStr,ActualDllName);
00158         ActualDllNameStr.MaximumLength = <span class="keyword">sizeof</span>(FreeBuffer);
00159 
00160         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( DllPath,
00161                                     &amp;ActualDllNameStr,
00162                                     FALSE,
00163                                     Wx86KnownDll,
00164                                     &amp;LdrDataTableEntry
00165                                   )
00166            ) {
00167             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a46">LdrpMapDll</a>(DllPath,
00168                             ActualDllName,
00169                             DllCharacteristics,
00170                             FALSE,
00171                             Wx86KnownDll,
00172                             &amp;LdrDataTableEntry
00173                             );
00174 
00175             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00176                 <span class="keywordflow">return</span> st;
00177                 }
00178 
00179             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( DllCharacteristics ) &amp;&amp;
00180                 *DllCharacteristics &amp; IMAGE_FILE_EXECUTABLE_IMAGE
00181                ) {
00182                 LdrDataTableEntry-&gt;EntryPoint = 0;
00183                 LdrDataTableEntry-&gt;Flags &amp;= ~LDRP_IMAGE_DLL;
00184                 }
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// and walk the import descriptor.</span>
00188             <span class="comment">//</span>
00189 
00190             <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
00191 
00192                 <span class="keywordflow">try</span> {
00193                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a39">LdrpWalkImportDescriptor</a>(
00194                               DllPath,
00195                               LdrDataTableEntry
00196                               );
00197                     }
00198                 except(EXCEPTION_EXECUTE_HANDLER) {
00199                     st = GetExceptionCode();
00200                     }
00201                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00202                     LdrDataTableEntry-&gt;LoadCount++;
00203                     }
00204                 <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrDataTableEntry);
00205                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00206                     LdrDataTableEntry-&gt;EntryPoint = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00207                     InsertTailList(&amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList,
00208                            &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
00209                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00210                     <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00211                     <span class="keywordflow">return</span> st;
00212                     }
00213                 }
00214             <span class="keywordflow">else</span> {
00215                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00216                     LdrDataTableEntry-&gt;LoadCount++;
00217                     }
00218                 }
00219 
00220             <span class="comment">//</span>
00221             <span class="comment">// Add init routine to list</span>
00222             <span class="comment">//</span>
00223 
00224             InsertTailList(&amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList,
00225                            &amp;LdrDataTableEntry-&gt;InInitializationOrderLinks);
00226 
00227 
00228             <span class="comment">//</span>
00229             <span class="comment">// If the loader data base is not fully setup, this load was because</span>
00230             <span class="comment">// of a forwarder in the static load set. Can't run init routines</span>
00231             <span class="comment">// yet because the load counts are NOT set</span>
00232             <span class="comment">//</span>
00233 
00234             <span class="keywordflow">if</span> ( RunInitRoutines &amp;&amp; <a class="code" href="../../d8/d2/ldrinit_8c.html#a3">LdrpLdrDatabaseIsSetup</a> ) {
00235 
00236                 <span class="keywordflow">try</span> {
00237                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a43">LdrpRunInitializeRoutines</a>(NULL);
00238                     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00239                         <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00240                         }
00241                     }
00242                 except( EXCEPTION_EXECUTE_HANDLER ) {
00243                     <a class="code" href="../../d4/d2/ldrapi_8c.html#a6">LdrUnloadDll</a>((PVOID)LdrDataTableEntry-&gt;DllBase);
00244                     <span class="keywordflow">return</span> GetExceptionCode();
00245                     }
00246                 }
00247             <span class="keywordflow">else</span> {
00248                 st = STATUS_SUCCESS;
00249                 }
00250 
00251             }
00252         <span class="keywordflow">else</span> {
00253 
00254             <span class="comment">//</span>
00255             <span class="comment">// Count it. And everything that it imports.</span>
00256             <span class="comment">//</span>
00257 
00258             <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_DLL &amp;&amp;
00259                  LdrDataTableEntry-&gt;LoadCount != 0xffff  ) {
00260 
00261                 LdrDataTableEntry-&gt;LoadCount++;
00262 
00263                 <a class="code" href="../../d9/d2/ldrp_8h.html#a9">LdrpReferenceLoadedDll</a>(LdrDataTableEntry);
00264 
00265                 <span class="comment">//</span>
00266                 <span class="comment">// Now clear the Load in progress bits</span>
00267                 <span class="comment">//</span>
00268 
00269                 <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00270 
00271                 }
00272             <span class="keywordflow">else</span> {
00273                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;LoadCount != 0xffff ) {
00274                     LdrDataTableEntry-&gt;LoadCount++;
00275                     }
00276                 }
00277             }
00278         }
00279     finally {
00280         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00281             RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)NtCurrentPeb()-&gt;LoaderLock);
00282             }
00283 
00284         }
00285     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00286         *DllHandle = (PVOID)LdrDataTableEntry-&gt;DllBase;
00287         }
00288     <span class="keywordflow">else</span> {
00289         *DllHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00290         }
00291     <span class="keywordflow">return</span> st;
00292 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="ldrp.h::LdrpMapDll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpMapDll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG DllCharacteristics&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StaticLink</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wx86KnownDll</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLDR_DATA_TABLE_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">1261</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00090">Action</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03043">LdrpAllocateDataTableEntry()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">LdrpDefaultPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00386">LdrpFatalHardErrorCount</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03249">LdrpFetchAddressOfEntryPoint()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">LdrpInsertMemoryTableEntry()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00034">LdrpKnownDllObjectDirectory</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00391">LdrpNumberOfProcessors</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">LdrpSetProtection()</a>, <a class="el" href="../../d1/d2/ldrreloc_8c-source.html#l00091">LdrRelocateImage()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00153">NATIVE_PAGE_SIZE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00199">NtMapViewOfSection()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00851">NtQueryPerformanceCounter()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00532">NtRaiseHardError()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d8/umapview_8c-source.html#l00033">NtUnmapViewOfSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l01717">RtlDosPathNameToNtPathName_U()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d4/i386_2trapc_8c-source.html#l00076">type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00140">LdrpLoadImportModule()</a>.
<p>
<pre class="fragment"><div>01272                    :
01273 
01274     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> users address space.
01275 
01276 Arguments:
01277 
01278     DllPath - Supplies an optional search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to be used to locate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
01279 
01280     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to load.
01281 
01282     StaticLink - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> DLL has a <span class="keyword">static</span> link to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01283 
01284     Wx86KnownDll - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, treat Importer as x86
01285 
01286     LdrDataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data table entry.
01287 
01288 Return Value:
01289 
01290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
01291 
01292 --*/
01293 
01294 {
01295     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01296     PVOID ViewBase;
01297     PTEB Teb = NtCurrentTeb();
01298     SIZE_T ViewSize;
01299     HANDLE Section, DllFile;
01300     UNICODE_STRING FullDllName, BaseDllName;
01301     UNICODE_STRING NtFileName;
01302     PLDR_DATA_TABLE_ENTRY Entry;
01303     PIMAGE_NT_HEADERS NtHeaders;
01304     PVOID ArbitraryUserPointer;
01305     BOOLEAN KnownDll;
01306     UNICODE_STRING CollidingDll;
01307     PUCHAR ImageBase, ImageBounds, ScanBase, ScanTop;
01308     PLDR_DATA_TABLE_ENTRY ScanEntry;
01309     PLIST_ENTRY ScanHead,ScanNext;
01310     BOOLEAN CollidingDllFound;
01311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ErrorStatus;
01312     ULONG_PTR ErrorParameters[2];
01313     ULONG ErrorResponse;
01314 <span class="preprocessor">#if defined (WX86)</span>
01315 <span class="preprocessor"></span>    BOOLEAN Wx86Plugin = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01316 <span class="preprocessor">#endif</span>
01317 <span class="preprocessor"></span>
01318 
01319     <span class="comment">//</span>
01320     <span class="comment">// Get section handle of DLL being snapped</span>
01321     <span class="comment">//</span>
01322 
01323 <span class="preprocessor">#if LDRDBG</span>
01324 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01325         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpMapDll: Image Name %ws, Search Path %ws\n"</span>,
01326                 DllName,
01327                 ARGUMENT_PRESENT(DllPath) ? DllPath : L<span class="stringliteral">""</span>
01328                 );
01329     }
01330 <span class="preprocessor">#endif</span>
01331 <span class="preprocessor"></span>
01332     Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01333     KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01334     Section = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01335 
01336     <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a> &amp;&amp; !Wx86KnownDll) {
01337 
01338         PWCH p = DllName;
01339         WCHAR wch;
01340 
01341         <span class="comment">//</span>
01342         <span class="comment">// Skip the KnownDll check if this is an explicit path.</span>
01343         <span class="comment">//</span>
01344 
01345         <span class="keywordflow">while</span> (*p) {
01346             wch = *p++;
01347             <span class="keywordflow">if</span> (wch == (WCHAR)<span class="charliteral">'\\'</span> || wch == (WCHAR)<span class="charliteral">'/'</span> ) {
01348                 <span class="keywordflow">goto</span> SkipKnownDllCheck;
01349                 }
01350             }
01351         Section = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a56">LdrpCheckForKnownDll</a>(
01352                         DllName,
01353                         &amp;FullDllName,
01354                         &amp;BaseDllName
01355                         );
01356 
01357         }
01358 
01359 SkipKnownDllCheck:
01360 
01361     <span class="keywordflow">if</span> ( !Section ) {
01362 
01363 <span class="preprocessor">#if defined (WX86)</span>
01364 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Wx86ProcessInit) {
01365             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;BaseDllName, DllName);
01366             st = LdrpWx86MapDll(DllPath,
01367                                 DllCharacteristics,
01368                                 Wx86KnownDll,
01369                                 StaticLink,
01370                                 &amp;BaseDllName,
01371                                 &amp;Entry,
01372                                 &amp;ViewSize,
01373                                 &amp;Section
01374                                 );
01375 
01376             <span class="keywordflow">if</span> (st == STATUS_DLL_NOT_FOUND) {
01377                 <span class="keywordflow">goto</span> Wx86MapDllNotFound;
01378                 }
01379 
01380             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01381                 <span class="keywordflow">return</span> st;
01382                 }
01383 
01384 
01385             ViewBase    = Entry-&gt;DllBase;
01386             FullDllName = Entry-&gt;FullDllName;
01387             BaseDllName = Entry-&gt;BaseDllName;
01388             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01389 
01390             <span class="keywordflow">goto</span> Wx86MapComplete;
01391 
01392         } <span class="keywordflow">else</span>
01393 <span class="preprocessor">#endif</span>
01394 <span class="preprocessor"></span>
01395         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a54">LdrpResolveDllName</a>( DllPath,
01396                                 DllName,
01397                                 &amp;FullDllName,
01398                                 &amp;BaseDllName,
01399                                 &amp;DllFile
01400                               )
01401            ) {
01402             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01403                 PSZ <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>;
01404                 <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> = StaticLink ? <span class="stringliteral">"STATIC"</span> : <span class="stringliteral">"DYNAMIC"</span>;
01405                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Loading (%s) %wZ\n"</span>,
01406                          type,
01407                          &amp;FullDllName
01408                          );
01409             }
01410 
01411             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d1/curdir_8c.html#a29">RtlDosPathNameToNtPathName_U</a>( FullDllName.Buffer,
01412                                                &amp;NtFileName,
01413                                                NULL,
01414                                                NULL
01415                                              )
01416                ) {
01417                 <span class="keywordflow">return</span> STATUS_OBJECT_PATH_SYNTAX_BAD;
01418                 }
01419 
01420             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a47">LdrpCreateDllSection</a>(&amp;NtFileName,
01421                                       DllFile,
01422                                       &amp;BaseDllName,
01423                                       DllCharacteristics,
01424                                       &amp;Section
01425                                      );
01426 
01427             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, NtFileName.Buffer);
01428 
01429             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01430                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;FullDllName);
01431                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;BaseDllName);
01432                 <span class="keywordflow">return</span> st;
01433             }
01434 <span class="preprocessor">#if DBG</span>
01435 <span class="preprocessor"></span>            LdrpSectionCreates++;
01436 <span class="preprocessor">#endif</span>
01437 <span class="preprocessor"></span>
01438         } <span class="keywordflow">else</span> {
01439 
01440 <span class="preprocessor">#ifdef WX86</span>
01441 <span class="preprocessor"></span>Wx86MapDllNotFound:
01442 <span class="preprocessor">#endif</span>
01443 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( StaticLink ) {
01444                 PUNICODE_STRING ErrorStrings[2];
01445                 UNICODE_STRING ErrorDllName, ErrorDllPath;
01446                 ULONG ErrorResponse;
01447 
01448                 ErrorStrings[0] = &amp;ErrorDllName;
01449                 ErrorStrings[1] = &amp;ErrorDllPath;
01450                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ErrorDllName,DllName);
01451                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;ErrorDllPath,
01452                         ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer);
01453                 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01454                   (NTSTATUS)STATUS_DLL_NOT_FOUND,
01455                   2,
01456                   0x00000003,
01457                   (PULONG_PTR)ErrorStrings,
01458                   OptionOk,
01459                   &amp;ErrorResponse
01460                   );
01461                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01462                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01463                     }
01464                 }
01465 
01466             <span class="keywordflow">return</span> STATUS_DLL_NOT_FOUND;
01467         }
01468     } <span class="keywordflow">else</span> {
01469         KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01470     }
01471 
01472     ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01473     ViewSize = 0;
01474 
01475 
01476 <span class="preprocessor">#if DBG</span>
01477 <span class="preprocessor"></span>    LdrpSectionMaps++;
01478     <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01479         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;MapBeginTime, NULL);
01480     }
01481 <span class="preprocessor">#endif</span>
01482 <span class="preprocessor"></span>
01483     <span class="comment">//</span>
01484     <span class="comment">// arrange for debugger to pick up the image name</span>
01485     <span class="comment">//</span>
01486 
01487     ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01488     Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01489     st = <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01490             Section,
01491             NtCurrentProcess(),
01492             (PVOID *)&amp;ViewBase,
01493             0L,
01494             0L,
01495             NULL,
01496             &amp;ViewSize,
01497             ViewShare,
01498             0L,
01499             PAGE_READWRITE
01500             );
01501     Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01502 
01503     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01504         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01505         <span class="keywordflow">return</span> st;
01506     }
01507 
01508     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01509     <span class="keywordflow">if</span> ( !NtHeaders ) {
01510         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01511         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01512         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01513         }
01514 
01515 <span class="preprocessor">#if DBG</span>
01516 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (LdrpDisplayLoadTime) {
01517         <a class="code" href="../../d9/d6/ex_2profile_8c.html#a14">NtQueryPerformanceCounter</a>(&amp;MapEndTime, NULL);
01518         MapElapsedTime.QuadPart = MapEndTime.QuadPart - MapBeginTime.QuadPart;
01519         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Map View of Section Time %ld %ws\n"</span>,
01520             MapElapsedTime.LowPart,
01521             DllName
01522             );
01523     }
01524 <span class="preprocessor">#endif</span>
01525 <span class="preprocessor"></span>
01526 <span class="preprocessor">#if defined (BUILD_WOW6432)</span>
01527 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d9/d2/ldrp_8h.html#a2">NATIVE_PAGE_SIZE</a> &amp;&amp;
01528         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeaders, ViewBase)))
01529       {
01530         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01531         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01532         <span class="keywordflow">return</span> st;
01533         }
01534 <span class="preprocessor">#elif defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
01535 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
01536         !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(LdrpWx86FormatVirtualImage((PIMAGE_NT_HEADERS32)NtHeaders, ViewBase)))
01537       {
01538         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01539         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01540         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01541         }
01542 
01543     <span class="keywordflow">if</span> (st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH &amp;&amp; !StaticLink) {
01544 
01545         <span class="comment">// Attempt to find a plugin provider dll that can thunk this interface</span>
01546         <span class="comment">// temporarily insert the image in the loaded-module-list</span>
01547 
01548         Entry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(ViewBase);
01549         <span class="keywordflow">if</span> (!Entry) {
01550             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01551         }
01552 
01553         Entry-&gt;Flags = 0;
01554         Entry-&gt;LoadCount = 0;
01555         Entry-&gt;FullDllName = FullDllName;
01556         Entry-&gt;BaseDllName = BaseDllName;
01557         Entry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(Entry-&gt;DllBase);
01558         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(Entry);
01559 
01560         <span class="comment">// Determine if this dll can be thunked using a plugin</span>
01561 
01562         st = Wx86IdentifyPlugin(ViewBase, &amp;FullDllName );
01563 
01564          <span class="comment">// remove the image from the loaded-module-list</span>
01565 
01566         RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01567         RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01568         RemoveEntryList(&amp;Entry-&gt;HashLinks);
01569         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Entry);
01570         Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01571 
01572         <span class="keywordflow">if</span> (st == STATUS_SUCCESS) {
01573 
01574             <span class="comment">// Release the previous mapping because it's going to</span>
01575             <span class="comment">// be reloaded via Wx86.</span>
01576 
01577             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01578             ViewBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01579 
01580             <span class="comment">// The plugin providers must be statically bound to Wx86</span>
01581             <span class="comment">// or dynamically load it in their DllInit.</span>
01582 
01583             <span class="keywordflow">if</span> (Wx86ProcessInit) {
01584 
01585                 <span class="comment">// Load the dll again using Wx86.</span>
01586 
01587                 st = LdrpWx86MapDll(NULL,
01588                                     DllCharacteristics,
01589                                     !Wx86KnownDll,          <span class="comment">// swap sense so we don't get mismatch</span>
01590                                     StaticLink,
01591                                     &amp;FullDllName,
01592                                     &amp;Entry,
01593                                     &amp;ViewSize,
01594                                     &amp;Section
01595                                     );
01596 
01597                 <span class="comment">// Load and thunk the plugin dll</span>
01598 
01599                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01600 
01601                     ViewBase    = Entry-&gt;DllBase;
01602                     FullDllName = Entry-&gt;FullDllName;
01603                     BaseDllName = Entry-&gt;BaseDllName;
01604                     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(ViewBase);
01605 
01606                 }
01607             }
01608 
01609             <span class="keywordflow">if</span> (!Wx86ProcessInit || <a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>(st)) {
01610                 Wx86UnloadProviders(ViewBase);
01611                 st = STATUS_IMAGE_MACHINE_TYPE_MISMATCH;
01612             }
01613         }
01614 
01615         <span class="comment">// Need to save the status here to put in loader ENTRY after it's allocated.</span>
01616 
01617         Wx86Plugin = (st == STATUS_SUCCESS);
01618 
01619         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01620             PCHAR <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
01621 
01622             <span class="keywordflow">if</span> (st == STATUS_SUCCESS) {
01623                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Loaded"</span>;
01624             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH) {
01625                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Unsupported"</span>;
01626             } <span class="keywordflow">else</span> {
01627                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> = <span class="stringliteral">"Failed"</span>;
01628             }
01629 
01630             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDRWx86: Plugin: %wZ %s.\n"</span>,
01631                 &amp;FullDllName, Action
01632                 );
01633         }
01634     }
01635 
01636     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) || (ViewBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01637         <span class="keywordflow">if</span> (ViewBase) <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01638         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01639         <span class="keywordflow">return</span> st;
01640     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Entry) {
01641         <span class="keywordflow">goto</span> Wx86MapComplete;
01642     }
01643 <span class="preprocessor">#endif</span>
01644 <span class="preprocessor"></span>
01645     <span class="comment">//</span>
01646     <span class="comment">// Allocate a data table entry.</span>
01647     <span class="comment">//</span>
01648 
01649     Entry = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a52">LdrpAllocateDataTableEntry</a>(ViewBase);
01650 
01651     <span class="keywordflow">if</span> (!Entry) {
01652         <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01653         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01654         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01655     }
01656 
01657 
01658     Entry-&gt;Flags = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(StaticLink ? LDRP_STATIC_LINK : 0);
01659     Entry-&gt;LoadCount = 0;
01660     Entry-&gt;FullDllName = FullDllName;
01661     Entry-&gt;BaseDllName = BaseDllName;
01662     Entry-&gt;EntryPoint = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a55">LdrpFetchAddressOfEntryPoint</a>(Entry-&gt;DllBase);
01663 
01664 <span class="preprocessor">#ifdef WX86</span>
01665 <span class="preprocessor"></span>Wx86MapComplete:
01666     <span class="keywordflow">if</span> (Wx86Plugin) {
01667         Entry-&gt;Flags |= LDRP_WX86_PLUGIN;
01668     }
01669 <span class="preprocessor">#endif</span>
01670 <span class="preprocessor"></span>
01671 
01672 <span class="preprocessor">#if LDRDBG</span>
01673 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01674         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrpMapDll: Full Name %wZ, Base Name %wZ\n"</span>,
01675                 &amp;FullDllName,
01676                 &amp;BaseDllName
01677                 );
01678     }
01679 <span class="preprocessor">#endif</span>
01680 <span class="preprocessor"></span>
01681     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a53">LdrpInsertMemoryTableEntry</a>(Entry);
01682 
01683     <span class="keywordflow">if</span> ( st == STATUS_IMAGE_MACHINE_TYPE_MISMATCH ) {
01684 
01685         PIMAGE_NT_HEADERS ImageHeader = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( NtCurrentPeb()-&gt;ImageBaseAddress );
01686 
01687         <span class="comment">//</span>
01688         <span class="comment">// apps compiled for NT 3.x and below can load cross architecture</span>
01689         <span class="comment">// images</span>
01690         <span class="comment">//</span>
01691 
01692         ErrorStatus = STATUS_SUCCESS;
01693         ErrorResponse = ResponseCancel;
01694 
01695         <span class="keywordflow">if</span> ( ImageHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 ) {
01696 
01697             Entry-&gt;EntryPoint = 0;
01698 
01699             <span class="comment">//</span>
01700             <span class="comment">// Hard Error Time</span>
01701             <span class="comment">//</span>
01702 
01703             <span class="comment">//</span>
01704             <span class="comment">// Its error time...</span>
01705             <span class="comment">//</span>
01706 
01707             ErrorParameters[0] = (ULONG_PTR)&amp;FullDllName;
01708 
01709             ErrorStatus = <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01710                             STATUS_IMAGE_MACHINE_TYPE_MISMATCH,
01711                             1,
01712                             1,
01713                             ErrorParameters,
01714                             OptionOkCancel,
01715                             &amp;ErrorResponse
01716                             );
01717             }
01718         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ErrorStatus) &amp;&amp; ErrorResponse == ResponseCancel ) {
01719             RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01720             RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01721             RemoveEntryList(&amp;Entry-&gt;HashLinks);
01722             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, Entry );
01723             <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01724             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01725 
01726             <span class="keywordflow">if</span> ( ImageHeader-&gt;OptionalHeader.MajorSubsystemVersion &lt;= 3 ) {
01727                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01728                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01729                     }
01730                 }
01731             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
01732             }
01733         }
01734     <span class="keywordflow">else</span> {
01735         <span class="keywordflow">if</span> (NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_DLL) {
01736             Entry-&gt;Flags |= LDRP_IMAGE_DLL;
01737             }
01738 
01739         <span class="keywordflow">if</span> (!(Entry-&gt;Flags &amp; LDRP_IMAGE_DLL)) {
01740             Entry-&gt;EntryPoint = 0;
01741             }
01742         }
01743     *LdrDataTableEntry = Entry;
01744 
01745     <span class="keywordflow">if</span> (st == STATUS_IMAGE_NOT_AT_BASE) {
01746 
01747         Entry-&gt;Flags |= LDRP_IMAGE_NOT_AT_BASE;
01748 
01749         <span class="comment">//</span>
01750         <span class="comment">// now find the colliding dll. If we can not find a dll,</span>
01751         <span class="comment">// then the colliding dll must be dynamic memory</span>
01752         <span class="comment">//</span>
01753 
01754         ImageBase = (PUCHAR)NtHeaders-&gt;OptionalHeader.ImageBase;
01755         ImageBounds = ImageBase + ViewSize;
01756 
01757         CollidingDllFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01758 
01759         ScanHead = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList;
01760         ScanNext = ScanHead-&gt;Flink;
01761 
01762         <span class="keywordflow">while</span> ( ScanNext != ScanHead ) {
01763             ScanEntry = CONTAINING_RECORD(ScanNext, LDR_DATA_TABLE_ENTRY, InLoadOrderLinks);
01764             ScanNext = ScanNext-&gt;Flink;
01765 
01766             ScanBase = (PUCHAR)ScanEntry-&gt;DllBase;
01767             ScanTop = ScanBase + ScanEntry-&gt;SizeOfImage;
01768 
01769             <span class="comment">//</span>
01770             <span class="comment">// when we unload, the memory order links flink field is nulled.</span>
01771             <span class="comment">// this is used to skip the entry pending list removal.</span>
01772             <span class="comment">//</span>
01773 
01774             <span class="keywordflow">if</span> ( !ScanEntry-&gt;InMemoryOrderLinks.Flink ) {
01775                 <span class="keywordflow">continue</span>;
01776                 }
01777 
01778             <span class="comment">//</span>
01779             <span class="comment">// See if the base address of the scan image is within the relocating dll</span>
01780             <span class="comment">// or if the top address of the scan image is within the relocating dll</span>
01781             <span class="comment">//</span>
01782 
01783             <span class="keywordflow">if</span> ( (ImageBase &gt;= ScanBase &amp;&amp; ImageBase &lt;= ScanTop)
01784 
01785                  ||
01786 
01787                  (ImageBounds &gt;= ScanBase &amp;&amp; ImageBounds &lt;= ScanTop)
01788 
01789                  ||
01790 
01791                  (ScanBase &gt;= ImageBase &amp;&amp; ScanBase &lt;= ImageBounds)
01792 
01793                  ){
01794 
01795                 CollidingDllFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01796                 CollidingDll = ScanEntry-&gt;FullDllName;
01797                 <span class="keywordflow">break</span>;
01798                 }
01799             }
01800 
01801         <span class="keywordflow">if</span> ( !CollidingDllFound ) {
01802             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;CollidingDll,L<span class="stringliteral">"Dynamically Allocated Memory"</span>);
01803             }
01804 
01805 <span class="preprocessor">#if DBG</span>
01806 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( BeginTime.LowPart || BeginTime.HighPart ) {
01807             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nLDR: LdrpMapDll Relocateing Image Name %ws\n"</span>,
01808                     DllName
01809                     );
01810         }
01811         LdrpSectionRelocates++;
01812 <span class="preprocessor">#endif</span>
01813 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL) {
01814 
01815             BOOLEAN AllowRelocation;
01816             UNICODE_STRING SystemDll;
01817 
01818             <span class="keywordflow">if</span> (!(NtHeaders-&gt;FileHeader.Characteristics &amp; IMAGE_FILE_RELOCS_STRIPPED)) {
01819 
01820                 PVOID pBaseRelocs;
01821                 ULONG BaseRelocCountBytes = 0;
01822 
01823                 <span class="comment">//</span>
01824                 <span class="comment">// If the iamge doesn't have the reloc stripped bit set and there's no</span>
01825                 <span class="comment">// relocs in the data directory, allow this through.  This is probably</span>
01826                 <span class="comment">// a pure forwarder dll or data w/o relocs.</span>
01827                 <span class="comment">//</span>
01828 
01829                 pBaseRelocs = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
01830                         ViewBase, TRUE, IMAGE_DIRECTORY_ENTRY_BASERELOC, &amp;BaseRelocCountBytes);
01831 
01832                 <span class="keywordflow">if</span> (!pBaseRelocs &amp;&amp; !BaseRelocCountBytes) {
01833                     <span class="keywordflow">goto</span> NoRelocNeeded;
01834                     }
01835                 }
01836 
01837             <span class="comment">//</span>
01838             <span class="comment">// decide whether or not to allow the relocation</span>
01839             <span class="comment">// certain system dll's like user32 and kernel32 are not relocatable</span>
01840             <span class="comment">// since addresses within these dll's are not always stored per process</span>
01841             <span class="comment">// do not allow these dll's to be relocated</span>
01842             <span class="comment">//</span>
01843 
01844             AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01845             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SystemDll,L<span class="stringliteral">"user32.dll"</span>);
01846             <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;BaseDllName,&amp;SystemDll,TRUE) ) {
01847                 AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01848                 }
01849             <span class="keywordflow">else</span> {
01850                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;SystemDll,L<span class="stringliteral">"kernel32.dll"</span>);
01851                 <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;BaseDllName,&amp;SystemDll,TRUE) ) {
01852                     AllowRelocation = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01853                     }
01854                 }
01855             <span class="keywordflow">if</span> ( !AllowRelocation &amp;&amp; KnownDll ) {
01856 
01857                 <span class="comment">//</span>
01858                 <span class="comment">// totally disallow the relocation since this is a knowndll</span>
01859                 <span class="comment">// that matches our system binaries and is being relocated</span>
01860                 <span class="comment">//</span>
01861 
01862                 <span class="comment">//</span>
01863                 <span class="comment">// Hard Error Time</span>
01864                 <span class="comment">//</span>
01865 
01866                 ErrorParameters[0] = (ULONG_PTR)&amp;SystemDll;
01867                 ErrorParameters[1] = (ULONG_PTR)&amp;CollidingDll;
01868 
01869                 <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
01870                   STATUS_ILLEGAL_DLL_RELOCATION,
01871                   2,
01872                   3,
01873                   ErrorParameters,
01874                   OptionOk,
01875                   &amp;ErrorResponse
01876                   );
01877 
01878                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
01879                     <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
01880                     }
01881 
01882                 st = STATUS_CONFLICTING_ADDRESSES;
01883                 <span class="keywordflow">goto</span> skipreloc;
01884                 }
01885 
01886             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, FALSE, StaticLink );
01887             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01888                 st = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d0/d3/ldrreloc_8c.html#a5">LdrRelocateImage</a>(ViewBase,
01889                             <span class="stringliteral">"LDR"</span>,
01890                             (ULONG)STATUS_SUCCESS,
01891                             (ULONG)STATUS_CONFLICTING_ADDRESSES,
01892                             (ULONG)STATUS_INVALID_IMAGE_FORMAT
01893                             );
01894                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
01895 
01896                     <span class="comment">//</span>
01897                     <span class="comment">// If we did relocations, then map the section again.</span>
01898                     <span class="comment">// this will force the debug event</span>
01899                     <span class="comment">//</span>
01900 
01901                     <span class="comment">//</span>
01902                     <span class="comment">// arrange for debugger to pick up the image name</span>
01903                     <span class="comment">//</span>
01904 
01905                     ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01906                     Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01907                     <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01908                         Section,
01909                         NtCurrentProcess(),
01910                         (PVOID *)&amp;ViewBase,
01911                         0L,
01912                         0L,
01913                         NULL,
01914                         &amp;ViewSize,
01915                         ViewShare,
01916                         0L,
01917                         PAGE_READWRITE
01918                         );
01919                     Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01920 
01921                     st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a57">LdrpSetProtection</a>(ViewBase, TRUE, StaticLink);
01922 
01923                 }
01924             }
01925 skipreloc:
01926             <span class="comment">//</span>
01927             <span class="comment">// if the set protection failed, or if the relocation failed, then</span>
01928             <span class="comment">// remove the partially loaded dll from the lists and clear entry</span>
01929             <span class="comment">// that it has been freed.</span>
01930             <span class="comment">//</span>
01931 
01932             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01933                 RemoveEntryList(&amp;Entry-&gt;InLoadOrderLinks);
01934                 RemoveEntryList(&amp;Entry-&gt;InMemoryOrderLinks);
01935                 RemoveEntryList(&amp;Entry-&gt;HashLinks);
01936                 <a class="code" href="../../d4/d9/umapview_8c.html#a0">NtUnmapViewOfSection</a>(NtCurrentProcess(),ViewBase);
01937                 Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01938                 }
01939 
01940             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01941                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Fixups %successfully re-applied @ %lx\n"</span>,
01942                        <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ? <span class="stringliteral">"s"</span> : <span class="stringliteral">"uns"</span>, ViewBase);
01943             }
01944         } <span class="keywordflow">else</span> {
01945 NoRelocNeeded:
01946                  st = STATUS_SUCCESS;
01947 
01948                  <span class="comment">//</span>
01949                  <span class="comment">// arrange for debugger to pick up the image name</span>
01950                  <span class="comment">//</span>
01951 
01952                  ArbitraryUserPointer = Teb-&gt;NtTib.ArbitraryUserPointer;
01953                  Teb-&gt;NtTib.ArbitraryUserPointer = (PVOID)FullDllName.Buffer;
01954                  <a class="code" href="../../d3/d5/mapview_8c.html#a20">NtMapViewOfSection</a>(
01955                      Section,
01956                      NtCurrentProcess(),
01957                      (PVOID *)&amp;ViewBase,
01958                      0L,
01959                      0L,
01960                      NULL,
01961                      &amp;ViewSize,
01962                      ViewShare,
01963                      0L,
01964                      PAGE_READWRITE
01965                      );
01966                  Teb-&gt;NtTib.ArbitraryUserPointer = ArbitraryUserPointer;
01967 
01968                  <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
01969                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Fixups won't be re-applied to non-Dll @ %lx\n"</span>,
01970                               ViewBase);
01971                  }
01972                }
01973     }
01974 
01975 <span class="preprocessor">#if defined (_ALPHA_)</span>
01976 <span class="preprocessor"></span>
01977     <span class="comment">//</span>
01978     <span class="comment">// Find and apply Alpha architecture fixups for this dll</span>
01979     <span class="comment">//</span>
01980     <span class="keywordflow">if</span> (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL)
01981         AlphaFindArchitectureFixups(NtHeaders, ViewBase, StaticLink);
01982 <span class="preprocessor">#endif</span>
01983 <span class="preprocessor"></span>
01984 <span class="preprocessor">#if defined(_X86_)</span>
01985 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a> &gt; 1 &amp;&amp; Entry &amp;&amp; (Entry-&gt;Flags &amp; LDRP_IMAGE_DLL) ) {
01986         LdrpValidateImageForMp(Entry);
01987         }
01988 <span class="preprocessor">#endif</span>
01989 <span class="preprocessor"></span>    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(Section);
01990     <span class="keywordflow">return</span> st;
01991 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="ldrp.h::LdrpNameToOrdinal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> LdrpNameToOrdinal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfNames</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NameTableBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a22">PUSHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NameOrdinalTableBase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02747">2747</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.
<p>
<pre class="fragment"><div>02754 {
02755     LONG High;
02756     LONG Low;
02757     LONG Middle;
02758     LONG Result;
02759 
02760     <span class="comment">//</span>
02761     <span class="comment">// Lookup the import name in the name table using a binary search.</span>
02762     <span class="comment">//</span>
02763 
02764     Low = 0;
02765     High = NumberOfNames - 1;
02766     <span class="keywordflow">while</span> (High &gt;= Low) {
02767 
02768         <span class="comment">//</span>
02769         <span class="comment">// Compute the next probe index and compare the import name</span>
02770         <span class="comment">// with the export name entry.</span>
02771         <span class="comment">//</span>
02772 
02773         Middle = (Low + High) &gt;&gt; 1;
02774         Result = strcmp(Name, (PCHAR)((ULONG_PTR)DllBase + NameTableBase[Middle]));
02775 
02776         <span class="keywordflow">if</span> (Result &lt; 0) {
02777             High = Middle - 1;
02778 
02779         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Result &gt; 0) {
02780             Low = Middle + 1;
02781 
02782         } <span class="keywordflow">else</span> {
02783             <span class="keywordflow">break</span>;
02784         }
02785     }
02786 
02787     <span class="comment">//</span>
02788     <span class="comment">// If the high index is less than the low index, then a matching</span>
02789     <span class="comment">// table entry was not found. Otherwise, get the ordinal number</span>
02790     <span class="comment">// from the ordinal table.</span>
02791     <span class="comment">//</span>
02792 
02793     <span class="keywordflow">if</span> (High &lt; Low) {
02794         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)-1;
02795     } <span class="keywordflow">else</span> {
02796         <span class="keywordflow">return</span> NameOrdinalTableBase[Middle];
02797     }
02798 
02799 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="ldrp.h::LdrpResolveDllName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN LdrpResolveDllName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FullDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseDllName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DllFile</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">3120</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00460">LDR_TAG</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">LdrpDefaultPath</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02156">RtlDosSearchPath_U()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">TEMP_TAG</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03130                    :
03131 
03132     This function computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL pathname and base dll name (the
03133     unqualified, extensionless portion of the file name) <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
03134     DLL.
03135 
03136 Arguments:
03137 
03138     DllPath - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03139 
03140     DllName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
03141 
03142     FullDllName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fully qualified pathname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03143         DLL. The <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> field of <span class="keyword">this</span> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dynamically
03144         allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes heap.
03145 
03146     BaseDLLName - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base dll name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll.  The base name
03147         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dll <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trailing
03148         <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a>. The <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> field of <span class="keyword">this</span> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> dynamically
03149         allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processes heap.
03150 
03151     DllFile - Returns an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>. This parameter may
03152         still be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> even upon success.
03153 
03154 Return Value:
03155 
03156     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - The operation was successful. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> DLL <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> was found, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03157         FullDllName-&gt;Buffer &amp; BaseDllName-&gt;Buffer field points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03158         base of process heap allocated memory.
03159 
03160     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - The DLL could not be found.
03161 
03162 --*/
03163 
03164 {
03165     ULONG Length;
03166     PWCH p, pp;
03167     PWCH FullBuffer;
03168 
03169     *DllFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03170     FullDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TEMP_TAG ),530+<span class="keyword">sizeof</span>(UNICODE_NULL));
03171     <span class="keywordflow">if</span> (FullDllName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03172         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03173         }
03174 
03175     Length = <a class="code" href="../../d5/d1/curdir_8c.html#a32">RtlDosSearchPath_U</a>(
03176                 ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer,
03177                 DllName,
03178                 NULL,
03179                 530,
03180                 FullDllName-&gt;Buffer,
03181                 &amp;BaseDllName-&gt;Buffer
03182                 );
03183 
03184     <span class="keywordflow">if</span> ( !Length || Length &gt; 530 ) {
03185 
03186         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03187             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: LdrResolveDllName - Unable To Locate "</span>);
03188             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%ws from %ws\n"</span>,
03189                 DllName,
03190                 ARGUMENT_PRESENT(DllPath) ? DllPath : <a class="code" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>.Buffer
03191                 );
03192         }
03193 
03194         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(FullDllName);
03195         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03196     }
03197 
03198     FullDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
03199     FullDllName-&gt;MaximumLength = FullDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03200     FullBuffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ),FullDllName-&gt;MaximumLength);
03201     <span class="keywordflow">if</span> ( FullBuffer ) {
03202         RtlCopyMemory(FullBuffer,FullDllName-&gt;Buffer,FullDllName-&gt;MaximumLength);
03203         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, FullDllName-&gt;Buffer);
03204         FullDllName-&gt;Buffer = FullBuffer;
03205         }
03206     <span class="keywordflow">else</span> {
03207         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03208         }
03209     <span class="comment">//</span>
03210     <span class="comment">// Compute Length of base dll name</span>
03211     <span class="comment">//</span>
03212 
03213     pp = UNICODE_NULL;
03214     p = FullDllName-&gt;Buffer;
03215     <span class="keywordflow">while</span> (*p) {
03216         <span class="keywordflow">if</span> (*p++ == (WCHAR)<span class="charliteral">'\\'</span>) {
03217             pp = p;
03218         }
03219     }
03220 
03221     p = pp ? pp : DllName;
03222     pp = p;
03223 
03224     <span class="keywordflow">while</span> (*p) {
03225         ++p;
03226     }
03227 
03228     BaseDllName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)p - (ULONG_PTR)pp);
03229     BaseDllName-&gt;MaximumLength = BaseDllName-&gt;Length + (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<span class="keyword">sizeof</span>(UNICODE_NULL);
03230     BaseDllName-&gt;Buffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( LDR_TAG ), BaseDllName-&gt;MaximumLength);
03231     <span class="keywordflow">if</span> ( BaseDllName-&gt;Buffer ) {
03232         RtlMoveMemory(BaseDllName-&gt;Buffer,
03233                        pp,
03234                        BaseDllName-&gt;Length
03235                      );
03236 
03237         BaseDllName-&gt;Buffer[BaseDllName-&gt;Length &gt;&gt; 1] = UNICODE_NULL;
03238         }
03239     <span class="keywordflow">else</span> {
03240         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(), 0, FullBuffer);
03241         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03242         }
03243 
03244     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03245 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="ldrp.h::LdrpRunInitializeRoutines" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpRunInitializeRoutines           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT Context&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">652</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00484">LdrpCallInitRoutine</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00622">LdrpClearLoadInProgress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00032">LdrpImageHasTls</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00457">MAKE_TAG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00465">TEMP_TAG</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.
<p>
<pre class="fragment"><div>00655 {
00656     PLIST_ENTRY Head, Next;
00657     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
00658     PLDR_DATA_TABLE_ENTRY *LdrDataTableBase;
00659     PDLL_INIT_ROUTINE InitRoutine;
00660     BOOLEAN InitStatus;
00661     ULONG NumberOfRoutines;
00662     ULONG i;
00663     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00664     ULONG BreakOnDllLoad;
00665 
00666     <span class="comment">//</span>
00667     <span class="comment">// Run the Init routines</span>
00668     <span class="comment">//</span>
00669 
00670     <span class="comment">//</span>
00671     <span class="comment">// capture the entries that have init routines</span>
00672     <span class="comment">//</span>
00673 
00674     NumberOfRoutines = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a42">LdrpClearLoadInProgress</a>();
00675     <span class="keywordflow">if</span> ( NumberOfRoutines ) {
00676         LdrDataTableBase = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(RtlProcessHeap(),<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TEMP_TAG ),NumberOfRoutines*<span class="keyword">sizeof</span>(LdrDataTableBase));
00677         <span class="keywordflow">if</span> ( !LdrDataTableBase ) {
00678             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00679             }
00680         }
00681     <span class="keywordflow">else</span> {
00682         LdrDataTableBase = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00683         }
00684 
00685     Head = &amp;NtCurrentPeb()-&gt;Ldr-&gt;InInitializationOrderModuleList;
00686     Next = Head-&gt;Flink;
00687     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00688         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Real INIT LIST\n"</span>);
00689         }
00690 
00691     i = 0;
00692     <span class="keywordflow">while</span> ( Next != Head ) {
00693         LdrDataTableEntry = CONTAINING_RECORD(Next, LDR_DATA_TABLE_ENTRY, InInitializationOrderLinks);
00694 
00695 <span class="preprocessor">#if defined (WX86)</span>
00696 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Wx86ProcessInit &amp;&amp; !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED)) {
00697             PIMAGE_NT_HEADERS NtHeaders;
00698 
00699             NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase);
00700             <span class="keywordflow">if</span> (NtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386) {
00701                 LdrpWx86DllMapNotify(LdrDataTableEntry-&gt;DllBase, TRUE);
00702             }
00703         }
00704 <span class="preprocessor">#endif</span>
00705 <span class="preprocessor"></span>
00706         <span class="keywordflow">if</span> ( !(LdrDataTableEntry-&gt;Flags &amp; LDRP_ENTRY_PROCESSED) &amp;&amp; LdrDataTableEntry-&gt;EntryPoint) {
00707             LdrDataTableBase[i] = LdrDataTableEntry;
00708             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00709                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     %wZ init routine %x\n"</span>,
00710                         &amp;LdrDataTableEntry-&gt;FullDllName,
00711                         LdrDataTableEntry-&gt;EntryPoint
00712                         );
00713                 }
00714 
00715             i++;
00716             }
00717         LdrDataTableEntry-&gt;Flags |= LDRP_ENTRY_PROCESSED;
00718 
00719         Next = Next-&gt;Flink;
00720         }
00721     <span class="keywordflow">if</span> ( !LdrDataTableBase ) {
00722         <span class="keywordflow">return</span> STATUS_SUCCESS;
00723         }
00724 
00725     <span class="keywordflow">try</span> {
00726         i = 0;
00727         <span class="keywordflow">while</span> ( i &lt; NumberOfRoutines ) {
00728             LdrDataTableEntry = LdrDataTableBase[i];
00729             i++;
00730             InitRoutine = (PDLL_INIT_ROUTINE)LdrDataTableEntry-&gt;EntryPoint;
00731 
00732             <span class="comment">//</span>
00733             <span class="comment">// Walk through the entire list looking for un-processed</span>
00734             <span class="comment">// entries. For each entry, set the processed flag</span>
00735             <span class="comment">// and optionally call it's init routine</span>
00736             <span class="comment">//</span>
00737 
00738             BreakOnDllLoad = 0;
00739 <span class="preprocessor">#if DBG</span>
00740 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00741 <span class="preprocessor">#else</span>
00742 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (NtCurrentPeb()-&gt;BeingDebugged || NtCurrentPeb()-&gt;ReadImageFileExecOptions) {
00743 <span class="preprocessor">#endif</span>
00744 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d2/ldrinit_8c.html#a30">LdrQueryImageFileExecutionOptions</a>( &amp;LdrDataTableEntry-&gt;BaseDllName,
00745                                                             L<span class="stringliteral">"BreakOnDllLoad"</span>,
00746                                                             REG_DWORD,
00747                                                             &amp;BreakOnDllLoad,
00748                                                             <span class="keyword">sizeof</span>( BreakOnDllLoad ),
00749                                                             NULL
00750                                                           );
00751                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00752                     BreakOnDllLoad = 0;
00753                     }
00754                 }
00755 
00756             <span class="keywordflow">if</span> (BreakOnDllLoad) {
00757                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00758                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: %wZ loaded."</span>, &amp;LdrDataTableEntry-&gt;BaseDllName );
00759                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">" - About to call init routine at %lx\n"</span>, InitRoutine );
00760                     }
00761                 DbgBreakPoint();
00762 
00763                 }
00764             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00765                 <span class="keywordflow">if</span> ( InitRoutine ) {
00766                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: %wZ loaded."</span>, &amp;LdrDataTableEntry-&gt;BaseDllName );
00767                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - Calling init routine at %lx\n"</span>, InitRoutine);
00768                     }
00769                 }
00770 
00771             <span class="keywordflow">if</span> ( InitRoutine ) {
00772 
00773                 <span class="comment">//</span>
00774                 <span class="comment">// If the DLL has TLS data, then call the optional initializers</span>
00775                 <span class="comment">//</span>
00776 
00777 
00778 
00779                 <span class="keywordflow">if</span> ( LdrDataTableEntry-&gt;TlsIndex &amp;&amp; Context) {
00780                     <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(LdrDataTableEntry-&gt;DllBase,DLL_PROCESS_ATTACH);
00781                     }
00782 
00783 <span class="preprocessor">#if defined (WX86)</span>
00784 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!Wx86ProcessInit ||
00785                     LdrpRunWx86DllEntryPoint(InitRoutine,
00786                                             &amp;InitStatus,
00787                                             LdrDataTableEntry-&gt;DllBase,
00788                                             DLL_PROCESS_ATTACH,
00789                                             Context
00790                                             ) ==  STATUS_IMAGE_MACHINE_TYPE_MISMATCH)
00791                     {
00792                     InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
00793                                                      LdrDataTableEntry-&gt;DllBase,
00794                                                      DLL_PROCESS_ATTACH,
00795                                                      Context
00796                                                     );
00797                     }
00798 
00799 <span class="preprocessor">#else</span>
00800 <span class="preprocessor"></span>                InitStatus = <a class="code" href="../../d9/d2/ldrp_8h.html#a20">LdrpCallInitRoutine</a>(InitRoutine,
00801                                                  LdrDataTableEntry-&gt;DllBase,
00802                                                  DLL_PROCESS_ATTACH,
00803                                                  Context
00804                                                 );
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>
00807                 LdrDataTableEntry-&gt;Flags |= LDRP_PROCESS_ATTACH_CALLED;
00808 
00809                 <span class="keywordflow">if</span> ( !InitStatus ) {
00810                     <span class="keywordflow">return</span> STATUS_DLL_INIT_FAILED;
00811                     }
00812                 }
00813             }
00814 
00815         <span class="comment">//</span>
00816         <span class="comment">// If the image has tls than call its initializers</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a1">LdrpImageHasTls</a> &amp;&amp; Context ) {
00820             <a class="code" href="../../d9/d2/ldrp_8h.html#a81">LdrpCallTlsInitializers</a>(NtCurrentPeb()-&gt;ImageBaseAddress,DLL_PROCESS_ATTACH);
00821             }
00822 
00823         }
00824     finally {
00825         <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(RtlProcessHeap(),0,LdrDataTableBase);
00826         }
00827 
00828     <span class="keywordflow">return</span> STATUS_SUCCESS;
00829 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="ldrp.h::LdrpSetProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpSetProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Reset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StaticLink</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03417">3417</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.
<p>
<pre class="fragment"><div>03425                    :
03426 
03427     This function loops thru <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> images sections/objects, setting
03428     all sections/objects marked r/o to r/w. It also resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03429     original section/object protections.
03430 
03431 Arguments:
03432 
03433     Base - Base of image.
03434 
03435     Reset - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, reset section/object protection to original
03436             protection described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section/object headers.
03437             If <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, then set all sections/objects to r/w.
03438 
03439     StaticLink - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">static</span> link.
03440 
03441 Return Value:
03442 
03443     SUCCESS or <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a> failed.
03444 
03445 --*/
03446 
03447 {
03448     HANDLE CurrentProcessHandle;
03449     SIZE_T RegionSize;
03450     ULONG NewProtect, OldProtect;
03451     PVOID VirtualAddress;
03452     ULONG i;
03453     PLDR_DATA_TABLE_ENTRY LdrDataTableEntry;
03454     PIMAGE_NT_HEADERS NtHeaders;
03455     PIMAGE_SECTION_HEADER SectionHeader;
03456     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03457 
03458     CurrentProcessHandle = NtCurrentProcess();
03459 
03460     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
03461 
03462 <span class="preprocessor">#if defined (_ALPHA_)</span>
03463 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
03464         <span class="comment">//</span>
03465         <span class="comment">// if SectionAlignment &lt; PAGE_SIZE the entire image is</span>
03466         <span class="comment">// exec-copy on write, so we have nothing to do.</span>
03467         <span class="comment">//</span>
03468         <span class="keywordflow">return</span> STATUS_SUCCESS;
03469         }
03470 <span class="preprocessor">#endif</span>
03471 <span class="preprocessor"></span>
03472     SectionHeader = (PIMAGE_SECTION_HEADER)((ULONG_PTR)NtHeaders + <span class="keyword">sizeof</span>(ULONG) +
03473                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
03474                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
03475                         );
03476 
03477     <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
03478         <span class="keywordflow">if</span> (!(SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_WRITE) &amp;&amp;
03479              (SectionHeader-&gt;SizeOfRawData))
03480          {
03481             <span class="comment">//</span>
03482             <span class="comment">// Object isn't writeable and has a non-zero on disk size, change it.</span>
03483             <span class="comment">//</span>
03484             <span class="keywordflow">if</span> (Reset) {
03485                 <span class="keywordflow">if</span> (SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) {
03486                     NewProtect = PAGE_EXECUTE;
03487                 } <span class="keywordflow">else</span> {
03488                          NewProtect = PAGE_READONLY;
03489                 }
03490                 NewProtect |= (SectionHeader-&gt;Characteristics &amp; IMAGE_SCN_MEM_NOT_CACHED) ? PAGE_NOCACHE : 0;
03491             } <span class="keywordflow">else</span> {
03492                 NewProtect = PAGE_READWRITE;
03493             }
03494             VirtualAddress = (PVOID)((ULONG_PTR)Base + SectionHeader-&gt;VirtualAddress);
03495             RegionSize = SectionHeader-&gt;SizeOfRawData;
03496 
03497             <span class="keywordflow">if</span> (RegionSize != 0) {
03498                 st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>(CurrentProcessHandle, &amp;VirtualAddress,
03499                               &amp;RegionSize, NewProtect, &amp;OldProtect);
03500 
03501                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
03502                     <span class="keywordflow">return</span> st;
03503                 }
03504             }
03505 
03506         }
03507         ++SectionHeader;
03508     }
03509 
03510     <span class="keywordflow">if</span> (Reset) {
03511         <a class="code" href="../../d5/d5/flushbuf_8c.html#a2">NtFlushInstructionCache</a>(NtCurrentProcess(), NULL, 0);
03512     }
03513     <span class="keywordflow">return</span> STATUS_SUCCESS;
03514 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="ldrp.h::LdrpSnapIAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpSnapIAT           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry_Export</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry_Import</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_IMPORT_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>ImportDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SnapForwardersOnly</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02258">2258</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d4/flushbuf_8c-source.html#l00142">NtFlushInstructionCache()</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">LdrpWalkImportDescriptor()</a>.
<p>
<pre class="fragment"><div>02267                    :
02268 
02269     This function snaps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Import Address Table <span class="keywordflow">for</span> <span class="keyword">this</span>
02270     Import Descriptor.
02271 
02272 Arguments:
02273 
02274     LdrDataTableEntry_Export - Information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to <span class="keyword">import</span> from.
02275 
02276     LdrDataTableEntry_Import - Information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image to <span class="keyword">import</span> to.
02277 
02278     ImportDescriptor - Contains a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IAT to snap.
02279 
02280     SnapForwardersOnly - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> just snapping forwarders <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
02281 
02282 Return Value:
02283 
02284     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
02285 
02286 --*/
02287 
02288 {
02289     PPEB Peb;
02290     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02291     ULONG ExportSize;
02292     PIMAGE_EXPORT_DIRECTORY ExportDirectory;
02293     PIMAGE_THUNK_DATA Thunk, OriginalThunk;
02294     PSZ ImportName;
02295     ULONG ForwarderChain;
02296     PIMAGE_NT_HEADERS NtHeaders;
02297     PIMAGE_SECTION_HEADER NtSection;
02298     ULONG i, Rva;
02299     PVOID IATBase;
02300     SIZE_T IATSize;
02301     ULONG LittleIATSize;
02302     ULONG OldProtect;
02303 
02304     Peb = NtCurrentPeb();
02305 
02306     ExportDirectory = (PIMAGE_EXPORT_DIRECTORY)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02307                        LdrDataTableEntry_Export-&gt;DllBase,
02308                        TRUE,
02309                        IMAGE_DIRECTORY_ENTRY_EXPORT,
02310                        &amp;ExportSize
02311                        );
02312 
02313     <span class="keywordflow">if</span> (!ExportDirectory) {
02314         KdPrint((<span class="stringliteral">"LDR: %wZ doesn't contain an EXPORT table\n"</span>, &amp;LdrDataTableEntry_Export-&gt;BaseDllName));
02315         <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
02316         }
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// Determine the location and size of the IAT.  If the linker did</span>
02320     <span class="comment">// not tell use explicitly, then use the location and size of the</span>
02321     <span class="comment">// image section that contains the import table.</span>
02322     <span class="comment">//</span>
02323 
02324     IATBase = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( LdrDataTableEntry_Import-&gt;DllBase,
02325                                             TRUE,
02326                                             IMAGE_DIRECTORY_ENTRY_IAT,
02327                                             &amp;LittleIATSize
02328                                           );
02329     IATSize = LittleIATSize;
02330     <span class="keywordflow">if</span> (IATBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02331         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( LdrDataTableEntry_Import-&gt;DllBase );
02332         NtSection = IMAGE_FIRST_SECTION( NtHeaders );
02333         Rva = NtHeaders-&gt;OptionalHeader.DataDirectory[ IMAGE_DIRECTORY_ENTRY_IMPORT ].VirtualAddress;
02334         <span class="keywordflow">if</span> (Rva != 0) {
02335             <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
02336                 <span class="keywordflow">if</span> (Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
02337                     Rva &lt; (NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData)
02338                    ) {
02339                     IATBase = (PVOID)
02340                         ((ULONG_PTR)(LdrDataTableEntry_Import-&gt;DllBase) + NtSection-&gt;VirtualAddress);
02341 
02342                     LittleIATSize = NtSection-&gt;Misc.VirtualSize;
02343                     <span class="keywordflow">if</span> (LittleIATSize == 0) {
02344                         LittleIATSize = NtSection-&gt;SizeOfRawData;
02345                         }
02346                     <span class="keywordflow">break</span>;
02347                     }
02348 
02349                 ++NtSection;
02350                 }
02351             }
02352 
02353         <span class="keywordflow">if</span> (IATBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02354             KdPrint(( <span class="stringliteral">"LDR: Unable to unprotect IAT for %wZ (Image Base %x)\n"</span>,
02355                       &amp;LdrDataTableEntry_Import-&gt;BaseDllName,
02356                       LdrDataTableEntry_Import-&gt;DllBase
02357                    ));
02358             <span class="keywordflow">return</span> STATUS_INVALID_IMAGE_FORMAT;
02359             }
02360         IATSize = LittleIATSize;
02361         }
02362 
02363     st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
02364                                  &amp;IATBase,
02365                                  &amp;IATSize,
02366                                  PAGE_READWRITE,
02367                                  &amp;OldProtect
02368                                );
02369     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02370         KdPrint(( <span class="stringliteral">"LDR: Unable to unprotect IAT for %wZ (Status %x)\n"</span>,
02371                   &amp;LdrDataTableEntry_Import-&gt;BaseDllName,
02372                   st
02373                ));
02374         <span class="keywordflow">return</span> st;
02375         }
02376 
02377     <span class="comment">//</span>
02378     <span class="comment">// If just snapping forwarded entries, walk that list</span>
02379     <span class="comment">//</span>
02380     <span class="keywordflow">if</span> (SnapForwardersOnly) {
02381         ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;Name);
02382         ForwarderChain = ImportDescriptor-&gt;ForwarderChain;
02383         <span class="keywordflow">while</span> (ForwarderChain != -1) {
02384             OriginalThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02385                             ImportDescriptor-&gt;OriginalFirstThunk +
02386                             (ForwarderChain * <span class="keyword">sizeof</span>(IMAGE_THUNK_DATA)));
02387             Thunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02388                             ImportDescriptor-&gt;FirstThunk +
02389                             (ForwarderChain * <span class="keyword">sizeof</span>(IMAGE_THUNK_DATA)));
02390             ForwarderChain = (ULONG) Thunk-&gt;u1.Ordinal;
02391             <span class="keywordflow">try</span> {
02392                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry_Export-&gt;DllBase,
02393                         LdrDataTableEntry_Import-&gt;DllBase,
02394                         OriginalThunk,
02395                         Thunk,
02396                         ExportDirectory,
02397                         ExportSize,
02398                         TRUE,
02399                         ImportName
02400                         );
02401                 Thunk++;
02402                 }
02403             except (EXCEPTION_EXECUTE_HANDLER) {
02404                 st = GetExceptionCode();
02405                 }
02406             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02407                 <span class="keywordflow">break</span>;
02408                 }
02409             }
02410         }
02411     <span class="keywordflow">else</span>
02412 
02413     <span class="comment">//</span>
02414     <span class="comment">// Otherwise, walk through the IAT and snap all the thunks.</span>
02415     <span class="comment">//</span>
02416 
02417     <span class="keywordflow">if</span> ( ImportDescriptor-&gt;FirstThunk ) {
02418         Thunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
02419 
02420         NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>( LdrDataTableEntry_Import-&gt;DllBase );
02421         <span class="comment">//</span>
02422         <span class="comment">// If the OriginalFirstThunk field does not point inside the image, then ignore</span>
02423         <span class="comment">// it.  This is will detect bogus Borland Linker 2.25 images that did not fill</span>
02424         <span class="comment">// this field in.</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> (ImportDescriptor-&gt;Characteristics &lt; NtHeaders-&gt;OptionalHeader.SizeOfHeaders ||
02428             ImportDescriptor-&gt;Characteristics &gt;= NtHeaders-&gt;OptionalHeader.SizeOfImage
02429            ) {
02430             OriginalThunk = Thunk;
02431         } <span class="keywordflow">else</span> {
02432             OriginalThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase +
02433                             ImportDescriptor-&gt;OriginalFirstThunk);
02434         }
02435         ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry_Import-&gt;DllBase + ImportDescriptor-&gt;Name);
02436         <span class="keywordflow">while</span> (OriginalThunk-&gt;u1.AddressOfData) {
02437             <span class="keywordflow">try</span> {
02438                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a49">LdrpSnapThunk</a>(LdrDataTableEntry_Export-&gt;DllBase,
02439                         LdrDataTableEntry_Import-&gt;DllBase,
02440                         OriginalThunk,
02441                         Thunk,
02442                         ExportDirectory,
02443                         ExportSize,
02444                         TRUE,
02445                         ImportName
02446                         );
02447                 OriginalThunk++;
02448                 Thunk++;
02449                 }
02450             except (EXCEPTION_EXECUTE_HANDLER) {
02451                 st = GetExceptionCode();
02452                 }
02453 
02454             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02455                 <span class="keywordflow">break</span>;
02456                 }
02457             }
02458         }
02459 
02460     <span class="comment">//</span>
02461     <span class="comment">// Restore protection for IAT and flush instruction cache.</span>
02462     <span class="comment">//</span>
02463 
02464     <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
02465                             &amp;IATBase,
02466                             &amp;IATSize,
02467                             OldProtect,
02468                             &amp;OldProtect
02469                           );
02470     <a class="code" href="../../d5/d5/flushbuf_8c.html#a2">NtFlushInstructionCache</a>( NtCurrentProcess(), IATBase, LittleIATSize );
02471 
02472     <span class="keywordflow">return</span> st;
02473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="ldrp.h::LdrpSnapLinksToDllHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpSnapLinksToDllHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfThunks</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIMAGE_THUNK_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstThunk</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="ldrp.h::LdrpSnapThunk" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpSnapThunk           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DllBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ImageBase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_THUNK_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>OriginalThunk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIMAGE_THUNK_DATA&nbsp;</td>
          <td class="mdname" nowrap> <em>Thunk</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_EXPORT_DIRECTORY&nbsp;</td>
          <td class="mdname" nowrap> <em>ExportDirectory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ExportSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StaticSnap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSZ DllName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">2476</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00166">LDRP_BAD_DLL</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00386">LdrpFatalHardErrorCount</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00035">LdrpInLdrInit</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02747">LdrpNameToOrdinal()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00532">NtRaiseHardError()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d0/d3/cnvint_8c-source.html#l00121">RtlCharToInteger()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02258">LdrpSnapIAT()</a>.
<p>
<pre class="fragment"><div>02489                    :
02490 
02491     This function snaps a thunk <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Export Section data.
02492     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section data does not support <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02493     partially snapped (Dll field is still non-null, but snap address is
02494     set).
02495 
02496 Arguments:
02497 
02498     DllBase - Base of Dll.
02499 
02500     ImageBase - Base of image that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunks to snap.
02501 
02502     Thunk - On input, supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thunk to snap.  When successfully
02503         snapped, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in
02504         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.
02505 
02506     ExportDirectory - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Export Section data from a DLL.
02507 
02508     StaticSnap - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, then loader <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attempting a <span class="keyword">static</span> snap,
02509                  and any ordinal/name lookup <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> will be reported.
02510 
02511 Return Value:
02512 
02513     STATUS_SUCCESS or STATUS_PROCEDURE_NOT_FOUND
02514 
02515 --*/
02516 
02517 {
02518     BOOLEAN Ordinal;
02519     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> OrdinalNumber;
02520     ULONG OriginalOrdinalNumber;
02521     PIMAGE_IMPORT_BY_NAME AddressOfData;
02522     PULONG NameTableBase;
02523     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a> NameOrdinalTableBase;
02524     PULONG Addr;
02525     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> HintIndex;
02526     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02527     PSZ ImportString;
02528 
02529     <span class="comment">//</span>
02530     <span class="comment">// Determine if snap is by name, or by ordinal</span>
02531     <span class="comment">//</span>
02532 
02533     Ordinal = (BOOLEAN)IMAGE_SNAP_BY_ORDINAL(OriginalThunk-&gt;u1.Ordinal);
02534 
02535     <span class="keywordflow">if</span> (Ordinal) {
02536         OriginalOrdinalNumber = (ULONG)IMAGE_ORDINAL(OriginalThunk-&gt;u1.Ordinal);
02537         OrdinalNumber = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(OriginalOrdinalNumber - ExportDirectory-&gt;Base);
02538     } <span class="keywordflow">else</span> {
02539              <span class="comment">//</span>
02540              <span class="comment">// Change AddressOfData from an RVA to a VA.</span>
02541              <span class="comment">//</span>
02542 
02543              AddressOfData = (PIMAGE_IMPORT_BY_NAME)((ULONG_PTR)ImageBase + ((ULONG_PTR)OriginalThunk-&gt;u1.AddressOfData &amp; 0xffffffff));
02544              ImportString = (PSZ)AddressOfData-&gt;Name;
02545 
02546              <span class="comment">//</span>
02547              <span class="comment">// Lookup Name in NameTable</span>
02548              <span class="comment">//</span>
02549 
02550              NameTableBase = (PULONG)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNames);
02551              NameOrdinalTableBase = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfNameOrdinals);
02552 
02553              <span class="comment">//</span>
02554              <span class="comment">// Before dropping into binary search, see if</span>
02555              <span class="comment">// the hint index results in a successful</span>
02556              <span class="comment">// match. If the hint index is zero, then</span>
02557              <span class="comment">// drop into binary search.</span>
02558              <span class="comment">//</span>
02559 
02560              HintIndex = AddressOfData-&gt;Hint;
02561              <span class="keywordflow">if</span> ((ULONG)HintIndex &lt; ExportDirectory-&gt;NumberOfNames &amp;&amp;
02562                  !strcmp(ImportString, (PSZ)((ULONG_PTR)DllBase + NameTableBase[HintIndex]))) {
02563                  OrdinalNumber = NameOrdinalTableBase[HintIndex];
02564 <span class="preprocessor">#if LDRDBG</span>
02565 <span class="preprocessor"></span>                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02566                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snapping %s\n"</span>, ImportString);
02567                  }
02568 <span class="preprocessor">#endif</span>
02569 <span class="preprocessor"></span>             } <span class="keywordflow">else</span> {
02570 <span class="preprocessor">#if LDRDBG</span>
02571 <span class="preprocessor"></span>                      <span class="keywordflow">if</span> (HintIndex) {
02572                           <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Warning HintIndex Failure. Name %s (%lx) Hint 0x%lx\n"</span>,
02573                               ImportString,
02574                               (ULONG)ImportString,
02575                               (ULONG)HintIndex
02576                               );
02577                       }
02578 <span class="preprocessor">#endif</span>
02579 <span class="preprocessor"></span>                      OrdinalNumber = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a50">LdrpNameToOrdinal</a>(
02580                                         ImportString,
02581                                         ExportDirectory-&gt;NumberOfNames,
02582                                         DllBase,
02583                                         NameTableBase,
02584                                         NameOrdinalTableBase
02585                                         );
02586                     }
02587            }
02588 
02589     <span class="comment">//</span>
02590     <span class="comment">// If OrdinalNumber is not within the Export Address Table,</span>
02591     <span class="comment">// then DLL does not implement function. Snap to LDRP_BAD_DLL.</span>
02592     <span class="comment">//</span>
02593 
02594     <span class="keywordflow">if</span> ((ULONG)OrdinalNumber &gt;= ExportDirectory-&gt;NumberOfFunctions) {
02595 baddllref:
02596 <span class="preprocessor">#if DBG</span>
02597 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (StaticSnap) {
02598             <span class="keywordflow">if</span> (Ordinal) {
02599                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Can't locate ordinal 0x%lx\n"</span>, OriginalOrdinalNumber);
02600                 }
02601             <span class="keywordflow">else</span> {
02602                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Can't locate %s\n"</span>, ImportString);
02603                 }
02604         }
02605 <span class="preprocessor">#endif</span>
02606 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( StaticSnap ) {
02607             <span class="comment">//</span>
02608             <span class="comment">// Hard Error Time</span>
02609             <span class="comment">//</span>
02610 
02611             ULONG_PTR ErrorParameters[3];
02612             UNICODE_STRING ErrorDllName, ErrorEntryPointName;
02613             ANSI_STRING AnsiScratch;
02614             ULONG ParameterStringMask;
02615             ULONG ErrorResponse;
02616 
02617             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiScratch,DllName ? DllName : <span class="stringliteral">"Unknown"</span>);
02618             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ErrorDllName,&amp;AnsiScratch,TRUE);
02619             ErrorParameters[1] = (ULONG_PTR)&amp;ErrorDllName;
02620             ParameterStringMask = 2;
02621 
02622             <span class="keywordflow">if</span> ( Ordinal ) {
02623                 ErrorParameters[0] = OriginalOrdinalNumber;
02624                 }
02625             <span class="keywordflow">else</span> {
02626                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiScratch,ImportString);
02627                 <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;ErrorEntryPointName,&amp;AnsiScratch,TRUE);
02628                 ErrorParameters[0] = (ULONG_PTR)&amp;ErrorEntryPointName;
02629                 ParameterStringMask = 3;
02630                 }
02631 
02632 
02633             <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a11">NtRaiseHardError</a>(
02634               Ordinal ? STATUS_ORDINAL_NOT_FOUND : STATUS_ENTRYPOINT_NOT_FOUND,
02635               2,
02636               ParameterStringMask,
02637               ErrorParameters,
02638               OptionOk,
02639               &amp;ErrorResponse
02640               );
02641 
02642             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d2/ldrinit_8c.html#a4">LdrpInLdrInit</a> ) {
02643                 <a class="code" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>++;
02644                 }
02645             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ErrorDllName);
02646             <span class="keywordflow">if</span> ( !Ordinal ) {
02647                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ErrorEntryPointName);
02648                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_ENTRYPOINT_NOT_FOUND);
02649                 }
02650             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_ORDINAL_NOT_FOUND);
02651             }
02652         Thunk-&gt;u1.Function = (ULONG_PTR)<a class="code" href="../../d9/d2/ldrp_8h.html#a8">LDRP_BAD_DLL</a>;
02653         st = Ordinal ? STATUS_ORDINAL_NOT_FOUND : STATUS_ENTRYPOINT_NOT_FOUND;
02654     } <span class="keywordflow">else</span> {
02655              Addr = (PULONG)((ULONG_PTR)DllBase + (ULONG)ExportDirectory-&gt;AddressOfFunctions);
02656              Thunk-&gt;u1.Function = ((ULONG_PTR)DllBase + Addr[OrdinalNumber]);
02657              <span class="keywordflow">if</span> (Thunk-&gt;u1.Function &gt; (ULONG_PTR)ExportDirectory &amp;&amp;
02658                  Thunk-&gt;u1.Function &lt; ((ULONG_PTR)ExportDirectory + ExportSize)
02659                 ) {
02660                 UNICODE_STRING UnicodeString;
02661                 ANSI_STRING ForwardDllName;
02662                 PVOID ForwardDllHandle;
02663                 PUNICODE_STRING ForwardProcName;
02664                 ULONG ForwardProcOrdinal;
02665 
02666                 ImportString = (PSZ)Thunk-&gt;u1.Function;
02667                 ForwardDllName.Buffer = ImportString,
02668                 ForwardDllName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(strchr(ImportString, <span class="charliteral">'.'</span>) - ImportString);
02669                 ForwardDllName.MaximumLength = ForwardDllName.Length;
02670                 st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeString, &amp;ForwardDllName, TRUE);
02671 
02672                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02673 <span class="preprocessor">#if defined (WX86)</span>
02674 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Wx86ProcessInit) {
02675                         NtCurrentTeb()-&gt;Wx86Thread.UseKnownWx86Dll = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase)-&gt;FileHeader.Machine
02676                                                    == IMAGE_FILE_MACHINE_I386;
02677 
02678                         }
02679 <span class="preprocessor">#endif</span>
02680 <span class="preprocessor"></span>
02681 
02682                         st = <a class="code" href="../../d9/d2/ldrp_8h.html#a82">LdrpLoadDll</a>(NULL, NULL, &amp;UnicodeString, &amp;ForwardDllHandle,FALSE);
02683                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeString);
02684                     }
02685 
02686                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02687                     <span class="keywordflow">goto</span> baddllref;
02688                     }
02689 
02690                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;ForwardDllName,
02691                                    ImportString + ForwardDllName.Length + 1
02692                                  );
02693                 <span class="keywordflow">if</span> (ForwardDllName.Length &gt; 1 &amp;&amp;
02694                     *ForwardDllName.Buffer == <span class="charliteral">'#'</span>
02695                    ) {
02696                     ForwardProcName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02697                     st = <a class="code" href="../../d9/d3/cnvint_8c.html#a3">RtlCharToInteger</a>( ForwardDllName.Buffer+1,
02698                                            0,
02699                                            &amp;ForwardProcOrdinal
02700                                          );
02701                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02702                         <span class="keywordflow">goto</span> baddllref;
02703                         }
02704                     }
02705                 <span class="keywordflow">else</span> {
02706                     ForwardProcName = (PUNICODE_STRING)&amp;ForwardDllName;
02707 
02708                     <span class="comment">//</span>
02709                     <span class="comment">// Following line is not needed since this is a by name lookup</span>
02710                     <span class="comment">//</span>
02711                     <span class="comment">//</span>
02712                     <span class="comment">//ForwardProcOrdinal = (ULONG)&amp;ForwardDllName;</span>
02713                     <span class="comment">//</span>
02714                     }
02715 
02716                 st = <a class="code" href="../../d9/d2/ldrp_8h.html#a83">LdrpGetProcedureAddress</a>( ForwardDllHandle,
02717                                               (PANSI_STRING )ForwardProcName,
02718                                               ForwardProcOrdinal,
02719                                               &amp;(PVOID)Thunk-&gt;u1.Function,
02720                                               FALSE
02721                                             );
02722                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02723                     <span class="keywordflow">goto</span> baddllref;
02724                     }
02725                 }
02726              <span class="keywordflow">else</span> {
02727                 <span class="keywordflow">if</span> ( !Addr[OrdinalNumber] ) {
02728                     <span class="keywordflow">goto</span> baddllref;
02729                     }
02730 <span class="preprocessor">#if defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
02731 <span class="preprocessor"></span>                <span class="keywordflow">else</span> {
02732                    PIMAGE_NT_HEADERS ExportNtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DllBase);
02733 
02734                    <span class="keywordflow">if</span> ((ExportNtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
02735                        (ExportNtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386)) {
02736                        Thunk-&gt;u1.Function += LdrpWx86RelocatedFixupDiff(DllBase, Addr[OrdinalNumber]);
02737                     }
02738                 }
02739 <span class="preprocessor">#endif //  defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
02740 <span class="preprocessor"></span>             }
02741              st = STATUS_SUCCESS;
02742            }
02743     <span class="keywordflow">return</span> st;
02744 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="ldrp.h::LdrpUpdateLoadCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LdrpUpdateLoadCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IncrementCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02802">2802</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02809                    :
02810 
02811     This function dereferences a loaded DLL adjusting its reference
02812     count.  It then dereferences each dll referenced by <span class="keyword">this</span> dll.
02813 
02814 Arguments:
02815 
02816     LdrDataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL to dereference
02817 
02818     IncrementCount - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> adding one to LoadCount, O.W. subtracting one
02819 
02820 Return Value:
02821 
02822     None.
02823 
02824 --*/
02825 
02826 {
02827     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
02828     PIMAGE_BOUND_IMPORT_DESCRIPTOR NewImportDescriptor;
02829     PIMAGE_BOUND_FORWARDER_REF NewImportForwarder;
02830     PSZ ImportName, NewImportStringBase;
02831     ULONG i, ImportSize, NewImportSize;
02832     ANSI_STRING AnsiString;
02833     PUNICODE_STRING ImportDescriptorName_U;
02834     PLDR_DATA_TABLE_ENTRY Entry;
02835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02836     BOOLEAN Wx86KnownDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02837     PIMAGE_THUNK_DATA FirstThunk;
02838 
02839     <span class="keywordflow">if</span> (IncrementCount)
02840         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_LOAD_IN_PROGRESS) {
02841             <span class="keywordflow">return</span>;
02842         } <span class="keywordflow">else</span> {
02843             LdrDataTableEntry-&gt;Flags |= LDRP_LOAD_IN_PROGRESS;
02844         }
02845     <span class="keywordflow">else</span>
02846         <span class="keywordflow">if</span> (LdrDataTableEntry-&gt;Flags &amp; LDRP_UNLOAD_IN_PROGRESS) {
02847             <span class="keywordflow">return</span>;
02848         } <span class="keywordflow">else</span> {
02849             LdrDataTableEntry-&gt;Flags |= LDRP_UNLOAD_IN_PROGRESS;
02850         }
02851 
02852     <span class="comment">//</span>
02853     <span class="comment">// For each DLL used by this DLL, reference or dereference the DLL.</span>
02854     <span class="comment">//</span>
02855 
02856     ImportDescriptorName_U = &amp;NtCurrentTeb()-&gt;StaticUnicodeString;
02857 
02858 <span class="preprocessor">#if defined (WX86)</span>
02859 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wx86ProcessInit) {
02860         Wx86KnownDll = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase)-&gt;FileHeader.Machine
02861                            == IMAGE_FILE_MACHINE_I386;
02862         }
02863 <span class="preprocessor">#endif</span>
02864 <span class="preprocessor"></span>
02865 
02866 
02867 
02868     <span class="comment">//</span>
02869     <span class="comment">// See if there is a bound import table.  If so, walk that to</span>
02870     <span class="comment">// determine DLL names to reference or dereference.  Avoids touching</span>
02871     <span class="comment">// the .idata section</span>
02872     <span class="comment">//</span>
02873     NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02874                            LdrDataTableEntry-&gt;DllBase,
02875                            TRUE,
02876                            IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT,
02877                            &amp;NewImportSize
02878                            );
02879     <span class="keywordflow">if</span> (NewImportDescriptor) {
02880         <span class="keywordflow">if</span> (IncrementCount) {
02881             LdrDataTableEntry-&gt;Flags |= LDRP_LOAD_IN_PROGRESS;
02882         } <span class="keywordflow">else</span> {
02883             LdrDataTableEntry-&gt;Flags |= LDRP_UNLOAD_IN_PROGRESS;
02884         }
02885 
02886         NewImportStringBase = (LPSTR)NewImportDescriptor;
02887         <span class="keywordflow">while</span> (NewImportDescriptor-&gt;OffsetModuleName) {
02888             ImportName = NewImportStringBase +
02889                          NewImportDescriptor-&gt;OffsetModuleName;
02890             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
02891             st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, FALSE);
02892             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02893                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( NULL,
02894                                            ImportDescriptorName_U,
02895                                            TRUE,
02896                                            Wx86KnownDll,
02897                                            &amp;Entry
02898                                          )
02899                    ) {
02900                     <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
02901                         <span class="keywordflow">if</span> (IncrementCount) {
02902                             Entry-&gt;LoadCount++;
02903 
02904                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02905                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
02906                                         ImportDescriptorName_U,
02907                                         (ULONG)Entry-&gt;LoadCount
02908                                         );
02909                             }
02910                         } <span class="keywordflow">else</span> {
02911                             Entry-&gt;LoadCount--;
02912 
02913                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02914                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
02915                                         ImportDescriptorName_U,
02916                                         (ULONG)Entry-&gt;LoadCount
02917                                         );
02918                             }
02919                         }
02920                     }
02921                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
02922                 }
02923             }
02924 
02925             NewImportForwarder = (PIMAGE_BOUND_FORWARDER_REF)(NewImportDescriptor+1);
02926             <span class="keywordflow">for</span> (i=0; i&lt;NewImportDescriptor-&gt;NumberOfModuleForwarderRefs; i++) {
02927                 ImportName = NewImportStringBase +
02928                              NewImportForwarder-&gt;OffsetModuleName;
02929 
02930                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
02931                 st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, FALSE);
02932                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02933                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( NULL,
02934                                                ImportDescriptorName_U,
02935                                                TRUE,
02936                                                Wx86KnownDll,
02937                                                &amp;Entry
02938                                              )
02939                        ) {
02940                         <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
02941                             <span class="keywordflow">if</span> (IncrementCount) {
02942                                 Entry-&gt;LoadCount++;
02943 
02944                                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02945                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
02946                                             ImportDescriptorName_U,
02947                                             (ULONG)Entry-&gt;LoadCount
02948                                             );
02949                                 }
02950                             } <span class="keywordflow">else</span> {
02951                                 Entry-&gt;LoadCount--;
02952 
02953                                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
02954                                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
02955                                             ImportDescriptorName_U,
02956                                             (ULONG)Entry-&gt;LoadCount
02957                                             );
02958                                 }
02959                             }
02960                         }
02961                         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
02962                     }
02963                 }
02964 
02965                 NewImportForwarder += 1;
02966             }
02967 
02968             NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)NewImportForwarder;
02969         }
02970 
02971         <span class="keywordflow">return</span>;
02972     }
02973 
02974     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
02975                         LdrDataTableEntry-&gt;DllBase,
02976                         TRUE,
02977                         IMAGE_DIRECTORY_ENTRY_IMPORT,
02978                         &amp;ImportSize
02979                         );
02980     <span class="keywordflow">if</span> (ImportDescriptor) {
02981 
02982         <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;FirstThunk) {
02983 
02984             <span class="comment">//</span>
02985             <span class="comment">// Match code in walk that skips references like this. IE3 had</span>
02986             <span class="comment">// some dll's with these bogus links to url.dll. On load, the url.dll</span>
02987             <span class="comment">// ref was skipped. On unload, it was not skipped because</span>
02988             <span class="comment">// this code was missing.</span>
02989             <span class="comment">//</span>
02990             <span class="comment">// Since the skip logic is only in the old style import</span>
02991             <span class="comment">// descriptor path, it is only duplicated here.</span>
02992             <span class="comment">//</span>
02993             <span class="comment">// check for import that has no references</span>
02994             <span class="comment">//</span>
02995             FirstThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
02996             <span class="keywordflow">if</span> ( !FirstThunk-&gt;u1.Function ) {
02997                 <span class="keywordflow">goto</span> skipskippedimport;
02998                 }
02999 
03000             ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
03001 
03002             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;AnsiString, ImportName);
03003             st = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(ImportDescriptorName_U, &amp;AnsiString, FALSE);
03004             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03005                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d3/ldrsnap_8c.html#a44">LdrpCheckForLoadedDll</a>( NULL,
03006                                            ImportDescriptorName_U,
03007                                            TRUE,
03008                                            Wx86KnownDll,
03009                                            &amp;Entry
03010                                          )
03011                    ) {
03012                     <span class="keywordflow">if</span> ( Entry-&gt;LoadCount != 0xffff ) {
03013                         <span class="keywordflow">if</span> (IncrementCount) {
03014                             Entry-&gt;LoadCount++;
03015 
03016                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03017                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Refcount   %wZ (%lx)\n"</span>,
03018                                         ImportDescriptorName_U,
03019                                         (ULONG)Entry-&gt;LoadCount
03020                                         );
03021                             }
03022                         } <span class="keywordflow">else</span> {
03023                             Entry-&gt;LoadCount--;
03024 
03025                             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
03026                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Derefcount   %wZ (%lx)\n"</span>,
03027                                         ImportDescriptorName_U,
03028                                         (ULONG)Entry-&gt;LoadCount
03029                                         );
03030                             }
03031                         }
03032                     }
03033                     <a class="code" href="../../d2/d3/ldrsnap_8c.html#a51">LdrpUpdateLoadCount</a>(Entry, IncrementCount);
03034                 }
03035             }
03036 skipskippedimport:
03037             ++ImportDescriptor;
03038         }
03039     }
03040 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="ldrp.h::LdrpWalkImportDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LdrpWalkImportDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR DllPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLDR_DATA_TABLE_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>LdrDataTableEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">214</a> of file <a class="el" href="../../d3/d2/ldrsnap_8c-source.html">ldrsnap.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/heaptag_8c-source.html#l00191">LdrpDefineDllTag()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03970">LdrpDphInitializeTargetDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00140">LdrpLoadImportModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02258">LdrpSnapIAT()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d8/protect_8c-source.html#l00069">NtProtectVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">ShowSnaps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00221                    :
00222 
00223     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a recursive routine which walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Import Descriptor
00224     Table and loads each DLL that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> referenced.
00225 
00226 Arguments:
00227 
00228     DllPath - Supplies an optional search <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to be used to locate
00229         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DLL.
00230 
00231     LdrDataTableEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data table entry
00232         to initialize.
00233 
00234 Return Value:
00235 
00236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value.
00237 
00238 --*/
00239 
00240 {
00241     ULONG i, ImportSize, NewImportSize;
00242     BOOLEAN AlreadyLoaded, SnapForwardersOnly, StaleBinding;
00243     PLDR_DATA_TABLE_ENTRY DataTableEntry, FwdDataTableEntry;
00244     PIMAGE_IMPORT_DESCRIPTOR ImportDescriptor;
00245     PIMAGE_BOUND_IMPORT_DESCRIPTOR NewImportDescriptor;
00246     PIMAGE_BOUND_FORWARDER_REF NewImportForwarder;
00247     PSZ ImportName, NewImportName, NewFwdImportName, NewImportStringBase;
00248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00249     PIMAGE_NT_HEADERS ExportNtHeaders;
00250     PVOID ImportBase;
00251     ULONG RegionSize;
00252     PIMAGE_THUNK_DATA Thunk,<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00253     PIMAGE_THUNK_DATA FirstThunk;
00254     PPEB Peb = NtCurrentPeb();
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">// See if there is a bound import table.  If so, walk that to</span>
00258     <span class="comment">// verify if the binding is good.  If so, then succeed with</span>
00259     <span class="comment">// having touched the .idata section, as all the information</span>
00260     <span class="comment">// in the bound imports table is stored in the header.  If any</span>
00261     <span class="comment">// are stale, then fall out into the unbound case.</span>
00262     <span class="comment">//</span>
00263     NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00264                            LdrDataTableEntry-&gt;DllBase,
00265                            TRUE,
00266                            IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT,
00267                            &amp;NewImportSize
00268                            );
00269 
00270     ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00271                         LdrDataTableEntry-&gt;DllBase,
00272                         TRUE,
00273                         IMAGE_DIRECTORY_ENTRY_IMPORT,
00274                         &amp;ImportSize
00275                         );
00276 
00277 
00278     <span class="keywordflow">if</span> (NewImportDescriptor) {
00279         NewImportStringBase = (LPSTR)NewImportDescriptor;
00280         <span class="keywordflow">while</span> (NewImportDescriptor-&gt;OffsetModuleName) {
00281             NewImportName = NewImportStringBase +
00282                          NewImportDescriptor-&gt;OffsetModuleName;
00283 
00284             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00285                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ bound to %s\n"</span>,
00286                     &amp;LdrDataTableEntry-&gt;BaseDllName,
00287                     NewImportName
00288                     );
00289             }
00290 
00291             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00292                                        NewImportName,
00293                                        LdrDataTableEntry-&gt;DllBase,
00294                                        &amp;DataTableEntry,
00295                                        &amp;AlreadyLoaded
00296                                        );
00297             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00298                 <span class="keywordflow">return</span> st;
00299             }
00300 
00301             <span class="comment">//</span>
00302             <span class="comment">// Add to initialization list.</span>
00303             <span class="comment">//</span>
00304 
00305             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00306                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00307                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00308             }
00309 
00310 <span class="preprocessor">#if defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00311 <span class="preprocessor"></span>            ExportNtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(LdrDataTableEntry-&gt;DllBase);
00312 
00313             <span class="keywordflow">if</span> ((ExportNtHeaders-&gt;OptionalHeader.SectionAlignment &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp;&amp;
00314                 (ExportNtHeaders-&gt;FileHeader.Machine == IMAGE_FILE_MACHINE_I386)) {
00315                 <span class="keywordflow">if</span> (LdrpWx86DllHasRelocatedSharedSection(LdrDataTableEntry-&gt;DllBase)) {
00316                    DataTableEntry-&gt;Flags |= LDRP_IMAGE_NOT_AT_BASE;
00317                 }
00318             }
00319 <span class="preprocessor">#endif // defined (_ALPHA_) &amp;&amp; defined (WX86)</span>
00320 <span class="preprocessor"></span>
00321             <span class="keywordflow">if</span> ( NewImportDescriptor-&gt;TimeDateStamp != DataTableEntry-&gt;TimeDateStamp ||
00322                  (DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE) ) {
00323                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00324                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has stale binding to %s\n"</span>,
00325                             &amp;LdrDataTableEntry-&gt;BaseDllName,
00326                             NewImportName
00327                             );
00328                 }
00329                 StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330             } <span class="keywordflow">else</span> {
00331 <span class="preprocessor">#if DBG</span>
00332 <span class="preprocessor"></span>                LdrpSnapBypass++;
00333 <span class="preprocessor">#endif</span>
00334 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00335                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has correct binding to %s\n"</span>,
00336                             &amp;LdrDataTableEntry-&gt;BaseDllName,
00337                             NewImportName
00338                             );
00339                 }
00340                 StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00341             }
00342 
00343             NewImportForwarder = (PIMAGE_BOUND_FORWARDER_REF)(NewImportDescriptor+1);
00344             <span class="keywordflow">for</span> (i=0; i&lt;NewImportDescriptor-&gt;NumberOfModuleForwarderRefs; i++) {
00345                 NewFwdImportName = NewImportStringBase +
00346                                 NewImportForwarder-&gt;OffsetModuleName;
00347                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00348                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ bound to %s via forwarder(s) from %wZ\n"</span>,
00349                         &amp;LdrDataTableEntry-&gt;BaseDllName,
00350                         NewFwdImportName,
00351                         &amp;DataTableEntry-&gt;BaseDllName
00352                         );
00353                 }
00354 
00355                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00356                                            NewFwdImportName,
00357                                            LdrDataTableEntry-&gt;DllBase,
00358                                            &amp;FwdDataTableEntry,
00359                                            &amp;AlreadyLoaded
00360                                            );
00361                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00362                     <span class="keywordflow">if</span> (!AlreadyLoaded) {
00363                         InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00364                                        &amp;FwdDataTableEntry-&gt;InInitializationOrderLinks);
00365                         }
00366                     }
00367 
00368                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ||
00369                      NewImportForwarder-&gt;TimeDateStamp != FwdDataTableEntry-&gt;TimeDateStamp ||
00370                      (FwdDataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE ) ) {
00371                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00372                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has stale binding to %s\n"</span>,
00373                                 &amp;LdrDataTableEntry-&gt;BaseDllName,
00374                                 NewFwdImportName
00375                                 );
00376                     }
00377                     StaleBinding = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00378                 } <span class="keywordflow">else</span> {
00379 <span class="preprocessor">#if DBG</span>
00380 <span class="preprocessor"></span>                    LdrpSnapBypass++;
00381 <span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00383                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %wZ has correct binding to %s\n"</span>,
00384                                 &amp;LdrDataTableEntry-&gt;BaseDllName,
00385                                 NewFwdImportName
00386                                 );
00387                     }
00388                 }
00389 
00390                 NewImportForwarder += 1;
00391             }
00392             NewImportDescriptor = (PIMAGE_BOUND_IMPORT_DESCRIPTOR)NewImportForwarder;
00393 
00394             <span class="keywordflow">if</span> (StaleBinding) {
00395 <span class="preprocessor">#if DBG</span>
00396 <span class="preprocessor"></span>                LdrpNormalSnap++;
00397 <span class="preprocessor">#endif</span>
00398 <span class="preprocessor"></span>                <span class="comment">//</span>
00399                 <span class="comment">// Find the unbound import descriptor that matches this bound</span>
00400                 <span class="comment">// import descriptor</span>
00401                 <span class="comment">//</span>
00402 
00403                 ImportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00404                                     LdrDataTableEntry-&gt;DllBase,
00405                                     TRUE,
00406                                     IMAGE_DIRECTORY_ENTRY_IMPORT,
00407                                     &amp;ImportSize
00408                                     );
00409 
00410                 <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name) {
00411                     ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
00412                     <span class="keywordflow">if</span> (!_stricmp(ImportName, NewImportName)) {
00413                         <span class="keywordflow">break</span>;
00414                     }
00415 
00416                     ImportDescriptor += 1;
00417                 }
00418 
00419                 <span class="keywordflow">if</span> (!ImportDescriptor-&gt;Name) {
00420                     <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00421                 }
00422 
00423                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00424                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Stale Bind %s from %wZ\n"</span>,ImportName,&amp;LdrDataTableEntry-&gt;BaseDllName);
00425                 }
00426 
00427                 st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">LdrpSnapIAT</a>(
00428                         DataTableEntry,
00429                         LdrDataTableEntry,
00430                         ImportDescriptor,
00431                         FALSE
00432                         );
00433 
00434                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00435                     <span class="keywordflow">return</span> st;
00436                 }
00437             }
00438         }
00439     }
00440     <span class="keywordflow">else</span>
00441     <span class="keywordflow">if</span> (ImportDescriptor) {
00442         <span class="comment">//</span>
00443         <span class="comment">// For each DLL used by this DLL, load the dll. Then snap</span>
00444         <span class="comment">// the IAT, and call the DLL's init routine.</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">while</span> (ImportDescriptor-&gt;Name &amp;&amp; ImportDescriptor-&gt;FirstThunk) {
00448             ImportName = (PSZ)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;Name);
00449 
00450             <span class="comment">//</span>
00451             <span class="comment">// check for import that has no references</span>
00452             <span class="comment">//</span>
00453             FirstThunk = (PIMAGE_THUNK_DATA)((ULONG_PTR)LdrDataTableEntry-&gt;DllBase + ImportDescriptor-&gt;FirstThunk);
00454             <span class="keywordflow">if</span> ( !FirstThunk-&gt;u1.Function ) {
00455                 <span class="keywordflow">goto</span> skipimport;
00456                 }
00457 
00458             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00459                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: %s used by %wZ\n"</span>,
00460                     ImportName,
00461                     &amp;LdrDataTableEntry-&gt;BaseDllName
00462                     );
00463             }
00464 
00465 
00466             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a41">LdrpLoadImportModule</a>( DllPath,
00467                                        ImportName,
00468                                        LdrDataTableEntry-&gt;DllBase,
00469                                        &amp;DataTableEntry,
00470                                        &amp;AlreadyLoaded
00471                                        );
00472             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00473                 <span class="keywordflow">return</span> st;
00474             }
00475 
00476             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00477                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snapping imports for %wZ from %s\n"</span>,
00478                         &amp;LdrDataTableEntry-&gt;BaseDllName,
00479                         ImportName
00480                         );
00481             }
00482 
00483             <span class="comment">//</span>
00484             <span class="comment">// If the image has been bound and the import date stamp</span>
00485             <span class="comment">// matches the date time stamp in the export modules header,</span>
00486             <span class="comment">// and the image was mapped at it's prefered base address,</span>
00487             <span class="comment">// then we are done.</span>
00488             <span class="comment">//</span>
00489 
00490             SnapForwardersOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00491 
00492             <span class="keywordflow">if</span> ( ImportDescriptor-&gt;OriginalFirstThunk ) {
00493                 <span class="keywordflow">if</span> ( ImportDescriptor-&gt;TimeDateStamp &amp;&amp;
00494                      ImportDescriptor-&gt;TimeDateStamp == DataTableEntry-&gt;TimeDateStamp &amp;&amp;
00495                      (! DataTableEntry-&gt;Flags &amp; LDRP_IMAGE_NOT_AT_BASE) ) {
00496 <span class="preprocessor">#if DBG</span>
00497 <span class="preprocessor"></span>                    LdrpSnapBypass++;
00498 <span class="preprocessor">#endif</span>
00499 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>) {
00500                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"LDR: Snap bypass %s from %wZ\n"</span>,
00501                             ImportName,
00502                             &amp;LdrDataTableEntry-&gt;BaseDllName
00503                             );
00504                     }
00505 
00506                     <span class="keywordflow">if</span> (ImportDescriptor-&gt;ForwarderChain == -1) {
00507                         <span class="keywordflow">goto</span> bypass_snap;
00508                         }
00509 
00510                     SnapForwardersOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00511 
00512                     }
00513             }
00514 <span class="preprocessor">#if DBG</span>
00515 <span class="preprocessor"></span>            LdrpNormalSnap++;
00516 <span class="preprocessor">#endif</span>
00517 <span class="preprocessor"></span>            <span class="comment">//</span>
00518             <span class="comment">// Add to initialization list.</span>
00519             <span class="comment">//</span>
00520 
00521             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00522                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00523                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00524             }
00525             st = <a class="code" href="../../d2/d3/ldrsnap_8c.html#a48">LdrpSnapIAT</a>(
00526                     DataTableEntry,
00527                     LdrDataTableEntry,
00528                     ImportDescriptor,
00529                     SnapForwardersOnly
00530                     );
00531 
00532             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00533                 <span class="keywordflow">return</span> st;
00534             }
00535             AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00536 bypass_snap:
00537             <span class="comment">//</span>
00538             <span class="comment">// Add to initialization list.</span>
00539             <span class="comment">//</span>
00540 
00541             <span class="keywordflow">if</span> (!AlreadyLoaded) {
00542                 InsertTailList(&amp;Peb-&gt;Ldr-&gt;InInitializationOrderModuleList,
00543                                &amp;DataTableEntry-&gt;InInitializationOrderLinks);
00544             }
00545 
00546 skipimport:
00547             ++ImportDescriptor;
00548         }
00549     }
00550 
00551     <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_ENABLE_TAG_BY_DLL) {
00552         PVOID IATBase;
00553         SIZE_T BigIATSize;
00554         ULONG  LittleIATSize;
00555         PVOID *ProcAddresses;
00556         ULONG NumberOfProcAddresses;
00557         ULONG OldProtect;
00558         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
00559 
00560         <span class="comment">//</span>
00561         <span class="comment">// Determine the location and size of the IAT.  If found, scan the</span>
00562         <span class="comment">// IAT address to see if any are pointing to RtlAllocateHeap.  If so</span>
00563         <span class="comment">// replace when with a pointer to a unique thunk function that will</span>
00564         <span class="comment">// replace the tag with a unique tag for this image.</span>
00565         <span class="comment">//</span>
00566 
00567         IATBase = <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>( LdrDataTableEntry-&gt;DllBase,
00568                                                 TRUE,
00569                                                 IMAGE_DIRECTORY_ENTRY_IAT,
00570                                                 &amp;LittleIATSize
00571                                               );
00572         BigIATSize = LittleIATSize;
00573         <span class="keywordflow">if</span> (IATBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00574             st = <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
00575                                          &amp;IATBase,
00576                                          &amp;BigIATSize,
00577                                          PAGE_READWRITE,
00578                                          &amp;OldProtect
00579                                        );
00580             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00581                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"LDR: Unable to unprotect IAT to enable tagging by DLL.\n"</span> );
00582             }
00583             <span class="keywordflow">else</span> {
00584                 ProcAddresses = (PVOID *)IATBase;
00585                 NumberOfProcAddresses = (ULONG)(BigIATSize / <span class="keyword">sizeof</span>(PVOID));
00586                 <span class="keywordflow">while</span> (NumberOfProcAddresses--) {
00587                     <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>) {
00588                         *ProcAddresses = <a class="code" href="../../d9/d2/ldrp_8h.html#a87">LdrpDefineDllTag</a>( LdrDataTableEntry-&gt;BaseDllName.Buffer, &amp;TagIndex );
00589                         <span class="keywordflow">if</span> (*ProcAddresses == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590                             *ProcAddresses = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>;
00591                         }
00592                     }
00593 
00594                     ProcAddresses += 1;
00595                 }
00596 
00597                 <a class="code" href="../../d0/d9/protect_8c.html#a4">NtProtectVirtualMemory</a>( NtCurrentProcess(),
00598                                         &amp;IATBase,
00599                                         &amp;BigIATSize,
00600                                         OldProtect,
00601                                         &amp;OldProtect
00602                                       );
00603             }
00604         }
00605     }
00606 
00607     <span class="comment">//</span>
00608     <span class="comment">// Check if we need to redirect some imports in case page heap</span>
00609     <span class="comment">// is enabled and we target specific dlls.</span>
00610     <span class="comment">//</span>
00611 
00612     <span class="keywordflow">if</span> (Peb-&gt;NtGlobalFlag &amp; FLG_HEAP_PAGE_ALLOCS) {
00613         
00614         <a class="code" href="../../d2/d3/ldrsnap_8c.html#a40">LdrpDphInitializeTargetDll</a> (LdrDataTableEntry);
00615     }
00616 
00617     <span class="keywordflow">return</span> STATUS_SUCCESS;
00618 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="ldrp.h::RtlpLockProcessHeapsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLIST_ENTRY RtlpLockProcessHeapsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="ldrp.h::RtlpSerializeHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpSerializeHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>HeapHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">323</a> of file <a class="el" href="../../d5/d8/heapdbg_8c-source.html">heapdbg.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00322">_HEAP::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00323">_HEAP::ForceFlags</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d8/d8/heappage_8h-source.html#l00058">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00369">_HEAP::LockVariable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00077">RtlInitializeLockRoutine</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04250">RtlpCheckHeapSignature()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l03795">RtlpDebugPageHeapSerialize()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">RtlpValidateHeapHeaders()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.
<p>
<pre class="fragment"><div>00329                    :
00330 
00331 Arguments:
00332 
00333 Return Value:
00334 
00335 --*/
00336 
00337 {
00338     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00339     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
00340     <a class="code" href="../../d4/d6/struct__HEAP__LOCK.html">PHEAP_LOCK</a> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00341 
00342     <a class="code" href="../../d7/d9/heappage_8h.html#a6">IF_DEBUG_PAGE_HEAP_THEN_RETURN</a>( HeapHandle,
00343                                     <a class="code" href="../../d7/d9/heappage_8h.html#a24">RtlpDebugPageHeapSerialize</a>( HeapHandle ));
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Validate that HeapAddress points to a HEAP structure.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a>( Heap, <span class="stringliteral">"RtlpSerializeHeap"</span> )) {
00350 
00351         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00352     }
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">//  Lock the heap.</span>
00356     <span class="comment">//</span>
00357 
00358     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_NO_SERIALIZE) {
00359 
00360         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( HeapHandle, HEAP_NO_SERIALIZE, <span class="keyword">sizeof</span>( *Lock ) );
00361 
00362         <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00363 
00364             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00365         }
00366     
00367         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/heappriv_8h.html#a2">RtlInitializeLockRoutine</a>( Lock );
00368 
00369         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00370 
00371             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( HeapHandle, HEAP_NO_SERIALIZE, Lock );
00372 
00373             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00374         }
00375 
00376         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
00377         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp;= ~HEAP_NO_SERIALIZE;
00378         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o3">ForceFlags</a> &amp;= ~HEAP_NO_SERIALIZE;
00379 
00380         <a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, TRUE );
00381     }
00382 
00383     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00384 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="ldrp.h::RtlpUnlockProcessHeapsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpUnlockProcessHeapsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="ldrp.h::UnicodeToAnsii" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSZ UnicodeToAnsii           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PWSTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>String</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="ldrp.h::xRtlDosPathNameToNtPathName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN xRtlDosPathNameToNtPathName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>DosFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NtFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSZ *FilePart&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRTL_RELATIVE_NAME <a class="el" href="../../d2/d2/rtload_8c.html#a7">RelativeName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="ldrp.h::xRtlDosSearchPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG xRtlDosSearchPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpPath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpExtension</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>nBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ *lpFilePart&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="ldrp.h::xRtlGetFullPathName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG xRtlGetFullPathName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpFileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>nBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ&nbsp;</td>
          <td class="mdname" nowrap> <em>lpBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PSZ *lpFilePart&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a46" doxytag="ldrp.h::FastPebLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION <a class="el" href="../../d9/d2/ldrp_8h.html#a46">FastPebLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00388">388</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="ldrp.h::LdrpActiveUnloadCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a42">LdrpActiveUnloadCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00383">383</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="ldrp.h::LdrpDefaultPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d9/d2/ldrp_8h.html#a22">LdrpDefaultPath</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00387">387</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="ldrp.h::LdrpDefaultPathCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a27">LdrpDefaultPathCache</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00168">168</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="ldrp.h::LdrpFatalHardErrorCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d2/ldrp_8h.html#a45">LdrpFatalHardErrorCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00386">386</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00157">LdrpInitializationFailure()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="ldrp.h::LdrpGetModuleHandleCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a43">LdrpGetModuleHandleCache</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00384">384</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="ldrp.h::LdrpHashTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a26">LdrpHashTable</a>[LDRP_HASH_TABLE_SIZE]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00162">162</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03084">LdrpInsertMemoryTableEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="ldrp.h::LdrpImageEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a40">LdrpImageEntry</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00390">390</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="ldrp.h::LdrpImageHasTls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a21">LdrpImageHasTls</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00032">32</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01702">LdrpInitializeThread()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01602">LdrShutdownThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="ldrp.h::LdrpInLdrInit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a37">LdrpInLdrInit</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00374">374</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00474">LdrDisableThreadCalloutsForDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01210">LdrQueryProcessModuleInformation()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="ldrp.h::LdrpKnownDllObjectDirectory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d9/d2/ldrp_8h.html#a23">LdrpKnownDllObjectDirectory</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00034">34</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="ldrp.h::LdrpKnownDllPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d9/d2/ldrp_8h.html#a25">LdrpKnownDllPath</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00037">37</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03283">LdrpCheckForKnownDll()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="ldrp.h::LdrpKnownDllPathBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d9/d2/ldrp_8h.html#a24">LdrpKnownDllPathBuffer</a>[LDRP_MAX_KNOWN_PATH]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00036">36</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="ldrp.h::LdrpLdrDatabaseIsSetup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a38">LdrpLdrDatabaseIsSetup</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00375">375</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="ldrp.h::LdrpLoadedDllHandleCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a44">LdrpLoadedDllHandleCache</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00385">385</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01196">LdrpCheckForLoadedDllHandle()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="ldrp.h::LdrpNumberOfProcessors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d2/ldrp_8h.html#a48">LdrpNumberOfProcessors</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00391">391</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="ldrp.h::LdrpNumberOfTlsEntries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d2/ldrp_8h.html#a52">LdrpNumberOfTlsEntries</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00401">401</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="ldrp.h::LdrpShutdownInProgress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d7/d8/dll_2resource_8c.html#a4">LdrpShutdownInProgress</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00373">373</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="ldrp.h::LdrpShutdownThreadId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d7/d8/dll_2resource_8c.html#a5">LdrpShutdownThreadId</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00389">389</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01717">RtlpNotOwnerCriticalSection()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="ldrp.h::LdrpTlsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a51">LdrpTlsList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00400">400</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02134">LdrpFreeTls()</a>, and <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="ldrp.h::LdrpUnloadHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a41">LdrpUnloadHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00382">382</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="ldrp.h::LdrpVerifyDlls" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a39">LdrpVerifyDlls</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00376">376</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="ldrp.h::NtdllBaseTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d2/ldrp_8h.html#a53">NtdllBaseTag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00455">455</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="ldrp.h::NtGlobalFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d1/d1/theap_8c.html#a3">NtGlobalFlag</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">370</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l02607">ExAllocatePoolWithQuotaTag()</a>, <a class="el" href="../../d8/d3/ddkresrc_8c-source.html#l00172">ExInitializeResource()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00209">ExInitializeResourceLite()</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00677">InitializePool()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l00270">IoInitSystem()</a>, <a class="el" href="../../d9/d7/i386_2kdtrap_8c-source.html#l00038">KdpTrap()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01567">MiMapViewOfImageSection()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l04631">MmCreatePeb()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03445">MmInPageKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l03180">MmOutPageKernelStack()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00941">NtQuerySystemInformation()</a>, <a class="el" href="../../d1/d7/ex_2event_8c-source.html#l00748">NtSetEvent()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02264">NtSetSystemInformation()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00807">ObpCaptureHandleInformation()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01127">ObpEnumFindHandleProcedure()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00162">RtlDispatchException()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01432">RtlGetNtGlobalFlags()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04732">RtlpInitializeHeapSegment()</a>, and <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02004">UserInitialize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="ldrp.h::RtlCriticalSectionList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d9/d2/ldrp_8h.html#a34">RtlCriticalSectionList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00371">371</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>, and <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l01049">RtlQueryProcessLockInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="ldrp.h::RtlCriticalSectionLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> RTL_CRITICAL_SECTION <a class="el" href="../../d9/d2/ldrp_8h.html#a35">RtlCriticalSectionLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00372">372</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00211">RtlpInitDeferedCriticalSection()</a>, and <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l01049">RtlQueryProcessLockInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="ldrp.h::RtlpTimeout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LARGE_INTEGER <a class="el" href="../../d9/d2/ldrp_8h.html#a32">RtlpTimeout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00369">369</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">RtlAcquireResourceExclusive()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">RtlAcquireResourceShared()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">RtlConvertSharedToExclusive()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="ldrp.h::RtlpTimoutDisable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a31">RtlpTimoutDisable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00368">368</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="ldrp.h::ShowSnaps" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d2/ldrp_8h.html#a30">ShowSnaps</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00367">367</a> of file <a class="el" href="../../d0/d2/ldrp_8h-source.html">ldrp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00295">LdrGetDllHandle()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02071">LdrpAllocateTls()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02178">LdrpCallTlsInitializers()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00851">LdrpGetProcedureAddress()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01978">LdrpInitializeTls()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00070">LdrpLoadDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l03120">LdrpResolveDllName()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00652">LdrpRunInitializeRoutines()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02802">LdrpUpdateLoadCount()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00214">LdrpWalkImportDescriptor()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01462">LdrShutdownProcess()</a>, and <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l00528">LdrUnloadDll()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:31 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
