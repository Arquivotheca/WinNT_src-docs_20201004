<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsubs2.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsubs2.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d0/d2/cmsubs2_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(<a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(<a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PUCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a> (IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, IN <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList, IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ValueKey, IN BOOLEAN ValueCached)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="el" href="../../d7/d0/cmdat2_8c.html#a24">Cell</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node, KEY_INFORMATION_CLASS KeyInformationClass, PVOID KeyInformation, ULONG Length, PULONG ResultLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList, <a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueKey, BOOLEAN ValueCached, KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass, PVOID KeyValueInformation, ULONG Length, PULONG ResultLength)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="cmsubs2.c::ALIGN_OFFSET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_OFFSET          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(ULONG) \
        ((((ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>) + <span class="keyword">sizeof</span>(ULONG)-1)) &amp; (~(<span class="keyword">sizeof</span>(ULONG) - 1)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00045">45</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">CmpQueryKeyData()</a>, and <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="cmsubs2.c::ALIGN_OFFSET64" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_OFFSET64          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(ULONG) \
        ((((ULONG)(<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>) + <span class="keyword">sizeof</span>(ULONGLONG)-1)) &amp; (~(<span class="keyword">sizeof</span>(ULONGLONG) - 1)))
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00048">48</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="cmsubs2.c::CmpFreeValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CmpFreeValue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Cell</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00053">53</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00096">Cell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00688">HvFreeCell()</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, and <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00092">CmDeleteValueKey()</a>, <a class="el" href="../../d4/d2/cmtredel_8c-source.html#l00140">CmpFreeKeyByCell()</a>, and <a class="el" href="../../d3/d2/cmtrecpy_8c-source.html#l01064">CmpFreeKeyValues()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     Free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>.Cell refers to, including
00062     its name and data cells.
00063 
00064 Arguments:
00065 
00066     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00067 
00068     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of value to <span class="keyword">delete</span>
00069 
00070 Return Value:
00071 
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00073 
00074         &lt;TBS&gt;
00075 
00076 --*/
00077 {
00078     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> value;
00079     ULONG       realsize;
00080     BOOLEAN     small;
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// map in the cell</span>
00084     <span class="comment">//</span>
00085     value = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Cell);
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// free data if present</span>
00089     <span class="comment">//</span>
00090     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00091     <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0))
00092     {
00093         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, value-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">// free the cell itself</span>
00098     <span class="comment">//</span>
00099     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(Hive, Cell);
00100 
00101     <span class="keywordflow">return</span>;
00102 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="cmsubs2.c::CmpGetValueDataFromCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PUCHAR CmpGetValueDataFromCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueCached</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">403</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00586">CM_CACHE_DATA_CACHED</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00585">CM_CACHE_DATA_NOT_CACHED</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00587">CM_CACHE_DATA_TOO_BIG</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00609">CMP_GET_CACHED_ADDRESS</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00613">CMP_MARK_CELL_CACHED</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00142">CmpMakeSpecialPoolReadOnly</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00143">CmpMakeSpecialPoolReadWrite</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00599">_CM_CACHED_VALUE::DataCacheType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00335">HvGetCellSize()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00601">_CM_CACHED_VALUE::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00588">MAXIMUM_CACHED_DATA</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00600">_CM_CACHED_VALUE::ValueKeySize</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">CmpQueryKeyValueData()</a>.
<p>
<pre class="fragment"><div>00411                    :
00412 
00413     Get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cached Value Data given a value node.
00414 
00415 Arguments:
00416 
00417     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive of interest
00418 
00419     ContainingList - Address that stores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value node.
00420                      We need to update <span class="keyword">this</span> when we <span class="keywordflow">do</span> a re-allocate to cache
00421                      both value key and value data.
00422 
00423     ValueKey - pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Value <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>
00424 
00425     ValueCached - Indicating whether Value key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cached or not.
00426 
00427 Return Value:
00428 
00429     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Valve <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>.
00430 --*/
00431 {
00432     <span class="comment">//</span>
00433     <span class="comment">// Cache the data if needed.</span>
00434     <span class="comment">//</span>
00435     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> OldEntry;
00436     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a> NewEntry;
00437     PUCHAR      datapointer;
00438     PUCHAR      Cacheddatapointer;
00439     ULONG       AllocSize;
00440     ULONG       CopySize;
00441     ULONG       DataSize;
00442 
00443     <span class="keywordflow">if</span> (ValueCached) {
00444         OldEntry = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(*ContainingList);
00445         <span class="keywordflow">if</span> (OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a41">CM_CACHE_DATA_CACHED</a>) {
00446             <span class="comment">//</span>
00447             <span class="comment">// Data is already cached, use it.</span>
00448             <span class="comment">//</span>
00449             datapointer = (PUCHAR) ((ULONG_PTR) ValueKey + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00450         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == <a class="code" href="../../d9/d0/cmdata_8h.html#a42">CM_CACHE_DATA_TOO_BIG</a>) {
00451             <span class="comment">//</span>
00452             <span class="comment">// Data is too big to warrent caching, get it from the registry.</span>
00453             <span class="comment">//</span>
00454             datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueKey-&gt;u.KeyValue.Data);
00455         } <span class="keywordflow">else</span> {
00456             <span class="comment">//</span>
00457             <span class="comment">// consistency check</span>
00458             <span class="comment">//</span>
00459             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> == CM_CACHE_DATA_NOT_CACHED);
00460 
00461             <span class="comment">//</span>
00462             <span class="comment">// Value data is not cached.</span>
00463             <span class="comment">// Check the size of value data, if it is smaller than MAXIMUM_CACHED_DATA, cache it.</span>
00464             <span class="comment">//</span>
00465             datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueKey-&gt;u.KeyValue.Data);
00466             DataSize = (ULONG) <a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(Hive, datapointer);
00467             <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a43">MAXIMUM_CACHED_DATA</a>) {
00468                 <span class="comment">//</span>
00469                 <span class="comment">// Data is not cached and now we are going to do it.</span>
00470                 <span class="comment">// Reallocate a new cached entry for both value key and value data.</span>
00471                 <span class="comment">//</span>
00472                 CopySize = DataSize + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>;
00473                 AllocSize = CopySize + FIELD_OFFSET(<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">CM_CACHED_VALUE</a>, KeyValue);
00474 
00475                 <span class="comment">// Dragos: Changed to catch the memory violator</span>
00476                 <span class="comment">// it didn't work</span>
00477                 <span class="comment">//NewEntry = (PCM_CACHED_VALUE) ExAllocatePoolWithTagPriority(PagedPool, AllocSize, CM_CACHE_VALUE_DATA_TAG,NormalPoolPrioritySpecialPoolUnderrun);</span>
00478                 NewEntry = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, AllocSize, CM_CACHE_VALUE_DATA_TAG);
00479 
00480                 <span class="keywordflow">if</span> (NewEntry) {
00481                     <span class="comment">//</span>
00482                     <span class="comment">// Now fill the data to the new cached entry</span>
00483                     <span class="comment">//</span>
00484                     NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a41">CM_CACHE_DATA_CACHED</a>;
00485                     NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a> = OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>;
00486 
00487                     RtlCopyMemory((PVOID)&amp;(NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>),
00488                                   (PVOID)&amp;(OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>),
00489                                   NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00490 
00491                     Cacheddatapointer = (PUCHAR) ((ULONG_PTR) &amp;(NewEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o2">KeyValue</a>) + OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o1">ValueKeySize</a>);
00492                     RtlCopyMemory(Cacheddatapointer, datapointer, DataSize);
00493 
00494                     <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00495                     <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( OldEntry );
00496 
00497                     *ContainingList = (<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PCM_CACHED_VALUE</a>) <a class="code" href="../../d9/d0/cmdata_8h.html#a50">CMP_MARK_CELL_CACHED</a>(NewEntry);
00498 
00499                     <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00500                     <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>( NewEntry );
00501 
00502                     <span class="comment">//</span>
00503                     <span class="comment">// Free the old entry</span>
00504                     <span class="comment">//</span>
00505 
00506                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldEntry);
00507                 }
00508             } <span class="keywordflow">else</span> {
00509                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00510                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( OldEntry );
00511 
00512                 <span class="comment">//</span>
00513                 <span class="comment">// Mark the type and do not cache it.</span>
00514                 <span class="comment">//</span>
00515                 OldEntry-&gt;<a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html#o0">DataCacheType</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a42">CM_CACHE_DATA_TOO_BIG</a>;
00516 
00517                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00518                 <a class="code" href="../../d1/d2/cmp_8h.html#a7">CmpMakeSpecialPoolReadOnly</a>( OldEntry );
00519             }
00520         }
00521     } <span class="keywordflow">else</span> {
00522         datapointer = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, ValueKey-&gt;u.KeyValue.Data);
00523     }
00524 
00525     <span class="keywordflow">return</span> (datapointer);
00526 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="cmsubs2.c::CmpQueryKeyData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQueryKeyData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Node</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>KEY_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00110">110</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00045">ALIGN_OFFSET</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00464">_CM_KEY_NODE::Class</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00476">_CM_KEY_NODE::ClassLength</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00673">CmpHKeyNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00332">_CHILD_LIST::Count</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00450">_CM_KEY_NODE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00290">HvGetCell</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00440">KEY_COMP_NAME</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00552">_KEY_INFORMATION::KeyBasicInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00554">_KEY_INFORMATION::KeyFullInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00553">_KEY_INFORMATION::KeyNodeInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00451">_CM_KEY_NODE::LastWriteTime</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00466">_CM_KEY_NODE::MaxClassLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00465">_CM_KEY_NODE::MaxNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00468">_CM_KEY_NODE::MaxValueDataLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00467">_CM_KEY_NODE::MaxValueNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00477">_CM_KEY_NODE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00475">_CM_KEY_NODE::NameLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00454">_CM_KEY_NODE::SubKeyCounts</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00458">_CM_KEY_NODE::ValueList</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00285">CmEnumerateKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00647">CmQueryKey()</a>.
<p>
<pre class="fragment"><div>00120                    :
00121 
00122     Do <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual copy of data <span class="keywordflow">for</span> a key into caller's buffer.
00123 
00124     If KeyInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00125     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00126     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00127 
00128 Arguments:
00129 
00130     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00131 
00132     Node - Supplies pointer to node whose subkeys are to be found
00133 
00134     KeyInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information returned in
00135         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00136 
00137         KeyBasicInformation - <span class="keywordflow">return</span> last write time, title index, and name.
00138             (see KEY_BASIC_INFORMATION structure)
00139 
00140         KeyNodeInformation - <span class="keywordflow">return</span> last write time, title index, name, <span class="keyword">class</span>.
00141             (see KEY_NODE_INFORMATION structure)
00142 
00143     KeyInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00144 
00145     Length - Length of KeyInformation in bytes.
00146 
00147     ResultLength - Number of bytes actually written into KeyInformation.
00148 
00149 Return Value:
00150 
00151     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00152 
00153         &lt;TBS&gt;
00154 
00155 --*/
00156 {
00157     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00158     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pclass;
00159     ULONG       requiredlength;
00160     LONG        leftlength;
00161     ULONG       offset;
00162     ULONG       minimumlength;
00163     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer;
00164     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00165 
00166     pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00167     NameLength = <a class="code" href="../../d1/d2/cmp_8h.html#a96">CmpHKeyNameLen</a>(Node);
00168 
00169     <span class="keywordflow">switch</span> (KeyInformationClass) {
00170 
00171     <span class="keywordflow">case</span> KeyBasicInformation:
00172 
00173         <span class="comment">//</span>
00174         <span class="comment">// LastWriteTime, TitleIndex, NameLength, Name</span>
00175 
00176         requiredlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, Name) +
00177                          NameLength;
00178 
00179         minimumlength = FIELD_OFFSET(KEY_BASIC_INFORMATION, Name);
00180 
00181         *ResultLength = requiredlength;
00182 
00183         status = STATUS_SUCCESS;
00184 
00185         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00186 
00187             status = STATUS_BUFFER_TOO_SMALL;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.LastWriteTime =
00192                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00193 
00194             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.TitleIndex = 0;
00195 
00196             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.NameLength =
00197                 NameLength;
00198 
00199             leftlength = Length - minimumlength;
00200 
00201             requiredlength = NameLength;
00202 
00203             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00204                 requiredlength = leftlength;
00205                 status = STATUS_BUFFER_OVERFLOW;
00206             }
00207 
00208             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00209                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name,
00210                                       leftlength,
00211                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00212                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00213             } <span class="keywordflow">else</span> {
00214                 RtlCopyMemory(
00215                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o0">KeyBasicInformation</a>.Name[0]),
00216                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00217                     requiredlength
00218                     );
00219             }
00220         }
00221 
00222         <span class="keywordflow">break</span>;
00223 
00224 
00225     <span class="keywordflow">case</span> KeyNodeInformation:
00226 
00227         <span class="comment">//</span>
00228         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength</span>
00229         <span class="comment">// NameLength, Name, Class</span>
00230         <span class="comment">//</span>
00231         requiredlength = FIELD_OFFSET(KEY_NODE_INFORMATION, Name) +
00232                          NameLength +
00233                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00234 
00235         minimumlength = FIELD_OFFSET(KEY_NODE_INFORMATION, Name);
00236 
00237         *ResultLength = requiredlength;
00238 
00239         status = STATUS_SUCCESS;
00240 
00241         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00242 
00243             status = STATUS_BUFFER_TOO_SMALL;
00244 
00245         } <span class="keywordflow">else</span> {
00246 
00247             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.LastWriteTime =
00248                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00249 
00250             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.TitleIndex = 0;
00251 
00252             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassLength =
00253                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00254 
00255             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.NameLength =
00256                 NameLength;
00257 
00258             leftlength = Length - minimumlength;
00259             requiredlength = NameLength;
00260 
00261             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00262                 requiredlength = leftlength;
00263                 status = STATUS_BUFFER_OVERFLOW;
00264             }
00265 
00266             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>) {
00267                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name,
00268                                       leftlength,
00269                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>,
00270                                       Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a>);
00271             } <span class="keywordflow">else</span> {
00272                 RtlCopyMemory(
00273                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.Name[0]),
00274                     &amp;(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>[0]),
00275                     requiredlength
00276                     );
00277             }
00278 
00279             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00280 
00281                 offset = FIELD_OFFSET(KEY_NODE_INFORMATION, Name) +
00282                             NameLength;
00283                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(offset);
00284 
00285                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = offset;
00286 
00287                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00288 
00289                 pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)((PUCHAR)pbuffer + offset);
00290 
00291                 leftlength = (((LONG)Length - (LONG)offset) &lt; 0) ?
00292                                     0 :
00293                                     Length - offset;
00294 
00295                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00296 
00297                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00298                     requiredlength = leftlength;
00299                     status = STATUS_BUFFER_OVERFLOW;
00300                 }
00301 
00302                 RtlMoveMemory(
00303                     pbuffer,
00304                     pclass,
00305                     requiredlength
00306                     );
00307 
00308             } <span class="keywordflow">else</span> {
00309                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o1">KeyNodeInformation</a>.ClassOffset = (ULONG)-1;
00310             }
00311         }
00312 
00313         <span class="keywordflow">break</span>;
00314 
00315 
00316     <span class="keywordflow">case</span> KeyFullInformation:
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// LastWriteTime, TitleIndex, ClassOffset, ClassLength,</span>
00320         <span class="comment">// SubKeys, MaxNameLen, MaxClassLen, Values, MaxValueNameLen,</span>
00321         <span class="comment">// MaxValueDataLen, Class</span>
00322         <span class="comment">//</span>
00323         requiredlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class) +
00324                          Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00325 
00326         minimumlength = FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00327 
00328         *ResultLength = requiredlength;
00329 
00330         status = STATUS_SUCCESS;
00331 
00332         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00333 
00334             status = STATUS_BUFFER_TOO_SMALL;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.LastWriteTime =
00339                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a>;
00340 
00341             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.TitleIndex = 0;
00342 
00343             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassLength =
00344                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00345 
00346             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
00347 
00348                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset =
00349                         FIELD_OFFSET(KEY_FULL_INFORMATION, Class);
00350 
00351                 pclass = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Hive, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
00352 
00353                 leftlength = Length - minimumlength;
00354                 requiredlength = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a>;
00355 
00356                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00357                     requiredlength = leftlength;
00358                     status = STATUS_BUFFER_OVERFLOW;
00359                 }
00360 
00361                 RtlMoveMemory(
00362                     &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Class[0]),
00363                     pclass,
00364                     requiredlength
00365                     );
00366 
00367             } <span class="keywordflow">else</span> {
00368                 pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.ClassOffset = (ULONG)-1;
00369             }
00370 
00371             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.SubKeys =
00372                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] +
00373                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
00374 
00375             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.Values =
00376                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00377 
00378             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxNameLen =
00379                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a>;
00380 
00381             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxClassLen =
00382                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a>;
00383 
00384             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueNameLen =
00385                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a>;
00386 
00387             pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o2">KeyFullInformation</a>.MaxValueDataLen =
00388                 Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a>;
00389 
00390         }
00391 
00392         <span class="keywordflow">break</span>;
00393 
00394 
00395     <span class="keywordflow">default</span>:
00396         status = STATUS_INVALID_PARAMETER;
00397         <span class="keywordflow">break</span>;
00398     }
00399     <span class="keywordflow">return</span> status;
00400 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="cmsubs2.c::CmpQueryKeyValueData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CmpQueryKeyValueData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ContainingList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueCached</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>KEY_VALUE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResultLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00531">531</a> of file <a class="el" href="../../d0/d2/cmsubs2_8c-source.html">cmsubs2.c</a>.
<p>
References <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00045">ALIGN_OFFSET</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00048">ALIGN_OFFSET64</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00489">CM_KEY_VALUE_SMALL</a>, <a class="el" href="../../d0/d1/cmname_8c-source.html#l00151">CmpCopyCompressedName()</a>, <a class="el" href="../../d0/d2/cmsubs2_8c-source.html#l00403">CmpGetValueDataFromCache()</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00508">CmpIsHKeyValueSmall</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00692">CmpValueNameLen</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00498">_CM_KEY_VALUE::Data</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00497">_CM_KEY_VALUE::DataLength</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00500">_CM_KEY_VALUE::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00538">_CELL_DATA::_u::KeyValue</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00559">_KEY_VALUE_INFORMATION::KeyValueBasicInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00560">_KEY_VALUE_INFORMATION::KeyValueFullInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00561">_KEY_VALUE_INFORMATION::KeyValuePartialInformation</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00562">_KEY_VALUE_INFORMATION::KeyValuePartialInformationAlign64</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00502">_CM_KEY_VALUE::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00496">_CM_KEY_VALUE::NameLength</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00499">_CM_KEY_VALUE::Type</a>, <a class="el" href="../../d4/d9/struct__CELL__DATA.html#o0">_CELL_DATA::u</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d0/d0/cmdata_8h-source.html#l00491">VALUE_COMP_NAME</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00416">CmEnumerateValueKey()</a>, and <a class="el" href="../../d9/d8/cmapi_8c-source.html#l00804">CmQueryValueKey()</a>.
<p>
<pre class="fragment"><div>00543                    :
00544 
00545     Do <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual copy of data <span class="keywordflow">for</span> a key value into caller's buffer.
00546 
00547     If KeyValueInformation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <span class="keywordtype">long</span> enough to hold all requested data,
00548     STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be
00549     set to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes actually required.
00550 
00551 Arguments:
00552 
00553     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive
00554 
00555     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> - supplies index of node to whose sub keys are to be found
00556 
00557     KeyValueInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information returned in
00558         KeyValueInformation.  One of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following types:
00559 
00560     KeyValueInformation -Supplies pointer to buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data.
00561 
00562     Length - Length of KeyInformation in bytes.
00563 
00564     ResultLength - Number of bytes actually written into KeyInformation.
00565 
00566 Return Value:
00567 
00568     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Result code from call, among <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following:
00569 
00570         &lt;TBS&gt;
00571 
00572 --*/
00573 {
00574     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00575     <a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html">PKEY_VALUE_INFORMATION</a> pbuffer;
00576     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pcell;
00577     LONG        leftlength;
00578     ULONG       requiredlength;
00579     ULONG       minimumlength;
00580     ULONG       offset;
00581     ULONG       base;
00582     ULONG       realsize;
00583     PUCHAR      datapointer;
00584     BOOLEAN     small;
00585     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00586 
00587     pbuffer = (<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html">PKEY_VALUE_INFORMATION</a>)KeyValueInformation;
00588 
00589     pcell = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>) ValueKey;
00590     NameLength = <a class="code" href="../../d1/d2/cmp_8h.html#a99">CmpValueNameLen</a>(&amp;pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>);
00591 
00592     <span class="keywordflow">switch</span> (KeyValueInformationClass) {
00593 
00594     <span class="keywordflow">case</span> KeyValueBasicInformation:
00595 
00596         <span class="comment">//</span>
00597         <span class="comment">// TitleIndex, Type, NameLength, Name</span>
00598         <span class="comment">//</span>
00599         requiredlength = FIELD_OFFSET(KEY_VALUE_BASIC_INFORMATION, Name) +
00600                          NameLength;
00601 
00602         minimumlength = FIELD_OFFSET(KEY_VALUE_BASIC_INFORMATION, Name);
00603 
00604         *ResultLength = requiredlength;
00605 
00606         status = STATUS_SUCCESS;
00607 
00608         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00609 
00610             status = STATUS_BUFFER_TOO_SMALL;
00611 
00612         } <span class="keywordflow">else</span> {
00613 
00614             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.TitleIndex = 0;
00615 
00616             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Type =
00617                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00618 
00619             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.NameLength =
00620                 NameLength;
00621 
00622             leftlength = Length - minimumlength;
00623             requiredlength = NameLength;
00624 
00625             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00626                 requiredlength = leftlength;
00627                 status = STATUS_BUFFER_OVERFLOW;
00628             }
00629 
00630             <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00631                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Name,
00632                                       requiredlength,
00633                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00634                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>);
00635             } <span class="keywordflow">else</span> {
00636                 RtlCopyMemory(&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o0">KeyValueBasicInformation</a>.Name[0]),
00637                               &amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>[0]),
00638                               requiredlength);
00639             }
00640         }
00641 
00642         <span class="keywordflow">break</span>;
00643 
00644 
00645 
00646     <span class="keywordflow">case</span> KeyValueFullInformation:
00647     <span class="keywordflow">case</span> KeyValueFullInformationAlign64:
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// TitleIndex, Type, DataOffset, DataLength, NameLength,</span>
00651         <span class="comment">// Name, Data</span>
00652         <span class="comment">//</span>
00653         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00654 
00655         requiredlength = FIELD_OFFSET(KEY_VALUE_FULL_INFORMATION, Name) +
00656                          NameLength +
00657                          realsize;
00658 
00659         minimumlength = FIELD_OFFSET(KEY_VALUE_FULL_INFORMATION, Name);
00660         <span class="keywordflow">if</span> (realsize &gt; 0) {
00661             base = requiredlength - realsize;
00662 
00663 <span class="preprocessor">#if defined(_WIN64)</span>
00664 <span class="preprocessor"></span>
00665             offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base);
00666 
00667 <span class="preprocessor">#else</span>
00668 <span class="preprocessor"></span>
00669             <span class="keywordflow">if</span> (KeyValueInformationClass == KeyValueFullInformationAlign64) {
00670                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base);
00671 
00672             } <span class="keywordflow">else</span> {
00673                 offset = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(base);
00674             }
00675 
00676 <span class="preprocessor">#endif</span>
00677 <span class="preprocessor"></span>
00678             <span class="keywordflow">if</span> (offset &gt; base) {
00679                 requiredlength += (offset - base);
00680             }
00681 
00682 <span class="preprocessor">#if DBG &amp;&amp; defined(_WIN64)</span>
00683 <span class="preprocessor"></span>
00684             <span class="comment">//</span>
00685             <span class="comment">// Some clients will have passed in a structure that they "know"</span>
00686             <span class="comment">// will be exactly the right size.  The fact that alignment</span>
00687             <span class="comment">// has changed on NT64 may cause these clients to have problems.</span>
00688             <span class="comment">//</span>
00689             <span class="comment">// The solution is to fix the client, but print out some debug</span>
00690             <span class="comment">// spew here if it looks like this is the case.  This problem</span>
00691             <span class="comment">// isn't particularly easy to spot from the client end.</span>
00692             <span class="comment">//</span>
00693 
00694             <span class="keywordflow">if</span>((KeyValueInformationClass == KeyValueFullInformation) &amp;&amp;
00695                 (Length != minimumlength) &amp;&amp;
00696                 (requiredlength &gt; Length) &amp;&amp;
00697                 ((requiredlength - Length) &lt;=
00698                                 (<a class="code" href="../../d9/d2/cmsubs2_8c.html#a1">ALIGN_OFFSET64</a>(base) - <a class="code" href="../../d9/d2/cmsubs2_8c.html#a0">ALIGN_OFFSET</a>(base)))) {
00699 
00700                 KdPrint((<span class="stringliteral">"ntos/config-64 KeyValueFullInformation: "</span>
00701                          <span class="stringliteral">"Possible client buffer size problem.\n"</span>));
00702 
00703                 KdPrint((<span class="stringliteral">"    Required size = %d\n"</span>, requiredlength));
00704                 KdPrint((<span class="stringliteral">"    Supplied size = %d\n"</span>, Length));
00705             }
00706 
00707 <span class="preprocessor">#endif</span>
00708 <span class="preprocessor"></span>
00709         }
00710 
00711         *ResultLength = requiredlength;
00712 
00713         status = STATUS_SUCCESS;
00714 
00715         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00716 
00717             status = STATUS_BUFFER_TOO_SMALL;
00718 
00719         } <span class="keywordflow">else</span> {
00720 
00721             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.TitleIndex = 0;
00722 
00723             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Type =
00724                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00725 
00726             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataLength =
00727                 realsize;
00728 
00729             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.NameLength =
00730                 NameLength;
00731 
00732             leftlength = Length - minimumlength;
00733             requiredlength = NameLength;
00734 
00735             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00736                 requiredlength = leftlength;
00737                 status = STATUS_BUFFER_OVERFLOW;
00738             }
00739 
00740             <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>) {
00741                 <a class="code" href="../../d1/d2/cmp_8h.html#a318">CmpCopyCompressedName</a>(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Name,
00742                                       requiredlength,
00743                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
00744                                       pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a>);
00745             } <span class="keywordflow">else</span> {
00746                 RtlMoveMemory(
00747                     &amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.Name[0]),
00748                     &amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>[0]),
00749                     requiredlength
00750                     );
00751             }
00752 
00753             <span class="keywordflow">if</span> (realsize &gt; 0) {
00754 
00755                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00756                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00757                 } <span class="keywordflow">else</span> {
00758                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(Hive, ContainingList, pcell, ValueCached);
00759                 }
00760 
00761                 pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataOffset = offset;
00762 
00763                 leftlength = (((LONG)Length - (LONG)offset) &lt; 0) ?
00764                                     0 :
00765                                     Length - offset;
00766 
00767                 requiredlength = realsize;
00768 
00769                 <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00770                     requiredlength = leftlength;
00771                     status = STATUS_BUFFER_OVERFLOW;
00772                 }
00773 
00774                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= CM_KEY_VALUE_SMALL) : TRUE));
00775 
00776                 RtlMoveMemory(
00777                     ((PUCHAR)pbuffer + offset),
00778                     datapointer,
00779                     requiredlength
00780                     );
00781 
00782             } <span class="keywordflow">else</span> {
00783                 pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o1">KeyValueFullInformation</a>.DataOffset = (ULONG)-1;
00784             }
00785         }
00786 
00787         <span class="keywordflow">break</span>;
00788 
00789 
00790     <span class="keywordflow">case</span> KeyValuePartialInformation:
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">// TitleIndex, Type, DataLength, Data</span>
00794         <span class="comment">//</span>
00795         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00796         requiredlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) +
00797                          realsize;
00798 
00799         minimumlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data);
00800 
00801         *ResultLength = requiredlength;
00802 
00803         status = STATUS_SUCCESS;
00804 
00805         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00806 
00807             status = STATUS_BUFFER_TOO_SMALL;
00808 
00809         } <span class="keywordflow">else</span> {
00810 
00811             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.TitleIndex = 0;
00812 
00813             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.Type =
00814                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00815 
00816             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.DataLength =
00817                 realsize;
00818 
00819             leftlength = Length - minimumlength;
00820             requiredlength = realsize;
00821 
00822             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00823                 requiredlength = leftlength;
00824                 status = STATUS_BUFFER_OVERFLOW;
00825             }
00826 
00827             <span class="keywordflow">if</span> (realsize &gt; 0) {
00828 
00829                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00830                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00831                 } <span class="keywordflow">else</span> {
00832                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(Hive, ContainingList, pcell, ValueCached);
00833                 }
00834 
00835                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= CM_KEY_VALUE_SMALL) : TRUE));
00836 
00837                 RtlMoveMemory((PUCHAR)&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o2">KeyValuePartialInformation</a>.Data[0]),
00838                               datapointer,
00839                               requiredlength);
00840             }
00841         }
00842 
00843         <span class="keywordflow">break</span>;
00844     <span class="keywordflow">case</span> KeyValuePartialInformationAlign64:
00845 
00846         <span class="comment">//</span>
00847         <span class="comment">// TitleIndex, Type, DataLength, Data</span>
00848         <span class="comment">//</span>
00849         small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
00850         requiredlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION_ALIGN64, Data) +
00851                          realsize;
00852 
00853         minimumlength = FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION_ALIGN64, Data);
00854 
00855         *ResultLength = requiredlength;
00856 
00857         status = STATUS_SUCCESS;
00858 
00859         <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00860 
00861             status = STATUS_BUFFER_TOO_SMALL;
00862 
00863         } <span class="keywordflow">else</span> {
00864 
00865             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.Type =
00866                 pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
00867 
00868             pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.DataLength =
00869                 realsize;
00870 
00871             leftlength = Length - minimumlength;
00872             requiredlength = realsize;
00873 
00874             <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00875                 requiredlength = leftlength;
00876                 status = STATUS_BUFFER_OVERFLOW;
00877             }
00878 
00879             <span class="keywordflow">if</span> (realsize &gt; 0) {
00880 
00881                 <span class="keywordflow">if</span> (small == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00882                     datapointer = (PUCHAR)(&amp;(pcell-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>));
00883                 } <span class="keywordflow">else</span> {
00884                     datapointer = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a2">CmpGetValueDataFromCache</a>(Hive, ContainingList, pcell, ValueCached);
00885                 }
00886 
00887                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((small ? (requiredlength &lt;= CM_KEY_VALUE_SMALL) : TRUE));
00888                 RtlMoveMemory((PUCHAR)&amp;(pbuffer-&gt;<a class="code" href="../../d7/d6/union__KEY__VALUE__INFORMATION.html#o3">KeyValuePartialInformationAlign64</a>.Data[0]),
00889                               datapointer,
00890                               requiredlength);
00891             }
00892         }
00893 
00894         <span class="keywordflow">break</span>;
00895 
00896     <span class="keywordflow">default</span>:
00897         status = STATUS_INVALID_PARAMETER;
00898         <span class="keywordflow">break</span>;
00899     }
00900     <span class="keywordflow">return</span> status;
00901 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
