<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: qsinfo.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>qsinfo.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d0/d2/qsinfo_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/qsinfo_8c.html#a0">FSIO_A</a>&nbsp;&nbsp;&nbsp;FILE_SYNCHRONOUS_IO_ALERT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/qsinfo_8c.html#a1">FSIO_NA</a>&nbsp;&nbsp;&nbsp;FILE_SYNCHRONOUS_IO_NONALERT</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/qsinfo_8c.html#a2">IopGetModeInformation</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/qsinfo_8c.html#a3">NtQueryInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, OUT PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a> (IN HANDLE FileHandle, OUT PIO_STATUS_BLOCK IoStatusBlock, IN PVOID FileInformation, IN ULONG Length, IN FILE_INFORMATION_CLASS FileInformationClass)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="qsinfo.c::FSIO_A" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSIO_A&nbsp;&nbsp;&nbsp;FILE_SYNCHRONOUS_IO_ALERT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00034">34</a> of file <a class="el" href="../../d0/d2/qsinfo_8c-source.html">qsinfo.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="qsinfo.c::FSIO_NA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FSIO_NA&nbsp;&nbsp;&nbsp;FILE_SYNCHRONOUS_IO_NONALERT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00035">35</a> of file <a class="el" href="../../d0/d2/qsinfo_8c-source.html">qsinfo.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="qsinfo.c::IopGetModeInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopGetModeInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00054">54</a> of file <a class="el" href="../../d0/d2/qsinfo_8c-source.html">qsinfo.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01506">FO_DELETE_ON_CLOSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01493">FO_NO_INTERMEDIATE_BUFFERING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01495">FO_SEQUENTIAL_ONLY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>.
<p>
Referenced by <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">NtQueryInformationFile()</a>.
<p>
<pre class="fragment"><div>00060                    :
00061 
00062     This encapsulates extracting and translating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode bits from
00063     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, to be returned from a query information call.
00064 
00065 Arguments:
00066 
00067     FileObject - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">for</span> which to <span class="keywordflow">return</span> Mode info.
00068 
00069 Return Value:
00070 
00071     The translated mode information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00072 
00073 --*/
00074 
00075 {
00076     ULONG mode = 0;
00077 
00078     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a>) {
00079         mode = FILE_WRITE_THROUGH;
00080     }
00081     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a155">FO_SEQUENTIAL_ONLY</a>) {
00082         mode |= FILE_SEQUENTIAL_ONLY;
00083     }
00084     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a>) {
00085         mode |= FILE_NO_INTERMEDIATE_BUFFERING;
00086     }
00087     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00088         <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>) {
00089             mode |= FILE_SYNCHRONOUS_IO_ALERT;
00090         } <span class="keywordflow">else</span> {
00091             mode |= FILE_SYNCHRONOUS_IO_NONALERT;
00092         }
00093     }
00094     <span class="keywordflow">if</span> (FileObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a166">FO_DELETE_ON_CLOSE</a>) {
00095         mode |= FILE_DELETE_ON_CLOSE;
00096     }
00097     <span class="keywordflow">return</span> mode;
00098 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="qsinfo.c::NtQueryInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00101">101</a> of file <a class="el" href="../../d0/d2/qsinfo_8c-source.html">qsinfo.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01194">_DEVICE_OBJECT::AlignmentRequirement</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01403">_DRIVER_OBJECT::FastIoDispatch</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00946">_FAST_IO_DISPATCH::FastIoQueryBasicInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00947">_FAST_IO_DISPATCH::FastIoQueryStandardInfo</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00057">_OBJECT_HANDLE_INFORMATION::GrantedAccess</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00054">IopGetModeInformation()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00511">IopQueryOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00358">IopQueryOperationLength</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00460">IopQuerySetAlignmentRequirement</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">LdrVerifyImageMatchesChecksum()</a>, <a class="el" href="../../d0/d8/uexec2_8c-source.html#l00026">main()</a>, <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00259">RegLoadAsciiFileAsUnicode()</a>, and <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00158">RegReadBinaryFile()</a>.
<p>
<pre class="fragment"><div>00111                    :
00112 
00113     This service returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information about a specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00114     The information returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformationClass that
00115     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> placed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's FileInformation buffer.
00116 
00117 Arguments:
00118 
00119     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> about which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
00120         information should be returned.
00121 
00122     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00123 
00124     FileInformation - Supplies a buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information
00125         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00126 
00127     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00128 
00129     FileInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
00130         returned about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00131 
00132 Return Value:
00133 
00134     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00135 
00136 --*/
00137 
00138 {
00139     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00140     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00141     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00142     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00143     <a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html">PFAST_IO_DISPATCH</a> fastIoDispatch;
00144     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00146     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00147     IO_STATUS_BLOCK localIoStatus;
00148     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> handleInformation;
00149     BOOLEAN synchronousIo;
00150     BOOLEAN skipDriver;
00151 
00152     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00156     <span class="comment">//</span>
00157 
00158     requestorMode = KeGetPreviousMode();
00159 
00160     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00161 
00162         <span class="comment">//</span>
00163         <span class="comment">// Ensure that the FileInformationClass parameter is legal for querying</span>
00164         <span class="comment">// information about the file.</span>
00165         <span class="comment">//</span>
00166 
00167         <span class="keywordflow">if</span> ((ULONG) FileInformationClass &gt;= FileMaximumInformation ||
00168             !<a class="code" href="../../d3/d5/iodata_8c.html#a63">IopQueryOperationLength</a>[FileInformationClass]) {
00169             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00170         }
00171 
00172         <span class="comment">//</span>
00173         <span class="comment">// Ensure that the supplied buffer is large enough to contain the</span>
00174         <span class="comment">// information associated with the specified set operation that is</span>
00175         <span class="comment">// to be performed.</span>
00176         <span class="comment">//</span>
00177 
00178         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a63">IopQueryOperationLength</a>[FileInformationClass]) {
00179             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00180         }
00181 
00182         <span class="comment">//</span>
00183         <span class="comment">// The caller's access mode is not kernel so probe each of the arguments</span>
00184         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00185         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00186         <span class="comment">// return an access violation status code back to the system service</span>
00187         <span class="comment">// dispatcher.</span>
00188         <span class="comment">//</span>
00189 
00190         <span class="keywordflow">try</span> {
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00194             <span class="comment">//</span>
00195 
00196             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00197 
00198             <span class="comment">//</span>
00199             <span class="comment">// The FileInformation buffer must be writeable by the caller.</span>
00200             <span class="comment">//</span>
00201 
00202 <span class="preprocessor">#if defined(_X86_)</span>
00203 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00204 <span class="preprocessor">#elif defined(_WIN64)</span>
00205 <span class="preprocessor"></span>
00206             <span class="comment">//</span>
00207             <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00208             <span class="comment">//</span>
00209 
00210             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00211                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation, Length, <span class="keyword">sizeof</span>( ULONG ) );
00212             } <span class="keywordflow">else</span> {
00213                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00214                                Length,
00215                                IopQuerySetAlignmentRequirement[FileInformationClass] );
00216             }
00217 <span class="preprocessor">#else</span>
00218 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( FileInformation,
00219                            Length,
00220                            IopQuerySetAlignmentRequirement[FileInformationClass] );
00221 <span class="preprocessor">#endif</span>
00222 <span class="preprocessor"></span>
00223         } except(EXCEPTION_EXECUTE_HANDLER) {
00224 
00225             <span class="comment">//</span>
00226             <span class="comment">// An exception was incurred while probing the caller's</span>
00227             <span class="comment">// parameters.  Simply return an appropriate error status</span>
00228             <span class="comment">// code.</span>
00229             <span class="comment">//</span>
00230 
00231 <span class="preprocessor">#if DBG</span>
00232 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_DATATYPE_MISALIGNMENT) {
00233                 DbgBreakPoint();
00234             }
00235 <span class="preprocessor">#endif // DBG</span>
00236 <span class="preprocessor"></span>
00237             <span class="keywordflow">return</span> GetExceptionCode();
00238         }
00239 
00240 <span class="preprocessor">#if DBG</span>
00241 <span class="preprocessor"></span>
00242     } <span class="keywordflow">else</span> {
00243 
00244         <span class="comment">//</span>
00245         <span class="comment">// The caller's mode is kernel.  Ensure that at least the information</span>
00246         <span class="comment">// class and lengths are appropriate.</span>
00247         <span class="comment">//</span>
00248 
00249         <span class="keywordflow">if</span> ((ULONG) FileInformationClass &gt;= FileMaximumInformation ||
00250             !<a class="code" href="../../d3/d5/iodata_8c.html#a63">IopQueryOperationLength</a>[FileInformationClass]) {
00251             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00252         }
00253 
00254         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a63">IopQueryOperationLength</a>[FileInformationClass]) {
00255             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00256         }
00257 
00258 <span class="preprocessor">#endif // DBG</span>
00259 <span class="preprocessor"></span>
00260     }
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
00264     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
00265     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
00266     <span class="comment">// access to the file, then it will fail.</span>
00267     <span class="comment">//</span>
00268 
00269     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
00270                                         IopQueryOperationAccess[FileInformationClass],
00271                                         IoFileObjectType,
00272                                         requestorMode,
00273                                         (PVOID *) &amp;fileObject,
00274                                         &amp;handleInformation);
00275 
00276     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00277         <span class="keywordflow">return</span> status;
00278     }
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">// Get the address of the target device object.  If this file represents</span>
00282     <span class="comment">// a device that was opened directly, then simply use the device or its</span>
00283     <span class="comment">// attached device(s) directly.  Also get the address of the Fast Io</span>
00284     <span class="comment">// dispatch structure.</span>
00285     <span class="comment">//</span>
00286 
00287     <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
00288         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
00289     } <span class="keywordflow">else</span> {
00290         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
00291     }
00292     fastIoDispatch = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o10">FastIoDispatch</a>;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
00296     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
00297     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
00298     <span class="comment">// operation, then allocate and initialize the local event.</span>
00299     <span class="comment">//</span>
00300 
00301     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
00302 
00303         BOOLEAN interrupted;
00304 
00305         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
00306             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
00307                                                requestorMode,
00308                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00309                                                &amp;interrupted );
00310             <span class="keywordflow">if</span> (interrupted) {
00311                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00312                 <span class="keywordflow">return</span> status;
00313             }
00314         }
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Make a special check here to determine whether or not the caller</span>
00318         <span class="comment">// is attempting to query the file position pointer.  If so, then</span>
00319         <span class="comment">// return it immediately and get out.</span>
00320         <span class="comment">//</span>
00321 
00322         <span class="keywordflow">if</span> (FileInformationClass == FilePositionInformation) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// The caller has requested the current file position context</span>
00326             <span class="comment">// information.  This is a relatively frequent call, so it is</span>
00327             <span class="comment">// optimized here to cut through the normal IRP path.</span>
00328             <span class="comment">//</span>
00329             <span class="comment">// Begin by establishing a condition handler and attempting to</span>
00330             <span class="comment">// return both the file position information as well as the I/O</span>
00331             <span class="comment">// status block.  If writing the output buffer fails, then return</span>
00332             <span class="comment">// an appropriate error status code.  If writing the I/O status</span>
00333             <span class="comment">// block fails, then ignore the error.  This is what would</span>
00334             <span class="comment">// normally happen were everything to go through normal special</span>
00335             <span class="comment">// kernel APC processing.</span>
00336             <span class="comment">//</span>
00337 
00338             BOOLEAN writingBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00339             PFILE_POSITION_INFORMATION fileInformation = FileInformation;
00340 
00341             <span class="keywordflow">try</span> {
00342 
00343                 <span class="comment">//</span>
00344                 <span class="comment">// Return the current position information.</span>
00345                 <span class="comment">//</span>
00346 
00347                 fileInformation-&gt;CurrentByteOffset = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>;
00348                 writingBuffer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00349 
00350                 <span class="comment">//</span>
00351                 <span class="comment">// Write the I/O status block.</span>
00352                 <span class="comment">//</span>
00353 
00354                 IoStatusBlock-&gt;Status = STATUS_SUCCESS;
00355                 IoStatusBlock-&gt;Information = <span class="keyword">sizeof</span>( FILE_POSITION_INFORMATION );
00356 
00357             } except( EXCEPTION_EXECUTE_HANDLER ) {
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">// One of writing the caller's buffer or writing the I/O</span>
00361                 <span class="comment">// status block failed.  Set the final status appropriately.</span>
00362                 <span class="comment">//</span>
00363 
00364                 <span class="keywordflow">if</span> (writingBuffer) {
00365                     status = GetExceptionCode();
00366                 }
00367 
00368             }
00369 
00370             <span class="comment">//</span>
00371             <span class="comment">// Note that the state of the event in the file object has not yet</span>
00372             <span class="comment">// been reset, so it need not be set either.  Therefore, simply</span>
00373             <span class="comment">// cleanup and return.</span>
00374             <span class="comment">//</span>
00375 
00376             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00377             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00378             <span class="keywordflow">return</span> status;
00379 
00380         <span class="comment">//</span>
00381         <span class="comment">// Also do a special check if the caller it doing a query for basic or</span>
00382         <span class="comment">// standard information and if so then try the fast query calls if they</span>
00383         <span class="comment">// exist.</span>
00384         <span class="comment">//</span>
00385 
00386         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fastIoDispatch &amp;&amp;
00387                    (((FileInformationClass == FileBasicInformation) &amp;&amp;
00388                      fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o4">FastIoQueryBasicInfo</a>) ||
00389                     ((FileInformationClass == FileStandardInformation) &amp;&amp;
00390                      fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a>))) {
00391 
00392             IO_STATUS_BLOCK localIoStatus;
00393             BOOLEAN queryResult = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00394             BOOLEAN writingStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00395 
00396             <span class="comment">//</span>
00397             <span class="comment">// Do the query and setting of the IoStatusBlock inside an exception</span>
00398             <span class="comment">// handler.  Note that if an exception occurs, other than writing</span>
00399             <span class="comment">// the status back, then the IRP route will be taken.  If an error</span>
00400             <span class="comment">// occurs attempting to write the status back to the caller's buffer</span>
00401             <span class="comment">// then it will be ignored, just as it would be on the long path.</span>
00402             <span class="comment">//</span>
00403 
00404             <span class="keywordflow">try</span> {
00405 
00406                 <span class="keywordflow">if</span> (FileInformationClass == FileBasicInformation) {
00407                     queryResult = fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o4">FastIoQueryBasicInfo</a>( fileObject,
00408                                                                         TRUE,
00409                                                                         FileInformation,
00410                                                                         &amp;localIoStatus,
00411                                                                         deviceObject );
00412                 } <span class="keywordflow">else</span> {
00413                     queryResult = fastIoDispatch-&gt;<a class="code" href="../../d5/d9/struct__FAST__IO__DISPATCH.html#o5">FastIoQueryStandardInfo</a>( fileObject,
00414                                                                            TRUE,
00415                                                                            FileInformation,
00416                                                                            &amp;localIoStatus,
00417                                                                            deviceObject );
00418                 }
00419 
00420                 <span class="keywordflow">if</span> (queryResult) {
00421                     status = localIoStatus.Status;
00422                     writingStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423                     *IoStatusBlock = localIoStatus;
00424                 }
00425 
00426             } except( EXCEPTION_EXECUTE_HANDLER ) {
00427 
00428                 <span class="comment">//</span>
00429                 <span class="comment">// If the result of the preceeding block is an exception that</span>
00430                 <span class="comment">// occurred after the Fast I/O path itself, then the query</span>
00431                 <span class="comment">// actually succeeded so everything is done already, but the</span>
00432                 <span class="comment">// user's I/O status buffer is not writable.  This case is</span>
00433                 <span class="comment">// ignored to be consistent w/the long path.</span>
00434                 <span class="comment">//</span>
00435 
00436                 <span class="keywordflow">if</span> (!writingStatus) {
00437                     status = GetExceptionCode();
00438                 }
00439             }
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// If the results of the preceeding statement block is true, then</span>
00443             <span class="comment">// the fast query call succeeeded, so simply cleanup and return.</span>
00444             <span class="comment">//</span>
00445 
00446             <span class="keywordflow">if</span> (queryResult) {
00447 
00448                 <span class="comment">//</span>
00449                 <span class="comment">// Note that once again, the event in the file object has not</span>
00450                 <span class="comment">// yet been set reset, so it need not be set to the Signaled</span>
00451                 <span class="comment">// state, so simply cleanup and return.</span>
00452                 <span class="comment">//</span>
00453 
00454                 <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00455                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00456                 <span class="keywordflow">return</span> status;
00457             }
00458         }
00459         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00460     } <span class="keywordflow">else</span> {
00461 
00462         <span class="comment">//</span>
00463         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
00464         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
00465         <span class="comment">// to synchronize the completion of the operation before returning</span>
00466         <span class="comment">// to the caller.  A local event is used to do this.</span>
00467         <span class="comment">//</span>
00468 
00469         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
00470         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00471             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
00472             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00473         }
00474         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
00475         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00476     }
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// Set the file object to the Not-Signaled state.</span>
00480     <span class="comment">//</span>
00481 
00482     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
00486     <span class="comment">// The allocation is performed with an exception handler in case the</span>
00487     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
00488     <span class="comment">//</span>
00489 
00490     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
00491     <span class="keywordflow">if</span> (!irp) {
00492 
00493         <span class="comment">//</span>
00494         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
00495         <span class="comment">// error status code.</span>
00496         <span class="comment">//</span>
00497 
00498         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
00499             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00500         }
00501 
00502         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
00503 
00504         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00505     }
00506     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
00507     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00508     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
00509 
00510     <span class="comment">//</span>
00511     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
00512     <span class="comment">//</span>
00513 
00514     <span class="keywordflow">if</span> (synchronousIo) {
00515         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00516         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00517     } <span class="keywordflow">else</span> {
00518         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
00519         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
00520         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
00521     }
00522     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00523 
00524     <span class="comment">//</span>
00525     <span class="comment">// Get a pointer to the stack location for the first driver.  This will be</span>
00526     <span class="comment">// used to pass the original function codes and parameters.</span>
00527     <span class="comment">//</span>
00528 
00529     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00530     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a>;
00531     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// Allocate a buffer which should be used to put the information into by</span>
00535     <span class="comment">// the driver.  This will be copied back to the caller's buffer when the</span>
00536     <span class="comment">// service completes.  This is done by setting the flag which says that</span>
00537     <span class="comment">// this is an input operation.</span>
00538     <span class="comment">//</span>
00539 
00540     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> = FileInformation;
00541     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00542     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00543 
00544     <span class="keywordflow">try</span> {
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">// Allocate the system buffer using an exception handler so that</span>
00548         <span class="comment">// errors can be caught and handled.</span>
00549         <span class="comment">//</span>
00550 
00551         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
00552                                                                    Length );
00553     } except(EXCEPTION_EXECUTE_HANDLER) {
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">// An exception was incurred by attempting to allocate the intermediary</span>
00557         <span class="comment">// system buffer.  Cleanup everything and return an appropriate error</span>
00558         <span class="comment">// status code.</span>
00559         <span class="comment">//</span>
00560 
00561         <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
00562                              irp,
00563                              (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
00564                              event );
00565 
00566         <span class="keywordflow">return</span> GetExceptionCode();
00567     }
00568 
00569     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> |
00570                   <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> |
00571                   <a class="code" href="../../d0/d5/io_8h.html#a180">IRP_INPUT_OPERATION</a> |
00572                   <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
00576     <span class="comment">// IRP.</span>
00577     <span class="comment">//</span>
00578 
00579     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length = Length;
00580     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass = FileInformationClass;
00581 
00582     <span class="comment">//</span>
00583     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
00584     <span class="comment">//</span>
00585 
00586     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// Update the operation count statistic for the current process for</span>
00590     <span class="comment">// operations other than read and write.</span>
00591     <span class="comment">//</span>
00592 
00593     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
00594 
00595     <span class="comment">//</span>
00596     <span class="comment">// Everything is now set to invoke the device driver with this request.</span>
00597     <span class="comment">// However, it is possible that the information that the caller wants</span>
00598     <span class="comment">// is device independent.  If this is the case, then the request can</span>
00599     <span class="comment">// be satisfied here without having to have all of the drivers implement</span>
00600     <span class="comment">// the same code.  Note that having the IRP is still necessary since</span>
00601     <span class="comment">// the I/O completion code requires it.</span>
00602     <span class="comment">//</span>
00603 
00604     skipDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00605 
00606     <span class="keywordflow">if</span> (FileInformationClass == FileAccessInformation) {
00607 
00608         PFILE_ACCESS_INFORMATION accessBuffer = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00609 
00610         <span class="comment">//</span>
00611         <span class="comment">// Return the access information for this file.</span>
00612         <span class="comment">//</span>
00613 
00614         accessBuffer-&gt;AccessFlags = handleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
00615 
00616         <span class="comment">//</span>
00617         <span class="comment">// Complete the I/O operation.</span>
00618         <span class="comment">//</span>
00619 
00620         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( FILE_ACCESS_INFORMATION );
00621         skipDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00622 
00623     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileModeInformation) {
00624 
00625         PFILE_MODE_INFORMATION modeBuffer = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00626 
00627         <span class="comment">//</span>
00628         <span class="comment">// Return the mode information for this file.</span>
00629         <span class="comment">//</span>
00630 
00631         modeBuffer-&gt;Mode = <a class="code" href="../../d9/d2/qsinfo_8c.html#a2">IopGetModeInformation</a>( fileObject );
00632 
00633         <span class="comment">//</span>
00634         <span class="comment">// Complete the I/O operation.</span>
00635         <span class="comment">//</span>
00636 
00637         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( FILE_MODE_INFORMATION );
00638         skipDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00639 
00640     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileAlignmentInformation) {
00641 
00642         PFILE_ALIGNMENT_INFORMATION alignmentInformation = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00643 
00644         <span class="comment">//</span>
00645         <span class="comment">// Return the alignment information for this file.</span>
00646         <span class="comment">//</span>
00647 
00648         alignmentInformation-&gt;AlignmentRequirement = deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o17">AlignmentRequirement</a>;
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Complete the I/O operation.</span>
00652         <span class="comment">//</span>
00653 
00654         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( FILE_ALIGNMENT_INFORMATION );
00655         skipDriver = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00656 
00657     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileAllInformation) {
00658 
00659         PFILE_ALL_INFORMATION allInformation = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00660 
00661         <span class="comment">//</span>
00662         <span class="comment">// The caller has requested all of the information about the file.</span>
00663         <span class="comment">// This request is handled specially because the service will fill</span>
00664         <span class="comment">// in the Access and Mode and Alignment information in the buffer</span>
00665         <span class="comment">// and then pass the buffer to the driver to fill in the remainder.</span>
00666         <span class="comment">//</span>
00667         <span class="comment">// Begin by returning the Access information for the file.</span>
00668         <span class="comment">//</span>
00669 
00670         allInformation-&gt;AccessInformation.AccessFlags =
00671             handleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o1">GrantedAccess</a>;
00672 
00673         <span class="comment">//</span>
00674         <span class="comment">// Return the mode information for this file.</span>
00675         <span class="comment">//</span>
00676 
00677         allInformation-&gt;ModeInformation.Mode =
00678             <a class="code" href="../../d9/d2/qsinfo_8c.html#a2">IopGetModeInformation</a>( fileObject );
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">// Return the alignment information for this file.</span>
00682         <span class="comment">//</span>
00683 
00684         allInformation-&gt;AlignmentInformation.AlignmentRequirement =
00685             deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o17">AlignmentRequirement</a>;
00686 
00687         <span class="comment">//</span>
00688         <span class="comment">// Finally, set the information field of the IoStatus block in the IRP</span>
00689         <span class="comment">// to account for the amount information already filled in and invoke</span>
00690         <span class="comment">// the driver to fill in the remainder.</span>
00691         <span class="comment">//</span>
00692 
00693         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( FILE_ACCESS_INFORMATION ) +
00694                                     <span class="keyword">sizeof</span>( FILE_MODE_INFORMATION ) +
00695                                     <span class="keyword">sizeof</span>( FILE_ALIGNMENT_INFORMATION );
00696     }
00697 
00698     <span class="keywordflow">if</span> (skipDriver) {
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">// The requested operation has already been performed.  Simply</span>
00702         <span class="comment">// set the final status in the packet and the return state.</span>
00703         <span class="comment">//</span>
00704 
00705         status = STATUS_SUCCESS;
00706         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
00707 
00708     } <span class="keywordflow">else</span> {
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">// This is not a request that can be [completely] performed here, so</span>
00712         <span class="comment">// invoke the driver at its appropriate dispatch entry with the IRP.</span>
00713         <span class="comment">//</span>
00714 
00715         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
00720     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
00721     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
00722     <span class="comment">// and obtain the final status from the file object itself.</span>
00723     <span class="comment">//</span>
00724 
00725     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
00726 
00727         <span class="keywordflow">if</span> (synchronousIo) {
00728 
00729             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
00730                                             Executive,
00731                                             requestorMode,
00732                                             (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
00733                                             (PLARGE_INTEGER) NULL );
00734 
00735             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
00736 
00737                 <span class="comment">//</span>
00738                 <span class="comment">// The wait request has ended either because the thread was</span>
00739                 <span class="comment">// alerted or an APC was queued to this thread, because of</span>
00740                 <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
00741                 <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
00742                 <span class="comment">// completes before this routine exists so that synchronization</span>
00743                 <span class="comment">// with the file object will remain intact.</span>
00744                 <span class="comment">//</span>
00745 
00746                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, irp );
00747 
00748             }
00749 
00750             status = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a>;
00751 
00752             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00753 
00754         } <span class="keywordflow">else</span> {
00755 
00756             <span class="comment">//</span>
00757             <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
00758             <span class="comment">// serialized synchronous I/O operation.  For this case, wait for</span>
00759             <span class="comment">// the local event and copy the final status information back to</span>
00760             <span class="comment">// the caller.</span>
00761             <span class="comment">//</span>
00762 
00763             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( event,
00764                                             Executive,
00765                                             requestorMode,
00766                                             FALSE,
00767                                             (PLARGE_INTEGER) NULL );
00768 
00769             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
00770 
00771                 <span class="comment">//</span>
00772                 <span class="comment">// The wait request has ended either because the thread was</span>
00773                 <span class="comment">// alerted or an APC was queued to this thread, because of</span>
00774                 <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
00775                 <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
00776                 <span class="comment">// completes before this routine exists or the event will not</span>
00777                 <span class="comment">// be around to set to the Signaled state.</span>
00778                 <span class="comment">//</span>
00779 
00780                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( event, irp );
00781 
00782             }
00783 
00784             status = localIoStatus.Status;
00785 
00786             <span class="keywordflow">try</span> {
00787 
00788                 *IoStatusBlock = localIoStatus;
00789 
00790             } except(EXCEPTION_EXECUTE_HANDLER) {
00791 
00792                 <span class="comment">//</span>
00793                 <span class="comment">// An exception occurred attempting to write the caller's I/O</span>
00794                 <span class="comment">// status block.  Simply change the final status of the operation</span>
00795                 <span class="comment">// to the exception code.</span>
00796                 <span class="comment">//</span>
00797 
00798                 status = GetExceptionCode();
00799             }
00800 
00801             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00802 
00803         }
00804 
00805     } <span class="keywordflow">else</span> {
00806 
00807         <span class="comment">//</span>
00808         <span class="comment">// The I/O operation finished without return a status of pending.</span>
00809         <span class="comment">// This means that the operation has not been through I/O completion,</span>
00810         <span class="comment">// so it must be done here.</span>
00811         <span class="comment">//</span>
00812 
00813         <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> normalRoutine;
00814         PVOID normalContext;
00815         KIRQL irql;
00816 
00817         <span class="keywordflow">if</span> (!synchronousIo) {
00818 
00819             <span class="comment">//</span>
00820             <span class="comment">// This is not a synchronous I/O operation, it is a synchronous</span>
00821             <span class="comment">// I/O API to a file opened for asynchronous I/O.  Since this</span>
00822             <span class="comment">// code path need never wait on the allocated and supplied event,</span>
00823             <span class="comment">// get rid of it so that it doesn't have to be set to the</span>
00824             <span class="comment">// Signaled state by the I/O completion code.</span>
00825             <span class="comment">//</span>
00826 
00827             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
00829         }
00830 
00831         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
00832         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
00833         <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
00834                             &amp;normalRoutine,
00835                             &amp;normalContext,
00836                             (PVOID *) &amp;fileObject,
00837                             &amp;normalContext );
00838         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
00839 
00840         <span class="keywordflow">if</span> (synchronousIo) {
00841             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
00842         }
00843     }
00844 
00845     <span class="keywordflow">return</span> status;
00846 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="qsinfo.c::NtSetInformationFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationFile           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>FileHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN FILE_INFORMATION_CLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>FileInformationClass</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">849</a> of file <a class="el" href="../../d0/d2/qsinfo_8c-source.html">qsinfo.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00127">ExAllocatePoolWithQuota</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01492">FO_ALERTABLE_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01501">FO_DIRECT_DEVICE_OPEN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01493">FO_NO_INTERMEDIATE_BUFFERING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01495">FO_SEQUENTIAL_ONLY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01494">FO_WRITE_THROUGH</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00034">FSIO_A</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00035">FSIO_NA</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00652">IoAllocateIrp()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00234">IoCompletionObjectType</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06786">IoGetAttachedDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07247">IoGetRelatedDeviceObject()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00595">IopAcquireFastLock</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00181">IopAcquireFileObjectLock()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00284">IopAllocateIrpCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00417">IopCancelAlertedRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01934">IopExceptionCleanup()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">IopOpenLinkOrRenameTarget()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00460">IopQuerySetAlignmentRequirement</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01103">IopQueueThreadIrp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l01157">IopReleaseFileObjectLock</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00562">IopSetOperationAccess</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00409">IopSetOperationLength</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l07272">IopTrackLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12345">IopUpdateOtherOperationCount()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l12441">IopUpdateOtherTransferCount()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01554">IRP_BUFFERED_IO</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01564">IRP_DEFER_IO_COMPLETION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01552">IRP_SYNCHRONOUS_API</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01483">_IO_COMPLETION_CONTEXT::Key</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01482">_IO_COMPLETION_CONTEXT::Port</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01498">ProbeForWriteIoStatus</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01207">_DEVICE_OBJECT::SectorSize</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01189">_DEVICE_OBJECT::StackSize</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d6/d4/rdwr_8c-source.html#l00050">NTFastDOSIO()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l00600">RtlSetIoCompletionCallback()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01582">SepClientOpenPipe()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00861">ZwSetInformationFile()</a>.
<p>
<pre class="fragment"><div>00859                    :
00860 
00861     This service changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> provided information about a specified <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  The
00862     information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> changed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformationClass that
00863     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.  The <span class="keyword">new</span> information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> taken from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00864 
00865 Arguments:
00866 
00867     FileHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> whose information should be
00868         changed.
00869 
00870     IoStatusBlock - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's I/O status block.
00871 
00872     FileInformation - Supplies a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information which should
00873         be changed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00874 
00875     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileInformation buffer.
00876 
00877     FileInformationClass - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information which should be
00878         changed about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00879 
00880 Return Value:
00881 
00882     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00883 
00884 --*/
00885 
00886 {
00887     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00889     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> fileObject;
00890     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
00891     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00892     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> requestorMode;
00893     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00894     IO_STATUS_BLOCK localIoStatus;
00895     HANDLE targetHandle = (HANDLE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00896     BOOLEAN synchronousIo;
00897 
00898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Get the previous mode;  i.e., the mode of the caller.</span>
00902     <span class="comment">//</span>
00903 
00904     requestorMode = KeGetPreviousMode();
00905 
00906     <span class="keywordflow">if</span> (requestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00907 
00908         <span class="comment">//</span>
00909         <span class="comment">// Ensure that the FileInformationClass parameter is legal for setting</span>
00910         <span class="comment">// information about the file.</span>
00911         <span class="comment">//</span>
00912 
00913         <span class="keywordflow">if</span> ((ULONG) FileInformationClass &gt;= FileMaximumInformation ||
00914             !<a class="code" href="../../d3/d5/iodata_8c.html#a64">IopSetOperationLength</a>[FileInformationClass]) {
00915             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00916         }
00917 
00918         <span class="comment">//</span>
00919         <span class="comment">// Ensure that the supplied buffer is large enough to contain the</span>
00920         <span class="comment">// information associated with the specified set operation that is</span>
00921         <span class="comment">// to be performed.</span>
00922         <span class="comment">//</span>
00923 
00924         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a64">IopSetOperationLength</a>[FileInformationClass]) {
00925             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00926         }
00927 
00928         <span class="comment">//</span>
00929         <span class="comment">// The caller's access mode is user, so probe each of the arguments</span>
00930         <span class="comment">// and capture them as necessary.  If any failures occur, the condition</span>
00931         <span class="comment">// handler will be invoked to handle them.  It will simply cleanup and</span>
00932         <span class="comment">// return an access violation status code back to the system service</span>
00933         <span class="comment">// dispatcher.</span>
00934         <span class="comment">//</span>
00935 
00936         <span class="keywordflow">try</span> {
00937 
00938             <span class="comment">//</span>
00939             <span class="comment">// The IoStatusBlock parameter must be writeable by the caller.</span>
00940             <span class="comment">//</span>
00941 
00942             <a class="code" href="../../d5/d8/ex_8h.html#a31">ProbeForWriteIoStatus</a>( IoStatusBlock );
00943 
00944             <span class="comment">//</span>
00945             <span class="comment">// The FileInformation buffer must be readable by the caller.</span>
00946             <span class="comment">//</span>
00947 
00948 <span class="preprocessor">#if defined(_X86_)</span>
00949 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FileInformation,
00950                           Length,
00951                           Length == <span class="keyword">sizeof</span>( BOOLEAN ) ? <span class="keyword">sizeof</span>( BOOLEAN ) : <span class="keyword">sizeof</span>( ULONG ) );
00952 <span class="preprocessor">#elif defined(_WIN64)</span>
00953 <span class="preprocessor"></span>            <span class="comment">// If we are a wow64 process, follow the X86 rules</span>
00954             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Wow64Process) {
00955                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FileInformation,
00956                               Length,
00957                               Length == <span class="keyword">sizeof</span>( BOOLEAN ) ? <span class="keyword">sizeof</span>( BOOLEAN ) : <span class="keyword">sizeof</span>( ULONG ) );
00958             }
00959             <span class="keywordflow">else</span> {
00960                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FileInformation,
00961                               Length,
00962                               IopQuerySetAlignmentRequirement[FileInformationClass] );
00963             }
00964 <span class="preprocessor">#else</span>
00965 <span class="preprocessor"></span>            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( FileInformation,
00966                           Length,
00967                           IopQuerySetAlignmentRequirement[FileInformationClass] );
00968 <span class="preprocessor">#endif</span>
00969 <span class="preprocessor"></span>
00970         } except(EXCEPTION_EXECUTE_HANDLER) {
00971 
00972             <span class="comment">//</span>
00973             <span class="comment">// An exception was incurred while probing the caller's parameters.</span>
00974             <span class="comment">// Simply return an appropriate error status code.</span>
00975             <span class="comment">//</span>
00976 
00977 <span class="preprocessor">#if DBG</span>
00978 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (GetExceptionCode() == STATUS_DATATYPE_MISALIGNMENT) {
00979                 DbgBreakPoint();
00980             }
00981 <span class="preprocessor">#endif // DBG</span>
00982 <span class="preprocessor"></span>
00983             <span class="keywordflow">return</span> GetExceptionCode();
00984 
00985         }
00986 
00987 <span class="preprocessor">#if DBG</span>
00988 <span class="preprocessor"></span>
00989     } <span class="keywordflow">else</span> {
00990 
00991         <span class="comment">//</span>
00992         <span class="comment">// The caller's mode is kernel.  Ensure that at least the information</span>
00993         <span class="comment">// class and lengths are appropriate.</span>
00994         <span class="comment">//</span>
00995 
00996         <span class="keywordflow">if</span> ((ULONG) FileInformationClass &gt;= FileMaximumInformation ||
00997             !<a class="code" href="../../d3/d5/iodata_8c.html#a64">IopSetOperationLength</a>[FileInformationClass]) {
00998             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00999         }
01000 
01001         <span class="keywordflow">if</span> (Length &lt; (ULONG) <a class="code" href="../../d3/d5/iodata_8c.html#a64">IopSetOperationLength</a>[FileInformationClass]) {
01002             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01003         }
01004 
01005 <span class="preprocessor">#endif // DBG</span>
01006 <span class="preprocessor"></span>
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">// There were no blatant errors so far, so reference the file object so</span>
01011     <span class="comment">// the target device object can be found.  Note that if the handle does</span>
01012     <span class="comment">// not refer to a file object, or if the caller does not have the required</span>
01013     <span class="comment">// access to the file, then it will fail.</span>
01014     <span class="comment">//</span>
01015 
01016     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( FileHandle,
01017                                         IopSetOperationAccess[FileInformationClass],
01018                                         IoFileObjectType,
01019                                         requestorMode,
01020                                         (PVOID *) &amp;fileObject,
01021                                         NULL );
01022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01023         <span class="keywordflow">return</span> status;
01024     }
01025 
01026     <span class="comment">//</span>
01027     <span class="comment">// Get the address of the target device object.  If this file represents</span>
01028     <span class="comment">// a device that was opened directly, then simply use the device or its</span>
01029     <span class="comment">// attached device(s) directly.</span>
01030     <span class="comment">//</span>
01031 
01032     <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a161">FO_DIRECT_DEVICE_OPEN</a>)) {
01033         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>( fileObject );
01034     } <span class="keywordflow">else</span> {
01035         deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>( fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a> );
01036     }
01037 
01038     <span class="comment">//</span>
01039     <span class="comment">// Make a special check here to determine whether this is a synchronous</span>
01040     <span class="comment">// I/O operation.  If it is, then wait here until the file is owned by</span>
01041     <span class="comment">// the current thread.  If this is not a (serialized) synchronous I/O</span>
01042     <span class="comment">// operation, then allocate and initialize the local event.</span>
01043     <span class="comment">//</span>
01044 
01045     <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01046 
01047         BOOLEAN interrupted;
01048 
01049         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a13">IopAcquireFastLock</a>( fileObject )) {
01050             status = <a class="code" href="../../d0/d6/iop_8h.html#a147">IopAcquireFileObjectLock</a>( fileObject,
01051                                                requestorMode,
01052                                                (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
01053                                                &amp;interrupted );
01054             <span class="keywordflow">if</span> (interrupted) {
01055                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01056                 <span class="keywordflow">return</span> status;
01057             }
01058         }
01059 
01060         <span class="comment">//</span>
01061         <span class="comment">// Make a special check here to determine whether or not the caller</span>
01062         <span class="comment">// is attempting to set the file position pointer information.  If so,</span>
01063         <span class="comment">// then set it immediately and get out.</span>
01064         <span class="comment">//</span>
01065 
01066         <span class="keywordflow">if</span> (FileInformationClass == FilePositionInformation) {
01067 
01068             <span class="comment">//</span>
01069             <span class="comment">// The caller has requested setting the current file position</span>
01070             <span class="comment">// context information.  This is a relatively frequent call, so</span>
01071             <span class="comment">// it is optimized here to cut through the normal IRP path.</span>
01072             <span class="comment">//</span>
01073             <span class="comment">// Begin by checking to see whether the file was opened with no</span>
01074             <span class="comment">// intermediate buffering.  If so, then the file pointer must be</span>
01075             <span class="comment">// set in a manner consistent with the alignment requirement of</span>
01076             <span class="comment">// read and write operations to a non-buffered file.</span>
01077             <span class="comment">//</span>
01078 
01079             PFILE_POSITION_INFORMATION fileInformation = FileInformation;
01080             LARGE_INTEGER currentByteOffset;
01081 
01082             <span class="keywordflow">try</span> {
01083 
01084                 <span class="comment">//</span>
01085                 <span class="comment">// Attempt to read the position information from the buffer.</span>
01086                 <span class="comment">//</span>
01087 
01088                 currentByteOffset.QuadPart = fileInformation-&gt;CurrentByteOffset.QuadPart;
01089 
01090             } except( EXCEPTION_EXECUTE_HANDLER ) {
01091 
01092                 <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01093                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01094                 <span class="keywordflow">return</span> GetExceptionCode();
01095             }
01096 
01097             <span class="keywordflow">if</span> ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a> &amp;&amp;
01098                  (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o23">SectorSize</a> &amp;&amp;
01099                  (currentByteOffset.LowPart &amp;
01100                  (deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o23">SectorSize</a> - 1)))) ||
01101                  currentByteOffset.HighPart &lt; 0) {
01102 
01103                     status = STATUS_INVALID_PARAMETER;
01104 
01105             } <span class="keywordflow">else</span> {
01106 
01107                 <span class="comment">//</span>
01108                 <span class="comment">// Set the current file position information.</span>
01109                 <span class="comment">//</span>
01110 
01111                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = currentByteOffset.QuadPart;
01112 
01113                 <span class="keywordflow">try</span> {
01114 
01115                     <span class="comment">//</span>
01116                     <span class="comment">// Write the I/O status block.</span>
01117                     <span class="comment">//</span>
01118 
01119                     IoStatusBlock-&gt;Status = STATUS_SUCCESS;
01120                     IoStatusBlock-&gt;Information = 0;
01121 
01122                 } except( EXCEPTION_EXECUTE_HANDLER ) {
01123 
01124                     <span class="comment">//</span>
01125                     <span class="comment">// Writes to I/O status blocks are ignored since the</span>
01126                     <span class="comment">// operation succeeded.</span>
01127                     <span class="comment">//</span>
01128 
01129                     NOTHING;
01130 
01131                 }
01132 
01133             }
01134 
01135             <span class="comment">//</span>
01136             <span class="comment">// Update the transfer count statistic for the current process for</span>
01137             <span class="comment">// operations other than read and write.</span>
01138             <span class="comment">//</span>
01139         
01140             <a class="code" href="../../d4/d6/iosubs_8c.html#a132">IopUpdateOtherTransferCount</a>( Length );
01141 
01142             <span class="comment">//</span>
01143             <span class="comment">// Note that the file object's event has not yet been reset,</span>
01144             <span class="comment">// so it is not necessary to set it to the Signaled state, since</span>
01145             <span class="comment">// that is it's state at this point by definition.  Therefore,</span>
01146             <span class="comment">// simply cleanup and return.</span>
01147             <span class="comment">//</span>
01148 
01149             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01150             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01151             <span class="keywordflow">return</span> status;
01152         }
01153         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01154     } <span class="keywordflow">else</span> {
01155 
01156         <span class="comment">//</span>
01157         <span class="comment">// This is a synchronous API being invoked for a file that is opened</span>
01158         <span class="comment">// for asynchronous I/O.  This means that this system service is</span>
01159         <span class="comment">// to synchronize the completion of the operation before returning</span>
01160         <span class="comment">// to the caller.  A local event is used to do this.</span>
01161         <span class="comment">//</span>
01162 
01163         event = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( NonPagedPool, <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> ) );
01164         <span class="keywordflow">if</span> (event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01165             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01166             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01167         }
01168         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( event, SynchronizationEvent, FALSE );
01169         synchronousIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01170     }
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">// Set the file object to the Not-Signaled state.</span>
01174     <span class="comment">//</span>
01175 
01176     <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> );
01177 
01178     <span class="comment">//</span>
01179     <span class="comment">// If a link is being tracked, handle this out-of-line.</span>
01180     <span class="comment">//</span>
01181 
01182     <span class="keywordflow">if</span> (FileInformationClass == FileTrackingInformation) {
01183         status = <a class="code" href="../../d0/d6/iop_8h.html#a214">IopTrackLink</a>( fileObject,
01184                                &amp;localIoStatus,
01185                                FileInformation,
01186                                Length,
01187                                synchronousIo ? &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a> : event,
01188                                requestorMode );
01189         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01190             <span class="keywordflow">try</span> {
01191                 IoStatusBlock-&gt;Information = 0;
01192                 IoStatusBlock-&gt;Status = status;
01193             } except(EXCEPTION_EXECUTE_HANDLER) {
01194                 NOTHING;
01195             }
01196         }
01197 
01198         <span class="keywordflow">if</span> (synchronousIo) {
01199             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01200         } <span class="keywordflow">else</span> {
01201             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
01202         }
01203         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( fileObject );
01204         <span class="keywordflow">return</span> status;
01205     }
01206 
01207     <span class="comment">//</span>
01208     <span class="comment">// Allocate and initialize the I/O Request Packet (IRP) for this operation.</span>
01209     <span class="comment">// The allocation is performed with an exception handler in case the</span>
01210     <span class="comment">// caller does not have enough quota to allocate the packet.</span>
01211 
01212     irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a17">IoAllocateIrp</a>( deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o13">StackSize</a>, TRUE );
01213     <span class="keywordflow">if</span> (!irp) {
01214 
01215         <span class="comment">//</span>
01216         <span class="comment">// An IRP could not be allocated.  Cleanup and return an appropriate</span>
01217         <span class="comment">// error status code.</span>
01218         <span class="comment">//</span>
01219 
01220         <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) {
01221             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
01222         }
01223 
01224         <a class="code" href="../../d0/d6/iop_8h.html#a148">IopAllocateIrpCleanup</a>( fileObject, (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL );
01225 
01226         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01227     }
01228     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject = fileObject;
01229     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01230     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> = requestorMode;
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">// Fill in the service independent parameters in the IRP.</span>
01234     <span class="comment">//</span>
01235 
01236     <span class="keywordflow">if</span> (synchronousIo) {
01237         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01238         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
01239     } <span class="keywordflow">else</span> {
01240         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = event;
01241         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = &amp;localIoStatus;
01242         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a176">IRP_SYNCHRONOUS_API</a>;
01243     }
01244     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine = (PIO_APC_ROUTINE) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01245 
01246     <span class="comment">//</span>
01247     <span class="comment">// Get a pointer to the stack location for the first driver.  This will</span>
01248     <span class="comment">// be used to pass the original function codes and parameters.</span>
01249     <span class="comment">//</span>
01250 
01251     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
01252     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a>;
01253     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = fileObject;
01254 
01255     <span class="comment">//</span>
01256     <span class="comment">// Allocate a buffer and copy the information that is to be set on the</span>
01257     <span class="comment">// file into it.  Also, set the flags so that the completion code will</span>
01258     <span class="comment">// properly handle getting rid of the buffer and will not attempt to</span>
01259     <span class="comment">// copy data.</span>
01260     <span class="comment">//</span>
01261 
01262     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = (PVOID) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01263     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01264 
01265     <span class="keywordflow">try</span> {
01266 
01267         PVOID systemBuffer;
01268 
01269         systemBuffer =
01270         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>( NonPagedPool,
01271                                                                    Length );
01272         RtlCopyMemory( irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer,
01273                        FileInformation,
01274                        Length );
01275 
01276         <span class="comment">//</span>
01277         <span class="comment">//  Negative file offsets are illegal.</span>
01278         <span class="comment">//</span>
01279 
01280         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FIELD_OFFSET(FILE_END_OF_FILE_INFORMATION, EndOfFile) |
01281                 FIELD_OFFSET(FILE_ALLOCATION_INFORMATION, AllocationSize) |
01282                 FIELD_OFFSET(FILE_POSITION_INFORMATION, CurrentByteOffset)) == 0);
01283 
01284         <span class="keywordflow">if</span> (((FileInformationClass == FileEndOfFileInformation) ||
01285              (FileInformationClass == FileAllocationInformation) ||
01286              (FileInformationClass == FilePositionInformation)) &amp;&amp;
01287             (((PFILE_POSITION_INFORMATION)systemBuffer)-&gt;CurrentByteOffset.HighPart &lt; 0)) {
01288 
01289             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INVALID_PARAMETER);
01290         }
01291 
01292 
01293 
01294     } except(EXCEPTION_EXECUTE_HANDLER) {
01295 
01296         <span class="comment">//</span>
01297         <span class="comment">// An exception was incurred while allocating the intermediary</span>
01298         <span class="comment">// system buffer or while copying the caller's data into the</span>
01299         <span class="comment">// buffer. Cleanup and return an appropriate error status code.</span>
01300         <span class="comment">//</span>
01301 
01302         <a class="code" href="../../d0/d6/iop_8h.html#a170">IopExceptionCleanup</a>( fileObject,
01303                              irp,
01304                              (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) NULL,
01305                              event );
01306 
01307         <span class="keywordflow">return</span> GetExceptionCode();
01308 
01309     }
01310 
01311     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a178">IRP_BUFFERED_IO</a> | <a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a> | <a class="code" href="../../d0/d5/io_8h.html#a186">IRP_DEFER_IO_COMPLETION</a>;
01312 
01313     <span class="comment">//</span>
01314     <span class="comment">// Copy the caller's parameters to the service-specific portion of the</span>
01315     <span class="comment">// IRP.</span>
01316     <span class="comment">//</span>
01317 
01318     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.Length = Length;
01319     irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.FileInformationClass = FileInformationClass;
01320 
01321     <span class="comment">//</span>
01322     <span class="comment">// Insert the packet at the head of the IRP list for the thread.</span>
01323     <span class="comment">//</span>
01324 
01325     <a class="code" href="../../d0/d6/iop_8h.html#a21">IopQueueThreadIrp</a>( irp );
01326 
01327     <span class="comment">//</span>
01328     <span class="comment">// Update the operation count statistic for the current process for</span>
01329     <span class="comment">// operations other than read and write.</span>
01330     <span class="comment">//</span>
01331 
01332     <a class="code" href="../../d4/d6/iosubs_8c.html#a129">IopUpdateOtherOperationCount</a>();
01333 
01334 
01335     <span class="comment">//</span>
01336     <span class="comment">// Everything is now set to invoke the device driver with this request.</span>
01337     <span class="comment">// However, it is possible that the information that the caller wants</span>
01338     <span class="comment">// to set is device independent.  If this is the case, then the request</span>
01339     <span class="comment">// can be satisfied here without having to have all of the drivers</span>
01340     <span class="comment">// implement the same code.  Note that having the IRP is still necessary</span>
01341     <span class="comment">// since the I/O completion code requires it.</span>
01342     <span class="comment">//</span>
01343 
01344     <span class="keywordflow">if</span> (FileInformationClass == FileModeInformation) {
01345 
01346         PFILE_MODE_INFORMATION modeBuffer = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01347 
01348         <span class="comment">//</span>
01349         <span class="comment">// Set the various flags in the mode field for the file object, if</span>
01350         <span class="comment">// they are reasonable.  There are 4 different invalid combinations</span>
01351         <span class="comment">// that the caller may not specify:</span>
01352         <span class="comment">//</span>
01353         <span class="comment">//     1)  An invalid flag was set in the mode field.  Not all Create/</span>
01354         <span class="comment">//         Open options may be changed.</span>
01355         <span class="comment">//</span>
01356         <span class="comment">//     2)  The caller set one of the synchronous I/O flags (alert or</span>
01357         <span class="comment">//         nonalert), but the file is not opened for synchronous I/O.</span>
01358         <span class="comment">//</span>
01359         <span class="comment">//     3)  The file is opened for synchronous I/O but the caller did</span>
01360         <span class="comment">//         not set either of the synchronous I/O flags (alert or non-</span>
01361         <span class="comment">//         alert).</span>
01362         <span class="comment">//</span>
01363         <span class="comment">//     4)  The caller set both of the synchronous I/O flags (alert and</span>
01364         <span class="comment">//         nonalert).</span>
01365         <span class="comment">//</span>
01366 
01367         <span class="keywordflow">if</span> ((modeBuffer-&gt;Mode &amp; ~FILE_VALID_SET_FLAGS) ||
01368             ((modeBuffer-&gt;Mode &amp; (<a class="code" href="../../d9/d2/qsinfo_8c.html#a0">FSIO_A</a> | <a class="code" href="../../d9/d2/qsinfo_8c.html#a1">FSIO_NA</a>)) &amp;&amp; (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>))) ||
01369             ((!(modeBuffer-&gt;Mode &amp; (<a class="code" href="../../d9/d2/qsinfo_8c.html#a0">FSIO_A</a> | <a class="code" href="../../d9/d2/qsinfo_8c.html#a1">FSIO_NA</a>))) &amp;&amp; (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>)) ||
01370             (((modeBuffer-&gt;Mode &amp; <a class="code" href="../../d9/d2/qsinfo_8c.html#a0">FSIO_A</a>) &amp;&amp; (modeBuffer-&gt;Mode &amp; <a class="code" href="../../d9/d2/qsinfo_8c.html#a1">FSIO_NA</a>) ))) {
01371             status = STATUS_INVALID_PARAMETER;
01372 
01373         } <span class="keywordflow">else</span> {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">// Set or clear the appropriate flags in the file object.</span>
01377             <span class="comment">//</span>
01378 
01379             <span class="keywordflow">if</span> (!(fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a153">FO_NO_INTERMEDIATE_BUFFERING</a>)) {
01380                 <span class="keywordflow">if</span> (modeBuffer-&gt;Mode &amp; FILE_WRITE_THROUGH) {
01381                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a>;
01382                 } <span class="keywordflow">else</span> {
01383                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a154">FO_WRITE_THROUGH</a>;
01384                 }
01385             }
01386 
01387             <span class="keywordflow">if</span> (modeBuffer-&gt;Mode &amp; FILE_SEQUENTIAL_ONLY) {
01388                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a155">FO_SEQUENTIAL_ONLY</a>;
01389             } <span class="keywordflow">else</span> {
01390                 fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a155">FO_SEQUENTIAL_ONLY</a>;
01391             }
01392 
01393             <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01394                 <span class="keywordflow">if</span> (modeBuffer-&gt;Mode &amp; <a class="code" href="../../d9/d2/qsinfo_8c.html#a0">FSIO_A</a>) {
01395                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>;
01396                 } <span class="keywordflow">else</span> {
01397                     fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a152">FO_ALERTABLE_IO</a>;
01398                 }
01399             }
01400 
01401             status = STATUS_SUCCESS;
01402         }
01403 
01404         <span class="comment">//</span>
01405         <span class="comment">// Complete the I/O operation.</span>
01406         <span class="comment">//</span>
01407 
01408         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
01409         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01410 
01411     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileRenameInformation ||
01412                FileInformationClass == FileLinkInformation ||
01413                FileInformationClass == FileMoveClusterInformation) {
01414 
01415         <span class="comment">//</span>
01416         <span class="comment">// Note that following code depends on the fact that the rename</span>
01417         <span class="comment">// information, link information and copy-on-write information</span>
01418         <span class="comment">// structures look exactly the same.</span>
01419         <span class="comment">//</span>
01420 
01421         PFILE_RENAME_INFORMATION renameBuffer = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01422 
01423         <span class="comment">//</span>
01424         <span class="comment">// The information being set is a variable-length structure with</span>
01425         <span class="comment">// embedded size information.  Walk the structure to ensure that</span>
01426         <span class="comment">// it is valid so the driver does not walk off the end and incur</span>
01427         <span class="comment">// an access violation in kernel mode.</span>
01428         <span class="comment">//</span>
01429 
01430         <span class="keywordflow">if</span> ((ULONG) (Length - FIELD_OFFSET( FILE_RENAME_INFORMATION, FileName[0] )) &lt; renameBuffer-&gt;FileNameLength) {
01431             status = STATUS_INVALID_PARAMETER;
01432             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
01433 
01434         } <span class="keywordflow">else</span> {
01435 
01436             <span class="comment">//</span>
01437             <span class="comment">// Copy the value of the replace BOOLEAN (or the ClusterCount field)</span>
01438             <span class="comment">// from the caller's buffer to the I/O stack location parameter</span>
01439             <span class="comment">// field where it is expected by file systems.</span>
01440             <span class="comment">//</span>
01441 
01442             <span class="keywordflow">if</span> (FileInformationClass == FileMoveClusterInformation) {
01443                 irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.ClusterCount =
01444                     ((FILE_MOVE_CLUSTER_INFORMATION *) renameBuffer)-&gt;ClusterCount;
01445             } <span class="keywordflow">else</span> {
01446                 irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.ReplaceIfExists = renameBuffer-&gt;ReplaceIfExists;
01447             }
01448 
01449             <span class="comment">//</span>
01450             <span class="comment">// Check to see whether or not a fully qualified pathname was</span>
01451             <span class="comment">// supplied.  If so, then more processing is required.</span>
01452             <span class="comment">//</span>
01453 
01454             <span class="keywordflow">if</span> (renameBuffer-&gt;FileName[0] == (WCHAR) OBJ_NAME_PATH_SEPARATOR ||
01455                 renameBuffer-&gt;RootDirectory) {
01456 
01457                 <span class="comment">//</span>
01458                 <span class="comment">// A fully qualified file name was specified as the target of</span>
01459                 <span class="comment">// the rename operation.  Attempt to open the target file and</span>
01460                 <span class="comment">// ensure that the replacement policy for the file is consistent</span>
01461                 <span class="comment">// with the caller's request, and ensure that the file is on the</span>
01462                 <span class="comment">// same volume.</span>
01463                 <span class="comment">//</span>
01464 
01465                 status = <a class="code" href="../../d0/d6/iop_8h.html#a197">IopOpenLinkOrRenameTarget</a>( &amp;targetHandle,
01466                                                     irp,
01467                                                     renameBuffer,
01468                                                     fileObject );
01469                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01470                     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
01471 
01472                 } <span class="keywordflow">else</span> {
01473 
01474                     <span class="comment">//</span>
01475                     <span class="comment">// The fully qualified file name specifies a file on the</span>
01476                     <span class="comment">// same volume and if it exists, then the caller specified</span>
01477                     <span class="comment">// that it should be replaced.</span>
01478                     <span class="comment">//</span>
01479 
01480                     status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01481 
01482                 }
01483 
01484             } <span class="keywordflow">else</span> {
01485 
01486                 <span class="comment">//</span>
01487                 <span class="comment">// This is a simple rename operation, so call the driver and</span>
01488                 <span class="comment">// let it perform the rename operation within the same directory</span>
01489                 <span class="comment">// as the source file.</span>
01490                 <span class="comment">//</span>
01491 
01492                 status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01493 
01494             }
01495         }
01496 
01497     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileDispositionInformation) {
01498 
01499         PFILE_DISPOSITION_INFORMATION disposition = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01500 
01501         <span class="comment">//</span>
01502         <span class="comment">// Check to see whether the disposition delete field has been set to</span>
01503         <span class="comment">// TRUE and, if so, copy the handle being used to do this to the IRP</span>
01504         <span class="comment">// stack location parameter.</span>
01505         <span class="comment">//</span>
01506 
01507         <span class="keywordflow">if</span> (disposition-&gt;DeleteFile) {
01508             irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.SetFile.DeleteHandle = FileHandle;
01509         }
01510 
01511         <span class="comment">//</span>
01512         <span class="comment">// Simply invoke the driver to perform the (un)delete operation.</span>
01513         <span class="comment">//</span>
01514 
01515         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01516 
01517     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FileInformationClass == FileCompletionInformation) {
01518 
01519         PFILE_COMPLETION_INFORMATION completion = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
01520         <a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html">PIO_COMPLETION_CONTEXT</a> context;
01521         PVOID portObject;
01522 
01523         <span class="comment">//</span>
01524         <span class="comment">// It is an error if this file object already has an LPC port associated</span>
01525         <span class="comment">// with it.</span>
01526         <span class="comment">//</span>
01527 
01528         <span class="keywordflow">if</span> (fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a> || fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a151">FO_SYNCHRONOUS_IO</a>) {
01529 
01530             status = STATUS_INVALID_PARAMETER;
01531 
01532         } <span class="keywordflow">else</span> {
01533 
01534             <span class="comment">//</span>
01535             <span class="comment">// Attempt to reference the port object by its handle and convert it</span>
01536             <span class="comment">// into a pointer to the port object itself.</span>
01537             <span class="comment">//</span>
01538 
01539             status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( completion-&gt;Port,
01540                                                 IO_COMPLETION_MODIFY_STATE,
01541                                                 IoCompletionObjectType,
01542                                                 requestorMode,
01543                                                 (PVOID *) &amp;portObject,
01544                                                 NULL );
01545             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01546 
01547                 <span class="comment">//</span>
01548                 <span class="comment">// Allocate the memory to be associated w/this file object</span>
01549                 <span class="comment">//</span>
01550 
01551                 context = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
01552                                                  <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html">IO_COMPLETION_CONTEXT</a> ),
01553                                                  'cCoI' );
01554                 <span class="keywordflow">if</span> (!context) {
01555 
01556                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( portObject );
01557                     status = STATUS_INSUFFICIENT_RESOURCES;
01558 
01559                 } <span class="keywordflow">else</span> {
01560 
01561                     <span class="comment">//</span>
01562                     <span class="comment">// Everything was successful.  Capture the completion port</span>
01563                     <span class="comment">// and the key.</span>
01564                     <span class="comment">//</span>
01565 
01566                     context-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o0">Port</a> = portObject;
01567                     context-&gt;<a class="code" href="../../d2/d4/struct__IO__COMPLETION__CONTEXT.html#o1">Key</a> = completion-&gt;Key;
01568 
01569                     <span class="keywordflow">if</span> (!InterlockedCompareExchangePointer( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o26">CompletionContext</a>, context, NULL )) {
01570 
01571                         status = STATUS_SUCCESS;
01572 
01573                     } <span class="keywordflow">else</span> {
01574 
01575                         <span class="comment">//</span>
01576                         <span class="comment">// Someone set the completion context after the check.</span>
01577                         <span class="comment">// Simply drop everything on the floor and return an</span>
01578                         <span class="comment">// error.</span>
01579                         <span class="comment">//</span>
01580 
01581                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( context );
01582                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( portObject );
01583                         status = STATUS_INVALID_PARAMETER;
01584                     }
01585                 }
01586             }
01587         }
01588 
01589         <span class="comment">//</span>
01590         <span class="comment">// Complete the I/O operation.</span>
01591         <span class="comment">//</span>
01592 
01593         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
01594         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
01595 
01596     } <span class="keywordflow">else</span> {
01597 
01598         <span class="comment">//</span>
01599         <span class="comment">// This is not a request that can be performed here, so invoke the</span>
01600         <span class="comment">// driver at its appropriate dispatch entry with the IRP.</span>
01601         <span class="comment">//</span>
01602 
01603         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( deviceObject, irp );
01604     }
01605 
01606     <span class="comment">//</span>
01607     <span class="comment">// If this operation was a synchronous I/O operation, check the return</span>
01608     <span class="comment">// status to determine whether or not to wait on the file object.  If</span>
01609     <span class="comment">// the file object is to be waited on, wait for the operation to complete</span>
01610     <span class="comment">// and obtain the final status from the file object itself.</span>
01611     <span class="comment">//</span>
01612 
01613     <span class="keywordflow">if</span> (status == STATUS_PENDING) {
01614 
01615         <span class="keywordflow">if</span> (synchronousIo) {
01616 
01617             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>,
01618                                             Executive,
01619                                             requestorMode,
01620                                             (BOOLEAN) ((fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a> &amp; FO_ALERTABLE_IO) != 0),
01621                                             (PLARGE_INTEGER) NULL );
01622 
01623             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
01624 
01625                 <span class="comment">//</span>
01626                 <span class="comment">// The wait request has ended either because the thread was</span>
01627                 <span class="comment">// alerted or an APC was queued to this thread, because of</span>
01628                 <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
01629                 <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
01630                 <span class="comment">// completes before this routine exists so that synchronization</span>
01631                 <span class="comment">// with the file object will remain intact.</span>
01632                 <span class="comment">//</span>
01633 
01634                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( &amp;fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o25">Event</a>, irp );
01635 
01636             }
01637 
01638             status = fileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o8">FinalStatus</a>;
01639 
01640             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01641 
01642         } <span class="keywordflow">else</span> {
01643 
01644             <span class="comment">//</span>
01645             <span class="comment">// This is a normal synchronous I/O operation, as opposed to a</span>
01646             <span class="comment">// serialized synchronous I/O operation.  For this case, wait for</span>
01647             <span class="comment">// the local event and copy the final status information back to</span>
01648             <span class="comment">// the caller.</span>
01649             <span class="comment">//</span>
01650 
01651             status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( event,
01652                                             Executive,
01653                                             requestorMode,
01654                                             FALSE,
01655                                             (PLARGE_INTEGER) NULL );
01656 
01657             <span class="keywordflow">if</span> (status == STATUS_ALERTED || status == STATUS_USER_APC) {
01658 
01659                 <span class="comment">//</span>
01660                 <span class="comment">// The wait request has ended either because the thread was</span>
01661                 <span class="comment">// alerted or an APC was queued to this thread, because of</span>
01662                 <span class="comment">// thread rundown or CTRL/C processing.  In either case, try</span>
01663                 <span class="comment">// to bail out of this I/O request carefully so that the IRP</span>
01664                 <span class="comment">// completes before this routine exists or the event will not</span>
01665                 <span class="comment">// be around to set to the Signaled state.</span>
01666                 <span class="comment">//</span>
01667 
01668                 <a class="code" href="../../d0/d6/iop_8h.html#a151">IopCancelAlertedRequest</a>( event, irp );
01669 
01670             }
01671 
01672             status = localIoStatus.Status;
01673 
01674             <span class="keywordflow">try</span> {
01675 
01676                 *IoStatusBlock = localIoStatus;
01677 
01678             } except(EXCEPTION_EXECUTE_HANDLER) {
01679 
01680                 <span class="comment">//</span>
01681                 <span class="comment">// An exception occurred attempting to write the caller's I/O</span>
01682                 <span class="comment">// status block.  Simply change the final status of the</span>
01683                 <span class="comment">// operation to the exception code.</span>
01684                 <span class="comment">//</span>
01685 
01686                 status = GetExceptionCode();
01687             }
01688 
01689             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
01690 
01691         }
01692 
01693     } <span class="keywordflow">else</span> {
01694 
01695         <span class="comment">//</span>
01696         <span class="comment">// The I/O operation finished without return a status of pending.</span>
01697         <span class="comment">// This means that the operation has not been through I/O completion,</span>
01698         <span class="comment">// so it must be done here.</span>
01699         <span class="comment">//</span>
01700 
01701         <a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> normalRoutine;
01702         PVOID normalContext;
01703         KIRQL irql;
01704 
01705         <span class="keywordflow">if</span> (!synchronousIo) {
01706 
01707             <span class="comment">//</span>
01708             <span class="comment">// This is not a synchronous I/O operation, it is a synchronous</span>
01709             <span class="comment">// I/O API to a file opened for asynchronous I/O.  Since this</span>
01710             <span class="comment">// code path need never wait on the allocated and supplied event,</span>
01711             <span class="comment">// get rid of it so that it doesn't have to be set to the</span>
01712             <span class="comment">// Signaled state by the I/O completion code.</span>
01713             <span class="comment">//</span>
01714 
01715             irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01716             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( event );
01717         }
01718 
01719         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = IoStatusBlock;
01720         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
01721         <a class="code" href="../../d0/d6/iop_8h.html#a157">IopCompleteRequest</a>( &amp;irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Apc,
01722                             &amp;normalRoutine,
01723                             &amp;normalContext,
01724                             (PVOID *) &amp;fileObject,
01725                             &amp;normalContext );
01726         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
01727 
01728         <span class="keywordflow">if</span> (synchronousIo) {
01729             <a class="code" href="../../d0/d6/iop_8h.html#a22">IopReleaseFileObjectLock</a>( fileObject );
01730         }
01731 
01732     }
01733 
01734     <span class="comment">//</span>
01735     <span class="comment">// If there was a target handle generated because of a rename operation,</span>
01736     <span class="comment">// close it now.</span>
01737     <span class="comment">//</span>
01738 
01739     <span class="keywordflow">if</span> (targetHandle) {
01740         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( targetHandle );
01741     }
01742 
01743     <span class="keywordflow">return</span> status;
01744 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
