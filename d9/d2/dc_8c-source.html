<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dc.c</h1><a href="../../d8/d3/dc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: dc.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains User's DC APIs and related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 23-Oct-1990 DarrinM   Created.</span>
00010 <span class="comment">* 07-Feb-1991 MikeKe    Added Revalidation code (None).</span>
00011 <span class="comment">* 17-Jul-1991 DarrinM   Recreated from Win 3.1 source.</span>
00012 <span class="comment">* 21-Jan-1992 IanJa     ANSI/Unicode neutral (null op).</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 <span class="comment">/*</span>
00019 <span class="comment"> * DBG Related Information.</span>
00020 <span class="comment"> */</span>
00021 <span class="preprocessor">#if DBG</span>
00022 <span class="preprocessor"></span><a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fDisableCache;                 <span class="comment">// TRUE to disable DC cache.</span>
00023 <span class="preprocessor">#endif</span>
00024 <span class="preprocessor"></span>
00025 <span class="comment">/***************************************************************************\</span>
00026 <span class="comment">* DecrementFreeDCECount</span>
00027 <span class="comment">*</span>
00028 <span class="comment">\***************************************************************************/</span>
00029 
<a name="l00030"></a><a class="code" href="../../d8/d3/dc_8c.html#a1">00030</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a1">DecrementFreeDCECount</a>(VOID)
00031 {
00032     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a180">gnDCECount</a>--;
00033     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a180">gnDCECount</a> &gt;= 0);
00034 }
00035 
00036 <span class="comment">/***************************************************************************\</span>
00037 <span class="comment">* IncrementFreeDCECount</span>
00038 <span class="comment">*</span>
00039 <span class="comment">\***************************************************************************/</span>
00040 
<a name="l00041"></a><a class="code" href="../../d8/d3/dc_8c.html#a2">00041</a> __inline <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a2">IncrementFreeDCECount</a>(VOID)
00042 {
00043     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a180">gnDCECount</a>++;
00044     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a180">gnDCECount</a> &gt;= 0);
00045 }
00046 
00047 <span class="comment">/***************************************************************************\</span>
00048 <span class="comment">* SetMonitorRegion</span>
00049 <span class="comment">*</span>
00050 <span class="comment">* The region is in meta dc coordinates, so convert to monitor coords.</span>
00051 <span class="comment">\***************************************************************************/</span>
00052 
<a name="l00053"></a><a class="code" href="../../d8/d3/dc_8c.html#a3">00053</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d3/dc_8c.html#a3">SetMonitorRegion</a>(<a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor, HRGN hrgnDst, HRGN hrgnSrc)
00054 {
00055     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnDst, hrgnSrc, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o5">hrgnMonitor</a>) == ERROR) {
00056         GreSetRectRgn(hrgnDst, 0, 0, 0, 0);
00057         <span class="keywordflow">return</span>;
00058     }
00059 
00060     GreOffsetRgn(hrgnDst, -pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left, -pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
00061 }
00062 
00063 <span class="comment">/***************************************************************************\</span>
00064 <span class="comment">* ResetOrg</span>
00065 <span class="comment">*</span>
00066 <span class="comment">* Resets the origin of the DC associated with *pdce, and selects</span>
00067 <span class="comment">* a new visrgn.</span>
00068 <span class="comment">*</span>
00069 <span class="comment">* History:</span>
00070 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00071 <span class="comment">\***************************************************************************/</span>
00072 
<a name="l00073"></a><a class="code" href="../../d8/d3/dc_8c.html#a4">00073</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a4">ResetOrg</a>(
00074     HRGN hrgn,
00075     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce,
00076     BOOL fSetVisRgn)
00077 {
00078     RECT  rc;
00079     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndLayer;
00080 
00081     <span class="comment">/*</span>
00082 <span class="comment">     * For compatibility purposes, make sure that the DC's for the</span>
00083 <span class="comment">     * desktop windows originate at the primary monitor, i.e. (0,0).</span>
00084 <span class="comment">     */</span>
00085     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a196">FNID_DESKTOP</a>) {
00086         rc.left = rc.top = 0;
00087         rc.right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN);
00088         rc.bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN);
00089     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_WINDOW) {
00090         rc = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00091     } <span class="keywordflow">else</span> {
00092         rc = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
00093     }
00094 
00095     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00096         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left,
00097                 -pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
00098 
00099         <span class="keywordflow">if</span> (hrgn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00100             <a class="code" href="../../d8/d3/dc_8c.html#a3">SetMonitorRegion</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>, hrgn, hrgn);
00101         }
00102     }
00103 
00104     <span class="keywordflow">if</span> ((pwndLayer = <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00105         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) {
00106             <span class="keywordtype">int</span> x = pwndLayer-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00107             <span class="keywordtype">int</span> y = pwndLayer-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00108 
00109             <span class="comment">/*</span>
00110 <span class="comment">             * For layered redirection DCs, the surface origin is the</span>
00111 <span class="comment">             * window origin, so offset both the rectangle and the</span>
00112 <span class="comment">             * region appropriately.</span>
00113 <span class="comment">             */</span>
00114             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -x, -y);
00115             <span class="keywordflow">if</span> (hrgn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00116                 GreOffsetRgn(hrgn, -x, -y);
00117             }
00118         } <span class="keywordflow">else</span> {
00119             <span class="comment">/*</span>
00120 <span class="comment">             * Layered windows can only draw to the screen via the redirection</span>
00121 <span class="comment">             * DCs or UpdateLayeredWindow, so select an empty visrgn into this</span>
00122 <span class="comment">             * screen DC.</span>
00123 <span class="comment">             */</span>
00124             <span class="keywordflow">if</span> (hrgn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00125                 GreSetRectRgn(hrgn, 0, 0, 0, 0);
00126             }
00127         }
00128     } <span class="keywordflow">else</span> {
00129         UserAssert(!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED));
00130     }
00131 
00132     GreSetDCOrg(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, rc.left, rc.top, (PRECTL)&amp;rc);
00133 
00134     <span class="keywordflow">if</span> (fSetVisRgn) {
00135         GreSelectVisRgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, hrgn, SVR_DELETEOLD);
00136     }
00137 }
00138 
00139 <span class="comment">/***************************************************************************\</span>
00140 <span class="comment">* GetDC (API)</span>
00141 <span class="comment">*</span>
00142 <span class="comment">* Standard call to GetDC().</span>
00143 <span class="comment">*</span>
00144 <span class="comment">* History:</span>
00145 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00146 <span class="comment">\***************************************************************************/</span>
00147 
<a name="l00148"></a><a class="code" href="../../d4/d1/userk_8h.html#a1694">00148</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1694">_GetDC</a>(
00149     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00150 {
00151     <span class="comment">/*</span>
00152 <span class="comment">     * Special case for NULL: For backward compatibility we want to return</span>
00153 <span class="comment">     * a window DC for the desktop that does not exclude its children.</span>
00154 <span class="comment">     */</span>
00155     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00156 
00157         <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk;
00158 
00159         <span class="keywordflow">if</span> (pdesk) {
00160             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a>,
00161                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00162                             DCX_WINDOW | DCX_CACHE);
00163         }
00164 
00165         <span class="comment">/*</span>
00166 <span class="comment">         * The thread has no desktop.  Fail the call.</span>
00167 <span class="comment">         */</span>
00168         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00169     }
00170 
00171     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_USESTYLE);
00172 }
00173 
00174 <span class="comment">/***************************************************************************\</span>
00175 <span class="comment">* _ReleaseDC (API)</span>
00176 <span class="comment">*</span>
00177 <span class="comment">* Release the DC retrieved from GetDC().</span>
00178 <span class="comment">*</span>
00179 <span class="comment">* History:</span>
00180 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00181 <span class="comment">\***************************************************************************/</span>
00182 
<a name="l00183"></a><a class="code" href="../../d4/d1/userk_8h.html#a1697">00183</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(
00184     HDC hdc)
00185 {
00186     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00187 
00188     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1698">ReleaseCacheDC</a>(hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) == <a class="code" href="../../d4/d1/userk_8h.html#a398">DCE_NORELEASE</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00189 }
00190 
00191 <span class="comment">/***************************************************************************\</span>
00192 <span class="comment">* _GetWindowDC (API)</span>
00193 <span class="comment">*</span>
00194 <span class="comment">* Retrive a DC for the window.</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* History:</span>
00197 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00198 <span class="comment">* 25-Jan-1996 ChrisWil  Allow rgnClip so that WM_NCACTIVATE can clip.</span>
00199 <span class="comment">\***************************************************************************/</span>
00200 
<a name="l00201"></a><a class="code" href="../../d4/d1/userk_8h.html#a1696">00201</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1696">_GetWindowDC</a>(
00202     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00203 {
00204 
00205 <span class="preprocessor">#if 0</span>
00206 <span class="preprocessor"></span>
00207     <span class="comment">/*</span>
00208 <span class="comment">     * For WIN31 and previous apps, we want to actually return back a</span>
00209 <span class="comment">     * client DC.  Before WIN40, the window rect and client rect were the</span>
00210 <span class="comment">     * same, and there was this terrible hack to grab the window dc when</span>
00211 <span class="comment">     * painting because window DCs never clip anything.  Otherwise the</span>
00212 <span class="comment">     * children of the minimized window would be clipped out of the fake</span>
00213 <span class="comment">     * client area.  So apps would call GetWindowDC() to redraw their icons,</span>
00214 <span class="comment">     * since GetDC() would clip empty if the window had a class icon.</span>
00215 <span class="comment">     */</span>
00216     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
00217         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, hrgnClip, DCX_INTERNAL | DCX_CACHE | DCX_USESTYLE));
00218 <span class="preprocessor">#endif</span>
00219 <span class="preprocessor"></span>
00220     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_USESTYLE);
00221 }
00222 
00223 <span class="comment">/***************************************************************************\</span>
00224 <span class="comment">* UserSetDCVisRgn</span>
00225 <span class="comment">*</span>
00226 <span class="comment">* Set the visrgn for the DCE.  If the window has a (hrgnClipPublic), we use</span>
00227 <span class="comment">* that instead of the (hrgnClip) since it's a public-object.  The other is</span>
00228 <span class="comment">* created and owned by the user-thread and can't be used if say we're in the</span>
00229 <span class="comment">* hung-app-drawing (different process).  Both regions should be equalent in</span>
00230 <span class="comment">* data.</span>
00231 <span class="comment">*</span>
00232 <span class="comment">* History:</span>
00233 <span class="comment">* 10-Nov-1992 DavidPe   Created.</span>
00234 <span class="comment">* 20-Dec-1995 ChrisWil  Added (hrgnClipPublic) entry.</span>
00235 <span class="comment">\***************************************************************************/</span>
00236 
<a name="l00237"></a><a class="code" href="../../d8/d3/dc_8c.html#a8">00237</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a8">UserSetDCVisRgn</a>(
00238     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce)
00239 {
00240     HRGN hrgn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * If the visrgn calculated is empt, set the flag DCX_PWNDORGINVISIBLE,</span>
00244 <span class="comment">     * otherwise clear it (it could've been set earlier on).</span>
00245 <span class="comment">     */</span>
00246     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgn, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a>)) {
00247         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_PWNDORGINVISIBLE;
00248     } <span class="keywordflow">else</span> {
00249         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~DCX_PWNDORGINVISIBLE;
00250     }
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * Deal with INTERSECTRGN and EXCLUDERGN.</span>
00254 <span class="comment">     */</span>
00255     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INTERSECTRGN) {
00256 
00257         UserAssert(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>);
00258 
00259         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00260             <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgn);
00261         } <span class="keywordflow">else</span> {
00262             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgn, hrgn, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a>);
00263         }
00264 
00265     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_EXCLUDERGN) {
00266 
00267         UserAssert(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00268 
00269         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00270             <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgn);
00271         } <span class="keywordflow">else</span> {
00272             <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgn, hrgn, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a>);
00273         }
00274     }
00275 
00276     <a class="code" href="../../d8/d3/dc_8c.html#a4">ResetOrg</a>(hrgn, pdce, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00277 }
00278 
00279 <span class="comment">/***************************************************************************\</span>
00280 <span class="comment">* UserGetClientRgn</span>
00281 <span class="comment">*</span>
00282 <span class="comment">* Return a copy of the client region and rectangle for the given hwnd.</span>
00283 <span class="comment">*</span>
00284 <span class="comment">* The caller must enter the user critical section before calling this function.</span>
00285 <span class="comment">*</span>
00286 <span class="comment">* History:</span>
00287 <span class="comment">* 27-Sep-1993 WendyWu   Created.</span>
00288 <span class="comment">\***************************************************************************/</span>
00289 
<a name="l00290"></a><a class="code" href="../../d8/d3/dc_8c.html#a9">00290</a> HRGN <a class="code" href="../../d8/d3/dc_8c.html#a9">UserGetClientRgn</a>(
00291     HWND   hwnd,
00292     LPRECT lprc,
00293     BOOL   bWindowInsteadOfClient)
00294 {
00295     HRGN hrgnClient = (HRGN)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00296     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00297 
00298     <span class="comment">/*</span>
00299 <span class="comment">     * Must be in critical section.</span>
00300 <span class="comment">     */</span>
00301     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00302 
00303     <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) {
00304 
00305         <span class="keywordflow">if</span> (bWindowInsteadOfClient) {
00306 
00307             <span class="comment">/*</span>
00308 <span class="comment">             * Never clip children for WO_RGN_WINDOW so that NetMeeting</span>
00309 <span class="comment">             * gets the unioned window area:</span>
00310 <span class="comment">             */</span>
00311 
00312             <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgnClient,
00313                        pwnd,
00314                        pwnd,
00315                        DCX_WINDOW |
00316                        (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>) ? DCX_CLIPSIBLINGS : 0));
00317         } <span class="keywordflow">else</span> {
00318             <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgnClient,
00319                        pwnd,
00320                        pwnd,
00321                        DCX_CLIPCHILDREN | DCX_CLIPSIBLINGS);
00322         }
00323 
00324         *lprc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
00325     }
00326 
00327     <span class="keywordflow">return</span> hrgnClient;
00328 }
00329 
00330 <span class="comment">/***************************************************************************\</span>
00331 <span class="comment">* UserGetHwnd</span>
00332 <span class="comment">*</span>
00333 <span class="comment">* Return a hwnd and the associated pwo for the given display hdc.</span>
00334 <span class="comment">*</span>
00335 <span class="comment">* It returns FALSE if no hwnd corresponds to the hdc is found or if the</span>
00336 <span class="comment">* hwnd has incorrect styles for a device format window.</span>
00337 <span class="comment">*</span>
00338 <span class="comment">* The caller must enter the user critical section before calling this function.</span>
00339 <span class="comment">*</span>
00340 <span class="comment">* History:</span>
00341 <span class="comment">* 27-Sep-1993 WendyWu   Created.</span>
00342 <span class="comment">\***************************************************************************/</span>
00343 
<a name="l00344"></a><a class="code" href="../../d8/d3/dc_8c.html#a10">00344</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/dc_8c.html#a10">UserGetHwnd</a>(
00345     HDC   hdc,
00346     HWND  *phwnd,
00347     PVOID *ppwo,
00348     BOOL  bCheckStyle)
00349 {
00350     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00351     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00352 
00353     <span class="comment">/*</span>
00354 <span class="comment">     * Must be in critical section.</span>
00355 <span class="comment">     */</span>
00356     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00357 
00358     <span class="comment">/*</span>
00359 <span class="comment">     * Find pdce and pwnd for this DC.</span>
00360 <span class="comment">     *</span>
00361 <span class="comment">     * Note: the SAMEHANDLE macro strips out the user defined bits in the</span>
00362 <span class="comment">     * handle before doing the comparison.  This is important because when</span>
00363 <span class="comment">     * GRE calls this function, it may have lost track of the OWNDC bit.</span>
00364 <span class="comment">     */</span>
00365     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00366 
00367         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc) <span class="comment">// this should be undone once SAMEHANDLE is fixed for kmode</span>
00368             <span class="keywordflow">break</span>;
00369     }
00370 
00371     <span class="comment">/*</span>
00372 <span class="comment">     * Return FALSE If it is not in the pdce list.</span>
00373 <span class="comment">     */</span>
00374     <span class="keywordflow">if</span> ((pdce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
00375         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00376 
00377     pwnd = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
00378 
00379     <span class="comment">/*</span>
00380 <span class="comment">     * The window style must be clipchildren and clipsiblings.</span>
00381 <span class="comment">     * the window's class must not be parentdc</span>
00382 <span class="comment">     */</span>
00383     <span class="keywordflow">if</span> (bCheckStyle) {
00384 
00385         <span class="keywordflow">if</span> (    !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>) ||
00386                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>) ||
00387                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a476">CFPARENTDC</a>)) {
00388 
00389             RIPMSG0(RIP_WARNING, <span class="stringliteral">"UserGetHwnd: Bad OpenGL window style or class"</span>);
00390             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00391         }
00392     }
00393 
00394     <span class="comment">/*</span>
00395 <span class="comment">     * Return the hwnd with the correct styles for a device format window.</span>
00396 <span class="comment">     */</span>
00397     *phwnd = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00398     *ppwo  = <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a479">PROP_WNDOBJ</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00399 
00400     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00401 }
00402 
00403 <span class="comment">/***************************************************************************\</span>
00404 <span class="comment">* UserAssociateHwnd</span>
00405 <span class="comment">*</span>
00406 <span class="comment">* Associate a gdi WNDOBJ with hwnd.  The caller must enter the user</span>
00407 <span class="comment">* critical section before calling this function.</span>
00408 <span class="comment">*</span>
00409 <span class="comment">* If 'pwo' is NULL, the association is removed.</span>
00410 <span class="comment">*</span>
00411 <span class="comment">* History:</span>
00412 <span class="comment">* 13-Jan-1994 HockL     Created.</span>
00413 <span class="comment">\***************************************************************************/</span>
00414 
<a name="l00415"></a><a class="code" href="../../d8/d3/dc_8c.html#a11">00415</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a11">UserAssociateHwnd</a>(
00416     HWND  hwnd,
00417     PVOID pwo)
00418 {
00419     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00420 
00421     <span class="comment">/*</span>
00422 <span class="comment">     * Must be in critical section.</span>
00423 <span class="comment">     */</span>
00424     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00425 
00426     <span class="keywordflow">if</span> (pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd)) {
00427 
00428         <span class="keywordflow">if</span> (pwo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a479">PROP_WNDOBJ</a>, pwo, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a500">PROPF_NOPOOL</a>))
00430                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a95">gcountPWO</a>++;
00431         } <span class="keywordflow">else</span> {
00432             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a1">InternalRemoveProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a479">PROP_WNDOBJ</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>))
00433                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a95">gcountPWO</a>--;
00434         }
00435     }
00436 }
00437 
00438 <span class="comment">/***************************************************************************\</span>
00439 <span class="comment">* UserReleaseDC</span>
00440 <span class="comment">*</span>
00441 <span class="comment">* Enter's the critical section and calls _ReleaseDC.</span>
00442 <span class="comment">*</span>
00443 <span class="comment">* History:</span>
00444 <span class="comment">* 25-Jan-1996 ChrisWil  Created comment block.</span>
00445 <span class="comment">\***************************************************************************/</span>
00446 
<a name="l00447"></a><a class="code" href="../../d8/d3/dc_8c.html#a12">00447</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/dc_8c.html#a12">UserReleaseDC</a>(
00448     HDC hdc)
00449 {
00450     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> b;
00451 
00452     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00453     b = <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00454     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00455 
00456     <span class="keywordflow">return</span> b;
00457 }
00458 
00459 <span class="comment">/***************************************************************************\</span>
00460 <span class="comment">* InvalidateDce</span>
00461 <span class="comment">*</span>
00462 <span class="comment">* If the DCE is not in use, removes all information and marks it invalid.</span>
00463 <span class="comment">* Otherwise, it resets the DCE flags based on the window styles and</span>
00464 <span class="comment">* recalculates the vis rgn.</span>
00465 <span class="comment">*</span>
00466 <span class="comment">* History:</span>
00467 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00468 <span class="comment">\***************************************************************************/</span>
00469 
<a name="l00470"></a><a class="code" href="../../d4/d1/userk_8h.html#a1701">00470</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1701">InvalidateDce</a>(
00471     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce)
00472 {
00473     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00474 
00475     <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
00476 
00477         <span class="comment">/*</span>
00478 <span class="comment">         * Accumulate any bounds for this CE</span>
00479 <span class="comment">         * since we're about to mark it invalid.</span>
00480 <span class="comment">         */</span>
00481         <a class="code" href="../../d4/d1/userk_8h.html#a1771">SpbCheckDce</a>(pdce);
00482 
00483         <a class="code" href="../../d4/d1/userk_8h.html#a1709">MarkDCEInvalid</a>(pdce);
00484 
00485         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>        = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00486         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00487         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00488         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00489 
00490         <span class="comment">/*</span>
00491 <span class="comment">         * Remove the vis rgn since it is still owned - if we did not,</span>
00492 <span class="comment">         * gdi would not be able to clean up properly if the app that</span>
00493 <span class="comment">         * owns this vis rgn exist while the vis rgn is still selected.</span>
00494 <span class="comment">         */</span>
00495         GreSelectVisRgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SVR_DELETEOLD);
00496 
00497     } <span class="keywordflow">else</span> {
00498 
00499         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOrg  = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
00500         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndClip = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>;
00501 
00502         <span class="comment">/*</span>
00503 <span class="comment">         * In case the window's clipping style bits changed,</span>
00504 <span class="comment">         * reset the DCE flags from the window style bits.</span>
00505 <span class="comment">         * Note that minimized windows never exclude their children.</span>
00506 <span class="comment">         */</span>
00507         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~(DCX_CLIPCHILDREN | DCX_CLIPSIBLINGS);
00508 
00509         <span class="comment">/*</span>
00510 <span class="comment">         * Chicago stuff...</span>
00511 <span class="comment">         */</span>
00512         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a476">CFPARENTDC</a>) &amp;&amp;
00513             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) &amp;&amp;
00514             (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))) {
00515 
00516             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00517                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_CLIPSIBLINGS;
00518 
00519         } <span class="keywordflow">else</span> {
00520 
00521             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
00522                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_CLIPCHILDREN;
00523 
00524             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00525                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_CLIPSIBLINGS;
00526         }
00527 
00528         <span class="comment">/*</span>
00529 <span class="comment">         * Mark that any saved visrgn needs to be recomputed.</span>
00530 <span class="comment">         */</span>
00531         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_SAVEDRGNINVALID;
00532 
00533         <a class="code" href="../../d8/d3/dc_8c.html#a8">UserSetDCVisRgn</a>(pdce);
00534     }
00535 
00536     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00537 }
00538 
00539 <span class="comment">/***************************************************************************\</span>
00540 <span class="comment">* DeleteHrgnClip</span>
00541 <span class="comment">*</span>
00542 <span class="comment">* Deletes the clipping regions in the DCE, restores the saved visrgn,</span>
00543 <span class="comment">* and invalidates the DCE if saved visrgn is invalid.</span>
00544 <span class="comment">*</span>
00545 <span class="comment">* History:</span>
00546 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00547 <span class="comment">\***************************************************************************/</span>
00548 
<a name="l00549"></a><a class="code" href="../../d4/d1/userk_8h.html#a1702">00549</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1702">DeleteHrgnClip</a>(
00550     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce)
00551 {
00552     <span class="comment">/*</span>
00553 <span class="comment">     * Clear these flags first in case we get a DCHook() callback...</span>
00554 <span class="comment">     */</span>
00555     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~(DCX_EXCLUDERGN | DCX_INTERSECTRGN);
00556 
00557     <span class="comment">/*</span>
00558 <span class="comment">     * Blow away pdce-&gt;hrgnClip and clear the associated flags.</span>
00559 <span class="comment">     * Do not delete hrgnClip if DCX_NODELETERGN is set!</span>
00560 <span class="comment">     */</span>
00561     <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_NODELETERGN)) {
00562         <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>);
00563     } <span class="keywordflow">else</span> {
00564         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~DCX_NODELETERGN;
00565     }
00566 
00567     <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a>);
00568 
00569     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00570     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571 
00572     <span class="comment">/*</span>
00573 <span class="comment">     * If the saved visrgn was invalidated by an InvalidateDce()</span>
00574 <span class="comment">     * while we had it checked out, then invalidate the entry now.</span>
00575 <span class="comment">     */</span>
00576     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_SAVEDRGNINVALID) {
00577         <a class="code" href="../../d4/d1/userk_8h.html#a1701">InvalidateDce</a>(pdce);
00578 
00579         <span class="comment">/*</span>
00580 <span class="comment">         * We've just gone through InvalidateDce, so the visrgn in the</span>
00581 <span class="comment">         * DC has been properly reset. Simply nuke the old saved visrgn.</span>
00582 <span class="comment">         */</span>
00583         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00584             GreDeleteObject(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a>);
00585             pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00586         }
00587     } <span class="keywordflow">else</span> {
00588         <span class="comment">/*</span>
00589 <span class="comment">         * The saved visrgn is still valid, select it back into the</span>
00590 <span class="comment">         * DC so the entry may be re-used without recomputing.</span>
00591 <span class="comment">         */</span>
00592         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593             GreSelectVisRgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a>, SVR_DELETEOLD);
00594             pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00595         }
00596     }
00597 }
00598 
00599 <span class="comment">/***************************************************************************\</span>
00600 <span class="comment">* GetDCEx (API)</span>
00601 <span class="comment">*</span>
00602 <span class="comment">*</span>
00603 <span class="comment">* History:</span>
00604 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00605 <span class="comment">* 20-Dec-1995 ChrisWil  Added (hrgnClipPublic) entry.</span>
00606 <span class="comment">\***************************************************************************/</span>
00607 
<a name="l00608"></a><a class="code" href="../../d4/d1/userk_8h.html#a1695">00608</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(
00609     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00610     HRGN  hrgnClip,
00611     DWORD DCX_flags)
00612 {
00613     HRGN  hrgn;
00614     HDC   hdcMatch;
00615     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndClip;
00616     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOrg;
00617     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>  pdce;
00618     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>  *ppdce;
00619     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>  *ppdceNotInUse;
00620     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> DCX_flagsMatch;
00621     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bpwndOrgVisible;
00622     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndLayer;
00623     HBITMAP hbmLayer;
00624     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fVisRgnError = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00625 
00626     <span class="comment">/*</span>
00627 <span class="comment">     * Lock the device while we're playing with visrgns.</span>
00628 <span class="comment">     */</span>
00629     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00630 
00631     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00632         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
00633 
00634     hdcMatch = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00635     pwndOrg  = pwndClip = pwnd;
00636 
00637     bpwndOrgVisible = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwndOrg);
00638 
00639     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;W32PF_Flags &amp; W32PF_OWNDCCLEANUP) {
00640         <a class="code" href="../../d4/d1/userk_8h.html#a1705">DelayedDestroyCacheDC</a>();
00641     }
00642 
00643     <span class="comment">/*</span>
00644 <span class="comment">     * If necessary, compute DCX flags from window style.</span>
00645 <span class="comment">     */</span>
00646     <span class="keywordflow">if</span> (DCX_flags &amp; DCX_USESTYLE) {
00647 
00648         DCX_flags &amp;= ~(DCX_CLIPSIBLINGS | DCX_CLIPCHILDREN | DCX_PARENTCLIP);
00649 
00650         <span class="keywordflow">if</span> (!(DCX_flags &amp; DCX_WINDOW)) {
00651 
00652             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a476">CFPARENTDC</a>))
00653                 DCX_flags |= DCX_PARENTCLIP;
00654 
00655             <span class="comment">/*</span>
00656 <span class="comment">             * If the DCX_CACHE flag is present, override OWNDC/CLASSDC.</span>
00657 <span class="comment">             * Otherwise, calculate from appropriate style bits.</span>
00658 <span class="comment">             */</span>
00659             <span class="keywordflow">if</span> (!(DCX_flags &amp; DCX_CACHE) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a474">CFOWNDC</a>)) {
00660                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a475">CFCLASSDC</a>)) {
00661                     <span class="comment">/*</span>
00662 <span class="comment">                     * Look for a non-cache entry that matches hdc...</span>
00663 <span class="comment">                     */</span>
00664                     <span class="keywordflow">if</span> (pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o4">pdce</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00665                         hdcMatch = pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o4">pdce</a>-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>;
00666                     }
00667                 } <span class="keywordflow">else</span> {
00668                     DCX_flags |= DCX_CACHE;
00669                 }
00670             }
00671 
00672             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
00673                 DCX_flags |= DCX_CLIPCHILDREN;
00674 
00675             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00676                 DCX_flags |= DCX_CLIPSIBLINGS;
00677 
00678             <span class="comment">/*</span>
00679 <span class="comment">             * Minimized windows never exclude their children.</span>
00680 <span class="comment">             */</span>
00681             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00682                 DCX_flags &amp;= ~DCX_CLIPCHILDREN;
00683 
00684                 <span class="keywordflow">if</span> (pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;spicn)
00685                     DCX_flags |= DCX_CACHE;
00686             }
00687 
00688         } <span class="keywordflow">else</span> {
00689             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00690                 DCX_flags |= DCX_CLIPSIBLINGS;
00691 
00692             DCX_flags |= DCX_CACHE;
00693 
00694             <span class="comment">/*</span>
00695 <span class="comment">             * Window DCs never exclude children.</span>
00696 <span class="comment">             */</span>
00697         }
00698     }
00699 
00700     <span class="comment">/*</span>
00701 <span class="comment">     * Deal with all the Win 3.0-compatible clipping rules:</span>
00702 <span class="comment">     *</span>
00703 <span class="comment">     * DCX_NOCLIPCHILDREN overrides:</span>
00704 <span class="comment">     *      DCX_PARENTCLIP/CS_OWNDC/CS_CLASSDC</span>
00705 <span class="comment">     * DCX_PARENTCLIP overrides:</span>
00706 <span class="comment">     *      DCX_CLIPSIBLINGS/DCX_CLIPCHILDREN/CS_OWNDC/CS_CLASSDC</span>
00707 <span class="comment">     */</span>
00708     <span class="keywordflow">if</span> (DCX_flags &amp; DCX_NOCLIPCHILDREN) {
00709         DCX_flags &amp;= ~(DCX_PARENTCLIP | DCX_CLIPCHILDREN);
00710         DCX_flags |= DCX_CACHE;
00711     }
00712 
00713     <span class="comment">/*</span>
00714 <span class="comment">     * Deal with layered windows.</span>
00715 <span class="comment">     */</span>
00716     <span class="keywordflow">if</span> ((pwndLayer = <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(pwndOrg)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00717             (hbmLayer = <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwndLayer, <a class="code" href="../../d4/d1/userk_8h.html#a481">PROP_LAYER</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00718 
00719         <span class="comment">/*</span>
00720 <span class="comment">         * Get a layered redirection DC.</span>
00721 <span class="comment">         */</span>
00722         DCX_flags |= DCX_LAYERED;
00723 
00724         <span class="comment">/*</span>
00725 <span class="comment">         * When the window we're getting the DC for is the layered and</span>
00726 <span class="comment">         * redirected window, don't allow to clip to its parent, since</span>
00727 <span class="comment">         * clipping must not exceed the size of the backing bitmap.</span>
00728 <span class="comment">         */</span>
00729         <span class="keywordflow">if</span> (pwndOrg == pwndLayer) {
00730             DCX_flags &amp;= ~DCX_PARENTCLIP;
00731         }
00732 
00733         <span class="comment">/*</span>
00734 <span class="comment">         * Convert hrgnClip from screen to the redirection DC coordinates.</span>
00735 <span class="comment">         */</span>
00736         <span class="keywordflow">if</span> (hrgnClip &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a879">HRGN_SPECIAL_LAST</a>) {
00737             GreOffsetRgn(hrgnClip, -pwndLayer-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left,
00738                     -pwndLayer-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
00739         }
00740     } <span class="keywordflow">else</span> {
00741         pwndLayer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742         hbmLayer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00743     }
00744 
00745     <span class="keywordflow">if</span> (DCX_flags &amp; DCX_PARENTCLIP) {
00746 
00747         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
00748 
00749         <span class="comment">/*</span>
00750 <span class="comment">         * If this window has no parent.  This can occur if the app is</span>
00751 <span class="comment">         * calling GetDC in response to a CBT_CREATEWND callback.  In this</span>
00752 <span class="comment">         * case, the parent is not yet setup.</span>
00753 <span class="comment">         */</span>
00754         <span class="keywordflow">if</span> (pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00755             pwndParent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
00756         <span class="keywordflow">else</span>
00757             pwndParent = pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
00758 
00759         <span class="comment">/*</span>
00760 <span class="comment">         * Always get the DC from the cache.</span>
00761 <span class="comment">         */</span>
00762         DCX_flags |= DCX_CACHE;
00763 
00764         <span class="comment">/*</span>
00765 <span class="comment">         * We can't use a shared DC if the visibility of the</span>
00766 <span class="comment">         * child does not match the parent's, or if a</span>
00767 <span class="comment">         * CLIPSIBLINGS or CLIPCHILDREN DC is requested.</span>
00768 <span class="comment">         *</span>
00769 <span class="comment">         * In 3.1, we pay attention to the CLIPSIBLINGS and CLIPCHILDREN</span>
00770 <span class="comment">         * bits of CS_PARENTDC windows, by overriding CS_PARENTDC if</span>
00771 <span class="comment">         * either of these flags are requested.</span>
00772 <span class="comment">         *</span>
00773 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
00774 <span class="comment">         *</span>
00775 <span class="comment">         * If parent is CLIPCHILDREN, get a cache DC, but don't</span>
00776 <span class="comment">         * use parent's DC.  Windows PowerPoint depends on this</span>
00777 <span class="comment">         * behavior in order to draw the little gray rect between</span>
00778 <span class="comment">         * its scroll bars correctly.</span>
00779 <span class="comment">         */</span>
00780         <span class="keywordflow">if</span> (!(DCX_flags &amp; (DCX_CLIPSIBLINGS | DCX_CLIPCHILDREN)) &amp;&amp;
00781                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) &amp;&amp;
00782                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>)) {
00783 
00784             pwndClip = pwndParent;
00785 
00786 <span class="preprocessor">#if DBG</span>
00787 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (DCX_flags &amp; DCX_CLIPCHILDREN)
00788                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"WS_CLIPCHILDREN overridden by CS_PARENTDC"</span>);
00789             <span class="keywordflow">if</span> (DCX_flags &amp; DCX_CLIPSIBLINGS)
00790                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"WS_CLIPSIBLINGS overridden by CS_PARENTDC"</span>);
00791 <span class="preprocessor">#endif</span>
00792 <span class="preprocessor"></span>            <span class="comment">/*</span>
00793 <span class="comment">             * Make sure flags reflect hwndClip rather than hwndOrg.</span>
00794 <span class="comment">             * But, we must never clip the children (since that's who</span>
00795 <span class="comment">             * wants to do the drawing!)</span>
00796 <span class="comment">             */</span>
00797             DCX_flags &amp;= ~(DCX_CLIPCHILDREN | DCX_CLIPSIBLINGS);
00798             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>))
00799                 DCX_flags |= DCX_CLIPSIBLINGS;
00800         }
00801     }
00802 
00803     <span class="comment">/*</span>
00804 <span class="comment">     * Make sure we don't return an OWNDC if the calling thread didn't</span>
00805 <span class="comment">     * create this window - need to returned cached always in this case.</span>
00806 <span class="comment">     *</span>
00807 <span class="comment">     * Win95 does not contain this code.  Why?</span>
00808 <span class="comment">     */</span>
00809     <span class="keywordflow">if</span> (!(DCX_flags &amp; DCX_CACHE)) {
00810         <span class="keywordflow">if</span> (pwndOrg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndOrg) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())
00811             DCX_flags |= DCX_CACHE;
00812     }
00813 
00814     DCX_flagsMatch = DCX_flags &amp; DCX_MATCHMASK;
00815 
00816     <span class="keywordflow">if</span> (!(DCX_flags &amp; DCX_CACHE)) {
00817 
00818         <span class="comment">/*</span>
00819 <span class="comment">         * Handle CS_OWNDC and CS_CLASSDC cases specially.  Based on the</span>
00820 <span class="comment">         * supplied match information, we need to find the appropriate DCE.</span>
00821 <span class="comment">         */</span>
00822         <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; (pdce = *ppdce); ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00823 
00824             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE)
00825                 <span class="keywordflow">continue</span>;
00826 
00827             <span class="comment">/*</span>
00828 <span class="comment">             * Look for the entry that matches hdcMatch or pwndOrg...</span>
00829 <span class="comment">             */</span>
00830             <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> == pwndOrg || pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdcMatch))
00831                 <span class="keywordflow">continue</span>;
00832 
00833             <span class="comment">/*</span>
00834 <span class="comment">             * NOTE: The "Multiple-BeginPaint()-of-OWNDC-Window" Conundrum</span>
00835 <span class="comment">             *</span>
00836 <span class="comment">             * There is a situation having to do with OWNDC or CLASSDC window</span>
00837 <span class="comment">             * DCs that can theoretically arise that is handled specially</span>
00838 <span class="comment">             * here and in ReleaseCacheDC().  These DCs are identified with</span>
00839 <span class="comment">             * the DCX_CACHE bit CLEAR.</span>
00840 <span class="comment">             *</span>
00841 <span class="comment">             * In the case where BeginPaint() (or a similar operation) is</span>
00842 <span class="comment">             * called more than once without an intervening EndPaint(), the</span>
00843 <span class="comment">             * DCX_INTERSECTRGN (or DCX_EXCLUDERGN) bit may already be set</span>
00844 <span class="comment">             * when we get here.</span>
00845 <span class="comment">             *</span>
00846 <span class="comment">             * Theoretically, the correct thing to do is to save the current</span>
00847 <span class="comment">             * hrgnClip, and set up the new one here.  In ReleaseCacheDC, the</span>
00848 <span class="comment">             * saved hrgnClip is restored and the visrgn recomputed.</span>
00849 <span class="comment">             *</span>
00850 <span class="comment">             * All of this is only necessary if BOTH calls involve an</span>
00851 <span class="comment">             * hrgnClip that causes the visrgn to be changed (i.e., the</span>
00852 <span class="comment">             * simple hrgnClip test clears the INTERSECTRGN or EXCLUDERGN bit</span>
00853 <span class="comment">             * fails), which is not at all likely.</span>
00854 <span class="comment">             *</span>
00855 <span class="comment">             * When this code encounters this multiple-BeginPaint case it</span>
00856 <span class="comment">             * punts by honoring the new EXCLUDE/INTERSECTRGN bits, but it</span>
00857 <span class="comment">             * first restores the DC to a wide-open visrgn before doing so.</span>
00858 <span class="comment">             * This means that the first EndPaint() will restore the visrgn</span>
00859 <span class="comment">             * to a wide-open DC, rather than clipped to the first</span>
00860 <span class="comment">             * BeginPaint()'s update rgn.  This is a good punt, because worst</span>
00861 <span class="comment">             * case an app does a bit more drawing than it should.</span>
00862 <span class="comment">             */</span>
00863             <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_EXCLUDERGN | DCX_INTERSECTRGN)) &amp;&amp;
00864                     (DCX_flags &amp; (DCX_EXCLUDERGN | DCX_INTERSECTRGN))) {
00865 
00866                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Nested BeginPaint() calls, please fix Your app!"</span>);
00867                 <a class="code" href="../../d4/d1/userk_8h.html#a1702">DeleteHrgnClip</a>(pdce);
00868             }
00869 
00870             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) {
00871                 <span class="comment">/*</span>
00872 <span class="comment">                 * We're giving out the same DC again. Since it may not have</span>
00873 <span class="comment">                 * been released, transfer any accumulated bits if needed.</span>
00874 <span class="comment">                 */</span>
00875                 <a class="code" href="../../d4/d1/userk_8h.html#a1986">UpdateLayeredSprite</a>(pdce);
00876             
00877                 <span class="comment">/*</span>
00878 <span class="comment">                 * As this point, the DC may get converted back to a screen</span>
00879 <span class="comment">                 * DC, so we must select the screen surface back into the DC.</span>
00880 <span class="comment">                 */</span>
00881                 UserVerify(GreSelectRedirectionBitmap(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00882             }
00883 
00884             <span class="comment">/*</span>
00885 <span class="comment">             * If we matched exactly, no recomputation necessary</span>
00886 <span class="comment">             * (we found a CS_OWNDC or a CS_CLASSDC that is already set up)</span>
00887 <span class="comment">             * Otherwise, we have a CS_CLASSDC that needs recomputation.</span>
00888 <span class="comment">             */</span>
00889             <span class="keywordflow">if</span> (    pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> == pwndOrg &amp;&amp;
00890                     bpwndOrgVisible &amp;&amp;
00891                     (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) == (DCX_flags &amp; DCX_LAYERED) &amp;&amp;
00892                     !(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_PWNDORGINVISIBLE)) {
00893 
00894                 <span class="keywordflow">goto</span> HaveComputedEntry;
00895             }
00896 
00897             <span class="keywordflow">goto</span> RecomputeEntry;
00898         }
00899 
00900         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Couldn't find DC for %p - bad code path"</span>, pwndOrg);
00901 
00902 NullExit:
00903 
00904         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
00905         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00906 
00907     } <span class="keywordflow">else</span> {
00908 
00909         <span class="comment">/*</span>
00910 <span class="comment">         * Make a quick pass through the cache, looking for an</span>
00911 <span class="comment">         * exact match.</span>
00912 <span class="comment">         */</span>
00913 SearchAgain:
00914 
00915 <span class="preprocessor">#if DBG</span>
00916 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fDisableCache)
00917             <span class="keywordflow">goto</span> SearchFailed;
00918 <span class="preprocessor">#endif</span>
00919 <span class="preprocessor"></span>
00920         <span class="comment">/*</span>
00921 <span class="comment">         * CONSIDER (adams): Put this check into the loop above so we don't</span>
00922 <span class="comment">         * touch all these pages twice?</span>
00923 <span class="comment">         */</span>
00924         <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; (pdce = *ppdce); ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00925 
00926             <span class="comment">/*</span>
00927 <span class="comment">             * If we find an entry that is not in use and whose clip flags</span>
00928 <span class="comment">             * and clip window match, we can use it.</span>
00929 <span class="comment">             *</span>
00930 <span class="comment">             * NOTE: DCX_INTERSECT/EXCLUDERGN cache entries always have</span>
00931 <span class="comment">             * DCX_INUSE set, so we'll never erroneously match one here.</span>
00932 <span class="comment">             */</span>
00933             UserAssert(!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INTERSECTRGN | DCX_EXCLUDERGN)) ||
00934                        (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE));
00935 
00936             <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a> == pwndClip) &amp;&amp;
00937                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00938                 (DCX_flagsMatch == (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_MATCHMASK | DCX_INUSE | DCX_INVALID)))) {
00939 
00940                 <span class="comment">/*</span>
00941 <span class="comment">                 * Special case for icon - bug 9103 (win31)</span>
00942 <span class="comment">                 */</span>
00943                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndClip, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp;
00944                     (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> != pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>)) {
00945                     <span class="keywordflow">continue</span>;
00946                 }
00947 
00948                 <span class="comment">/*</span>
00949 <span class="comment">                 * If the pwndOrg of the DC we found is not visible and</span>
00950 <span class="comment">                 * the pwndOrg we're looking for is visble, then</span>
00951 <span class="comment">                 * the visrgn is no good, we can't reuse it so keep</span>
00952 <span class="comment">                 * looking.</span>
00953 <span class="comment">                 */</span>
00954                 <span class="keywordflow">if</span> (bpwndOrgVisible &amp;&amp; pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_PWNDORGINVISIBLE) {
00955                     <span class="keywordflow">continue</span>;
00956                 }
00957 
00958                 <span class="comment">/*</span>
00959 <span class="comment">                 * Set INUSE before performing any GDI operations, just</span>
00960 <span class="comment">                 * in case DCHook() has a mind to recalculate the visrgn...</span>
00961 <span class="comment">                 */</span>
00962                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_INUSE;
00963 
00964                 <span class="comment">/*</span>
00965 <span class="comment">                 * We found an entry with the proper visrgn.</span>
00966 <span class="comment">                 * If the origin doesn't match, update the CE and reset it.</span>
00967 <span class="comment">                 */</span>
00968                 <span class="keywordflow">if</span> (pwndOrg != pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) {
00969                     <span class="comment">/*</span>
00970 <span class="comment">                     * Need to flush any dirty rectangle stuff now.</span>
00971 <span class="comment">                     */</span>
00972                     <a class="code" href="../../d4/d1/userk_8h.html#a1771">SpbCheckDce</a>(pdce);
00973 
00974                     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> = pwndOrg;
00975                     <a class="code" href="../../d8/d3/dc_8c.html#a4">ResetOrg</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pdce, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00976                 }
00977 
00978                 <span class="keywordflow">goto</span> HaveComputedEntry;
00979             }
00980         }
00981 
00982 <span class="preprocessor">#if DBG</span>
00983 <span class="preprocessor"></span>SearchFailed:
00984 <span class="preprocessor">#endif</span>
00985 <span class="preprocessor"></span>
00986         <span class="comment">/*</span>
00987 <span class="comment">         * Couldn't find an exact match.  Find some invalid or non-inuse</span>
00988 <span class="comment">         * entry we can reuse.</span>
00989 <span class="comment">         */</span>
00990         ppdceNotInUse = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00991         <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; (pdce = *ppdce); ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00992 
00993             <span class="comment">/*</span>
00994 <span class="comment">             * Skip non-cache entries</span>
00995 <span class="comment">             */</span>
00996             <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE))
00997                 <span class="keywordflow">continue</span>;
00998 
00999             <span class="comment">/*</span>
01000 <span class="comment">             * Skip monitor-specific entires</span>
01001 <span class="comment">             */</span>
01002             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01003                 <span class="keywordflow">continue</span>;
01004 
01005             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INVALID) {
01006                 <span class="keywordflow">break</span>;
01007             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
01008 
01009                 <span class="comment">/*</span>
01010 <span class="comment">                 * Remember the non-inuse one, but keep looking for an invalid.</span>
01011 <span class="comment">                 */</span>
01012                 ppdceNotInUse = ppdce;
01013             }
01014         }
01015 
01016         <span class="comment">/*</span>
01017 <span class="comment">         * If we broke out of the loop, we found an invalid entry to reuse.</span>
01018 <span class="comment">         * Otherwise see if we found a non-inuse entry to reuse.</span>
01019 <span class="comment">         */</span>
01020         <span class="keywordflow">if</span> (pdce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ((ppdce = ppdceNotInUse) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01021 
01022             <span class="comment">/*</span>
01023 <span class="comment">             * Create another DCE if we need it.</span>
01024 <span class="comment">             */</span>
01025             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1699">CreateCacheDC</a>(pwndOrg,
01026                                DCX_INVALID | DCX_CACHE |
01027                                (DCX_flags &amp; DCX_LAYERED),
01028                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01029                 <span class="keywordflow">goto</span> NullExit;
01030             }
01031 
01032             <span class="keywordflow">goto</span> SearchAgain;
01033         }
01034 
01035         <span class="comment">/*</span>
01036 <span class="comment">         * We've chosen an entry to reuse: now fill it in and recompute it.</span>
01037 <span class="comment">         */</span>
01038         pdce = *ppdce;
01039 
01040 RecomputeEntry:
01041 
01042         <span class="comment">/*</span>
01043 <span class="comment">         * Any non-invalid entries that we reuse might still have some bounds</span>
01044 <span class="comment">         * that need to be used to invalidate SPBs.  Apply them here.</span>
01045 <span class="comment">         */</span>
01046         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INVALID))
01047             <a class="code" href="../../d4/d1/userk_8h.html#a1771">SpbCheckDce</a>(pdce);
01048 
01049         <span class="comment">/*</span>
01050 <span class="comment">         * We want to compute only the matchable visrgn at first,</span>
01051 <span class="comment">         * so we don't set up hrgnClip, or set the EXCLUDERGN or INTERSECTRGN</span>
01052 <span class="comment">         * bits yet -- we'll deal with those later.</span>
01053 <span class="comment">         */</span>
01054         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> = DCX_flagsMatch | DCX_INUSE;
01055 
01056 <span class="preprocessor">#if DBG</span>
01057 <span class="preprocessor"></span>        <span class="comment">/*</span>
01058 <span class="comment">         * We're about to select the visrgn into the DC, even though it's</span>
01059 <span class="comment">         * not yet completely setup. Turn off the visrgn validation for now.</span>
01060 <span class="comment">         * It will be turned on before this function returns.</span>
01061 <span class="comment">         */</span>
01062         GreValidateVisrgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01063 <span class="preprocessor">#endif</span>
01064 <span class="preprocessor"></span>
01065         <span class="comment">/*</span>
01066 <span class="comment">         * Now recompute the visrgn (minus any hrgnClip shenanigans)</span>
01067 <span class="comment">         */</span>
01068         hrgn = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01069         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgn, pwndOrg, pwndClip, DCX_flagsMatch) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01070             pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_PWNDORGINVISIBLE;
01071         }
01072 
01073         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>        = pwndOrg;
01074         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>       = pwndClip;
01075         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;      <span class="comment">// Just in case...</span>
01076         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01077 
01078         <a class="code" href="../../d8/d3/dc_8c.html#a4">ResetOrg</a>(hrgn, pdce, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01079 
01080         <span class="keywordflow">if</span> (hrgn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01081             fVisRgnError = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01082         }
01083 
01084         <span class="comment">/*</span>
01085 <span class="comment">         * When we arrive here, pdce (and *ppdce) point to</span>
01086 <span class="comment">         * a cache entry whose visrgn and origin are set up.</span>
01087 <span class="comment">         * All that remains to be done is to deal with EXCLUDE/INTERSECTRGN</span>
01088 <span class="comment">         */</span>
01089 HaveComputedEntry:
01090 
01091         <span class="comment">/*</span>
01092 <span class="comment">         * If the window clipping flags have changed in the window</span>
01093 <span class="comment">         * since the last time this dc was invalidated, then recompute</span>
01094 <span class="comment">         * this dc entry.</span>
01095 <span class="comment">         */</span>
01096         <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_MATCHMASK) != (DCX_flags &amp; DCX_MATCHMASK))
01097             <span class="keywordflow">goto</span> RecomputeEntry;
01098 
01099         <span class="comment">/*</span>
01100 <span class="comment">         * Let's check these assertions just in case...</span>
01101 <span class="comment">         */</span>
01102         UserAssert(pdce);
01103         UserAssert(*ppdce == pdce);
01104         UserAssert(pdce-&gt;DCX_flags &amp; DCX_INUSE);
01105         UserAssert(!(pdce-&gt;DCX_flags &amp; DCX_INVALID));
01106         UserAssert((pdce-&gt;DCX_flags &amp; DCX_MATCHMASK) == (DCX_flags &amp; DCX_MATCHMASK));
01107 
01108         <span class="comment">/*</span>
01109 <span class="comment">         * Move the dce to the head of the list so it's easy to find later.</span>
01110 <span class="comment">         */</span>
01111         <span class="keywordflow">if</span> (pdce != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>) {
01112             *ppdce = pdce-&gt;pdceNext;
01113             pdce-&gt;pdceNext = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>;
01114             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> = pdce;
01115         }
01116 
01117 <span class="preprocessor">#if DBG</span>
01118 <span class="preprocessor"></span>        <span class="comment">/*</span>
01119 <span class="comment">         * We're about to mess with the visrgn in this DC, even though it's</span>
01120 <span class="comment">         * not yet completely setup. Turn off the visrgn validation for now.</span>
01121 <span class="comment">         * It will be turned on before this function returns.</span>
01122 <span class="comment">         */</span>
01123         GreValidateVisrgn(pdce-&gt;hdc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01124 <span class="preprocessor">#endif</span>
01125 <span class="preprocessor"></span>
01126         <span class="comment">/*</span>
01127 <span class="comment">         * Time to deal with DCX_INTERSECTRGN or DCX_EXCLUDERGN.</span>
01128 <span class="comment">         *</span>
01129 <span class="comment">         * We handle these two bits specially, because cache entries</span>
01130 <span class="comment">         * with these bits set cannot be reused with the bits set.  This</span>
01131 <span class="comment">         * is because the area described in hrgnClip would have to be</span>
01132 <span class="comment">         * compared along with the bit, which is a pain, especially since</span>
01133 <span class="comment">         * they'd never match very often anyhow.</span>
01134 <span class="comment">         *</span>
01135 <span class="comment">         * What we do instead is to save the visrgn of the window before</span>
01136 <span class="comment">         * applying either of these two flags, which is then restored</span>
01137 <span class="comment">         * at ReleaseCacheDC() time, along with the clearing of these bits.</span>
01138 <span class="comment">         * This effectively converts a cache entry with either of these</span>
01139 <span class="comment">         * bits set into a "normal" cache entry that can be matched.</span>
01140 <span class="comment">         */</span>
01141         <span class="keywordflow">if</span> (DCX_flags &amp; DCX_INTERSECTRGN) {
01142 
01143             <span class="keywordflow">if</span> (hrgnClip != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01144 
01145                 <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
01146 
01147                 <span class="comment">/*</span>
01148 <span class="comment">                 * Save the visrgn for reuse on ReleaseDC().</span>
01149 <span class="comment">                 * (do this BEFORE we set hrgnClip &amp; pdce-&gt;flag bit,</span>
01150 <span class="comment">                 * so that if a DCHook() callback occurs it recalculates</span>
01151 <span class="comment">                 * without hrgnClip)</span>
01152 <span class="comment">                 */</span>
01153                 UserAssertMsg0(!pdce-&gt;hrgnSavedVis,
01154                                <span class="stringliteral">"Nested SaveVisRgn attempt in _GetDCEx"</span>);
01155 
01156                 <span class="comment">/*</span>
01157 <span class="comment">                 * get the current vis region into hrgnSavedVis.  Temporarily</span>
01158 <span class="comment">                 * store a dummy one in the DC.</span>
01159 <span class="comment">                 */</span>
01160 
01161                 pdce-&gt;hrgnSavedVis = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
01162 
01163                 GreSelectVisRgn(pdce-&gt;hdc,pdce-&gt;hrgnSavedVis, SVR_SWAP);
01164 
01165                 pdce-&gt;hrgnClip = hrgnClip;
01166 
01167                 <span class="keywordflow">if</span> (DCX_flags &amp; DCX_NODELETERGN)
01168                     pdce-&gt;DCX_flags |= DCX_NODELETERGN;
01169 
01170                 pdce-&gt;DCX_flags |= DCX_INTERSECTRGN;
01171 
01172                 <span class="keywordflow">if</span> (hrgnClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01173 
01174                     pdce-&gt;hrgnClipPublic = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01175 
01176                 } <span class="keywordflow">else</span> {
01177 
01178                     <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, pdce-&gt;hrgnSavedVis, hrgnClip);
01179 
01180                     <span class="comment">/*</span>
01181 <span class="comment">                     * Make a copy of the hrgnClip and make it public</span>
01182 <span class="comment">                     * so that we can use it in calculations in HungDraw.</span>
01183 <span class="comment">                     */</span>
01184                     pdce-&gt;hrgnClipPublic = <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>();
01185                     <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(pdce-&gt;hrgnClipPublic, hrgnClip);
01186                 }
01187 
01188                 <span class="comment">/*</span>
01189 <span class="comment">                 * Clear the SAVEDRGNINVALID bit, since we're just</span>
01190 <span class="comment">                 * about to set it properly now.  If the dce later</span>
01191 <span class="comment">                 * gets invalidated, it'll set this bit so we know</span>
01192 <span class="comment">                 * to recompute it when we restore the visrgn.</span>
01193 <span class="comment">                 */</span>
01194                 pdce-&gt;DCX_flags &amp;= ~DCX_SAVEDRGNINVALID;
01195 
01196                 <span class="comment">/*</span>
01197 <span class="comment">                 * Select in the new region.  we use the SWAP_REGION mode</span>
01198 <span class="comment">                 * so that ghrgnGDC always has a valid rgn</span>
01199 <span class="comment">                 */</span>
01200 
01201                 GreSelectVisRgn(pdce-&gt;hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, SVR_SWAP);
01202             }
01203         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DCX_flags &amp; DCX_EXCLUDERGN) {
01204 
01205             <span class="keywordflow">if</span> (hrgnClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206 
01207                 <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
01208 
01209                 <span class="comment">/*</span>
01210 <span class="comment">                 * Save the visrgn for reuse on ReleaseDC().</span>
01211 <span class="comment">                 * (do this BEFORE we set hrgnClip &amp; pdce-&gt;flag bit,</span>
01212 <span class="comment">                 * so that if a DCHook() callback occurs it recalculates</span>
01213 <span class="comment">                 * without hrgnClip)</span>
01214 <span class="comment">                 */</span>
01215                 UserAssertMsg0(!pdce-&gt;hrgnSavedVis,
01216                                <span class="stringliteral">"Nested SaveVisRgn attempt in _GetDCEx"</span>);
01217 
01218                 <span class="comment">/*</span>
01219 <span class="comment">                 * get the current vis region into hrgnSavedVis.  Temporarily</span>
01220 <span class="comment">                 * store a dummy one in the DC.</span>
01221 <span class="comment">                 */</span>
01222                 pdce-&gt;hrgnSavedVis = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
01223 
01224                 GreSelectVisRgn(pdce-&gt;hdc,pdce-&gt;hrgnSavedVis, SVR_SWAP);
01225 
01226                 pdce-&gt;hrgnClip = hrgnClip;
01227 
01228                 <span class="keywordflow">if</span> (DCX_flags &amp; DCX_NODELETERGN)
01229                     pdce-&gt;DCX_flags |= DCX_NODELETERGN;
01230 
01231                 pdce-&gt;DCX_flags |= DCX_EXCLUDERGN;
01232 
01233                 <span class="keywordflow">if</span> (hrgnClip == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01234 
01235                     pdce-&gt;hrgnClipPublic = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
01236 
01237                 } <span class="keywordflow">else</span> {
01238 
01239                     <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, pdce-&gt;hrgnSavedVis, hrgnClip);
01240 
01241                     <span class="comment">/*</span>
01242 <span class="comment">                     * Make a copy of the hrgnClip and make it public</span>
01243 <span class="comment">                     * so that we can use it in calculations in HungDraw.</span>
01244 <span class="comment">                     */</span>
01245                     pdce-&gt;hrgnClipPublic = <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>();
01246                     <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(pdce-&gt;hrgnClipPublic, hrgnClip);
01247                 }
01248 
01249                 <span class="comment">/*</span>
01250 <span class="comment">                 * Clear the SAVEDRGNINVALID bit, since we're just</span>
01251 <span class="comment">                 * about to set it properly now.  If the dce later</span>
01252 <span class="comment">                 * gets invalidated, it'll set this bit so we know</span>
01253 <span class="comment">                 * to recompute it when we restore the visrgn.</span>
01254 <span class="comment">                 */</span>
01255                 pdce-&gt;DCX_flags &amp;= ~DCX_SAVEDRGNINVALID;
01256 
01257                 <span class="comment">/*</span>
01258 <span class="comment">                 * Select in the new region.  we use the SWAP_REGION mode</span>
01259 <span class="comment">                 * so that ghrgnGDC always has a valid rgn</span>
01260 <span class="comment">                 */</span>
01261 
01262                 GreSelectVisRgn(pdce-&gt;hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, SVR_SWAP);
01263             }
01264         }
01265     }
01266 
01267     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) {
01268         UserAssert(pwndLayer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01269         UserAssert(hbmLayer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01270 
01271         UserVerify(GreSelectRedirectionBitmap(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, hbmLayer));
01272 
01273         <span class="comment">/*</span>
01274 <span class="comment">         * Enable bounds accumulation, so we know if there was any drawing</span>
01275 <span class="comment">         * done into that DC and the actual rect we need to update when</span>
01276 <span class="comment">         * this DC is released.</span>
01277 <span class="comment">         */</span>
01278         GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, GGB_ENABLE_WINMGR);
01279 
01280         <span class="comment">/*</span>
01281 <span class="comment">         * In case the visrgn couldn't be allocated, clear it in the</span>
01282 <span class="comment">         * dc again, since we just selected a new surface.</span>
01283 <span class="comment">         */</span>
01284         <span class="keywordflow">if</span> (fVisRgnError) {
01285             GreSelectVisRgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, SVR_DELETEOLD);
01286         }
01287     }
01288 
01289     <span class="comment">/*</span>
01290 <span class="comment">     * Whew! Set ownership and return the bloody DC.</span>
01291 <span class="comment">     * Only set ownership for cache dcs.  Own dcs have already been owned.</span>
01292 <span class="comment">     * The reason why we don't want to set the ownership over again is</span>
01293 <span class="comment">     * because the console sets its owndcs to PUBLIC so gdisrv can use</span>
01294 <span class="comment">     * them without asserting.  We don't want to set the ownership back</span>
01295 <span class="comment">     * again.</span>
01296 <span class="comment">     */</span>
01297     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE) {
01298 
01299         <span class="keywordflow">if</span> (!GreSetDCOwner(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, OBJECT_OWNER_CURRENT)) {
01300             RIPMSG1(RIP_WARNING, <span class="stringliteral">"GetDCEx: SetDCOwner Failed %lX"</span>, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>);
01301         }
01302 
01303         <span class="comment">/*</span>
01304 <span class="comment">         * Decrement the Free DCE Count.  This should always be &gt;= 0,</span>
01305 <span class="comment">         * since we'll create a new dce if the cache is all in use.</span>
01306 <span class="comment">         */</span>
01307         <a class="code" href="../../d8/d3/dc_8c.html#a1">DecrementFreeDCECount</a>();
01308 
01309         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a> = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01310     }
01311 
01312 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01313 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL) &amp;&amp; !(DCX_flags &amp; DCX_NOMIRROR)) {
01314         GreSetLayout(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, -1, LAYOUT_RTL);
01315     }
01316 <span class="preprocessor">#endif</span>
01317 <span class="preprocessor"></span>
01318 <span class="preprocessor">#if DBG</span>
01319 <span class="preprocessor"></span>    GreValidateVisrgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01320 <span class="preprocessor">#endif</span>
01321 <span class="preprocessor"></span>
01322     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01323 
01324     <span class="keywordflow">return</span> pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>;
01325 }
01326 
01327 <span class="comment">/***************************************************************************\</span>
01328 <span class="comment">* ReleaseCacheDC</span>
01329 <span class="comment">*</span>
01330 <span class="comment">* Releases a DC from the cache.</span>
01331 <span class="comment">*</span>
01332 <span class="comment">* History:</span>
01333 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01334 <span class="comment">* 20-Dec-1995 ChrisWil  Added (hrgnClipPublic) entry.</span>
01335 <span class="comment">\***************************************************************************/</span>
01336 
<a name="l01337"></a><a class="code" href="../../d4/d1/userk_8h.html#a1698">01337</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1698">ReleaseCacheDC</a>(
01338     HDC  hdc,
01339     BOOL fEndPaint)
01340 {
01341     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01342     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> *ppdce;
01343 
01344     <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; (pdce = *ppdce); ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01345 
01346         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc) {
01347 
01348             <span class="comment">/*</span>
01349 <span class="comment">             * Check for redundant releases or release of an invalid entry</span>
01350 <span class="comment">             */</span>
01351             <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_DESTROYTHIS | DCX_INVALID | DCX_INUSE)) != DCX_INUSE)
01352                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a398">DCE_NORELEASE</a>;
01353 
01354             <span class="comment">/*</span>
01355 <span class="comment">             * Lock the display since we may be playing with visrgns.</span>
01356 <span class="comment">             */</span>
01357             GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01358 
01359             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) {
01360                 <a class="code" href="../../d4/d1/userk_8h.html#a1986">UpdateLayeredSprite</a>(pdce);
01361             }
01362 
01363             <span class="comment">/*</span>
01364 <span class="comment">             * If this is a permanent DC, then don't reset its state.</span>
01365 <span class="comment">             */</span>
01366             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE) {
01367                 <span class="comment">/*</span>
01368 <span class="comment">                 * Restore the DC state and mark the entry as not in use.</span>
01369 <span class="comment">                 * Set owner back to server as well, since it's going back</span>
01370 <span class="comment">                 * into the cache.</span>
01371 <span class="comment">                 */</span>
01372                 <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_NORESETATTRS)) {
01373                     <span class="comment">/*</span>
01374 <span class="comment">                     * If bSetupDC() failed, the DC is busy (ie. in-use</span>
01375 <span class="comment">                     * by another thread), so don't release it.</span>
01376 <span class="comment">                     */</span>
01377                     <span class="keywordflow">if</span> ( (!(GreCleanDC(hdc))) ||
01378                          (!(GreSetDCOwner(hdc, OBJECT_OWNER_NONE))) ) {
01379 
01380                         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01381                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a398">DCE_NORELEASE</a>;
01382                     }
01383 
01384                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!GreSetDCOwner(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, OBJECT_OWNER_NONE)) {
01385 
01386                     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01387                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a398">DCE_NORELEASE</a>;
01388                 }
01389 
01390                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01391                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a>    &amp;= ~DCX_INUSE;
01392 
01393 <span class="preprocessor">#if DBG</span>
01394 <span class="preprocessor"></span>                <span class="comment">/*</span>
01395 <span class="comment">                 * Turn off checked only surface validation for now, since</span>
01396 <span class="comment">                 * we may select a different surface (screen) in this DC that</span>
01397 <span class="comment">                 * may not correspond to the visrgn currently in the DC. When</span>
01398 <span class="comment">                 * the DC is given out again, it will be revalidated.</span>
01399 <span class="comment">                 */</span>
01400                 GreValidateVisrgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01401 <span class="preprocessor">#endif</span>
01402 <span class="preprocessor"></span>
01403                 <span class="comment">/*</span>
01404 <span class="comment">                 * The DC is no longer in use, so unselect the redirection</span>
01405 <span class="comment">                 * bitmap from it.</span>
01406 <span class="comment">                 */</span>
01407                 <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) {
01408                     UserVerify(GreSelectRedirectionBitmap(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
01409                 }
01410 
01411                 <span class="comment">/*</span>
01412 <span class="comment">                 * Increment the Free DCE count.  This holds the count</span>
01413 <span class="comment">                 * of available DCEs.  Check the threshold, and destroy</span>
01414 <span class="comment">                 * the dce if it's above the mark.</span>
01415 <span class="comment">                 */</span>
01416                 <a class="code" href="../../d8/d3/dc_8c.html#a2">IncrementFreeDCECount</a>();
01417 
01418                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a180">gnDCECount</a> &gt; <a class="code" href="../../d4/d1/userk_8h.html#a395">DCE_SIZE_CACHETHRESHOLD</a>) {
01419                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1700">DestroyCacheDC</a>(ppdce, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>)) {
01420                         GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01421                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a397">DCE_FREED</a>;
01422                     }
01423                 }
01424             }
01425 
01426             <span class="comment">/*</span>
01427 <span class="comment">             * If we have an EXCLUDERGN or INTERSECTRGN cache entry,</span>
01428 <span class="comment">             * convert it back to a "normal" cache entry by restoring</span>
01429 <span class="comment">             * the visrgn and blowing away hrgnClip.</span>
01430 <span class="comment">             *</span>
01431 <span class="comment">             * Note that for non-DCX_CACHE DCs, we only do this if</span>
01432 <span class="comment">             * we're being called from EndPaint().</span>
01433 <span class="comment">             */</span>
01434             <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_EXCLUDERGN | DCX_INTERSECTRGN)) &amp;&amp;
01435                     ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE) || fEndPaint)) {
01436                 <a class="code" href="../../d4/d1/userk_8h.html#a1702">DeleteHrgnClip</a>(pdce);
01437             }
01438 
01439             GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01440             <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a396">DCE_RELEASED</a>;
01441         }
01442     }
01443 
01444     <span class="comment">/*</span>
01445 <span class="comment">     * Yell if DC couldn't be found...</span>
01446 <span class="comment">     */</span>
01447     RIPERR1(ERROR_DC_NOT_FOUND, RIP_WARNING,
01448             <span class="stringliteral">"Invalid device context (DC) handle passed to ReleaseCacheDC (0x%08lx)"</span>, hdc);
01449 
01450     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a398">DCE_NORELEASE</a>;
01451 }
01452 
01453 <span class="comment">/***************************************************************************\</span>
01454 <span class="comment">* CreateCacheDC</span>
01455 <span class="comment">*</span>
01456 <span class="comment">* Creates a DCE and adds it to the cache.</span>
01457 <span class="comment">*</span>
01458 <span class="comment">* History:</span>
01459 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01460 <span class="comment">* 20-Dec-1995 ChrisWil  Added (hrgnClipPublic) entry.</span>
01461 <span class="comment">\***************************************************************************/</span>
01462 
<a name="l01463"></a><a class="code" href="../../d4/d1/userk_8h.html#a1699">01463</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1699">CreateCacheDC</a>(
01464         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndOrg,
01465         DWORD DCX_flags,
01466         <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor
01467         )
01468 {
01469     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01470     HDC  hdc;
01471     HANDLE hDev;
01472 
01473     <span class="keywordflow">if</span> ((pdce = (<a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/structtagDCE.html">DCE</a>), TAG_DCE)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01474         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01475 
01476     <span class="keywordflow">if</span> (pMonitor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01477         hDev = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>;
01478     } <span class="keywordflow">else</span> {
01479         hDev = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o8">hDev</a>;
01480     }
01481 
01482     <span class="keywordflow">if</span> ((hdc = GreCreateDisplayDC(hDev, DCTYPE_DIRECT, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01483         UserFreePool(pdce);
01484         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01485     }
01486 
01487     <span class="comment">/*</span>
01488 <span class="comment">     * Link this entry into the cache entry list.</span>
01489 <span class="comment">     */</span>
01490     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>      = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>;
01491     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> = pdce;
01492 
01493     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>            = hdc;
01494     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a>      = DCX_flags;
01495     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>        = pwndOrg;
01496     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>       = pwndOrg;
01497     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>       = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01498     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01499     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a>   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01500     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a>       = pMonitor;
01501 
01502     <span class="comment">/*</span>
01503 <span class="comment">     * Mark it as undeleteable so no application can delete it out of our</span>
01504 <span class="comment">     * cache!</span>
01505 <span class="comment">     */</span>
01506     GreMarkUndeletableDC(hdc);
01507 
01508     <span class="keywordflow">if</span> (DCX_flags &amp; DCX_OWNDC) {
01509 
01510         <span class="comment">/*</span>
01511 <span class="comment">         * Set the ownership of owndcs immediately: that way console can set</span>
01512 <span class="comment">         * the owernship to PUBLIC when it calls GetDC so that both the input</span>
01513 <span class="comment">         * thread and the service threads can use the same owndc.</span>
01514 <span class="comment">         */</span>
01515         GreSetDCOwner(hdc, OBJECT_OWNER_CURRENT);
01516         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a> = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01517 
01518     } <span class="keywordflow">else</span> {
01519 
01520         <span class="comment">/*</span>
01521 <span class="comment">         * Otherwise it is a cache dc...  set its owner to none - nothing</span>
01522 <span class="comment">         * is using it - equivalent of "being in the cache" but unaccessible</span>
01523 <span class="comment">         * to other processes.</span>
01524 <span class="comment">         */</span>
01525         GreSetDCOwner(hdc, OBJECT_OWNER_NONE);
01526         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01527 
01528         <span class="comment">/*</span>
01529 <span class="comment">         * Increment the available-cacheDC count.  Once this hits our</span>
01530 <span class="comment">         * threshold, then we can free-up some of the entries.</span>
01531 <span class="comment">         */</span>
01532         <a class="code" href="../../d8/d3/dc_8c.html#a2">IncrementFreeDCECount</a>();
01533     }
01534 
01535     <span class="comment">/*</span>
01536 <span class="comment">     * If we're creating a permanent DC, then compute it now.</span>
01537 <span class="comment">     */</span>
01538     <span class="keywordflow">if</span> (!(DCX_flags &amp; DCX_CACHE)) {
01539 
01540         <span class="comment">/*</span>
01541 <span class="comment">         * Set up the class DC now...</span>
01542 <span class="comment">         */</span>
01543         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndOrg, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a475">CFCLASSDC</a>))
01544             pwndOrg-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o4">pdce</a> = pdce;
01545 
01546         <span class="comment">/*</span>
01547 <span class="comment">         * Finish setting up DCE and force eventual visrgn calculation.</span>
01548 <span class="comment">         */</span>
01549         UserAssert(!(DCX_flags &amp; DCX_WINDOW));
01550 
01551         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_INUSE;
01552 
01553         <a class="code" href="../../d4/d1/userk_8h.html#a1701">InvalidateDce</a>(pdce);
01554     }
01555 
01556     <span class="comment">/*</span>
01557 <span class="comment">     * If there are any spb's around then enable bounds accumulation.</span>
01558 <span class="comment">     */</span>
01559     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>())
01560         GreGetBounds(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCB_ENABLE | DCB_SET | DCB_WINDOWMGR);
01561 
01562     <span class="keywordflow">return</span> pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>;
01563 }
01564 
01565 <span class="comment">/***************************************************************************\</span>
01566 <span class="comment">* WindowFromCacheDC</span>
01567 <span class="comment">*</span>
01568 <span class="comment">* Returns the window associated with a DC.</span>
01569 <span class="comment">*</span>
01570 <span class="comment">* History:</span>
01571 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01572 <span class="comment">\***************************************************************************/</span>
01573 
<a name="l01574"></a><a class="code" href="../../d4/d1/userk_8h.html#a1703">01574</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1703">WindowFromCacheDC</a>(
01575     HDC hdc)
01576 {
01577     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01578     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01579 
01580         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc)
01581             <span class="keywordflow">return</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_DESTROYTHIS) ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> : pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
01582     }
01583 
01584     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01585 }
01586 
01587 <span class="comment">/***************************************************************************\</span>
01588 <span class="comment">* DelayedDestroyCacheDC</span>
01589 <span class="comment">*</span>
01590 <span class="comment">* Destroys DCE's which have been partially destroyed.</span>
01591 <span class="comment">*</span>
01592 <span class="comment">* History:</span>
01593 <span class="comment">* 16-Jun-1992 DavidPe   Created.</span>
01594 <span class="comment">\***************************************************************************/</span>
01595 
<a name="l01596"></a><a class="code" href="../../d4/d1/userk_8h.html#a1705">01596</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1705">DelayedDestroyCacheDC</a>(VOID)
01597 {
01598     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> *ppdce;
01599     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01600 
01601 
01602     <span class="comment">/*</span>
01603 <span class="comment">     * Zip through the cache looking for a DCX_DESTROYTHIS hdc.</span>
01604 <span class="comment">     */</span>
01605     <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; *ppdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ) {
01606 
01607         <span class="comment">/*</span>
01608 <span class="comment">         * If we found a DCE on this thread that we tried to destroy</span>
01609 <span class="comment">         * earlier, try and destroy it again.</span>
01610 <span class="comment">         */</span>
01611         pdce = *ppdce;
01612 
01613         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_DESTROYTHIS)
01614             <a class="code" href="../../d4/d1/userk_8h.html#a1700">DestroyCacheDC</a>(ppdce, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>);
01615 
01616         <span class="comment">/*</span>
01617 <span class="comment">         * Step to the next DC.  If the DC was deleted, there</span>
01618 <span class="comment">         * is no need to calculate address of the next entry.</span>
01619 <span class="comment">         */</span>
01620         <span class="keywordflow">if</span> (pdce == *ppdce)
01621             ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>;
01622     }
01623 
01624     <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;W32PF_Flags &amp;= ~W32PF_OWNDCCLEANUP;
01625 }
01626 
01627 <span class="comment">/***************************************************************************\</span>
01628 <span class="comment">* DestroyCacheDC</span>
01629 <span class="comment">*</span>
01630 <span class="comment">* Removes a DC from the cache, freeing all resources associated</span>
01631 <span class="comment">* with it.</span>
01632 <span class="comment">*</span>
01633 <span class="comment">* History:</span>
01634 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01635 <span class="comment">* 20-Dec-1995 ChrisWil  Added (hrgnClipPublic) entry.</span>
01636 <span class="comment">\***************************************************************************/</span>
01637 
<a name="l01638"></a><a class="code" href="../../d4/d1/userk_8h.html#a1700">01638</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1700">DestroyCacheDC</a>(
01639     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> *ppdce,
01640     HDC  hdc)
01641 {
01642     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01643 
01644     <span class="comment">/*</span>
01645 <span class="comment">     * Zip through the cache looking for hdc.</span>
01646 <span class="comment">     */</span>
01647     <span class="keywordflow">if</span> (ppdce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01648         <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; (pdce = *ppdce); ppdce = &amp;pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01649             <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc)
01650                 <span class="keywordflow">break</span>;
01651         }
01652     }
01653 
01654     <span class="keywordflow">if</span> (ppdce == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01656 
01657     <span class="comment">/*</span>
01658 <span class="comment">     * Set this here so we know this DCE is supposed to be deleted.</span>
01659 <span class="comment">     */</span>
01660     pdce = *ppdce;
01661     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_DESTROYTHIS;
01662 
01663     <span class="comment">/*</span>
01664 <span class="comment">     * Free up the dce object and contents.</span>
01665 <span class="comment">     */</span>
01666 
01667     <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_NODELETERGN)) {
01668         <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>);
01669         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01670     }
01671 
01672     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01673         GreDeleteObject(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a>);
01674         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o5">hrgnClipPublic</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01675     }
01676 
01677     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01678         GreDeleteObject(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a>);
01679         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o6">hrgnSavedVis</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01680     }
01681 
01682     <span class="comment">/*</span>
01683 <span class="comment">     * If GreSetDCOwner() or GreDeleteDC() fail, the</span>
01684 <span class="comment">     * DC is in-use by another thread.  Set</span>
01685 <span class="comment">     * W32PF_OWNDCCLEANUP so we know to scan for and</span>
01686 <span class="comment">     * delete this DCE later.</span>
01687 <span class="comment">     */</span>
01688     <span class="keywordflow">if</span> (!GreSetDCOwner(hdc, OBJECT_OWNER_PUBLIC)) {
01689         <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;W32PF_Flags |= W32PF_OWNDCCLEANUP;
01690         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01691     }
01692 
01693     <span class="comment">/*</span>
01694 <span class="comment">     * Set the don't rip flag so our routine RipIfCacheDC() doesn't</span>
01695 <span class="comment">     * rip (called back from gdi).</span>
01696 <span class="comment">     */</span>
01697 <span class="preprocessor">#if DBG</span>
01698 <span class="preprocessor"></span>    pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_DONTRIPONDESTROY;
01699     GreMarkDeletableDC(hdc);    <span class="comment">// So GRE doesn't RIP.</span>
01700 <span class="preprocessor">#endif</span>
01701 <span class="preprocessor"></span>
01702     <span class="keywordflow">if</span> (!GreDeleteDC(hdc)) {
01703 
01704 <span class="preprocessor">#if DBG</span>
01705 <span class="preprocessor"></span>        GreMarkUndeletableDC(hdc);
01706         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~DCX_DONTRIPONDESTROY;
01707 <span class="preprocessor">#endif</span>
01708 <span class="preprocessor"></span>        <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;W32PF_Flags |= W32PF_OWNDCCLEANUP;
01709         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01710     }
01711 
01712     <span class="comment">/*</span>
01713 <span class="comment">     * Decrement this dc-entry from the free-list count.</span>
01714 <span class="comment">     */</span>
01715     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE) {
01716 
01717         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
01718             <a class="code" href="../../d8/d3/dc_8c.html#a1">DecrementFreeDCECount</a>();
01719         }
01720     }
01721 
01722 <span class="preprocessor">#if DBG</span>
01723 <span class="preprocessor"></span>    pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01724     pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01725 <span class="preprocessor">#endif</span>
01726 <span class="preprocessor"></span>
01727     <span class="comment">/*</span>
01728 <span class="comment">     * Unlink the DCE from the list.</span>
01729 <span class="comment">     */</span>
01730     *ppdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>;
01731 
01732     UserFreePool(pdce);
01733 
01734     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01735 }
01736 
01737 
01738 <span class="comment">/***************************************************************************\</span>
01739 <span class="comment">* InvalidateGDIWindows</span>
01740 <span class="comment">*</span>
01741 <span class="comment">* Recalculates the visrgn of all descendents of pwnd on behalf of GRE.</span>
01742 <span class="comment">*</span>
01743 <span class="comment">* History:</span>
01744 <span class="comment">\***************************************************************************/</span>
01745 
<a name="l01746"></a><a class="code" href="../../d8/d3/dc_8c.html#a21">01746</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/dc_8c.html#a21">InvalidateGDIWindows</a>(
01747     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01748 {
01749     PVOID pwo;
01750 
01751     <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01752 
01753         <span class="keywordflow">if</span> ((pwo = <a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a479">PROP_WNDOBJ</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01754 
01755             HRGN hrgnClient = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01756 
01757             <span class="keywordflow">if</span> (GreWindowInsteadOfClient(pwo)) {
01758 
01759                 <span class="comment">/*</span>
01760 <span class="comment">                 * Never clip children for WO_RGN_WINDOW so that NetMeeting</span>
01761 <span class="comment">                 * gets the unioned window area:</span>
01762 <span class="comment">                 */</span>
01763 
01764                 <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgnClient,
01765                            pwnd,
01766                            pwnd,
01767                            DCX_WINDOW |
01768                            (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>) ? DCX_CLIPSIBLINGS : 0));
01769             } <span class="keywordflow">else</span> {
01770                 <a class="code" href="../../d3/d6/visrgn_8c.html#a17">CalcVisRgn</a>(&amp;hrgnClient,
01771                            pwnd,
01772                            pwnd,
01773                            DCX_CLIPCHILDREN | DCX_CLIPSIBLINGS);
01774             }
01775 
01776             GreSetClientRgn(pwo, hrgnClient, &amp;(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>));
01777         }
01778 
01779         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01780         <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01781             <a class="code" href="../../d8/d3/dc_8c.html#a21">InvalidateGDIWindows</a>(pwnd);
01782             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01783         }
01784     }
01785 }
01786 
01787 <span class="comment">/***************************************************************************\</span>
01788 <span class="comment">* zzzInvalidateDCCache</span>
01789 <span class="comment">*</span>
01790 <span class="comment">* This function is called when the visrgn of a window is changing for</span>
01791 <span class="comment">* some reason.  It is responsible for ensuring that all of the cached</span>
01792 <span class="comment">* visrgns in the DC cache that are affected by the visrgn change are</span>
01793 <span class="comment">* invalidated.</span>
01794 <span class="comment">*</span>
01795 <span class="comment">* Operations that affect the visrgn of a window (i.e., things that better</span>
01796 <span class="comment">* call this routine one way or another:)</span>
01797 <span class="comment">*</span>
01798 <span class="comment">*   Hiding or showing self or parent</span>
01799 <span class="comment">*   Moving, sizing, or Z-order change of self or parent</span>
01800 <span class="comment">*   Minimizing or unminimizing self or parent</span>
01801 <span class="comment">*   Screen or paint locking of self or parent</span>
01802 <span class="comment">*   LockWindowUpdate of self or parent</span>
01803 <span class="comment">*</span>
01804 <span class="comment">* Invalidates any cache entries associated with pwnd and/or any children of</span>
01805 <span class="comment">* pwnd by either recalcing them on the fly if they're in use, or causing</span>
01806 <span class="comment">* them to be recalced later.</span>
01807 <span class="comment">*</span>
01808 <span class="comment">* History:</span>
01809 <span class="comment">* 17-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01810 <span class="comment">\***************************************************************************/</span>
01811 
<a name="l01812"></a><a class="code" href="../../d4/d1/userk_8h.html#a1004">01812</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1004">zzzInvalidateDCCache</a>(
01813     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndInvalid,
01814     DWORD flags)
01815 {
01816     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
01817     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a>        pdce;
01818     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01819     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndInvalid;
01820     FLONG       fl;
01821 
01822     <span class="comment">/*</span>
01823 <span class="comment">     * Invalidation implies screen real estate is changing so we must</span>
01824 <span class="comment">     * jiggle the mouse, because a different window may be underneath</span>
01825 <span class="comment">     * the mouse, which needs to get a mouse move in order to change the</span>
01826 <span class="comment">     * mouse pointer.</span>
01827 <span class="comment">     *</span>
01828 <span class="comment">     * The check for the tracking is added for full-drag-windows.  In doing</span>
01829 <span class="comment">     * full-drag, zzzBltValidBits() is called from setting the window-pos.</span>
01830 <span class="comment">     * This resulted in an extra-mousemove being queued from this routine.</span>
01831 <span class="comment">     * So, when we're tracking, don't queue a mousemove.  This pointer is</span>
01832 <span class="comment">     * null when tracking is off, so it won't effect the normal case.</span>
01833 <span class="comment">     */</span>
01834     <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndInvalid, &amp;tlpwndInvalid);
01835     
01836     <span class="keywordflow">if</span> (!(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>) &amp;&amp;
01837             !(flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a236">IDC_NOMOUSE</a>)) {
01838 
01839 <span class="preprocessor">#ifdef REDIRECTION</span>
01840 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a442">IsGlobalHooked</a>(ptiCurrent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a510">WHF_FROM_WH</a>(WH_HITTEST)))
01841 <span class="preprocessor">#endif // REDIRECTION</span>
01842 <span class="preprocessor"></span>        
01843             <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
01844     }
01845     
01846     <span class="comment">/*</span>
01847 <span class="comment">     * The visrgn of pwnd is changing.  First see if a change to this</span>
01848 <span class="comment">     * visrgn will also affect other window's visrgns:</span>
01849 <span class="comment">     *</span>
01850 <span class="comment">     * 1) if parent is clipchildren, we need to invalidate parent</span>
01851 <span class="comment">     * 2) if clipsiblings, we need to invalidate our sibling's visrgns.</span>
01852 <span class="comment">     *</span>
01853 <span class="comment">     * We don't optimize the case where we're NOT clipsiblings, and our</span>
01854 <span class="comment">     * parent is clipchildren: very rare case.</span>
01855 <span class="comment">     * We also don't optimize the fact that a clipsiblings window visrgn</span>
01856 <span class="comment">     * change only affects the visrgns of windows BELOW it.</span>
01857 <span class="comment">     */</span>
01858     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a232">IDC_DEFAULT</a>) {
01859 
01860         flags = 0;
01861 
01862         <span class="keywordflow">if</span> ((pwndInvalid-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01863             (pwndInvalid != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndInvalid))) {
01864 
01865             <span class="comment">/*</span>
01866 <span class="comment">             * If the parent is a clip-children window, then</span>
01867 <span class="comment">             * a change to our visrgn will affect his visrgn, and</span>
01868 <span class="comment">             * possibly those of our siblings.  So, invalidate starting</span>
01869 <span class="comment">             * from our parent.  Note that we don't need to invalidate</span>
01870 <span class="comment">             * any window DCs associated with our parent.</span>
01871 <span class="comment">             */</span>
01872             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInvalid-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) {
01873 
01874                 flags = <a class="code" href="../../d4/d1/userk_8h.html#a234">IDC_CLIENTONLY</a>;
01875                 pwndInvalid = pwndInvalid-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01876 
01877             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndInvalid, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>)) {
01878 
01879                 <span class="comment">/*</span>
01880 <span class="comment">                 * If we are clip-siblings, chances are that our siblings are</span>
01881 <span class="comment">                 * too.  A change to our visrgn might affect our siblings,</span>
01882 <span class="comment">                 * so invalidate all of our siblings.</span>
01883 <span class="comment">                 *</span>
01884 <span class="comment">                 * NOTE! This code assumes that if pwndInvalid is NOT</span>
01885 <span class="comment">                 * CLIPSIBLINGs, that either it does not overlap other</span>
01886 <span class="comment">                 * CLIPSIBLINGs windows, or that none of the siblings are</span>
01887 <span class="comment">                 * CLIPSIBLINGs.  This is a reasonable assumption, because</span>
01888 <span class="comment">                 * mixing CLIPSIBLINGs and non CLIPSIBLINGs windows that</span>
01889 <span class="comment">                 * overlap is generally unpredictable anyhow.</span>
01890 <span class="comment">                 */</span>
01891                 flags = <a class="code" href="../../d4/d1/userk_8h.html#a233">IDC_CHILDRENONLY</a>;
01892                 pwndInvalid = pwndInvalid-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01893             }
01894         }
01895     }
01896 
01897     <span class="comment">/*</span>
01898 <span class="comment">     * Go through the list of DCE's, looking for any that need to be</span>
01899 <span class="comment">     * invalidated or recalculated.  Basically, any DCE that contains</span>
01900 <span class="comment">     * a window handle that is equal to pwndInvalid or a child of pwndInvalid</span>
01901 <span class="comment">     * needs to be invalidated.</span>
01902 <span class="comment">     */</span>
01903     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01904 
01905         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INVALID | DCX_DESTROYTHIS))
01906             <span class="keywordflow">continue</span>;
01907 
01908         <span class="comment">/*</span>
01909 <span class="comment">         * HACK ALERT</span>
01910 <span class="comment">         *</span>
01911 <span class="comment">         * A minimized client DC must never exclude its children, even if</span>
01912 <span class="comment">         * its WS_CLIPCHILDREN bit is set.  For CS_OWNDC windows we must</span>
01913 <span class="comment">         * update the flags of the DCE to reflect the change in window state</span>
01914 <span class="comment">         * when the visrgn is eventually recomputed.</span>
01915 <span class="comment">         */</span>
01916         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_CACHE | DCX_WINDOW))) {
01917 
01918             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
01919                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> |= DCX_CLIPCHILDREN;
01920 
01921             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01922                 pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp;= ~DCX_CLIPCHILDREN;
01923         }
01924 
01925         <span class="comment">/*</span>
01926 <span class="comment">         * This code assumes that if pdce-&gt;pwndClip != pdce-&gt;pwndOrg,</span>
01927 <span class="comment">         * that pdce-&gt;pwndClip == pdce-&gt;pwndOrg-&gt;spwndParent.  To ensure</span>
01928 <span class="comment">         * that both windows are visited, we start the walk upwards from</span>
01929 <span class="comment">         * the lower of the two, or pwndOrg.</span>
01930 <span class="comment">         */</span>
01931         UserAssert((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a> == pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) ||
01932                    (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a> == pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>));
01933 
01934         <span class="comment">/*</span>
01935 <span class="comment">         * Walk upwards from pdce-&gt;pwndOrg, to see if we encounter</span>
01936 <span class="comment">         * pwndInvalid.</span>
01937 <span class="comment">         */</span>
01938         <span class="keywordflow">for</span> (pwnd = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>; pwnd; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
01939 
01940             <span class="keywordflow">if</span> (pwnd == pwndInvalid) {
01941 
01942                 <span class="keywordflow">if</span> (pwndInvalid == pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>) {
01943 
01944                     <span class="comment">/*</span>
01945 <span class="comment">                     * Ignore DCEs for pwndInvalid if IDC_CHILDRENONLY.</span>
01946 <span class="comment">                     */</span>
01947                     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a233">IDC_CHILDRENONLY</a>)
01948                         <span class="keywordflow">break</span>;
01949 
01950                     <span class="comment">/*</span>
01951 <span class="comment">                     * Ignore window DCEs for pwndInvalid if IDC_CLIENTONLY</span>
01952 <span class="comment">                     */</span>
01953                     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a234">IDC_CLIENTONLY</a>) &amp;&amp; (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_WINDOW))
01954                         <span class="keywordflow">break</span>;
01955                 }
01956 
01957                 <a class="code" href="../../d4/d1/userk_8h.html#a1701">InvalidateDce</a>(pdce);
01958                 <span class="keywordflow">break</span>;
01959             }
01960         }
01961     }
01962 
01963     <span class="comment">/*</span>
01964 <span class="comment">     * Update WNDOBJs in gdi if they exist.</span>
01965 <span class="comment">     */</span>
01966     GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01967 
01968     fl = (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a235">IDC_MOVEBLT</a>) ? GCR_DELAYFINALUPDATE : 0;
01969 
01970     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a95">gcountPWO</a> != 0) {
01971         <a class="code" href="../../d8/d3/dc_8c.html#a21">InvalidateGDIWindows</a>(pwndInvalid);
01972         fl |= GCR_WNDOBJEXISTS;
01973     }
01974 
01975     GreClientRgnUpdated(fl);
01976 
01977     GreUpdateSpriteVisRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01978 
01979     GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01980 
01981     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndInvalid);
01982 
01983     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01984 }
01985 
01986 <span class="comment">/***************************************************************************\</span>
01987 <span class="comment">* _WindowFromDC (API)</span>
01988 <span class="comment">*</span>
01989 <span class="comment">* Takes a dc, returns the window associated with it.</span>
01990 <span class="comment">*</span>
01991 <span class="comment">* History:</span>
01992 <span class="comment">* 23-Jun-1991 ScottLu   Created.</span>
01993 <span class="comment">\***************************************************************************/</span>
01994 
<a name="l01995"></a><a class="code" href="../../d4/d1/userk_8h.html#a1903">01995</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1903">_WindowFromDC</a>(
01996     HDC hdc)
01997 {
01998     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01999 
02000     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
02001 
02002         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE) || (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CREATEDC))
02003             <span class="keywordflow">continue</span>;
02004 
02005         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc)
02006             <span class="keywordflow">return</span> pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
02007     }
02008 
02009     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02010 }
02011 
02012 <span class="comment">/***************************************************************************\</span>
02013 <span class="comment">* FastWindowFromDC</span>
02014 <span class="comment">*</span>
02015 <span class="comment">* Returns the window associated with a DC, and puts it at the</span>
02016 <span class="comment">* front of the list.</span>
02017 <span class="comment">*</span>
02018 <span class="comment">* History:</span>
02019 <span class="comment">* 23-Jun-1991 ScottLu   Created.</span>
02020 <span class="comment">\***************************************************************************/</span>
02021 
<a name="l02022"></a><a class="code" href="../../d4/d1/userk_8h.html#a1704">02022</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d1/userk_8h.html#a1704">FastWindowFromDC</a>(
02023     HDC hdc)
02024 {
02025     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> *ppdce;
02026     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdceT;
02027 
02028     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc) &amp;&amp;
02029         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
02030 
02031         <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
02032     }
02033 
02034     <span class="keywordflow">for</span> (ppdce = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; *ppdce; ppdce = &amp;(*ppdce)-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
02035 
02036         <span class="keywordflow">if</span> (((*ppdce)-&gt;hdc == hdc) &amp;&amp; ((*ppdce)-&gt;DCX_flags &amp; DCX_INUSE)) {
02037 
02038             <span class="comment">/*</span>
02039 <span class="comment">             * Unlink/link to make it first.</span>
02040 <span class="comment">             */</span>
02041             pdceT                 = *ppdce;
02042             *ppdce                = pdceT-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>;
02043             pdceT-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>       = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>;
02044             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a> = pdceT;
02045 
02046             <span class="keywordflow">return</span> pdceT-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
02047         }
02048     }
02049 
02050     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02051 }
02052 
02053 <span class="comment">/***************************************************************************\</span>
02054 <span class="comment">* GetDCOrgOnScreen</span>
02055 <span class="comment">*</span>
02056 <span class="comment">* This function gets the DC origin of a window in screen coordinates. The</span>
02057 <span class="comment">* DC origin is always in the surface coordinates. For screen DCs the</span>
02058 <span class="comment">* surface is the screen, so their origin is already in the screen</span>
02059 <span class="comment">* coordinates. For redirected DCs, GreGetDCOrg will return the origin</span>
02060 <span class="comment">* of the DC in the redirected surface coordinates to which we will add</span>
02061 <span class="comment">* the origin of the redirected window that the surface is backing.</span>
02062 <span class="comment">*</span>
02063 <span class="comment">* 11/25/1998        vadimg      created</span>
02064 <span class="comment">\***************************************************************************/</span>
02065 
<a name="l02066"></a><a class="code" href="../../d4/d1/userk_8h.html#a1708">02066</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1708">GetDCOrgOnScreen</a>(HDC hdc, LPPOINT ppt)
02067 {
02068     <span class="keywordflow">if</span> (GreGetDCOrg(hdc, ppt)) {
02069         POINT ptScreen;
02070 
02071         <span class="comment">/*</span>
02072 <span class="comment">         * Get the origin of the redirected window in screen coordinates.</span>
02073 <span class="comment">         */</span>
02074         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/dc_8c.html#a26">UserGetRedirectedWindowOrigin</a>(hdc, &amp;ptScreen)) {
02075             ppt-&gt;x += ptScreen.x;
02076             ppt-&gt;y += ptScreen.y;
02077             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02078         }
02079     }
02080     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02081 }
02082 
02083 <span class="comment">/***************************************************************************\</span>
02084 <span class="comment">* UserGetRedirectedWindowOrigin</span>
02085 <span class="comment">*</span>
02086 <span class="comment">* The DC origin is in the surface coordinates. For screen DCs, the surface</span>
02087 <span class="comment">* is the screen and so their origin is in the screen coordinates. But for</span>
02088 <span class="comment">* redirected DCs, the backing surface origin is the same as the window</span>
02089 <span class="comment">* being redirected. This function retrieves the screen origin of a redirected</span>
02090 <span class="comment">* window corresponding to a redirection DC. It returns FALSE if this isn't</span>
02091 <span class="comment">* a valid DC or it's not a redirected DC.</span>
02092 <span class="comment">*</span>
02093 <span class="comment">* 11/18/1998        vadimg      created</span>
02094 <span class="comment">\***************************************************************************/</span>
02095 
<a name="l02096"></a><a class="code" href="../../d8/d3/dc_8c.html#a26">02096</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/dc_8c.html#a26">UserGetRedirectedWindowOrigin</a>(HDC hdc, LPPOINT ppt)
02097 {
02098     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
02099     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
02100 
02101     <span class="keywordflow">if</span> ((pdce = <a class="code" href="../../d4/d1/userk_8h.html#a1706">LookupDC</a>(hdc)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02102         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02103 
02104     <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED))
02105         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02106 
02107     pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a1990">GetLayeredWindow</a>(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>);
02108 
02109     ppt-&gt;x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
02110     ppt-&gt;y = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
02111 
02112     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02113 }
02114 
02115 <span class="comment">/***************************************************************************\</span>
02116 <span class="comment">* LookupDC</span>
02117 <span class="comment">*</span>
02118 <span class="comment">* Validate a DC by returning a correspnding pdce.</span>
02119 <span class="comment">*</span>
02120 <span class="comment">* 11/12/1997   vadimg          created</span>
02121 <span class="comment">\***************************************************************************/</span>
02122 
<a name="l02123"></a><a class="code" href="../../d4/d1/userk_8h.html#a1706">02123</a> <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> <a class="code" href="../../d4/d1/userk_8h.html#a1706">LookupDC</a>(HDC hdc)
02124 {
02125     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
02126 
02127     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
02128 
02129         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INVALID | DCX_DESTROYTHIS))
02130             <span class="keywordflow">continue</span>;
02131         
02132         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc &amp;&amp; pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
02133                 (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
02134             <span class="keywordflow">return</span> pdce;
02135         }
02136     }
02137     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02138 }
02139 
02140 <span class="comment">/***************************************************************************\</span>
02141 <span class="comment">* GetMonitorDC</span>
02142 <span class="comment">*</span>
02143 <span class="comment">* 11/06/97      vadimg      ported from Memphis</span>
02144 <span class="comment">\***************************************************************************/</span>
02145 
<a name="l02146"></a><a class="code" href="../../d8/d3/dc_8c.html#a0">02146</a> <span class="preprocessor">#define DCX_LEAVEBITS (DCX_WINDOW | DCX_CLIPCHILDREN | DCX_CLIPSIBLINGS | \</span>
02147 <span class="preprocessor">        DCX_PARENTCLIP | DCX_LOCKWINDOWUPDATE | DCX_NOCLIPCHILDREN | \</span>
02148 <span class="preprocessor">        DCX_USESTYLE | DCX_EXCLUDEUPDATE | DCX_INTERSECTUPDATE | \</span>
02149 <span class="preprocessor">        DCX_EXCLUDERGN | DCX_INTERSECTRGN)</span>
02150 <span class="preprocessor"></span>
<a name="l02151"></a><a class="code" href="../../d4/d1/userk_8h.html#a1707">02151</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1707">GetMonitorDC</a>(<a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdceOrig, <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor)
02152 {
02153     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
02154     POINT pt;
02155     RECT rc;
02156 
02157 TryAgain:
02158     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
02159         <span class="comment">/*</span>
02160 <span class="comment">         * Find an available DC for this monitor.</span>
02161 <span class="comment">         */</span>
02162         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INUSE | DCX_DESTROYTHIS))
02163             <span class="keywordflow">continue</span>;
02164 
02165         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o9">pMonitor</a> != pMonitor)
02166             <span class="keywordflow">continue</span>;
02167 
02168         <span class="keywordflow">if</span> (!(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INVALID))
02169             <a class="code" href="../../d4/d1/userk_8h.html#a1771">SpbCheckDce</a>(pdce);
02170 
02171         <span class="comment">/*</span>
02172 <span class="comment">         * Copy DC properties and style bits.</span>
02173 <span class="comment">         */</span>
02174         GreSetDCOwner(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, OBJECT_OWNER_CURRENT);
02175         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> = pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a>;
02176         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a> = pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o3">pwndClip</a>;
02177         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a> = pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o8">ptiOwner</a>;
02178         pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> = (DCX_INUSE | DCX_CACHE) | 
02179                 (pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; <a class="code" href="../../d8/d3/dc_8c.html#a0">DCX_LEAVEBITS</a>);
02180 
02181         <span class="keywordflow">if</span> (pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
02182             UserAssert(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02183             UserAssert(pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INTERSECTRGN | DCX_EXCLUDERGN));
02184 
02185             pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
02186             <a class="code" href="../../d8/d3/dc_8c.html#a3">SetMonitorRegion</a>(pMonitor, pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>, pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>);
02187         } <span class="keywordflow">else</span> {
02188             pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a> = pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o4">hrgnClip</a>;
02189         }
02190 
02191         <span class="comment">/*</span>
02192 <span class="comment">         * Setup the visrgn clipped to this monitor.</span>
02193 <span class="comment">         */</span>
02194         GreCopyVisRgn(pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
02195         <a class="code" href="../../d8/d3/dc_8c.html#a3">SetMonitorRegion</a>(pMonitor, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>);
02196         GreSelectVisRgn(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a194">ghrgnGDC</a>, SVR_COPYNEW);
02197 
02198         GreGetDCOrgEx(pdceOrig-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, &amp;pt, &amp;rc);
02199         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.left, -pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top);
02200         GreSetDCOrg(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, rc.left, rc.top, (PRECTL)&amp;rc);
02201 
02202         <span class="comment">/*</span>
02203 <span class="comment">         * Decrement the Free DCE Count.  This should always be &gt;= 0,</span>
02204 <span class="comment">         * since we'll create a new dce if the cache is all in use.</span>
02205 <span class="comment">         */</span>
02206         <a class="code" href="../../d8/d3/dc_8c.html#a1">DecrementFreeDCECount</a>();
02207 
02208         <span class="keywordflow">return</span> pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>;
02209     }
02210 
02211     <span class="comment">/*</span>
02212 <span class="comment">     * If this call succeeds a new DC will be available in the cache,</span>
02213 <span class="comment">     * so the loop will find it and properly set it up.</span>
02214 <span class="comment">     */</span>
02215     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1699">CreateCacheDC</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_INVALID | DCX_CACHE, pMonitor) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02216         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02217 
02218     <span class="keywordflow">goto</span> TryAgain;
02219 }
02220 
02221 <span class="comment">/***************************************************************************\</span>
02222 <span class="comment">* RipIfCacheDC</span>
02223 <span class="comment">*</span>
02224 <span class="comment">* This is called on debug systems by gdi when it is destroying a dc</span>
02225 <span class="comment">* to make sure it isn't in the cache.</span>
02226 <span class="comment">*</span>
02227 <span class="comment">* History:</span>
02228 <span class="comment">\***************************************************************************/</span>
02229 
02230 <span class="preprocessor">#if DBG</span>
02231 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> RipIfCacheDC(
02232     HDC hdc)
02233 {
02234     <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
02235 
02236     <span class="comment">/*</span>
02237 <span class="comment">     * This is called on debug systems by gdi when it is destroying a dc</span>
02238 <span class="comment">     * to make sure it isn't in the cache.</span>
02239 <span class="comment">     */</span>
02240     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
02241 
02242     <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
02243 
02244         <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a> == hdc &amp;&amp; !(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_DONTRIPONDESTROY)) {
02245 
02246             RIPMSG1(RIP_ERROR,
02247                   <span class="stringliteral">"Deleting DC in DC cache - contact JohnC. hdc == %08lx\n"</span>,
02248                   pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>);
02249         }
02250     }
02251 
02252     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
02253 }
02254 <span class="preprocessor">#endif</span>
02255 <span class="preprocessor"></span>
02256 <span class="preprocessor">#ifdef USE_MIRRORING</span>
02257 <span class="preprocessor"></span><span class="comment">/***************************************************************************\</span>
02258 <span class="comment">* MirrorRect</span>
02259 <span class="comment">*</span>
02260 <span class="comment">* Mirror the client window coordinates.</span>
02261 <span class="comment">* </span>
02262 <span class="comment">*</span>
02263 <span class="comment">* History:</span>
02264 <span class="comment">\***************************************************************************/</span>
02265 <span class="keywordtype">void</span> MirrorRect(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LPRECT lprc)
02266 {
02267     <span class="keywordtype">int</span> left, cx;
02268 
02269     cx          = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
02270     left        = lprc-&gt;left;
02271     lprc-&gt;left  = cx - lprc-&gt;right;
02272     lprc-&gt;right = cx - left;
02273 }
02274 
02275 <span class="comment">/***************************************************************************\</span>
02276 <span class="comment">* OrderRects</span>
02277 <span class="comment">*</span>
02278 <span class="comment">* Order the rectangles, so that they flow from left to right. This is needed</span>
02279 <span class="comment">* when combining a mirrored region (see MirrorRegion)</span>
02280 <span class="comment">* </span>
02281 <span class="comment">*</span>
02282 <span class="comment">* History:</span>
02283 <span class="comment">\***************************************************************************/</span>
02284 <span class="keywordtype">void</span> OrderRects(LPRECT lpR, <span class="keywordtype">int</span> nRects)
02285 {
02286     RECT R;
02287     <span class="keywordtype">int</span> i,j;
02288 
02289     <span class="comment">//</span>
02290     <span class="comment">// Sort Left to right</span>
02291     <span class="comment">//</span>
02292     <span class="keywordflow">for</span> (i=0; i&lt;nRects; i++){
02293         <span class="keywordflow">for</span> (j=i+1; (j&lt;nRects) &amp;&amp; ((lpR+j)-&gt;top == (lpR+i)-&gt;top); j++){
02294             <span class="keywordflow">if</span> (((lpR+j)-&gt;left &lt; (lpR+i)-&gt;left)) {
02295                 R = *(lpR+i);
02296                 *(lpR+i) = *(lpR+j); 
02297                 *(lpR+j) = R;
02298             }
02299         }
02300     }
02301 
02302 }
02303 
02304 <span class="comment">/***************************************************************************\</span>
02305 <span class="comment">* MirrorRegion</span>
02306 <span class="comment">*</span>
02307 <span class="comment">* Mirror a region in a window. This is done by mirroring the rects</span>
02308 <span class="comment">* that constitute the region. 'bUseClient' param controls whether </span>
02309 <span class="comment">* the region is a client one or not.</span>
02310 <span class="comment">*</span>
02311 <span class="comment">* History:</span>
02312 <span class="comment">\***************************************************************************/</span>
02313 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> MirrorRegion(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HRGN hrgn, BOOL bUseClient)
02314 {
02315     <span class="keywordtype">int</span>        nRects, i, nDataSize, Saveleft, cx;
02316     HRGN       hrgn2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02317     RECT       *lpR;
02318     RGNDATA    *lpRgnData;
02319     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>       bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02320 
02321     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL) &amp;&amp; hrgn &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a879">HRGN_SPECIAL_LAST</a>) {
02322         nDataSize = GreGetRegionData(hrgn, 0, NULL);
02323         <span class="keywordflow">if</span> (nDataSize &amp;&amp; (lpRgnData = (RGNDATA *)UserAllocPool(nDataSize, TAG_MIRROR))) {
02324             <span class="keywordflow">if</span> (GreGetRegionData(hrgn, nDataSize, lpRgnData)) {
02325                 nRects       = lpRgnData-&gt;rdh.nCount; 
02326                 lpR          = (RECT *)lpRgnData-&gt;Buffer;
02327     
02328                 <span class="keywordflow">if</span> (bUseClient) {
02329                     cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
02330                 } <span class="keywordflow">else</span> {
02331                     cx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
02332                 }
02333     
02334                 Saveleft                     = lpRgnData-&gt;rdh.rcBound.left;
02335                 lpRgnData-&gt;rdh.rcBound.left  = cx - lpRgnData-&gt;rdh.rcBound.right;
02336                 lpRgnData-&gt;rdh.rcBound.right = cx - Saveleft;
02337     
02338         
02339                 <span class="keywordflow">for</span> (i=0; i&lt;nRects; i++){
02340                     Saveleft   = lpR-&gt;left;
02341                     lpR-&gt;left  = cx - lpR-&gt;right;
02342                     lpR-&gt;right = cx - Saveleft;
02343         
02344                     lpR++;
02345                 }
02346         
02347                 OrderRects((RECT *)lpRgnData-&gt;Buffer, nRects);
02348                 hrgn2 = GreExtCreateRegion(NULL, nDataSize, lpRgnData);
02349                 <span class="keywordflow">if</span> (hrgn2) {
02350                     GreCombineRgn(hrgn, hrgn2, NULL, RGN_COPY);
02351                     GreDeleteObject((HGDIOBJ)hrgn2);
02352                     bRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02353                 }
02354             }
02355     
02356             <span class="comment">//Free mem.</span>
02357             UserFreePool(lpRgnData);
02358         }
02359     }
02360 
02361     <span class="keywordflow">return</span> bRet;
02362 }
02363 
02364 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:39 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
