<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mips/initkr.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>initkr.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d0/d2/mips_2initkr_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/mips_2initkr_8c.html#a0">KiInitializeKernel</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN PVOID IdleStack, IN PKPRCB Prcb, IN CCHAR Number, IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="mips/initkr.c::KiInitializeKernel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeKernel           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>IdleStack</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKPRCB&nbsp;</td>
          <td class="mdname" nowrap> <em>Prcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Number</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LoaderBlock</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d2/mips_2initkr_8c-source.html#l00041">41</a> of file <a class="el" href="../../d0/d2/mips_2initkr_8c-source.html">mips/initkr.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l00869">_BOOT_STATUS::BootFinished</a>, <a class="el" href="../../d2/d8/arc_8h-source.html#l01359">_RESTART_BLOCK::BootStatus</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a196">HalInitializeProcessor()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00088">IPI_LEVEL</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00072">KdInitSystem()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d2/d1/mips_2buserror_8c-source.html#l00029">KeBusError()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00063">KeInitializeProcess()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02773">KeLoaderBlock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02777">KeProcessorArchitecture</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02778">KeProcessorLevel</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02779">KeProcessorRevision</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00127">KiAdjustDpcThreshold</a>, <a class="el" href="../../d0/d0/ki_8h.html#a97">KiApcInterrupt()</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00237">KiComputeReciprocal()</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l01113">KiContextSwapLock</a>, <a class="el" href="../../d0/d0/ki_8h.html#a111">KiDispatchInterrupt()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00301">KiDmaIoCoherency</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00044">KiIdleSummary</a>, <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00096">KiInitSystem()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00125">KiMaximumDpcQueueDepth</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00126">KiMinimumDpcRate</a>, <a class="el" href="../../d0/d0/ki_8h.html#a129">KiPassiveRelease()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00505">KiTimeIncrementReciprocal</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00512">KiTimeIncrementShiftCount</a>, <a class="el" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt()</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l01420">MAXIMUM_PROCESSORS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d2/ppcdef_8h-source.html#l00079">PASSIVE_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00601">PDI_SHIFT</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00367">PKSTART_ROUTINE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00379">PKSYSTEM_ROUTINE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00177">PRCB_MAJOR_VERSION</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00176">PRCB_MINOR_VERSION</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a193">Running</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00065">SetMember</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00052                    :
00053 
00054     This function gains <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been bootstrapped and
00055     before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has been initialized. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to initialize
00056     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel data structures, initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> idle thread and process objects,
00057     initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block, call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive initialization
00058     routine, and then <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system startup routine. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00059     also called to initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor specific structures when a <span class="keyword">new</span>
00060     processor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> brought on line.
00061 
00062 Arguments:
00063 
00064     Process - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process <span class="keywordflow">for</span>
00065         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00066 
00067     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread <span class="keywordflow">for</span>
00068         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00069 
00070     IdleStack - Supplies a pointer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real kernel stack <span class="keywordflow">for</span>
00071         idle thread on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor.
00072 
00073     Prcb - Supplies a pointer to a processor <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00074         processor.
00075 
00076     Number - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
00077         initialized.
00078 
00079     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loader parameter block.
00080 
00081 Return Value:
00082 
00083     None.
00084 
00085 --*/
00086 
00087 {
00088 
00089     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00090     KIRQL OldIrql;
00091     <a class="code" href="../../d5/d4/struct__RESTART__BLOCK.html">PRESTART_BLOCK</a> RestartBlock;
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Perform platform dependent processor initialization.</span>
00095     <span class="comment">//</span>
00096 
00097     <a class="code" href="../../d2/d7/hal_8h.html#a196">HalInitializeProcessor</a>(Number);
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// Save the address of the loader parameter block.</span>
00101     <span class="comment">//</span>
00102 
00103     <a class="code" href="../../d4/d9/ke_8h.html#a130">KeLoaderBlock</a> = LoaderBlock;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">// Initialize the processor block.</span>
00107     <span class="comment">//</span>
00108 
00109     Prcb-&gt;MinorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a101">PRCB_MINOR_VERSION</a>;
00110     Prcb-&gt;MajorVersion = <a class="code" href="../../d6/d7/halmips_8h.html#a102">PRCB_MAJOR_VERSION</a>;
00111     Prcb-&gt;BuildType = 0;
00112 
00113 <span class="preprocessor">#if DBG</span>
00114 <span class="preprocessor"></span>
00115     Prcb-&gt;BuildType |= PRCB_BUILD_DEBUG;
00116 
00117 <span class="preprocessor">#endif</span>
00118 <span class="preprocessor"></span>
00119 <span class="preprocessor">#if defined(NT_UP)</span>
00120 <span class="preprocessor"></span>
00121     Prcb-&gt;BuildType |= PRCB_BUILD_UNIPROCESSOR;
00122 
00123 <span class="preprocessor">#endif</span>
00124 <span class="preprocessor"></span>
00125     Prcb-&gt;CurrentThread = Thread;
00126     Prcb-&gt;NextThread = (<a class="code" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00127     Prcb-&gt;IdleThread = Thread;
00128     Prcb-&gt;Number = Number;
00129     Prcb-&gt;SetMember = 1 &lt;&lt; Number;
00130     Prcb-&gt;PcrPage = LoaderBlock-&gt;u.Mips.PcrPage;
00131 
00132 <span class="preprocessor">#if !defined(NT_UP)</span>
00133 <span class="preprocessor"></span>
00134     Prcb-&gt;TargetSet = 0;
00135     Prcb-&gt;WorkerRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00136     Prcb-&gt;RequestSummary = 0;
00137     Prcb-&gt;IpiFrozen = 0;
00138 
00139 <span class="preprocessor">#if NT_INST</span>
00140 <span class="preprocessor"></span>
00141     Prcb-&gt;IpiCounts = &amp;KiIpiCounts[Number];
00142 
00143 <span class="preprocessor">#endif</span>
00144 <span class="preprocessor"></span>
00145 <span class="preprocessor">#endif</span>
00146 <span class="preprocessor"></span>
00147     Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00148     Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00149     Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Initialize DPC listhead and lock.</span>
00153     <span class="comment">//</span>
00154 
00155     InitializeListHead(&amp;Prcb-&gt;DpcListHead);
00156     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;Prcb-&gt;DpcLock);
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Set address of processor block.</span>
00160     <span class="comment">//</span>
00161 
00162     <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[Number] = Prcb;
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Set global processor architecture, level and revision.  The</span>
00166     <span class="comment">// latter two are the least common denominator on an MP system.</span>
00167     <span class="comment">//</span>
00168 
00169     <a class="code" href="../../d4/d9/ke_8h.html#a134">KeProcessorArchitecture</a> = PROCESSOR_ARCHITECTURE_MIPS;
00170     <a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> = 0;
00171     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> == 0 ||
00172         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(PCR-&gt;ProcessorId &gt;&gt; 8)) {
00173         <a class="code" href="../../d4/d9/ke_8h.html#a135">KeProcessorLevel</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(PCR-&gt;ProcessorId &gt;&gt; 8);
00174     }
00175 
00176     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> == 0 ||
00177         <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(PCR-&gt;ProcessorId &amp; 0xff)) {
00178         <a class="code" href="../../d4/d9/ke_8h.html#a136">KeProcessorRevision</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(PCR-&gt;ProcessorId &amp; 0xff);
00179     }
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Initialize the address of the bus error routines.</span>
00183     <span class="comment">//</span>
00184 
00185     PCR-&gt;DataBusError = <a class="code" href="../../d1/d2/mips_2buserror_8c.html#a0">KeBusError</a>;
00186     PCR-&gt;InstructionBusError = <a class="code" href="../../d1/d2/mips_2buserror_8c.html#a0">KeBusError</a>;
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// Initialize the idle thread initial kernel stack and limit address value.</span>
00190     <span class="comment">//</span>
00191 
00192     PCR-&gt;InitialStack = IdleStack;
00193     PCR-&gt;StackLimit = (PVOID)((ULONG)IdleStack - KERNEL_STACK_SIZE);
00194 
00195     <span class="comment">//</span>
00196     <span class="comment">// Initialize all interrupt vectors to transfer control to the unexpected</span>
00197     <span class="comment">// interrupt routine.</span>
00198     <span class="comment">//</span>
00199     <span class="comment">// N.B. This interrupt object is never actually "connected" to an interrupt</span>
00200     <span class="comment">//      vector via KeConnectInterrupt. It is initialized and then connected</span>
00201     <span class="comment">//      by simply storing the address of the dispatch code in the interrupt</span>
00202     <span class="comment">//      vector.</span>
00203     <span class="comment">//</span>
00204 
00205     <span class="keywordflow">if</span> (Number == 0) {
00206 
00207         <span class="comment">//</span>
00208         <span class="comment">// Initial the address of the interrupt dispatch routine.</span>
00209         <span class="comment">//</span>
00210 
00211         KxUnexpectedInterrupt.DispatchAddress = <a class="code" href="../../d0/d0/ki_8h.html#a142">KiUnexpectedInterrupt</a>;
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">// Copy the interrupt dispatch code template into the interrupt object</span>
00215         <span class="comment">// and flush the dcache on all processors that the current thread can</span>
00216         <span class="comment">// run on to ensure that the code is actually in memory.</span>
00217         <span class="comment">//</span>
00218 
00219         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; DISPATCH_LENGTH; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00220             KxUnexpectedInterrupt.DispatchCode[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = KiInterruptTemplate[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00221         }
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">// Set the default DMA I/O coherency attributes.</span>
00225         <span class="comment">//</span>
00226 
00227         <a class="code" href="../../d5/d9/kernldat_8c.html#a34">KiDmaIoCoherency</a> = 0;
00228 
00229         <span class="comment">//</span>
00230         <span class="comment">// Initialize the context swap spinlock.</span>
00231         <span class="comment">//</span>
00232 
00233         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;KiContextSwapLock);
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">// Sweep the data cache to make sure the dispatch code is flushed</span>
00237         <span class="comment">// to memory on the current processor.</span>
00238         <span class="comment">//</span>
00239 
00240         HalSweepDcache();
00241     }
00242 
00243     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; MAXIMUM_VECTOR; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00244         PCR-&gt;InterruptRoutine[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] =
00245                     (PKINTERRUPT_ROUTINE)(&amp;KxUnexpectedInterrupt.DispatchCode);
00246     }
00247 
00248     <span class="comment">//</span>
00249     <span class="comment">// Initialize the profile count and interval.</span>
00250     <span class="comment">//</span>
00251 
00252     PCR-&gt;ProfileCount = 0;
00253     PCR-&gt;ProfileInterval = 0x200000;
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Initialize the passive release, APC, and DPC interrupt vectors.</span>
00257     <span class="comment">//</span>
00258 
00259     PCR-&gt;InterruptRoutine[0] = <a class="code" href="../../d0/d0/ki_8h.html#a129">KiPassiveRelease</a>;
00260     PCR-&gt;InterruptRoutine[<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>] = <a class="code" href="../../d0/d0/ki_8h.html#a97">KiApcInterrupt</a>;
00261     PCR-&gt;InterruptRoutine[<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>] = <a class="code" href="../../d0/d0/ki_8h.html#a111">KiDispatchInterrupt</a>;
00262     PCR-&gt;ReservedVectors = (1 &lt;&lt; <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>) | (1 &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) |
00263                                         (1 &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) | (1 &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a54">IPI_LEVEL</a>);
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// Initialize the set member for the current processor, set IRQL to</span>
00267     <span class="comment">// APC_LEVEL, and set the processor number.</span>
00268     <span class="comment">//</span>
00269 
00270     PCR-&gt;CurrentIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>;
00271     PCR-&gt;SetMember = 1 &lt;&lt; Number;
00272     PCR-&gt;NotMember = ~PCR-&gt;SetMember;
00273     PCR-&gt;Number = Number;
00274 
00275     <span class="comment">//</span>
00276     <span class="comment">// Set the initial stall execution scale factor. This value will be</span>
00277     <span class="comment">// recomputed later by the HAL.</span>
00278     <span class="comment">//</span>
00279 
00280     PCR-&gt;StallScaleFactor = 50;
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Set address of process object in thread object.</span>
00284     <span class="comment">//</span>
00285 
00286     Thread-&gt;ApcState.Process = Process;
00287 
00288     <span class="comment">//</span>
00289     <span class="comment">// Set the appropriate member in the active processors set.</span>
00290     <span class="comment">//</span>
00291 
00292     <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, KeActiveProcessors);
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Set the number of processors based on the maximum of the current</span>
00296     <span class="comment">// number of processors and the current processor number.</span>
00297     <span class="comment">//</span>
00298 
00299     <span class="keywordflow">if</span> ((Number + 1) &gt; <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a>) {
00300         <a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> = Number + 1;
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">// If the initial processor is being initialized, then initialize the</span>
00305     <span class="comment">// per system data structures.</span>
00306     <span class="comment">//</span>
00307 
00308     <span class="keywordflow">if</span> (Number == 0) {
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// Initialize the address of the restart block for the boot master.</span>
00312         <span class="comment">//</span>
00313 
00314         Prcb-&gt;RestartBlock = SYSTEM_BLOCK-&gt;RestartBlock;
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Initialize the kernel debugger.</span>
00318         <span class="comment">//</span>
00319 
00320         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a>(LoaderBlock, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00321             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(PHASE0_INITIALIZATION_FAILED);
00322         }
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">// Initialize processor block array.</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00329             <a class="code" href="../../d4/d9/ke_8h.html#a139">KiProcessorBlock</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = (PKPRCB)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00330         }
00331 
00332         <span class="comment">//</span>
00333         <span class="comment">// Perform architecture independent initialization.</span>
00334         <span class="comment">//</span>
00335 
00336         <a class="code" href="../../d2/d0/kiinit_8c.html#a1">KiInitSystem</a>();
00337 
00338         <span class="comment">//</span>
00339         <span class="comment">// Initialize idle thread process object and then set:</span>
00340         <span class="comment">//</span>
00341         <span class="comment">//      1. all the quantum values to the maximum possible.</span>
00342         <span class="comment">//      2. the process in the balance set.</span>
00343         <span class="comment">//      3. the active processor mask to the specified processor.</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d3/d5/procobj_8c.html#a3">KeInitializeProcess</a>(Process,
00347                             (KPRIORITY)0,
00348                             (KAFFINITY)(0xffffffff),
00349                             (PULONG)(PDE_BASE + ((PDE_BASE &gt;&gt; PDI_SHIFT - 2) &amp; 0xffc)),
00350                             FALSE);
00351 
00352         Process-&gt;ThreadQuantum = MAXCHAR;
00353 
00354     }
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Initialize idle thread object and then set:</span>
00358     <span class="comment">//</span>
00359     <span class="comment">//      1. the initial kernel stack to the specified idle stack.</span>
00360     <span class="comment">//      2. the next processor number to the specified processor.</span>
00361     <span class="comment">//      3. the thread priority to the highest possible value.</span>
00362     <span class="comment">//      4. the state of the thread to running.</span>
00363     <span class="comment">//      5. the thread affinity to the specified processor.</span>
00364     <span class="comment">//      6. the specified processor member in the process active processors</span>
00365     <span class="comment">//          set.</span>
00366     <span class="comment">//</span>
00367 
00368     <a class="code" href="../../d9/d1/thredobj_8c.html#a1">KeInitializeThread</a>(Thread, (PVOID)((ULONG)IdleStack - PAGE_SIZE),
00369                        (PKSYSTEM_ROUTINE)NULL, (PKSTART_ROUTINE)NULL,
00370                        (PVOID)NULL, (PCONTEXT)NULL, (PVOID)NULL, Process);
00371 
00372     Thread-&gt;InitialStack = IdleStack;
00373     Thread-&gt;StackBase = IdleStack;
00374     Thread-&gt;StackLimit = (PVOID)((ULONG)IdleStack - KERNEL_STACK_SIZE);
00375     Thread-&gt;NextProcessor = Number;
00376     Thread-&gt;Priority = HIGH_PRIORITY;
00377     Thread-&gt;State = <a class="code" href="../../d4/d9/ke_8h.html#a406a193">Running</a>;
00378     Thread-&gt;Affinity = (KAFFINITY)(1 &lt;&lt; Number);
00379     Thread-&gt;WaitIrql = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// If the current processor is 0, then set the appropriate bit in the</span>
00383     <span class="comment">// active summary of the idle process.</span>
00384     <span class="comment">//</span>
00385 
00386     <span class="keywordflow">if</span> (Number == 0) {
00387         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, Process-&gt;ActiveProcessors);
00388     }
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Execute the executive initialization.</span>
00392     <span class="comment">//</span>
00393 
00394     <span class="keywordflow">try</span> {
00395         <a class="code" href="../../d0/d0/ki_8h.html#a86">ExpInitializeExecutive</a>(Number, LoaderBlock);
00396 
00397     } except (EXCEPTION_EXECUTE_HANDLER) {
00398         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a> (PHASE0_EXCEPTION);
00399     }
00400 
00401     <span class="comment">//</span>
00402     <span class="comment">// If the initial processor is being initialized, then compute the</span>
00403     <span class="comment">// timer table reciprocal value and reset the PRCB values for the</span>
00404     <span class="comment">// controllable DPC behavior in order to reflect any registry</span>
00405     <span class="comment">// overrides.</span>
00406     <span class="comment">//</span>
00407 
00408     <span class="keywordflow">if</span> (Number == 0) {
00409         <a class="code" href="../../d5/d9/kernldat_8c.html#a59">KiTimeIncrementReciprocal</a> = <a class="code" href="../../d2/d0/kiinit_8c.html#a2">KiComputeReciprocal</a>((LONG)KeMaximumIncrement,
00410                                                         &amp;KiTimeIncrementShiftCount);
00411 
00412         Prcb-&gt;MaximumDpcQueueDepth = <a class="code" href="../../d8/d0/cmdat3_8c.html#a64">KiMaximumDpcQueueDepth</a>;
00413         Prcb-&gt;MinimumDpcRate = <a class="code" href="../../d8/d0/cmdat3_8c.html#a65">KiMinimumDpcRate</a>;
00414         Prcb-&gt;AdjustDpcThreshold = <a class="code" href="../../d8/d0/cmdat3_8c.html#a66">KiAdjustDpcThreshold</a>;
00415     }
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">// Raise IRQL to dispatch level and set the priority of the idle thread</span>
00419     <span class="comment">// to zero. This will have the effect of immediately causing the phase</span>
00420     <span class="comment">// one initialization thread to get scheduled for execution. The idle</span>
00421     <span class="comment">// thread priority is then set to the lowest realtime priority. This is</span>
00422     <span class="comment">// necessary so that mutexes aquired at DPC level do not cause the active</span>
00423     <span class="comment">// matrix to get corrupted.</span>
00424     <span class="comment">//</span>
00425 
00426     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(DISPATCH_LEVEL, &amp;OldIrql);
00427     <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(Thread, (KPRIORITY)0);
00428     Thread-&gt;Priority = LOW_REALTIME_PRIORITY;
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// Raise IRQL to the highest level.</span>
00432     <span class="comment">//</span>
00433 
00434     <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(HIGH_LEVEL, &amp;OldIrql);
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">// If a restart block exists for the current process, then set boot</span>
00438     <span class="comment">// completed.</span>
00439     <span class="comment">//</span>
00440     <span class="comment">// N.B. Firmware on uniprocessor machines configured for MP operation</span>
00441     <span class="comment">//      can have a restart block address of NULL.</span>
00442     <span class="comment">//</span>
00443 
00444 <span class="preprocessor">#if !defined(NT_UP)</span>
00445 <span class="preprocessor"></span>
00446     RestartBlock = Prcb-&gt;RestartBlock;
00447     <span class="keywordflow">if</span> (RestartBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00448         RestartBlock-&gt;<a class="code" href="../../d5/d4/struct__RESTART__BLOCK.html#o8">BootStatus</a>.<a class="code" href="../../d8/d4/struct__BOOT__STATUS.html#o1">BootFinished</a> = 1;
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// If the current processor is not 0, then set the appropriate bit in</span>
00453     <span class="comment">// idle summary.</span>
00454     <span class="comment">//</span>
00455 
00456     <span class="keywordflow">if</span> (Number != 0) {
00457         <a class="code" href="../../d0/d0/ki_8h.html#a7">SetMember</a>(Number, KiIdleSummary);
00458     }
00459 
00460 <span class="preprocessor">#endif</span>
00461 <span class="preprocessor"></span>
00462     <span class="keywordflow">return</span>;
00463 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
