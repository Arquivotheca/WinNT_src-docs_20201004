<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: movesize.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>movesize.c</h1><a href="../../d8/d3/movesize_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************************************************************\</span>
00002 <span class="comment">* Module Name: movesize.c  (formerly wmmove.c)</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains Window Moving and Sizing Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3</span>
00010 <span class="comment">* 13-Feb-1991 IanJa     HWND revalidation added</span>
00011 <span class="comment">\****************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 
<a name="l00017"></a><a class="code" href="../../d8/d3/movesize_8c.html#a0">00017</a> <span class="preprocessor">#define DRAG_START    0</span>
<a name="l00018"></a><a class="code" href="../../d8/d3/movesize_8c.html#a1">00018</a> <span class="preprocessor"></span><span class="preprocessor">#define DRAG_MOVE     1</span>
<a name="l00019"></a><a class="code" href="../../d8/d3/movesize_8c.html#a2">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define DRAG_END      2</span>
00020 <span class="preprocessor"></span>
00021 <span class="comment">/****************************************************************************\</span>
00022 <span class="comment">* These values are indexes that represent rect sides. These indexes are</span>
00023 <span class="comment">* used as indexes into rgimpiwx and rgimpiwy (which are indexes into the</span>
00024 <span class="comment">* the rect structure) which tell the move code where to store the new x &amp; y</span>
00025 <span class="comment">* coordinates. Notice that when two of these values that represent sides</span>
00026 <span class="comment">* are added together, we get a unique list of contiguous values starting at</span>
00027 <span class="comment">* 1 that represent all the ways we can size a rect. That also leaves 0 free</span>
00028 <span class="comment">* a initialization value.</span>
00029 <span class="comment">*</span>
00030 <span class="comment">* The reason we need rgimpimpiw is for the keyboard interface - we</span>
00031 <span class="comment">* incrementally decide what our 'move command' is. With the mouse interface</span>
00032 <span class="comment">* we know immediately because we registered a mouse hit on the segment(s)</span>
00033 <span class="comment">* we're moving.</span>
00034 <span class="comment">*</span>
00035 <span class="comment">*       4           5</span>
00036 <span class="comment">*        \ ___3___ /</span>
00037 <span class="comment">*         |       |</span>
00038 <span class="comment">*         1       2</span>
00039 <span class="comment">*         |_______|</span>
00040 <span class="comment">*        /    6    \</span>
00041 <span class="comment">*       7           8</span>
00042 <span class="comment">*</span>
00043 <span class="comment">\****************************************************************************/</span>
00044 
<a name="l00045"></a><a class="code" href="../../d8/d3/movesize_8c.html#a4">00045</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/movesize_8c.html#a4">rgimpimpiw</a>[] = {1, 3, 2, 6};
<a name="l00046"></a><a class="code" href="../../d8/d3/movesize_8c.html#a5">00046</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/movesize_8c.html#a5">rgimpiwx</a>[]   = {0,  0,  2, -1, 0, 2, -1, 0, 2, 0};
<a name="l00047"></a><a class="code" href="../../d8/d3/movesize_8c.html#a6">00047</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/movesize_8c.html#a6">rgimpiwy</a>[]   = {0, -1, -1,  1, 1, 1,  3, 3, 3, 1};
<a name="l00048"></a><a class="code" href="../../d8/d3/movesize_8c.html#a7">00048</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/movesize_8c.html#a7">rgcmdmpix</a>[]  = {0, 1, 2, 0, 1, 2, 0, 1, 2, 1};
<a name="l00049"></a><a class="code" href="../../d8/d3/movesize_8c.html#a8">00049</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/movesize_8c.html#a8">rgcmdmpiy</a>[]  = {0, 0, 0, 3, 3, 3, 6, 6, 6, 3};
00050 
00051 <span class="comment">/***************************************************************************\</span>
00052 <span class="comment">* GetMonitorMaxArea</span>
00053 <span class="comment">*</span>
00054 <span class="comment">* Return the rectangle on a monitor which should be used to</span>
00055 <span class="comment">* maximize to, the work rect or the monitor rect.</span>
00056 <span class="comment">*</span>
00057 <span class="comment">* History:</span>
00058 <span class="comment">* 24-Sep-1996 adams     Created.</span>
00059 <span class="comment">\***************************************************************************/</span>
00060 
00061 <span class="keywordtype">void</span>
<a name="l00062"></a><a class="code" href="../../d4/d1/userk_8h.html#a1332">00062</a> <a class="code" href="../../d4/d1/userk_8h.html#a1332">GetMonitorMaxArea</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor, LPRECT * pprc)
00063 {
00064     <span class="keywordflow">if</span> (    !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a634">WFMAXBOX</a>) ||
00065             !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a553">WFCPRESENT</a>) ||
00066             pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o6">cFullScreen</a>) {
00067 
00068         *pprc = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00069     } <span class="keywordflow">else</span> {
00070         *pprc = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
00071     }
00072 }
00073 
00074 
00075 <span class="comment">/***************************************************************************\</span>
00076 <span class="comment">* SizeRect</span>
00077 <span class="comment">*</span>
00078 <span class="comment">* Match corner or side (defined by cmd) to pt.</span>
00079 <span class="comment">*</span>
00080 <span class="comment">* History:</span>
00081 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3 asm code</span>
00082 <span class="comment">\***************************************************************************/</span>
00083 
<a name="l00084"></a><a class="code" href="../../d8/d3/movesize_8c.html#a10">00084</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/movesize_8c.html#a10">SizeRect</a>(
00085     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd,
00086     DWORD         pt)
00087 {
00088     <span class="keywordtype">int</span>  ax;
00089     <span class="keywordtype">int</span>  dx;
00090     <span class="keywordtype">int</span>  index;
00091     <span class="keywordtype">int</span>  indexOpp;
00092     <a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a> psideDragCursor = ((<a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a>)(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>));
00093     <a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a> psideParent     = ((<a class="code" href="../../d9/d5/ndismain_8h.html#a264">PINT</a>)(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>));
00094 
00095 
00096     <span class="comment">/*</span>
00097 <span class="comment">     * DO HORIZONTAL</span>
00098 <span class="comment">     */</span>
00099 
00100     <span class="comment">/*</span>
00101 <span class="comment">     * We know what part of the rect we're moving based on</span>
00102 <span class="comment">     * what's in cmd.  We use cmd as an index into rgimpiw? which</span>
00103 <span class="comment">     * tells us what part of the rect we're dragging.</span>
00104 <span class="comment">     */</span>
00105 
00106     <span class="comment">/*</span>
00107 <span class="comment">     * Get the approriate array entry.</span>
00108 <span class="comment">     */</span>
00109     index = (<span class="keywordtype">int</span>)<a class="code" href="../../d8/d3/movesize_8c.html#a5">rgimpiwx</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>];   <span class="comment">// AX</span>
00110 
00111     <span class="comment">/*</span>
00112 <span class="comment">     * Is it one of the entries we don't map (i.e.  -1)?</span>
00113 <span class="comment">     */</span>
00114     <span class="keywordflow">if</span> (index &lt; 0)
00115         <span class="keywordflow">goto</span> mrLoopBottom;
00116 
00117     psideDragCursor[index] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(pt);
00118 
00119     indexOpp = index ^ 0x2;
00120 
00121     <span class="comment">/*</span>
00122 <span class="comment">     * Now check to see if we're below the min or above the max. Get the width</span>
00123 <span class="comment">     * of the rect in this direction (either x or y) and see if it's bad. If</span>
00124 <span class="comment">     * so, map the side we're moving to the min or max.</span>
00125 <span class="comment">     */</span>
00126     ax = psideDragCursor[index] - psideDragCursor[indexOpp];
00127 
00128     <span class="keywordflow">if</span> (indexOpp &amp; 0x2)
00129         ax = -ax;
00130 
00131     <span class="keywordflow">if</span> ((ax &gt;= (dx = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o4">ptMinTrack</a>.x)) &amp;&amp;
00132         (ax &lt;= (dx = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o5">ptMaxTrack</a>.x))) {
00133 
00134         <span class="comment">/*</span>
00135 <span class="comment">         * Only test for the parent's client boundary if we are a child</span>
00136 <span class="comment">         * window...Otherwise we are bound to the client of the desktop</span>
00137 <span class="comment">         * which causes strange drag problems.</span>
00138 <span class="comment">         */</span>
00139         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
00140             <span class="keywordflow">goto</span> mrLoopBottom;
00141 
00142         <span class="comment">/*</span>
00143 <span class="comment">         * Now see if we're extending beyond our parent's client rect.</span>
00144 <span class="comment">         * Compute the size the rect can be expanded to in this direction.</span>
00145 <span class="comment">         */</span>
00146         dx = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(psideParent[index] - psideDragCursor[indexOpp]);
00147 
00148         <span class="keywordflow">if</span> (ax &lt;= dx)
00149             <span class="keywordflow">goto</span> mrLoopBottom;
00150 
00151         <span class="comment">/*</span>
00152 <span class="comment">         * The width is invalid - map the side we're moving to the other</span>
00153 <span class="comment">         * side +/- the width.</span>
00154 <span class="comment">         */</span>
00155     }
00156 
00157     <span class="keywordflow">if</span> (indexOpp &amp; 0x2)
00158         dx = -dx;
00159 
00160     psideDragCursor[index] = dx + psideDragCursor[indexOpp];
00161 
00162 mrLoopBottom:
00163 
00164     <span class="comment">/*</span>
00165 <span class="comment">     * DO VERTICAL</span>
00166 <span class="comment">     */</span>
00167 
00168     <span class="comment">/*</span>
00169 <span class="comment">     * We know what part of the rect we're moving based on</span>
00170 <span class="comment">     * what's in cmd.  We use cmd as an index into rgimpiw? which</span>
00171 <span class="comment">     * tells us what part of the rect we're dragging.</span>
00172 <span class="comment">     */</span>
00173 
00174     <span class="comment">/*</span>
00175 <span class="comment">     * Get the approriate array entry.</span>
00176 <span class="comment">     */</span>
00177     index = (<span class="keywordtype">int</span>)<a class="code" href="../../d8/d3/movesize_8c.html#a6">rgimpiwy</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>];   <span class="comment">// AX</span>
00178 
00179     <span class="comment">/*</span>
00180 <span class="comment">     * Is it one of the entries we don't map (i.e.  -1)?</span>
00181 <span class="comment">     */</span>
00182     <span class="keywordflow">if</span> (index &lt; 0)
00183         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00184 
00185     psideDragCursor[index] = <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(pt);
00186 
00187     indexOpp = index ^ 0x2;
00188 
00189     <span class="comment">/*</span>
00190 <span class="comment">     * Now check to see if we're below the min or above the max. Get the width</span>
00191 <span class="comment">     * of the rect in this direction (either x or y) and see if it's bad. If</span>
00192 <span class="comment">     * so, map the side we're moving to the min or max.</span>
00193 <span class="comment">     */</span>
00194     ax = psideDragCursor[index] - psideDragCursor[indexOpp];
00195 
00196     <span class="keywordflow">if</span> (indexOpp &amp; 0x2)
00197         ax = -ax;
00198 
00199     <span class="keywordflow">if</span> ((ax &gt;= (dx = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o4">ptMinTrack</a>.y)) &amp;&amp;
00200         (ax &lt;= (dx = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o5">ptMaxTrack</a>.y))) {
00201 
00202         <span class="comment">/*</span>
00203 <span class="comment">         * Only test for the parent's client boundary if we are a child</span>
00204 <span class="comment">         * window...Otherwise we are bound to the client of the desktop</span>
00205 <span class="comment">         * which causes strange drag problems.</span>
00206 <span class="comment">         */</span>
00207         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
00208             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00209 
00210         <span class="comment">/*</span>
00211 <span class="comment">         * Now see if we're extending beyond our parent's client rect.</span>
00212 <span class="comment">         * Compute the size the rect can be expanded to in this direction.</span>
00213 <span class="comment">         */</span>
00214         dx = <a class="code" href="../../d4/d1/userk_8h.html#a259">abs</a>(psideParent[index] - psideDragCursor[indexOpp]);
00215 
00216         <span class="keywordflow">if</span> (ax &lt;= dx)
00217             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00218 
00219         <span class="comment">/*</span>
00220 <span class="comment">         * The width is invalid - map the side we're moving to the other</span>
00221 <span class="comment">         * side +/- the width.</span>
00222 <span class="comment">         */</span>
00223     }
00224 
00225     <span class="keywordflow">if</span> (indexOpp &amp; 0x2)
00226         dx = -dx;
00227 
00228     psideDragCursor[index] = dx + psideDragCursor[indexOpp];
00229 
00230     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00231 }
00232 
00233 <span class="comment">/***************************************************************************\</span>
00234 <span class="comment">* MoveRect</span>
00235 <span class="comment">*</span>
00236 <span class="comment">* Move the rect to pt, make sure we're not going out of the parent rect.</span>
00237 <span class="comment">*</span>
00238 <span class="comment">* History:</span>
00239 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3 asm code</span>
00240 <span class="comment">\***************************************************************************/</span>
00241 
<a name="l00242"></a><a class="code" href="../../d8/d3/movesize_8c.html#a11">00242</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/movesize_8c.html#a11">MoveRect</a>(
00243     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd,
00244     DWORD         pt)
00245 {
00246     RECT rcAnd;
00247 
00248     <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>,
00249                <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(pt) - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>.left,
00250                <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(pt) - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>.top);
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * Don't move the entire rectangle off the screen.</span>
00254 <span class="comment">     * However, if the window started offscreen completely, let it move.</span>
00255 <span class="comment">     */</span>
00256     <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o19">fOffScreen</a>)
00257         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00258 
00259     <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>) {
00260         <span class="keywordflow">return</span> GreRectInRegion(
00261                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>);
00262     }
00263 
00264     <span class="keywordflow">return</span> <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcAnd, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>);
00265 }
00266 
00267 <span class="comment">/***************************************************************************\</span>
00268 <span class="comment">* xxxTM_MoveDragRect</span>
00269 <span class="comment">*</span>
00270 <span class="comment">* History:</span>
00271 <span class="comment">* 12-Nov-1990 MikeHar      Ported from win3</span>
00272 <span class="comment">\***************************************************************************/</span>
00273 
<a name="l00274"></a><a class="code" href="../../d8/d3/movesize_8c.html#a12">00274</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/movesize_8c.html#a12">xxxTM_MoveDragRect</a>(
00275     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd,
00276     LPARAM        lParam)
00277 {
00278     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00279     RECT rc;
00280 
00281     UserAssert(pmsd == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pmsd);
00282     UserAssert(pmsd-&gt;cmd != WMSZ_KEYSIZE);
00283 
00284     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;rcDragCursor, &amp;pmsd-&gt;rcDrag);
00285 
00286     <span class="keywordflow">if</span> (pmsd-&gt;cmd == WMSZ_MOVE) {
00287 
00288         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/movesize_8c.html#a11">MoveRect</a>(pmsd, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam))
00289             <span class="keywordflow">return</span>;
00290 
00291         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_MOVING;
00292 
00293     } <span class="keywordflow">else</span> {
00294 
00295         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/movesize_8c.html#a10">SizeRect</a>(pmsd, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lParam))
00296             <span class="keywordflow">return</span>;
00297 
00298         <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a> = WM_SIZING;
00299     }
00300 
00301     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pmsd-&gt;rcDragCursor);
00302     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pmsd-&gt;spwnd, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, pmsd-&gt;cmd, (LPARAM)(LPRECT)&amp;rc);
00303     <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsd, &amp;rc, <a class="code" href="../../d8/d3/movesize_8c.html#a1">DRAG_MOVE</a>);
00304 
00305     <span class="keywordflow">if</span> (pmsd-&gt;cmd == WMSZ_MOVE) {
00306 
00307         <span class="comment">/*</span>
00308 <span class="comment">         * Keep dxMouse &amp; dxMouse relative to the offset from the top left</span>
00309 <span class="comment">         * corner, the rectangle could've changed on WM_MOVING</span>
00310 <span class="comment">         */</span>
00311         pmsd-&gt;dxMouse += (rc.left - <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(lParam));
00312         pmsd-&gt;dyMouse += (rc.top - <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(lParam));
00313     }
00314 }
00315 
00316 <span class="comment">/***************************************************************************\</span>
00317 <span class="comment">* CkptRestore</span>
00318 <span class="comment">*</span>
00319 <span class="comment">* Positions are always relative to the origin of the monitor's working</span>
00320 <span class="comment">* area that the window is on, except for rcNormal.  That way, windows will</span>
00321 <span class="comment">* maximize to the working area of the monitor they find themselves on, and</span>
00322 <span class="comment">* not to a random place.</span>
00323 <span class="comment">*</span>
00324 <span class="comment">* This allows us to keep information in a reasonably independent fashion,</span>
00325 <span class="comment">* information that doesn't go out of date when a window moves or the</span>
00326 <span class="comment">* monitors are configured differently.</span>
00327 <span class="comment">*</span>
00328 <span class="comment">* rcNormal is different because that does need to be absolute.  It's where</span>
00329 <span class="comment">* the window should come up the first time in a normal state.</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* History:</span>
00332 <span class="comment">* 14-Nov-1990 DarrinM   Ported from Win 3.0 sources.</span>
00333 <span class="comment">\***************************************************************************/</span>
00334 
<a name="l00335"></a><a class="code" href="../../d4/d1/userk_8h.html#a1240">00335</a> <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(
00336     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwnd,
00337     LPCRECT lprcWindow)
00338 {
00339     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp;
00340 
00341     <span class="comment">/*</span>
00342 <span class="comment">     * Don't return or create a checkpoint if the window is dying.</span>
00343 <span class="comment">     */</span>
00344     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pwnd))
00345         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00346 
00347     <span class="comment">/*</span>
00348 <span class="comment">     * If it doesn't exist, create it.</span>
00349 <span class="comment">     */</span>
00350     <span class="keywordflow">if</span> ((pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a>)<a class="code" href="../../d7/d8/rtl_2winprop_8c.html#a2">_GetProp</a>(pwnd,
00351                                      <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>,
00352                                      <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00353 
00354         <span class="keywordflow">if</span> ((pcp = (<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a>)UserAllocPoolWithQuota(<span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/structtagCHECKPOINT.html">CHECKPOINT</a>),
00355                                                        TAG_CHECKPT)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00356             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00357         }
00358 
00359         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/kernel_2winprop_8c.html#a0">InternalSetProp</a>(pwnd,
00360                              <a class="code" href="../../d4/d1/userk_8h.html#a475">PROP_CHECKPOINT</a>,
00361                              (HANDLE)pcp,
00362                              <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a498">PROPF_INTERNAL</a>)) {
00363 
00364             UserFreePool(pcp);
00365             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00366         }
00367 
00368         <span class="comment">/*</span>
00369 <span class="comment">         * Initialize it to -1 so first minimize will park the icon.</span>
00370 <span class="comment">         */</span>
00371         pcp-&gt;ptMin.x = -1;
00372         pcp-&gt;ptMin.y = -1;
00373         pcp-&gt;ptMax.x = -1;
00374         pcp-&gt;ptMax.y = -1;
00375 
00376         <span class="comment">/*</span>
00377 <span class="comment">         * Initialize pwndTitle to NULL so we create a title window on the</span>
00378 <span class="comment">         * first minimize of the window</span>
00379 <span class="comment">         */</span>
00380         pcp-&gt;fDragged                     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00381         pcp-&gt;fWasMaximizedBeforeMinimized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382         pcp-&gt;fWasMinimizedBeforeMaximized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00383         pcp-&gt;fMinInitialized              = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00384         pcp-&gt;fMaxInitialized              = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00385 
00386         <span class="comment">/*</span>
00387 <span class="comment">         * BOGUS!  We're going to copy this twice if the window isn't</span>
00388 <span class="comment">         * minimized or maximized.  But if it isn't, we're going to get</span>
00389 <span class="comment">         * a weird size in rcNormal...</span>
00390 <span class="comment">         */</span>
00391         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pcp-&gt;rcNormal, lprcWindow);
00392     }
00393 
00394     <span class="comment">/*</span>
00395 <span class="comment">     * If the window is minimized/maximized, then set the min/max</span>
00396 <span class="comment">     * point.  Otherwise use checkpoint the window-size.</span>
00397 <span class="comment">     */</span>
00398     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00399         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o6">fMinInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00400         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.x = lprcWindow-&gt;left;
00401         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o1">ptMin</a>.y = lprcWindow-&gt;top;
00402     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00403         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00404 
00405         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00406             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a582">WFREALLYMAXIMIZABLE</a>)) {
00407                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o7">fMaxInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.x = -1;
00409                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.y = -1;
00410             } <span class="keywordflow">else</span> {
00411                 <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a> pMonitor;
00412                 LPRECT   lprc;
00413 
00414                 pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(lprcWindow, MONITOR_DEFAULTTOPRIMARY);
00415                 <a class="code" href="../../d4/d1/userk_8h.html#a1332">GetMonitorMaxArea</a>(pwnd, pMonitor, &amp;lprc);
00416                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.x = lprcWindow-&gt;left - lprc-&gt;left;
00417                 pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.y = lprcWindow-&gt;top - lprc-&gt;top;
00418             }
00419         } <span class="keywordflow">else</span> {
00420             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.x = lprcWindow-&gt;left;
00421             pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o2">ptMax</a>.y = lprcWindow-&gt;top;
00422         }
00423     } <span class="keywordflow">else</span> {
00424         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o0">rcNormal</a>, lprcWindow);
00425     }
00426 
00427     <span class="keywordflow">return</span> pcp;
00428 }
00429 
00430 <span class="comment">/***************************************************************************\</span>
00431 <span class="comment">* xxxMS_TrackMove</span>
00432 <span class="comment">*</span>
00433 <span class="comment">* History:</span>
00434 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3</span>
00435 <span class="comment">\***************************************************************************/</span>
00436 
<a name="l00437"></a><a class="code" href="../../d8/d3/movesize_8c.html#a14">00437</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d3/movesize_8c.html#a14">xxxMS_TrackMove</a>(
00438     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwnd,
00439     UINT          message,
00440     WPARAM        wParam,
00441     LPARAM        lParam,
00442     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd)
00443 {
00444     <span class="keywordtype">int</span>         dxMove;
00445     <span class="keywordtype">int</span>         dyMove;
00446     POINT       pt;
00447     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fSlower;
00448     RECT        rc;
00449     <a class="code" href="../../d0/d0/structtagCHECKPOINT.html">PCHECKPOINT</a> pcp;
00450     LPWORD      ps;
00451     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00452 
00453     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00454     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00455     UserAssert(pmsd == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>);
00456 
00457     pt.x = <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(lParam);
00458     pt.y = <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(lParam);
00459 
00460     <span class="keywordflow">switch</span> (message) {
00461     <span class="keywordflow">case</span> WM_LBUTTONUP:
00462 
00463         <span class="comment">/*</span>
00464 <span class="comment">         * Do final move!</span>
00465 <span class="comment">         */</span>
00466         <a class="code" href="../../d8/d3/movesize_8c.html#a12">xxxTM_MoveDragRect</a>(pmsd, lParam);
00467 
00468 
00469         <span class="comment">/*</span>
00470 <span class="comment">         * Don't reset the mouse position when done.</span>
00471 <span class="comment">         */</span>
00472         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o14">fmsKbd</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00473 
00474 Accept:
00475 
00476         <span class="comment">/*</span>
00477 <span class="comment">         * Turn off rect, unlock screen, release capture, and stop tracking.</span>
00478 <span class="comment">         * 1 specifies end and accept drag.</span>
00479 <span class="comment">         */</span>
00480         bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00481         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>) {
00482             <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a360">DDR_ENDACCEPT</a>);
00483             ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>;
00484         }
00485 
00486 TrackMoveCancel:
00487 
00488         <span class="comment">/*</span>
00489 <span class="comment">         * Revalidation: if pwnd is unexpectedly deleted, jump here to cleanup.</span>
00490 <span class="comment">         * If pwnd is/becomes invalid between here and return, continue with</span>
00491 <span class="comment">         * cleanup as best as possible.</span>
00492 <span class="comment">         */</span>
00493         <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>((LPRECT)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00494         <a class="code" href="../../d4/d1/userk_8h.html#a1772">LockWindowUpdate2</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00495         <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
00496 
00497         <span class="comment">/*</span>
00498 <span class="comment">         * First unlock task and reset cursor.</span>
00499 <span class="comment">         */</span>
00500         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00501 
00502         <span class="comment">/*</span>
00503 <span class="comment">         * If using the keyboard, restore the initial mouse position.</span>
00504 <span class="comment">         */</span>
00505         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o14">fmsKbd</a>) {
00506             <span class="comment">/*</span>
00507 <span class="comment">             * No DeferWinEventNotify required - xxx calls above &amp; below</span>
00508 <span class="comment">             */</span>
00509             <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o12">ptRestore</a>.x,
00510                                  pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o12">ptRestore</a>.y
00511                                  );
00512         }
00513 
00514         <span class="comment">/*</span>
00515 <span class="comment">         * Move to new location relative to parent.</span>
00516 <span class="comment">         */</span>
00517         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00518             rc.left = rc.top = 0;
00519         } <span class="keywordflow">else</span> {
00520             rc.left = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00521             rc.top = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00522         }
00523 
00524         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>)) {
00525 
00526             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_MOVESIZE,
00527                              (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd),
00528                              (LPARAM)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>,
00529                              WH_CBT)) {
00530 
00531                 RECT rcT;
00532 
00533                 <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> != WMSZ_MOVE) {
00534 
00535                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00536 
00537                         <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rcT,
00538                                        &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>,
00539                                        -rc.left,
00540                                        -rc.top);
00541 
00542                         <span class="comment">/*</span>
00543 <span class="comment">                         * Save the minimized position.</span>
00544 <span class="comment">                         */</span>
00545                         <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;rcT);
00546                         <a class="code" href="../../d4/d1/userk_8h.html#a1631">SetMinimize</a>(pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a574">SMIN_CLEAR</a>);
00547 
00548                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>)) {
00549                         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a648">WFMAXIMIZED</a>);
00550                     }
00551 
00552                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00553 
00554                     <a class="code" href="../../d3/d6/rect_8c.html#a3">CopyOffsetRect</a>(&amp;rcT,
00555                                    &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>,
00556                                    -rc.left,
00557                                    -rc.top);
00558 
00559 
00560                     <span class="keywordflow">if</span> (pcp = <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;rcT))
00561                         pcp-&gt;<a class="code" href="../../d0/d0/structtagCHECKPOINT.html#o3">fDragged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00562                 }
00563 
00564             } <span class="keywordflow">else</span> {
00565                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>);
00566             }
00567         }
00568 
00569         <span class="comment">/*</span>
00570 <span class="comment">         * Move to new location relative to parent.</span>
00571 <span class="comment">         */</span>
00572 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
00573 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>,WEFLAYOUTRTL)) {
00574             <span class="comment">/*</span>
00575 <span class="comment">             * If this is a mirrored window, then measure the client</span>
00576 <span class="comment">             * coordinates from the parent's right edge, not the left one.</span>
00577 <span class="comment">             */</span>
00578             <span class="keywordtype">int</span> iLeft;
00579 
00580             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right, -rc.top);
00581             iLeft = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.left;
00582             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.left  = (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.right * -1);
00583             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.right = (iLeft * -1);
00584         }
00585         <span class="keywordflow">else</span>
00586 <span class="preprocessor">#endif</span>
00587 <span class="preprocessor"></span>            <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, -rc.left, -rc.top);
00588 
00589         <span class="comment">/*</span>
00590 <span class="comment">         * For top level windows, make sure at least part of the caption</span>
00591 <span class="comment">         * caption is always visible in the desktop area.  This will</span>
00592 <span class="comment">         * ensure that once moved, the window can be moved back.</span>
00593 <span class="comment">         */</span>
00594         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00595 
00596             <span class="keywordtype">int</span>         dy;
00597             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        fMonitor;
00598             <a class="code" href="../../d0/d2/structtagMONITOR.html">PMONITOR</a>    pMonitor;
00599 
00600             UserAssert(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>));
00601             fMonitor = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>);
00602             dy = (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>) ?
00603                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSMCAPTION) : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYCAPTION)) - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
00604 
00605             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> == 1) {
00606                 pMonitor = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>();
00607             } <span class="keywordflow">else</span> {
00608                 <span class="keywordtype">int</span>     y;
00609                 LPRECT  lprc;
00610 
00611                 y = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top + dy;
00612 
00613                 <span class="comment">/*</span>
00614 <span class="comment">                 * Make sure that some part of the caption is showing on some</span>
00615 <span class="comment">                 * monitor...</span>
00616 <span class="comment">                 */</span>
00617                 <span class="keywordflow">for</span> (   pMonitor = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o13">pMonitorFirst</a>;
00618                         pMonitor;
00619                         pMonitor = pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o1">pMonitorNext</a>) {
00620 
00621                     <span class="keywordflow">if</span> (!(pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o2">dwMONFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a525">MONF_VISIBLE</a>))
00622                         <span class="keywordflow">continue</span>;
00623 
00624                     <span class="keywordflow">if</span> (fMonitor) {
00625                         lprc = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>;
00626                     } <span class="keywordflow">else</span> {
00627                         lprc = &amp;pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
00628                     }
00629 
00630                     <span class="comment">/*</span>
00631 <span class="comment">                     * Is the Y coordinate visible on screen somewhere?</span>
00632 <span class="comment">                     */</span>
00633                     <span class="keywordflow">if</span> (y &gt;= lprc-&gt;top &amp;&amp; y &lt; lprc-&gt;bottom)
00634                         <span class="keywordflow">goto</span> AllSet;
00635                 }
00636 
00637                 <span class="comment">/*</span>
00638 <span class="comment">                 * Oops, have to move the window so that some part of</span>
00639 <span class="comment">                 * the caption is visible on screen.</span>
00640 <span class="comment">                 */</span>
00641                 pMonitor = <a class="code" href="../../d9/d1/mmrtl_8c.html#a7">_MonitorFromRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, MONITOR_DEFAULTTONEAREST);
00642             }
00643 
00644             <span class="keywordflow">if</span> (fMonitor) {
00645                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o3">rcMonitor</a>.top - dy);
00646             } <span class="keywordflow">else</span> {
00647                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top, pMonitor-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>.top - dy);
00648             }
00649 
00650 AllSet:
00651             ;
00652         }
00653 
00654         <span class="comment">/*</span>
00655 <span class="comment">         * OR in SWP_NOSIZE so it doesn't redraw if we're just moving.</span>
00656 <span class="comment">         */</span>
00657         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(
00658                 pwnd,
00659                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00660                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.left,
00661                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top,
00662                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.right - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.left,
00663                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.bottom - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top,
00664                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> == (<span class="keywordtype">int</span>)WMSZ_MOVE) ? SWP_NOSIZE : 0));
00665 
00666         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00667             <a class="code" href="../../d4/d1/userk_8h.html#a1240">CkptRestore</a>(pwnd, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>);
00668         }
00669 
00670         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00671             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MOVESIZEEND, pwnd, OBJID_WINDOW, INDEXID_CONTAINER, 0);
00672         }
00673 
00674         <span class="comment">/*</span>
00675 <span class="comment">         * Send this message for winoldapp support</span>
00676 <span class="comment">         */</span>
00677         <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_EXITSIZEMOVE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
00678         <span class="keywordflow">break</span>;
00679 
00680     <span class="keywordflow">case</span> WM_KEYDOWN:
00681     <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00682 
00683         <span class="comment">/*</span>
00684 <span class="comment">         * Assume we're not moving the drag rectangle.</span>
00685 <span class="comment">         */</span>
00686         dxMove =
00687         dyMove = 0;
00688 
00689         <span class="comment">/*</span>
00690 <span class="comment">         * We move or size slower if the control key is down.</span>
00691 <span class="comment">         */</span>
00692         fSlower = (<a class="code" href="../../d7/d9/keyboard_8c.html#a1">_GetKeyState</a>(VK_CONTROL) &lt; 0);
00693 
00694         <span class="keywordflow">switch</span> (wParam) {
00695         <span class="keywordflow">case</span> VK_RETURN:
00696             lParam = <a class="code" href="../../d4/d1/userk_8h.html#a1639">_GetMessagePos</a>();
00697             <span class="keywordflow">goto</span> Accept;
00698 
00699         <span class="keywordflow">case</span> VK_ESCAPE:
00700 
00701             <span class="comment">/*</span>
00702 <span class="comment">             * 2 specifies end and cancel drag.</span>
00703 <span class="comment">             */</span>
00704             bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00705             <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>) {
00706                 <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a361">DDR_ENDCANCEL</a>);
00707                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>;
00708             }
00709 
00710             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>);
00711 
00712             <span class="keywordflow">goto</span> TrackMoveCancel;
00713 
00714         <span class="keywordflow">case</span> VK_LEFT:
00715         <span class="keywordflow">case</span> VK_RIGHT:
00716 
00717             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> == 0) {
00718 
00719                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a4">rgimpimpiw</a>[wParam - VK_LEFT];
00720                 <span class="keywordflow">goto</span> NoOffset;
00721 
00722             } <span class="keywordflow">else</span> {
00723 
00724                 dxMove = (fSlower ? 1 : <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXSIZE) / 2, 1));
00725 
00726                 <span class="keywordflow">if</span> (wParam == VK_LEFT)
00727                     dxMove = -dxMove;
00728 
00729                 <span class="keywordflow">goto</span> KeyMove;
00730             }
00731 
00732         <span class="keywordflow">case</span> VK_UP:
00733         <span class="keywordflow">case</span> VK_DOWN:
00734 
00735             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a> == 0) {
00736 
00737                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a4">rgimpimpiw</a>[wParam - VK_LEFT];
00738 NoOffset:
00739                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a> = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a> = 0;
00740 
00741             } <span class="keywordflow">else</span> {
00742 
00743                 dyMove = (fSlower ? 1 : <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYSIZE) / 2, 1));
00744 
00745                 <span class="keywordflow">if</span> (wParam == VK_UP) {
00746                     dyMove = -dyMove;
00747                 }
00748             }
00749 
00750 KeyMove:
00751             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> == WMSZ_MOVE) {
00752 
00753                 <span class="comment">/*</span>
00754 <span class="comment">                 * Use the current rect position as the current mouse</span>
00755 <span class="comment">                 * position</span>
00756 <span class="comment">                 */</span>
00757                 lParam = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(POINTTOPOINTS(*((POINT *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>)));
00758 
00759             } <span class="keywordflow">else</span> {
00760 
00761                 <span class="comment">/*</span>
00762 <span class="comment">                 * Get the current mouse position</span>
00763 <span class="comment">                 */</span>
00764                 lParam = <a class="code" href="../../d4/d1/userk_8h.html#a1639">_GetMessagePos</a>();
00765             }
00766 
00767             <span class="comment">/*</span>
00768 <span class="comment">             * Calc the new 'mouse' pos</span>
00769 <span class="comment">             */</span>
00770             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> != 0) {
00771                 ps = ((WORD *)(&amp;lParam)) + 0;
00772                 *ps = (WORD)(*((<span class="keywordtype">int</span> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a> +
00773                              <a class="code" href="../../d8/d3/movesize_8c.html#a5">rgimpiwx</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a>])        +
00774                              dxMove);
00775             }
00776 
00777             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a> != 0) {
00778                 ps = ((WORD *)(&amp;lParam)) + 1;
00779                 *ps = (WORD)(*((<span class="keywordtype">int</span> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a> +
00780                              <a class="code" href="../../d8/d3/movesize_8c.html#a6">rgimpiwy</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a>])        +
00781                              dyMove);
00782             }
00783 
00784             <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> != WMSZ_MOVE) {
00785 
00786                 <span class="comment">/*</span>
00787 <span class="comment">                 * Calculate the new move command.</span>
00788 <span class="comment">                 */</span>
00789                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a>;
00790 
00791                 <span class="comment">/*</span>
00792 <span class="comment">                 * Change the mouse cursor for this condition.</span>
00793 <span class="comment">                 */</span>
00794                 <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(
00795                         pwnd,
00796                         WM_SETCURSOR,
00797                         (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
00798                         MAKELONG((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> + HTSIZEFIRST - WMSZ_SIZEFIRST), WM_MOUSEMOVE));
00799             }
00800 
00801             <span class="comment">/*</span>
00802 <span class="comment">             * We don't want to call zzzInternalSetCursorPos() if the</span>
00803 <span class="comment">             * rect position is outside of rcParent because that'll</span>
00804 <span class="comment">             * generate a mouse move which will jerk the rect back</span>
00805 <span class="comment">             * again.  This is here so we can move rects partially off</span>
00806 <span class="comment">             * screen without regard to the mouse position.</span>
00807 <span class="comment">             */</span>
00808             pt.x = <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(lParam) - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a>;
00809             pt.y = <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(lParam) - pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a>;
00810 
00811             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>) {
00812                 <span class="keywordflow">if</span> (GrePtInRegion(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, pt.x, pt.y)) {
00813                     <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pt.x, pt.y);
00814                 }
00815             } <span class="keywordflow">else</span> {
00816                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>, pt)) {
00817                     <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(pt.x, pt.y);
00818                 }
00819             }
00820 
00821             <span class="comment">/*</span>
00822 <span class="comment">             * Move or size the rect using lParam as our mouse</span>
00823 <span class="comment">             * coordinates</span>
00824 <span class="comment">             */</span>
00825             <a class="code" href="../../d8/d3/movesize_8c.html#a12">xxxTM_MoveDragRect</a>(pmsd, lParam);
00826             <span class="keywordflow">break</span>;
00827 
00828         }  <span class="comment">// of inner switch</span>
00829         <span class="keywordflow">break</span>;
00830 
00831     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00832         <a class="code" href="../../d8/d3/movesize_8c.html#a12">xxxTM_MoveDragRect</a>(pmsd, lParam);
00833         <span class="keywordflow">break</span>;
00834     }
00835 }
00836 
00837 <span class="comment">/***************************************************************************\</span>
00838 <span class="comment">* xxxMS_FlushWigglies</span>
00839 <span class="comment">*</span>
00840 <span class="comment">* History:</span>
00841 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3</span>
00842 <span class="comment">\***************************************************************************/</span>
00843 
<a name="l00844"></a><a class="code" href="../../d8/d3/movesize_8c.html#a15">00844</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/movesize_8c.html#a15">xxxMS_FlushWigglies</a>(VOID)
00845 {
00846     MSG <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
00847 
00848     <span class="comment">/*</span>
00849 <span class="comment">     * HACK!</span>
00850 <span class="comment">     *</span>
00851 <span class="comment">     * Calling zzzInternalSetCursorPos() while initializing the cursor</span>
00852 <span class="comment">     * position appears to be posting a bogus MouseMove</span>
00853 <span class="comment">     * message...  don't really have the time</span>
00854 <span class="comment">     * now to figure out why...  so spit out all the mouse move messages</span>
00855 <span class="comment">     * before entering the main move/size loop.  CraigC.</span>
00856 <span class="comment">     */</span>
00857     <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
00858                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00859                           WM_MOUSEMOVE,
00860                           WM_MOUSEMOVE,
00861                           PM_REMOVE | PM_NOYIELD));
00862 }
00863 
00864 <span class="comment">/***************************************************************************\</span>
00865 <span class="comment">* xxxTrackInitSize</span>
00866 <span class="comment">*</span>
00867 <span class="comment">* NOTE: to recover from hwnd invalidation, just return and let ?</span>
00868 <span class="comment">*</span>
00869 <span class="comment">* History:</span>
00870 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3</span>
00871 <span class="comment">\***************************************************************************/</span>
00872 
<a name="l00873"></a><a class="code" href="../../d8/d3/movesize_8c.html#a16">00873</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d3/movesize_8c.html#a16">xxxTrackInitSize</a>(
00874     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>          pwnd,
00875     UINT          message,
00876     WPARAM        wParam,
00877     LPARAM        lParam,
00878     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd)
00879 {
00880     <span class="keywordtype">int</span>   ht;
00881     POINT pt;
00882     RECT  rc;
00883     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00884 
00885     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00886     UserAssert(pmsd == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>);
00887     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00888 
00889     POINTSTOPOINT(pt, lParam);
00890 
00891     <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a18">_ClientToScreen</a>(pwnd, (LPPOINT)&amp;pt);
00892     ht = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a0">FindNCHit</a>(pwnd, POINTTOPOINTS(pt));
00893 
00894     <span class="keywordflow">switch</span> (message) {
00895 
00896     <span class="keywordflow">case</span> WM_KEYDOWN:
00897         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> == WMSZ_MOVE) {
00898             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd,
00899                            WM_SETCURSOR,
00900                            (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
00901                            MAKELONG(WMSZ_KEYSIZE, WM_MOUSEMOVE));
00902         }
00903         <span class="comment">/* keys below are only allowed */</span>
00904         <span class="keywordflow">switch</span> (wParam) {
00905         <span class="keywordflow">case</span> VK_RETURN:
00906         <span class="keywordflow">case</span> VK_ESCAPE:
00907         <span class="keywordflow">case</span> VK_LEFT:
00908         <span class="keywordflow">case</span> VK_RIGHT:
00909         <span class="keywordflow">case</span> VK_UP:
00910         <span class="keywordflow">case</span> VK_DOWN:
00911             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00912             <span class="keywordflow">break</span>;
00913         }
00914         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00915 
00916     <span class="keywordflow">case</span> WM_LBUTTONDOWN:
00917         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, pt)) {
00918 
00919             <span class="comment">/*</span>
00920 <span class="comment">             *** FALL THRU ***</span>
00921 <span class="comment">             */</span>
00922 
00923     <span class="keywordflow">case</span> WM_LBUTTONUP:
00924 
00925             <span class="comment">/*</span>
00926 <span class="comment">             * Cancel everything.</span>
00927 <span class="comment">             */</span>
00928             {
00929                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00930 
00931                 bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00932                 <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>) {
00933                     <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a361">DDR_ENDCANCEL</a>);
00934                     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>;
00935                 }
00936 
00937                 pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00938                 <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00939             }
00940 
00941             <a class="code" href="../../d4/d1/userk_8h.html#a1713">xxxReleaseCapture</a>();
00942             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00943             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00944 
00945         } <span class="keywordflow">else</span> {
00946 
00947             <span class="comment">/*</span>
00948 <span class="comment">             * Now start hit testing for a border.</span>
00949 <span class="comment">             */</span>
00950             <span class="keywordflow">goto</span> CheckFrame;
00951         }
00952 
00953     <span class="keywordflow">case</span> WM_MOUSEMOVE:
00954 
00955         <span class="comment">/*</span>
00956 <span class="comment">         * The mouse is down, hit test for a border on mouse moves.</span>
00957 <span class="comment">         */</span>
00958         <span class="keywordflow">if</span> (wParam == MK_LBUTTON) {
00959 
00960 CheckFrame:
00961 
00962             <span class="keywordflow">switch</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>) {
00963             <span class="keywordflow">case</span> WMSZ_MOVE:
00964 
00965                 <span class="comment">/*</span>
00966 <span class="comment">                 * If we are on the caption bar, exit.</span>
00967 <span class="comment">                 */</span>
00968                 <span class="keywordflow">if</span> (ht == HTCAPTION) {
00969 
00970                     <span class="comment">/*</span>
00971 <span class="comment">                     * Change the mouse cursor.</span>
00972 <span class="comment">                     */</span>
00973                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd,
00974                                    WM_SETCURSOR,
00975                                    (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
00976                                    MAKELONG(WMSZ_KEYSIZE, WM_MOUSEMOVE));
00977 
00978                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a>   = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>.left - pt.x;
00979                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a>   = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>.top - pt.y;
00980                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00981                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00982                 }
00983                 <span class="keywordflow">break</span>;
00984 
00985             <span class="keywordflow">case</span> WMSZ_KEYSIZE:
00986 
00987                 <span class="comment">/*</span>
00988 <span class="comment">                 * If we are on a frame control, change the cursor and exit.</span>
00989 <span class="comment">                 */</span>
00990                 <span class="keywordflow">if</span> (ht &gt;= HTSIZEFIRST &amp;&amp; ht &lt;= HTSIZELAST) {
00991 
00992                     <span class="comment">/*</span>
00993 <span class="comment">                     * Change the mouse cursor</span>
00994 <span class="comment">                     */</span>
00995                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd,
00996                                    WM_SETCURSOR,
00997                                    (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
00998                                    MAKELONG(ht, WM_MOUSEMOVE));
00999 
01000                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01001 
01002                     <span class="comment">/*</span>
01003 <span class="comment">                     * Set the proper cmd for SizeRect().</span>
01004 <span class="comment">                     *</span>
01005 <span class="comment">                     * HACK! Depends on order of HTSIZE* defines!</span>
01006 <span class="comment">                     */</span>
01007                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a7">rgcmdmpix</a>[ht - HTSIZEFIRST + 1];
01008                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a8">rgcmdmpiy</a>[ht - HTSIZEFIRST + 1];
01009                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>  = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a>;
01010 
01011                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a> = *((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a> + <a class="code" href="../../d8/d3/movesize_8c.html#a5">rgimpiwx</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>]) - pt.x;
01012                     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a> = *((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d6/d7/aug98_2dll32_2icmdll_8h.html#a5">FAR</a> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a> + <a class="code" href="../../d8/d3/movesize_8c.html#a6">rgimpiwy</a>[pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a>]) - pt.y;
01013 
01014                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01015                 }
01016             }
01017 
01018         } <span class="keywordflow">else</span> {
01019 
01020             <span class="comment">/*</span>
01021 <span class="comment">             * If button not down, and we are moving the window, change the</span>
01022 <span class="comment">             * cursor shape depending upon where the mouse is pointing.  This</span>
01023 <span class="comment">             * allows the cursor to change to the arrows when over the window</span>
01024 <span class="comment">             * frame.</span>
01025 <span class="comment">             */</span>
01026             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01027             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;rc, pt)) {
01028                 <span class="keywordflow">if</span> ((ht &gt;= HTSIZEFIRST) &amp;&amp; (ht &lt;= HTSIZELAST)) {
01029                     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd,
01030                                    WM_SETCURSOR,
01031                                    (WPARAM)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd),
01032                                    MAKELONG(ht, WM_MOUSEMOVE));
01033 
01034                     <span class="keywordflow">break</span>;
01035                 }
01036             }
01037 
01038             <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(<a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(SIZEALL));
01039         }
01040         <span class="keywordflow">break</span>;
01041     }
01042 
01043     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01044 }
01045 
01046 <span class="comment">/***************************************************************************\</span>
01047 <span class="comment">* xxxMoveSize</span>
01048 <span class="comment">*</span>
01049 <span class="comment">* History:</span>
01050 <span class="comment">* 12-Nov-1990 MikeHar   Ported from win3</span>
01051 <span class="comment">\***************************************************************************/</span>
01052 
<a name="l01053"></a><a class="code" href="../../d4/d1/userk_8h.html#a1508">01053</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1508">xxxMoveSize</a>(
01054     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01055     UINT  cmdMove,
01056     DWORD wptStart)
01057 {
01058     MSG             <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>;
01059     <span class="keywordtype">int</span>             x;
01060     <span class="keywordtype">int</span>             y;
01061     <span class="keywordtype">int</span>             i;
01062     RECT            rcSys;
01063     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01064     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a>   pmsd;
01065     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>              tlpwndT;
01066     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>            pwndT;
01067     POINT           ptStart;
01068     MINMAXINFO      mmi;
01069 
01070     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01071     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
01072 
01073     <span class="comment">/*</span>
01074 <span class="comment">     * Don't allow the app to track a window</span>
01075 <span class="comment">     * from another queue.</span>
01076 <span class="comment">     */</span>
01077     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;pq != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>)
01078         <span class="keywordflow">return</span>;
01079 
01080     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01081         <span class="keywordflow">return</span>;
01082 
01083     <span class="comment">/*</span>
01084 <span class="comment">     * If the window with the focus is a combobox, hide the dropdown</span>
01085 <span class="comment">     * listbox before tracking starts.  The dropdown listbox is not a</span>
01086 <span class="comment">     * child of the window being moved, therefore it won't be moved along</span>
01087 <span class="comment">     * with the window.</span>
01088 <span class="comment">     *</span>
01089 <span class="comment">     * NOTE: Win 3.1 doesn't perform this check.</span>
01090 <span class="comment">     */</span>
01091     <span class="keywordflow">if</span> ((pwndT = ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o7">spwndFocus</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01092 
01093         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndT) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>) {
01094             ;
01095         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01096                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a201">FNID_COMBOBOX</a>)) {
01097 
01098             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01099         } <span class="keywordflow">else</span> {
01100             pwndT = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01101         }
01102 
01103         <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01104             <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pwndT, &amp;tlpwndT);
01105             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndT, CB_SHOWDROPDOWN, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, 0);
01106             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
01107         }
01108     }
01109 
01110     <span class="comment">/*</span>
01111 <span class="comment">     * Allocate and zero the movesize data structure</span>
01112 <span class="comment">     */</span>
01113     pmsd = (<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a>)UserAllocPoolWithQuotaZInit(
01114             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">MOVESIZEDATA</a>), TAG_MOVESIZE);
01115 
01116     <span class="keywordflow">if</span> (pmsd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01117         <span class="keywordflow">return</span>;
01118 
01119     <span class="comment">/*</span>
01120 <span class="comment">     * Assign the move data into the pti.  If the thread is destroyed before</span>
01121 <span class="comment">     * we free the data the DestroyThreadInfo() routine will free the move data</span>
01122 <span class="comment">     */</span>
01123     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> = pmsd;
01124 
01125     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>), pwnd);
01126 
01127     <span class="comment">/*</span>
01128 <span class="comment">     * Set fForeground so we know whether to draw or not.</span>
01129 <span class="comment">     */</span>
01130     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o17">fForeground</a> = (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a> == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01131 
01132     <span class="comment">/*</span>
01133 <span class="comment">     * Lower the priority of the thread doing the dragging to make sure</span>
01134 <span class="comment">     * that we don't starve other threads and they get to repaint more often.</span>
01135 <span class="comment">     */</span>
01136     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>) {
01137         <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01138     }
01139 
01140     <span class="comment">/*</span>
01141 <span class="comment">     * Get the client and window rects.</span>
01142 <span class="comment">     */</span>
01143     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01144 
01145     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01146         <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a615">WEFTOPMOST</a>) ||
01147                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a619">WEFTOOLWINDOW</a>) ||
01148                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o11">cMonitors</a> &gt; 1) {
01149 
01150             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o14">rcScreen</a>;
01151          } <span class="keywordflow">else</span> {
01152             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a> = <a class="code" href="../../d6/d0/usercli_8h.html#a793">GetPrimaryMonitor</a>()-&gt;<a class="code" href="../../d0/d2/structtagMONITOR.html#o4">rcWork</a>;
01153          }
01154     } <span class="keywordflow">else</span> {
01155         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>);
01156 
01157         <span class="comment">/*</span>
01158 <span class="comment">         * If the parent does have a region, intersect with its bounding rect.</span>
01159 <span class="comment">         */</span>
01160         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01161 
01162             RECT rcT;
01163 
01164             GreGetRgnBox(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, &amp;rcT);
01165             <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>, &amp;rcT);
01166         }
01167     }
01168 
01169     <span class="comment">/*</span>
01170 <span class="comment">     * This works for multiple monitors _and_ regional windows</span>
01171 <span class="comment">     */</span>
01172     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>) {
01173         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o19">fOffScreen</a> = !GreRectInRegion(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>);
01174     } <span class="keywordflow">else</span> {
01175         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o19">fOffScreen</a> = !<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcSys, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>);
01176     }
01177 
01178     <span class="comment">/*</span>
01179 <span class="comment">     * No need to DeferWinEventNotify(), judging by xxxInitSendValidateMinMaxInfo below</span>
01180 <span class="comment">     */</span>
01181     <a class="code" href="../../d4/d1/userk_8h.html#a1788">zzzClipCursor</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>);
01182     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcSys, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>);
01183 
01184     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
01185 
01186         <span class="comment">/*</span>
01187 <span class="comment">         * No need to send WM_GETMINMAXINFO since we know the minimized size.</span>
01188 <span class="comment">         */</span>
01189         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o4">ptMinTrack</a>.x = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o5">ptMaxTrack</a>.x = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMINIMIZED);
01190         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o4">ptMinTrack</a>.y = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o5">ptMaxTrack</a>.y = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMINIMIZED);
01191 
01192     } <span class="keywordflow">else</span> {
01193         <a class="code" href="../../d4/d1/userk_8h.html#a1161">xxxInitSendValidateMinMaxInfo</a>(pwnd, &amp;mmi);
01194         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o4">ptMinTrack</a> = mmi.ptMinTrackSize;
01195         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o5">ptMaxTrack</a> = mmi.ptMaxTrackSize;
01196     }
01197 
01198     <span class="comment">/*</span>
01199 <span class="comment">     * Set up the drag rectangle.</span>
01200 <span class="comment">     */</span>
01201     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a>);
01202     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o2">rcDragCursor</a>, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>);
01203 
01204     ptStart.x = <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(wptStart);
01205     ptStart.y = <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(wptStart);
01206 
01207     <span class="comment">/*</span>
01208 <span class="comment">     * Assume Move/Size from mouse.</span>
01209 <span class="comment">     */</span>
01210     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01211     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o14">fmsKbd</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01212 
01213     <span class="comment">/*</span>
01214 <span class="comment">     * Get the mouse position for this move/size command.</span>
01215 <span class="comment">     */</span>
01216     <span class="keywordflow">switch</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> = cmdMove) {
01217     <span class="keywordflow">case</span> WMSZ_KEYMOVE:
01218         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> = cmdMove = WMSZ_MOVE;
01219 
01220         <span class="comment">/*</span>
01221 <span class="comment">         ** FALL THRU **</span>
01222 <span class="comment">         */</span>
01223 
01224     <span class="keywordflow">case</span> WMSZ_KEYSIZE:
01225         <span class="comment">/*</span>
01226 <span class="comment">         * No need to DeferWinEventNotify() - pmsd won't go away, and pwnd is locked</span>
01227 <span class="comment">         */</span>
01228         <a class="code" href="../../d4/d1/userk_8h.html#a1785">zzzSetCursor</a>(<a class="code" href="../../d4/d1/userk_8h.html#a321">SYSCUR</a>(SIZEALL));
01229 
01230         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01231             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01232 
01233         <span class="comment">/*</span>
01234 <span class="comment">         * Workaround: always behave as if the command is</span>
01235 <span class="comment">         * issued using keyboard.</span>
01236 <span class="comment">         * if it's found as the wrong way, the behavior is defined as:</span>
01237 <span class="comment">         * if (mnFocus == KEYBDHOLD) ||</span>
01238 <span class="comment">         *   ((mnFocus == MOUSEHOLD) &amp;&amp; TestWF(pwnd, WFMINIMIZED))) {</span>
01239 <span class="comment">         * In order to do this, mnFocus should be saved somewhere.</span>
01240 <span class="comment">         * originally, mnFocus was saved in MenuState.</span>
01241 <span class="comment">         */</span>
01242         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o14">fmsKbd</a>      = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01243         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o12">ptRestore</a>.x = <a class="code" href="../../d1/d0/inc_2user_8h.html#a4">LOSHORT</a>(wptStart);
01244         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o12">ptRestore</a>.y = <a class="code" href="../../d1/d0/inc_2user_8h.html#a5">HISHORT</a>(wptStart);
01245 
01246         <span class="comment">/*</span>
01247 <span class="comment">         * Center cursor in caption area of window</span>
01248 <span class="comment">         */</span>
01249 
01250         <span class="comment">/*</span>
01251 <span class="comment">         * Horizontally</span>
01252 <span class="comment">         */</span>
01253         ptStart.x = (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.left + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.right) / 2;
01254 
01255         <span class="comment">/*</span>
01256 <span class="comment">         * Vertically</span>
01257 <span class="comment">         */</span>
01258         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) || (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o9">cmd</a> != WMSZ_MOVE)) {
01259             ptStart.y = (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.bottom) / 2;
01260         } <span class="keywordflow">else</span> {
01261             <span class="keywordtype">int</span> dy;
01262 
01263             dy = <a class="code" href="../../d4/d1/userk_8h.html#a2017">GetCaptionHeight</a>(pwnd);
01264             ptStart.y = pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>.top + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYFIXEDFRAME) + dy / 2;
01265         }
01266 
01267         <a class="code" href="../../d4/d1/userk_8h.html#a1179">zzzInternalSetCursorPos</a>(ptStart.x, ptStart.y);
01268         <a class="code" href="../../d8/d3/movesize_8c.html#a15">xxxMS_FlushWigglies</a>();
01269         <span class="keywordflow">break</span>;
01270 
01271     <span class="keywordflow">default</span>:
01272         <span class="keywordflow">break</span>;
01273     }
01274 
01275     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o18">fDragFullWindows</a> = <a class="code" href="../../d4/d1/userk_8h.html#a658">TEST_BOOL_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a641">PUDF_DRAGFULLWINDOWS</a>);
01276     <a class="code" href="../../d4/d1/userk_8h.html#a661">SET_OR_CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a648">PUDF_DRAGGINGFULLWINDOW</a>, pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o18">fDragFullWindows</a>);
01277 
01278     <span class="comment">/*</span>
01279 <span class="comment">     * If we hit with the mouse, set up impx and impy so that we</span>
01280 <span class="comment">     * can use the keyboard too.</span>
01281 <span class="comment">     */</span>
01282     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o10">impx</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a7">rgcmdmpix</a>[cmdMove];
01283     pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o11">impy</a> = <a class="code" href="../../d8/d3/movesize_8c.html#a8">rgcmdmpiy</a>[cmdMove];
01284 
01285     <span class="comment">/*</span>
01286 <span class="comment">     * Setup dxMouse and dyMouse - If we're sizing with the keyboard these</span>
01287 <span class="comment">     * guys are set to zero down in the keyboard code.</span>
01288 <span class="comment">     */</span>
01289     <span class="keywordflow">if</span> ((i = <a class="code" href="../../d8/d3/movesize_8c.html#a5">rgimpiwx</a>[cmdMove]) != (-1))
01290         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a> = *((<span class="keywordtype">int</span> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a> + (<span class="keywordtype">short</span>)i) - ptStart.x;
01291 
01292     <span class="keywordflow">if</span> ((i = <a class="code" href="../../d8/d3/movesize_8c.html#a6">rgimpiwy</a>[cmdMove]) != (-1))
01293         pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a> = *((<span class="keywordtype">int</span> *)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o6">rcWindow</a> + (<span class="keywordtype">short</span>)i) - ptStart.y;
01294 
01295     <span class="comment">/*</span>
01296 <span class="comment">     * Tell Gdi the width of the drag rect (if its a special size)</span>
01297 <span class="comment">     * Turn the drag rect on.  0 specifies start drag.</span>
01298 <span class="comment">     */</span>
01299     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>))
01300         bSetDevDragWidth(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, 1);
01301 
01302     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
01303         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a>(EVENT_SYSTEM_MOVESIZESTART, pwnd, OBJID_WINDOW, INDEXID_CONTAINER, 0);
01304     }
01305 
01306     <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a359">DDR_START</a>);
01307     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>;
01308 
01309     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam = MAKELONG(ptStart.x, ptStart.y);
01310 
01311     <span class="comment">/*</span>
01312 <span class="comment">     * Right here win3.1 calls LockWindowUpdate(). This calls zzzSetFMouseMoved()</span>
01313 <span class="comment">     * which ensures that the next message in the queue is a mouse message.</span>
01314 <span class="comment">     * We need that mouse message as the first message because the first</span>
01315 <span class="comment">     * call to TrackInitSize() assumes that lParam is an x, y from a mouse</span>
01316 <span class="comment">     * message - scottlu.</span>
01317 <span class="comment">     */</span>
01318     <a class="code" href="../../d5/d3/ntuser_2kernel_2input_8c.html#a32">zzzSetFMouseMoved</a>();
01319 
01320     <span class="comment">/*</span>
01321 <span class="comment">     * Send this message for winoldapp support</span>
01322 <span class="comment">     */</span>
01323     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_ENTERSIZEMOVE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01324     <a class="code" href="../../d4/d1/userk_8h.html#a1516">xxxCapture</a>(ptiCurrent, pwnd, <a class="code" href="../../d4/d1/userk_8h.html#a468">CLIENT_CAPTURE_INTERNAL</a>);
01325 
01326     <span class="comment">/*</span>
01327 <span class="comment">     * Show the move cursor for non-mouse systems.</span>
01328 <span class="comment">     */</span>
01329     <a class="code" href="../../d4/d1/userk_8h.html#a1787">zzzShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01330 
01331     <span class="keywordflow">while</span> (!(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a>)) {
01332 
01333         <span class="comment">/*</span>
01334 <span class="comment">         * Let other messages not related to dragging be dispatched</span>
01335 <span class="comment">         * to the application window.</span>
01336 <span class="comment">         * In the case of clock, clock will now receive messages to</span>
01337 <span class="comment">         * update the time displayed instead of having the time display</span>
01338 <span class="comment">         * freeze while we are dragging.</span>
01339 <span class="comment">         */</span>
01340         <span class="keywordflow">while</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> == pwnd) {
01341 
01342             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a576">xxxPeekMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 0, PM_REMOVE)) {
01343 
01344                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message &gt;= WM_MOUSEFIRST &amp;&amp; <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message &lt;= WM_MOUSELAST)
01345                     || (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_QUEUESYNC)
01346                     || (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message &gt;= WM_KEYFIRST &amp;&amp; <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message &lt;= WM_KEYLAST)) {
01347 
01348                     <span class="keywordflow">break</span>;
01349                 }
01350 
01351                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1818">_CallMsgFilter</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, cmdMove == WMSZ_MOVE ? MSGF_MOVE : MSGF_SIZE)) {
01352                     <span class="keywordflow">continue</span>;
01353                 }
01354 
01355                 <a class="code" href="../../d4/d1/userk_8h.html#a1646">xxxTranslateMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, 0);
01356                 <span class="comment">/*</span>
01357 <span class="comment">                 * To prevent applications from doing</span>
01358 <span class="comment">                 * a PeekMessage loop and getting the mouse move messages that</span>
01359 <span class="comment">                 * are destined for the xxxMoveSize PeekMessage loop, we OR in</span>
01360 <span class="comment">                 * this flag. See comments in input.c for xxxInternalGetMessage.</span>
01361 <span class="comment">                 */</span>
01362                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>;
01363                 <a class="code" href="../../d4/d1/userk_8h.html#a1640">xxxDispatchMessage</a>(&amp;<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
01364                 ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>;
01365 
01366             } <span class="keywordflow">else</span> {
01367                 <span class="comment">/*</span>
01368 <span class="comment">                 * If we've been cancelled by someone else, or our pwnd</span>
01369 <span class="comment">                 * has been destroyed, blow out of here.</span>
01370 <span class="comment">                 */</span>
01371                 <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a>)
01372                     <span class="keywordflow">break</span>;
01373 
01374                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1634">xxxWaitMessage</a>())
01375                     <span class="keywordflow">break</span>;
01376             }
01377         }
01378 
01379         <span class="comment">/*</span>
01380 <span class="comment">         * If we've lost capture while tracking,</span>
01381 <span class="comment">         * cancel the move/size operation.</span>
01382 <span class="comment">         */</span>
01383         <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o6">spwndCapture</a> != pwnd) {
01384 
01385             <span class="comment">/*</span>
01386 <span class="comment">             * Fake a key-down of the escape key to cancel.</span>
01387 <span class="comment">             */</span>
01388             <a class="code" href="../../d8/d3/movesize_8c.html#a14">xxxMS_TrackMove</a>(pwnd, WM_KEYDOWN, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)VK_ESCAPE, 1, pmsd);
01389             <span class="keywordflow">goto</span> MoveSizeCleanup;
01390         }
01391 
01392         <span class="comment">/*</span>
01393 <span class="comment">         * If we've been cancelled by someone else, or our pwnd</span>
01394 <span class="comment">         * has been destroyed, blow out of here.</span>
01395 <span class="comment">         */</span>
01396         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a>) {
01397             pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01398             <span class="keywordflow">goto</span> MoveSizeCleanup;
01399         }
01400 
01401         <span class="comment">/*</span>
01402 <span class="comment">         * If we get a WM_QUEUESYNC, let the CBT hook know.</span>
01403 <span class="comment">         */</span>
01404         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message == WM_QUEUESYNC) {
01405             <a class="code" href="../../d4/d1/userk_8h.html#a1521">xxxCallHook</a>(HCBT_QS, 0, 0, WH_CBT);
01406         }
01407 
01408         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a>) {
01409             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/movesize_8c.html#a16">xxxTrackInitSize</a>(pwnd, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.lParam,
01410                     pmsd)) {
01411                 <span class="keywordflow">break</span>;
01412             }
01413         }
01414 
01415         <span class="comment">/*</span>
01416 <span class="comment">         * Convert captured mouse into screen coordinates.</span>
01417 <span class="comment">         */</span>
01418         x = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt.x + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o7">dxMouse</a>;
01419         y = <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.pt.y + pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o8">dyMouse</a>;
01420 
01421         <span class="comment">/*</span>
01422 <span class="comment">         * This is checked twice so the same message is not processed both</span>
01423 <span class="comment">         * places.</span>
01424 <span class="comment">         */</span>
01425         <span class="keywordflow">if</span> (!pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o13">fInitSize</a>) {
01426             <a class="code" href="../../d8/d3/movesize_8c.html#a14">xxxMS_TrackMove</a>(pwnd, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.message, <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>.wParam, MAKELONG(x, y),
01427                     pmsd);
01428         }
01429     }
01430 
01431 MoveSizeCleanup:
01432 
01433     <span class="comment">/*</span>
01434 <span class="comment">     * Reset priority if still in the foreground thread.</span>
01435 <span class="comment">     */</span>
01436 
01437     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a25">gptiForeground</a>) {
01438         <a class="code" href="../../d4/d1/userk_8h.html#a1334">SetForegroundPriority</a>(ptiCurrent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01439     }
01440 
01441     <span class="comment">/*</span>
01442 <span class="comment">     * Reset the border size if it was abnormal</span>
01443 <span class="comment">     */</span>
01444 
01445     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>))
01446         bSetDevDragWidth(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder + <a class="code" href="../../d4/d1/userk_8h.html#a740">BORDER_EXTRA</a>);
01447 
01448     <span class="comment">/*</span>
01449 <span class="comment">     * Revalidation: If pwnd is deleted unexpectedly, jump here to cleanup.</span>
01450 <span class="comment">     */</span>
01451 
01452     bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01453     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>);
01454 
01455     <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o18">fDragFullWindows</a>) {
01456         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457             GreDeleteObject(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a>);
01458             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a9">ghrgnUpdateSave</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01459             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a10">gnUpdateSave</a> = 0;
01460         }
01461     }
01462 
01463     <a class="code" href="../../d4/d1/userk_8h.html#a660">CLEAR_PUDF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a648">PUDF_DRAGGINGFULLWINDOW</a>);
01464 
01465     ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01466 
01467     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>);
01468 
01469 
01470     <a class="code" href="../../d4/d1/userk_8h.html#a1787">zzzShowCursor</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01471 
01472     <span class="comment">/*</span>
01473 <span class="comment">     * Free the move/size data structure</span>
01474 <span class="comment">     */</span>
01475     UserFreePool(pmsd);
01476 }
01477 
01478 <span class="comment">/***************************************************************************\</span>
01479 <span class="comment">* This calls xxxRedrawHungWindow() on windows that do not belong to this thread.</span>
01480 <span class="comment">*</span>
01481 <span class="comment">* History:</span>
01482 <span class="comment">* 27-May-1994 johannec</span>
01483 <span class="comment">\***************************************************************************/</span>
01484 
<a name="l01485"></a><a class="code" href="../../d8/d3/movesize_8c.html#a18">01485</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/movesize_8c.html#a18">xxxUpdateOtherThreadsWindows</a>(
01486     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01487     HRGN hrgnFullDrag)
01488 {
01489     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwndChild;
01490     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwndChild;
01491     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01492 
01493     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01494 
01495     <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwnd, hrgnFullDrag);
01496 
01497     <span class="comment">/*</span>
01498 <span class="comment">     * If the parent window does not have the flag WFCLIPCHILDREN set,</span>
01499 <span class="comment">     * there is no need to redraw its children.</span>
01500 <span class="comment">     */</span>
01501     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
01502         <span class="keywordflow">return</span>;
01503 
01504     pwndChild = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01505     <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwndChild);
01506     <span class="keywordflow">while</span> (pwndChild != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01507         <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwndChild, &amp;tlpwndChild);
01508         <a class="code" href="../../d8/d3/movesize_8c.html#a18">xxxUpdateOtherThreadsWindows</a>(pwndChild, hrgnFullDrag);
01509         pwndChild = pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01510     }
01511 
01512     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndChild);
01513 }
01514 
01515 <span class="comment">/***************************************************************************\</span>
01516 <span class="comment">* This calls UpdateWindow() on every window that is owned by this thread</span>
01517 <span class="comment">* and calls xxxRedrawHungWindow() for windows owned by other threads.</span>
01518 <span class="comment">*</span>
01519 <span class="comment">* History:</span>
01520 <span class="comment">* 28-Sep-1993 mikeke   Created</span>
01521 <span class="comment">\***************************************************************************/</span>
01522 
<a name="l01523"></a><a class="code" href="../../d4/d1/userk_8h.html#a1943">01523</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1943">xxxUpdateThreadsWindows</a>(
01524     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti,
01525     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd,
01526     HRGN        hrgnFullDrag)
01527 {
01528     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwnd;
01529 
01530     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01531 
01532     <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwnd);
01533     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01534         <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwnd, &amp;tlpwnd);
01535         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) == pti) {
01536             <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(pwnd);
01537         } <span class="keywordflow">else</span> {
01538             <a class="code" href="../../d8/d3/movesize_8c.html#a18">xxxUpdateOtherThreadsWindows</a>(pwnd, hrgnFullDrag);
01539         }
01540 
01541         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01542     }
01543 
01544     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01545 }
01546 
01547 <span class="comment">/***************************************************************************\</span>
01548 <span class="comment">* xxxDrawDragRect</span>
01549 <span class="comment">*</span>
01550 <span class="comment">* Draws the drag rect for sizing and moving windows.  When moving windows,</span>
01551 <span class="comment">* can move full windows including client area.  lprc new rect to move to.</span>
01552 <span class="comment">* if lprc is null, flags specify why.</span>
01553 <span class="comment">*</span>
01554 <span class="comment">* flags:  DDR_START     0 - start drag.</span>
01555 <span class="comment">*         DDR_ENDACCEPT 1 - end and accept</span>
01556 <span class="comment">*         DDR_ENDCANCEL 2 - end and cancel.</span>
01557 <span class="comment">*</span>
01558 <span class="comment">* History:</span>
01559 <span class="comment">* 07-29-91 darrinm      Ported from Win 3.1 sources.</span>
01560 <span class="comment">\***************************************************************************/</span>
01561 
<a name="l01562"></a><a class="code" href="../../d4/d1/userk_8h.html#a1331">01562</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(
01563     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsd,
01564     LPRECT        lprc,
01565     UINT          type)
01566 {
01567     HDC  hdc;
01568     <span class="keywordtype">int</span>  lvBorder;
01569     HRGN hrgnClip;
01570 
01571     <span class="comment">/*</span>
01572 <span class="comment">     * If we're dragging an icon, or we're not foreground, don't draw</span>
01573 <span class="comment">     * the dragging rect.</span>
01574 <span class="comment">     */</span>
01575     <span class="keywordflow">if</span> (!pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o17">fForeground</a>) {
01576 
01577         <span class="keywordflow">if</span> (lprc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01578             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, lprc);
01579 
01580         <span class="keywordflow">return</span>;
01581     }
01582 
01583     <span class="comment">/*</span>
01584 <span class="comment">     * If it already equals, just return.</span>
01585 <span class="comment">     */</span>
01586     <span class="keywordflow">if</span> ((lprc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, lprc))
01587         <span class="keywordflow">return</span>;
01588 
01589     <span class="keywordflow">if</span> (!(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o18">fDragFullWindows</a>)) {
01590 
01591         <span class="comment">/*</span>
01592 <span class="comment">         * If we were not able to lock the screen (because some other process</span>
01593 <span class="comment">         * or thread had the screen locked), then get a dc but make sure</span>
01594 <span class="comment">         * it is totally clipped to nothing.</span>
01595 <span class="comment">         * NO longer a posibility</span>
01596 <span class="comment">         */</span>
01597 
01598         <span class="comment">/*</span>
01599 <span class="comment">         * Clip to client rect of parent.  (Client given in screen coords.)</span>
01600 <span class="comment">         */</span>
01601         hrgnClip = GreCreateRectRgnIndirect(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>);
01602 
01603         <span class="comment">/*</span>
01604 <span class="comment">         * Clip to the parent's window clipping rgn if it has one.</span>
01605 <span class="comment">         */</span>
01606         <span class="keywordflow">if</span> (hrgnClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01607             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnClip,
01608                          hrgnClip,
01609                          pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
01610 
01611         <span class="keywordflow">if</span> (hrgnClip == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01612             hrgnClip = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
01613 
01614         <span class="comment">/*</span>
01615 <span class="comment">         * If lprc == NULL, just draw rcDrag once.  If lprc != NULL,</span>
01616 <span class="comment">         * undraw *lprc, draw rcDrag, copy in *lprc.</span>
01617 <span class="comment">         */</span>
01618 
01619         <span class="comment">/*</span>
01620 <span class="comment">         * Use size 1 for minimized or non-sizeable windows.  Otherwise</span>
01621 <span class="comment">         * use the # of borders (2 for outer edge, 1 for border, clBorder for</span>
01622 <span class="comment">         * size border.</span>
01623 <span class="comment">         */</span>
01624         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a638">WFSIZEBOX</a>))
01625             lvBorder = 1;
01626         <span class="keywordflow">else</span>
01627             lvBorder = 3 + <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;gclBorder;
01628 
01629         <span class="comment">/*</span>
01630 <span class="comment">         * Get a screen DC clipped to the parent, select in a gray brush.</span>
01631 <span class="comment">         */</span>
01632         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(
01633                 <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>),
01634                 hrgnClip,
01635                 DCX_WINDOW | DCX_CACHE | DCX_INTERSECTRGN | DCX_LOCKWINDOWUPDATE);
01636 
01637         <span class="keywordflow">if</span> (lprc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01638 
01639             <span class="comment">/*</span>
01640 <span class="comment">             * Move the frame to a new location by delta drawing</span>
01641 <span class="comment">             */</span>
01642             GreLockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01643             bMoveDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, (PRECTL) lprc);
01644             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>, lprc);
01645             GreUnlockDisplay(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>);
01646 
01647         } <span class="keywordflow">else</span> {
01648 
01649             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> == <a class="code" href="../../d4/d1/userk_8h.html#a359">DDR_START</a>) {
01650                 bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>,
01651                                 (PRECTL)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>,
01652                                 (PRECTL)&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o3">rcParent</a>);
01653             }
01654         }
01655 
01656         <span class="comment">/*</span>
01657 <span class="comment">         * Release the DC &amp; delete hrgnClip</span>
01658 <span class="comment">         */</span>
01659         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
01660 
01661     } <span class="keywordflow">else</span> {
01662 
01663         RECT        rcSWP;
01664         HRGN        hrgnFullDragNew;
01665         HRGN        hrgnFullDragOld;
01666         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCancel = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>);
01667         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01668         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>        pwnd;
01669         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlpwnd;
01670 
01671 <span class="preprocessor">#if DBG</span>
01672 <span class="preprocessor"></span>        <span class="comment">/*</span>
01673 <span class="comment">         * If ptiCancel != ptiCurrent, we must have come from xxxCancelTracking,</span>
01674 <span class="comment">         * which has already locked ptiCancel.</span>
01675 <span class="comment">         */</span>
01676         <span class="keywordflow">if</span> (ptiCancel != ptiCurrent) {
01677             <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(ptiCancel);
01678         }
01679 <span class="preprocessor">#endif</span>
01680 <span class="preprocessor"></span>
01681         <span class="comment">/*</span>
01682 <span class="comment">         * To prevent applications (like Micrografx Draw) from doing</span>
01683 <span class="comment">         * a PeekMessage loop and getting the mouse move messages that</span>
01684 <span class="comment">         * are destined for the xxxMoveSize PeekMessage loop, we OR in</span>
01685 <span class="comment">         * this flag. See comments in input.c for xxxInternalGetMessage.</span>
01686 <span class="comment">         */</span>
01687         ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>;
01688 
01689         <span class="keywordflow">if</span> (lprc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01690             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>), lprc);
01691 
01692         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcSWP, &amp;(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o1">rcDrag</a>));
01693 
01694         <span class="comment">/*</span>
01695 <span class="comment">         * Convert coordinates to client if the window is a child window or</span>
01696 <span class="comment">         * if it's a popup-with parent.  The test for the popup is necessary</span>
01697 <span class="comment">         * to solve a problem where a popup was assigned a parent of a MDI-</span>
01698 <span class="comment">         * CLIENT window.</span>
01699 <span class="comment">         */</span>
01700         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a596">FTopLevel</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>)) {
01701             <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, (LPPOINT)&amp;rcSWP);
01702             <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a21">_ScreenToClient</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, ((LPPOINT)&amp;rcSWP)+1);
01703 
01704 <span class="preprocessor">#if defined(USE_MIRRORING)</span>
01705 <span class="preprocessor"></span>            <span class="comment">//</span>
01706             <span class="comment">// If the parent of this window is mirrored, then mirror the</span>
01707             <span class="comment">// rectangle coordinates so that child MDI windows work</span>
01708             <span class="comment">// properly</span>
01709             <span class="comment">//</span>
01710             <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>,WEFLAYOUTRTL) )
01711             {
01712               <span class="keywordtype">int</span> iLeft   = rcSWP.left;
01713               rcSWP.left  = rcSWP.right;
01714               rcSWP.right = iLeft;
01715             }
01716 <span class="preprocessor">#endif</span>
01717 <span class="preprocessor"></span>        }
01718 
01719         <span class="comment">/*</span>
01720 <span class="comment">         * Don't bother being optimal here.  There's one case where we</span>
01721 <span class="comment">         * really shouldn't blow away the SPB--the window is being sized</span>
01722 <span class="comment">         * bigger.  We do want to do this when moving or sizing the window</span>
01723 <span class="comment">         * smaller.  Why bother detecting the first case?</span>
01724 <span class="comment">         */</span>
01725         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a558">WFHASSPB</a>)){
01726 
01727             <a class="code" href="../../d0/d7/structtagSPB.html">PSPB</a> pspb;
01728             RECT rc;
01729 
01730             <span class="comment">/*</span>
01731 <span class="comment">             * If we're intersecting the original window rect and the window</span>
01732 <span class="comment">             * has an SPB saved onboard, then just free it.  Otherwise the</span>
01733 <span class="comment">             * window will move, the entire SPB will blt over it, we'll</span>
01734 <span class="comment">             * invalidate the intersection, and the window will repaint,</span>
01735 <span class="comment">             * causing mad flicker.</span>
01736 <span class="comment">             */</span>
01737             pspb = <a class="code" href="../../d4/d1/userk_8h.html#a1765">FindSpb</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>);
01738 
01739             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01740             <span class="keywordflow">if</span> (lprc &amp;&amp; <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, lprc)){
01741                 <a class="code" href="../../d4/d1/userk_8h.html#a1766">FreeSpb</a>(pspb);
01742             }
01743         }
01744 
01745         hrgnFullDragOld = GreCreateRectRgnIndirect(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01746 
01747         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01748             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnFullDragOld,
01749                          hrgnFullDragOld,
01750                          pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
01751 
01752         <a class="code" href="../../d4/d1/userk_8h.html#a1615">xxxSetWindowPos</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>,
01753                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01754                         rcSWP.left, rcSWP.top,
01755                         rcSWP.right-rcSWP.left, rcSWP.bottom-rcSWP.top,
01756                         SWP_NOACTIVATE | SWP_NOZORDER | SWP_NOOWNERZORDER);
01757 
01758         <span class="comment">/*</span>
01759 <span class="comment">         * We locked ptiCancel, so ptiCancel-&gt;pmsd has not been unexpectedly</span>
01760 <span class="comment">         * freed in DeleteThreadInfo(), but xxxMoveSize() may have terminated</span>
01761 <span class="comment">         * during our callback to xxxSetWindowPos and freed the pmsd there.</span>
01762 <span class="comment">         */</span>
01763         <span class="keywordflow">if</span> (ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != pmsd) {
01764             RIPMSG3(RIP_ERROR,
01765                     <span class="stringliteral">"xxxDrawDragRect: ptiCancel(%#p)-&gt;pmsd(%#p) != pmsd(%#p)\n"</span>,
01766                     ptiCancel, ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>, pmsd);
01767             <span class="keywordflow">goto</span> CleanupAfterPmsdDisappearance;
01768         }
01769         hrgnFullDragNew = GreCreateRectRgnIndirect(&amp;pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
01770 
01771         <span class="keywordflow">if</span> (pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01772             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnFullDragNew,
01773                          hrgnFullDragNew,
01774                          pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
01775         }
01776 
01777         <span class="comment">/*</span>
01778 <span class="comment">         * Set the full drag update region that is used in xxxRedrawHungWindow.</span>
01779 <span class="comment">         */</span>
01780         <span class="keywordflow">if</span> (hrgnFullDragNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01781 
01782             <span class="comment">/*</span>
01783 <span class="comment">             * We couldn't create the new full drag region so don't</span>
01784 <span class="comment">             * use the full drag region to xxxRedrawHungWindow. Using</span>
01785 <span class="comment">             * NULL with force a redraw of the entire window's hrgnUpdate.</span>
01786 <span class="comment">             * (which is what we used to do, overdrawing but at least</span>
01787 <span class="comment">             * covering the invalidated areas).</span>
01788 <span class="comment">             */</span>
01789             <span class="keywordflow">if</span> (hrgnFullDragOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01790                 GreDeleteObject(hrgnFullDragOld);
01791                 hrgnFullDragOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01792             }
01793 
01794         } <span class="keywordflow">else</span> {
01795 
01796             <span class="keywordflow">if</span> (hrgnFullDragOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01797 
01798                 <span class="comment">/*</span>
01799 <span class="comment">                 * Subtract the new window rect from the old window rect</span>
01800 <span class="comment">                 * to create the update region caused by the drag.</span>
01801 <span class="comment">                 */</span>
01802                 <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnFullDragOld, hrgnFullDragOld, hrgnFullDragNew);
01803             }
01804         }
01805 
01806         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pmsd-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>)-&gt;spwndChild;
01807         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
01808         <a class="code" href="../../d4/d1/userk_8h.html#a1943">xxxUpdateThreadsWindows</a>(ptiCurrent, pwnd, hrgnFullDragOld);
01809         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01810 
01811         GreDeleteObject(hrgnFullDragNew);
01812 
01813 CleanupAfterPmsdDisappearance:
01814         GreDeleteObject(hrgnFullDragOld);
01815 
01816         ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a809">TIF_MOVESIZETRACKING</a>;
01817     }
01818 }
01819 
01820 <span class="comment">/***************************************************************************\</span>
01821 <span class="comment">* xxxCancelTrackingForThread</span>
01822 <span class="comment">*</span>
01823 <span class="comment">*</span>
01824 <span class="comment">\***************************************************************************/</span>
01825 
<a name="l01826"></a><a class="code" href="../../d4/d1/userk_8h.html#a1515">01826</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1515">xxxCancelTrackingForThread</a>(
01827     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCancel)
01828 {
01829     <a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html">PMOVESIZEDATA</a> pmsdCancel;
01830 
01831     UserAssert(ptiCancel);
01832 
01833     <span class="comment">/*</span>
01834 <span class="comment">     * If this thread isn't around any more, skip it.</span>
01835 <span class="comment">     */</span>
01836     <span class="keywordflow">if</span> (ptiCancel == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01837         <span class="keywordflow">return</span>;
01838 
01839     <span class="keywordflow">if</span> ((pmsdCancel = ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01840 
01841         <span class="comment">/*</span>
01842 <span class="comment">         * Found one, now stop tracking.</span>
01843 <span class="comment">         */</span>
01844         pmsdCancel-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o16">fTrackCancelled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01845 
01846         <span class="comment">/*</span>
01847 <span class="comment">         * Only remove the tracking rectangle if it's</span>
01848 <span class="comment">         * been made visible.</span>
01849 <span class="comment">         */</span>
01850         <span class="keywordflow">if</span> (ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>) {
01851             bSetDevDragRect(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o0">hDev</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01852             <span class="keywordflow">if</span> (!(pmsdCancel-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o18">fDragFullWindows</a>)) {
01853                 <a class="code" href="../../d4/d1/userk_8h.html#a1331">xxxDrawDragRect</a>(pmsdCancel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a361">DDR_ENDCANCEL</a>);
01854             }
01855         }
01856 
01857         <span class="comment">/*</span>
01858 <span class="comment">         * Leave TIF_TRACKING set to prevent xxxMoveSize()</span>
01859 <span class="comment">         * recursion.</span>
01860 <span class="comment">         */</span>
01861         ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a799">TIF_TRACKRECTVISIBLE</a>;
01862         <span class="keywordflow">if</span> (ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>) {
01863             <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptiCancel, QS_MOUSEMOVE);
01864         }
01865 
01866         <span class="comment">/*</span>
01867 <span class="comment">         * If the tracking window is still in menuloop, send the</span>
01868 <span class="comment">         * WM_CANCELMODE message so that it can exit the menu.</span>
01869 <span class="comment">         * This fixes the bug where we have 2 icons with their</span>
01870 <span class="comment">         * system menu up.</span>
01871 <span class="comment">         * 8/5/94 johannec</span>
01872 <span class="comment">         */</span>
01873         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1322">IsInsideMenuLoop</a>(ptiCancel) &amp;&amp; ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>)
01874             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(ptiCancel-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>, WM_CANCELMODE, 0, 0);
01875 
01876         <span class="comment">/*</span>
01877 <span class="comment">         * Turn off capture</span>
01878 <span class="comment">         */</span>
01879         <a class="code" href="../../d4/d1/userk_8h.html#a1516">xxxCapture</a>(ptiCancel, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d1/userk_8h.html#a462">NO_CAP_CLIENT</a>);
01880     }
01881 }
01882 
01883 <span class="comment">/***************************************************************************\</span>
01884 <span class="comment">* xxxCancelTracking</span>
01885 <span class="comment">*</span>
01886 <span class="comment">*</span>
01887 <span class="comment">\***************************************************************************/</span>
01888 
<a name="l01889"></a><a class="code" href="../../d8/d3/movesize_8c.html#a3">01889</a> <span class="preprocessor">#define MAX_THREADS 12</span>
01890 <span class="preprocessor"></span>
<a name="l01891"></a><a class="code" href="../../d4/d1/userk_8h.html#a1514">01891</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1514">xxxCancelTracking</a>(VOID)
01892 {
01893     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01894     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiList[<a class="code" href="../../d8/d3/movesize_8c.html#a3">MAX_THREADS</a>];
01895     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlptiList[<a class="code" href="../../d8/d3/movesize_8c.html#a3">MAX_THREADS</a>];
01896     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>          tlspwndList[<a class="code" href="../../d8/d3/movesize_8c.html#a3">MAX_THREADS</a>];
01897     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>        cThreads = 0;
01898     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>         i;
01899     PLIST_ENTRY pHead;
01900     PLIST_ENTRY pEntry;
01901     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
01902 
01903     <span class="comment">/*</span>
01904 <span class="comment">     * Build a list of threads that we need to look at. We can't just</span>
01905 <span class="comment">     * walk the pointer list while we're doing the work, because we</span>
01906 <span class="comment">     * might leave the critical section and the pointer could get</span>
01907 <span class="comment">     * deleted out from under us.</span>
01908 <span class="comment">     */</span>
01909     pHead = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
01910     <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
01911 
01912         pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
01913 
01914         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01915 
01916             UserAssert(cThreads &lt; <a class="code" href="../../d8/d3/movesize_8c.html#a3">MAX_THREADS</a>);
01917 
01918             <span class="keywordflow">if</span> (cThreads &lt; <a class="code" href="../../d8/d3/movesize_8c.html#a3">MAX_THREADS</a>) {
01919                 <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, pti, &amp;tlptiList[cThreads]);
01920                 <a class="code" href="../../d6/d0/usercli_8h.html#a39">ThreadLockAlwaysWithPti</a>(ptiCurrent, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o30">pmsd</a>-&gt;<a class="code" href="../../d4/d9/struct__MOVESIZEDATA.html#o0">spwnd</a>, &amp;tlspwndList[cThreads]);
01921                 ptiList[cThreads++] = pti;
01922             }
01923         }
01924     }
01925 
01926     <span class="comment">/*</span>
01927 <span class="comment">     * Walk the list backwards so the unlocks will be done in the right order.</span>
01928 <span class="comment">     */</span>
01929     <span class="keywordflow">for</span> (i = cThreads - 1; i &gt;= 0; i--) {
01930         <span class="keywordflow">if</span> (!(ptiList[i]-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
01931             <a class="code" href="../../d4/d1/userk_8h.html#a1515">xxxCancelTrackingForThread</a>(ptiList[i]);
01932         }
01933 
01934         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlspwndList[i]);
01935         <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlptiList[i]);
01936     }
01937 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
