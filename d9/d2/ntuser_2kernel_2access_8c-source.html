<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: access.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>access.c</h1><a href="../../d8/d3/ntuser_2kernel_2access_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: access.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the Access Pack functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">00015</a> CONST <a class="code" href="../../d9/d3/access_8h.html#a39">ACCESSIBILITYPROC</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>[] = {
00016     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a35">HighContrastHotKey</a>,
00017     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>,
00018     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a18">xxxStickyKeys</a>,
00019     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>,
00020     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>,
00021     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a47">UtilityManager</a>
00022 };
00023 
<a name="l00024"></a><a class="code" href="../../d9/d1/structtagMODBITINFO.html">00024</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d1/structtagMODBITINFO.html">tagMODBITINFO</a> {
<a name="l00025"></a><a class="code" href="../../d9/d1/structtagMODBITINFO.html#o0">00025</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d1/structtagMODBITINFO.html#o0">BitPosition</a>;
<a name="l00026"></a><a class="code" href="../../d9/d1/structtagMODBITINFO.html#o1">00026</a>     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> <a class="code" href="../../d9/d1/structtagMODBITINFO.html#o1">ScanCode</a>;
<a name="l00027"></a><a class="code" href="../../d9/d1/structtagMODBITINFO.html#o2">00027</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d9/d1/structtagMODBITINFO.html#o2">Vk</a>;
00028 } <a class="code" href="../../d9/d1/structtagMODBITINFO.html">MODBITINFO</a>, *<a class="code" href="../../d9/d1/structtagMODBITINFO.html">PMODBITINFO</a>;
00029 
<a name="l00030"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">00030</a> CONST <a class="code" href="../../d9/d1/structtagMODBITINFO.html">MODBITINFO</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>[] =
00031 {
00032     { 0x01, SCANCODE_LSHIFT, VK_LSHIFT },
00033     { 0x02, SCANCODE_RSHIFT, VK_RSHIFT | KBDEXT },
00034     { 0x04, SCANCODE_CTRL, VK_LCONTROL },
00035     { 0x08, SCANCODE_CTRL, VK_RCONTROL | KBDEXT },
00036     { 0x10, SCANCODE_ALT, VK_LMENU },
00037     { 0x20, SCANCODE_ALT, VK_RMENU | KBDEXT },
00038     { 0x40, SCANCODE_LWIN, VK_LWIN },
00039     { 0x80, SCANCODE_RWIN,    VK_RWIN | KBDEXT}
00040 };
00041 
00042 <span class="comment">/*</span>
00043 <span class="comment"> * The ausMouseVKey array provides a translation from the virtual key</span>
00044 <span class="comment"> * value to an index.  The index is used to select the appropriate</span>
00045 <span class="comment"> * routine to process the virtual key, as well as to select extra</span>
00046 <span class="comment"> * information that is used by this routine during its processing.</span>
00047 <span class="comment"> */</span>
<a name="l00048"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a4">00048</a> CONST <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a4">ausMouseVKey</a>[] = {
00049                        VK_CLEAR,
00050                        VK_PRIOR,
00051                        VK_NEXT,
00052                        VK_END,
00053                        VK_HOME,
00054                        VK_LEFT,
00055                        VK_UP,
00056                        VK_RIGHT,
00057                        VK_DOWN,
00058                        VK_INSERT,
00059                        VK_DELETE,
00060                        VK_MULTIPLY,
00061                        VK_ADD,
00062                        VK_SUBTRACT,
00063                        VK_DIVIDE | KBDEXT,
00064                        VK_NUMLOCK | KBDEXT
00065                       };
00066 
<a name="l00067"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a5">00067</a> CONST <span class="keywordtype">int</span> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a5">cMouseVKeys</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a4">ausMouseVKey</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a4">ausMouseVKey</a>[0]);
00068 
00069 <span class="comment">/*</span>
00070 <span class="comment"> * aMouseKeyEvent is an array of function pointers.  The routine to call</span>
00071 <span class="comment"> * is selected using the index created by scanning the ausMouseVKey array.</span>
00072 <span class="comment"> */</span>
<a name="l00073"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a6">00073</a> CONST <a class="code" href="../../d9/d3/access_8h.html#a41">MOUSEPROC</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a6">aMouseKeyEvent</a>[] = {
00074     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a28">xxxMKButtonClick</a>,      <span class="comment">// Numpad 5 (Clear)</span>
00075     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 9 (PgUp)</span>
00076     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 3 (PgDn)</span>
00077     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 1 (End)</span>
00078     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 7 (Home)</span>
00079     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 4 (Left)</span>
00080     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 8 (Up)</span>
00081     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 6 (Right)</span>
00082     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a31">xxxMKMouseMove</a>,        <span class="comment">// Numpad 2 (Down)</span>
00083     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a32">xxxMKButtonSetState</a>,   <span class="comment">// Numpad 0 (Ins)</span>
00084     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a32">xxxMKButtonSetState</a>,   <span class="comment">// Numpad . (Del)</span>
00085     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a33">MKButtonSelect</a>,        <span class="comment">// Numpad * (Multiply)</span>
00086     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a34">xxxMKButtonDoubleClick</a>,<span class="comment">// Numpad + (Add)</span>
00087     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a33">MKButtonSelect</a>,        <span class="comment">// Numpad - (Subtract)</span>
00088     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a33">MKButtonSelect</a>,        <span class="comment">// Numpad / (Divide)</span>
00089     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a27">xxxMKToggleMouseKeys</a>   <span class="comment">// Num Lock</span>
00090 };
00091 
00092 <span class="comment">/*</span>
00093 <span class="comment"> * ausMouseKeyData contains useful data for the routines that process</span>
00094 <span class="comment"> * the virtual mousekeys.  This array is indexed using the index created</span>
00095 <span class="comment"> * by scanning the ausMouseVKey array.</span>
00096 <span class="comment"> */</span>
<a name="l00097"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a7">00097</a> CONST <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a7">ausMouseKeyData</a>[] = {
00098     0,                     <span class="comment">// Numpad 5: Click active button</span>
00099     <a class="code" href="../../d9/d3/access_8h.html#a32">MK_UP</a> | <a class="code" href="../../d9/d3/access_8h.html#a34">MK_RIGHT</a>,      <span class="comment">// Numpad 9: Up &amp; Right</span>
00100     <a class="code" href="../../d9/d3/access_8h.html#a33">MK_DOWN</a> | <a class="code" href="../../d9/d3/access_8h.html#a34">MK_RIGHT</a>,    <span class="comment">// Numpad 3: Down &amp; Right</span>
00101     <a class="code" href="../../d9/d3/access_8h.html#a33">MK_DOWN</a> | <a class="code" href="../../d9/d3/access_8h.html#a35">MK_LEFT</a>,     <span class="comment">// Numpad 1: Down &amp; Left</span>
00102     <a class="code" href="../../d9/d3/access_8h.html#a32">MK_UP</a> | <a class="code" href="../../d9/d3/access_8h.html#a35">MK_LEFT</a>,       <span class="comment">// Numpad 7: Up &amp; Left</span>
00103     <a class="code" href="../../d9/d3/access_8h.html#a35">MK_LEFT</a>,               <span class="comment">// Numpad 4: Left</span>
00104     <a class="code" href="../../d9/d3/access_8h.html#a32">MK_UP</a>,                 <span class="comment">// Numpad 8: Up</span>
00105     <a class="code" href="../../d9/d3/access_8h.html#a34">MK_RIGHT</a>,              <span class="comment">// Numpad 6: Right</span>
00106     <a class="code" href="../../d9/d3/access_8h.html#a33">MK_DOWN</a>,               <span class="comment">// Numpad 2: Down</span>
00107     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                 <span class="comment">// Numpad 0: Active button down</span>
00108     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                  <span class="comment">// Numpad .: Active button up</span>
00109     <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> | <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>,   <span class="comment">// Numpad *: Select both buttons</span>
00110     0,                     <span class="comment">// Numpad +: Double click active button</span>
00111     <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>,    <span class="comment">// Numpad -: Select right button</span>
00112     <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>,     <span class="comment">// Numpad /: Select left button</span>
00113     0
00114 };
00115 
00116 __inline <span class="keywordtype">void</span>
<a name="l00117"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">00117</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(UINT accessKeyType)
00118 {
00119     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00120     {
00121         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a78">glinp</a>.<a class="code" href="../../d5/d9/structtagLASTINPUT.html#o2">ptiLastWoken</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>);
00122 
00123         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
00124                  LOGON_ACCESSNOTIFY, accessKeyType);
00125     }
00126 }
00127 
<a name="l00128"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">00128</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(<a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm, UINT message) {
00129     <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(
00130                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>,
00131                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>,
00132                     <a class="code" href="../../d4/d1/userk_8h.html#a349">QEVENT_RITSOUND</a>,
00133                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00134                     message, 0, 0);
00135     <span class="keywordflow">return</span>;
00136 }
00137 
<a name="l00138"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">00138</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( LPARAM lParam )
00139 {
00140     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00141 
00142     <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(
00143             pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>,
00144             pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o3">pqDesktop</a>,
00145             <a class="code" href="../../d4/d1/userk_8h.html#a348">QEVENT_RITACCESSIBILITY</a>,
00146             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00147             0, HSHELL_ACCESSIBILITYSTATE, lParam);
00148 }
00149 
00150 <span class="comment">/***************************************************************************\</span>
00151 <span class="comment">* AccessProceduresStream</span>
00152 <span class="comment">*</span>
00153 <span class="comment">* This function controls the order in which the access functions are called.</span>
00154 <span class="comment">* All key events pass through this routine.  If an access function returns</span>
00155 <span class="comment">* FALSE then none of the other access functions in the stream are called.</span>
00156 <span class="comment">* This routine is called initially from KeyboardApcProcedure(), but then</span>
00157 <span class="comment">* can be called any number of times by the access functions as they process</span>
00158 <span class="comment">* the current key event or add more key events.</span>
00159 <span class="comment">*</span>
00160 <span class="comment">* Return value:</span>
00161 <span class="comment">*   TRUE    All access functions returned TRUE, the key event can be</span>
00162 <span class="comment">*           processed.</span>
00163 <span class="comment">*   FALSE   An access function returned FALSE, the key event should be</span>
00164 <span class="comment">*           discarded.</span>
00165 <span class="comment">*</span>
00166 <span class="comment">* History:</span>
00167 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00168 <span class="comment">\***************************************************************************/</span>
<a name="l00169"></a><a class="code" href="../../d9/d3/access_8h.html#a48">00169</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> dwProcIndex)
00170 {
00171     <span class="keywordtype">int</span> index;
00172 
00173     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00174     <span class="keywordflow">for</span> (index = dwProcIndex; index &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>); index++) {
00175         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>[index](pKeyEvent, ExtraInformation, index+1)) {
00176             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00177         }
00178     }
00179 
00180     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00181 }
00182 
00183 
00184 <span class="comment">/***************************************************************************\</span>
00185 <span class="comment">* FKActivationTimer</span>
00186 <span class="comment">*</span>
00187 <span class="comment">* If the hot key (right shift key) is held down this routine is called after</span>
00188 <span class="comment">* 4, 8, 12 and 16 seconds.  This routine is only called at the 12 and 16</span>
00189 <span class="comment">* second time points if we're in the process of enabling FilterKeys.  If at</span>
00190 <span class="comment">* 8 seconds FilterKeys is disabled then this routine will not be called again</span>
00191 <span class="comment">* until the hot key is released and then pressed.</span>
00192 <span class="comment">*</span>
00193 <span class="comment">* This routine is called with the critical section already locked.</span>
00194 <span class="comment">*</span>
00195 <span class="comment">* Return value:</span>
00196 <span class="comment">*    0</span>
00197 <span class="comment">*</span>
00198 <span class="comment">* History:</span>
00199 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00200 <span class="comment">\***************************************************************************/</span>
<a name="l00201"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a12">00201</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a12">FKActivationTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
00202 {
00203     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> TimerDelta;
00204     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00205 
00206     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00207 
00208     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a>) {
00209 
00210     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a13">FKFIRSTWARNING</a>:
00211         <span class="comment">//</span>
00212         <span class="comment">// The audible feedback cannot be disabled for this warning.</span>
00213         <span class="comment">//</span>
00214         <span class="comment">/*PostEventMessage(</span>
00215 <span class="comment">                    pTerm-&gt;ptiDesktop,</span>
00216 <span class="comment">                    pTerm-&gt;ptiDesktop-&gt;pq,</span>
00217 <span class="comment">                    QEVENT_RITSOUND,</span>
00218 <span class="comment">                    NULL,</span>
00219 <span class="comment">                    RITSOUND_DOBEEP, RITSOUND_HIGHBEEP, 3);*/</span>
00220         TimerDelta = <a class="code" href="../../d9/d3/access_8h.html#a9">FKACTIVATIONDELTA</a>;
00221         <span class="keywordflow">break</span>;
00222 
00223     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a14">FKTOGGLE</a>:
00224         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON)) {
00225             <span class="comment">//</span>
00226             <span class="comment">// Disable Filter Keys</span>
00227             <span class="comment">//</span>
00228             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON);
00229             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYSOUND)) {
00230                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00231                     pTerm,
00232                     <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
00233             }
00234             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_FILTERKEYS );
00235             <span class="comment">//</span>
00236             <span class="comment">// Stop all timers that are currently running.</span>
00237             <span class="comment">//</span>
00238             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> != 0) {
00239                 <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00240                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = 0;
00241             }
00242             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> != 0) {
00243                 <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a>);
00244                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = 0;
00245             }
00246 
00247             <span class="comment">//</span>
00248             <span class="comment">// Don't reset activation timer.  Emergency levels are only</span>
00249             <span class="comment">// activated after enabling Filter Keys.</span>
00250             <span class="comment">//</span>
00251             <span class="keywordflow">return</span>;
00252         } <span class="keywordflow">else</span> {
00253             <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00254 
00255             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYSOUND)) {
00256                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00257                     pTerm,
00258                     <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>);
00259             }
00260 
00261             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_FILTERKEYS);
00262 
00263         }
00264         TimerDelta = <a class="code" href="../../d9/d3/access_8h.html#a10">FKEMERGENCY1DELTA</a>;
00265         <span class="keywordflow">break</span>;
00266 
00267     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a15">FKFIRSTLEVELEMERGENCY</a>:
00268         <span class="comment">//</span>
00269         <span class="comment">// First level emergency settings:</span>
00270         <span class="comment">//    Repeat Rate OFF</span>
00271         <span class="comment">//    SlowKeys OFF (Acceptance Delay of 0)</span>
00272         <span class="comment">//    BounceKeys Debounce Time of 1 second</span>
00273         <span class="comment">//</span>
00274         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYSOUND)) {
00275             <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(
00276                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>,
00277                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>,
00278                     <a class="code" href="../../d4/d1/userk_8h.html#a349">QEVENT_RITSOUND</a>,
00279                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00280                     <a class="code" href="../../d4/d1/userk_8h.html#a356">RITSOUND_DOBEEP</a>, <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>, 2);
00281         }
00282         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec = 0;
00283         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iWaitMSec = 0;
00284         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iBounceMSec = 1000;
00285         TimerDelta = <a class="code" href="../../d9/d3/access_8h.html#a11">FKEMERGENCY2DELTA</a>;
00286         <span class="keywordflow">break</span>;
00287 
00288     <span class="keywordflow">case</span> <a class="code" href="../../d9/d3/access_8h.html#a16">FKSECONDLEVELEMERGENCY</a>:
00289         <span class="comment">//</span>
00290         <span class="comment">// Second level emergency settings:</span>
00291         <span class="comment">//    Repeat Rate OFF</span>
00292         <span class="comment">//    SlowKeys Acceptance Delay of 2 seconds</span>
00293         <span class="comment">//    BounceKeys OFF (Debounce Time of 0)</span>
00294         <span class="comment">//</span>
00295         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec = 0;
00296         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iWaitMSec = 2000;
00297         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iBounceMSec = 0;
00298         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYSOUND)) {
00299             <a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(
00300                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>,
00301                     pTerm-&gt;<a class="code" href="../../d1/d8/structtagTERMINAL.html#o2">ptiDesktop</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>,
00302                     <a class="code" href="../../d4/d1/userk_8h.html#a349">QEVENT_RITSOUND</a>,
00303                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00304                     <a class="code" href="../../d4/d1/userk_8h.html#a356">RITSOUND_DOBEEP</a>, <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>, 3);
00305         }
00306         <span class="keywordflow">return</span>;
00307         <span class="keywordflow">break</span>;
00308 
00309     <span class="keywordflow">default</span>:
00310         <span class="keywordflow">return</span>;
00311     }
00312 
00313     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a>++;
00314     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00315                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00316                                     nID,
00317                                     TimerDelta,
00318                                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a12">FKActivationTimer</a>,
00319                                     TMRF_RIT | TMRF_ONESHOT
00320                                     );
00321     <span class="keywordflow">return</span>;
00322 
00323     DBG_UNREFERENCED_PARAMETER(pwnd);
00324     DBG_UNREFERENCED_PARAMETER(lParam);
00325     DBG_UNREFERENCED_PARAMETER(message);
00326 }
00327 
00328 <span class="comment">/***************************************************************************\</span>
00329 <span class="comment">* FKBounceKeyTimer</span>
00330 <span class="comment">*</span>
00331 <span class="comment">* If BounceKeys is active this routine is called after the debounce time</span>
00332 <span class="comment">* has expired.  Until then, the last key released will not be accepted as</span>
00333 <span class="comment">* input if it is pressed again.</span>
00334 <span class="comment">*</span>
00335 <span class="comment">* Return value:</span>
00336 <span class="comment">*    0</span>
00337 <span class="comment">*</span>
00338 <span class="comment">* History:</span>
00339 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00340 <span class="comment">\***************************************************************************/</span>
<a name="l00341"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a13">00341</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a13">FKBounceKeyTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
00342 {
00343 
00344     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00345     <span class="comment">//</span>
00346     <span class="comment">// All we need to do is clear gBounceVk to allow this key as the</span>
00347     <span class="comment">// next keystroke.</span>
00348     <span class="comment">//</span>
00349     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a> = 0;
00350     <span class="keywordflow">return</span>;
00351 
00352     DBG_UNREFERENCED_PARAMETER(pwnd);
00353     DBG_UNREFERENCED_PARAMETER(lParam);
00354     DBG_UNREFERENCED_PARAMETER(nID);
00355     DBG_UNREFERENCED_PARAMETER(message);
00356 
00357 }
00358 
00359 <span class="comment">/***************************************************************************\</span>
00360 <span class="comment">* xxxFKRepeatRateTimer</span>
00361 <span class="comment">*</span>
00362 <span class="comment">* If FilterKeys is active and a repeat rate is set, this routine controls</span>
00363 <span class="comment">* the rate at which the last key pressed repeats.  The hardware keyboard</span>
00364 <span class="comment">* typematic repeat is ignored in this case.</span>
00365 <span class="comment">*</span>
00366 <span class="comment">* This routine is called with the critical section already locked.</span>
00367 <span class="comment">*</span>
00368 <span class="comment">* Return value:</span>
00369 <span class="comment">*    0</span>
00370 <span class="comment">*</span>
00371 <span class="comment">* History:</span>
00372 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00373 <span class="comment">\***************************************************************************/</span>
<a name="l00374"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">00374</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
00375 {
00376 
00377     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00378     <span class="comment">//</span>
00379     <span class="comment">// Repeat after me...</span>
00380     <span class="comment">//</span>
00381     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_CLICKON)) {
00382         <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00383         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00384                     pTerm,
00385                     <a class="code" href="../../d4/d1/userk_8h.html#a355">RITSOUND_KEYCLICK</a>);
00386     }
00387 
00388     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> == 0);
00389 
00390     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00391                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00392                                   nID,
00393                                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec,
00394                                   <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>,
00395                                   TMRF_RIT | TMRF_ONESHOT
00396                                   );
00397     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a46">gpFKKeyEvent</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a47">gFKExtraInformation</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a48">gFKNextProcIndex</a>)) {
00398         <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a46">gpFKKeyEvent</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a47">gFKExtraInformation</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00399     }
00400     <span class="keywordflow">return</span>;
00401 
00402 
00403     DBG_UNREFERENCED_PARAMETER(pwnd);
00404     DBG_UNREFERENCED_PARAMETER(lParam);
00405     DBG_UNREFERENCED_PARAMETER(message);
00406 }
00407 
00408 <span class="comment">/***************************************************************************\</span>
00409 <span class="comment">* xxxFKAcceptanceDelayTimer</span>
00410 <span class="comment">*</span>
00411 <span class="comment">* If FilterKeys is active and an acceptance delay is set, this routine</span>
00412 <span class="comment">* is called after the key has been held down for the acceptance delay</span>
00413 <span class="comment">* period.</span>
00414 <span class="comment">*</span>
00415 <span class="comment">* This routine is called with the critical section already locked.</span>
00416 <span class="comment">*</span>
00417 <span class="comment">* Return value:</span>
00418 <span class="comment">*    0</span>
00419 <span class="comment">*</span>
00420 <span class="comment">* History:</span>
00421 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00422 <span class="comment">\***************************************************************************/</span>
<a name="l00423"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a15">00423</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a15">xxxFKAcceptanceDelayTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
00424 {
00425 
00426     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00427     <span class="comment">//</span>
00428     <span class="comment">// The key has been held down long enough.  Send it on...</span>
00429     <span class="comment">//</span>
00430     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_CLICKON)) {
00431         <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00432         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00433                     pTerm,
00434                     <a class="code" href="../../d4/d1/userk_8h.html#a355">RITSOUND_KEYCLICK</a>);
00435     }
00436 
00437     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a46">gpFKKeyEvent</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a47">gFKExtraInformation</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a48">gFKNextProcIndex</a>)) {
00438         <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a46">gpFKKeyEvent</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a47">gFKExtraInformation</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00439     }
00440     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec) {
00441         <span class="comment">//</span>
00442         <span class="comment">// gptmrFKAcceptanceDelay needs to be released, but we can't do it while</span>
00443         <span class="comment">// in a RIT timer routine.  Set a global to indicate that the subsequent</span>
00444         <span class="comment">// break of this key should be passed on and the timer freed.</span>
00445         <span class="comment">//</span>
00446         <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a631">ACCF_FKMAKECODEPROCESSED</a>);
00447         <span class="keywordflow">return</span>;
00448     }
00449     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> == 0);
00450     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iDelayMSec) {
00451         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00452                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00453                                       nID,
00454                                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iDelayMSec,
00455                                       <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>,
00456                                       TMRF_RIT | TMRF_ONESHOT
00457                                       );
00458     } <span class="keywordflow">else</span> {
00459         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00460                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00461                                       nID,
00462                                       <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec,
00463                                       <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>,
00464                                       TMRF_RIT | TMRF_ONESHOT
00465                                       );
00466     }
00467     <span class="comment">//</span>
00468     <span class="comment">// gptmrFKAcceptanceDelay timer structure was reused so set handle to NULL.</span>
00469     <span class="comment">//</span>
00470     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = 0;
00471 
00472     <span class="keywordflow">return</span>;
00473 
00474     DBG_UNREFERENCED_PARAMETER(lParam);
00475     DBG_UNREFERENCED_PARAMETER(message);
00476     DBG_UNREFERENCED_PARAMETER(pwnd);
00477 }
00478 
00479 <span class="comment">/***************************************************************************\</span>
00480 <span class="comment">* FilterKeys</span>
00481 <span class="comment">*</span>
00482 <span class="comment">* History:</span>
00483 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00484 <span class="comment">\***************************************************************************/</span>
<a name="l00485"></a><a class="code" href="../../d9/d3/access_8h.html#a42">00485</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a42">FilterKeys</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NextProcIndex)
00486 {
00487     <span class="keywordtype">int</span> fBreak;
00488     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
00489 
00490     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00491     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(pKeyEvent-&gt;usFlaggedVk &amp; 0xff);
00492     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">// Check for Filter Keys hot key (right shift key).</span>
00496     <span class="comment">//</span>
00497     <span class="keywordflow">if</span> (Vk == VK_RSHIFT) {
00498         <span class="keywordflow">if</span> (fBreak) {
00499             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> != 0) {
00500                 <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a>);
00501                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> = 0;
00502             }
00503             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a> = <a class="code" href="../../d9/d3/access_8h.html#a12">FKIDLE</a>;
00504         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a7">ONLYRIGHTSHIFTDOWN</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>)) {
00505             <span class="comment">//</span>
00506             <span class="comment">// Verify that activation via hotkey is allowed.</span>
00507             <span class="comment">//</span>
00508             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYACTIVE)) {
00509                 <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> == 0) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a> != <a class="code" href="../../d9/d3/access_8h.html#a17">FKMOUSEMOVE</a>)) {
00510                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a> = <a class="code" href="../../d9/d3/access_8h.html#a13">FKFIRSTWARNING</a>;
00511                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00512                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00513                                                     0,
00514                                                     <a class="code" href="../../d9/d3/access_8h.html#a8">FKFIRSTWARNINGTIME</a>,
00515                                                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a12">FKActivationTimer</a>,
00516                                                     TMRF_RIT | TMRF_ONESHOT
00517                                                     );
00518                 }
00519             }
00520         }
00521     }
00522 
00523     <span class="comment">//</span>
00524     <span class="comment">// If another key is pressed while the hot key is down, kill</span>
00525     <span class="comment">// the timer.</span>
00526     <span class="comment">//</span>
00527     <span class="keywordflow">if</span> ((Vk != VK_RSHIFT) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> != 0)) {
00528         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a44">gFilterKeysState</a> = <a class="code" href="../../d9/d3/access_8h.html#a12">FKIDLE</a>;
00529         <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a>);
00530         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a41">gtmridFKActivation</a> = 0;
00531     }
00532     <span class="comment">//</span>
00533     <span class="comment">// If Filter Keys not enabled send the key event on.</span>
00534     <span class="comment">//</span>
00535     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON)) {
00536         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00537     }
00538 
00539     <span class="keywordflow">if</span> (fBreak) {
00540         <span class="comment">//</span>
00541         <span class="comment">// Kill the current timer and activate bounce key timer (if this is</span>
00542         <span class="comment">// a break of the last key down).</span>
00543         <span class="comment">//</span>
00544         <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a161">gLastVkDown</a>) {
00545             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00546             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = 0;
00547 
00548             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a161">gLastVkDown</a> = 0;
00549             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> != 0) {
00550                 <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a>);
00551                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = 0;
00552                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a631">ACCF_FKMAKECODEPROCESSED</a>)) {
00553                     <span class="comment">//</span>
00554                     <span class="comment">// This key was released before accepted.  Don't pass on the</span>
00555                     <span class="comment">// break.</span>
00556                     <span class="comment">//</span>
00557                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00558                 } <span class="keywordflow">else</span> {
00559                     <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a631">ACCF_FKMAKECODEPROCESSED</a>);
00560                 }
00561             }
00562 
00563             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iBounceMSec) {
00564                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a> = Vk;
00565                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00566                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00567                                               0,
00568                                               <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iBounceMSec,
00569                                               <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a13">FKBounceKeyTimer</a>,
00570                                               TMRF_RIT | TMRF_ONESHOT
00571                                               );
00572                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a630">ACCF_IGNOREBREAKCODE</a>)) {
00573                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574                 }
00575             }
00576         }
00577     } <span class="keywordflow">else</span> {
00578         <span class="comment">//</span>
00579         <span class="comment">// Make key processing</span>
00580         <span class="comment">//</span>
00581         <span class="comment">// First check to see if this is a typematic repeat.  If so, we</span>
00582         <span class="comment">// can ignore this key event.  Our timer will handle any repeats.</span>
00583         <span class="comment">// LastVkDown is cleared during processing of the break.</span>
00584         <span class="comment">//</span>
00585         <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a161">gLastVkDown</a>) {
00586             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00587         }
00588         <span class="comment">//</span>
00589         <span class="comment">// Remember current Virtual Key down for typematic repeat check.</span>
00590         <span class="comment">//</span>
00591         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a161">gLastVkDown</a> = Vk;
00592 
00593         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a>) {
00594             <span class="comment">//</span>
00595             <span class="comment">// BounceKeys is active.  If this is a make of the last</span>
00596             <span class="comment">// key pressed we ignore it.  Only when the BounceKey</span>
00597             <span class="comment">// timer expires or another key is pressed will we accept</span>
00598             <span class="comment">// this key.</span>
00599             <span class="comment">//</span>
00600             <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a>) {
00601                 <span class="comment">//</span>
00602                 <span class="comment">// Ignore this make event and the subsequent break</span>
00603                 <span class="comment">// code.  BounceKey timer will be reset on break.</span>
00604                 <span class="comment">//</span>
00605                 <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a630">ACCF_IGNOREBREAKCODE</a>);
00606                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00607             } <span class="keywordflow">else</span> {
00608                 <span class="comment">//</span>
00609                 <span class="comment">// We have a make of a new key.  Kill the BounceKey</span>
00610                 <span class="comment">// timer and clear gBounceVk.</span>
00611                 <span class="comment">//</span>
00612                 UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00613                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> != 0) {
00614                     <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00615                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = 0;
00616                 }
00617                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a> = 0;
00618             }
00619         }
00620         <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a630">ACCF_IGNOREBREAKCODE</a>);
00621 
00622         <span class="comment">//</span>
00623         <span class="comment">// Give audible feedback that key was pressed.</span>
00624         <span class="comment">//</span>
00625         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_CLICKON)) {
00626             <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00627             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00628                     pTerm,
00629                     <a class="code" href="../../d4/d1/userk_8h.html#a355">RITSOUND_KEYCLICK</a>);
00630         }
00631 
00632         <span class="comment">//</span>
00633         <span class="comment">// If gptmrFKAcceptanceDelay is non-NULL the previous key was</span>
00634         <span class="comment">// not held down long enough to be accepted.  Kill the current</span>
00635         <span class="comment">// timer.  A new timer will be started below for the key we're</span>
00636         <span class="comment">// processing now.</span>
00637         <span class="comment">//</span>
00638         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> != 0) {
00639             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a>);
00640             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = 0;
00641         }
00642 
00643         <span class="comment">//</span>
00644         <span class="comment">// If gptmrFKResponse is non-NULL a repeat rate timer is active</span>
00645         <span class="comment">// on the previous key.  Kill the timer as we have a new make key.</span>
00646         <span class="comment">//</span>
00647         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> != 0) {
00648             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00649             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = 0;
00650         }
00651 
00652         <span class="comment">//</span>
00653         <span class="comment">// Save the current key event for later use if we process an</span>
00654         <span class="comment">// acceptance delay or key repeat.</span>
00655         <span class="comment">//</span>
00656         *<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a46">gpFKKeyEvent</a> = *pKeyEvent;
00657         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a47">gFKExtraInformation</a> = ExtraInformation;
00658         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a48">gFKNextProcIndex</a> = NextProcIndex;
00659 
00660         <span class="comment">//</span>
00661         <span class="comment">// If there is an acceptance delay, set timer and ignore current</span>
00662         <span class="comment">// key event.  When timer expires, saved key event will be sent.</span>
00663         <span class="comment">//</span>
00664         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iWaitMSec) {
00665             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00666                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00667                                           0,
00668                                           <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iWaitMSec,
00669                                           <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a15">xxxFKAcceptanceDelayTimer</a>,
00670                                           TMRF_RIT | TMRF_ONESHOT
00671                                           );
00672             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a631">ACCF_FKMAKECODEPROCESSED</a>);
00673             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00674         }
00675         <span class="comment">//</span>
00676         <span class="comment">// No acceptance delay.  Before sending this key event on the</span>
00677         <span class="comment">// timer routine must be set to either the delay until repeat value</span>
00678         <span class="comment">// or the repeat rate value.  If repeat rate is 0 then ignore</span>
00679         <span class="comment">// delay until repeat.</span>
00680         <span class="comment">//</span>
00681         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec) {
00682             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00683         }
00684 
00685         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> == 0);
00686         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iDelayMSec) {
00687             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00688                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00689                                           0,
00690                                           <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iDelayMSec,
00691                                           <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>,
00692                                           TMRF_RIT | TMRF_ONESHOT
00693                                           );
00694         } <span class="keywordflow">else</span> {
00695             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00696                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00697                                           0,
00698                                           <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec,
00699                                           <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a14">xxxFKRepeatRateTimer</a>,
00700                                           TMRF_RIT | TMRF_ONESHOT
00701                                           );
00702         }
00703     }
00704 
00705     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00706 }
00707 
00708 <span class="comment">/***************************************************************************\</span>
00709 <span class="comment">* StopFilterKeysTimers</span>
00710 <span class="comment">*</span>
00711 <span class="comment">* Called from SystemParametersInfo on SPI_SETFILTERKEYS if FKF_FILTERKEYSON</span>
00712 <span class="comment">* is not set.  Timers must be stopped if user turns FilterKeys off.</span>
00713 <span class="comment">*</span>
00714 <span class="comment">* History:</span>
00715 <span class="comment">*   18 Jul 94 GregoryW   Created.</span>
00716 <span class="comment">\***************************************************************************/</span>
<a name="l00717"></a><a class="code" href="../../d9/d3/access_8h.html#a50">00717</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a50">StopFilterKeysTimers</a>(VOID)
00718 {
00719 
00720     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> != 0) {
00721         <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a>);
00722         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a42">gtmridFKResponse</a> = 0;
00723     }
00724     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a>) {
00725         <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a>);
00726         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a43">gtmridFKAcceptanceDelay</a> = 0;
00727     }
00728     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a161">gLastVkDown</a> = 0;
00729     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a162">gBounceVk</a> = 0;
00730 }
00731 
00732 <span class="comment">/***************************************************************************\</span>
00733 <span class="comment">* xxxStickyKeys</span>
00734 <span class="comment">*</span>
00735 <span class="comment">* History:</span>
00736 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
00737 <span class="comment">\***************************************************************************/</span>
<a name="l00738"></a><a class="code" href="../../d9/d3/access_8h.html#a43">00738</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a43">xxxStickyKeys</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NextProcIndex)
00739 {
00740     <span class="keywordtype">int</span> fBreak;
00741     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> NewLockBits, NewLatchBits;
00742     <span class="keywordtype">int</span> BitPositions;
00743     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bChange;
00744     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
00745 
00746 
00747     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00748     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
00749 
00750     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00751         <span class="comment">//</span>
00752         <span class="comment">// Process modifier key</span>
00753         <span class="comment">//</span>
00754 
00755         <span class="comment">//</span>
00756         <span class="comment">// One method of activating StickyKeys is to press either the</span>
00757         <span class="comment">// left shift key or the right shift key five times without</span>
00758         <span class="comment">// pressing any other keys.  We don't want the typematic shift</span>
00759         <span class="comment">// (make code) to enable/disable StickyKeys so we perform a</span>
00760         <span class="comment">// special test for them.</span>
00761         <span class="comment">//</span>
00762         <span class="keywordflow">if</span> (!fBreak) {
00763             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a165">gPrevModifierState</a>) {
00764                 <span class="comment">//</span>
00765                 <span class="comment">// This is a typematic make of a modifier key.  Don't do</span>
00766                 <span class="comment">// any further processing.  Just pass it along.</span>
00767                 <span class="comment">//</span>
00768                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a165">gPrevModifierState</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
00769                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00770             }
00771         }
00772 
00773         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a165">gPrevModifierState</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
00774 
00775         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a20">LEFTSHIFTKEY</a>(pKeyEvent-&gt;usFlaggedVk) &amp;&amp;
00776             ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> &amp; ~<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) == 0)) {
00777             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a>++;
00778         } <span class="keywordflow">else</span> {
00779             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> = 0;
00780         }
00781         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a21">RIGHTSHIFTKEY</a>(pKeyEvent-&gt;usFlaggedVk) &amp;&amp;
00782             ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> &amp; ~<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) == 0)) {
00783             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a>++;
00784         } <span class="keywordflow">else</span> {
00785             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> = 0;
00786         }
00787 
00788         <span class="comment">//</span>
00789         <span class="comment">// Check to see if StickyKeys should be toggled on/off</span>
00790         <span class="comment">//</span>
00791         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> == (<a class="code" href="../../d9/d3/access_8h.html#a18">TOGGLE_STICKYKEYS_COUNT</a> * 2)) ||
00792             (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> == (<a class="code" href="../../d9/d3/access_8h.html#a18">TOGGLE_STICKYKEYS_COUNT</a> * 2))) {
00793             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_HOTKEYACTIVE)) {
00794                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)) {
00795                     <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>();
00796                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_HOTKEYSOUND)) {
00797                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00798                             pTerm,
00799                             <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
00800                     }
00801                 } <span class="keywordflow">else</span> {
00802                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_HOTKEYSOUND)) {
00803                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00804                             pTerm,
00805                             <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>);
00806                     }
00807                     <span class="comment">// To make the notification window get the focus</span>
00808                     <span class="comment">// The same is done other places where WM_LOGONNOTIFY message is</span>
00809                     <span class="comment">// sent    : a-anilk</span>
00810                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_STICKYKEYS);
00811 
00812                 }
00813             }
00814             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> = 0;
00815             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> = 0;
00816             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00817         }
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// If StickyKeys is enabled process the modifier key, otherwise</span>
00821         <span class="comment">// just pass on the modifier key.</span>
00822         <span class="comment">//</span>
00823         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)) {
00824             <span class="keywordflow">if</span> (fBreak) {
00825                 <span class="comment">//</span>
00826                 <span class="comment">// If either locked or latched bit set for this key then</span>
00827                 <span class="comment">// don't pass the break on.</span>
00828                 <span class="comment">//</span>
00829                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a19">UNION</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>) &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00830                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00831                 } <span class="keywordflow">else</span> {
00832                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00833                 }
00834             } <span class="keywordflow">else</span>{
00835                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00836                     <span class="comment">//</span>
00837                     <span class="comment">// More than one modifier key down at the same time.</span>
00838                     <span class="comment">// This condition may signal sticky keys to turn off.</span>
00839                     <span class="comment">// The routine xxxTwoKeysDown will return the new value</span>
00840                     <span class="comment">// of fStickyKeysOn.  If sticky keys is turned off</span>
00841                     <span class="comment">// (return value 0), the key event should be passed</span>
00842                     <span class="comment">// on without further processing here.</span>
00843                     <span class="comment">//</span>
00844                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a57">xxxTwoKeysDown</a>(NextProcIndex)) {
00845                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00846                     }
00847 
00848                     <span class="comment">//</span>
00849                     <span class="comment">// Modifier states were set to physical state by</span>
00850                     <span class="comment">// xxxTwoKeysDown.  The modifier keys currently in</span>
00851                     <span class="comment">// the down position will be latched by updating</span>
00852                     <span class="comment">// gLatchBits.  No more processing for this key</span>
00853                     <span class="comment">// event is needed.</span>
00854                     <span class="comment">//</span>
00855                     bChange = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> ||
00856                               (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>);
00857                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
00858                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> = 0;
00859                     <span class="keywordflow">if</span> (bChange) {
00860                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
00861                     }
00862 
00863                     <span class="comment">//</span>
00864                     <span class="comment">// Provide sound feedback, if enabled, before returning.</span>
00865                     <span class="comment">//</span>
00866                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_AUDIBLEFEEDBACK)) {
00867                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00868                             pTerm,
00869                             <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>);
00870                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00871                             pTerm,
00872                             <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>);
00873                     }
00874                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00875                 }
00876                 <span class="comment">//</span>
00877                 <span class="comment">// Figure out which bits (Shift, Ctrl or Alt key bits) to</span>
00878                 <span class="comment">// examine.  Also set up default values for NewLatchBits</span>
00879                 <span class="comment">// and NewLockBits in case they're not set later.</span>
00880                 <span class="comment">//</span>
00881                 <span class="comment">// See the depiction of the bit pattern in KeyboardApcProcedure.</span>
00882                 <span class="comment">//</span>
00883                 <span class="comment">// Bit 0 -- L SHIFT</span>
00884                 <span class="comment">// Bit 1 -- R SHIFT</span>
00885                 <span class="comment">// Bit 2 -- L CTL</span>
00886                 <span class="comment">// Bit 3 -- R CTL</span>
00887                 <span class="comment">// Bit 4 -- L ALT</span>
00888                 <span class="comment">// Bit 5 -- R RLT</span>
00889                 <span class="comment">// Bit 6 -- L WIN</span>
00890                 <span class="comment">// Bit 7 -- R WIN</span>
00891                 <span class="keywordflow">switch</span>(pKeyEvent-&gt;usFlaggedVk) {
00892                 <span class="keywordflow">case</span> VK_LSHIFT:
00893                 <span class="keywordflow">case</span> VK_RSHIFT:
00894                     BitPositions = 0x3;
00895                     <span class="keywordflow">break</span>;
00896                 <span class="keywordflow">case</span> VK_LCONTROL:
00897                 <span class="keywordflow">case</span> VK_RCONTROL:
00898                     BitPositions = 0xc;
00899                     <span class="keywordflow">break</span>;
00900                 <span class="keywordflow">case</span> VK_LMENU:
00901                 <span class="keywordflow">case</span> VK_RMENU:
00902                     BitPositions = 0x30;
00903                     <span class="keywordflow">break</span>;
00904                 <span class="keywordflow">case</span> VK_LWIN:
00905                 <span class="keywordflow">case</span> VK_RWIN:
00906                     BitPositions = 0xc0;
00907                     <span class="keywordflow">break</span>;
00908                 }
00909                 NewLatchBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>;
00910                 NewLockBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>;
00911 
00912                 <span class="comment">//</span>
00913                 <span class="comment">// If either left or right modifier is locked clear latched</span>
00914                 <span class="comment">// and locked states and send appropriate break/make messages.</span>
00915                 <span class="comment">//</span>
00916                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> &amp; BitPositions) {
00917                     NewLockBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> &amp; ~BitPositions;
00918                     NewLatchBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> &amp; ~BitPositions;
00919                     <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(
00920                         NewLockBits | NewLatchBits | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>,
00921                         NextProcIndex
00922                         );
00923                 } <span class="keywordflow">else</span> {
00924                     <span class="comment">//</span>
00925                     <span class="comment">// If specific lock bit (left or right) not</span>
00926                     <span class="comment">// previously set then toggle latch bits.</span>
00927                     <span class="comment">//</span>
00928                     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>)) {
00929                         NewLatchBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> ^ <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>;
00930                     }
00931                     <span class="comment">//</span>
00932                     <span class="comment">// If locked mode (tri-state) enabled then if latch or lock</span>
00933                     <span class="comment">// bit previously set, toggle lock bit.</span>
00934                     <span class="comment">//</span>
00935                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_TRISTATE)) {
00936                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a19">UNION</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>) &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00937                             NewLockBits = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> ^ <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>;
00938                         }
00939                     }
00940                 }
00941 
00942                 <span class="comment">//</span>
00943                 <span class="comment">// Update globals</span>
00944                 <span class="comment">//</span>
00945                 bChange = ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> != NewLatchBits) ||
00946                            (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> != NewLockBits));
00947 
00948                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = NewLatchBits;
00949                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> = NewLockBits;
00950 
00951                 <span class="keywordflow">if</span> (bChange) {
00952                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
00953                 }
00954                 <span class="comment">//</span>
00955                 <span class="comment">// Now provide sound feedback if enabled.  For the transition</span>
00956                 <span class="comment">// to LATCH mode issue a low beep then a high beep.  For the</span>
00957                 <span class="comment">// transition to LOCKED mode issue a high beep.  For the</span>
00958                 <span class="comment">// transition out of LOCKED mode (or LATCH mode if tri-state</span>
00959                 <span class="comment">// not enabled) issue a low beep.</span>
00960                 <span class="comment">//</span>
00961                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_AUDIBLEFEEDBACK)) {
00962                     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>)) {
00963                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00964                             pTerm,
00965                             <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>);
00966                     }
00967                     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>) &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00968                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
00969                             pTerm,
00970                             <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>);
00971                     }
00972                 }
00973                 <span class="comment">//</span>
00974                 <span class="comment">// Pass key on if shift bit is set (e.g., if transitioning</span>
00975                 <span class="comment">// from shift to lock mode don't pass on make).</span>
00976                 <span class="comment">//</span>
00977                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> &amp; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a164">gCurrentModifierBit</a>) {
00978                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00979                 } <span class="keywordflow">else</span> {
00980                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00981                 }
00982 
00983             }
00984         }
00985     } <span class="keywordflow">else</span> {
00986         <span class="comment">//</span>
00987         <span class="comment">// Non-shift key processing here...</span>
00988         <span class="comment">//</span>
00989         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> = 0;
00990         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> = 0;
00991         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)) {
00992             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00993         }
00994 
00995         <span class="comment">//</span>
00996         <span class="comment">// If no modifier keys are down, or this is a break, pass the key event</span>
00997         <span class="comment">// on and clear any latch states.</span>
00998         <span class="comment">//</span>
00999         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a> || fBreak) {
01000             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(pKeyEvent, ExtraInformation, NextProcIndex)) {
01001                 <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(pKeyEvent, ExtraInformation, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01002             }
01003             <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>, NextProcIndex);
01004 
01005             bChange = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> != 0;
01006             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = 0;
01007             <span class="keywordflow">if</span> (bChange) {
01008 
01009                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
01010             }
01011             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01012         } <span class="keywordflow">else</span> {
01013             <span class="comment">//</span>
01014             <span class="comment">// This is a make of a non-modifier key and there is a modifier key</span>
01015             <span class="comment">// down.  Update the states and pass the key event on.</span>
01016             <span class="comment">//</span>
01017             <a class="code" href="../../d9/d3/access_8h.html#a57">xxxTwoKeysDown</a>(NextProcIndex);
01018             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01019         }
01020     }
01021 
01022     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01023 }
01024 
01025 <span class="comment">/***************************************************************************\</span>
01026 <span class="comment">* xxxUpdateModifierState</span>
01027 <span class="comment">*</span>
01028 <span class="comment">* Starting from the current modifier keys state, send the necessary key</span>
01029 <span class="comment">* events (make or break) to end up with the NewModifierState passed in.</span>
01030 <span class="comment">*</span>
01031 <span class="comment">* Return value:</span>
01032 <span class="comment">*    None.</span>
01033 <span class="comment">*</span>
01034 <span class="comment">* History:</span>
01035 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01036 <span class="comment">\***************************************************************************/</span>
<a name="l01037"></a><a class="code" href="../../d9/d3/access_8h.html#a59">01037</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(<span class="keywordtype">int</span> NewModifierState, <span class="keywordtype">int</span> NextProcIndex)
01038 {
01039     KE ke;
01040     <span class="keywordtype">int</span> CurrentModState;
01041     <span class="keywordtype">int</span> CurrentModBit, NewModBit;
01042     <span class="keywordtype">int</span> i;
01043 
01044     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01045 
01046     CurrentModState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>;
01047 
01048     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>); i++) {
01049         CurrentModBit = CurrentModState &amp; <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>[i].<a class="code" href="../../d9/d1/structtagMODBITINFO.html#o0">BitPosition</a>;
01050         NewModBit = NewModifierState &amp; <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>[i].<a class="code" href="../../d9/d1/structtagMODBITINFO.html#o0">BitPosition</a>;
01051         <span class="keywordflow">if</span> (CurrentModBit != NewModBit) {
01052             ke.bScanCode = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>[i].<a class="code" href="../../d9/d1/structtagMODBITINFO.html#o1">ScanCode</a>;
01053             ke.usFlaggedVk = <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a3">aModBit</a>[i].<a class="code" href="../../d9/d1/structtagMODBITINFO.html#o2">Vk</a>;
01054             <span class="keywordflow">if</span> (CurrentModBit) {          <span class="comment">// if it's currently on, send break</span>
01055                 ke.usFlaggedVk |= KBDBREAK;
01056             }
01057             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(&amp;ke, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, NextProcIndex)) {
01058                 <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ke, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01059             }
01060         }
01061     }
01062 }
01063 
01064 <span class="comment">/***************************************************************************\</span>
01065 <span class="comment">* xxxTurnOffStickyKeys</span>
01066 <span class="comment">*</span>
01067 <span class="comment">* The user either pressed the appropriate key sequence or used the</span>
01068 <span class="comment">* access utility to turn StickyKeys off.  Update modifier states and</span>
01069 <span class="comment">* reset globals.</span>
01070 <span class="comment">*</span>
01071 <span class="comment">* Return value:</span>
01072 <span class="comment">*   None.</span>
01073 <span class="comment">*</span>
01074 <span class="comment">* History:</span>
01075 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01076 <span class="comment">\***************************************************************************/</span>
<a name="l01077"></a><a class="code" href="../../d9/d3/access_8h.html#a60">01077</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>(VOID)
01078 {
01079     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> index;
01080     
01081     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01082 
01083     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>); index++) {
01084         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>[index] == <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a18">xxxStickyKeys</a>) {
01085 
01086             <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>, index+1);
01087             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = 0;
01088             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
01089 
01090             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
01091             <span class="keywordflow">break</span>;
01092         }
01093     }
01094 }
01095 
01096 <span class="comment">/***************************************************************************\</span>
01097 <span class="comment">* xxxUnlatchStickyKeys</span>
01098 <span class="comment">*</span>
01099 <span class="comment">* This routine releases any sticky keys that are latched.  This routine</span>
01100 <span class="comment">* is called during mouse up event processing.</span>
01101 <span class="comment">*</span>
01102 <span class="comment">* Return value:</span>
01103 <span class="comment">*   None.</span>
01104 <span class="comment">*</span>
01105 <span class="comment">* History:</span>
01106 <span class="comment">*   21 Jun 93 GregoryW   Created.</span>
01107 <span class="comment">\***************************************************************************/</span>
<a name="l01108"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a21">01108</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a21">xxxUnlatchStickyKeys</a>(VOID)
01109 {
01110     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> index;
01111     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bChange;
01112 
01113     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a>) {
01114         <span class="keywordflow">return</span>;
01115     }
01116 
01117     <span class="keywordflow">for</span> (index = 0; index &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a2">ARRAY_SIZE</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>); index++) {
01118         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a0">aAccessibilityProc</a>[index] == <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a18">xxxStickyKeys</a>) {
01119             <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a>, index+1);
01120             bChange = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> != 0;
01121             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = 0;
01122 
01123             <span class="keywordflow">if</span> (bChange) {
01124 
01125                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
01126             }
01127             <span class="keywordflow">break</span>;
01128         }
01129     }
01130 }
01131 
01132 
01133 <span class="comment">/***************************************************************************\</span>
01134 <span class="comment">* xxxHardwareMouseKeyUp</span>
01135 <span class="comment">*</span>
01136 <span class="comment">* This routine is called during a mouse button up event.  If MouseKeys is</span>
01137 <span class="comment">* on and the button up event corresponds to a mouse key that's locked down,</span>
01138 <span class="comment">* the mouse key must be released.</span>
01139 <span class="comment">*</span>
01140 <span class="comment">* If StickyKeys is on, all latched keys are released.</span>
01141 <span class="comment">*</span>
01142 <span class="comment">* Return value:</span>
01143 <span class="comment">*   None.</span>
01144 <span class="comment">*</span>
01145 <span class="comment">* History:</span>
01146 <span class="comment">*   17 Jun 94 GregoryW   Created.</span>
01147 <span class="comment">\***************************************************************************/</span>
01148 
<a name="l01149"></a><a class="code" href="../../d9/d3/access_8h.html#a61">01149</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a61">xxxHardwareMouseKeyUp</a>(DWORD dwButton)
01150 {
01151     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01152 
01153     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)) {
01154         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp;= ~dwButton;
01155     }
01156 
01157         <span class="comment">// Not required to post a setting change</span>
01158     <span class="comment">//PostAccessibility( SPI_SETMOUSEKEYS );</span>
01159 
01160     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)) {
01161         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a21">xxxUnlatchStickyKeys</a>();
01162     }
01163 }
01164 
01165 
01166 <span class="comment">/***************************************************************************\</span>
01167 <span class="comment">* xxxTwoKeysDown</span>
01168 <span class="comment">*</span>
01169 <span class="comment">* Two keys are down simultaneously.  Check to see if StickyKeys should be</span>
01170 <span class="comment">* turned off.  In all cases update the modifier key state to reflect the</span>
01171 <span class="comment">* physical key state and clear latched and locked modes.</span>
01172 <span class="comment">*</span>
01173 <span class="comment">* Return value:</span>
01174 <span class="comment">*    1 if StickyKeys is enabled.</span>
01175 <span class="comment">*    0 if StickyKeys is disabled.</span>
01176 <span class="comment">*</span>
01177 <span class="comment">* History:</span>
01178 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01179 <span class="comment">\***************************************************************************/</span>
<a name="l01180"></a><a class="code" href="../../d9/d3/access_8h.html#a57">01180</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a57">xxxTwoKeysDown</a>(<span class="keywordtype">int</span> NextProcIndex)
01181 {
01182     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01183 
01184     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_TWOKEYSOFF)) {
01185         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
01186         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_HOTKEYSOUND)) {
01187             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01188                     pTerm,
01189                     <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
01190         }
01191         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a172">gStickyKeysLeftShiftCount</a> = 0;
01192         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a173">gStickyKeysRightShiftCount</a> = 0;
01193     }
01194     <a class="code" href="../../d9/d3/access_8h.html#a59">xxxUpdateModifierState</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>, NextProcIndex);
01195     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> = 0;
01196 
01197     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
01198 
01199     <span class="keywordflow">return</span> <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
01200 }
01201 
01202 <span class="comment">/***************************************************************************\</span>
01203 <span class="comment">* SetGlobalCursorLevel</span>
01204 <span class="comment">*</span>
01205 <span class="comment">* Set the cursor level of all threads running on the visible</span>
01206 <span class="comment">* windowstation.</span>
01207 <span class="comment">*</span>
01208 <span class="comment">* History:</span>
01209 <span class="comment">* 04-17-95 JimA         Created.</span>
01210 <span class="comment">\***************************************************************************/</span>
01211 
<a name="l01212"></a><a class="code" href="../../d9/d3/access_8h.html#a58">01212</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a58">SetGlobalCursorLevel</a>(
01213     INT iCursorLevel)
01214 {
01215 
01216 <span class="comment">/*</span>
01217 <span class="comment"> * LATER</span>
01218 <span class="comment"> * We have other code which assumes that the</span>
01219 <span class="comment"> * iCursorLevel of a queue is the sum of the iCursorLevel values for the</span>
01220 <span class="comment"> * threads attached to the queue.  But this code, if you set iCursorLevel to</span>
01221 <span class="comment"> * -1 (to indicate no mouse) will set the queue iCursorLevel to -1, no matter</span>
01222 <span class="comment"> * how many threads are attached to the queue.  This needs to be revisited.</span>
01223 <span class="comment"> * See the function AttachToQueue.</span>
01224 <span class="comment"> *  FritzS</span>
01225 <span class="comment"> */</span>
01226 
01227 
01228     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk;
01229     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
01230     PLIST_ENTRY pHead, pEntry;
01231 
01232     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"SetGlobalCursorLevel %x"</span>, iCursorLevel);
01233 
01234     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>) {
01235         <span class="keywordflow">for</span> (pdesk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>;
01236                 pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
01237 
01238             pHead = &amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o20">PtiList</a>;
01239             <span class="keywordflow">for</span> (pEntry = pHead-&gt;Flink; pEntry != pHead; pEntry = pEntry-&gt;Flink) {
01240                 pti = CONTAINING_RECORD(pEntry, <a class="code" href="../../d2/d8/structtagTHREADINFO.html">THREADINFO</a>, PtiLink);
01241 
01242                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a> = iCursorLevel;
01243                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> = iCursorLevel;
01244             }
01245         }
01246     }
01247 
01248     <span class="comment">/*</span>
01249 <span class="comment">     * CSRSS doesn't seem to be on the list, so fix it up now.</span>
01250 <span class="comment">     */</span>
01251     <span class="keywordflow">for</span> (pti = <a class="code" href="../../d4/d1/userk_8h.html#a18">PpiFromProcess</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a299">gpepCSRSS</a>)-&gt;ptiList;
01252             pti != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pti = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o29">ptiSibling</a>) {
01253         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a> != iCursorLevel) {
01254             TAGMSG3(DBGTAG_PNP, <span class="stringliteral">"pti %#p has cursorlevel %x, should be %x"</span>,
01255                     pti, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a>, iCursorLevel);
01256         }
01257         <span class="keywordflow">if</span> (pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> != iCursorLevel) {
01258             TAGMSG4(DBGTAG_PNP, <span class="stringliteral">"pti-&gt;pq %#p-&gt;%#p has cursorlevel %x, should be %x"</span>,
01259                     pti, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a>, iCursorLevel);
01260         }
01261         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o37">iCursorLevel</a> = iCursorLevel;
01262         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o20">iCursorLevel</a> = iCursorLevel;
01263     }
01264 }
01265 
01266 <span class="comment">/***************************************************************************\</span>
01267 <span class="comment">* MKShowMouseCursor</span>
01268 <span class="comment">*</span>
01269 <span class="comment">* If no hardware mouse is installed and MouseKeys is enabled, we need</span>
01270 <span class="comment">* to fix up the system metrics, the oem information and the queue</span>
01271 <span class="comment">* information.  The mouse cursor then gets displayed.</span>
01272 <span class="comment">*</span>
01273 <span class="comment">* Return value:</span>
01274 <span class="comment">*    None.</span>
01275 <span class="comment">*</span>
01276 <span class="comment">* History:</span>
01277 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01278 <span class="comment">\***************************************************************************/</span>
<a name="l01279"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a25">01279</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a25">MKShowMouseCursor</a>()
01280 {
01281     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"MKShowMouseCursor (gpDeviceInfoList == %#p)"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>);
01282 
01283     <span class="comment">//</span>
01284     <span class="comment">// If TEST_GTERMF(GTERMF_MOUSE) is TRUE then we either have a hardware mouse</span>
01285     <span class="comment">// or we're already pretending a mouse is installed.  In either case,</span>
01286     <span class="comment">// there's nothing to do so just return.</span>
01287     <span class="comment">//</span>
01288     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a193">TEST_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>)) {
01289         TAGMSG0(DBGTAG_PNP, <span class="stringliteral">"MKShowMouseCursor just returns"</span>);
01290         <span class="keywordflow">return</span>;
01291     }
01292 
01293     <a class="code" href="../../d4/d1/userk_8h.html#a195">SET_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>);
01294     <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a632">ACCF_MKVIRTUALMOUSE</a>);
01295     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01296     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CMOUSEBUTTONS) = 2;
01297     <span class="comment">/*</span>
01298 <span class="comment">     * HACK: CreateQueue() uses oemInfo.fMouse to determine if a mouse is</span>
01299 <span class="comment">     * present and thus whether to set the iCursorLevel field in the</span>
01300 <span class="comment">     * THREADINFO structure to 0 or -1.  Unfortunately some queues have</span>
01301 <span class="comment">     * already been created at this point.  Since oemInfo.fMouse is</span>
01302 <span class="comment">     * initialized to FALSE, we need to go back through any queues already</span>
01303 <span class="comment">     * around and set their iCursorLevel field to the correct value when</span>
01304 <span class="comment">     * mousekeys is enabled.</span>
01305 <span class="comment">     */</span>
01306     <a class="code" href="../../d9/d3/access_8h.html#a58">SetGlobalCursorLevel</a>(0);
01307 }
01308 
01309 <span class="comment">/***************************************************************************\</span>
01310 <span class="comment">* MKHideMouseCursor</span>
01311 <span class="comment">*</span>
01312 <span class="comment">* If no hardware mouse is installed and MouseKeys is disabled, we need</span>
01313 <span class="comment">* to fix up the system metrics, the oem information and the queue</span>
01314 <span class="comment">* information.  The mouse cursor then disappears.</span>
01315 <span class="comment">*</span>
01316 <span class="comment">* Return value:</span>
01317 <span class="comment">*    None.</span>
01318 <span class="comment">*</span>
01319 <span class="comment">* History:</span>
01320 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01321 <span class="comment">\***************************************************************************/</span>
<a name="l01322"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a26">01322</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a26">MKHideMouseCursor</a>()
01323 {
01324     TAGMSG1(DBGTAG_PNP, <span class="stringliteral">"MKHideMouseCursor (gpDeviceInfoList == %#p)"</span>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a205">gpDeviceInfoList</a>);
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// If a hardware mouse is present we don't need to do anything.</span>
01328     <span class="comment">//</span>
01329     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a632">ACCF_MKVIRTUALMOUSE</a>)) {
01330         <span class="keywordflow">return</span>;
01331     }
01332 
01333     <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a632">ACCF_MKVIRTUALMOUSE</a>);
01334     <a class="code" href="../../d4/d1/userk_8h.html#a196">CLEAR_GTERMF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a199">GTERMF_MOUSE</a>);
01335     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(MOUSEPRESENT) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01336     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CMOUSEBUTTONS) = 0;
01337 
01338     <a class="code" href="../../d9/d3/access_8h.html#a58">SetGlobalCursorLevel</a>(-1);
01339 }
01340 
01341 <span class="comment">/***************************************************************************\</span>
01342 <span class="comment">* xxxMKToggleMouseKeys</span>
01343 <span class="comment">*</span>
01344 <span class="comment">* This routine is called when the NumLock key is pressed and MouseKeys is</span>
01345 <span class="comment">* active.  If the left shift key and the left alt key are down then MouseKeys</span>
01346 <span class="comment">* is turned off.  If just the NumLock key is pressed then we toggle between</span>
01347 <span class="comment">* MouseKeys active and the state of the number pad before MouseKeys was</span>
01348 <span class="comment">* activated.</span>
01349 <span class="comment">*</span>
01350 <span class="comment">* Return value:</span>
01351 <span class="comment">*    TRUE  - key should be passed on in the input stream.</span>
01352 <span class="comment">*    FALSE - key should not be passed on.</span>
01353 <span class="comment">*</span>
01354 <span class="comment">* History:</span>
01355 <span class="comment">\***************************************************************************/</span>
<a name="l01356"></a><a class="code" href="../../d9/d3/access_8h.html#a68">01356</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a68">xxxMKToggleMouseKeys</a>(USHORT NotUsed)
01357 {
01358     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bRetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01359     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bNewPassThrough;
01360     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01361 
01362 
01363     <span class="comment">//</span>
01364     <span class="comment">// If this is a typematic repeat of NumLock we just pass it on.</span>
01365     <span class="comment">//</span>
01366     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>)) {
01367         <span class="keywordflow">return</span> bRetVal;
01368     }
01369     <span class="comment">//</span>
01370     <span class="comment">// This is a make of NumLock.  Check for disable sequence.</span>
01371     <span class="comment">//</span>
01372     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a>) {
01373         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYACTIVE)) {
01374             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a>) {
01375                <span class="comment">//</span>
01376                <span class="comment">// User wants to turn MouseKeys off.  If we're currently in</span>
01377                <span class="comment">// pass through mode then the NumLock key is in the same state</span>
01378                <span class="comment">// (on or off) as it was when the user invoked MouseKeys.  We</span>
01379                <span class="comment">// want to leave it in that state, so don't pass the NumLock</span>
01380                <span class="comment">// key on.</span>
01381                <span class="comment">//</span>
01382                bRetVal = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01383             }
01384             <a class="code" href="../../d9/d3/access_8h.html#a62">TurnOffMouseKeys</a>();
01385         }
01386         <span class="keywordflow">return</span> bRetVal;
01387     }
01388     <span class="comment">/*</span>
01389 <span class="comment">     * This is a NumLock with no modifiers.  Toggle current state and</span>
01390 <span class="comment">     * provide audible feedback.</span>
01391 <span class="comment">     *</span>
01392 <span class="comment">     * Note -- this test is the reverse of other ones because it tests the</span>
01393 <span class="comment">     * state of VK_NUMLOCK before the keypress flips the state of NUMLOCK.</span>
01394 <span class="comment">     * So the code checks for what the state will be.</span>
01395 <span class="comment">     */</span>
01396     bNewPassThrough =
01397 <span class="preprocessor">#ifdef FE_SB // MouseKeys()</span>
01398 <span class="preprocessor"></span>        (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) != 0) ^
01399 <span class="preprocessor">#else  // FE_SB</span>
01400 <span class="preprocessor"></span>        (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_NUMLOCK) != 0) ^
01401 <span class="preprocessor">#endif // FE_SB</span>
01402 <span class="preprocessor"></span>             (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_REPLACENUMBERS) != 0);
01403 
01404 
01405     <span class="keywordflow">if</span> (!bNewPassThrough) {
01406         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01407         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01408               pTerm,
01409               <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>);
01410     } <span class="keywordflow">else</span> {
01411         WORD SaveCurrentActiveButton;
01412         <span class="comment">//</span>
01413         <span class="comment">// User wants keys to be passed on.  Release all buttons currently</span>
01414         <span class="comment">// down.</span>
01415         <span class="comment">//</span>
01416         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01417         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01418               pTerm,
01419               <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>);
01420         SaveCurrentActiveButton = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a>;
01421         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a> = <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a> | <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>;
01422         <a class="code" href="../../d9/d3/access_8h.html#a65">xxxMKButtonSetState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01423         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a> = SaveCurrentActiveButton;
01424     }
01425 
01426     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_MOUSEKEYS );
01427 
01428     <span class="keywordflow">return</span> bRetVal;
01429 
01430 
01431     DBG_UNREFERENCED_PARAMETER(NotUsed);
01432 }
01433 
01434 <span class="comment">/***************************************************************************\</span>
01435 <span class="comment">* xxxMKButtonClick</span>
01436 <span class="comment">*</span>
01437 <span class="comment">* Click the active mouse button.</span>
01438 <span class="comment">*</span>
01439 <span class="comment">* Return value:</span>
01440 <span class="comment">*    Always FALSE - key should not be passed on.</span>
01441 <span class="comment">*</span>
01442 <span class="comment">* History:</span>
01443 <span class="comment">\***************************************************************************/</span>
<a name="l01444"></a><a class="code" href="../../d9/d3/access_8h.html#a63">01444</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a63">xxxMKButtonClick</a>(USHORT NotUsed)
01445 {
01446     <span class="comment">//</span>
01447     <span class="comment">// The button click only happens on initial make of key.  If this is a</span>
01448     <span class="comment">// typematic repeat we just ignore it.</span>
01449     <span class="comment">//</span>
01450     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>)) {
01451         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01452     }
01453     <span class="comment">//</span>
01454     <span class="comment">// Ensure active button is UP before the click</span>
01455     <span class="comment">//</span>
01456     <a class="code" href="../../d9/d3/access_8h.html#a65">xxxMKButtonSetState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01457     <span class="comment">//</span>
01458     <span class="comment">// Now push the button DOWN</span>
01459     <span class="comment">//</span>
01460     <a class="code" href="../../d9/d3/access_8h.html#a65">xxxMKButtonSetState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01461     <span class="comment">//</span>
01462     <span class="comment">// Now release the button</span>
01463     <span class="comment">//</span>
01464     <a class="code" href="../../d9/d3/access_8h.html#a65">xxxMKButtonSetState</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01465 
01466     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01467 
01468 
01469     UNREFERENCED_PARAMETER(NotUsed);
01470 }
01471 
01472 
01473 <span class="comment">/***************************************************************************\</span>
01474 <span class="comment">* xxxMKMoveConstCursorTimer</span>
01475 <span class="comment">*</span>
01476 <span class="comment">* Timer routine that handles constant speed mouse movement.  This routine</span>
01477 <span class="comment">* is called 20 times per second and uses information from</span>
01478 <span class="comment">* gMouseCursor.bConstantTable[] to determine how many pixels to move the</span>
01479 <span class="comment">* mouse cursor on each tick.</span>
01480 <span class="comment">*</span>
01481 <span class="comment">* Return value:</span>
01482 <span class="comment">*    None.</span>
01483 <span class="comment">*</span>
01484 <span class="comment">* History:</span>
01485 <span class="comment">\***************************************************************************/</span>
<a name="l01486"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a29">01486</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a29">xxxMKMoveConstCursorTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
01487 {
01488     LONG  MovePixels;
01489 
01490     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01491 
01492     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MODIFIERS)) {
01493         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) &amp; <a class="code" href="../../d9/d3/access_8h.html#a29">LRSHIFT</a>) {
01494             MovePixels = 1;
01495             <span class="keywordflow">goto</span> MoveIt;
01496         }
01497         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) &amp; <a class="code" href="../../d9/d3/access_8h.html#a28">LRCONTROL</a>) {
01498             MovePixels = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[0] * <a class="code" href="../../d9/d3/access_8h.html#a38">MK_CONTROL_SPEED</a>;
01499             <span class="keywordflow">goto</span> MoveIt;
01500         }
01501     }
01502 
01503     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a> %= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTableLen;
01504 
01505     MovePixels = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a>++];
01506 
01507     <span class="keywordflow">if</span> (MovePixels == 0) {
01508         <span class="keywordflow">return</span>;
01509     }
01510 
01511 MoveIt:
01512     <span class="comment">//</span>
01513     <span class="comment">// We're inside the critical section - leave before calling MoveEvent.</span>
01514     <span class="comment">// Set gbMouseMoved to TRUE so RawInputThread wakes up the appropriate</span>
01515     <span class="comment">// user thread (if any) to receive this event.</span>
01516     <span class="comment">//</span>
01517     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01518 
01519     <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(MovePixels * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a56">gMKDeltaX</a>, MovePixels * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a57">gMKDeltaY</a>, 0, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01520     <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(0, 0, 0, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01521     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01522     <span class="keywordflow">return</span>;
01523 
01524 
01525     UNREFERENCED_PARAMETER(pwnd);
01526     UNREFERENCED_PARAMETER(lParam);
01527     UNREFERENCED_PARAMETER(nID);
01528     UNREFERENCED_PARAMETER(message);
01529 }
01530 
01531 <span class="comment">/***************************************************************************\</span>
01532 <span class="comment">* xxxMKMoveAccelCursorTimer</span>
01533 <span class="comment">*</span>
01534 <span class="comment">* Timer routine that handles mouse acceleration.  It gets called 20 times</span>
01535 <span class="comment">* per second and uses information from gMouseCursor.bAccelTable[] to determine</span>
01536 <span class="comment">* how many pixels to move the mouse cursor on each tick.</span>
01537 <span class="comment">*</span>
01538 <span class="comment">* Return value:</span>
01539 <span class="comment">*    None.</span>
01540 <span class="comment">*</span>
01541 <span class="comment">* History:</span>
01542 <span class="comment">\***************************************************************************/</span>
<a name="l01543"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a30">01543</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a30">xxxMKMoveAccelCursorTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
01544 {
01545     LONG  MovePixels;
01546 
01547     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01548 
01549     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MODIFIERS)) {
01550         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) &amp; <a class="code" href="../../d9/d3/access_8h.html#a29">LRSHIFT</a>) {
01551             MovePixels = 1;
01552             <span class="keywordflow">goto</span> MoveIt;
01553         }
01554         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) &amp; <a class="code" href="../../d9/d3/access_8h.html#a28">LRCONTROL</a>) {
01555             MovePixels = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[0] * <a class="code" href="../../d9/d3/access_8h.html#a38">MK_CONTROL_SPEED</a>;
01556             <span class="keywordflow">goto</span> MoveIt;
01557         }
01558     }
01559 
01560     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a> &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bAccelTableLen) {
01561         MovePixels = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bAccelTable[<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a>++];
01562     } <span class="keywordflow">else</span> {
01563         <span class="comment">//</span>
01564         <span class="comment">// We've reached maximum cruising speed.  Switch to constant table.</span>
01565         <span class="comment">//</span>
01566         MovePixels = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[0];
01567         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a> = 1;
01568         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
01569                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01570                                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a>,
01571                                         <a class="code" href="../../d9/d3/access_8h.html#a36">MOUSETIMERRATE</a>,
01572                                         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a29">xxxMKMoveConstCursorTimer</a>,
01573                                         TMRF_RIT
01574                                         );
01575 
01576     }
01577     <span class="keywordflow">if</span> (MovePixels == 0) {
01578         <span class="keywordflow">return</span>;
01579     }
01580 
01581 MoveIt:
01582     <span class="comment">//</span>
01583     <span class="comment">// We're inside the critical section - leave before calling xxxMoveEvent.</span>
01584     <span class="comment">// Set gbMouseMoved to TRUE so RawInputThread wakes up the appropriate</span>
01585     <span class="comment">// user thread (if any) to receive this event.</span>
01586     <span class="comment">//</span>
01587     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01588     <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(MovePixels * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a56">gMKDeltaX</a>, MovePixels * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a57">gMKDeltaY</a>, 0, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01589     <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(0, 0, 0, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01590 
01591     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01592 
01593     <span class="keywordflow">return</span>;
01594 
01595     UNREFERENCED_PARAMETER(pwnd);
01596     UNREFERENCED_PARAMETER(message);
01597     UNREFERENCED_PARAMETER(nID);
01598     UNREFERENCED_PARAMETER(lParam);
01599 }
01600 
01601 <span class="comment">/***************************************************************************\</span>
01602 <span class="comment">* xxxMKMouseMove</span>
01603 <span class="comment">*</span>
01604 <span class="comment">* Send a mouse move event.  A timer routine is set to handle the mouse</span>
01605 <span class="comment">* cursor acceleration.  The timer will be set on the first make of a</span>
01606 <span class="comment">* mouse move key if FilterKeys repeat rate is OFF.  Otherwise, the timer</span>
01607 <span class="comment">* is set on the first repeat (typematic make) of the mouse move key.</span>
01608 <span class="comment">* Once the timer is set the timer routine handles all mouse movement</span>
01609 <span class="comment">* until the key is released or a new key is pressed.</span>
01610 <span class="comment">*</span>
01611 <span class="comment">* Return value:</span>
01612 <span class="comment">*    Always FALSE - key should not be passed on.</span>
01613 <span class="comment">*</span>
01614 <span class="comment">* History:</span>
01615 <span class="comment">\***************************************************************************/</span>
<a name="l01616"></a><a class="code" href="../../d9/d3/access_8h.html#a64">01616</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a64">xxxMKMouseMove</a>(USHORT Data)
01617 {
01618 
01619 
01620     <span class="comment">/*</span>
01621 <span class="comment">     * Let the mouse acceleration timer routine handle repeats.</span>
01622 <span class="comment">     */</span>
01623     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> != 0)) {
01624         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01625     }
01626 
01627 
01628     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a56">gMKDeltaX</a> = (LONG)((<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Data));   <span class="comment">// Force sign extension</span>
01629     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a57">gMKDeltaY</a> = (LONG)((<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(Data));   <span class="comment">// Force sign extension</span>
01630 
01631     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
01632 
01633     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MODIFIERS) &amp;&amp; ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) &amp; <a class="code" href="../../d9/d3/access_8h.html#a28">LRCONTROL</a>))) {
01634         <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a56">gMKDeltaX</a> * <a class="code" href="../../d9/d3/access_8h.html#a38">MK_CONTROL_SPEED</a> * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[0], <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a57">gMKDeltaY</a> * <a class="code" href="../../d9/d3/access_8h.html#a38">MK_CONTROL_SPEED</a> * <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[0], 0, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01635     } <span class="keywordflow">else</span> {
01636         <a class="code" href="../../d4/d1/userk_8h.html#a1028">xxxMoveEvent</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a56">gMKDeltaX</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a57">gMKDeltaY</a>, 0, 0, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01637     }
01638 
01639     <a class="code" href="../../d4/d1/userk_8h.html#a1033">QueueMouseEvent</a>(0, 0, 0, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>, <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01640 
01641     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
01642 
01643     <span class="comment">/*</span>
01644 <span class="comment">     * If the repeat rate is zero we'll start the mouse acceleration</span>
01645 <span class="comment">     * immediately.  Otherwise we wait until after the first repeat</span>
01646 <span class="comment">     * of the mouse movement key.</span>
01647 <span class="comment">     */</span>
01648     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec || <a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>)) {
01649         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a58">giMouseMoveTable</a> = 0;
01650         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
01651                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01652                                         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a>,
01653                                         <a class="code" href="../../d9/d3/access_8h.html#a36">MOUSETIMERRATE</a>,
01654                                         (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bAccelTableLen) ?
01655                                             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a30">xxxMKMoveAccelCursorTimer</a> :
01656                                             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a29">xxxMKMoveConstCursorTimer</a>,
01657                                         TMRF_RIT
01658                                         );
01659     }
01660     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01661 }
01662 
01663 <span class="comment">/***************************************************************************\</span>
01664 <span class="comment">* xxxMKButtonSetState</span>
01665 <span class="comment">*</span>
01666 <span class="comment">* Set the active mouse button(s) to the state specified by fButtonUp</span>
01667 <span class="comment">* (if fButtonUp is TRUE then the button is released, o.w. the button</span>
01668 <span class="comment">*  is pressed).</span>
01669 <span class="comment">*</span>
01670 <span class="comment">* Return value:</span>
01671 <span class="comment">*    Always FALSE - key should not be passed on.</span>
01672 <span class="comment">*</span>
01673 <span class="comment">* History:</span>
01674 <span class="comment">\***************************************************************************/</span>
<a name="l01675"></a><a class="code" href="../../d9/d3/access_8h.html#a65">01675</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a65">xxxMKButtonSetState</a>(USHORT fButtonUp)
01676 {
01677     WORD NewButtonState;
01678 
01679     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01680     <span class="keywordflow">if</span> (fButtonUp) {
01681         NewButtonState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; ~<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a>;
01682     } <span class="keywordflow">else</span> {
01683         NewButtonState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a>;
01684     }
01685 
01686     <span class="keywordflow">if</span> ((NewButtonState &amp; <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>) != (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; <a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>)) {
01687         <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(<a class="code" href="../../d9/d3/access_8h.html#a24">MOUSE_BUTTON_LEFT</a>,
01688                        <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>,
01689                        fButtonUp,
01690                        <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(),
01691                        0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01692                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01693                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01694     }
01695     <span class="keywordflow">if</span> ((NewButtonState &amp; <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>) != (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> &amp; <a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>)) {
01696         <a class="code" href="../../d4/d1/userk_8h.html#a1027">xxxButtonEvent</a>(<a class="code" href="../../d9/d3/access_8h.html#a25">MOUSE_BUTTON_RIGHT</a>,
01697                        <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a79">gptCursorAsync</a>,
01698                        fButtonUp,
01699                        <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>(),
01700                        0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01701                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01702                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01703     }
01704     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a53">gwMKButtonState</a> = NewButtonState;
01705 
01706     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_MOUSEKEYS );
01707 
01708     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01709 }
01710 
01711 <span class="comment">/***************************************************************************\</span>
01712 <span class="comment">* MKButtonSelect</span>
01713 <span class="comment">*</span>
01714 <span class="comment">* Mark ThisButton as the active mouse button.  It's possible to select both</span>
01715 <span class="comment">* the left and right mouse buttons as active simultaneously.</span>
01716 <span class="comment">*</span>
01717 <span class="comment">* Return value:</span>
01718 <span class="comment">*    Always FALSE - key should not be passed on.</span>
01719 <span class="comment">*</span>
01720 <span class="comment">* History:</span>
01721 <span class="comment">\***************************************************************************/</span>
<a name="l01722"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a33">01722</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a66">MKButtonSelect</a>(WORD ThisButton)
01723 {
01724     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a54">gwMKCurrentButton</a> = ThisButton;
01725 
01726     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_MOUSEKEYS );
01727     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01728 }
01729 
01730 <span class="comment">/***************************************************************************\</span>
01731 <span class="comment">* xxxMKButtonDoubleClick</span>
01732 <span class="comment">*</span>
01733 <span class="comment">* Double click the active mouse button.</span>
01734 <span class="comment">*</span>
01735 <span class="comment">* Return value:</span>
01736 <span class="comment">*    Always FALSE - key should not be passed on.</span>
01737 <span class="comment">*</span>
01738 <span class="comment">* History:</span>
01739 <span class="comment">\***************************************************************************/</span>
<a name="l01740"></a><a class="code" href="../../d9/d3/access_8h.html#a67">01740</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a67">xxxMKButtonDoubleClick</a>(USHORT NotUsed)
01741 {
01742     <a class="code" href="../../d9/d3/access_8h.html#a63">xxxMKButtonClick</a>(0);
01743     <a class="code" href="../../d9/d3/access_8h.html#a63">xxxMKButtonClick</a>(0);
01744     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01745 
01746     UNREFERENCED_PARAMETER(NotUsed);
01747 }
01748 
<a name="l01749"></a><a class="code" href="../../d9/d3/access_8h.html#a46">01749</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a46">HighContrastHotKey</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NotUsed) {
01750     <span class="keywordtype">int</span> CurrentModState;
01751     <span class="keywordtype">int</span> fBreak;
01752     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
01753 
01754 
01755     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01756 
01757     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(pKeyEvent-&gt;usFlaggedVk &amp; 0xff);
01758     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
01759     CurrentModState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
01760 
01761     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON)) {
01762         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HOTKEYACTIVE) &amp;&amp; Vk == VK_SNAPSHOT &amp;&amp; !fBreak &amp;&amp; CurrentModState == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a>) {
01763 
01764             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, MKF_HOTKEYSOUND)) {
01765                 <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01766                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01767                     pTerm,
01768                     <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>);
01769             }
01770 
01771             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_HIGHCONTRAST);
01772 
01773             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01774         }
01775     } <span class="keywordflow">else</span> {
01776         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HOTKEYACTIVE) &amp;&amp; Vk == VK_SNAPSHOT &amp;&amp; !fBreak &amp;&amp; CurrentModState == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a>) {
01777 
01778             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON);
01779 
01780                         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, MKF_HOTKEYSOUND)) {
01781                 <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01782                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01783                     pTerm,
01784                     <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
01785             }
01786 
01787             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01788 
01789             <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
01790                          LOGON_ACCESSNOTIFY, ACCESS_HIGHCONTRASTOFF);
01791             }
01792         }
01793     }
01794     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// send key event to next accessibility routine.</span>
01795     UNREFERENCED_PARAMETER(NotUsed);
01796     UNREFERENCED_PARAMETER(ExtraInformation);
01797 }
01798 
01799 
01800 <span class="comment">/***************************************************************************\</span>
01801 <span class="comment">* MouseKeys</span>
01802 <span class="comment">*</span>
01803 <span class="comment">* This is the strategy routine that gets called as part of the input stream</span>
01804 <span class="comment">* processing.  MouseKeys enabling/disabling is handled here.  All MouseKeys</span>
01805 <span class="comment">* helper routines are called from this routine.</span>
01806 <span class="comment">*</span>
01807 <span class="comment">* Return value:</span>
01808 <span class="comment">*    TRUE  - key event should be passed on to the next access routine.</span>
01809 <span class="comment">*    FALSE - key event was processed and should not be passed on.</span>
01810 <span class="comment">*</span>
01811 <span class="comment">* History:</span>
01812 <span class="comment">\***************************************************************************/</span>
<a name="l01813"></a><a class="code" href="../../d9/d3/access_8h.html#a44">01813</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a44">MouseKeys</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NotUsed)
01814 {
01815     <span class="keywordtype">int</span> CurrentModState;
01816     <span class="keywordtype">int</span> fBreak;
01817     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
01818     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> FlaggedVk;
01819     <span class="keywordtype">int</span> i;
01820 
01821     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
01822     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(pKeyEvent-&gt;usFlaggedVk &amp; 0xff);
01823     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
01824     CurrentModState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
01825 
01826     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)) {
01827         <span class="comment">//</span>
01828         <span class="comment">// MouseKeys currently disabled.  Check for enabling sequence:</span>
01829         <span class="comment">//   left Shift + left Alt + Num Lock.</span>
01830         <span class="comment">//</span>
01831 <span class="preprocessor">#ifdef FE_SB // MouseKeys()</span>
01832 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYACTIVE) &amp;&amp; Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a> &amp;&amp; !fBreak &amp;&amp; CurrentModState == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a>) {
01833 <span class="preprocessor">#else  // FE_SB</span>
01834 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYACTIVE) &amp;&amp; Vk == VK_NUMLOCK &amp;&amp; !fBreak &amp;&amp; CurrentModState == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a>) {
01835 <span class="preprocessor">#endif // FE_SB</span>
01836 <span class="preprocessor"></span>            <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a169">gMKPreviousVk</a> = Vk;
01837             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYSOUND)) {
01838                 <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
01839                 <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01840                     pTerm,
01841                     <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>);
01842             }
01843             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_MOUSEKEYS);
01844 
01845             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01846         }
01847     } <span class="keywordflow">else</span> {
01848         <span class="comment">//</span>
01849         <span class="comment">// Is this a MouseKey key?</span>
01850         <span class="comment">//</span>
01851         <span class="comment">//</span>
01852         FlaggedVk = Vk | (pKeyEvent-&gt;usFlaggedVk &amp; KBDEXT);
01853         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a5">cMouseVKeys</a>; i++) {
01854 <span class="preprocessor">#ifdef FE_SB // MouseKeys()</span>
01855 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (FlaggedVk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a261">gpusMouseVKey</a>[i]) {
01856 <span class="preprocessor">#else  // FE_SB</span>
01857 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (FlaggedVk == <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a4">ausMouseVKey</a>[i]) {
01858 <span class="preprocessor">#endif // FE_SB</span>
01859 <span class="preprocessor"></span>                <span class="keywordflow">break</span>;
01860             }
01861         }
01862 
01863         <span class="keywordflow">if</span> (i == <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a5">cMouseVKeys</a>) {
01864             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;          <span class="comment">// not a mousekey</span>
01865         }
01866         <span class="comment">//</span>
01867         <span class="comment">// Check to see if we should pass on key events until Num Lock is</span>
01868         <span class="comment">// entered.</span>
01869         <span class="comment">//</span>
01870 
01871         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a>) {
01872 <span class="preprocessor">#ifdef FE_SB // MouseKeys()</span>
01873 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vk != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) {
01874 <span class="preprocessor">#else  // FE_SB</span>
01875 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vk != VK_NUMLOCK) {
01876 <span class="preprocessor">#endif // FE_SB</span>
01877 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01878             }
01879         }
01880 
01881         <span class="comment">//</span>
01882         <span class="comment">// Check for Ctrl-Alt-Numpad Del.  Pass key event on if sequence</span>
01883         <span class="comment">// detected.</span>
01884         <span class="comment">//</span>
01885         <span class="keywordflow">if</span> (Vk == VK_DELETE &amp;&amp; CurrentModState &amp; <a class="code" href="../../d9/d3/access_8h.html#a27">LRALT</a> &amp;&amp; CurrentModState &amp; <a class="code" href="../../d9/d3/access_8h.html#a28">LRCONTROL</a>) {
01886             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01887         }
01888         <span class="keywordflow">if</span> (fBreak) {
01889             <span class="comment">//</span>
01890             <span class="comment">// If this is a break of the key that we're accelerating then</span>
01891             <span class="comment">// kill the timer.</span>
01892             <span class="comment">//</span>
01893             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a169">gMKPreviousVk</a> == Vk) {
01894                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> != 0) {
01895                     <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a>);
01896                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> = 0;
01897                 }
01898                 <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>);
01899                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a169">gMKPreviousVk</a> = 0;
01900             }
01901             <span class="comment">//</span>
01902             <span class="comment">// Pass break of Numlock along.  Other mousekeys stop here.</span>
01903             <span class="comment">//</span>
01904 <span class="preprocessor">#ifdef FE_SB // MouseKeys()</span>
01905 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) {
01906 <span class="preprocessor">#else  // FE_SB</span>
01907 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Vk == VK_NUMLOCK) {
01908 <span class="preprocessor">#endif // FE_SB</span>
01909 <span class="preprocessor"></span>                <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01910             } <span class="keywordflow">else</span> {
01911                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01912             }
01913         } <span class="keywordflow">else</span> {
01914             <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>,
01915                               (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a169">gMKPreviousVk</a> == Vk));
01916             <span class="comment">//</span>
01917             <span class="comment">// If this is not a typematic repeat, kill the mouse acceleration</span>
01918             <span class="comment">// timer.</span>
01919             <span class="comment">//</span>
01920             <span class="keywordflow">if</span> ((!<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>)) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a>)) {
01921                 <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a>);
01922                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a55">gtmridMKMoveCursor</a> = 0;
01923             }
01924             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a169">gMKPreviousVk</a> = Vk;
01925         }
01926         <span class="keywordflow">return</span> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a6">aMouseKeyEvent</a>[i](<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a7">ausMouseKeyData</a>[i]);
01927     }
01928     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01929 
01930     UNREFERENCED_PARAMETER(NotUsed);
01931     UNREFERENCED_PARAMETER(ExtraInformation);
01932 
01933 }
01934 
01935 <span class="comment">/***************************************************************************\</span>
01936 <span class="comment">* TurnOffMouseKeys</span>
01937 <span class="comment">*</span>
01938 <span class="comment">* Return value:</span>
01939 <span class="comment">*    None.</span>
01940 <span class="comment">*</span>
01941 <span class="comment">* History:</span>
01942 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
01943 <span class="comment">\***************************************************************************/</span>
<a name="l01944"></a><a class="code" href="../../d9/d3/access_8h.html#a62">01944</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a62">TurnOffMouseKeys</a>(VOID)
01945 {
01946     <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON);
01947 <span class="comment">//    gMKPassThrough = 0;</span>
01948     <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a633">ACCF_MKREPEATVK</a>);
01949     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a26">MKHideMouseCursor</a>();
01950     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYSOUND)) {
01951         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
01952             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>,
01953             <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
01954     }
01955     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_MOUSEKEYS );
01956 }
01957 
01958 
01959 <span class="comment">/***************************************************************************\</span>
01960 <span class="comment">* CalculateMouseTable</span>
01961 <span class="comment">*</span>
01962 <span class="comment">* Set mouse table based on time to max speed and max speed.  This routine</span>
01963 <span class="comment">* is called during user logon (after the registry entries for the access</span>
01964 <span class="comment">* features are read).</span>
01965 <span class="comment">*</span>
01966 <span class="comment">* Return value:</span>
01967 <span class="comment">*    None.</span>
01968 <span class="comment">*</span>
01969 <span class="comment">* History:</span>
01970 <span class="comment">*    Taken from access utility.</span>
01971 <span class="comment">*</span>
01972 <span class="comment">****************************************************************************/</span>
<a name="l01973"></a><a class="code" href="../../d9/d3/access_8h.html#a71">01973</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a71">CalculateMouseTable</a>(VOID)
01974 {
01975     <span class="keywordtype">long</span>    Total_Distance;         <span class="comment">/* in 1000th of pixel */</span>
01976 
01977     <span class="keywordtype">long</span>    Accel_Per_Tick;         <span class="comment">/* in 1000th of pixel/tick */</span>
01978     <span class="keywordtype">long</span>    Current_Speed;          <span class="comment">/* in 1000th of pixel/tick */</span>
01979     <span class="keywordtype">long</span>    Max_Speed;              <span class="comment">/* in 1000th of pixel/tick */</span>
01980     <span class="keywordtype">long</span>    Real_Total_Distance;    <span class="comment">/* in pixels */</span>
01981     <span class="keywordtype">long</span>    Real_Delta_Distance;    <span class="comment">/* in pixels */</span>
01982     <span class="keywordtype">int</span>     i;
01983     <span class="keywordtype">int</span>     Num_Constant_Table,Num_Accel_Table;
01984 
01985 
01986     Max_Speed = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.iMaxSpeed;
01987     Max_Speed *= 1000 / <a class="code" href="../../d9/d3/access_8h.html#a37">MOUSETICKS</a>;
01988 
01989     Accel_Per_Tick = Max_Speed * 1000 / (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.iTimeToMaxSpeed * <a class="code" href="../../d9/d3/access_8h.html#a37">MOUSETICKS</a>);
01990     Current_Speed = 0;
01991     Total_Distance = 0;
01992     Real_Total_Distance = 0;
01993     Num_Constant_Table = 0;
01994     Num_Accel_Table = 0;
01995 
01996     <span class="keywordflow">for</span>(i=0; i&lt;= 255; i++) {
01997         Current_Speed = Current_Speed + Accel_Per_Tick;
01998         <span class="keywordflow">if</span> (Current_Speed &gt; Max_Speed) {
01999             Current_Speed = Max_Speed;
02000         }
02001         Total_Distance += Current_Speed;
02002 
02003         <span class="comment">//</span>
02004         <span class="comment">// Calculate how many pixels to move on this tick</span>
02005         <span class="comment">//</span>
02006         Real_Delta_Distance = ((Total_Distance - (Real_Total_Distance * 1000)) + 500) / 1000 ;
02007         <span class="comment">//</span>
02008         <span class="comment">// Calculate total distance moved up to this point</span>
02009         <span class="comment">//</span>
02010         Real_Total_Distance = Real_Total_Distance + Real_Delta_Distance;
02011 
02012         <span class="keywordflow">if</span> ((Current_Speed &lt; Max_Speed) &amp;&amp; (Num_Accel_Table &lt; 128)) {
02013             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bAccelTable[Num_Accel_Table++] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Real_Delta_Distance;
02014         }
02015 
02016         <span class="keywordflow">if</span> ((Current_Speed == Max_Speed) &amp;&amp; (Num_Constant_Table &lt; 128)) {
02017             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTable[Num_Constant_Table++] = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Real_Delta_Distance;
02018         }
02019 
02020     }
02021     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bAccelTableLen = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Num_Accel_Table;
02022     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a61">gMouseCursor</a>.bConstantTableLen = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Num_Constant_Table;
02023 }
02024 
02025 
02026 <span class="comment">/***************************************************************************\</span>
02027 <span class="comment">* xxxToggleKeysTimer</span>
02028 <span class="comment">*</span>
02029 <span class="comment">* Enable ToggleKeys if it is currently disabled.  Disable ToggleKeys if it</span>
02030 <span class="comment">* is currently enabled.</span>
02031 <span class="comment">*</span>
02032 <span class="comment">* This routine is called only when the NumLock key is held down for 5 seconds.</span>
02033 <span class="comment">*</span>
02034 <span class="comment">* Return value:</span>
02035 <span class="comment">*    0</span>
02036 <span class="comment">*</span>
02037 <span class="comment">* History:</span>
02038 <span class="comment">*   11 Feb 93 GregoryW   Created.</span>
02039 <span class="comment">\***************************************************************************/</span>
<a name="l02040"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a39">02040</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a39">xxxToggleKeysTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
02041 {
02042     KE ToggleKeyEvent;
02043     <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
02044 
02045     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02046     <span class="comment">//</span>
02047     <span class="comment">// Toggle ToggleKeys and provide audible feedback if appropriate.</span>
02048     <span class="comment">//</span>
02049     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON)) {
02050         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON);
02051         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_HOTKEYSOUND)) {
02052             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
02053                     pTerm,
02054                     <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
02055         }
02056     } <span class="keywordflow">else</span> {
02057         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_HOTKEYSOUND)) {
02058             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
02059                     pTerm,
02060                     <a class="code" href="../../d4/d1/userk_8h.html#a351">RITSOUND_UPSIREN</a>);
02061         }
02062 
02063         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_TOGGLEKEYS);
02064     }
02065     <span class="comment">//</span>
02066     <span class="comment">// Send a fake break/make combination so state of numlock key remains</span>
02067     <span class="comment">// the same as it was before user pressed it to activate/deactivate</span>
02068     <span class="comment">// ToggleKeys.</span>
02069     <span class="comment">//</span>
02070     ToggleKeyEvent.bScanCode = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a168">gTKScanCode</a>;
02071 <span class="preprocessor">#ifdef FE_SB // ToggleKeysTimer()</span>
02072 <span class="preprocessor"></span>    ToggleKeyEvent.usFlaggedVk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a> | KBDBREAK;
02073 <span class="preprocessor">#else</span>
02074 <span class="preprocessor"></span>    ToggleKeyEvent.usFlaggedVk = VK_NUMLOCK | KBDBREAK;
02075 <span class="preprocessor">#endif // FE_SB</span>
02076 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(&amp;ToggleKeyEvent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a51">gTKNextProcIndex</a>)) {
02077         <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ToggleKeyEvent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02078     }
02079 <span class="preprocessor">#ifdef FE_SB // ToggleKeysTimer()</span>
02080 <span class="preprocessor"></span>    ToggleKeyEvent.usFlaggedVk = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>;
02081 <span class="preprocessor">#else</span>
02082 <span class="preprocessor"></span>    ToggleKeyEvent.usFlaggedVk = VK_NUMLOCK;
02083 <span class="preprocessor">#endif // FE_SB</span>
02084 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a48">AccessProceduresStream</a>(&amp;ToggleKeyEvent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a51">gTKNextProcIndex</a>)) {
02085         <a class="code" href="../../d4/d1/userk_8h.html#a1026">xxxProcessKeyEvent</a>(&amp;ToggleKeyEvent, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02086     }
02087     <span class="keywordflow">return</span>;
02088 
02089     UNREFERENCED_PARAMETER(pwnd);
02090     UNREFERENCED_PARAMETER(message);
02091     UNREFERENCED_PARAMETER(nID);
02092     UNREFERENCED_PARAMETER(lParam);
02093 }
02094 
02095 
02096 <span class="comment">/***************************************************************************\</span>
02097 <span class="comment">* ToggleKeys</span>
02098 <span class="comment">*</span>
02099 <span class="comment">* This is the strategy routine that gets called as part of the input stream</span>
02100 <span class="comment">* processing.  Keys of interest are Num Lock, Scroll Lock and Caps Lock.</span>
02101 <span class="comment">*</span>
02102 <span class="comment">* Return value:</span>
02103 <span class="comment">*    TRUE - key event should be passed on to the next access routine.</span>
02104 <span class="comment">*    FALSE - key event was processed and should not be passed on.</span>
02105 <span class="comment">*</span>
02106 <span class="comment">* History:</span>
02107 <span class="comment">\***************************************************************************/</span>
<a name="l02108"></a><a class="code" href="../../d9/d3/access_8h.html#a45">02108</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a45">ToggleKeys</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NextProcIndex)
02109 {
02110     <span class="keywordtype">int</span> fBreak;
02111     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
02112 
02113     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02114     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)pKeyEvent-&gt;usFlaggedVk;
02115     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
02116 
02117     <span class="comment">//</span>
02118     <span class="comment">// Check for Numlock key.  On the first make set the ToggleKeys timer.</span>
02119     <span class="comment">// The timer is killed on the break of the Numlock key.</span>
02120     <span class="comment">//</span>
02121     <span class="keywordflow">switch</span> (Vk) {
02122     <span class="keywordflow">case</span> VK_NUMLOCK:
02123 <span class="preprocessor">#ifdef FE_SB // ToggleKeys()</span>
02124 <span class="preprocessor"></span>NumLockProc:
02125 <span class="preprocessor">#endif // FE_SB</span>
02126 <span class="preprocessor"></span>        <span class="comment">/*</span>
02127 <span class="comment">         * Don't handle NUMLOCK toggles if the user is doing MouseKey</span>
02128 <span class="comment">         * toggling.</span>
02129 <span class="comment">         */</span>
02130         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>) == <a class="code" href="../../d9/d3/access_8h.html#a26">MOUSEKEYMODBITS</a> &amp;&amp;
02131                 <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYACTIVE)) {
02132             <span class="keywordflow">break</span>;
02133         }
02134         <span class="keywordflow">if</span> (fBreak)
02135         {
02136             <span class="comment">//</span>
02137             <span class="comment">// Only reset gptmrToggleKeys on the break of NumLock. This</span>
02138             <span class="comment">// prevents cycling the toggle keys state by continually</span>
02139             <span class="comment">// holding down the NumLock key.</span>
02140             <span class="comment">//</span>
02141             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a>);
02142             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a> = 0;
02143             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a> = 0;
02144             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a168">gTKScanCode</a> = 0;
02145         }
02146         <span class="keywordflow">else</span>
02147         {
02148             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a> == 0 &amp;&amp;
02149                 <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_HOTKEYACTIVE))
02150             {
02151 
02152                 <span class="comment">//</span>
02153                 <span class="comment">// Remember key information to be used by timer routine.</span>
02154                 <span class="comment">//</span>
02155                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a50">gTKExtraInformation</a> = ExtraInformation;
02156                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a168">gTKScanCode</a> = pKeyEvent-&gt;bScanCode;
02157                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a51">gTKNextProcIndex</a> = NextProcIndex;
02158                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
02159                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02160                                               0,
02161                                               <a class="code" href="../../d9/d3/access_8h.html#a23">TOGGLEKEYTOGGLETIME</a>,
02162                                               <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a39">xxxToggleKeysTimer</a>,
02163                                               TMRF_RIT | TMRF_ONESHOT
02164                                               );
02165             }
02166         }
02167         <span class="comment">//</span>
02168         <span class="comment">// If MouseKeys is on, audible feedback has already occurred for this</span>
02169         <span class="comment">// keystroke.  Skip the rest of the processing.</span>
02170         <span class="comment">//</span>
02171         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)) {
02172             <span class="keywordflow">break</span>;
02173         }
02174         <span class="comment">// fall through</span>
02175 
02176     <span class="keywordflow">case</span> VK_SCROLL:
02177     <span class="keywordflow">case</span> VK_CAPITAL:
02178 <span class="preprocessor">#ifdef FE_SB // ToggleKeys()</span>
02179 <span class="preprocessor"></span>CapitalProc:
02180 <span class="preprocessor">#endif // FE_SB</span>
02181 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON) &amp;&amp; !fBreak) {
02182             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a843">TestAsyncKeyStateDown</a>(Vk)) {
02183                 <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
02184                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(Vk)) {
02185                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
02186                         pTerm,
02187                         <a class="code" href="../../d4/d1/userk_8h.html#a354">RITSOUND_HIGHBEEP</a>);
02188                 } <span class="keywordflow">else</span> {
02189                     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
02190                         pTerm,
02191                         <a class="code" href="../../d4/d1/userk_8h.html#a353">RITSOUND_LOWBEEP</a>);
02192                 }
02193             }
02194         }
02195         <span class="keywordflow">break</span>;
02196 
02197     <span class="keywordflow">default</span>:
02198 <span class="preprocessor">#ifdef FE_SB // ToggleKeys()</span>
02199 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) <span class="keywordflow">goto</span> NumLockProc;
02200         <span class="keywordflow">if</span> (Vk == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a263">gOemScrollVk</a>) <span class="keywordflow">goto</span> CapitalProc;
02201 <span class="preprocessor">#endif // FE_SB</span>
02202 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a> != 0) {
02203             <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a49">gtmridToggleKeys</a>);
02204         }
02205     }
02206 
02207     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02208 }
02209 
02210 
02211 <span class="comment">/***************************************************************************\</span>
02212 <span class="comment">* AccessTimeOutTimer</span>
02213 <span class="comment">*</span>
02214 <span class="comment">* This routine is called if no keyboard activity takes place for the</span>
02215 <span class="comment">* user configured amount of time.  All access related functions are</span>
02216 <span class="comment">* disabled.</span>
02217 <span class="comment">*</span>
02218 <span class="comment">* This routine is called with the critical section already locked.</span>
02219 <span class="comment">*</span>
02220 <span class="comment">* Return value:</span>
02221 <span class="comment">*    0</span>
02222 <span class="comment">*</span>
02223 <span class="comment">* History:</span>
02224 <span class="comment">\***************************************************************************/</span>
<a name="l02225"></a><a class="code" href="../../d9/d3/access_8h.html#a73">02225</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a73">xxxAccessTimeOutTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)
02226 {
02227     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02228     <span class="comment">/*</span>
02229 <span class="comment">     * The timeout timer will remain on (if so configured) as long as</span>
02230 <span class="comment">     * TEST_ACCF(ACCF_ACCESSENABLED) is TRUE.  This means we might get timeouts when</span>
02231 <span class="comment">     * only hot keys are enabled, but no features are actually on.  Don't</span>
02232 <span class="comment">     * provide any audible feedback in this case.</span>
02233 <span class="comment">     */</span>
02234     <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON)   ||
02235             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)   ||
02236             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)     ||
02237             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON)   ||
02238             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(SoundSentry, SSF_SOUNDSENTRYON) ||
02239             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON) ||
02240             <a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>)) {
02241 
02242         <a class="code" href="../../d1/d8/structtagTERMINAL.html">PTERMINAL</a> pTerm = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o3">rpwinstaParent</a>-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o2">pTerm</a>;
02243         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON);
02244         <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>();
02245         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON);
02246         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON);
02247         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(SoundSentry, SSF_SOUNDSENTRYON);
02248         <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>);
02249         <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON);
02250 
02251         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02252 
02253         <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a17">gspwndLogonNotify</a>, WM_LOGONNOTIFY,
02254                      LOGON_ACCESSNOTIFY, ACCESS_HIGHCONTRASTOFF);
02255         }
02256 
02257         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(AccessTimeOut, ATF_ONOFFFEEDBACK)) {
02258             <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a9">PostRitSound</a>(
02259                     pTerm,
02260                     <a class="code" href="../../d4/d1/userk_8h.html#a352">RITSOUND_DOWNSIREN</a>);
02261         }
02262         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_MOUSEKEYS );
02263 
02264         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_FILTERKEYS );
02265 
02266         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a10">PostAccessibility</a>( ACCESS_STICKYKEYS );
02267 
02268     }
02269     <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02270     <span class="keywordflow">return</span>;
02271 
02272 
02273     UNREFERENCED_PARAMETER(pwnd);
02274     UNREFERENCED_PARAMETER(message);
02275     UNREFERENCED_PARAMETER(nID);
02276     UNREFERENCED_PARAMETER(lParam);
02277 }
02278 
02279 <span class="comment">/***************************************************************************\</span>
02280 <span class="comment">* AccessTimeOutReset</span>
02281 <span class="comment">*</span>
02282 <span class="comment">* This routine resets the timeout timer.</span>
02283 <span class="comment">*</span>
02284 <span class="comment">* Return value:</span>
02285 <span class="comment">*    0</span>
02286 <span class="comment">*</span>
02287 <span class="comment">* History:</span>
02288 <span class="comment">\***************************************************************************/</span>
<a name="l02289"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a42">02289</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a42">AccessTimeOutReset</a>()
02290 {
02291 
02292     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a> != 0) {
02293         <a class="code" href="../../d4/d1/userk_8h.html#a499">KILLRITTIMER</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a>);
02294     }
02295     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON)) {
02296         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a52">gtmridAccessTimeOut</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
02297                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02298                                          0,
02299                                          (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.iTimeOutMSec,
02300                                          <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a41">xxxAccessTimeOutTimer</a>,
02301                                          TMRF_RIT | TMRF_ONESHOT
02302                                          );
02303     }
02304 }
02305 
02306 <span class="comment">/***************************************************************************\</span>
02307 <span class="comment">* xxxUpdatePerUserAccessPackSettings</span>
02308 <span class="comment">*</span>
02309 <span class="comment">* Sets the initial access pack features according to the user's profile.</span>
02310 <span class="comment">*</span>
02311 <span class="comment">* 02-14-93 GregoryW        Created.</span>
02312 <span class="comment">\***************************************************************************/</span>
02313 <span class="keywordtype">void</span>
<a name="l02314"></a><a class="code" href="../../d4/d1/userk_8h.html#a1853">02314</a> <a class="code" href="../../d4/d1/userk_8h.html#a1853">xxxUpdatePerUserAccessPackSettings</a>(PUNICODE_STRING pProfileUserName)
02315 {
02316     LUID luidCaller;
02317     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02318     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02319     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegFilterKeysOn;
02320     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegStickyKeysOn;
02321     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegMouseKeysOn;
02322     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegToggleKeysOn;
02323     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegTimeOutOn;
02324     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegKeyboardPref;
02325     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegScreenReader;
02326     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fRegHighContrastOn;
02327     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDefFlags;
02328     UNICODE_STRING usHighContrastScheme;
02329     WCHAR wcHighContrastScheme[MAX_SCHEME_NAME_SIZE];
02330 
02331     status = <a class="code" href="../../d4/d1/userk_8h.html#a961">GetProcessLuid</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;luidCaller);
02332     <span class="comment">//</span>
02333     <span class="comment">// If we're called in the system context no one is logged on.</span>
02334     <span class="comment">// We want to read the current .DEFAULT settings for the access</span>
02335     <span class="comment">// features.  Later when we're called in the user context (e.g.,</span>
02336     <span class="comment">// someone has successfully logged on) we check to see if the</span>
02337     <span class="comment">// current access state is the same as the default setting.  If</span>
02338     <span class="comment">// not, the user has enabled/disabled one or more access features</span>
02339     <span class="comment">// from the keyboard.  These changes will be propagated across</span>
02340     <span class="comment">// the logon into the user's intial state (overriding the settings</span>
02341     <span class="comment">// in the user's profile).</span>
02342     <span class="comment">//</span>
02343     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;luidCaller, &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a244">luidSystem</a>)) {
02344         fSystem = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02345     }
02346 
02347 
02348 
02349     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02350                      <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02351                      TEXT(<span class="stringliteral">"Flags"</span>),
02352                      0
02353                      );
02354     fRegFilterKeysOn = (dwDefFlags &amp; FKF_FILTERKEYSON) != 0;
02355 
02356     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02357                      <a class="code" href="../../d4/d1/userk_8h.html#a709">PMAP_STICKYKEYS</a>,
02358                      TEXT(<span class="stringliteral">"Flags"</span>),
02359                      0
02360                      );
02361     fRegStickyKeysOn = (dwDefFlags &amp; SKF_STICKYKEYSON) != 0;
02362 
02363     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02364                      <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
02365                      TEXT(<span class="stringliteral">"Flags"</span>),
02366                      0
02367                      );
02368     fRegMouseKeysOn = (dwDefFlags &amp; MKF_MOUSEKEYSON) != 0;
02369 
02370     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02371                      <a class="code" href="../../d4/d1/userk_8h.html#a712">PMAP_TOGGLEKEYS</a>,
02372                      TEXT(<span class="stringliteral">"Flags"</span>),
02373                      0
02374                      );
02375     fRegToggleKeysOn = (dwDefFlags &amp; TKF_TOGGLEKEYSON) != 0;
02376 
02377     fRegKeyboardPref = !!<a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02378                      <a class="code" href="../../d4/d1/userk_8h.html#a722">PMAP_KEYBOARDPREF</a>,
02379                      TEXT(<span class="stringliteral">"On"</span>),
02380                      0
02381                      );
02382 
02383     fRegScreenReader = !!<a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02384                      <a class="code" href="../../d4/d1/userk_8h.html#a723">PMAP_SCREENREADER</a>,
02385                      TEXT(<span class="stringliteral">"On"</span>),
02386                      0
02387                      );
02388 
02389     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02390                      <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
02391                      TEXT(<span class="stringliteral">"Flags"</span>),
02392                      0
02393                      );
02394     fRegTimeOutOn = (dwDefFlags &amp; ATF_TIMEOUTON) != 0;
02395 
02396     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02397                      <a class="code" href="../../d4/d1/userk_8h.html#a724">PMAP_HIGHCONTRAST</a>,
02398                      TEXT(<span class="stringliteral">"Flags"</span>),
02399                      0
02400                      );
02401     fRegHighContrastOn = (dwDefFlags &amp; HCF_HIGHCONTRASTON) != 0;
02402 
02403     <span class="keywordflow">if</span> (fSystem) {
02404         <span class="comment">//</span>
02405         <span class="comment">// We're in system mode (e.g., no one is logged in).  Remember</span>
02406         <span class="comment">// the .DEFAULT state for comparison during the next user logon</span>
02407         <span class="comment">// and set the current state to the .DEFAULT state.</span>
02408         <span class="comment">//</span>
02409         <span class="keywordflow">if</span> (fRegFilterKeysOn) {
02410             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a621">ACCF_DEFAULTFILTERKEYSON</a>);
02411             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON);
02412         } <span class="keywordflow">else</span> {
02413             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a621">ACCF_DEFAULTFILTERKEYSON</a>);
02414             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON);
02415         }
02416 
02417         <span class="comment">//</span>
02418         <span class="comment">// If StickyKeys is currently on and we're about to turn it</span>
02419         <span class="comment">// off we need to make sure the latch keys and lock keys are</span>
02420         <span class="comment">// released.</span>
02421         <span class="comment">//</span>
02422         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON) &amp;&amp; (fRegFilterKeysOn == 0)) {
02423                 <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>();
02424         }
02425 
02426         <span class="keywordflow">if</span> (fRegStickyKeysOn) {
02427             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a622">ACCF_DEFAULTSTICKYKEYSON</a>);
02428             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
02429         } <span class="keywordflow">else</span> {
02430             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a622">ACCF_DEFAULTSTICKYKEYSON</a>);
02431             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON);
02432         }
02433 
02434         <span class="keywordflow">if</span> (fRegMouseKeysOn) {
02435             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a623">ACCF_DEFAULTMOUSEKEYSON</a>);
02436             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON);
02437         } <span class="keywordflow">else</span> {
02438             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a623">ACCF_DEFAULTMOUSEKEYSON</a>);
02439             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON);
02440         }
02441 
02442         <span class="keywordflow">if</span> (fRegToggleKeysOn) {
02443             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a624">ACCF_DEFAULTTOGGLEKEYSON</a>);
02444             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON);
02445         } <span class="keywordflow">else</span> {
02446             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a624">ACCF_DEFAULTTOGGLEKEYSON</a>);
02447             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON);
02448         }
02449 
02450         <span class="keywordflow">if</span> (fRegTimeOutOn) {
02451             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a625">ACCF_DEFAULTTIMEOUTON</a>);
02452             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON);
02453         } <span class="keywordflow">else</span> {
02454             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a625">ACCF_DEFAULTTIMEOUTON</a>);
02455             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON);
02456         }
02457 
02458         <span class="keywordflow">if</span> (fRegKeyboardPref) {
02459             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a626">ACCF_DEFAULTKEYBOARDPREF</a>);
02460             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>);
02461             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bKeyboardPref = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02462         } <span class="keywordflow">else</span> {
02463             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a626">ACCF_DEFAULTKEYBOARDPREF</a>);
02464             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>);
02465             <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;bKeyboardPref = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02466         }
02467 
02468         <span class="keywordflow">if</span> (fRegScreenReader) {
02469             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a627">ACCF_DEFAULTSCREENREADER</a>);
02470             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>);
02471         } <span class="keywordflow">else</span> {
02472             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a627">ACCF_DEFAULTSCREENREADER</a>);
02473             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>);
02474         }
02475 
02476         <span class="keywordflow">if</span> (fRegHighContrastOn) {
02477             <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a628">ACCF_DEFAULTHIGHCONTRASTON</a>);
02478             <a class="code" href="../../d9/d3/access_8h.html#a2">SET_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON);
02479         } <span class="keywordflow">else</span> {
02480             <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a628">ACCF_DEFAULTHIGHCONTRASTON</a>);
02481             <a class="code" href="../../d9/d3/access_8h.html#a3">CLEAR_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON);
02482         }
02483     } <span class="keywordflow">else</span> {
02484         <span class="comment">//</span>
02485         <span class="comment">// A user has successfully logged on.  If the current state is</span>
02486         <span class="comment">// different from the default state stored earlier then we know</span>
02487         <span class="comment">// the user has modified the state via the keyboard (at the logon</span>
02488         <span class="comment">// dialog).  This state will override whatever on/off state the</span>
02489         <span class="comment">// user has set in their profile.  If the current state is the</span>
02490         <span class="comment">// same as the default state then the on/off setting from the</span>
02491         <span class="comment">// user profile is used.</span>
02492         <span class="comment">//</span>
02493 
02494         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON) ==
02495                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a621">ACCF_DEFAULTFILTERKEYSON</a>)) {
02496             <span class="comment">//</span>
02497             <span class="comment">// Current state and default state are the same.  Use the</span>
02498             <span class="comment">// user's profile setting.</span>
02499             <span class="comment">//</span>
02500 
02501             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON, fRegFilterKeysOn);
02502         }
02503 
02504         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON) ==
02505                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a622">ACCF_DEFAULTSTICKYKEYSON</a>)) {
02506             <span class="comment">//</span>
02507             <span class="comment">// If StickyKeys is currently on and we're about to turn it</span>
02508             <span class="comment">// off we need to make sure the latch keys and lock keys are</span>
02509             <span class="comment">// released.</span>
02510             <span class="comment">//</span>
02511             <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON) &amp;&amp;
02512                     (fRegStickyKeysOn == 0)) {
02513 
02514                 <a class="code" href="../../d9/d3/access_8h.html#a60">xxxTurnOffStickyKeys</a>();
02515             }
02516 
02517             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON, fRegStickyKeysOn);
02518         }
02519 
02520         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON) ==
02521                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a623">ACCF_DEFAULTMOUSEKEYSON</a>)) {
02522             <span class="comment">//</span>
02523             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02524             <span class="comment">// profile setting.</span>
02525             <span class="comment">//</span>
02526             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON, fRegMouseKeysOn);
02527         }
02528 
02529         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON) ==
02530                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a624">ACCF_DEFAULTTOGGLEKEYSON</a>)) {
02531             <span class="comment">//</span>
02532             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02533             <span class="comment">// profile setting.</span>
02534             <span class="comment">//</span>
02535             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON, fRegToggleKeysOn);
02536         }
02537 
02538         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON) ==
02539                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a625">ACCF_DEFAULTTIMEOUTON</a>)) {
02540             <span class="comment">//</span>
02541             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02542             <span class="comment">// profile setting.</span>
02543             <span class="comment">//</span>
02544             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON, fRegTimeOutOn);
02545         }
02546 
02547         <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>) ==
02548                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a626">ACCF_DEFAULTKEYBOARDPREF</a>)) {
02549             <span class="comment">//</span>
02550             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02551             <span class="comment">// profile setting.</span>
02552             <span class="comment">//</span>
02553             <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a637">ACCF_KEYBOARDPREF</a>, fRegKeyboardPref);
02554         }
02555 
02556         <span class="keywordflow">if</span> (    <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>) ==
02557                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a627">ACCF_DEFAULTSCREENREADER</a>)) {
02558             <span class="comment">//</span>
02559             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02560             <span class="comment">// profile setting.</span>
02561             <span class="comment">//</span>
02562             <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a638">ACCF_SCREENREADER</a>, fRegScreenReader);
02563         }
02564 
02565         <span class="keywordflow">if</span> (    <a class="code" href="../../d9/d3/access_8h.html#a1">TEST_BOOL_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON) ==
02566                 <a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a628">ACCF_DEFAULTHIGHCONTRASTON</a>)) {
02567             <span class="comment">//</span>
02568             <span class="comment">// Current state and default state are the same.  Use the user's</span>
02569             <span class="comment">// profile setting.</span>
02570             <span class="comment">//</span>
02571             <a class="code" href="../../d9/d3/access_8h.html#a4">SET_OR_CLEAR_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON, fRegHighContrastOn);
02572         }
02573     }
02574 
02575     <span class="comment">//</span>
02576     <span class="comment">// Get the default FilterKeys state.</span>
02577     <span class="comment">//</span>
02578     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02579     <span class="comment">// #define FKF_FILTERKEYSON    0x00000001           0</span>
02580     <span class="comment">// #define FKF_AVAILABLE       0x00000002           2</span>
02581     <span class="comment">// #define FKF_HOTKEYACTIVE    0x00000004           0</span>
02582     <span class="comment">// #define FKF_CONFIRMHOTKEY   0x00000008           0</span>
02583     <span class="comment">// #define FKF_HOTKEYSOUND     0x00000010          10</span>
02584     <span class="comment">// #define FKF_INDICATOR       0x00000020           0</span>
02585     <span class="comment">// #define FKF_CLICKON         0x00000040          40</span>
02586     <span class="comment">// ----------------------------------------- total = 0x52 = 82</span>
02587     <span class="comment">//</span>
02588 
02589     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02590                      <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02591                      TEXT(<span class="stringliteral">"Flags"</span>),
02592                      82
02593                      );
02594 
02595     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02596             dwDefFlags,
02597             FKF_FILTERKEYSON,
02598             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON));
02599 
02600     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.dwFlags = dwDefFlags;
02601     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iWaitMSec = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02602             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02603             TEXT(<span class="stringliteral">"DelayBeforeAcceptance"</span>),
02604             1000
02605             );
02606 
02607     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iRepeatMSec = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02608             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02609             TEXT(<span class="stringliteral">"AutoRepeatRate"</span>),
02610             500
02611             );
02612 
02613     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iDelayMSec = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02614             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02615             TEXT(<span class="stringliteral">"AutoRepeatDelay"</span>),
02616             1000
02617             );
02618 
02619     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a32">gFilterKeys</a>.iBounceMSec = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02620             <a class="code" href="../../d4/d1/userk_8h.html#a710">PMAP_KEYBOARDRESPONSE</a>,
02621             TEXT(<span class="stringliteral">"BounceTime"</span>),
02622             0
02623             );
02624 
02625     <span class="comment">//</span>
02626     <span class="comment">// Fill in the SoundSentry state.  This release of the</span>
02627     <span class="comment">// accessibility features only supports iWindowsEffect.</span>
02628     <span class="comment">//</span>
02629     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02630     <span class="comment">// #define SSF_SOUNDSENTRYON   0x00000001           0</span>
02631     <span class="comment">// #define SSF_AVAILABLE       0x00000002           1</span>
02632     <span class="comment">// #define SSF_INDICATOR       0x00000004           0</span>
02633     <span class="comment">// ----------------------------------------- total = 0x2 = 2</span>
02634     <span class="comment">//</span>
02635     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.dwFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02636             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
02637             TEXT(<span class="stringliteral">"Flags"</span>),
02638             2
02639             );
02640 
02641     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.iFSTextEffect = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02642             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
02643             TEXT(<span class="stringliteral">"FSTextEffect"</span>),
02644             0
02645             );
02646 
02647     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.iWindowsEffect = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02648             <a class="code" href="../../d4/d1/userk_8h.html#a714">PMAP_SOUNDSENTRY</a>,
02649             TEXT(<span class="stringliteral">"WindowsEffect"</span>),
02650             0
02651             );
02652 
02653     <span class="comment">/*</span>
02654 <span class="comment">     * Set ShowSounds flag.</span>
02655 <span class="comment">     */</span>
02656     <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>, <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02657             <a class="code" href="../../d4/d1/userk_8h.html#a715">PMAP_SHOWSOUNDS</a>,
02658             TEXT(<span class="stringliteral">"On"</span>),
02659             0
02660             ));
02661 
02662     <span class="comment">//</span>
02663     <span class="comment">// Get the default StickyKeys state.</span>
02664     <span class="comment">//</span>
02665     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02666     <span class="comment">// #define SKF_STICKYKEYSON    0x00000001          0</span>
02667     <span class="comment">// #define SKF_AVAILABLE       0x00000002          2</span>
02668     <span class="comment">// #define SKF_HOTKEYACTIVE    0x00000004          0</span>
02669     <span class="comment">// #define SKF_CONFIRMHOTKEY   0x00000008          0</span>
02670     <span class="comment">// #define SKF_HOTKEYSOUND     0x00000010         10</span>
02671     <span class="comment">// #define SKF_INDICATOR       0x00000020          0</span>
02672     <span class="comment">// #define SKF_AUDIBLEFEEDBACK 0x00000040         40</span>
02673     <span class="comment">// #define SKF_TRISTATE        0x00000080         80</span>
02674     <span class="comment">// #define SKF_TWOKEYSOFF      0x00000100        100</span>
02675     <span class="comment">// ----------------------------------------- total = 0x1d2 = 466</span>
02676     <span class="comment">//</span>
02677     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02678             <a class="code" href="../../d4/d1/userk_8h.html#a709">PMAP_STICKYKEYS</a>,
02679             TEXT(<span class="stringliteral">"Flags"</span>),
02680             466
02681             );
02682 
02683     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02684             dwDefFlags,
02685             SKF_STICKYKEYSON,
02686             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON));
02687 
02688     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a33">gStickyKeys</a>.dwFlags = dwDefFlags;
02689 
02690     <span class="comment">//</span>
02691     <span class="comment">// Get the default MouseKeys state.</span>
02692     <span class="comment">//</span>
02693     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02694     <span class="comment">// #define MKF_MOUSEKEYSON     0x00000001           0</span>
02695     <span class="comment">// #define MKF_AVAILABLE       0x00000002           2</span>
02696     <span class="comment">// #define MKF_HOTKEYACTIVE    0x00000004           0</span>
02697     <span class="comment">// #define MKF_CONFIRMHOTKEY   0x00000008           0</span>
02698     <span class="comment">// #define MKF_HOTKEYSOUND     0x00000010          10</span>
02699     <span class="comment">// #define MKF_INDICATOR       0x00000020           0</span>
02700     <span class="comment">// #define MKF_MODIFIERS       0x00000040           0</span>
02701     <span class="comment">// #define MKF_REPLACENUMBERS  0x00000080           0</span>
02702     <span class="comment">// ----------------------------------------- total = 0x12 = 18</span>
02703     <span class="comment">//</span>
02704     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02705             <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
02706             TEXT(<span class="stringliteral">"Flags"</span>),
02707             18
02708             );
02709 
02710     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02711             dwDefFlags,
02712             MKF_MOUSEKEYSON,
02713             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON));
02714 
02715     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.dwFlags = dwDefFlags;
02716     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.iMaxSpeed = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02717             <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
02718             TEXT(<span class="stringliteral">"MaximumSpeed"</span>),
02719             40
02720             );
02721 
02722     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a34">gMouseKeys</a>.iTimeToMaxSpeed = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02723                                      <a class="code" href="../../d4/d1/userk_8h.html#a711">PMAP_MOUSEKEYS</a>,
02724                                      TEXT(<span class="stringliteral">"TimeToMaximumSpeed"</span>),
02725                                      3000
02726                                      );
02727     <a class="code" href="../../d9/d3/access_8h.html#a71">CalculateMouseTable</a>();
02728 
02729     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a170">gbMKMouseMode</a> =
02730 <span class="preprocessor">#ifdef FE_SB</span>
02731 <span class="preprocessor"></span>            (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a>) != 0) ^
02732 <span class="preprocessor">#else  // FE_SB</span>
02733 <span class="preprocessor"></span>            (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a846">TestAsyncKeyStateToggle</a>(VK_NUMLOCK) != 0) ^
02734 <span class="preprocessor">#endif // FE_SB</span>
02735 <span class="preprocessor"></span>            (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_REPLACENUMBERS) != 0);
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">// If the system does not have a hardware mouse:</span>
02739     <span class="comment">//    If MouseKeys is enabled show the mouse cursor,</span>
02740     <span class="comment">//    o.w. hide the mouse cursor.</span>
02741     <span class="comment">//</span>
02742     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)) {
02743         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a25">MKShowMouseCursor</a>();
02744     } <span class="keywordflow">else</span> {
02745         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a26">MKHideMouseCursor</a>();
02746     }
02747 
02748     <span class="comment">//</span>
02749     <span class="comment">// Get the default ToggleKeys state.</span>
02750     <span class="comment">//</span>
02751     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02752     <span class="comment">// #define TKF_TOGGLEKEYSON    0x00000001           0</span>
02753     <span class="comment">// #define TKF_AVAILABLE       0x00000002           2</span>
02754     <span class="comment">// #define TKF_HOTKEYACTIVE    0x00000004           0</span>
02755     <span class="comment">// #define TKF_CONFIRMHOTKEY   0x00000008           0</span>
02756     <span class="comment">// #define TKF_HOTKEYSOUND     0x00000010          10</span>
02757     <span class="comment">// #define TKF_INDICATOR       0x00000020           0</span>
02758     <span class="comment">// ----------------------------------------- total = 0x12 = 18</span>
02759     <span class="comment">//</span>
02760     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02761             <a class="code" href="../../d4/d1/userk_8h.html#a712">PMAP_TOGGLEKEYS</a>,
02762             TEXT(<span class="stringliteral">"Flags"</span>),
02763             18
02764             );
02765 
02766     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02767             dwDefFlags,
02768             TKF_TOGGLEKEYSON,
02769             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON));
02770 
02771     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a36">gToggleKeys</a>.dwFlags = dwDefFlags;
02772 
02773     <span class="comment">//</span>
02774     <span class="comment">// Get the default Timeout state.</span>
02775     <span class="comment">//</span>
02776     <span class="comment">// -------- flag --------------- value --------- default ------</span>
02777     <span class="comment">// #define ATF_TIMEOUTON       0x00000001           0</span>
02778     <span class="comment">// #define ATF_ONOFFFEEDBACK   0x00000002           2</span>
02779     <span class="comment">// ----------------------------------------- total = 0x2 = 2</span>
02780     <span class="comment">//</span>
02781     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02782             <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
02783             TEXT(<span class="stringliteral">"Flags"</span>),
02784             2
02785             );
02786 
02787     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02788             dwDefFlags,
02789             ATF_TIMEOUTON,
02790             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(AccessTimeOut, ATF_TIMEOUTON));
02791 
02792     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.dwFlags = dwDefFlags;
02793 
02794 <span class="preprocessor">#ifdef FE_SB //</span>
02795 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>) {
02796         <span class="comment">//</span>
02797         <span class="comment">// Is there any alternative MouseVKey table in KBDNLSTABLE ?</span>
02798         <span class="comment">//</span>
02799         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;NumOfMouseVKey == <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a5">cMouseVKeys</a>) &amp;&amp;
02800             (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;pusMouseVKey   != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02801             <span class="comment">//</span>
02802             <span class="comment">// Overwite the pointer.</span>
02803             <span class="comment">//</span>
02804             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a261">gpusMouseVKey</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;pusMouseVKey;
02805         }
02806 
02807         <span class="comment">//</span>
02808         <span class="comment">// Is there any remapping flag for VK_NUMLOCK/VK_SCROLL ?</span>
02809         <span class="comment">//</span>
02810         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a72">gpKbdNlsTbl</a>-&gt;LayoutInformation &amp; NLSKBD_INFO_ACCESSIBILITY_KEYMAP) {
02811             <span class="comment">//</span>
02812             <span class="comment">// Overwrite default.</span>
02813             <span class="comment">//</span>
02814             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a262">gNumLockVk</a> = VK_HOME;
02815             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a263">gOemScrollVk</a> = VK_KANA;
02816         }
02817     }
02818 <span class="preprocessor">#endif // FE_SB</span>
02819 <span class="preprocessor"></span>
02820     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a35">gAccessTimeOut</a>.iTimeOutMSec = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02821              <a class="code" href="../../d4/d1/userk_8h.html#a713">PMAP_TIMEOUT</a>,
02822              TEXT(<span class="stringliteral">"TimeToWait"</span>),
02823              300000
02824              );  <span class="comment">// default is 5 minutes</span>
02825 
02826    <span class="comment">/*</span>
02827 <span class="comment">    * Get High Contrast state</span>
02828 <span class="comment">    */</span>
02829 
02830     dwDefFlags = <a class="code" href="../../d4/d1/userk_8h.html#a2008">FastGetProfileIntW</a>(pProfileUserName,
02831              <a class="code" href="../../d4/d1/userk_8h.html#a724">PMAP_HIGHCONTRAST</a>,
02832              TEXT(<span class="stringliteral">"Flags"</span>),
02833              HCF_AVAILABLE | HCF_HOTKEYSOUND | HCF_HOTKEYAVAILABLE
02834              );
02835 
02836     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a15">SET_OR_CLEAR_FLAG</a>(
02837             dwDefFlags,
02838             HCF_HIGHCONTRASTON,
02839             <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HIGHCONTRASTON));
02840 
02841     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a38">gHighContrast</a>.dwFlags = dwDefFlags;
02842 
02843     <span class="comment">/*</span>
02844 <span class="comment">     * Get scheme -- set up buffer</span>
02845 <span class="comment">     */</span>
02846 
02847     usHighContrastScheme.Buffer = wcHighContrastScheme;
02848     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a2007">FastGetProfileStringW</a>(pProfileUserName,
02849             <a class="code" href="../../d4/d1/userk_8h.html#a724">PMAP_HIGHCONTRAST</a>,
02850             TEXT(<span class="stringliteral">"High Contrast Scheme"</span>),
02851             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02852             wcHighContrastScheme,
02853             MAX_SCHEME_NAME_SIZE
02854             )) {
02855 
02856         <span class="comment">/*</span>
02857 <span class="comment">         * copy data</span>
02858 <span class="comment">         */</span>
02859 
02860         wcscpy(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a39">gHighContrastDefaultScheme</a>, usHighContrastScheme.Buffer);
02861     }
02862 
02863 
02864     <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a42">AccessTimeOutReset</a>();
02865     <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>();
02866 }
02867 
02868 
02869 <span class="comment">/***************************************************************************\</span>
02870 <span class="comment">* SetAccessEnabledFlag</span>
02871 <span class="comment">*</span>
02872 <span class="comment">* Sets the global flag ACCF_ACCESSENABLED to non-zero if any accessibility</span>
02873 <span class="comment">* function is on or hot key activation is enabled.  When TEST_ACCF(ACCF_ACCESSENABLED)</span>
02874 <span class="comment">* is zero keyboard input is processed directly.  When TEST_ACCF(ACCF_ACCESSENABLED) is</span>
02875 <span class="comment">* non-zero keyboard input is filtered through AccessProceduresStream().</span>
02876 <span class="comment">* See KeyboardApcProcedure in ntinput.c.</span>
02877 <span class="comment">*</span>
02878 <span class="comment">* History:</span>
02879 <span class="comment">* 01-19-94 GregoryW         Created.</span>
02880 <span class="comment">\***************************************************************************/</span>
<a name="l02881"></a><a class="code" href="../../d9/d3/access_8h.html#a49">02881</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d9/d3/access_8h.html#a49">SetAccessEnabledFlag</a>(VOID)
02882 {
02883 
02884     <a class="code" href="../../d4/d1/userk_8h.html#a655">SET_OR_CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a629">ACCF_ACCESSENABLED</a>,
02885                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_FILTERKEYSON)  ||
02886                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a16">FilterKeys</a>, FKF_HOTKEYACTIVE)  ||
02887                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_STICKYKEYSON)  ||
02888                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(StickyKeys, SKF_HOTKEYACTIVE)  ||
02889                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(HighContrast, HCF_HOTKEYACTIVE)  ||
02890                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_MOUSEKEYSON)    ||
02891                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a36">MouseKeys</a>, MKF_HOTKEYACTIVE)   ||
02892                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_TOGGLEKEYSON)  ||
02893                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(<a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a40">ToggleKeys</a>, TKF_HOTKEYACTIVE)  ||
02894                       <a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(SoundSentry, SSF_SOUNDSENTRYON)||
02895                       <a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a635">ACCF_SHOWSOUNDSON</a>));
02896 }
02897 
<a name="l02898"></a><a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a45">02898</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a45">SoundSentryTimer</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR idTimer, LPARAM lParam)
02899 {
02900     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
02901     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndSoundSentry;
02902 
02903     <span class="keywordflow">if</span> (pwndSoundSentry = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a59">ghwndSoundSentry</a>)) {
02904         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndSoundSentry, &amp;tlpwndT);
02905         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(pwndSoundSentry,
02906                        (<a class="code" href="../../d4/d1/userk_8h.html#a652">TEST_BOOL_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a634">ACCF_FIRSTTICK</a>) ? FLASHW_ALL : FLASHW_STOP),
02907                        0);
02908         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02909     }
02910 
02911     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a651">TEST_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a634">ACCF_FIRSTTICK</a>)) {
02912         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a60">gtmridSoundSentry</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
02913                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02914                                        idTimer,
02915                                        5,
02916                                        <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a45">SoundSentryTimer</a>,
02917                                        TMRF_RIT | TMRF_ONESHOT
02918                                        );
02919         <a class="code" href="../../d4/d1/userk_8h.html#a654">CLEAR_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a634">ACCF_FIRSTTICK</a>);
02920     } <span class="keywordflow">else</span> {
02921         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a59">ghwndSoundSentry</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02922         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a60">gtmridSoundSentry</a> = 0;
02923         <a class="code" href="../../d4/d1/userk_8h.html#a653">SET_ACCF</a>(<a class="code" href="../../d4/d1/userk_8h.html#a634">ACCF_FIRSTTICK</a>);
02924     }
02925 
02926     <span class="keywordflow">return</span>;
02927 
02928     UNREFERENCED_PARAMETER(pwnd);
02929     UNREFERENCED_PARAMETER(message);
02930     UNREFERENCED_PARAMETER(lParam);
02931 }
02932 
02933 <span class="comment">/***************************************************************************\</span>
02934 <span class="comment">* _UserSoundSentryWorker</span>
02935 <span class="comment">*</span>
02936 <span class="comment">* This is the worker routine that provides the visual feedback requested</span>
02937 <span class="comment">* by the user.</span>
02938 <span class="comment">*</span>
02939 <span class="comment">* History:</span>
02940 <span class="comment">* 08-02-93 GregoryW         Created.</span>
02941 <span class="comment">\***************************************************************************/</span>
02942 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02943"></a><a class="code" href="../../d9/d3/access_8h.html#a74">02943</a> <a class="code" href="../../d9/d3/access_8h.html#a74">_UserSoundSentryWorker</a>(VOID)
02944 {
02945     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndActive;
02946     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwndT;
02947 
02948     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
02949     <span class="comment">//</span>
02950     <span class="comment">// Check to see if SoundSentry is on.</span>
02951     <span class="comment">//</span>
02952     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d3/access_8h.html#a0">TEST_ACCESSFLAG</a>(SoundSentry, SSF_SOUNDSENTRYON)) {
02953         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02954     }
02955 
02956     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02957         pwndActive = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a29">gpqForeground</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o8">spwndActive</a>;
02958     } <span class="keywordflow">else</span> {
02959         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02960     }
02961 
02962     <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a37">gSoundSentry</a>.iWindowsEffect) {
02963 
02964     <span class="keywordflow">case</span> SSWF_NONE:
02965         <span class="keywordflow">break</span>;
02966 
02967     <span class="keywordflow">case</span> SSWF_TITLE:
02968         <span class="comment">//</span>
02969         <span class="comment">// Flash the active caption bar.</span>
02970         <span class="comment">//</span>
02971         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a60">gtmridSoundSentry</a>) {
02972             <span class="keywordflow">break</span>;
02973         }
02974         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndActive, &amp;tlpwndT);
02975         <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(pwndActive, FLASHW_ALL, 0);
02976         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
02977 
02978         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a59">ghwndSoundSentry</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndActive);
02979         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a60">gtmridSoundSentry</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
02980                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02981                                        0,
02982                                        100,
02983                                        <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a45">SoundSentryTimer</a>,
02984                                        TMRF_RIT | TMRF_ONESHOT
02985                                        );
02986         <span class="keywordflow">break</span>;
02987 
02988     <span class="keywordflow">case</span> SSWF_WINDOW:
02989     {
02990         <span class="comment">//</span>
02991         <span class="comment">// Flash the active window.</span>
02992         <span class="comment">//</span>
02993         HDC hdc;
02994         RECT rc;
02995 
02996         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1696">_GetWindowDC</a>(pwndActive);
02997         <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a20">_GetWindowRect</a>(pwndActive, &amp;rc);
02998         <span class="comment">//</span>
02999         <span class="comment">// _GetWindowRect returns screen coordinates.  First adjust them</span>
03000         <span class="comment">// to window (display) coordinates and then map them to logical</span>
03001         <span class="comment">// coordinates before calling InvertRect.</span>
03002         <span class="comment">//</span>
03003         <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -rc.left, -rc.top);
03004         GreDPtoLP(hdc, (LPPOINT)&amp;rc, 2);
03005         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a4">InvertRect</a>(hdc, &amp;rc);
03006         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a4">InvertRect</a>(hdc, &amp;rc);
03007         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
03008         <span class="keywordflow">break</span>;
03009     }
03010 
03011     <span class="keywordflow">case</span> SSWF_DISPLAY:
03012     {
03013         <span class="comment">//</span>
03014         <span class="comment">// Flash the entire display.</span>
03015         <span class="comment">//</span>
03016         HDC hdc;
03017         RECT rc;
03018 
03019         hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(<a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwndActive), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE);
03020         rc.left = rc.top = 0;
03021         rc.right = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXVIRTUALSCREEN);
03022         rc.bottom = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYVIRTUALSCREEN);
03023         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a4">InvertRect</a>(hdc, &amp;rc);
03024         <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a4">InvertRect</a>(hdc, &amp;rc);
03025         <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
03026         <span class="keywordflow">break</span>;
03027     }
03028     }
03029 
03030     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03031 }
03032 
03033 <span class="comment">/***************************************************************************\</span>
03034 <span class="comment">* UtilityManager</span>
03035 <span class="comment">*</span>
03036 <span class="comment">* This is the strategy routine that gets called as part of the input stream</span>
03037 <span class="comment">* processing.  Utility Manager launching happens here.</span>
03038 <span class="comment">*</span>
03039 <span class="comment">* Return value:</span>
03040 <span class="comment">*    TRUE  - key event should be passed on to the next access routine.</span>
03041 <span class="comment">*    FALSE - key event was processed and should not be passed on.</span>
03042 <span class="comment">*</span>
03043 <span class="comment">* History: 10-28-98 a-anilk created</span>
03044 <span class="comment">\***************************************************************************/</span>
<a name="l03045"></a><a class="code" href="../../d9/d3/access_8h.html#a47">03045</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d9/d3/access_8h.html#a47">UtilityManager</a>(PKE pKeyEvent, ULONG ExtraInformation, <span class="keywordtype">int</span> NotUsed)
03046 {
03047     <span class="keywordtype">int</span> CurrentModState;
03048     <span class="keywordtype">int</span> fBreak;
03049     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> Vk;
03050 
03051 
03052     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
03053 
03054     Vk = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)(pKeyEvent-&gt;usFlaggedVk &amp; 0xff);
03055     fBreak = pKeyEvent-&gt;usFlaggedVk &amp; KBDBREAK;
03056     CurrentModState = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a167">gLockBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a166">gLatchBits</a> | <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a163">gPhysModifierState</a>;
03057 
03058     <span class="comment">// the hot key to launch the utility manager is WinKey + U</span>
03059     <span class="keywordflow">if</span> ((Vk == <a class="code" href="../../d9/d3/access_8h.html#a31">VK_U</a> &amp;&amp; !fBreak &amp;&amp; (CurrentModState &amp; <a class="code" href="../../d9/d3/access_8h.html#a30">LRWIN</a>)) )
03060     {
03061         <a class="code" href="../../d8/d3/ntuser_2kernel_2access_8c.html#a8">PostAccessNotification</a>(ACCESS_UTILITYMANAGER);
03062 
03063         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03064     }
03065     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;  <span class="comment">// send key event to next accessibility routine.</span>
03066 
03067     UNREFERENCED_PARAMETER(NotUsed);
03068     UNREFERENCED_PARAMETER(ExtraInformation);
03069 }
03070 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
