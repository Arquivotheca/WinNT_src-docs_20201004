<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtvbatcr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtvbatcr.c</h1><a href="../../d8/d3/rtvbatcr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rtvbatcr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    NT level registry api test program, basic non-error paths.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Do a batch create, VOLATILE.  (Same as rtbatcr, but creates keys volatile.)</span>
00014 <span class="comment"></span>
00015 <span class="comment">    rtvbatcr    &lt;KeyPath&gt; &lt;KeyName&gt; &lt;basename&gt; &lt;#children&gt; &lt;#values&gt;</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Will attempt to create key &lt;KeyName&gt; as child of &lt;KeyPath&gt;  If</span>
00018 <span class="comment">    &lt;#children&gt; and &lt;#values&gt; are 0, this is all it does.  If &lt;KeyName&gt;</span>
00019 <span class="comment">    already exists, it will simply be used.</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Will create &lt;#children&gt; child cells, with names of the form</span>
00022 <span class="comment">    &lt;base&gt;0  &lt;base&gt;1, etc.  Will create &lt;#values&gt; value entries,</span>
00023 <span class="comment">    with similar names, for each created child key.  Data of</span>
00024 <span class="comment">    values will be a constant string including their name.</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Example:</span>
00027 <span class="comment"></span>
00028 <span class="comment">        rtvbatcr    \REGISTRY\MACHINE\TEST bigkey runa_ 100 100</span>
00029 <span class="comment">        rtvbatcr    \REGISTRY\MACHINE\TEST\bigkey runa_1 runb_ 100 100</span>
00030 <span class="comment"></span>
00031 <span class="comment">        Will create bigkey, give it 100 values calls runa_1 through</span>
00032 <span class="comment">        runa_100, create 100 subkeys called runa_1 through runa_100</span>
00033 <span class="comment">        for each of those children.</span>
00034 <span class="comment"></span>
00035 <span class="comment">        It will then open bigkey\runa_1, and create 100 subkeys and</span>
00036 <span class="comment">        100 values each for that.</span>
00037 <span class="comment"></span>
00038 <span class="comment">Author:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    Bryan Willman (bryanwi)  10-Dec-91</span>
00041 <span class="comment"></span>
00042 <span class="comment">Revision History:</span>
00043 <span class="comment"></span>
00044 <span class="comment">--*/</span>
00045 
00046 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00047 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00048 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00049 <span class="preprocessor">#include &lt;string.h&gt;</span>
00050 
<a name="l00051"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a0">00051</a> <span class="preprocessor">#define WORK_SIZE   1024</span>
00052 <span class="preprocessor"></span>
00053 <span class="keywordtype">void</span> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(<span class="keywordtype">int</span>, <span class="keywordtype">char</span> *);
00054 <span class="keywordtype">void</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>();
00055 
<a name="l00056"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a1">00056</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> = 0;
00057 
<a name="l00058"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a2">00058</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>;
<a name="l00059"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a3">00059</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
<a name="l00060"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a4">00060</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a>;
<a name="l00061"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a5">00061</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a>;
<a name="l00062"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a6">00062</a> UCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
<a name="l00063"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a7">00063</a> UCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
<a name="l00064"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a8">00064</a> STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>;
00065 
<a name="l00066"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a9">00066</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>;
<a name="l00067"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a10">00067</a> WCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
00068 
00069 <span class="keywordtype">void</span>
<a name="l00070"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a13">00070</a> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(
00071     <span class="keywordtype">int</span> argc,
00072     <span class="keywordtype">char</span> *argv[]
00073     )
00074 {
00075     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00076     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00077     HANDLE          BaseHandle;
00078     HANDLE          WorkHandle;
00079     ULONG           Disposition;
00080     UNICODE_STRING  ClassName;
00081     ULONG           i;
00082     ULONG           j;
00083     PUCHAR  p;
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// Process args</span>
00087     <span class="comment">//</span>
00088 
00089     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(argc, argv);
00090 
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">// Set up and create/open KeyPath|KeyName</span>
00094     <span class="comment">//</span>
00095 
00096     printf(<span class="stringliteral">"rtvbatcr: starting\n"</span>);
00097 
00098     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>;
00099     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00100     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = &amp;(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[0]);
00101 
00102     <a class="code" href="../../d2/d7/string_8c.html#a8">RtlCopyString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>);
00103 
00104     p = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer;
00105     p += <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length;
00106     *p = <span class="charliteral">'\\'</span>;
00107     p++;
00108     *p = <span class="charliteral">'\0'</span>;
00109     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length += 2;
00110 
00111     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
00112 
00113     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00114         &amp;ClassName,
00115         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Test Class Name"</span>
00116         );
00117 
00118     InitializeObjectAttributes(
00119         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00120         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00121         0,
00122         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00123         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00124         );
00125     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00126 
00127     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00128                 &amp;BaseHandle,
00129                 MAXIMUM_ALLOWED,
00130                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00131                 0,
00132                 &amp;ClassName,
00133                 REG_OPTION_VOLATILE,
00134                 &amp;Disposition
00135                 );
00136     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00137         printf(<span class="stringliteral">"rtvbatcr: t0: %08lx\n"</span>, status);
00138         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00139         <span class="keywordflow">goto</span> punt;
00140     }
00141 
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">// Create NumberChildren subkeys</span>
00145     <span class="comment">//</span>
00146 
00147     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a>; i++) {
00148 
00149         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"%s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, i);
00150         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>);
00151         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00152 
00153 
00154         InitializeObjectAttributes(
00155             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00156             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00157             0,
00158             BaseHandle,
00159             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00160             );
00161         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00162 
00163         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00164                     &amp;WorkHandle,
00165                     MAXIMUM_ALLOWED,
00166                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00167                     0,
00168                     &amp;ClassName,
00169                     REG_OPTION_VOLATILE,
00170                     &amp;Disposition
00171                     );
00172         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00173             printf(<span class="stringliteral">"rtvbatcr: t1: status = %08lx i = %d\n"</span>, status, i);
00174             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00175         }
00176 
00177         <span class="comment">//</span>
00178         <span class="comment">// Create NumberValues value entries for each (current) key</span>
00179         <span class="comment">//</span>
00180 
00181         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a>; j++) {
00182 
00183             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"%s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, j);
00184             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>);
00185             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00186 
00187             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
00188                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"This is a rtvbatcr value for %s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, j
00189                 );
00190 
00191             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00192                         WorkHandle,
00193                         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00194                         j,
00195                         j,
00196                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>,
00197                         <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>)+1
00198                         );
00199             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00200                 printf(<span class="stringliteral">"rtvbatcr: t2: status = %08lx j = %d\n"</span>, status, j);
00201                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00202             }
00203         }
00204         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(WorkHandle);
00205     }
00206 
00207 punt:
00208     printf(<span class="stringliteral">"rtvbatcr: %d failures\n"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>);
00209     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>);
00210 }
00211 
00212 
00213 <span class="keywordtype">void</span>
<a name="l00214"></a><a class="code" href="../../d8/d3/rtvbatcr_8c.html#a14">00214</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(
00215     <span class="keywordtype">int</span> argc,
00216     <span class="keywordtype">char</span> *argv[]
00217     )
00218 {
00219     ANSI_STRING temp;
00220 
00221     <span class="keywordflow">if</span> ( (argc != 3) &amp;&amp; (argc != 6) )
00222     {
00223         printf(<span class="stringliteral">"Usage: %s &lt;KeyPath&gt; &lt;KeyName&gt; [&lt;basename&gt; &lt;#children&gt; &lt;#values&gt;]\n"</span>,
00224                 argv[0]);
00225         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00226     }
00227 
00228     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00229         &amp;temp,
00230         argv[1]
00231         );
00232 
00233     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00234         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00235         &amp;temp,
00236         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00237         );
00238 
00239     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00240         &amp;temp,
00241         argv[2]
00242         );
00243 
00244     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00245         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00246         &amp;temp,
00247         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00248         );
00249 
00250     <span class="keywordflow">if</span> (argc &lt; 6) {
00251 
00252         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a> = 0;
00253         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a> = 0;
00254 
00255     } <span class="keywordflow">else</span> {
00256 
00257         strcpy(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, argv[3]);
00258         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a> = atoi(argv[4]);
00259         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a> = atoi(argv[5]);
00260 
00261     }
00262     <span class="keywordflow">return</span>;
00263 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:41 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
