<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: filter.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>filter.c</h1><a href="../../d8/d3/io_2filter_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment">All rights reserved</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    filter.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains support functions for IoAssignResources to filter caller's</span>
00013 <span class="comment">    IoRequirementResourceList.</span>
00014 <span class="comment">    Some of the stuff here is copied from KenR's Hal code.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Shie-Lin Tzong (shielint) Apr-7-1995</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode only.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00029 
00030 <span class="preprocessor">#if _PNP_POWER_</span>
00031 <span class="preprocessor"></span>
00032 <span class="keyword">typedef</span> <span class="keyword">struct </span>_NRParams {
00033     PIO_RESOURCE_DESCRIPTOR     InDesc;
00034     PIO_RESOURCE_DESCRIPTOR     OutDesc;
00035     <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>            CurrentPosition;
00036     LONGLONG                    Base;
00037     LONGLONG                    Limit;
00038     UCHAR                       DescOpt;
00039     BOOLEAN                     AnotherListPending;
00040 } NRPARAMS, *PNRPARAMS;
00041 
00042 PIO_RESOURCE_REQUIREMENTS_LIST
00043 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (
00044     IN ULONG SlotNumber,
00045     IN PCM_RESOURCE_LIST CmResourceList
00046     );
00047 
00048 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00049 IopAdjustResourceListRange (
00050     IN <a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html">PSUPPORTED_RANGES</a>                    SupportedRanges,
00051     IN <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>                     InterruptRange,
00052     IN PIO_RESOURCE_REQUIREMENTS_LIST       IoResourceList,
00053     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST   *ReturnedList
00054     );
00055 
00056 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00057 IopGetNextSupportedRange (
00058     IN LONGLONG             MinimumAddress,
00059     IN LONGLONG             MaximumAddress,
00060     IN OUT PNRPARAMS        PNRParams,
00061     OUT PIO_RESOURCE_DESCRIPTOR *IoDescriptor
00062     );
00063 
00064 ULONG
00065 IopSortRanges (
00066     IN <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>     RangeList
00067     );
00068 
00069 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAdjustResourceListRange)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopSortRanges)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopGetNextSupportedRange)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopAddDefaultResourceList)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,IopCmResourcesToIoResources)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077 PIO_RESOURCE_REQUIREMENTS_LIST
00078 IopAddDefaultResourceList (
00079     IN PIO_RESOURCE_REQUIREMENTS_LIST IoResourceList,
00080     IN PCM_RESOURCE_LIST CmResourceList
00081     )
00082 <span class="comment">/*++</span>
00083 <span class="comment"></span>
00084 <span class="comment">Routine Description:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    This functions builds an IO resource list by adjusting input IoResourceList to</span>
00087 <span class="comment">    the ranges specified by CmResourceList and merges the new Io resource list to the</span>
00088 <span class="comment">    input IoResourceList and returns the combined list.</span>
00089 <span class="comment">    If IoResourceList has zero descriptor, this routine bulds an</span>
00090 <span class="comment">    IO RESOURCE REQUIREMENTS LIST by simply converting the CmResourceList.</span>
00091 <span class="comment">    It's caller's responsiblity to free the returned list.</span>
00092 <span class="comment"></span>
00093 <span class="comment">Arguments:</span>
00094 <span class="comment"></span>
00095 <span class="comment">    IoResourceList - The resource requirements list which needs to</span>
00096 <span class="comment">                     be adjusted.</span>
00097 <span class="comment"></span>
00098 <span class="comment">    CmResourceList - the cm resource list to specify the resource ranges desired.</span>
00099 <span class="comment"></span>
00100 <span class="comment">Return Value:</span>
00101 <span class="comment"></span>
00102 <span class="comment">    returns a IO_RESOURCE_REQUIREMENTS_LISTST if succeeds.  Otherwise a NULL value is</span>
00103 <span class="comment">    returned.</span>
00104 <span class="comment"></span>
00105 <span class="comment">--*/</span>
00106 {
00107     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList, combinedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00108     <a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html">SUPPORTED_RANGES</a> supportRanges;
00109     <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">SUPPORTED_RANGE</a> interruptRange;
00110     <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a> range, tmpRange;
00111     <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a> intRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, ioRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, memRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, dmaRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00112     ULONG size, i, j, addressSpace = 0;
00113     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
00114     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
00115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00116 
00117     <span class="keywordflow">if</span> (!IoResourceList) {
00118 
00119         <span class="comment">//</span>
00120         <span class="comment">// If IoResourceList is NULL, return failure.</span>
00121         <span class="comment">//</span>
00122 
00123         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00124     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoResourceList-&gt;List[0].Count == 0) {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// an empty Io resource requirements list, simply return the converted</span>
00128         <span class="comment">// list.</span>
00129         <span class="comment">//</span>
00130 
00131         ioResReqList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(IoResourceList-&gt;SlotNumber,
00132                                                    CmResourceList);
00133         <span class="keywordflow">return</span> ioResReqList;
00134     }
00135 
00136     <span class="comment">//</span>
00137     <span class="comment">// Clip the IoResourceList against CmResourceList.</span>
00138     <span class="comment">// First, build the supported ranges structure to do the clipping.</span>
00139     <span class="comment">//</span>
00140 
00141     RtlZeroMemory(&amp;supportRanges, <span class="keyword">sizeof</span>(supportRanges));
00142     supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o0">Version</a> = <a class="code" href="../../d2/d7/hal_8h.html#a15">BUS_SUPPORTED_RANGE_VERSION</a>;
00143     supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o1">Sorted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00144     ioResReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00145 
00146     cmFullDesc = &amp;CmResourceList-&gt;List[0];
00147     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
00148         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
00149         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
00150             size = 0;
00151             range = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00152             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
00153             <span class="keywordflow">case</span> CmResourceTypePort:
00154                  <span class="keywordflow">if</span> (!ioRange) {
00155                      range = &amp;supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o4">IO</a>;
00156                  } <span class="keywordflow">else</span> {
00157                      range = (<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">SUPPORTED_RANGE</a>));
00158                      ioRange-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a> = range;
00159                  }
00160                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o1">SystemAddressSpace</a> = 1;
00161                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o2">SystemBase</a> = 0;
00162                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a> = cmPartDesc-&gt;u.Port.Start.QuadPart;
00163                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o4">Limit</a> = cmPartDesc-&gt;u.Port.Start.QuadPart +
00164                                             cmPartDesc-&gt;u.Port.Length - 1;
00165                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00166                  ioRange = range;
00167                  supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o3">NoIO</a>++;
00168                  <span class="keywordflow">break</span>;
00169             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00170                  <span class="keywordflow">if</span> (!intRange) {
00171                      range = &amp;interruptRange;
00172                  } <span class="keywordflow">else</span> {
00173                      range = (<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">SUPPORTED_RANGE</a>));
00174                      intRange-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a> = range;
00175                  }
00176                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o1">SystemAddressSpace</a> = 0;
00177                  range-&gt;SystemBase = 0;
00178                  range-&gt;Base = cmPartDesc-&gt;u.Interrupt.Vector;
00179                  range-&gt;Limit = cmPartDesc-&gt;u.Interrupt.Vector;
00180                  range-&gt;Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00181                  intRange = range;
00182                  <span class="keywordflow">break</span>;
00183             <span class="keywordflow">case</span> CmResourceTypeMemory:
00184                  <span class="keywordflow">if</span> (!memRange) {
00185                      range = &amp;supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o6">Memory</a>;
00186                  } <span class="keywordflow">else</span> {
00187                      range = (<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">SUPPORTED_RANGE</a>));
00188                      memRange-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a> = range;
00189                  }
00190                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o1">SystemAddressSpace</a> = 0;
00191                  range-&gt;SystemBase = 0;
00192                  range-&gt;Base = cmPartDesc-&gt;u.Memory.Start.QuadPart;
00193                  range-&gt;Limit = cmPartDesc-&gt;u.Memory.Start.QuadPart +
00194                                             cmPartDesc-&gt;u.Memory.Length - 1;
00195                  range-&gt;Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00196                  memRange = range;
00197                  supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o5">NoMemory</a>++;
00198                  <span class="keywordflow">break</span>;
00199             <span class="keywordflow">case</span> CmResourceTypeDma:
00200                  <span class="keywordflow">if</span> (!dmaRange) {
00201                      range = &amp;supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o10">Dma</a>;
00202                  } <span class="keywordflow">else</span> {
00203                      range = (<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">SUPPORTED_RANGE</a>));
00204                      dmaRange-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a> = range;
00205                  }
00206                  range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o1">SystemAddressSpace</a> = 0;
00207                  range-&gt;SystemBase = 0;
00208                  range-&gt;Base = cmPartDesc-&gt;u.Dma.Channel;
00209                  range-&gt;Limit = cmPartDesc-&gt;u.Dma.Channel;
00210                  range-&gt;Next = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00211                  dmaRange = range;
00212                  supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o9">NoDma</a>++;
00213                  <span class="keywordflow">break</span>;
00214             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
00215                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
00216                  <span class="keywordflow">break</span>;
00217             }
00218             cmPartDesc++;
00219             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
00220         }
00221         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
00222     }
00223 
00224     <span class="comment">//</span>
00225     <span class="comment">// Adjust the input resource requirements list ...</span>
00226     <span class="comment">//</span>
00227 
00228     status = IopAdjustResourceListRange (
00229                  &amp;supportRanges,
00230                  &amp;interruptRange,
00231                  IoResourceList,
00232                  &amp;ioResReqList
00233                  );
00234 
00235     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00236         <span class="keywordflow">goto</span> exit0;
00237     }
00238 
00239     <span class="comment">//</span>
00240     <span class="comment">// Combine the clipped io resource requirements list with the original resource</span>
00241     <span class="comment">// list.</span>
00242     <span class="comment">//</span>
00243 
00244     size = ioResReqList-&gt;ListSize + IoResourceList-&gt;ListSize -
00245            FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, List);
00246     combinedList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
00247     <span class="keywordflow">if</span> (combinedList) {
00248         RtlMoveMemory(combinedList, ioResReqList, ioResReqList-&gt;ListSize);
00249         combinedList-&gt;ListSize = size;
00250         combinedList-&gt;AlternativeLists += IoResourceList-&gt;AlternativeLists;
00251         RtlMoveMemory((PUCHAR)combinedList + ioResReqList-&gt;ListSize,
00252                       (PUCHAR)IoResourceList-&gt;List,
00253                       IoResourceList-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, List)
00254                       );
00255     }
00256     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioResReqList);
00257 exit0:
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Release the space allocated for supported ranges...</span>
00261     <span class="comment">//</span>
00262 
00263     range = interruptRange.<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00264     <span class="keywordflow">while</span> (range) {
00265         tmpRange = range;
00266         range = range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00267         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpRange);
00268     }
00269     range = supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o4">IO</a>.<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00270     <span class="keywordflow">while</span> (range) {
00271         tmpRange = range;
00272         range = range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00273         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpRange);
00274     }
00275     range = supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o6">Memory</a>.<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00276     <span class="keywordflow">while</span> (range) {
00277         tmpRange = range;
00278         range = range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00279         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpRange);
00280     }
00281     range = supportRanges.<a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html#o10">Dma</a>.<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00282     <span class="keywordflow">while</span> (range) {
00283         tmpRange = range;
00284         range = range-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>;
00285         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tmpRange);
00286     }
00287     <span class="keywordflow">return</span> combinedList;
00288 }
00289 
00290 PIO_RESOURCE_REQUIREMENTS_LIST
00291 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (
00292     IN ULONG SlotNumber,
00293     IN PCM_RESOURCE_LIST CmResourceList
00294     )
00295 
00296 <span class="comment">/*++</span>
00297 <span class="comment"></span>
00298 <span class="comment">Routine Description:</span>
00299 <span class="comment"></span>
00300 <span class="comment">    This routines converts the input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.</span>
00301 <span class="comment">    Note, the SlotNumber field of the returned list is not initialized.  Caller must</span>
00302 <span class="comment">    fill in the correct value.</span>
00303 <span class="comment"></span>
00304 <span class="comment">Arguments:</span>
00305 <span class="comment"></span>
00306 <span class="comment">    SlotNumber - supplies the SlotNumber the resources refer to.</span>
00307 <span class="comment"></span>
00308 <span class="comment">    CmResourceList - the cm resource list to convert.</span>
00309 <span class="comment"></span>
00310 <span class="comment">Return Value:</span>
00311 <span class="comment"></span>
00312 <span class="comment">    returns a IO_RESOURCE_REQUIREMENTS_LISTST if succeeds.  Otherwise a NULL value is</span>
00313 <span class="comment">    returned.</span>
00314 <span class="comment"></span>
00315 <span class="comment">--*/</span>
00316 {
00317     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
00318     ULONG count = 0, size, i, j;
00319     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
00320     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
00321     PIO_RESOURCE_DESCRIPTOR ioDesc;
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">// First determine number of descriptors required.</span>
00325     <span class="comment">//</span>
00326 
00327     cmFullDesc = &amp;CmResourceList-&gt;List[0];
00328     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
00329         count += cmFullDesc-&gt;PartialResourceList.Count;
00330         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
00331         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
00332             size = 0;
00333             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
00334             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
00335                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
00336                  <span class="keywordflow">break</span>;
00337             }
00338             cmPartDesc++;
00339             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
00340         }
00341         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
00342     }
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
00346     <span class="comment">//</span>
00347 
00348     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00349                        PagedPool,
00350                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
00351                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
00352                        );
00353     <span class="keywordflow">if</span> (!ioResReqList) {
00354         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00355     }
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
00359     <span class="comment">//</span>
00360 
00361     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
00362     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
00363     ioResReqList-&gt;SlotNumber = SlotNumber;
00364     ioResReqList-&gt;Reserved[0] = 0;
00365     ioResReqList-&gt;Reserved[1] = 0;
00366     ioResReqList-&gt;Reserved[2] = 0;
00367     ioResReqList-&gt;AlternativeLists = 1;
00368     ioResReqList-&gt;List[0].Version = 1;
00369     ioResReqList-&gt;List[0].Revision = 1;
00370     ioResReqList-&gt;List[0].Count = count;
00371 
00372     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
00373     cmFullDesc = &amp;CmResourceList-&gt;List[0];
00374     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
00375         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
00376         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
00377             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
00378             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
00379             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
00380             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
00381             ioDesc-&gt;Spare1 = 0;
00382             ioDesc-&gt;Spare2 = 0;
00383 
00384             size = 0;
00385             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
00386             <span class="keywordflow">case</span> CmResourceTypePort:
00387                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
00388                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
00389                                                              cmPartDesc-&gt;u.Port.Length - 1;
00390                  ioDesc-&gt;u.Port.Alignment = 1;
00391                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
00392                  ioDesc++;
00393                  <span class="keywordflow">break</span>;
00394             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00395                  ioDesc-&gt;u.Interrupt.MinimumVector = cmPartDesc-&gt;u.Interrupt.Vector;
00396                  ioDesc-&gt;u.Interrupt.MaximumVector = cmPartDesc-&gt;u.Interrupt.Vector;
00397                  ioDesc++;
00398                  <span class="keywordflow">break</span>;
00399             <span class="keywordflow">case</span> CmResourceTypeMemory:
00400                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
00401                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
00402                                                                cmPartDesc-&gt;u.Memory.Length - 1;
00403                  ioDesc-&gt;u.Memory.Alignment = 1;
00404                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
00405                  ioDesc++;
00406                  <span class="keywordflow">break</span>;
00407             <span class="keywordflow">case</span> CmResourceTypeDma:
00408                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
00409                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
00410                  ioDesc++;
00411                  <span class="keywordflow">break</span>;
00412             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
00413                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
00414                  <span class="keywordflow">break</span>;
00415             }
00416             cmPartDesc++;
00417             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
00418         }
00419         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
00420     }
00421     ioResReqList-&gt;ListSize = (ULONG)ioDesc - (ULONG)ioResReqList;
00422     <span class="keywordflow">return</span> ioResReqList;
00423 }
00424 
00425 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00426 IopAdjustResourceListRange (
00427     IN <a class="code" href="../../d4/d7/struct__SUPPORTED__RANGES.html">PSUPPORTED_RANGES</a>                    SupportedRanges,
00428     IN <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>                     InterruptRange,
00429     IN PIO_RESOURCE_REQUIREMENTS_LIST       IoResourceList,
00430     IN OUT PIO_RESOURCE_REQUIREMENTS_LIST   *ReturnedList
00431     )
00432 <span class="comment">/*++</span>
00433 <span class="comment"></span>
00434 <span class="comment">Routine Description:</span>
00435 <span class="comment"></span>
00436 <span class="comment">    This functions takes an IO_RESOURCE_REQUIREMENT_LIST and</span>
00437 <span class="comment">    adjusts it such that all ranges in the list fit in the</span>
00438 <span class="comment">    ranges specified by SupportedRanges &amp; InterruptRange.</span>
00439 <span class="comment"></span>
00440 <span class="comment">    This function is used by some HALs to clip the possible</span>
00441 <span class="comment">    settings to be contained on what the particular bus supports</span>
00442 <span class="comment">    in reponse to a HalAdjustResourceList call.</span>
00443 <span class="comment"></span>
00444 <span class="comment">Arguments:</span>
00445 <span class="comment"></span>
00446 <span class="comment">    SupportedRanges - Valid IO, Memory, Prefetch Memory, and DMA ranges.</span>
00447 <span class="comment">    InterruptRange  - Valid InterruptRanges</span>
00448 <span class="comment"></span>
00449 <span class="comment">    pResourceList   - The resource requirements list which needs to</span>
00450 <span class="comment">                      be adjusted to only contain the ranges as</span>
00451 <span class="comment">                      described by SupportedRanges &amp; InterruptRange.</span>
00452 <span class="comment"></span>
00453 <span class="comment">Return Value:</span>
00454 <span class="comment"></span>
00455 <span class="comment">    STATUS_SUCCESS or an appropiate error return.</span>
00456 <span class="comment"></span>
00457 <span class="comment">--*/</span>
00458 {
00459     PIO_RESOURCE_REQUIREMENTS_LIST  InCompleteList, OutCompleteList;
00460     PIO_RESOURCE_LIST               InResourceList, OutResourceList;
00461     PIO_RESOURCE_DESCRIPTOR         HeadOutDesc, SetDesc;
00462     NRPARAMS                        Pos;
00463     ULONG                           len, alt, cnt, i;
00464     ULONG                           icnt, ListCount;
00465     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">// Sanity check</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">if</span> (!SupportedRanges  ||  SupportedRanges-&gt;Version != <a class="code" href="../../d2/d7/hal_8h.html#a15">BUS_SUPPORTED_RANGE_VERSION</a>) {
00472         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00473     }
00474 
00475     <span class="comment">//</span>
00476     <span class="comment">// If SupportedRanges aren't sorted, sort them and get the</span>
00477     <span class="comment">// number of ranges for each type</span>
00478     <span class="comment">//</span>
00479 
00480     <span class="keywordflow">if</span> (!SupportedRanges-&gt;Sorted) {
00481         SupportedRanges-&gt;NoIO = IopSortRanges (&amp;SupportedRanges-&gt;IO);
00482         SupportedRanges-&gt;NoMemory = IopSortRanges (&amp;SupportedRanges-&gt;Memory);
00483         SupportedRanges-&gt;NoPrefetchMemory = IopSortRanges (&amp;SupportedRanges-&gt;PrefetchMemory);
00484         SupportedRanges-&gt;NoDma = IopSortRanges (&amp;SupportedRanges-&gt;Dma);
00485         SupportedRanges-&gt;Sorted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00486     }
00487 
00488     icnt = IopSortRanges (InterruptRange);
00489 
00490     InCompleteList = IoResourceList;
00491     len = InCompleteList-&gt;ListSize;
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">// Scan input list - verify revision #'s, and increase len varible</span>
00495     <span class="comment">// by amount output list may increase.</span>
00496     <span class="comment">//</span>
00497 
00498     i = 0;
00499     InResourceList = InCompleteList-&gt;List;
00500     <span class="keywordflow">for</span> (alt=0; alt &lt; InCompleteList-&gt;AlternativeLists; alt++) {
00501         <span class="keywordflow">if</span> (InResourceList-&gt;Version != 1 || InResourceList-&gt;Revision &lt; 1) {
00502             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00503         }
00504 
00505         Pos.InDesc  = InResourceList-&gt;Descriptors;
00506         <span class="keywordflow">for</span> (cnt = InResourceList-&gt;Count; cnt; cnt--) {
00507             <span class="keywordflow">switch</span> (Pos.InDesc-&gt;Type) {
00508                 <span class="keywordflow">case</span> CmResourceTypeInterrupt: i += icnt;                   <span class="keywordflow">break</span>;
00509                 <span class="keywordflow">case</span> CmResourceTypePort:      i += SupportedRanges-&gt;NoIO;  <span class="keywordflow">break</span>;
00510                 <span class="keywordflow">case</span> CmResourceTypeDma:       i += SupportedRanges-&gt;NoDma; <span class="keywordflow">break</span>;
00511 
00512                 <span class="keywordflow">case</span> CmResourceTypeMemory:
00513                     i += SupportedRanges-&gt;NoMemory;
00514                     <span class="keywordflow">if</span> (Pos.InDesc-&gt;Flags &amp; CM_RESOURCE_MEMORY_PREFETCHABLE) {
00515                         i += SupportedRanges-&gt;NoPrefetchMemory;
00516                     }
00517                     <span class="keywordflow">break</span>;
00518 
00519                 <span class="keywordflow">default</span>:
00520                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00521             }
00522 
00523             <span class="comment">// take one off for the original which is already accounted for in 'len'</span>
00524             i -= 1;
00525 
00526             <span class="comment">// Next descriptor</span>
00527             Pos.InDesc++;
00528         }
00529 
00530         <span class="comment">// Next Resource List</span>
00531         InResourceList  = (PIO_RESOURCE_LIST) Pos.InDesc;
00532     }
00533     len += i * <span class="keyword">sizeof</span> (IO_RESOURCE_DESCRIPTOR);
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">// Allocate output list</span>
00537     <span class="comment">//</span>
00538 
00539     OutCompleteList = (PIO_RESOURCE_REQUIREMENTS_LIST)
00540                             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (PagedPool, len);
00541 
00542     <span class="keywordflow">if</span> (!OutCompleteList) {
00543         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00544     }
00545 
00546     RtlZeroMemory (OutCompleteList, len);
00547 
00548     <span class="comment">//</span>
00549     <span class="comment">// Walk each ResourceList and build output structure</span>
00550     <span class="comment">//</span>
00551 
00552     InResourceList   = InCompleteList-&gt;List;
00553     *OutCompleteList = *InCompleteList;
00554     OutResourceList  = OutCompleteList-&gt;List;
00555     ListCount = InCompleteList-&gt;AlternativeLists;
00556 
00557     <span class="keywordflow">for</span> (alt=0; alt &lt; InCompleteList-&gt;AlternativeLists; alt++) {
00558         OutResourceList-&gt;Version  = 1;
00559         OutResourceList-&gt;Revision = 1;
00560 
00561         Pos.InDesc  = InResourceList-&gt;Descriptors;
00562         Pos.OutDesc = OutResourceList-&gt;Descriptors;
00563         HeadOutDesc = Pos.OutDesc;
00564 
00565         <span class="keywordflow">for</span> (cnt = InResourceList-&gt;Count; cnt; cnt--) {
00566 
00567             <span class="comment">//</span>
00568             <span class="comment">// Limit desctiptor to be with the buses supported ranges</span>
00569             <span class="comment">//</span>
00570 
00571             Pos.DescOpt = Pos.InDesc-&gt;Option | IO_RESOURCE_PREFERRED;
00572             Pos.AnotherListPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00573 
00574             <span class="keywordflow">switch</span> (Pos.InDesc-&gt;Type) {
00575                 <span class="keywordflow">case</span> CmResourceTypePort:
00576 
00577                     <span class="comment">//</span>
00578                     <span class="comment">// Get supported IO ranges</span>
00579                     <span class="comment">//</span>
00580 
00581                     Pos.CurrentPosition = &amp;SupportedRanges-&gt;IO;
00582                     <span class="keywordflow">do</span> {
00583                         status = IopGetNextSupportedRange (
00584                                     Pos.InDesc-&gt;u.Port.MinimumAddress.QuadPart,
00585                                     Pos.InDesc-&gt;u.Port.MaximumAddress.QuadPart,
00586                                     &amp;Pos,
00587                                     &amp;SetDesc
00588                                     );
00589                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00590                             <span class="keywordflow">if</span> (SetDesc) {
00591                                 SetDesc-&gt;u.Port.MinimumAddress.QuadPart = Pos.Base;
00592                                 SetDesc-&gt;u.Port.MaximumAddress.QuadPart = Pos.Limit;
00593                             }
00594                         } <span class="keywordflow">else</span> {
00595                             <span class="keywordflow">goto</span> skipCurrentList;
00596                         }
00597                     } <span class="keywordflow">while</span> (SetDesc) ;
00598                     <span class="keywordflow">break</span>;
00599 
00600                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
00601                     <span class="comment">//</span>
00602                     <span class="comment">// Get supported Interrupt ranges</span>
00603                     <span class="comment">//</span>
00604 
00605                     Pos.CurrentPosition = InterruptRange;
00606                     <span class="keywordflow">do</span> {
00607                         status = IopGetNextSupportedRange (
00608                                     Pos.InDesc-&gt;u.Interrupt.MinimumVector,
00609                                     Pos.InDesc-&gt;u.Interrupt.MaximumVector,
00610                                     &amp;Pos,
00611                                     &amp;SetDesc
00612                                     );
00613 
00614                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00615                             <span class="keywordflow">if</span> (SetDesc) {
00616                                 SetDesc-&gt;u.Interrupt.MinimumVector = (ULONG) Pos.Base;
00617                                 SetDesc-&gt;u.Interrupt.MaximumVector = (ULONG) Pos.Limit;
00618                             }
00619                         } <span class="keywordflow">else</span> {
00620                             <span class="keywordflow">goto</span> skipCurrentList;
00621                         }
00622                     } <span class="keywordflow">while</span> (SetDesc) ;
00623                     <span class="keywordflow">break</span>;
00624 
00625                 <span class="keywordflow">case</span> CmResourceTypeMemory:
00626                     <span class="comment">//</span>
00627                     <span class="comment">// Get supported memory ranges</span>
00628                     <span class="comment">//</span>
00629 
00630                     <span class="keywordflow">if</span> (Pos.InDesc-&gt;Flags &amp; CM_RESOURCE_MEMORY_PREFETCHABLE) {
00631 
00632                         <span class="comment">//</span>
00633                         <span class="comment">// This is a Prefetchable range.</span>
00634                         <span class="comment">// First add in any supported prefetchable ranges, then</span>
00635                         <span class="comment">// add in any regualer supported ranges</span>
00636                         <span class="comment">//</span>
00637 
00638                         Pos.AnotherListPending = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00639                         Pos.CurrentPosition = &amp;SupportedRanges-&gt;PrefetchMemory;
00640 
00641                         <span class="keywordflow">do</span> {
00642                             status = IopGetNextSupportedRange (
00643                                         Pos.InDesc-&gt;u.Memory.MinimumAddress.QuadPart,
00644                                         Pos.InDesc-&gt;u.Memory.MaximumAddress.QuadPart,
00645                                         &amp;Pos,
00646                                         &amp;SetDesc
00647                                         );
00648 
00649                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00650                                 <span class="keywordflow">if</span> (SetDesc) {
00651                                     SetDesc-&gt;u.Memory.MinimumAddress.QuadPart = Pos.Base;
00652                                     SetDesc-&gt;u.Memory.MaximumAddress.QuadPart = Pos.Limit;
00653                                     SetDesc-&gt;Option |= IO_RESOURCE_PREFERRED;
00654                                 }
00655                             } <span class="keywordflow">else</span> {
00656                                 <span class="keywordflow">goto</span> skipCurrentList;
00657                             }
00658                         } <span class="keywordflow">while</span> (SetDesc) ;
00659 
00660                         Pos.AnotherListPending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00661                     }
00662 
00663                     <span class="comment">//</span>
00664                     <span class="comment">// Add in supported bus memory ranges</span>
00665                     <span class="comment">//</span>
00666 
00667                     Pos.CurrentPosition = &amp;SupportedRanges-&gt;Memory;
00668                     <span class="keywordflow">do</span> {
00669                         status = IopGetNextSupportedRange (
00670                                         Pos.InDesc-&gt;u.Memory.MinimumAddress.QuadPart,
00671                                         Pos.InDesc-&gt;u.Memory.MaximumAddress.QuadPart,
00672                                         &amp;Pos,
00673                                         &amp;SetDesc
00674                                         );
00675                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00676                             <span class="keywordflow">if</span> (SetDesc) {
00677                                 SetDesc-&gt;u.Memory.MinimumAddress.QuadPart = Pos.Base;
00678                                 SetDesc-&gt;u.Memory.MaximumAddress.QuadPart = Pos.Limit;
00679                             }
00680                         } <span class="keywordflow">else</span> {
00681                             <span class="keywordflow">goto</span> skipCurrentList;
00682                         }
00683                     } <span class="keywordflow">while</span> (SetDesc);
00684                     <span class="keywordflow">break</span>;
00685 
00686                 <span class="keywordflow">case</span> CmResourceTypeDma:
00687                     <span class="comment">//</span>
00688                     <span class="comment">// Get supported DMA ranges</span>
00689                     <span class="comment">//</span>
00690 
00691                     Pos.CurrentPosition = &amp;SupportedRanges-&gt;Dma;
00692                     <span class="keywordflow">do</span> {
00693                         status = IopGetNextSupportedRange (
00694                                     Pos.InDesc-&gt;u.Dma.MinimumChannel,
00695                                     Pos.InDesc-&gt;u.Dma.MaximumChannel,
00696                                     &amp;Pos,
00697                                     &amp;SetDesc
00698                                     );
00699 
00700                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00701                             <span class="keywordflow">if</span> (SetDesc) {
00702                                 SetDesc-&gt;u.Dma.MinimumChannel = (ULONG) Pos.Base;
00703                                 SetDesc-&gt;u.Dma.MaximumChannel = (ULONG) Pos.Limit;
00704                             }
00705                          } <span class="keywordflow">else</span> {
00706                              <span class="keywordflow">goto</span> skipCurrentList;
00707                          }
00708                     } <span class="keywordflow">while</span> (SetDesc) ;
00709                     <span class="keywordflow">break</span>;
00710 
00711 <span class="preprocessor">#if DBG</span>
00712 <span class="preprocessor"></span>                <span class="keywordflow">default</span>:
00713                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"HalAdjustResourceList: Unkown resource type\n"</span>);
00714                     <span class="keywordflow">break</span>;
00715 <span class="preprocessor">#endif</span>
00716 <span class="preprocessor"></span>            }
00717 
00718             <span class="comment">//</span>
00719             <span class="comment">// Next descriptor</span>
00720             <span class="comment">//</span>
00721 
00722             Pos.InDesc++;
00723         }
00724 
00725         OutResourceList-&gt;Count = Pos.OutDesc - HeadOutDesc;
00726 
00727         <span class="comment">//</span>
00728         <span class="comment">// Next Resource List</span>
00729         <span class="comment">//</span>
00730 
00731         InResourceList  = (PIO_RESOURCE_LIST) Pos.InDesc;
00732         OutResourceList = (PIO_RESOURCE_LIST) Pos.OutDesc;
00733         <span class="keywordflow">continue</span>;
00734 
00735 skipCurrentList:
00736         InResourceList = (PIO_RESOURCE_LIST) (InResourceList-&gt;Descriptors + InResourceList-&gt;Count);
00737         ListCount--;
00738     }
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">// Return output list</span>
00742     <span class="comment">//</span>
00743 
00744     <span class="keywordflow">if</span> (ListCount == 0) {
00745         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OutCompleteList);
00746         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00747     } <span class="keywordflow">else</span> {
00748         OutCompleteList-&gt;ListSize = (ULONG) ((PUCHAR) OutResourceList - (PUCHAR) OutCompleteList);
00749         OutCompleteList-&gt;AlternativeLists = ListCount;
00750         *ReturnedList = OutCompleteList;
00751         <span class="keywordflow">return</span> STATUS_SUCCESS;
00752     }
00753 }
00754 
00755 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00756 IopGetNextSupportedRange (
00757     IN LONGLONG MinimumAddress,
00758     IN LONGLONG MaximumAddress,
00759     IN OUT PNRPARAMS Pos,
00760     OUT PIO_RESOURCE_DESCRIPTOR *IoDescriptor
00761     )
00762 <span class="comment">/*++</span>
00763 <span class="comment"></span>
00764 <span class="comment">Routine Description:</span>
00765 <span class="comment"></span>
00766 <span class="comment">    Support function for IopAdjustResourceListRange.</span>
00767 <span class="comment">    Returns the next supported range in the area passed in.</span>
00768 <span class="comment"></span>
00769 <span class="comment">Arguments:</span>
00770 <span class="comment"></span>
00771 <span class="comment">    MinimumAddress</span>
00772 <span class="comment">    MaximumAddress  - Min &amp; Max address of a range which needs</span>
00773 <span class="comment">                      to be clipped to match that of the supported</span>
00774 <span class="comment">                      ranges of the current bus.</span>
00775 <span class="comment"></span>
00776 <span class="comment">    Pos             - describes the current postion</span>
00777 <span class="comment"></span>
00778 <span class="comment">    IoDescriptor    - returns the adjusted resource descriptor</span>
00779 <span class="comment">                      NULL is no more returned ranges</span>
00780 <span class="comment"></span>
00781 <span class="comment">Return Value:</span>
00782 <span class="comment"></span>
00783 <span class="comment">    Otherwise, the IO_RESOURCE_DESCRIPTOR which needs to be set</span>
00784 <span class="comment">    with the matching range returned in Pos.</span>
00785 <span class="comment"></span>
00786 <span class="comment">--*/</span>
00787 {
00788     LONGLONG Base, Limit;
00789 
00790     <span class="comment">//</span>
00791     <span class="comment">// Find next range which is supported</span>
00792     <span class="comment">//</span>
00793 
00794     Base  = MinimumAddress;
00795     Limit = MaximumAddress;
00796 
00797     <span class="keywordflow">while</span> (Pos-&gt;CurrentPosition) {
00798         Pos-&gt;Base  = Base;
00799         Pos-&gt;Limit = Limit;
00800 
00801         <span class="comment">//</span>
00802         <span class="comment">// Clip to current range</span>
00803         <span class="comment">//</span>
00804 
00805         <span class="keywordflow">if</span> (Pos-&gt;Base &lt; Pos-&gt;CurrentPosition-&gt;Base) {
00806             Pos-&gt;Base = Pos-&gt;CurrentPosition-&gt;Base;
00807         }
00808 
00809         <span class="keywordflow">if</span> (Pos-&gt;Limit &gt; Pos-&gt;CurrentPosition-&gt;Limit) {
00810             Pos-&gt;Limit = Pos-&gt;CurrentPosition-&gt;Limit;
00811         }
00812 
00813         <span class="comment">//</span>
00814         <span class="comment">// set position to next range</span>
00815         <span class="comment">//</span>
00816 
00817         Pos-&gt;CurrentPosition = Pos-&gt;CurrentPosition-&gt;Next;
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// If valid range, return it</span>
00821         <span class="comment">//</span>
00822 
00823         <span class="keywordflow">if</span> (Pos-&gt;Base &lt;= Pos-&gt;Limit) {
00824             *Pos-&gt;OutDesc = *Pos-&gt;InDesc;
00825             Pos-&gt;OutDesc-&gt;Option = Pos-&gt;DescOpt;
00826 
00827             <span class="comment">//</span>
00828             <span class="comment">// next descriptor (if any) is an alternative</span>
00829             <span class="comment">// to the descriptor being returned now</span>
00830             <span class="comment">//</span>
00831 
00832             Pos-&gt;OutDesc += 1;
00833             Pos-&gt;DescOpt |= IO_RESOURCE_ALTERNATIVE;
00834             *IoDescriptor = Pos-&gt;OutDesc - 1;
00835             <span class="keywordflow">return</span> STATUS_SUCCESS;
00836         }
00837     }
00838 
00839     <span class="comment">//</span>
00840     <span class="comment">// There's no overlapping range.  If this descriptor is</span>
00841     <span class="comment">// not an alternative and this descriptor is not going to</span>
00842     <span class="comment">// be processed by another range list, then return</span>
00843     <span class="comment">// failure.</span>
00844     <span class="comment">//</span>
00845 
00846     <span class="keywordflow">if</span> (!(Pos-&gt;DescOpt &amp; IO_RESOURCE_ALTERNATIVE) &amp;&amp;
00847         Pos-&gt;AnotherListPending == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00848 
00849         <span class="comment">//</span>
00850         <span class="comment">// return a bogus descriptor</span>
00851         <span class="comment">//</span>
00852 
00853         Pos-&gt;Base  = MinimumAddress;
00854         Pos-&gt;Limit = Pos-&gt;Base - 1;
00855         <span class="keywordflow">if</span> (Pos-&gt;Base == 0) {       <span class="comment">// if wrapped, fix it</span>
00856             Pos-&gt;Base  = 1;
00857             Pos-&gt;Limit = 0;
00858         }
00859 
00860         *Pos-&gt;OutDesc = *Pos-&gt;InDesc;
00861         Pos-&gt;OutDesc-&gt;Option = Pos-&gt;DescOpt;
00862 
00863         Pos-&gt;OutDesc += 1;
00864         Pos-&gt;DescOpt |= IO_RESOURCE_ALTERNATIVE;
00865         *IoDescriptor = Pos-&gt;OutDesc - 1;
00866         <span class="keywordflow">return</span> STATUS_SUCCESS;
00867     }
00868 
00869     <span class="comment">//</span>
00870     <span class="comment">// No range found (or no more ranges)</span>
00871     <span class="comment">//</span>
00872 
00873     *IoDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00874     <span class="keywordflow">return</span> STATUS_SUCCESS;
00875 }
00876 
00877 ULONG
00878 IopSortRanges (
00879     IN <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a> RangeList
00880     )
00881 <span class="comment">/*++</span>
00882 <span class="comment"></span>
00883 <span class="comment">Routine Description:</span>
00884 <span class="comment"></span>
00885 <span class="comment">    Support function for IopAdjustResourceListRange.</span>
00886 <span class="comment">    Sorts a supported range list into decending order.</span>
00887 <span class="comment"></span>
00888 <span class="comment">Arguments:</span>
00889 <span class="comment"></span>
00890 <span class="comment">    pRange  - List to sort</span>
00891 <span class="comment"></span>
00892 <span class="comment">Return Value:</span>
00893 <span class="comment"></span>
00894 <span class="comment">--*/</span>
00895 {
00896     ULONG               cnt;
00897     LONGLONG            hldBase, hldLimit;
00898     <a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html">PSUPPORTED_RANGE</a>    Range1, Range2;
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Sort it</span>
00902     <span class="comment">//</span>
00903 
00904     <span class="keywordflow">for</span> (Range1 = RangeList; Range1; Range1 = Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>) {
00905         <span class="keywordflow">for</span> (Range2 = Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>; Range2; Range2 = Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>) {
00906 
00907             <span class="keywordflow">if</span> (Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a> &gt; Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a>) {
00908                 hldBase  = Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a>;
00909                 hldLimit = Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o4">Limit</a>;
00910 
00911                 Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a>  = Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a>;
00912                 Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o4">Limit</a> = Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o4">Limit</a>;
00913 
00914                 Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o3">Base</a>  = hldBase;
00915                 Range2-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o4">Limit</a> = hldLimit;
00916             }
00917         }
00918     }
00919 
00920     <span class="comment">//</span>
00921     <span class="comment">// Count the number of ranges</span>
00922     <span class="comment">//</span>
00923 
00924     cnt = 0;
00925     <span class="keywordflow">for</span> (Range1 = RangeList; Range1; Range1 = Range1-&gt;<a class="code" href="../../d3/d7/struct__SUPPORTED__RANGE.html#o0">Next</a>) {
00926         cnt += 1;
00927     }
00928 
00929     <span class="keywordflow">return</span> cnt;
00930 }
00931 <span class="preprocessor">#endif // _PNP_POWER_</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
