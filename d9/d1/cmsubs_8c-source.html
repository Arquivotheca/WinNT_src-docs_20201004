<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmsubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmsubs.c</h1><a href="../../d8/d2/cmsubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmsubs.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module various support routines for the configuration manager.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    The routines in this module are not independent enough to be linked</span>
00014 <span class="comment">    into any other program.  The routines in cmsubs2.c are.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Bryan M. Willman (bryanwi) 12-Sep-1991</span>
00019 <span class="comment"></span>
00020 <span class="comment">Revision History:</span>
00021 <span class="comment"></span>
00022 <span class="comment">--*/</span>
00023 
00024 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00025 
<a name="l00026"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a0">00026</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d1/d2/cmp_8h.html#a155">CmpKcbLock</a>;
<a name="l00027"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a1">00027</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d1/d2/cmp_8h.html#a177">CmpPostLock</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a2">00029</a> <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>;
<a name="l00030"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a3">00030</a> ULONG <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a> = 2048;
<a name="l00031"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a4">00031</a> ULONG <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a> = 512;
<a name="l00032"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a5">00032</a> <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
<a name="l00033"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a6">00033</a> <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
<a name="l00034"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a7">00034</a> ULONG_PTR <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>=0;
<a name="l00035"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a8">00035</a> <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> *<a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>;
00036 
00037 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00038 <a class="code" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a>(
00039     IN <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash
00040     );
00041 
00042 <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>
00043 <a class="code" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a>(
00044     IN <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash,
00045     IN BOOLEAN      FakeKey
00046     );
00047 
00048 <span class="comment">//</span>
00049 <span class="comment">// private prototype for recursive worker</span>
00050 <span class="comment">//</span>
00051 
00052 
00053 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00054 <a class="code" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a>(
00055     <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>   Ncb
00056     );
00057 
00058 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00059 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 CmpDumpKeyBodyList(
00061     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcb,
00062     IN PULONG                  Count
00063     );
00064 <span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00067 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSearchForOpenSubKeys)</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpReferenceKeyControlBlock)</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetNameControlBlock)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDereferenceNameControlBlockWithLock)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCleanUpSubKeyInfo)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCleanUpKcbValueCache)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCleanUpKcbCacheWithLock)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpConstructName)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRemoveFromDelayedClose)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreateKeyControlBlock)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSearchKeyControlBlockTree)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDereferenceKeyControlBlock)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDereferenceKeyControlBlockWithLock)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRemoveKeyControlBlock)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFreeKeyBody)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInsertKeyHash)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpRemoveKeyHash)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpInitializeCache)</span>
00085 <span class="preprocessor"></span>
00086 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDumpKeyBodyList)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpFlushNotifiesOnKeyBodyList)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00090 <span class="preprocessor"></span>
00091 <span class="preprocessor">#endif</span>
00092 <span class="preprocessor"></span>
00093 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00094 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00095 CmpDumpKeyBodyList(
00096     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcb,
00097     IN PULONG                  Count
00098     )
00099 {
00100         
00101     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>    KeyBody;
00102     PUNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00103 
00104     <span class="keywordflow">if</span>( IsListEmpty(&amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead)) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00105         <span class="comment">//</span>
00106         <span class="comment">// Nobody has this subkey open, but for sure some subkey must be </span>
00107         <span class="comment">// open. nicely return.</span>
00108         <span class="comment">//</span>
00109         <span class="keywordflow">return</span>;
00110     }
00111 
00112 
00113     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(kcb);
00114     <span class="keywordflow">if</span>( !<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> ){
00115         <span class="comment">// oops, we're low on resources</span>
00116         <span class="keywordflow">return</span>;
00117     }
00118     
00119     <span class="comment">//</span>
00120     <span class="comment">// now iterate through the list of KEY_BODYs referencing this kcb</span>
00121     <span class="comment">//</span>
00122     KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead.Flink;
00123     <span class="keywordflow">while</span>( KeyBody != (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(&amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead)) ) {
00124         KeyBody = CONTAINING_RECORD(KeyBody,
00125                                     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>,
00126                                     KeyBodyList);
00127         <span class="comment">//</span>
00128         <span class="comment">// sanity check: this should be a KEY_BODY</span>
00129         <span class="comment">//</span>
00130         <a class="code" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(KeyBody);
00131         
00132         <span class="comment">//</span>
00133         <span class="comment">// dump it's name and owning process</span>
00134         <span class="comment">//</span>
00135         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Process %lx :: Key %wZ \n"</span>,KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a>,Name);
00136         
00137         <span class="comment">// count it</span>
00138         (*Count)++;
00139         
00140         KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)KeyBody-&gt;KeyBodyList.Flink;
00141     }
00142 
00143     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Name, CM_NAME_TAG | PROTECTED_POOL);
00144 
00145 }
00146 
00147 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00148 CmpFlushNotifiesOnKeyBodyList(
00149     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcb
00150     )
00151 {
00152     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>    KeyBody;
00153     
00154     <span class="keywordflow">if</span>( IsListEmpty(&amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead)) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) {
00155         <span class="comment">//</span>
00156         <span class="comment">// now iterate through the list of KEY_BODYs referencing this kcb</span>
00157         <span class="comment">//</span>
00158         KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead.Flink;
00159         <span class="keywordflow">while</span>( KeyBody != (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(&amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyBodyListHead)) ) {
00160             KeyBody = CONTAINING_RECORD(KeyBody,
00161                                         <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>,
00162                                         KeyBodyList);
00163             <span class="comment">//</span>
00164             <span class="comment">// sanity check: this should be a KEY_BODY</span>
00165             <span class="comment">//</span>
00166             <a class="code" href="../../d1/d2/cmp_8h.html#a83">ASSERT_KEY_OBJECT</a>(KeyBody);
00167 
00168             <span class="comment">//</span>
00169             <span class="comment">// flush any notifies that might be set on it</span>
00170             <span class="comment">//</span>
00171             <a class="code" href="../../d1/d2/cmp_8h.html#a288">CmpFlushNotify</a>(KeyBody);
00172 
00173             KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)KeyBody-&gt;KeyBodyList.Flink;
00174         }
00175     }
00176 }
00177 <span class="preprocessor">#endif</span>
00178 <span class="preprocessor"></span>
00179 ULONG
<a name="l00180"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a12">00180</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(
00181     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock,
00182     SUBKEY_SEARCH_TYPE      SearchType
00183     )
00184 <span class="comment">/*++</span>
00185 <span class="comment">Routine Description:</span>
00186 <span class="comment"></span>
00187 <span class="comment">    This routine searches the KCB tree for any open handles to keys that</span>
00188 <span class="comment">    are subkeys of the given key.</span>
00189 <span class="comment"></span>
00190 <span class="comment">    It is used by CmRestoreKey to verify that the tree being restored to</span>
00191 <span class="comment">    has no open handles.</span>
00192 <span class="comment"></span>
00193 <span class="comment">Arguments:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    KeyControlBlock - Supplies the key control block for the key for which</span>
00196 <span class="comment">        open subkeys are to be found.</span>
00197 <span class="comment"></span>
00198 <span class="comment">    SearchType - the type of the search</span>
00199 <span class="comment">        SearchIfExist - exits at the first open subkey found ==&gt; returns 1 if any subkey is open</span>
00200 <span class="comment">        </span>
00201 <span class="comment">        SearchAndDeref - Forces the keys underneath the Key referenced KeyControlBlock to </span>
00202 <span class="comment">                be marked as not referenced (see the REG_FORCE_RESTORE flag in CmRestoreKey) </span>
00203 <span class="comment">                returns 1 if at least one deref was made</span>
00204 <span class="comment">        </span>
00205 <span class="comment">        SearchAndCount - Counts all open subkeys - returns the number of them</span>
00206 <span class="comment"></span>
00207 <span class="comment">Return Value:</span>
00208 <span class="comment"></span>
00209 <span class="comment">    TRUE  - open handles to subkeys of the given key exist</span>
00210 <span class="comment"></span>
00211 <span class="comment">    FALSE - open handles to subkeys of the given key do not exist.</span>
00212 <span class="comment">--*/</span>
00213 {
00214     ULONG i;
00215     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Current;
00216     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00217     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Realkcb;
00218     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Parent;
00219     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LevelDiff, l;
00220     ULONG   <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00221     
00222     <span class="comment">//</span>
00223     <span class="comment">// Registry lock should be held exclusively, so no need to KCB lock</span>
00224     <span class="comment">//</span>
00225     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00226 
00227 
00228     <span class="comment">//</span>
00229     <span class="comment">// First, clean up all subkeys in the cache</span>
00230     <span class="comment">//</span>
00231     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
00232         Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00233         <span class="keywordflow">while</span> (*Current) {
00234             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(*Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
00235             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 0) {
00236                 <span class="comment">//</span>
00237                 <span class="comment">// This kcb is in DelayClose case, remove it.</span>
00238                 <span class="comment">//</span>
00239                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00240                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00241 
00242                 <span class="comment">//</span>
00243                 <span class="comment">// The HashTable is changed, start over in this index again.</span>
00244                 <span class="comment">//</span>
00245                 Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00246                 <span class="keywordflow">continue</span>;
00247             }
00248             Current = &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NextHash;
00249         }
00250     }
00251 
00252     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 1) {
00253         <span class="comment">//</span>
00254         <span class="comment">// There is only one open handle, so there must be no open subkeys.</span>
00255         <span class="comment">//</span>
00256         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00257     } <span class="keywordflow">else</span> {
00258         <span class="comment">//</span>
00259         <span class="comment">// Now search for an open subkey handle.</span>
00260         <span class="comment">//</span>
00261         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00262 
00263      
00264 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00265 <span class="preprocessor"></span>        <span class="comment">//</span>
00266         <span class="comment">// dump the root first if we were asked to do so.</span>
00267         <span class="comment">//</span>
00268         <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>) {
00269             CmpDumpKeyBodyList(KeyControlBlock,&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00270         }
00271 <span class="preprocessor">#endif</span>
00272 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
00273 
00274 StartDeref:
00275             Current = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
00276             <span class="keywordflow">while</span> (*Current) {
00277                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(*Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
00278                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels &gt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>) {
00279                     LevelDiff = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels - KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>;
00280                 
00281                     Parent = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00282                     <span class="keywordflow">for</span> (l=0; l&lt;LevelDiff; l++) {
00283                         Parent = Parent-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00284                     }
00285     
00286                     <span class="keywordflow">if</span> (Parent == KeyControlBlock) {
00287                         <span class="comment">//</span>
00288                         <span class="comment">// Found a match;</span>
00289                         <span class="comment">//</span>
00290                         <span class="keywordflow">if</span>( SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a> ) {
00291                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 1;
00292                             <span class="keywordflow">break</span>;
00293                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a101">SearchAndDeref</a>) {
00294                             <span class="comment">//</span>
00295                             <span class="comment">// Mark the key as deleted, remove it from cache, but don't add it</span>
00296                             <span class="comment">// to the Delay Close table (we want the key to be visible only to</span>
00297                             <span class="comment">// the one(s) that have open handles on it.</span>
00298                             <span class="comment">//</span>
00299 
00300                             <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00301 
00302                             <span class="comment">//</span>
00303                             <span class="comment">// flush any pending notifies as the kcb won't be around any longer</span>
00304                             <span class="comment">//</span>
00305 <span class="preprocessor">#ifdef KCB_TO_KEYBODY_LINK</span>
00306 <span class="preprocessor"></span>                            CmpFlushNotifiesOnKeyBodyList(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>                            
00309                             <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb);
00310                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00311                             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00312                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00313                             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00314                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00315                          
00316                             <span class="comment">//</span>
00317                             <span class="comment">// Restart the search </span>
00318                             <span class="comment">// </span>
00319                             <span class="keywordflow">goto</span> StartDeref;
00320                         
00321                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(SearchType == <a class="code" href="../../d9/d0/cmdata_8h.html#a105a102">SearchAndCount</a>) {
00322                             <span class="comment">//</span>
00323                             <span class="comment">// here do the dumping and count incrementing stuff</span>
00324                             <span class="comment">//</span>
00325 <span class="preprocessor">                        #ifdef KCB_TO_KEYBODY_LINK</span>
00326 <span class="preprocessor"></span>                            CmpDumpKeyBodyList(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00327 <span class="preprocessor">                        #else</span>
00328 <span class="preprocessor"></span>                            <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
00329 <span class="preprocessor">                        #endif</span>
00330 <span class="preprocessor"></span>                        }
00331                     }   
00332 
00333                 }
00334                 Current = &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NextHash;
00335             }
00336         }
00337     }
00338     
00339                            
00340     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00341 }
00342 
00343 
00344 BOOLEAN
<a name="l00345"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a13">00345</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(
00346     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
00347     )
00348 {
00349     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00350         <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(KeyControlBlock);
00351     }
00352 
00353     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00354         <span class="comment">//</span>
00355         <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00356         <span class="comment">// some bogus app has opened the same key 64K times without</span>
00357         <span class="comment">// ever closing it. Just fail the call</span>
00358         <span class="comment">//</span>
00359         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00360     } <span class="keywordflow">else</span> {
00361         ++(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>);
00362         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00363     }
00364 }
00365 
00366 
00367 <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>
<a name="l00368"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a14">00368</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a14">CmpGetNameControlBlock</a>(
00369     PUNICODE_STRING NodeName
00370     )
00371 {
00372     <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>   Ncb;
00373     ULONG  Cnt;
00374     WCHAR *Cp;
00375     WCHAR *Cp2;
00376     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00377     ULONG i;
00378     ULONG      <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00379     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> CurrentName;
00380     ULONG rc;
00381     BOOLEAN NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameSize;
00383     BOOLEAN NameCompressed;
00384     ULONG NameConvKey=0;
00385     LONG Result;
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">// Calculate the ConvKey for this NadeName;</span>
00389     <span class="comment">//</span>
00390 
00391     Cp = NodeName-&gt;Buffer;
00392     <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName-&gt;Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00393         <span class="keywordflow">if</span> (*Cp != OBJ_NAME_PATH_SEPARATOR) {
00394             NameConvKey = 37 * NameConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00395         }
00396         ++Cp;
00397     }
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Find the Name Size;</span>
00401     <span class="comment">// </span>
00402     NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403     NameSize = NodeName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00404     <span class="keywordflow">for</span> (i=0;i&lt;NodeName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);i++) {
00405         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NodeName-&gt;Buffer[i] &gt; (UCHAR)-1) {
00406             NameSize = NodeName-&gt;Length;
00407             NameCompressed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00408         }
00409     }
00410 
00411     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(NameConvKey);
00412     CurrentName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00413 
00414     <span class="keywordflow">while</span> (CurrentName) {
00415         Ncb =  CONTAINING_RECORD(CurrentName, <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, NameHash);
00416 
00417         <span class="keywordflow">if</span> ((NameConvKey == CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o0">ConvKey</a>) &amp;&amp;
00418             (NameSize == Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>)) {
00419             <span class="comment">//</span>
00420             <span class="comment">// Hash value matches, compare the names.</span>
00421             <span class="comment">//</span>
00422             NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423             <span class="keywordflow">if</span> (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00424                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(NodeName, Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>, NameSize)) {
00425                     NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00426                 }
00427             } <span class="keywordflow">else</span> {
00428                 Cp = (WCHAR *) NodeName-&gt;Buffer;
00429                 Cp2 = (WCHAR *) Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00430                 <span class="keywordflow">for</span> (i=0 ;i&lt;Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i+= <span class="keyword">sizeof</span>(WCHAR)) {
00431                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp) != <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp2)) {
00432                         NameFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00433                         <span class="keywordflow">break</span>;
00434                     }
00435                     ++Cp;
00436                     ++Cp2;
00437                 }
00438             }
00439             <span class="keywordflow">if</span> (NameFound) {
00440                 <span class="comment">//</span>
00441                 <span class="comment">// Found it, increase the refcount.</span>
00442                 <span class="comment">//</span>
00443                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> + 1) == 0) {
00444                     <span class="comment">//</span>
00445                     <span class="comment">// We have maxed out the ref count.</span>
00446                     <span class="comment">// fail the call.</span>
00447                     <span class="comment">//</span>
00448                     Ncb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00449                 } <span class="keywordflow">else</span> {
00450                     ++Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a>;
00451                 }
00452                 <span class="keywordflow">break</span>;
00453             }
00454         }
00455         CurrentName = CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00456     }
00457     
00458     <span class="keywordflow">if</span> (NameFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00459         <span class="comment">//</span>
00460         <span class="comment">// Now need to create one Name block for this string.</span>
00461         <span class="comment">//</span>
00462         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = FIELD_OFFSET(<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">CM_NAME_CONTROL_BLOCK</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) + NameSize;
00463  
00464         Ncb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00465                                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00466                                     CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00467  
00468         <span class="keywordflow">if</span> (Ncb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00469             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00470         }
00471         RtlZeroMemory(Ncb, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
00472  
00473         <span class="comment">//</span>
00474         <span class="comment">// Update all the info for this newly created Name block.</span>
00475         <span class="comment">//</span>
00476         <span class="keywordflow">if</span> (NameCompressed) {
00477             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00478             <span class="keywordflow">for</span> (i=0;i&lt;NameSize;i++) {
00479                 ((PUCHAR)Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>)[i] = (UCHAR)(NodeName-&gt;Buffer[i]);
00480             }
00481         } <span class="keywordflow">else</span> {
00482             Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00483             RtlCopyMemory((PVOID)(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>), (PVOID)(NodeName-&gt;Buffer), NameSize);
00484         }
00485 
00486         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o3">ConvKey</a> = NameConvKey;
00487         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> = 1;
00488         Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> = NameSize;
00489         
00490         CurrentName = &amp;(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o2">NameHash</a>);
00491         <span class="comment">//</span>
00492         <span class="comment">// Insert into Name Hash table.</span>
00493         <span class="comment">//</span>
00494         CurrentName-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00495         <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = CurrentName;
00496     }
00497 
00498     <span class="keywordflow">return</span>(Ncb);
00499 }
00500 
00501 
00502 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00503"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a11">00503</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a>(
00504     <a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html">PCM_NAME_CONTROL_BLOCK</a>   Ncb
00505     )
00506 {
00507     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> *Prev;
00508     <a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a> Current;
00509 
00510     <span class="keywordflow">if</span> (--Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">// Remove it from the the Hash Table</span>
00514         <span class="comment">//</span>
00515         Prev = &amp;(<a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(<a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>, Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o3">ConvKey</a>));
00516         
00517         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00518             Current = *Prev;
00519             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00520             <span class="keywordflow">if</span> (Current == &amp;(Ncb-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o2">NameHash</a>)) {
00521                 *Prev = Current-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00522                 <span class="keywordflow">break</span>;
00523             }
00524             Prev = &amp;Current-&gt;<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html#o1">NextHash</a>;
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">// Free storage</span>
00529         <span class="comment">//</span>
00530         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Ncb, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00531     }
00532     <span class="keywordflow">return</span>;
00533 }
00534 
00535 
00536 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00537"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a15">00537</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a>(
00538     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
00539     )
00540 <span class="comment">/*++</span>
00541 <span class="comment">Routine Description:</span>
00542 <span class="comment"></span>
00543 <span class="comment">    Clean up the subkey information cache due to create or delete keys.</span>
00544 <span class="comment">    Registry is locked exclusively and no need to lock the KCB.</span>
00545 <span class="comment"></span>
00546 <span class="comment">Arguments:</span>
00547 <span class="comment"></span>
00548 <span class="comment">    KeyControlBlock - pointer to a key control block.</span>
00549 <span class="comment"></span>
00550 <span class="comment">Return Value:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    NONE.</span>
00553 <span class="comment"></span>
00554 <span class="comment">--*/</span>
00555 {
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00557 
00558     <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00559         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; (<a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
00560             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00561         }
00562         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~((<a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>));
00563     }
00564 }
00565 
00566 
00567 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00568"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a16">00568</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(
00569     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
00570     )
00571 <span class="comment">/*++</span>
00572 <span class="comment"></span>
00573 <span class="comment">Routine Description:</span>
00574 <span class="comment"></span>
00575 <span class="comment">    Clean up cached value/data that are associated to this key.</span>
00576 <span class="comment"></span>
00577 <span class="comment">Arguments:</span>
00578 <span class="comment"></span>
00579 <span class="comment">    KeyControlBlock - pointer to a key control block.</span>
00580 <span class="comment"></span>
00581 <span class="comment">Return Value:</span>
00582 <span class="comment"></span>
00583 <span class="comment">    NONE.</span>
00584 <span class="comment"></span>
00585 <span class="comment">--*/</span>
00586 {
00587     ULONG i;
00588     PULONG_PTR CachedList;
00589     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcell;
00590     ULONG      realsize;
00591     BOOLEAN    small;
00592 
00593     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>)) {
00594         CachedList = (PULONG_PTR) <a class="code" href="../../d9/d0/cmdata_8h.html#a47">CMP_GET_CACHED_CELLDATA</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>);
00595         <span class="keywordflow">for</span> (i = 0; i &lt; KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o0">Count</a>; i++) {
00596             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/cmdata_8h.html#a45">CMP_IS_CELL_CACHED</a>(CachedList[i])) {
00597 
00598                 <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00599                 <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]) );
00600 
00601                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(CachedList[i]));
00602                
00603             }
00604         }
00605 
00606         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00607         <a class="code" href="../../d1/d2/cmp_8h.html#a8">CmpMakeSpecialPoolReadWrite</a>( <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>) );
00608 
00609         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID) <a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a>));
00610 
00611         <span class="comment">// Mark the ValueList as NULL </span>
00612         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o1">ValueList</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00613 
00614     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00615         <span class="comment">//</span>
00616         <span class="comment">// This is a symbolic link key with symbolic name resolved.</span>
00617         <span class="comment">// Dereference to its real kcb and clear the bit.</span>
00618         <span class="comment">//</span>
00619         <span class="keywordflow">if</span> ((KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 1) &amp;&amp; !(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>)) {
00620             KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>;
00621         }
00622         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o12">ValueCache</a>.<a class="code" href="../../d5/d6/struct__CACHED__CHILD__LIST.html#o2">RealKcb</a>);
00623         KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00624     }
00625 }
00626 
00627 
00628 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00629"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a17">00629</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(
00630     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
00631     )
00632 <span class="comment">/*++</span>
00633 <span class="comment"></span>
00634 <span class="comment">Routine Description:</span>
00635 <span class="comment"></span>
00636 <span class="comment">    Clean up all cached allocations that are associated to this key.</span>
00637 <span class="comment">    If the parent is still open just because of this one, Remove the parent as well.</span>
00638 <span class="comment"></span>
00639 <span class="comment">Arguments:</span>
00640 <span class="comment"></span>
00641 <span class="comment">    KeyControlBlock - pointer to a key control block.</span>
00642 <span class="comment"></span>
00643 <span class="comment">Return Value:</span>
00644 <span class="comment"></span>
00645 <span class="comment">    NONE.</span>
00646 <span class="comment"></span>
00647 <span class="comment">--*/</span>
00648 {
00649     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Kcb;
00650     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00651 
00652     Kcb = KeyControlBlock;
00653 
00654     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeyControlBlock-&gt;RefCount == 0);
00655 
00656     <span class="keywordflow">while</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
00657         <span class="comment">//</span>
00658         <span class="comment">// First, free allocations for Value/data.</span>
00659         <span class="comment">//</span>
00660     
00661         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(Kcb);
00662     
00663         <span class="comment">//</span>
00664         <span class="comment">// Free the kcb and dereference parentkcb and nameblock.</span>
00665         <span class="comment">//</span>
00666     
00667         <a class="code" href="../../d8/d2/cmsubs_8c.html#a11">CmpDereferenceNameControlBlockWithLock</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>);
00668     
00669         <span class="keywordflow">if</span> (Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>) {
00670             <span class="comment">//</span>
00671             <span class="comment">// Now free the HintIndex allocation</span>
00672             <span class="comment">//</span>
00673             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o13">IndexHint</a>, CM_CACHE_INDEX_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00674         }
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">// Save the ParentKcb before we free the Kcb</span>
00678         <span class="comment">//</span>
00679         ParentKcb = Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00680         
00681         <span class="comment">//</span>
00682         <span class="comment">// We cannot call CmpDereferenceKeyControlBlockWithLock so we can avoid recurrsion.</span>
00683         <span class="comment">//</span>
00684         
00685         <span class="keywordflow">if</span> (!Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
00686             <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(Kcb);
00687         }
00688         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(Kcb, '4FmC');
00689         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(Kcb);
00690         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(Kcb, CM_KCB_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00691 
00692         Kcb = ParentKcb;
00693         Kcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a>--;
00694     }
00695 }
00696 
00697 
00698 PUNICODE_STRING
<a name="l00699"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a18">00699</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(
00700     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb
00701 )
00702 <span class="comment">/*++</span>
00703 <span class="comment"></span>
00704 <span class="comment">Routine Description:</span>
00705 <span class="comment"></span>
00706 <span class="comment">    Construct the name given a kcb.</span>
00707 <span class="comment"></span>
00708 <span class="comment">Arguments:</span>
00709 <span class="comment"></span>
00710 <span class="comment">    kcb - Kcb for the key</span>
00711 <span class="comment"></span>
00712 <span class="comment">Return Value:</span>
00713 <span class="comment"></span>
00714 <span class="comment">    Pointer to the unicode string constructed.  </span>
00715 <span class="comment">    Caller is responsible to free this storage space.</span>
00716 <span class="comment"></span>
00717 <span class="comment">--*/</span>
00718 {
00719     PUNICODE_STRING FullName;
00720     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> TmpKcb;
00721     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00722     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> size;
00723     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00724     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> BeginPosition;
00725     WCHAR *w1, *w2;
00726     UCHAR *u2;
00727 
00728     <span class="comment">//</span>
00729     <span class="comment">// Calculate the total string length.</span>
00730     <span class="comment">//</span>
00731     Length = 0;
00732     TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00733     <span class="keywordflow">while</span> (TmpKcb) {
00734         <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00735             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> * <span class="keyword">sizeof</span>(WCHAR);
00736         } <span class="keywordflow">else</span> {
00737             Length += TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; 
00738         }
00739         <span class="comment">//</span>
00740         <span class="comment">// Add the sapce for OBJ_NAME_PATH_SEPARATOR;</span>
00741         <span class="comment">//</span>
00742         Length += <span class="keyword">sizeof</span>(WCHAR);
00743 
00744         TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00745     }
00746 
00747     <span class="comment">//</span>
00748     <span class="comment">// Allocate the pool for the unicode string</span>
00749     <span class="comment">//</span>
00750     size = <span class="keyword">sizeof</span>(UNICODE_STRING) + Length;
00751 
00752     FullName = (PUNICODE_STRING) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00753                                                        size,
00754                                                        CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00755 
00756     <span class="keywordflow">if</span> (FullName) {
00757         FullName-&gt;Buffer = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> *) ((ULONG_PTR) FullName + <span class="keyword">sizeof</span>(UNICODE_STRING));
00758         FullName-&gt;Length = Length;
00759         FullName-&gt;MaximumLength = Length;
00760 
00761         <span class="comment">//</span>
00762         <span class="comment">// Now fill the name into the buffer.</span>
00763         <span class="comment">//</span>
00764         TmpKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00765         BeginPosition = Length;
00766 
00767         <span class="keywordflow">while</span> (TmpKcb) {
00768             <span class="comment">//</span>
00769             <span class="comment">// Calculate the begin position of each subkey. Then fill in the char.</span>
00770             <span class="comment">//</span>
00771             <span class="comment">//</span>
00772             <span class="keywordflow">if</span> (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
00773                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + 1) * <span class="keyword">sizeof</span>(WCHAR);
00774                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00775                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00776                 w1++;
00777 
00778                 u2 = (UCHAR *) &amp;(TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>[0]);
00779 
00780                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i++) {
00781                     *w1 = (WCHAR)(*u2);
00782                     w1++;
00783                     u2++;
00784                 }
00785             } <span class="keywordflow">else</span> {
00786                 BeginPosition -= (TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a> + <span class="keyword">sizeof</span>(WCHAR));
00787                 w1 = &amp;(FullName-&gt;Buffer[BeginPosition/<span class="keyword">sizeof</span>(WCHAR)]);
00788                 *w1 = OBJ_NAME_PATH_SEPARATOR;
00789                 w1++;
00790 
00791                 w2 = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
00792 
00793                 <span class="keywordflow">for</span> (i=0; i&lt;TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>; i=i+<span class="keyword">sizeof</span>(WCHAR)) {
00794                     *w1 = *w2;
00795                     w1++;
00796                     w2++;
00797                 }
00798             }
00799             TmpKcb = TmpKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
00800         }
00801     }
00802     <span class="keywordflow">return</span> (FullName);
00803 }
00804 
00805 
00806 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00807"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a19">00807</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(
00808     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb
00809     )
00810 {
00811     ULONG i;
00812     i = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex;
00813 
00814     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] == <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00815     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(i != <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>);
00816 
00817     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] = (<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>)<a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
00818     <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = i;
00819     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
00820 }
00821 
00822 
00823 <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>
<a name="l00824"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a20">00824</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(
00825     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00826     HCELL_INDEX     Cell,
00827     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Node,
00828     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb,
00829     BOOLEAN         FakeKey,
00830     PUNICODE_STRING KeyName
00831     )
00832 <span class="comment">/*++</span>
00833 <span class="comment"></span>
00834 <span class="comment">Routine Description:</span>
00835 <span class="comment"></span>
00836 <span class="comment">    Allocate and initialize a key control block, insert it into</span>
00837 <span class="comment">    the kcb tree.</span>
00838 <span class="comment"></span>
00839 <span class="comment">    Full path will be BaseName + '\' + KeyName, unless BaseName</span>
00840 <span class="comment">    NULL, in which case the full path is simply KeyName.</span>
00841 <span class="comment"></span>
00842 <span class="comment">    RefCount of returned KCB WILL have been incremented to reflect</span>
00843 <span class="comment">    callers ref.</span>
00844 <span class="comment"></span>
00845 <span class="comment">Arguments:</span>
00846 <span class="comment"></span>
00847 <span class="comment">    Hive - Supplies Hive that holds the key we are creating a KCB for.</span>
00848 <span class="comment"></span>
00849 <span class="comment">    Cell - Supplies Cell that contains the key we are creating a KCB for.</span>
00850 <span class="comment"></span>
00851 <span class="comment">    Node - Supplies pointer to key node.</span>
00852 <span class="comment"></span>
00853 <span class="comment">    ParentKcb - Parent kcb of the kcb to be created</span>
00854 <span class="comment"></span>
00855 <span class="comment">    FakeKey - Whether the kcb to be create is a fake one or not</span>
00856 <span class="comment"></span>
00857 <span class="comment">    KeyName - the subkey name to of the KCB to be created.</span>
00858 <span class="comment"> </span>
00859 <span class="comment">    NOTE:  We need the parameter instead of just using the name in the KEY_NODE </span>
00860 <span class="comment">           because there is no name in the root cell of a hive.</span>
00861 <span class="comment"></span>
00862 <span class="comment">Return Value:</span>
00863 <span class="comment"></span>
00864 <span class="comment">    NULL - failure (insufficient memory)</span>
00865 <span class="comment">    else a pointer to the new kcb.</span>
00866 <span class="comment"></span>
00867 <span class="comment">--*/</span>
00868 {
00869     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00870     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   kcbmatch=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00871     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00872     ULONG namelength;
00873     PUNICODE_STRING         fullname;
00874     ULONG       <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00875     ULONG i;
00876 
00877     UNICODE_STRING         NodeName;
00878     ULONG ConvKey=0;
00879     ULONG Cnt;
00880     WCHAR *Cp;
00881 
00882     <span class="comment">//</span>
00883     <span class="comment">// ParentKCb has the base hash value.</span>
00884     <span class="comment">//</span>
00885     <span class="keywordflow">if</span> (ParentKcb) {
00886         ConvKey = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o3">ConvKey</a>;
00887     }
00888 
00889     NodeName = *<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00890 
00891     <span class="keywordflow">while</span> ((NodeName.Length &gt; 0) &amp;&amp; (NodeName.Buffer[0] == OBJ_NAME_PATH_SEPARATOR)) {
00892         <span class="comment">//</span>
00893         <span class="comment">// This must be the \REGISTRY.</span>
00894         <span class="comment">// Strip off the leading OBJ_NAME_PATH_SEPARATOR</span>
00895         <span class="comment">//</span>
00896         NodeName.Buffer++;
00897         NodeName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00898     }
00899 
00900     <span class="comment">//</span>
00901     <span class="comment">// Manually compute the hash to use.</span>
00902     <span class="comment">//</span>
00903     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NodeName.Length &gt; 0);
00904 
00905     <span class="keywordflow">if</span> (NodeName.Length) {
00906         Cp = NodeName.Buffer;
00907         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;NodeName.Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
00908             <span class="keywordflow">if</span> ((*Cp != OBJ_NAME_PATH_SEPARATOR) &amp;&amp;
00909                 (*Cp != UNICODE_NULL)) {
00910                 ConvKey = 37 * ConvKey + (ULONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
00911             }
00912             ++Cp;
00913         }
00914     }
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">// Create a new kcb, which we will free if one already exists</span>
00918     <span class="comment">// for this key.</span>
00919     <span class="comment">// Now it is a fixed size structure.</span>
00920     <span class="comment">//</span>
00921     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00922                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>),
00923                                 CM_KCB_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00924 
00925 
00926     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00927         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00928     } <span class="keywordflow">else</span> {
00929         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, KCB_SIGNATURE);
00930         <a class="code" href="../../d1/d2/cmp_8h.html#a79">INIT_KCB_KEYBODY_LIST</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00931         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00932         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount = 1;
00933         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00934         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00935         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode = Node;
00936         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey = ConvKey;
00937 
00938     }
00939 
00940     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00941     <span class="comment">//</span>
00942     <span class="comment">// Find location to insert kcb in kcb tree.</span>
00943     <span class="comment">//</span>
00944 
00945 
00946     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">// Add the KCB to the hash table</span>
00950     <span class="comment">//</span>
00951     kcbmatch = <a class="code" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a>(&amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHash, FakeKey);
00952     <span class="keywordflow">if</span> (kcbmatch != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953         <span class="comment">//</span>
00954         <span class="comment">// A match was found.</span>
00955         <span class="comment">//</span>
00956         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!kcbmatch-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
00957         <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, '1FmC');
00958         <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00959         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, CM_KCB_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00960         <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(kcbmatch);
00961         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = kcbmatch;
00962         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount == 0) {
00963             <span class="comment">//</span>
00964             <span class="comment">// This kcb is on the delayed close list. Remove it from that</span>
00965             <span class="comment">// list.</span>
00966             <span class="comment">//</span>
00967             <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00968         }
00969         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1) == 0) {
00970             <span class="comment">//</span>
00971             <span class="comment">// We have maxed out the ref count on this key. Probably</span>
00972             <span class="comment">// some bogus app has opened the same key 64K times without</span>
00973             <span class="comment">// ever closing it. Just fail the open, they've got enough</span>
00974             <span class="comment">// handles already.</span>
00975             <span class="comment">//</span>
00976             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount + 1 != 0);
00977             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00978         } <span class="keywordflow">else</span> {
00979             ++<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;RefCount;
00980         }
00981     }
00982     <span class="keywordflow">else</span> {
00983         <span class="comment">//</span>
00984         <span class="comment">// No kcb created previously, fill in all the data.</span>
00985         <span class="comment">//</span>
00986 
00987         <span class="comment">//</span>
00988         <span class="comment">// Now try to reference the parentkcb</span>
00989         <span class="comment">//</span>
00990         
00991         <span class="keywordflow">if</span> (ParentKcb) {
00992             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00993                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = ParentKcb;
00994                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> + 1;
00995             } <span class="keywordflow">else</span> {
00996                 <span class="comment">//</span>
00997                 <span class="comment">// We have maxed out the ref count on the parent.</span>
00998                 <span class="comment">// Since it has been cached in the cachetable,</span>
00999                 <span class="comment">// remove it first before we free the allocation.</span>
01000                 <span class="comment">//</span>
01001                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01002                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, '2FmC');
01003                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01004                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, CM_KCB_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01005                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01006             }
01007         } <span class="keywordflow">else</span> {
01008             <span class="comment">//</span>
01009             <span class="comment">// It is the \REGISTRY node.</span>
01010             <span class="comment">//</span>
01011             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01012             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;TotalLevels = 1;
01013         }
01014 
01015         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>) {
01016             <span class="comment">//</span>
01017             <span class="comment">// Now try to find the Name Control block that has the name for this node.</span>
01018             <span class="comment">//</span>
01019     
01020             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock = <a class="code" href="../../d8/d2/cmsubs_8c.html#a14">CmpGetNameControlBlock</a> (&amp;NodeName);
01021 
01022             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameBlock) {
01023                 <span class="comment">//</span>
01024                 <span class="comment">// Now fill in all the data needed for the cache.</span>
01025                 <span class="comment">//</span>
01026                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.Count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01027                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.ValueList = (ULONG_PTR) Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01028         
01029                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Flags = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a>;
01030                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags = 0;
01031                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;DelayedCloseIndex = 0;
01032         
01033                 <span class="comment">//</span>
01034                 <span class="comment">// Cache the security cells in the kcb</span>
01035                 <span class="comment">//</span>
01036                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Security = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>;
01037         
01038                 <span class="keywordflow">if</span> (FakeKey) {
01039                     <span class="comment">//</span>
01040                     <span class="comment">// The KCb to be created is a fake one</span>
01041                     <span class="comment">//</span>
01042                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>;
01043                 }
01044             } <span class="keywordflow">else</span> {
01045                 <span class="comment">//</span>
01046                 <span class="comment">// We have maxed out the ref count on the Name.</span>
01047                 <span class="comment">//</span>
01048                 
01049                 <span class="comment">//</span>
01050                 <span class="comment">// First dereference the parent KCB.</span>
01051                 <span class="comment">//</span>
01052                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(ParentKcb);
01053 
01054                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01055                 <a class="code" href="../../d9/d0/cmdata_8h.html#a4">SET_KCB_SIGNATURE</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, '3FmC');
01056                 <a class="code" href="../../d1/d2/cmp_8h.html#a80">ASSERT_KEYBODY_LIST_EMPTY</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01057                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>, CM_KCB_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01058                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01059             }
01060         }
01061     }
01062 
01063 
01064     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01065     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01066 }
01067 
01068 
01069 
01070 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01071"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a21">01071</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
01072     PKCB_WORKER_ROUTINE WorkerRoutine,
01073     PVOID               Context1,
01074     PVOID               Context2
01075     )
01076 <span class="comment">/*++</span>
01077 <span class="comment"></span>
01078 <span class="comment">Routine Description:</span>
01079 <span class="comment"></span>
01080 <span class="comment">    Traverse the kcb tree.  We will visit all nodes unless WorkerRoutine</span>
01081 <span class="comment">    tells us to stop part way through.</span>
01082 <span class="comment"></span>
01083 <span class="comment">    For each node, call WorkerRoutine(..., Context1, Contex2).  If it returns</span>
01084 <span class="comment">    KCB_WORKER_DONE, we are done, simply return.  If it returns</span>
01085 <span class="comment">    KCB_WORKER_CONTINUE, just continue the search. If it returns KCB_WORKER_DELETE,</span>
01086 <span class="comment">    the specified KCB is marked as deleted.</span>
01087 <span class="comment"></span>
01088 <span class="comment">    This routine has the side-effect of removing all delayed-close KCBs.</span>
01089 <span class="comment"></span>
01090 <span class="comment">Arguments:</span>
01091 <span class="comment"></span>
01092 <span class="comment">    WorkerRoutine - applied to nodes witch Match.</span>
01093 <span class="comment"></span>
01094 <span class="comment">    Context1 - data we pass through</span>
01095 <span class="comment"></span>
01096 <span class="comment">    Context2 - data we pass through</span>
01097 <span class="comment"></span>
01098 <span class="comment"></span>
01099 <span class="comment">Return Value:</span>
01100 <span class="comment"></span>
01101 <span class="comment">    NONE.</span>
01102 <span class="comment"></span>
01103 <span class="comment">--*/</span>
01104 {
01105     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Current;
01106     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   Next;
01107     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Prev;
01108     ULONG                   WorkerResult;
01109     ULONG                   i;
01110 
01111     <span class="comment">//</span>
01112     <span class="comment">// Walk the hash table</span>
01113     <span class="comment">//</span>
01114     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; i++) {
01115         Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01116         <span class="keywordflow">while</span> (*Prev) {
01117             Current = CONTAINING_RECORD(*Prev,
01118                                         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01119                                         KeyHash);
01120             <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(Current);
01121             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01122             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01123                 <span class="comment">//</span>
01124                 <span class="comment">// This kcb is in DelayClose case, remove it.</span>
01125                 <span class="comment">//</span>
01126                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(Current);
01127                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(Current);
01128 
01129                 <span class="comment">//</span>
01130                 <span class="comment">// The HashTable is changed, start over in this index again.</span>
01131                 <span class="comment">//</span>
01132                 Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[i];
01133                 <span class="keywordflow">continue</span>;
01134             }
01135 
01136             WorkerResult = (WorkerRoutine)(Current, <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>, <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>);
01137             <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a115">KCB_WORKER_DONE</a>) {
01138                 <span class="keywordflow">return</span>;
01139             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a116">KCB_WORKER_DELETE</a>) {
01140                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>);
01141                 *Prev = Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01142                 <span class="keywordflow">continue</span>;
01143             } <span class="keywordflow">else</span> {
01144                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(WorkerResult == <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>);
01145                 Prev = &amp;Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o4">NextHash</a>;
01146             }
01147         }
01148     }
01149 }
01150 
01151 
01152 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01153"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a22">01153</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(
01154     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
01155     )
01156 <span class="comment">/*++</span>
01157 <span class="comment"></span>
01158 <span class="comment">Routine Description:</span>
01159 <span class="comment"></span>
01160 <span class="comment">    Decrements the reference count on a key control block, and frees it if it</span>
01161 <span class="comment">    becomes zero.</span>
01162 <span class="comment"></span>
01163 <span class="comment">    It is expected that no notify control blocks remain if the reference count</span>
01164 <span class="comment">    becomes zero.</span>
01165 <span class="comment"></span>
01166 <span class="comment">Arguments:</span>
01167 <span class="comment"></span>
01168 <span class="comment">    KeyControlBlock - pointer to a key control block.</span>
01169 <span class="comment"></span>
01170 <span class="comment">Return Value:</span>
01171 <span class="comment"></span>
01172 <span class="comment">    NONE.</span>
01173 <span class="comment"></span>
01174 <span class="comment">--*/</span>
01175 {
01176     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01177     <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock) ;
01178     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01179     <span class="keywordflow">return</span>;
01180 }
01181 
01182 
01183 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01184"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a23">01184</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(
01185     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
01186     )
01187 {
01188     ULONG_PTR FreeIndex;
01189     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KcbToFree;
01190 
01191 
01192 
01193     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01194 
01195     <span class="keywordflow">if</span> (--KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o1">RefCount</a> == 0) {
01196         <span class="comment">//</span>
01197         <span class="comment">// Remove kcb from the tree</span>
01198         <span class="comment">//</span>
01199         <span class="keywordflow">if</span> (KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o7">ExtFlags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a14">CM_KCB_NO_DELAY_CLOSE</a>) {
01200             <span class="comment">//</span>
01201             <span class="comment">// Free storage directly so we can clean up junk quickly.</span>
01202             <span class="comment">//</span>
01203             <span class="comment">//</span>
01204             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01205             <span class="comment">//</span>
01206             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01207         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o0">Delete</a>) {
01208 
01209             <span class="comment">//</span>
01210             <span class="comment">// Put this kcb on our delayed close list.</span>
01211             <span class="comment">//</span>
01212             <span class="comment">// First check the free list for a free slot.</span>
01213             <span class="comment">//</span>
01214             FreeIndex = <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a>;
01215             <span class="keywordflow">if</span> (FreeIndex != -1) {
01216                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FreeIndex &lt; <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>);
01217                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = (ULONG_PTR)<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex];
01218                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) FreeIndex;
01219                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> == -1) ||
01220                        (<a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> &lt; <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>));
01221                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[FreeIndex] = KeyControlBlock;
01222             } <span class="keywordflow">else</span> {
01223 
01224                 <span class="comment">//</span>
01225                 <span class="comment">// Nothing is free, we have to get rid of something.</span>
01226                 <span class="comment">//</span>
01227                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01228                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(*CmpDelayedCloseCurrent)-&gt;Delete);
01229                 <span class="comment">//</span>
01230                 <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01231                 <span class="comment">// Change the code sequence for the recurrsive call to dereference the parent.</span>
01232                 <span class="comment">//</span>
01233                 KcbToFree = *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01234                 *<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = KeyControlBlock;
01235                 KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o15">DelayedCloseIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>);
01236                 ++<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a>;
01237                 <span class="keywordflow">if</span> ((ULONG)(<a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> - <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>) == <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>) {
01238                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
01239                 }
01240 
01241                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KcbToFree);
01242             }
01243         } <span class="keywordflow">else</span> {
01244             <span class="comment">//</span>
01245             <span class="comment">// Free storage directly as there is no point in putting this on</span>
01246             <span class="comment">// our delayed close list.</span>
01247             <span class="comment">//</span>
01248             <span class="comment">//</span>
01249             <span class="comment">// Need to free all cached Index List, Index Leaf, Value, etc.</span>
01250             <span class="comment">//</span>
01251             <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(KeyControlBlock);
01252         }
01253     }
01254 
01255     <span class="keywordflow">return</span>;
01256 }
01257 
01258 
01259 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01260"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a24">01260</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(
01261     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   KeyControlBlock
01262     )
01263 <span class="comment">/*++</span>
01264 <span class="comment"></span>
01265 <span class="comment">Routine Description:</span>
01266 <span class="comment"></span>
01267 <span class="comment">    Remove a key control block from the KCB tree.</span>
01268 <span class="comment"></span>
01269 <span class="comment">    It is expected that no notify control blocks remain.</span>
01270 <span class="comment"></span>
01271 <span class="comment">    The kcb will NOT be freed, call DereferenceKeyControlBlock for that.</span>
01272 <span class="comment"></span>
01273 <span class="comment">    This call assumes the KCB tree is already locked or registry is locked exclusively.</span>
01274 <span class="comment"></span>
01275 <span class="comment">Arguments:</span>
01276 <span class="comment"></span>
01277 <span class="comment">    KeyControlBlock - pointer to a key control block.</span>
01278 <span class="comment"></span>
01279 <span class="comment">Return Value:</span>
01280 <span class="comment"></span>
01281 <span class="comment">    NONE.</span>
01282 <span class="comment"></span>
01283 <span class="comment">--*/</span>
01284 {
01285     <a class="code" href="../../d9/d0/cmdata_8h.html#a5">ASSERT_KCB</a>(KeyControlBlock);
01286 
01287     <span class="comment">//</span>
01288     <span class="comment">// Remove the KCB from the hash table</span>
01289     <span class="comment">//</span>
01290     <a class="code" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a>(&amp;KeyControlBlock-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o2">KeyHash</a>);
01291 
01292     <span class="keywordflow">return</span>;
01293 }
01294 
01295 
01296 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01297"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a25">01297</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a25">CmpFreeKeyBody</a>(
01298     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01299     HCELL_INDEX Cell
01300     )
01301 <span class="comment">/*++</span>
01302 <span class="comment"></span>
01303 <span class="comment">Routine Description:</span>
01304 <span class="comment"></span>
01305 <span class="comment">    Free storage for the key entry Hive.Cell refers to, including</span>
01306 <span class="comment">    its class and security data.  Will NOT free child list or value list.</span>
01307 <span class="comment"></span>
01308 <span class="comment">Arguments:</span>
01309 <span class="comment"></span>
01310 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
01311 <span class="comment"></span>
01312 <span class="comment">    Cell - supplies index of key to free</span>
01313 <span class="comment"></span>
01314 <span class="comment">Return Value:</span>
01315 <span class="comment"></span>
01316 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01317 <span class="comment"></span>
01318 <span class="comment">        &lt;TBS&gt;</span>
01319 <span class="comment"></span>
01320 <span class="comment">--*/</span>
01321 {
01322     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> key;
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// map in the cell</span>
01326     <span class="comment">//</span>
01327     key = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01328 
01329     <span class="keywordflow">if</span> (!(key-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a>)) {
01330         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01331             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, key-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o9">Security</a>);
01332         }
01333 
01334         <span class="keywordflow">if</span> (key-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> &gt; 0) {
01335             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, key-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o10">Class</a>);
01336         }
01337     }
01338 
01339     <span class="comment">//</span>
01340     <span class="comment">// unmap the cell itself and free it</span>
01341     <span class="comment">//</span>
01342     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01343 
01344     <span class="keywordflow">return</span>;
01345 }
01346 
01347 
01348 
01349 <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>
<a name="l01350"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a10">01350</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a10">CmpInsertKeyHash</a>(
01351     IN <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash,
01352     IN BOOLEAN      FakeKey
01353     )
01354 <span class="comment">/*++</span>
01355 <span class="comment"></span>
01356 <span class="comment">Routine Description:</span>
01357 <span class="comment"></span>
01358 <span class="comment">    Adds a key hash structure to the hash table. The hash table</span>
01359 <span class="comment">    will be checked to see if a duplicate entry already exists. If</span>
01360 <span class="comment">    a duplicate is found, its kcb will be returned. If a duplicate is not</span>
01361 <span class="comment">    found, NULL will be returned.</span>
01362 <span class="comment"></span>
01363 <span class="comment">Arguments:</span>
01364 <span class="comment"></span>
01365 <span class="comment">    KeyHash - Supplies the key hash structure to be added.</span>
01366 <span class="comment"></span>
01367 <span class="comment">Return Value:</span>
01368 <span class="comment"></span>
01369 <span class="comment">    NULL - if the supplied key has was added</span>
01370 <span class="comment">    PCM_KEY_HASH - The duplicate hash entry, if one was found</span>
01371 <span class="comment"></span>
01372 <span class="comment">--*/</span>
01373 
01374 {
01375     <a class="code" href="../../d9/d0/cmdata_8h.html#a52">HASH_VALUE</a> Hash;
01376     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01377     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01378 
01379     <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(KeyHash);
01380     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a76">GET_HASH_INDEX</a>(KeyHash-&gt;ConvKey);
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">// If this is a fake key, we will use the cell and hive from its </span>
01384     <span class="comment">// parent for uniqeness.  To deal with the case when the fake</span>
01385     <span class="comment">// has the same ConvKey as its parent (in which case we cannot distingish </span>
01386     <span class="comment">// between the two), we set the lowest bit of the fake key's cell.</span>
01387     <span class="comment">//</span>
01388     <span class="comment">// It's possible (unlikely) that we cannot distingish two fake keys </span>
01389     <span class="comment">// (when their Convkey's are the same) under the same key.  It is not breaking</span>
01390     <span class="comment">// anything, we just cannot find the other one in cache lookup.</span>
01391     <span class="comment">//</span>
01392     <span class="comment">//</span>
01393     <span class="keywordflow">if</span> (FakeKey) {
01394         KeyHash-&gt;KeyCell++;
01395     }
01396 
01397     <span class="comment">//</span>
01398     <span class="comment">// First look for duplicates.</span>
01399     <span class="comment">//</span>
01400     Current = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01401     <span class="keywordflow">while</span> (Current) {
01402         <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01403         <span class="comment">//</span>
01404         <span class="comment">// We must check ConvKey since we can create a fake kcb</span>
01405         <span class="comment">// for keys that does not exist.</span>
01406         <span class="comment">// We will use the Hive and Cell from the parent.</span>
01407         <span class="comment">//</span>
01408 
01409         <span class="keywordflow">if</span> ((KeyHash-&gt;ConvKey == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o0">ConvKey</a>) &amp;&amp;
01410             (KeyHash-&gt;KeyCell == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o3">KeyCell</a>) &amp;&amp;
01411             (KeyHash-&gt;KeyHive == Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o2">KeyHive</a>)) {
01412             <span class="comment">//</span>
01413             <span class="comment">// Found a match</span>
01414             <span class="comment">//</span>
01415             <span class="keywordflow">return</span>(CONTAINING_RECORD(Current,
01416                                      <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01417                                      KeyHash));
01418         }
01419         Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01420     }
01421 
01422 <span class="preprocessor">#if DBG</span>
01423 <span class="preprocessor"></span>    <span class="comment">// </span>
01424     <span class="comment">// Make sure this key is not somehow cached in the wrong spot.</span>
01425     <span class="comment">//</span>
01426     {
01427         ULONG DbgIndex;
01428         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01429         
01430         <span class="keywordflow">for</span> (DbgIndex = 0; DbgIndex &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; DbgIndex++) {
01431             Current = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[DbgIndex];
01432             <span class="keywordflow">while</span> (Current) {
01433                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = CONTAINING_RECORD(Current,
01434                                         <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>,
01435                                         KeyHash);
01436                 
01437                 <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01438                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((KeyHash-&gt;KeyHive != Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o2">KeyHive</a>) ||
01439                        FakeKey ||
01440                        (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) ||
01441                        (KeyHash-&gt;KeyCell != Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o3">KeyCell</a>));
01442                 Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01443             }
01444         }
01445     }
01446     
01447 <span class="preprocessor">#endif</span>
01448 <span class="preprocessor"></span>
01449     <span class="comment">//</span>
01450     <span class="comment">// No duplicate was found, add this entry at the head of the list</span>
01451     <span class="comment">//</span>
01452     KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01453     <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = KeyHash;
01454     <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01455 }
01456 
01457 
01458 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01459"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a9">01459</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a9">CmpRemoveKeyHash</a>(
01460     IN <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash
01461     )
01462 <span class="comment">/*++</span>
01463 <span class="comment"></span>
01464 <span class="comment">Routine Description:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    Removes a key hash structure from the hash table.</span>
01467 <span class="comment"></span>
01468 <span class="comment">Arguments:</span>
01469 <span class="comment"></span>
01470 <span class="comment">    KeyHash - Supplies the key hash structure to be deleted.</span>
01471 <span class="comment"></span>
01472 <span class="comment">Return Value:</span>
01473 <span class="comment"></span>
01474 <span class="comment">    None</span>
01475 <span class="comment"></span>
01476 <span class="comment">--*/</span>
01477 
01478 {
01479     <a class="code" href="../../d9/d0/cmdata_8h.html#a52">HASH_VALUE</a> Hash;
01480     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01481     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *Prev;
01482     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01483 
01484     <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(KeyHash);
01485 
01486     Hash = <a class="code" href="../../d1/d2/cmp_8h.html#a75">HASH_KEY</a>(KeyHash-&gt;ConvKey);
01487     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash % <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>;
01488 
01489     <span class="comment">//</span>
01490     <span class="comment">// Find this entry.</span>
01491     <span class="comment">//</span>
01492     Prev = &amp;<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01493     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01494         Current = *Prev;
01495         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01496         <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01497         <span class="keywordflow">if</span> (Current == KeyHash) {
01498             *Prev = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01499 <span class="preprocessor">#if DBG</span>
01500 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (*Prev) {
01501                 <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(*Prev);
01502             }
01503 <span class="preprocessor">#endif</span>
01504 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
01505         }
01506         Prev = &amp;Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01507     }
01508 }
01509 
01510 
01511 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01512"></a><a class="code" href="../../d8/d2/cmsubs_8c.html#a26">01512</a> <a class="code" href="../../d8/d2/cmsubs_8c.html#a26">CmpInitializeCache</a>()
01513 {
01514     ULONG TotalCmCacheSize;
01515     ULONG i;
01516 
01517     TotalCmCacheSize = <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a>);
01518 
01519     <a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01520                                           TotalCmCacheSize,
01521                                           'aCMC');
01522     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,1,0,0);
01524         <span class="keywordflow">return</span>;
01525     }
01526     RtlZeroMemory(<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>, TotalCmCacheSize);
01527 
01528     TotalCmCacheSize = <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d6/struct__CM__NAME__HASH.html">PCM_NAME_HASH</a>);
01529     <a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01530                                               TotalCmCacheSize,
01531                                               'aCMC');
01532     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01533         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,1,0,0);
01534         <span class="keywordflow">return</span>;
01535     }
01536     RtlZeroMemory(<a class="code" href="../../d8/d2/cmsubs_8c.html#a8">CmpNameCacheTable</a>, TotalCmCacheSize);
01537 
01538     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01539                                                  <a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>),
01540                                                  'cDMC');
01541     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01542         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(CONFIG_INITIALIZATION_FAILED,6,2,0,0);
01543         <span class="keywordflow">return</span>;
01544     }
01545     <a class="code" href="../../d8/d2/cmsubs_8c.html#a7">CmpDelayedFreeIndex</a> = 0;
01546     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>-1; i++) {
01547         <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[i] = (<a class="code" href="../../d9/d0/cmdata_8h.html#a64">PCM_KEY_CONTROL_BLOCK</a>)ULongToPtr(i+1);
01548     }
01549     <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>[<a class="code" href="../../d8/d2/cmsubs_8c.html#a4">CmpDelayedCloseSize</a>-1] = (<a class="code" href="../../d9/d0/cmdata_8h.html#a64">PCM_KEY_CONTROL_BLOCK</a>)-1;
01550     <a class="code" href="../../d8/d2/cmsubs_8c.html#a6">CmpDelayedCloseCurrent</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a5">CmpDelayedCloseTable</a>;
01551 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
