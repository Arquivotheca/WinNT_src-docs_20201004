<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: _output.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>_output.h</h1><a href="../../d8/d2/__output_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    _output.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Performance critical routine for Single Binary</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Each function will be created with two flavors FE and non FE</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    KazuM Jun.11.1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
<a name="l00023"></a><a class="code" href="../../d8/d2/__output_8h.html#a0">00023</a> <span class="preprocessor">#define WWSB_NEUTRAL_FILE 1</span>
00024 <span class="preprocessor"></span>
00025 <span class="preprocessor">#if !defined(FE_SB)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#error This header file should be included with FE_SB</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#if !defined(WWSB_FE) &amp;&amp; !defined(WWSB_NOFE)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#error Either WWSB_FE and WWSB_NOFE must be defined.</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
00033 <span class="preprocessor">#if defined(WWSB_FE) &amp;&amp; defined(WWSB_NOFE)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#error Both WWSB_FE and WWSB_NOFE defined.</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00036 <span class="preprocessor"></span>
00037 <span class="preprocessor">#include "<a class="code" href="../../d6/d8/dispatch_8h.html">dispatch.h</a>"</span>
00038 
00039 <span class="preprocessor">#if defined(WWSB_FE)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_StreamWriteToScreenBuffer)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_WriteRectToScreenBuffer)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_WriteRegionToScreen)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_WriteToScreen)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_WriteOutputString)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_FillOutput)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_FillRectangle)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_PolyTextOutCandidate)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(FE_TEXT, FE_ConsolePolyTextOut)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span>
00051 
00052 <span class="preprocessor">#if defined(WWSB_NOFE)</span>
00053 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00054 <a class="code" href="../../d6/d8/dispatch_8h.html#a27">SB_StreamWriteToScreenBuffer</a>(
00055     IN PWCHAR String,
00056     IN SHORT StringLength,
00057     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00058     )
00059 #<span class="keywordflow">else</span>
00060 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00061"></a><a class="code" href="../../d6/d8/dispatch_8h.html#a26">00061</a> <a class="code" href="../../d6/d8/dispatch_8h.html#a26">FE_StreamWriteToScreenBuffer</a>(
00062     IN PWCHAR String,
00063     IN SHORT StringLength,
00064     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00065     IN PCHAR StringA
00066     )
00067 #endif
00068 {
00069     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00070     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00071     PWCHAR Char;
00072     COORD TargetPoint;
00073 
00074     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"StreamWriteToScreenBuffer\n"</span>));
00075 <span class="preprocessor">#ifdef WWSB_FE</span>
00076 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>    ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00079     TargetPoint = ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition;
00080     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
00081     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00082     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"RowIndex = %x, Row = %x, TargetPoint = (%x,%x)\n"</span>,
00083             RowIndex, Row, TargetPoint.X, TargetPoint.Y));
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">// copy chars</span>
00087     <span class="comment">//</span>
00088 <span class="preprocessor">#ifdef WWSB_FE</span>
00089 <span class="preprocessor"></span>    <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>,TargetPoint,ScreenInfo);
00090     <span class="keywordflow">if</span> (TargetPoint.Y == ScreenInfo-&gt;ScreenBufferSize.Y-1 &amp;&amp;
00091         TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &gt;= ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp;
00092         *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) &amp; ATTR_LEADING_BYTE
00093        ) {
00094         *(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00095         *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) = 0;
00096         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> &gt; ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X-1) {
00097             *(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00098             *(StringA+ScreenInfo-&gt;ScreenBufferSize.X-TargetPoint.X) = 0;
00099         }
00100     }
00101 
00102     RtlCopyMemory(&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X],StringA,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00103 <span class="preprocessor">#endif</span>
00104 <span class="preprocessor"></span>
00105     RtlCopyMemory(&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X],<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00106 
00107     <span class="comment">// recalculate first and last non-space char</span>
00108 
00109     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
00110     <span class="keywordflow">if</span> (TargetPoint.X &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
00111         PWCHAR LastChar = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ScreenInfo-&gt;ScreenBufferSize.X];
00112 
00113         <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X];Char &lt; LastChar &amp;&amp; *Char==(WCHAR)<span class="charliteral">' '</span>;Char++)
00114             ;
00115         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char-Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>);
00116     }
00117 
00118     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
00119     <span class="keywordflow">if</span> ((TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
00120         PWCHAR FirstChar = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>;
00121 
00122         <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>-1];*Char==(WCHAR)<span class="charliteral">' '</span> &amp;&amp; Char &gt;= FirstChar;Char--)
00123             ;
00124         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char+1-FirstChar);
00125     }
00126 
00127     <span class="comment">//</span>
00128     <span class="comment">// see if attr string is different.  if so, allocate a new</span>
00129     <span class="comment">// attr buffer and merge the two strings.</span>
00130     <span class="comment">//</span>
00131 
00132     <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1 ||
00133         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> != ScreenInfo-&gt;Attributes) {
00134         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
00135         WORD NewAttrsLength;
00136         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attrs;
00137 
00138         Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
00139         Attrs.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = ScreenInfo-&gt;Attributes;
00140         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
00141                          Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
00142                          &amp;Attrs,
00143                          1,
00144                          &amp;NewAttrs,
00145                          &amp;NewAttrsLength,
00146                          TargetPoint.X,
00147                          (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetPoint.X+<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>-1),
00148                          Row,
00149                          ScreenInfo
00150                         ))) {
00151             <span class="keywordflow">return</span>;
00152         }
00153         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
00154             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
00155         }
00156         <span class="keywordflow">else</span> {
00157             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
00158         }
00159         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
00160         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
00161         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00162         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00163     }
00164     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetPoint.Y,TargetPoint.Y);
00165 }
00166 
00167 
<a name="l00168"></a><a class="code" href="../../d8/d2/__output_8h.html#a1">00168</a> <span class="preprocessor">#define CHAR_OF_PCI(p)  (((PCHAR_INFO)(p))-&gt;Char.AsciiChar)</span>
<a name="l00169"></a><a class="code" href="../../d8/d2/__output_8h.html#a2">00169</a> <span class="preprocessor"></span><span class="preprocessor">#define WCHAR_OF_PCI(p) (((PCHAR_INFO)(p))-&gt;Char.UnicodeChar)</span>
<a name="l00170"></a><a class="code" href="../../d8/d2/__output_8h.html#a3">00170</a> <span class="preprocessor"></span><span class="preprocessor">#define ATTR_OF_PCI(p)  (((PCHAR_INFO)(p))-&gt;Attributes)</span>
<a name="l00171"></a><a class="code" href="../../d8/d2/__output_8h.html#a4">00171</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZEOF_CI_CELL  sizeof(CHAR_INFO)</span>
00172 <span class="preprocessor"></span>
<a name="l00173"></a><a class="code" href="../../d8/d2/__output_8h.html#a5">00173</a> <span class="preprocessor">#define CHAR_OF_VGA(p)  (p[0])</span>
<a name="l00174"></a><a class="code" href="../../d8/d2/__output_8h.html#a6">00174</a> <span class="preprocessor"></span><span class="preprocessor">#define ATTR_OF_VGA(p)  (p[1])</span>
00175 <span class="preprocessor"></span><span class="preprocessor">#ifdef i386</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#define SIZEOF_VGA_CELL 2</span>
00177 <span class="preprocessor"></span><span class="preprocessor">#else // risc</span>
<a name="l00178"></a><a class="code" href="../../d8/d2/__output_8h.html#a7">00178</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZEOF_VGA_CELL 4</span>
00179 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00180 <span class="preprocessor"></span>
00181 
<a name="l00182"></a><a class="code" href="../../d8/d2/__output_8h.html#a8">00182</a> <span class="preprocessor">#define COMMON_LVB_MASK        0x33</span>
<a name="l00183"></a><a class="code" href="../../d8/d2/__output_8h.html#a9">00183</a> <span class="preprocessor"></span><span class="preprocessor">#define ATTR_OF_COMMON_LVB(p)  (ATTR_OF_VGA(p) + (((p[2] &amp; ~COMMON_LVB_MASK)) &lt;&lt; 8))</span>
<a name="l00184"></a><a class="code" href="../../d8/d2/__output_8h.html#a10">00184</a> <span class="preprocessor"></span><span class="preprocessor">#define SIZEOF_COMMON_LVB_CELL 4</span>
00185 <span class="preprocessor"></span>
00186 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00187"></a><a class="code" href="../../d8/d2/__output_8h.html#a14">00187</a> <a class="code" href="../../d8/d2/__output_8h.html#a14">WWSB_WriteRectToScreenBuffer</a>(
00188     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> Source,
00189     COORD SourceSize,
00190     PSMALL_RECT SourceRect,
00191     <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00192     COORD TargetPoint,
00193     IN UINT Codepage
00194     )
00195 
00196 <span class="comment">/*++</span>
00197 <span class="comment"></span>
00198 <span class="comment">Routine Description:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    This routine copies a rectangular region to the screen buffer.</span>
00201 <span class="comment">    no clipping is done.</span>
00202 <span class="comment"></span>
00203 <span class="comment">    The source should contain Unicode or UnicodeOem chars.</span>
00204 <span class="comment"></span>
00205 <span class="comment">Arguments:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    Source - pointer to source buffer (a real VGA buffer or CHAR_INFO[])</span>
00208 <span class="comment"></span>
00209 <span class="comment">    SourceSize - dimensions of source buffer</span>
00210 <span class="comment"></span>
00211 <span class="comment">    SourceRect - rectangle in source buffer to copy</span>
00212 <span class="comment"></span>
00213 <span class="comment">    ScreenInfo - pointer to screen info</span>
00214 <span class="comment"></span>
00215 <span class="comment">    TargetPoint - upper left coordinates of target rectangle</span>
00216 <span class="comment"></span>
00217 <span class="comment">    Codepage - codepage to translate real VGA buffer from,</span>
00218 <span class="comment">               0xFFFFFFF if Source is CHAR_INFO[] (not requiring translation)</span>
00219 <span class="comment">Return Value:</span>
00220 <span class="comment"></span>
00221 <span class="comment">    none.</span>
00222 <span class="comment"></span>
00223 <span class="comment">--*/</span>
00224 
00225 {
00226 
00227     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> SourcePtr;
00228     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
00229     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XSize,YSize;
00230     BOOLEAN WholeSource;
00231     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00232     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00233     PWCHAR Char;
00234     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attrs[80];
00235     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> AttrBuf;
00236     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr;
00237     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> AttrLength;
00238     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bVGABuffer;
00239     ULONG ulCellSize;
00240 <span class="preprocessor">#ifdef WWSB_FE</span>
00241 <span class="preprocessor"></span>    PCHAR AttrP;
00242 <span class="preprocessor">#endif</span>
00243 <span class="preprocessor"></span>
00244     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"WriteRectToScreenBuffer\n"</span>));
00245 <span class="preprocessor">#ifdef WWSB_FE</span>
00246 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o1">Flags</a> &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
00247 <span class="preprocessor">#endif</span>
00248 <span class="preprocessor"></span>
00249     ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
00250     XSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(SourceRect-&gt;Right - SourceRect-&gt;Left + 1);
00251     YSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(SourceRect-&gt;Bottom - SourceRect-&gt;Top + 1);
00252 
00253 
00254     AttrBuf = Attrs;
00255     <span class="keywordflow">if</span> (XSize &gt; 80) {
00256         AttrBuf = (<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),XSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a>));
00257         <span class="keywordflow">if</span> (AttrBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00258             <span class="keywordflow">return</span>;
00259     }
00260 
00261     bVGABuffer = (Codepage != 0xFFFFFFFF);
00262     <span class="keywordflow">if</span> (bVGABuffer) {
00263 <span class="preprocessor">#ifdef WWSB_FE</span>
00264 <span class="preprocessor"></span>        ulCellSize = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) ? <a class="code" href="../../d8/d2/__output_8h.html#a10">SIZEOF_COMMON_LVB_CELL</a> : <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>;
00265 <span class="preprocessor">#else</span>
00266 <span class="preprocessor"></span>        ulCellSize = <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>;
00267 <span class="preprocessor">#endif</span>
00268 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00269         ulCellSize = <a class="code" href="../../d8/d2/__output_8h.html#a4">SIZEOF_CI_CELL</a>;
00270     }
00271 
00272     SourcePtr = Source;
00273 
00274     WholeSource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     <span class="keywordflow">if</span> (XSize == SourceSize.X) {
00276         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (SourceRect-&gt;Left == 0);
00277         <span class="keywordflow">if</span> (SourceRect-&gt;Top != 0) {
00278             SourcePtr += <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(SourceRect-&gt;Left,
00279                                                SourceRect-&gt;Top,
00280                                                SourceSize.X,
00281                                                ulCellSize);
00282         }
00283         WholeSource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00284     }
00285     RowIndex = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.FirstRow+TargetPoint.Y) % ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y;
00286     <span class="keywordflow">for</span> (i=0;i&lt;YSize;i++) {
00287         <span class="keywordflow">if</span> (!WholeSource) {
00288             SourcePtr = Source + <a class="code" href="../../d3/d6/iostubs_8c.html#a0">SCREEN_BUFFER_POINTER</a>(SourceRect-&gt;Left,
00289                                                        SourceRect-&gt;Top+i,
00290                                                        SourceSize.X,
00291                                                        ulCellSize);
00292         }
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">// copy the chars and attrs into their respective arrays</span>
00296         <span class="comment">//</span>
00297 
00298 <span class="preprocessor">#ifdef WWSB_FE</span>
00299 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (! bVGABuffer) {
00300             COORD TPoint;
00301 
00302             TPoint.X = TargetPoint.X;
00303             TPoint.Y = TargetPoint.Y + i;
00304             <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(XSize,TPoint,ScreenInfo);
00305             <span class="keywordflow">if</span> (TPoint.Y == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y-1 &amp;&amp;
00306                 TPoint.X+XSize-1 &gt;= ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X &amp;&amp;
00307                 <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X-1) &amp; COMMON_LVB_LEADING_BYTE)
00308             {
00309                 <a class="code" href="../../d8/d2/__output_8h.html#a2">WCHAR_OF_PCI</a>(SourcePtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00310                 <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X-1) &amp;= ~COMMON_LVB_SBCSDBCS;
00311                 <span class="keywordflow">if</span> (XSize-1 &gt; ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X-1) {
00312                     <a class="code" href="../../d8/d2/__output_8h.html#a2">WCHAR_OF_PCI</a>(SourcePtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00313                     <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr+ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X-TPoint.X) &amp;= ~COMMON_LVB_SBCSDBCS;
00314                 }
00315             }
00316         }
00317 <span class="preprocessor">#endif</span>
00318 <span class="preprocessor"></span>
00319         Row = &amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o22">BufferInfo</a>.TextInfo.Rows[RowIndex];
00320         Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X];
00321 <span class="preprocessor">#ifdef WWSB_FE</span>
00322 <span class="preprocessor"></span>        AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetPoint.X];
00323 <span class="preprocessor">#endif</span>
00324 <span class="preprocessor"></span>        Attr = AttrBuf;
00325         Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 0;
00326         AttrLength = 1;
00327 
00328         <span class="comment">/*</span>
00329 <span class="comment">         * Two version of the following loop to keep it fast:</span>
00330 <span class="comment">         * one for VGA buffers, one for CHAR_INFO buffers.</span>
00331 <span class="comment">         */</span>
00332         <span class="keywordflow">if</span> (bVGABuffer) {
00333 <span class="preprocessor">#ifdef WWSB_FE</span>
00334 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) ? <a class="code" href="../../d8/d2/__output_8h.html#a9">ATTR_OF_COMMON_LVB</a>(SourcePtr) : <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr);
00335 <span class="preprocessor">#else</span>
00336 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr);
00337 <span class="preprocessor">#endif</span>
00338 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (j = SourceRect-&gt;Left;
00339                     j &lt;= SourceRect-&gt;Right;
00340                     j++,
00341 <span class="preprocessor">#ifdef WWSB_FE</span>
00342 <span class="preprocessor"></span>                    SourcePtr += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) ? <a class="code" href="../../d8/d2/__output_8h.html#a10">SIZEOF_COMMON_LVB_CELL</a> : <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>
00343 <span class="preprocessor">#else</span>
00344 <span class="preprocessor"></span>                    SourcePtr += <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>
00345 <span class="preprocessor">#endif</span>
00346 <span class="preprocessor"></span>                ) {
00347 
00348 <span class="preprocessor">#ifdef WWSB_FE</span>
00349 <span class="preprocessor"></span>                UCHAR TmpBuff[2];
00350 
00351                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(<a class="code" href="../../d8/d2/__output_8h.html#a5">CHAR_OF_VGA</a>(SourcePtr),&amp;ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;OutputCPInfo)) {
00352                     <span class="keywordflow">if</span> (j+1 &gt; SourceRect-&gt;Right) {
00353                         *Char = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
00354                         *AttrP = 0;
00355                     }
00356                     <span class="keywordflow">else</span> {
00357                         TmpBuff[0] = <a class="code" href="../../d8/d2/__output_8h.html#a5">CHAR_OF_VGA</a>(SourcePtr);
00358                         TmpBuff[1] = <a class="code" href="../../d8/d2/__output_8h.html#a5">CHAR_OF_VGA</a>((SourcePtr + ((ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) ? <a class="code" href="../../d8/d2/__output_8h.html#a10">SIZEOF_COMMON_LVB_CELL</a> : <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>)));
00359                         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
00360                                                TmpBuff,
00361                                                2,
00362                                                Char,
00363                                                2);
00364                         Char++;
00365                         j++;
00366                         *AttrP++ = ATTR_LEADING_BYTE;
00367                         *Char++ = *(Char-1);
00368                         *AttrP++ = ATTR_TRAILING_BYTE;
00369 
00370                         <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) {
00371                             <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == <a class="code" href="../../d8/d2/__output_8h.html#a9">ATTR_OF_COMMON_LVB</a>(SourcePtr)) {
00372                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
00373                             }
00374                             <span class="keywordflow">else</span> {
00375                                 Attr++;
00376                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
00377                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a9">ATTR_OF_COMMON_LVB</a>(SourcePtr);
00378                                 AttrLength += 1;
00379                             }
00380                         }
00381                         <span class="keywordflow">else</span>
00382                         {
00383                             <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr)) {
00384                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
00385                             }
00386                             <span class="keywordflow">else</span> {
00387                                 Attr++;
00388                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
00389                                 Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr);
00390                                 AttrLength += 1;
00391                             }
00392                         }
00393 
00394                         SourcePtr += (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) ? <a class="code" href="../../d8/d2/__output_8h.html#a10">SIZEOF_COMMON_LVB_CELL</a> : <a class="code" href="../../d8/d2/__output_8h.html#a7">SIZEOF_VGA_CELL</a>;
00395                     }
00396                 }
00397                 <span class="keywordflow">else</span> {
00398                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
00399                                            &amp;<a class="code" href="../../d8/d2/__output_8h.html#a5">CHAR_OF_VGA</a>(SourcePtr),
00400                                            1,
00401                                            Char,
00402                                            1);
00403                     Char++;
00404                     *AttrP++ = 0;
00405                 }
00406 <span class="preprocessor">#else</span>
00407 <span class="preprocessor"></span>                *Char++ = SB_CharToWcharGlyph(Codepage, <a class="code" href="../../d8/d2/__output_8h.html#a5">CHAR_OF_VGA</a>(SourcePtr));
00408 <span class="preprocessor">#endif</span>
00409 <span class="preprocessor"></span>
00410 <span class="preprocessor">#ifdef WWSB_FE</span>
00411 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o0">Console</a>-&gt;fVDMVideoMode) {
00412                     <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == <a class="code" href="../../d8/d2/__output_8h.html#a9">ATTR_OF_COMMON_LVB</a>(SourcePtr)) {
00413                         Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
00414                     }
00415                     <span class="keywordflow">else</span> {
00416                         Attr++;
00417                         Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
00418                         Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a9">ATTR_OF_COMMON_LVB</a>(SourcePtr);
00419                         AttrLength += 1;
00420                     }
00421                 }
00422                 <span class="keywordflow">else</span>
00423 <span class="preprocessor">#endif</span>
00424 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr)) {
00425                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
00426                 }
00427                 <span class="keywordflow">else</span> {
00428                     Attr++;
00429                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
00430                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a6">ATTR_OF_VGA</a>(SourcePtr);
00431                     AttrLength += 1;
00432                 }
00433             }
00434         } <span class="keywordflow">else</span> {
00435 <span class="preprocessor">#ifdef WWSB_FE</span>
00436 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr) &amp; ~COMMON_LVB_SBCSDBCS;
00437 <span class="preprocessor">#else</span>
00438 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr);
00439 <span class="preprocessor">#endif</span>
00440 <span class="preprocessor"></span>            <span class="keywordflow">for</span> (j = SourceRect-&gt;Left;
00441                     j &lt;= SourceRect-&gt;Right;
00442                     j++, SourcePtr += <a class="code" href="../../d8/d2/__output_8h.html#a4">SIZEOF_CI_CELL</a>) {
00443 
00444                 *Char++ = <a class="code" href="../../d8/d2/__output_8h.html#a2">WCHAR_OF_PCI</a>(SourcePtr);
00445 <span class="preprocessor">#ifdef WWSB_FE</span>
00446 <span class="preprocessor"></span>                <span class="comment">// MSKK Apr.02.1993 V-HirotS For KAttr</span>
00447                 *AttrP++ = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)((<a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr) &amp; COMMON_LVB_SBCSDBCS) &gt;&gt;8);
00448 <span class="preprocessor">#endif</span>
00449 <span class="preprocessor"></span>
00450 <span class="preprocessor">#ifdef WWSB_FE</span>
00451 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == (<a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr) &amp; ~COMMON_LVB_SBCSDBCS))
00452 <span class="preprocessor">#else</span>
00453 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr))
00454 <span class="preprocessor">#endif</span>
00455 <span class="preprocessor"></span>                {
00456                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
00457                 }
00458                 <span class="keywordflow">else</span> {
00459                     Attr++;
00460                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
00461 <span class="preprocessor">#ifdef WWSB_FE</span>
00462 <span class="preprocessor"></span>                    <span class="comment">// MSKK Apr.02.1993 V-HirotS For KAttr</span>
00463                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr) &amp; ~COMMON_LVB_SBCSDBCS;
00464 <span class="preprocessor">#else</span>
00465 <span class="preprocessor"></span>                    Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = <a class="code" href="../../d8/d2/__output_8h.html#a3">ATTR_OF_PCI</a>(SourcePtr);
00466 <span class="preprocessor">#endif</span>
00467 <span class="preprocessor"></span>                    AttrLength += 1;
00468                 }
00469             }
00470         }
00471 
00472         <span class="comment">// recalculate first and last non-space char</span>
00473 
00474         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
00475         <span class="keywordflow">if</span> (TargetPoint.X &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
00476             PWCHAR LastChar = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.X];
00477 
00478             <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetPoint.X];Char &lt; LastChar &amp;&amp; *Char==(WCHAR)<span class="charliteral">' '</span>;Char++)
00479                 ;
00480             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char-Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>);
00481         }
00482 
00483         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
00484         <span class="keywordflow">if</span> ((TargetPoint.X+XSize) &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
00485             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LastNonSpace;
00486             PWCHAR FirstChar = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>;
00487 
00488             LastNonSpace = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetPoint.X+XSize-1);
00489             <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[(TargetPoint.X+XSize-1)];*Char==(WCHAR)<span class="charliteral">' '</span> &amp;&amp; Char &gt;= FirstChar;Char--)
00490                 LastNonSpace--;
00491 
00492             <span class="comment">//</span>
00493             <span class="comment">// if the attributes change after the last non-space, make the</span>
00494             <span class="comment">// index of the last attribute change + 1 the length.  otherwise</span>
00495             <span class="comment">// make the length one more than the last non-space.</span>
00496             <span class="comment">//</span>
00497 
00498             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(LastNonSpace+1);
00499         }
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">// see if attr string is different.  if so, allocate a new</span>
00503         <span class="comment">// attr buffer and merge the two strings.</span>
00504         <span class="comment">//</span>
00505 
00506 
00507         <span class="keywordflow">if</span> (AttrLength != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> ||
00508             memcmp(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,AttrBuf,AttrLength*<span class="keyword">sizeof</span>(*Attr))) {
00509             <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
00510             WORD NewAttrsLength;
00511 
00512             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
00513                              Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
00514                              AttrBuf,
00515                              AttrLength,
00516                              &amp;NewAttrs,
00517                              &amp;NewAttrsLength,
00518                              TargetPoint.X,
00519                              (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetPoint.X+XSize-1),
00520                              Row,
00521                              ScreenInfo
00522                             ))) {
00523                 <span class="keywordflow">if</span> (XSize &gt; 80) {
00524                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AttrBuf);
00525                 }
00526                 <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetPoint.Y,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetPoint.Y+YSize-1));
00527                 <span class="keywordflow">return</span>;
00528             }
00529             <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
00530                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
00531             }
00532             <span class="keywordflow">else</span> {
00533                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
00534             }
00535             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
00536             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
00537             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00538             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
00539         }
00540         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o5">ScreenBufferSize</a>.Y) {
00541             RowIndex = 0;
00542         }
00543     }
00544     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetPoint.Y,(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetPoint.Y+YSize-1));
00545 
00546     <span class="keywordflow">if</span> (XSize &gt; 80) {
00547         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AttrBuf);
00548     }
00549 }
00550 
00551 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00552"></a><a class="code" href="../../d8/d2/__output_8h.html#a15">00552</a> <a class="code" href="../../d8/d2/__output_8h.html#a15">WWSB_WriteRegionToScreen</a>(
00553     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00554     IN PSMALL_RECT Region
00555     )
00556 {
00557     COORD Window;
00558     <span class="keywordtype">int</span> i,j;
00559     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr;
00560     RECT TextRect;
00561     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
00562     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CountOfAttr;
00563     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
00564     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> OneLine, SimpleWrite;  <span class="comment">// one line &amp;&amp; one attribute per line</span>
00565     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
00566     PWCHAR TransBufferCharacter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00567 <span class="preprocessor">#ifdef WWSB_FE</span>
00568 <span class="preprocessor"></span>    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  DoubleColorDbcs;
00569     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> CountOfAttrOriginal;
00570     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RegionRight;
00571     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  LocalEUDCFlag;
00572     SMALL_RECT CaTextRect;
00573     PCONVERSIONAREA_INFORMATION ConvAreaInfo = ScreenInfo-&gt;ConvScreenInfo;
00574 <span class="preprocessor">#endif</span>
00575 <span class="preprocessor"></span>
00576     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"WriteRegionToScreen\n"</span>));
00577 
00578 <span class="preprocessor">#ifdef WWSB_FE</span>
00579 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ConvAreaInfo) {
00580         CaTextRect.Left = Region-&gt;Left - ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Window.Left - ConvAreaInfo-&gt;CaInfo.coordConView.X;
00581         CaTextRect.Right = CaTextRect.Left + (Region-&gt;Right - Region-&gt;Left);
00582         CaTextRect.Top   = Region-&gt;Top - ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Window.Top - ConvAreaInfo-&gt;CaInfo.coordConView.Y;
00583         CaTextRect.Bottom = CaTextRect.Top + (Region-&gt;Bottom - Region-&gt;Top);
00584     }
00585 
00586     <span class="keywordflow">if</span> (Region-&gt;Left &amp;&amp; (ScreenInfo-&gt;BisectFlag &amp; BISECT_LEFT)) {
00587         Region-&gt;Left--;
00588     }
00589     <span class="keywordflow">if</span> (Region-&gt;Right+1 &lt; ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp; (ScreenInfo-&gt;BisectFlag &amp; BISECT_RIGHT)) {
00590         Region-&gt;Right++;
00591     }
00592     ScreenInfo-&gt;BisectFlag &amp;= ~(BISECT_LEFT | BISECT_RIGHT);
00593     Console-&gt;ConsoleIme.ScrollWaitCountDown = Console-&gt;ConsoleIme.ScrollWaitTimeout;
00594 <span class="preprocessor">#endif</span>
00595 <span class="preprocessor"></span>
00596     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> == 0) {
00597 
00598         <span class="comment">//</span>
00599         <span class="comment">// if we have a selection, turn it off.</span>
00600         <span class="comment">//</span>
00601 
00602         <a class="code" href="../../d8/d5/consrv_8h.html#a308">InvertSelection</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00603 
00604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
00605         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/__output_8h.html#a20">WWSB_PolyTextOutCandidate</a>(ScreenInfo,Region)) {
00606             <a class="code" href="../../d8/d2/__output_8h.html#a21">WWSB_ConsolePolyTextOut</a>(ScreenInfo,Region);
00607         }
00608         <span class="keywordflow">else</span> {
00609 
00610 <span class="preprocessor">#ifdef WWSB_FE</span>
00611 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ConvAreaInfo) {
00612                 Window.Y = Region-&gt;Top - Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Top;
00613                 Window.X = Region-&gt;Left - Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o4">CurrentScreenBuffer</a>-&gt;<a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html#o6">Window</a>.Left;
00614             }
00615             <span class="keywordflow">else</span> {
00616 <span class="preprocessor">#endif</span>
00617 <span class="preprocessor"></span>                Window.Y = Region-&gt;Top - ScreenInfo-&gt;Window.Top;
00618                 Window.X = Region-&gt;Left - ScreenInfo-&gt;Window.Left;
00619 <span class="preprocessor">#ifdef WWSB_FE</span>
00620 <span class="preprocessor"></span>            }
00621 <span class="preprocessor">#endif</span>
00622 <span class="preprocessor"></span>
00623 <span class="preprocessor">#ifdef WWSB_FE</span>
00624 <span class="preprocessor"></span>            RowIndex = (ConvAreaInfo ? CaTextRect.Top :
00625                                        (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+Region-&gt;Top) % ScreenInfo-&gt;ScreenBufferSize.Y
00626                        );
00627             RegionRight = Region-&gt;Right;
00628 <span class="preprocessor">#else</span>
00629 <span class="preprocessor"></span>            RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+Region-&gt;Top) % ScreenInfo-&gt;ScreenBufferSize.Y;
00630 <span class="preprocessor">#endif</span>
00631 <span class="preprocessor"></span>            OneLine = (Region-&gt;Top==Region-&gt;Bottom);
00632 
00633             TransBufferCharacter = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(
00634                                                      <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),
00635                                                      (ScreenInfo-&gt;ScreenBufferSize.X*<span class="keyword">sizeof</span>(WCHAR))+<span class="keyword">sizeof</span>(WCHAR));
00636             <span class="keywordflow">if</span> (TransBufferCharacter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00637             {
00638                 KdPrint((<span class="stringliteral">"CONSRV: WriteRegionToScreen cannot allocate memory\n"</span>));
00639                 <span class="keywordflow">return</span> ;
00640             }
00641 
00642             <span class="keywordflow">for</span> (i=Region-&gt;Top;i&lt;=Region-&gt;Bottom;i++,Window.Y++) {
00643 <span class="preprocessor">#ifdef WWSB_FE</span>
00644 <span class="preprocessor"></span>                DoubleColorDbcs = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645                 Region-&gt;Right = RegionRight;
00646 <span class="preprocessor">#endif</span>
00647 <span class="preprocessor"></span>
00648                 <span class="comment">//</span>
00649                 <span class="comment">// copy the chars and attrs from their respective arrays</span>
00650                 <span class="comment">//</span>
00651 
00652                 Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
00653 
00654                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> == 1) {
00655                     Attr = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>;
00656                     CountOfAttr = ScreenInfo-&gt;ScreenBufferSize.X;
00657                     SimpleWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00658                 } <span class="keywordflow">else</span> {
00659                     SimpleWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00660                     <a class="code" href="../../d6/d2/output_8c.html#a47">FindAttrIndex</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
00661 #ifdef <a class="code" href="../../d5/d8/dispatch_8c.html#a1">WWSB_FE</a>
00662                                   (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ConvAreaInfo ? CaTextRect.Left : Region-&gt;Left),
00663 #<span class="keywordflow">else</span>
00664                                   Region-&gt;Left,
00665 #endif
00666                                   &amp;Attr,
00667                                   &amp;CountOfAttr
00668                                  );
00669                 }
00670                 <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> != Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
00671                     <a class="code" href="../../d6/d2/output_8c.html#a2">TEXTCOLOR_CALL</a>;
00672 <span class="preprocessor">#ifdef WWSB_FE</span>
00673 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &amp; COMMON_LVB_REVERSE_VIDEO)
00674                     {
00675                         SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>)));
00676                         SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &gt;&gt; 4)));
00677                     }
00678                     <span class="keywordflow">else</span>{
00679 <span class="preprocessor">#endif</span>
00680 <span class="preprocessor"></span>                        SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>)));
00681                         SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &gt;&gt; 4)));
00682 <span class="preprocessor">#ifdef WWSB_FE</span>
00683 <span class="preprocessor"></span>                    }
00684 <span class="preprocessor">#endif</span>
00685 <span class="preprocessor"></span>                    Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
00686                 }
00687                 TextRect.top = Window.Y*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
00688                 TextRect.bottom = TextRect.top + <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
00689                 <span class="keywordflow">for</span> (j=Region-&gt;Left;j&lt;=Region-&gt;Right;) {
00690                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NumberOfChars;
00691                     <span class="keywordtype">int</span> TextLeft;
00692                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LeftChar,RightChar;
00693 
00694                     <span class="keywordflow">if</span> (CountOfAttr &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Region-&gt;Right - j + 1)) {
00695                         CountOfAttr = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Region-&gt;Right - j + 1);
00696                     }
00697 
00698 <span class="preprocessor">#ifdef WWSB_FE</span>
00699 <span class="preprocessor"></span>                    CountOfAttrOriginal = CountOfAttr;
00700 
00701 
00702                     LocalEUDCFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00703                     <span class="keywordflow">if</span>((ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a> &amp;&amp;
00704                         ((<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)(ScreenInfo-&gt;Console-&gt;EudcInformation))-&gt;LocalVDMEudcMode)){
00705                         LocalEUDCFlag = <a class="code" href="../../d9/d7/eudc_8h.html#a9">CheckEudcRangeInString</a>(
00706                                             Console,
00707                                             &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ConvAreaInfo ?
00708                                                                 CaTextRect.Left + (j-Region-&gt;Left) : j],
00709                                             CountOfAttr,
00710                                             &amp;CountOfAttr);
00711                     }
00712                     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
00713                         !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) &amp;&amp;
00714                         ((<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)(ScreenInfo-&gt;Console-&gt;EudcInformation))-&gt;LocalKeisenEudcMode
00715                        ) {
00716                         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> k;
00717                         PWCHAR Char2;
00718                         Char2 = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ConvAreaInfo ? CaTextRect.Left + (j-Region-&gt;Left) : j];
00719                         <span class="keywordflow">for</span> ( k = 0 ; k &lt; CountOfAttr ; k++,Char2++){
00720                             <span class="keywordflow">if</span> (*Char2 &lt; <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>){
00721                                 CountOfAttr = k ;
00722                                 LocalEUDCFlag = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00723                                 <span class="keywordflow">break</span>;
00724                             }
00725                         }
00726                     }
00727 <span class="preprocessor">#endif</span>
00728 <span class="preprocessor"></span>
00729                     <span class="comment">//</span>
00730                     <span class="comment">// make the bounding rect smaller, if we can.  the TEXT_VALID_HINT</span>
00731                     <span class="comment">// flag gets set each time we write to the screen buffer.  it gets</span>
00732                     <span class="comment">// turned off any time we get asked to redraw the screen</span>
00733                     <span class="comment">// and we don't know exactly what needs to be redrawn</span>
00734                     <span class="comment">// (i.e. paint messages).</span>
00735                     <span class="comment">//</span>
00736                     <span class="comment">// we have the left and right bounds of the text on the</span>
00737                     <span class="comment">// line.  the opaqueing rectangle and the number of</span>
00738                     <span class="comment">// chars get set according to those values.</span>
00739                     <span class="comment">//</span>
00740                     <span class="comment">// if there's more than one attr per line (!SimpleWrite)</span>
00741                     <span class="comment">// we bail on the opaqueing rect.</span>
00742                     <span class="comment">//</span>
00743 
00744                     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a> &amp;&amp; SimpleWrite) {
00745                         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> != <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>) {
00746                             TextRect.left = (<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a>),j)-ScreenInfo-&gt;Window.Left) *
00747                                             <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00748                         } <span class="keywordflow">else</span> {
00749                             TextRect.left = Window.X*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00750                         }
00751 
00752                         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> != <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>) {
00753                             TextRect.right = (<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a>),j+CountOfAttr)-ScreenInfo-&gt;Window.Left) *
00754                                              <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00755                         } <span class="keywordflow">else</span> {
00756                             TextRect.right = TextRect.left + CountOfAttr*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00757                         }
00758                         LeftChar = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,j);
00759                         RightChar = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,j+CountOfAttr);
00760                         NumberOfChars = RightChar - LeftChar;
00761                         TextLeft = (LeftChar-ScreenInfo-&gt;Window.Left)*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00762                     } <span class="keywordflow">else</span> {
00763 <span class="preprocessor">#ifdef WWSB_FE</span>
00764 <span class="preprocessor"></span>                        LeftChar = ConvAreaInfo ? CaTextRect.Left + (j-Region-&gt;Left) : j;
00765 <span class="preprocessor">#else</span>
00766 <span class="preprocessor"></span>                        LeftChar = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)j;
00767 <span class="preprocessor">#endif</span>
00768 <span class="preprocessor"></span>                        TextRect.left = Window.X*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00769                         TextRect.right = TextRect.left + CountOfAttr*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00770 <span class="preprocessor">#ifdef WWSB_FE</span>
00771 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (ConvAreaInfo)
00772                             NumberOfChars = (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((CaTextRect.Left+(j-Region-&gt;Left)) + CountOfAttr)) ?
00773                                 (CountOfAttr) : (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>-(CaTextRect.Left+(j-Region-&gt;Left)));
00774                         <span class="keywordflow">else</span>
00775 <span class="preprocessor">#endif</span>
00776 <span class="preprocessor"></span>                            NumberOfChars = (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(j + CountOfAttr)) ? (CountOfAttr) : (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>-j);
00777                         TextLeft = TextRect.left;
00778                     }
00779 
00780                     <span class="keywordflow">if</span> (NumberOfChars &lt; 0)
00781                     {
00782                         NumberOfChars = 0;
00783 <span class="preprocessor">#ifdef WWSB_FE</span>
00784 <span class="preprocessor"></span>                        TextRect.left = Window.X*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00785                         TextRect.right = TextRect.left + CountOfAttr*<a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
00786 <span class="preprocessor">#endif</span>
00787 <span class="preprocessor"></span>                    }
00788                     <a class="code" href="../../d6/d2/output_8c.html#a1">TEXTOUT_CALL</a>;
00789 <span class="preprocessor">#ifdef WWSB_FE</span>
00790 <span class="preprocessor"></span>                    <span class="comment">/*</span>
00791 <span class="comment">                     * Text out everything (i.e. SBCS/DBCS, Common LVB attribute, Local EUDC)</span>
00792 <span class="comment">                     */</span>
00793                     <a class="code" href="../../d0/d3/dbcs_8h.html#a41">TextOutEverything</a>(Console,
00794                                       ScreenInfo,
00795                                       (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)j,
00796                                       &amp;Region-&gt;Right,
00797                                       &amp;CountOfAttr,
00798                                       CountOfAttrOriginal,
00799                                       &amp;DoubleColorDbcs,
00800                                       LocalEUDCFlag,
00801                                       Row,
00802                                       Attr,
00803                                       LeftChar,
00804                                       RightChar,
00805                                       TextLeft,
00806                                       TextRect,
00807                                       NumberOfChars);
00808 <span class="preprocessor">#else</span>
00809 <span class="preprocessor"></span>                    NumberOfChars =
00810                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d0/d3/dbcs_8h.html#a36">RemoveDbcsMarkAll</a>(ScreenInfo,
00811                                                  Row,
00812                                                  &amp;LeftChar,
00813                                                  &amp;TextRect,
00814                                                  &amp;TextLeft,
00815                                                  TransBufferCharacter,
00816                                                  NumberOfChars);
00817                     ExtTextOutW(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
00818                                TextLeft,
00819                                TextRect.top,
00820                                ETO_OPAQUE,
00821                                &amp;TextRect,
00822                                TransBufferCharacter,
00823                                NumberOfChars,
00824                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00825                               );
00826 <span class="preprocessor">#endif</span>
00827 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (OneLine &amp;&amp; SimpleWrite) {
00828                         <span class="keywordflow">break</span>;
00829                     }
00830                     j+=CountOfAttr;
00831                     <span class="keywordflow">if</span> (j &lt;= Region-&gt;Right) {
00832                         Window.X += CountOfAttr;
00833 <span class="preprocessor">#ifdef WWSB_FE</span>
00834 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (CountOfAttr &lt; CountOfAttrOriginal){
00835                             CountOfAttr = CountOfAttrOriginal - CountOfAttr;
00836                         }
00837                         <span class="keywordflow">else</span> {
00838 <span class="preprocessor">#endif</span>
00839 <span class="preprocessor"></span>                            Attr++;
00840                             CountOfAttr = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a>;
00841 <span class="preprocessor">#ifdef WWSB_FE</span>
00842 <span class="preprocessor"></span>                        }
00843 <span class="preprocessor">#endif</span>
00844 <span class="preprocessor"></span><span class="preprocessor">#ifdef WWSB_FE</span>
00845 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &amp; COMMON_LVB_REVERSE_VIDEO)
00846                         {
00847                             SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>)));
00848                             SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &gt;&gt; 4)));
00849                         }
00850                         <span class="keywordflow">else</span>{
00851 <span class="preprocessor">#endif</span>
00852 <span class="preprocessor"></span>                            SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>)));
00853                             SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> &gt;&gt; 4)));
00854 <span class="preprocessor">#ifdef WWSB_FE</span>
00855 <span class="preprocessor"></span>                        }
00856 <span class="preprocessor">#endif</span>
00857 <span class="preprocessor"></span>                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> = Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
00858                     }
00859                 }
00860                 Window.X = Region-&gt;Left - ScreenInfo-&gt;Window.Left;
00861                 <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
00862                     RowIndex = 0;
00863                 }
00864             }
00865             GdiFlush();
00866             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferCharacter);
00867         }
00868 
00869         <span class="comment">//</span>
00870         <span class="comment">// if we have a selection, turn it on.</span>
00871         <span class="comment">//</span>
00872 
00873         <a class="code" href="../../d8/d5/consrv_8h.html#a308">InvertSelection</a>(Console, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00874     }
00875 <span class="preprocessor">#ifdef i386</span>
00876 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o47">FullScreenFlags</a> &amp; CONSOLE_FULLSCREEN_HARDWARE) {
00877 <span class="preprocessor">#ifdef WWSB_FE</span>
00878 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (! ScreenInfo-&gt;ConvScreenInfo) {
00879             <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer == ScreenInfo) {
00880                 WWSB_WriteRegionToScreenHW(ScreenInfo,Region);
00881             }
00882         }
00883         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)
00884 <span class="preprocessor">#endif</span>
00885 <span class="preprocessor"></span>            WWSB_WriteRegionToScreenHW(ScreenInfo,Region);
00886     }
00887 <span class="preprocessor">#endif</span>
00888 <span class="preprocessor"></span>
00889 <span class="preprocessor">#ifdef WWSB_FE</span>
00890 <span class="preprocessor"></span>    {
00891         SMALL_RECT TmpRegion;
00892 
00893         <span class="keywordflow">if</span> (ScreenInfo-&gt;BisectFlag &amp; BISECT_TOP) {
00894             ScreenInfo-&gt;BisectFlag &amp;= ~BISECT_TOP;
00895             <span class="keywordflow">if</span> (Region-&gt;Top) {
00896                 TmpRegion.Top = Region-&gt;Top-1;
00897                 TmpRegion.Bottom = Region-&gt;Top-1;
00898                 TmpRegion.Left = ScreenInfo-&gt;ScreenBufferSize.X-1;
00899                 TmpRegion.Right = ScreenInfo-&gt;ScreenBufferSize.X-1;
00900                 <a class="code" href="../../d8/d2/__output_8h.html#a15">WWSB_WriteRegionToScreen</a>(ScreenInfo,&amp;TmpRegion);
00901             }
00902         }
00903         <span class="keywordflow">if</span> (ScreenInfo-&gt;BisectFlag &amp; BISECT_BOTTOM) {
00904             ScreenInfo-&gt;BisectFlag &amp;= ~BISECT_BOTTOM;
00905             <span class="keywordflow">if</span> (Region-&gt;Bottom+1 &lt; ScreenInfo-&gt;ScreenBufferSize.Y) {
00906                 TmpRegion.Top = Region-&gt;Bottom+1;
00907                 TmpRegion.Bottom = Region-&gt;Bottom+1;
00908                 TmpRegion.Left = 0;
00909                 TmpRegion.Right = 0;
00910                 <a class="code" href="../../d8/d2/__output_8h.html#a15">WWSB_WriteRegionToScreen</a>(ScreenInfo,&amp;TmpRegion);
00911             }
00912         }
00913     }
00914 <span class="preprocessor">#endif</span>
00915 <span class="preprocessor"></span>}
00916 
00917 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00918"></a><a class="code" href="../../d8/d2/__output_8h.html#a16">00918</a> <a class="code" href="../../d8/d2/__output_8h.html#a16">WWSB_WriteToScreen</a>(
00919     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00920     IN PSMALL_RECT Region
00921     )
00922 <span class="comment">/*++</span>
00923 <span class="comment"></span>
00924 <span class="comment">Routine Description:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    This routine writes a screen buffer region to the screen.</span>
00927 <span class="comment"></span>
00928 <span class="comment">Arguments:</span>
00929 <span class="comment"></span>
00930 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
00931 <span class="comment"></span>
00932 <span class="comment">    Region - Region to write in screen buffer coordinates.  Region is</span>
00933 <span class="comment">    inclusive</span>
00934 <span class="comment"></span>
00935 <span class="comment">Return Value:</span>
00936 <span class="comment"></span>
00937 <span class="comment">    none.</span>
00938 <span class="comment"></span>
00939 <span class="comment">--*/</span>
00940 
00941 {
00942     SMALL_RECT ClippedRegion;
00943 
00944     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"WriteToScreen\n"</span>));
00945     <span class="comment">//</span>
00946     <span class="comment">// update to screen, if we're not iconic.  we're marked as</span>
00947     <span class="comment">// iconic if we're fullscreen, so check for fullscreen.</span>
00948     <span class="comment">//</span>
00949 
00950     <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo) ||
00951         (ScreenInfo-&gt;Console-&gt;Flags &amp; (<a class="code" href="../../d1/d7/server_8h.html#a0">CONSOLE_IS_ICONIC</a> | <a class="code" href="../../d1/d7/server_8h.html#a8">CONSOLE_NO_WINDOW</a>) &amp;&amp;
00952          ScreenInfo-&gt;Console-&gt;FullScreenFlags == 0)) {
00953         <span class="keywordflow">return</span>;
00954     }
00955 
00956     <span class="comment">// clip region</span>
00957 
00958     ClippedRegion.Left = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region-&gt;Left, ScreenInfo-&gt;Window.Left);
00959     ClippedRegion.Top = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Region-&gt;Top, ScreenInfo-&gt;Window.Top);
00960     ClippedRegion.Right = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region-&gt;Right, ScreenInfo-&gt;Window.Right);
00961     ClippedRegion.Bottom = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Region-&gt;Bottom, ScreenInfo-&gt;Window.Bottom);
00962     <span class="keywordflow">if</span> (ClippedRegion.Right &lt; ClippedRegion.Left ||
00963         ClippedRegion.Bottom &lt; ClippedRegion.Top) {
00964         <span class="keywordflow">return</span>;
00965     }
00966 
00967     <span class="keywordflow">if</span> (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a1">CONSOLE_GRAPHICS_BUFFER</a>) {
00968         <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;FullScreenFlags == 0) {
00969             <a class="code" href="../../d8/d5/consrv_8h.html#a274">WriteRegionToScreenBitMap</a>(ScreenInfo, &amp;ClippedRegion);
00970         }
00971     } <span class="keywordflow">else</span> {
00972         <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a3">ConsoleHideCursor</a>(ScreenInfo);
00973         <a class="code" href="../../d8/d2/__output_8h.html#a15">WWSB_WriteRegionToScreen</a>(ScreenInfo, &amp;ClippedRegion);
00974 <span class="preprocessor">#ifdef WWSB_FE</span>
00975 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Console-&gt;ConsoleIme.ScrollFlag &amp; HIDE_FOR_SCROLL))
00976         {
00977             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
00978 
00979             <span class="keywordflow">if</span> (! ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;ConvScreenInfo) {
00980                 WriteConvRegionToScreen(ScreenInfo,
00981                                         ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot,
00982                                         Region);
00983             }
00984             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ConvAreaInfo = ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot) {
00985                 <span class="keywordflow">do</span> {
00986                     <span class="keywordflow">if</span> (ConvAreaInfo-&gt;ScreenBuffer == ScreenInfo)
00987                         <span class="keywordflow">break</span>;
00988                 } <span class="keywordflow">while</span> (ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext);
00989                 <span class="keywordflow">if</span> (ConvAreaInfo) {
00990                     WriteConvRegionToScreen(ScreenInfo,
00991                                             ConvAreaInfo-&gt;ConvAreaNext,
00992                                             Region);
00993                 }
00994             }
00995         }
00996 <span class="preprocessor">#endif</span>
00997 <span class="preprocessor"></span>        <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a2">ConsoleShowCursor</a>(ScreenInfo);
00998     }
00999 }
01000 
01001 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01002"></a><a class="code" href="../../d8/d2/__output_8h.html#a17">01002</a> <a class="code" href="../../d8/d2/__output_8h.html#a17">WWSB_WriteOutputString</a>(
01003     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01004     IN PVOID Buffer,
01005     IN COORD WriteCoord,
01006     IN ULONG StringType,
01007     IN OUT PULONG NumRecords, <span class="comment">// this value is valid even for error cases</span>
01008     OUT PULONG NumColumns OPTIONAL
01009     )
01010 
01011 <span class="comment">/*++</span>
01012 <span class="comment"></span>
01013 <span class="comment">Routine Description:</span>
01014 <span class="comment"></span>
01015 <span class="comment">    This routine writes a string of characters or attributes to the</span>
01016 <span class="comment">    screen buffer.</span>
01017 <span class="comment"></span>
01018 <span class="comment">Arguments:</span>
01019 <span class="comment"></span>
01020 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
01021 <span class="comment"></span>
01022 <span class="comment">    Buffer - Buffer to write from.</span>
01023 <span class="comment"></span>
01024 <span class="comment">    WriteCoord - Screen buffer coordinate to begin writing to.</span>
01025 <span class="comment"></span>
01026 <span class="comment">    StringType</span>
01027 <span class="comment">      One of the following:</span>
01028 <span class="comment">        CONSOLE_ASCII          - write a string of ascii characters.</span>
01029 <span class="comment">        CONSOLE_REAL_UNICODE   - write a string of real unicode characters.</span>
01030 <span class="comment">        CONSOLE_FALSE_UNICODE  - write a string of false unicode characters.</span>
01031 <span class="comment">        CONSOLE_ATTRIBUTE      - write a string of attributes.</span>
01032 <span class="comment"></span>
01033 <span class="comment">    NumRecords - On input, the number of elements to write.  On output,</span>
01034 <span class="comment">    the number of elements written.</span>
01035 <span class="comment"></span>
01036 <span class="comment">    NumColumns - receives the number of columns output, which could be more</span>
01037 <span class="comment">                 than NumRecords (FE fullwidth chars)</span>
01038 <span class="comment">Return Value:</span>
01039 <span class="comment"></span>
01040 <span class="comment"></span>
01041 <span class="comment">--*/</span>
01042 
01043 {
01044     ULONG NumWritten;
01045     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> X,Y,LeftX;
01046     SMALL_RECT WriteRegion;
01047     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01048     PWCHAR Char;
01049     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01050     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j;
01051     PWCHAR TransBuffer;
01052 <span class="preprocessor">#ifdef WWSB_NOFE</span>
01053 <span class="preprocessor"></span>    WCHAR SingleChar;
01054 <span class="preprocessor">#endif</span>
01055 <span class="preprocessor"></span>    <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
01056 <span class="preprocessor">#ifdef WWSB_FE</span>
01057 <span class="preprocessor"></span>    <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> AttrP;
01058     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> TransBufferA;
01059     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> BufferA;
01060     ULONG NumRecordsSavedForUnicode;
01061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01062 <span class="preprocessor">#endif</span>
01063 <span class="preprocessor"></span>
01064     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"WriteOutputString\n"</span>));
01065 <span class="preprocessor">#ifdef WWSB_FE</span>
01066 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
01067 <span class="preprocessor">#endif</span>
01068 <span class="preprocessor"></span>
01069     <span class="keywordflow">if</span> (*NumRecords == 0)
01070         <span class="keywordflow">return</span> STATUS_SUCCESS;
01071 
01072     NumWritten = 0;
01073     X=WriteCoord.X;
01074     Y=WriteCoord.Y;
01075     <span class="keywordflow">if</span> (X&gt;=ScreenInfo-&gt;ScreenBufferSize.X ||
01076         X&lt;0 ||
01077         Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y ||
01078         Y&lt;0) {
01079         *NumRecords = 0;
01080         <span class="keywordflow">return</span> STATUS_SUCCESS;
01081     }
01082 
01083     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01084     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+WriteCoord.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
01085 
01086     <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) {
01087 <span class="preprocessor">#ifdef WWSB_FE</span>
01088 <span class="preprocessor"></span>        PCHAR TmpBuf;
01089         PWCHAR TmpTrans;
01090         ULONG i;
01091         PCHAR TmpTransA;
01092 <span class="preprocessor">#endif</span>
01093 <span class="preprocessor"></span>
01094         <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01095             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01096             <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01097                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
01098             <span class="keywordflow">else</span>
01099                 Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01100         } <span class="keywordflow">else</span> {
01101             Codepage = ScreenInfo-&gt;Console-&gt;OutputCP;
01102         }
01103 
01104 <span class="preprocessor">#ifdef WWSB_FE</span>
01105 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*NumRecords &gt; (ULONG)(ScreenInfo-&gt;ScreenBufferSize.X * ScreenInfo-&gt;ScreenBufferSize.Y)) {
01106 
01107             TransBuffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),*NumRecords * 2 * <span class="keyword">sizeof</span>(WCHAR));
01108             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01109                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01110             }
01111             TransBufferA = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),*NumRecords * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01112             <span class="keywordflow">if</span> (TransBufferA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01113                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01114                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01115             }
01116 
01117             fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01118         }
01119         <span class="keywordflow">else</span> {
01120             TransBuffer  = ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter;
01121             TransBufferA = ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferAttribute;
01122         }
01123 
01124         TmpBuf = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01125         TmpTrans = TransBuffer;
01126         TmpTransA = TransBufferA;      <span class="comment">// MSKK Apr.02.1993 V-HirotS For KAttr</span>
01127         <span class="keywordflow">for</span> (i=0; i &lt; *NumRecords;) {
01128             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>(*TmpBuf,&amp;ScreenInfo-&gt;Console-&gt;OutputCPInfo)) {
01129                 <span class="keywordflow">if</span> (i+1 &gt;= *NumRecords) {
01130                     *TmpTrans = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01131                     *TmpTransA = 0;
01132                     i++;
01133                 }
01134                 <span class="keywordflow">else</span> {
01135                     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01136                                            TmpBuf,
01137                                            2,
01138                                            TmpTrans,
01139                                            2);
01140                     *(TmpTrans+1) = *TmpTrans;
01141                     TmpTrans += 2;
01142                     TmpBuf += 2;
01143                     *TmpTransA++ = ATTR_LEADING_BYTE;
01144                     *TmpTransA++ = ATTR_TRAILING_BYTE;
01145                     i += 2;
01146                 }
01147             }
01148             <span class="keywordflow">else</span> {
01149                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01150                                        TmpBuf,
01151                                        1,
01152                                        TmpTrans,
01153                                        1);
01154                 TmpTrans++;
01155                 TmpBuf++;
01156                 *TmpTransA++ = 0;               <span class="comment">// MSKK APr.02.1993 V-HirotS For KAttr</span>
01157                 i++;
01158             }
01159         }
01160         BufferA = TransBufferA;
01161         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = TransBuffer;
01162 <span class="preprocessor">#else</span>
01163 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*NumRecords == 1) {
01164             TransBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01165             SingleChar = SB_CharToWcharGlyph(Codepage, *((<span class="keywordtype">char</span> *)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>));
01166             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = &amp;SingleChar;
01167         } <span class="keywordflow">else</span> {
01168             TransBuffer = (PWCHAR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),*NumRecords * <span class="keyword">sizeof</span>(WCHAR));
01169             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01170                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01171             }
01172             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage, <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, *NumRecords,
01173                     TransBuffer, *NumRecords);
01174             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = TransBuffer;
01175         }
01176 <span class="preprocessor">#endif</span>
01177 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a> &amp;&amp;
01178             (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01179             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01180         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
01181                                 *NumRecords,
01182                                 ScreenInfo-&gt;Console-&gt;OutputCP
01183                                 );
01184     }
01185 
01186 <span class="preprocessor">#ifdef WWSB_FE</span>
01187 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>) || (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>)) {
01188         PWCHAR TmpBuf;
01189         PWCHAR TmpTrans;
01190         PCHAR TmpTransA;
01191         ULONG i,j;
01192         WCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
01193 
01194         <span class="comment">/* Avoid overflow into TransBufferCharacter , TransBufferAttribute</span>
01195 <span class="comment">         * because, if hit by IsConsoleFullWidth()</span>
01196 <span class="comment">         * then one unicde character needs two spaces on TransBuffer.</span>
01197 <span class="comment">         */</span>
01198         <span class="keywordflow">if</span> ((*NumRecords*2) &gt; (ULONG)(ScreenInfo-&gt;ScreenBufferSize.X * ScreenInfo-&gt;ScreenBufferSize.Y)) {
01199 
01200             TransBuffer = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),*NumRecords * 2 * <span class="keyword">sizeof</span>(WCHAR));
01201             <span class="keywordflow">if</span> (TransBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01202                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01203             }
01204             TransBufferA = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( TMP_DBCS_TAG ),*NumRecords * 2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01205             <span class="keywordflow">if</span> (TransBufferA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01206                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01207                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01208             }
01209 
01210             fLocalHeap = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01211         }
01212         <span class="keywordflow">else</span> {
01213             TransBuffer  = ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferCharacter;
01214             TransBufferA = ScreenInfo-&gt;BufferInfo.TextInfo.DbcsScreenBuffer.TransBufferAttribute;
01215         }
01216 
01217         TmpBuf = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01218         TmpTrans = TransBuffer;
01219         TmpTransA = TransBufferA;
01220         <span class="keywordflow">for</span> (i=0,j=0; i &lt; *NumRecords; i++,j++) {
01221             *TmpTrans++ = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> = *TmpBuf++;
01222             *TmpTransA = 0;
01223             <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
01224                                    ScreenInfo-&gt;Console-&gt;OutputCP,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)) {
01225                 *TmpTransA++ = ATTR_LEADING_BYTE;
01226                 *TmpTrans++ = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
01227                 *TmpTransA = ATTR_TRAILING_BYTE;
01228                 j++;
01229             }
01230             TmpTransA++;
01231         }
01232         NumRecordsSavedForUnicode = *NumRecords;
01233         *NumRecords = j;
01234         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = TransBuffer;
01235         BufferA = TransBufferA;
01236     }
01237 <span class="preprocessor">#endif</span>
01238 <span class="preprocessor"></span>
01239     <span class="keywordflow">if</span> ((StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>) ||
01240             (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>) ||
01241             (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>)) {
01242         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01243 
01244             LeftX = X;
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// copy the chars into their arrays</span>
01248             <span class="comment">//</span>
01249 
01250             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01251             Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[X];
01252 <span class="preprocessor">#ifdef WWSB_FE</span>
01253 <span class="preprocessor"></span>            AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[X];
01254 <span class="preprocessor">#endif</span>
01255 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt;= (*NumRecords - NumWritten)) {
01256                 <span class="comment">/*</span>
01257 <span class="comment">                 * The text will not hit the right hand edge, copy it all</span>
01258 <span class="comment">                 */</span>
01259 <span class="preprocessor">#ifdef WWSB_FE</span>
01260 <span class="preprocessor"></span>                COORD TPoint;
01261 
01262                 TPoint.X = X;
01263                 TPoint.Y = Y;
01264                 <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*NumRecords-NumWritten),TPoint,ScreenInfo);
01265                 <span class="keywordflow">if</span> (TPoint.Y == ScreenInfo-&gt;ScreenBufferSize.Y-1 &amp;&amp;
01266                     (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TPoint.X+*NumRecords-NumWritten) &gt;= ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp;
01267                     *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) &amp; ATTR_LEADING_BYTE
01268                    ) {
01269                     *((PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01270                     *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) = 0;
01271                     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*NumRecords-NumWritten) &gt; (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1)) {
01272                         *((PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01273                         *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X) = 0;
01274                     }
01275                 }
01276                 RtlCopyMemory(AttrP,BufferA,(*NumRecords - NumWritten) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01277 <span class="preprocessor">#endif</span>
01278 <span class="preprocessor"></span>                RtlCopyMemory(Char,<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,(*NumRecords - NumWritten) * <span class="keyword">sizeof</span>(WCHAR));
01279                 X=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(X+*NumRecords - NumWritten-1);
01280                 NumWritten = *NumRecords;
01281             }
01282             <span class="keywordflow">else</span> {
01283                 <span class="comment">/*</span>
01284 <span class="comment">                 * The text will hit the right hand edge, copy only that much</span>
01285 <span class="comment">                 */</span>
01286 <span class="preprocessor">#ifdef WWSB_FE</span>
01287 <span class="preprocessor"></span>                COORD TPoint;
01288 
01289                 TPoint.X = X;
01290                 TPoint.Y = Y;
01291                 <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-X),TPoint,ScreenInfo);
01292                 <span class="keywordflow">if</span> (TPoint.Y == ScreenInfo-&gt;ScreenBufferSize.Y-1 &amp;&amp;
01293                     TPoint.X+ScreenInfo-&gt;ScreenBufferSize.X-X &gt;= ScreenInfo-&gt;ScreenBufferSize.X &amp;&amp;
01294                     *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) &amp; ATTR_LEADING_BYTE
01295                    ) {
01296                     *((PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01297                     *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) = 0;
01298                     <span class="keywordflow">if</span> (ScreenInfo-&gt;ScreenBufferSize.X-X &gt; ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X-1) {
01299                         *((PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01300                         *((PCHAR)BufferA+ScreenInfo-&gt;ScreenBufferSize.X-TPoint.X) = 0;
01301                     }
01302                 }
01303                 RtlCopyMemory(AttrP,BufferA,(ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01304                 BufferA = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)BufferA + ((ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)));
01305 <span class="preprocessor">#endif</span>
01306 <span class="preprocessor"></span>                RtlCopyMemory(Char,<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,(ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(WCHAR));
01307                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((ScreenInfo-&gt;ScreenBufferSize.X - X) * <span class="keyword">sizeof</span>(WCHAR)));
01308                 NumWritten += ScreenInfo-&gt;ScreenBufferSize.X - X;
01309                 X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
01310             }
01311 
01312             <span class="comment">// recalculate first and last non-space char</span>
01313 
01314             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
01315             <span class="keywordflow">if</span> (LeftX &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
01316                 PWCHAR LastChar = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[ScreenInfo-&gt;ScreenBufferSize.X];
01317 
01318                 <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[LeftX];Char &lt; LastChar &amp;&amp; *Char==(WCHAR)<span class="charliteral">' '</span>;Char++)
01319                     ;
01320                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(Char-Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>);
01321             }
01322 
01323             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
01324             <span class="keywordflow">if</span> ((X+1) &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
01325                 WORD LastNonSpace;
01326                 PWCHAR FirstChar = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>;
01327 
01328                 LastNonSpace = X;
01329                 <span class="keywordflow">for</span> (Char=&amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[X];*Char==(WCHAR)<span class="charliteral">' '</span> &amp;&amp; Char &gt;= FirstChar;Char--)
01330                     LastNonSpace--;
01331                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(LastNonSpace+1);
01332             }
01333             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01334                 RowIndex = 0;
01335             }
01336             <span class="keywordflow">if</span> (NumWritten &lt; *NumRecords) {
01337                 <span class="comment">/*</span>
01338 <span class="comment">                 * The string hit the right hand edge, so wrap around to the</span>
01339 <span class="comment">                 * next line by going back round the while loop, unless we</span>
01340 <span class="comment">                 * are at the end of the buffer - in which case we simply</span>
01341 <span class="comment">                 * abandon the remainder of the output string!</span>
01342 <span class="comment">                 */</span>
01343                 X = 0;
01344                 Y++;
01345                 <span class="keywordflow">if</span> (Y &gt;= ScreenInfo-&gt;ScreenBufferSize.Y) {
01346                     <span class="keywordflow">break</span>; <span class="comment">// abandon output, string is truncated</span>
01347                 }
01348             } <span class="keywordflow">else</span> {
01349                 <span class="keywordflow">break</span>;
01350             }
01351         }
01352     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>) {
01353         PWORD SourcePtr=<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01354         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> AttrBuf;
01355         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attrs[80];
01356         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> Attr;
01357         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> AttrLength;
01358 
01359         AttrBuf = Attrs;
01360         <span class="keywordflow">if</span> (ScreenInfo-&gt;ScreenBufferSize.X &gt; 80) {
01361             AttrBuf = (<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),ScreenInfo-&gt;ScreenBufferSize.X * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a>));
01362             <span class="keywordflow">if</span> (AttrBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01363                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01364         }
01365 <span class="preprocessor">#ifdef WWSB_FE</span>
01366 <span class="preprocessor"></span>        {
01367             COORD TPoint;
01368             TPoint.X = X;
01369             TPoint.Y = Y;
01370             <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt;= (*NumRecords - NumWritten)) {
01371                 <a class="code" href="../../d0/d3/dbcs_8h.html#a33">BisectWriteAttr</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*NumRecords-NumWritten),TPoint,ScreenInfo);
01372             }
01373             <span class="keywordflow">else</span>{
01374                 <a class="code" href="../../d0/d3/dbcs_8h.html#a33">BisectWriteAttr</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-X),TPoint,ScreenInfo);
01375             }
01376         }
01377 <span class="preprocessor">#endif</span>
01378 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01379 
01380             <span class="comment">//</span>
01381             <span class="comment">// copy the attrs into the screen buffer arrays</span>
01382             <span class="comment">//</span>
01383 
01384             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01385             Attr = AttrBuf;
01386             Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 0;
01387 <span class="preprocessor">#ifdef WWSB_FE</span>
01388 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = *SourcePtr &amp; ~COMMON_LVB_SBCSDBCS;
01389 <span class="preprocessor">#else</span>
01390 <span class="preprocessor"></span>            Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = *SourcePtr;
01391 <span class="preprocessor">#endif</span>
01392 <span class="preprocessor"></span>            AttrLength = 1;
01393             <span class="keywordflow">for</span> (j=X;j&lt;ScreenInfo-&gt;ScreenBufferSize.X;j++,SourcePtr++) {
01394 <span class="preprocessor">#ifdef WWSB_FE</span>
01395 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == (*SourcePtr &amp; ~COMMON_LVB_SBCSDBCS))
01396 <span class="preprocessor">#else</span>
01397 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> == *SourcePtr)
01398 <span class="preprocessor">#endif</span>
01399 <span class="preprocessor"></span>                {
01400                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> += 1;
01401                 }
01402                 <span class="keywordflow">else</span> {
01403                     Attr++;
01404                     Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = 1;
01405 <span class="preprocessor">#ifdef WWSB_FE</span>
01406 <span class="preprocessor"></span>                    Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = *SourcePtr &amp; ~COMMON_LVB_SBCSDBCS;
01407 <span class="preprocessor">#else</span>
01408 <span class="preprocessor"></span>                    Attr-&gt;<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = *SourcePtr;
01409 <span class="preprocessor">#endif</span>
01410 <span class="preprocessor"></span>                    AttrLength += 1;
01411                 }
01412                 NumWritten++;
01413                 X++;
01414                 <span class="keywordflow">if</span> (NumWritten == *NumRecords) {
01415                     <span class="keywordflow">break</span>;
01416                 }
01417             }
01418             X--;
01419 
01420             <span class="comment">// recalculate last non-space char</span>
01421 
01422             <span class="comment">//</span>
01423             <span class="comment">// see if attr string is different.  if so, allocate a new</span>
01424             <span class="comment">// attr buffer and merge the two strings.</span>
01425             <span class="comment">//</span>
01426 
01427             <span class="keywordflow">if</span> (AttrLength != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> ||
01428                 memcmp(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,AttrBuf,AttrLength*<span class="keyword">sizeof</span>(*Attr))) {
01429                 <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
01430                 WORD NewAttrsLength;
01431 
01432                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01433                                  Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
01434                                  AttrBuf,
01435                                  AttrLength,
01436                                  &amp;NewAttrs,
01437                                  &amp;NewAttrsLength,
01438                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((Y == WriteCoord.Y) ? WriteCoord.X : 0),
01439                                  X,
01440                                  Row,
01441                                  ScreenInfo
01442                                 ))) {
01443                     <span class="keywordflow">if</span> (ScreenInfo-&gt;ScreenBufferSize.X &gt; 80) {
01444                         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AttrBuf);
01445                     }
01446                     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,WriteCoord.Y,Y);
01447                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01448                 }
01449                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
01450                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
01451                 }
01452                 <span class="keywordflow">else</span> {
01453                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
01454                 }
01455                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
01456                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
01457                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01458                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01459             }
01460 
01461             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01462                 RowIndex = 0;
01463             }
01464             <span class="keywordflow">if</span> (NumWritten &lt; *NumRecords) {
01465                 X = 0;
01466                 Y++;
01467                 <span class="keywordflow">if</span> (Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y) {
01468                     <span class="keywordflow">break</span>;
01469                 }
01470             } <span class="keywordflow">else</span> {
01471                 <span class="keywordflow">break</span>;
01472             }
01473         }
01474         <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,WriteCoord.Y,Y);
01475         <span class="keywordflow">if</span> (ScreenInfo-&gt;ScreenBufferSize.X &gt; 80) {
01476             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(AttrBuf);
01477         }
01478     } <span class="keywordflow">else</span> {
01479         *NumRecords = 0;
01480         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01481     }
01482     <span class="keywordflow">if</span> ((StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) &amp;&amp; (TransBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01483 <span class="preprocessor">#ifdef WWSB_FE</span>
01484 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fLocalHeap) {
01485             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01486             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferA);
01487         }
01488 <span class="preprocessor">#else</span>
01489 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01490 <span class="preprocessor">#endif</span>
01491 <span class="preprocessor"></span>    }
01492 <span class="preprocessor">#ifdef WWSB_FE</span>
01493 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>) || (StringType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>)) {
01494         <span class="keywordflow">if</span> (fLocalHeap) {
01495             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBuffer);
01496             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(TransBufferA);
01497         }
01498         NumWritten = NumRecordsSavedForUnicode - (*NumRecords - NumWritten);
01499     }
01500 <span class="preprocessor">#endif</span>
01501 <span class="preprocessor"></span>
01502     <span class="comment">//</span>
01503     <span class="comment">// determine write region.  if we're still on the same line we started</span>
01504     <span class="comment">// on, left X is the X we started with and right X is the one we're on</span>
01505     <span class="comment">// now.  otherwise, left X is 0 and right X is the rightmost column of</span>
01506     <span class="comment">// the screen buffer.</span>
01507     <span class="comment">//</span>
01508     <span class="comment">// then update the screen.</span>
01509     <span class="comment">//</span>
01510 
01511     WriteRegion.Top = WriteCoord.Y;
01512     WriteRegion.Bottom = Y;
01513     <span class="keywordflow">if</span> (Y != WriteCoord.Y) {
01514         WriteRegion.Left = 0;
01515         WriteRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
01516     }
01517     <span class="keywordflow">else</span> {
01518         WriteRegion.Left = WriteCoord.X;
01519         WriteRegion.Right = X;
01520     }
01521     <a class="code" href="../../d8/d2/__output_8h.html#a16">WWSB_WriteToScreen</a>(ScreenInfo,&amp;WriteRegion);
01522     <span class="keywordflow">if</span> (NumColumns) {
01523         *NumColumns = X + (WriteCoord.Y - Y) * ScreenInfo-&gt;ScreenBufferSize.X - WriteCoord.X + 1;
01524     }
01525     *NumRecords = NumWritten;
01526     <span class="keywordflow">return</span> STATUS_SUCCESS;
01527 }
01528 
01529 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01530"></a><a class="code" href="../../d8/d2/__output_8h.html#a18">01530</a> <a class="code" href="../../d8/d2/__output_8h.html#a18">WWSB_FillOutput</a>(
01531     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01532     IN WORD Element,
01533     IN COORD WriteCoord,
01534     IN ULONG ElementType,
01535     IN OUT PULONG Length <span class="comment">// this value is valid even for error cases</span>
01536     )
01537 
01538 <span class="comment">/*++</span>
01539 <span class="comment"></span>
01540 <span class="comment">Routine Description:</span>
01541 <span class="comment"></span>
01542 <span class="comment">    This routine fills the screen buffer with the specified character or</span>
01543 <span class="comment">    attribute.</span>
01544 <span class="comment"></span>
01545 <span class="comment">Arguments:</span>
01546 <span class="comment"></span>
01547 <span class="comment">    ScreenInfo - Pointer to screen buffer information.</span>
01548 <span class="comment"></span>
01549 <span class="comment">    Element - Element to write.</span>
01550 <span class="comment"></span>
01551 <span class="comment">    WriteCoord - Screen buffer coordinate to begin writing to.</span>
01552 <span class="comment"></span>
01553 <span class="comment">    ElementType</span>
01554 <span class="comment"></span>
01555 <span class="comment">        CONSOLE_ASCII         - element is an ascii character.</span>
01556 <span class="comment">        CONSOLE_REAL_UNICODE  - element is a real unicode character. These will</span>
01557 <span class="comment">                                get converted to False Unicode as required.</span>
01558 <span class="comment">        CONSOLE_FALSE_UNICODE - element is a False Unicode character.</span>
01559 <span class="comment">        CONSOLE_ATTRIBUTE     - element is an attribute.</span>
01560 <span class="comment"></span>
01561 <span class="comment">    Length - On input, the number of elements to write.  On output,</span>
01562 <span class="comment">    the number of elements written.</span>
01563 <span class="comment"></span>
01564 <span class="comment">Return Value:</span>
01565 <span class="comment"></span>
01566 <span class="comment"></span>
01567 <span class="comment">--*/</span>
01568 
01569 {
01570     ULONG NumWritten;
01571     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> X,Y,LeftX;
01572     SMALL_RECT WriteRegion;
01573     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01574     PWCHAR Char;
01575     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01576     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j;
01577 <span class="preprocessor">#ifdef WWSB_FE</span>
01578 <span class="preprocessor"></span>    PCHAR AttrP;
01579 <span class="preprocessor">#endif</span>
01580 <span class="preprocessor"></span>
01581     <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"FillOutput\n"</span>));
01582     <span class="keywordflow">if</span> (*Length == 0)
01583         <span class="keywordflow">return</span> STATUS_SUCCESS;
01584     NumWritten = 0;
01585     X=WriteCoord.X;
01586     Y=WriteCoord.Y;
01587     <span class="keywordflow">if</span> (X&gt;=ScreenInfo-&gt;ScreenBufferSize.X ||
01588         X&lt;0 ||
01589         Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y ||
01590         Y&lt;0) {
01591         *Length = 0;
01592         <span class="keywordflow">return</span> STATUS_SUCCESS;
01593     }
01594 
01595 <span class="preprocessor">#ifdef WWSB_FE</span>
01596 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
01597 <span class="preprocessor">#endif</span>
01598 <span class="preprocessor"></span>
01599     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01600     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+WriteCoord.Y) % ScreenInfo-&gt;ScreenBufferSize.Y;
01601 
01602     <span class="keywordflow">if</span> (ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) {
01603         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> Codepage;
01604         <span class="keywordflow">if</span> ((ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01605                 ((ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) == 0)) {
01606             <span class="keywordflow">if</span> (ScreenInfo-&gt;Console-&gt;OutputCP != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01607                 Codepage = <a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>;
01608             <span class="keywordflow">else</span>
01609                 Codepage = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>;
01610         } <span class="keywordflow">else</span> {
01611             Codepage = ScreenInfo-&gt;Console-&gt;OutputCP;
01612         }
01613 <span class="preprocessor">#ifdef WWSB_FE</span>
01614 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ScreenInfo-&gt;FillOutDbcsLeadChar == 0){
01615             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a37">IsDBCSLeadByteConsole</a>((<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Element,&amp;ScreenInfo-&gt;Console-&gt;OutputCPInfo)) {
01616                 ScreenInfo-&gt;FillOutDbcsLeadChar = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Element;
01617                 *Length = 0;
01618                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01619             }<span class="keywordflow">else</span>{
01620                 <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Char=(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Element;
01621                 <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01622                           &amp;Char,
01623                           1,
01624                           &amp;Element,
01625                           1);
01626             }
01627         }<span class="keywordflow">else</span>{
01628             <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Char[2];
01629             Char[0]=ScreenInfo-&gt;FillOutDbcsLeadChar;
01630             Char[1]=(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Element;
01631             ScreenInfo-&gt;FillOutDbcsLeadChar = 0;
01632             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(Codepage,
01633                       Char,
01634                       2,
01635                       &amp;Element,
01636                       2);
01637         }
01638 <span class="preprocessor">#else</span>
01639 <span class="preprocessor"></span>        Element = SB_CharToWchar(Codepage, (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Element);
01640 <span class="preprocessor">#endif</span>
01641 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a> &amp;&amp;
01642             (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
01643             !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN)) {
01644         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(&amp;Element,
01645                                 1,
01646                                 ScreenInfo-&gt;Console-&gt;OutputCP
01647                                 );
01648     }
01649 
01650     <span class="keywordflow">if</span> ((ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a9">CONSOLE_ASCII</a>) ||
01651             (ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a10">CONSOLE_REAL_UNICODE</a>) ||
01652             (ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a12">CONSOLE_FALSE_UNICODE</a>)) {
01653 <span class="preprocessor">#ifdef WWSB_FE</span>
01654 <span class="preprocessor"></span>        <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> StartPosFlag ;
01655         StartPosFlag = 0;
01656 <span class="preprocessor">#endif</span>
01657 <span class="preprocessor"></span>        <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01658 
01659             <span class="comment">//</span>
01660             <span class="comment">// copy the chars into their arrays</span>
01661             <span class="comment">//</span>
01662 
01663             LeftX = X;
01664             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01665             Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[X];
01666 <span class="preprocessor">#ifdef WWSB_FE</span>
01667 <span class="preprocessor"></span>            AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[X];
01668 <span class="preprocessor">#endif</span>
01669 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt;= (*Length - NumWritten)) {
01670 <span class="preprocessor">#ifdef WWSB_FE</span>
01671 <span class="preprocessor"></span>                {
01672                     COORD TPoint;
01673 
01674                     TPoint.X = X;
01675                     TPoint.Y = Y;
01676                     <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*Length-NumWritten),TPoint,ScreenInfo);
01677                 }
01678 <span class="preprocessor">#endif</span>
01679 <span class="preprocessor"></span><span class="preprocessor">#ifdef WWSB_FE</span>
01680 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
01681                                        ScreenInfo-&gt;Console-&gt;OutputCP,(WCHAR)Element)) {
01682                     <span class="keywordflow">for</span> (j=0;j&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*Length - NumWritten);j++) {
01683                         *Char++ = (WCHAR)Element;
01684                         *AttrP &amp;= ~ATTR_DBCSSBCS_BYTE;
01685                         <span class="keywordflow">if</span>(StartPosFlag++ &amp; 1)
01686                             *AttrP++ |= ATTR_TRAILING_BYTE;
01687                         <span class="keywordflow">else</span>
01688                             *AttrP++ |= ATTR_LEADING_BYTE;
01689                     }
01690                     <span class="keywordflow">if</span>(StartPosFlag &amp; 1){
01691                         *(Char-1) = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01692                         *(AttrP-1) &amp;= ~ATTR_DBCSSBCS_BYTE;
01693                     }
01694                 }
01695                 <span class="keywordflow">else</span> {
01696 <span class="preprocessor">#endif</span>
01697 <span class="preprocessor"></span>                    <span class="keywordflow">for</span> (j=0;j&lt;(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*Length - NumWritten);j++) {
01698                         *Char++ = (WCHAR)Element;
01699 <span class="preprocessor">#ifdef WWSB_FE</span>
01700 <span class="preprocessor"></span>                        *AttrP++ &amp;= ~ATTR_DBCSSBCS_BYTE;
01701 <span class="preprocessor">#endif</span>
01702 <span class="preprocessor"></span>                    }
01703 <span class="preprocessor">#ifdef WWSB_FE</span>
01704 <span class="preprocessor"></span>                }
01705 <span class="preprocessor">#endif</span>
01706 <span class="preprocessor"></span>                X=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(X+*Length - NumWritten - 1);
01707                 NumWritten = *Length;
01708             }
01709             <span class="keywordflow">else</span> {
01710 <span class="preprocessor">#ifdef WWSB_FE</span>
01711 <span class="preprocessor"></span>                {
01712                     COORD TPoint;
01713 
01714                     TPoint.X = X;
01715                     TPoint.Y = Y;
01716                     <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-X),TPoint,ScreenInfo);
01717                 }
01718 <span class="preprocessor">#endif</span>
01719 <span class="preprocessor"></span><span class="preprocessor">#ifdef WWSB_FE</span>
01720 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
01721                                        ScreenInfo-&gt;Console-&gt;OutputCP,(WCHAR)Element)) {
01722                     <span class="keywordflow">for</span> (j=0;j&lt;ScreenInfo-&gt;ScreenBufferSize.X - X;j++) {
01723                         *Char++ = (WCHAR)Element;
01724                         *AttrP &amp;= ~ATTR_DBCSSBCS_BYTE;
01725                         <span class="keywordflow">if</span>(StartPosFlag++ &amp; 1)
01726                             *AttrP++ |= ATTR_TRAILING_BYTE;
01727                         <span class="keywordflow">else</span>
01728                             *AttrP++ |= ATTR_LEADING_BYTE;
01729                     }
01730                 }
01731                 <span class="keywordflow">else</span> {
01732 <span class="preprocessor">#endif</span>
01733 <span class="preprocessor"></span>                    <span class="keywordflow">for</span> (j=0;j&lt;ScreenInfo-&gt;ScreenBufferSize.X - X;j++) {
01734                         *Char++ = (WCHAR)Element;
01735 <span class="preprocessor">#ifdef WWSB_FE</span>
01736 <span class="preprocessor"></span>                        *AttrP++ &amp;= ~ATTR_DBCSSBCS_BYTE;
01737 <span class="preprocessor">#endif</span>
01738 <span class="preprocessor"></span>                    }
01739 <span class="preprocessor">#ifdef WWSB_FE</span>
01740 <span class="preprocessor"></span>                }
01741 <span class="preprocessor">#endif</span>
01742 <span class="preprocessor"></span>                NumWritten += ScreenInfo-&gt;ScreenBufferSize.X - X;
01743                 X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
01744             }
01745 
01746             <span class="comment">// recalculate first and last non-space char</span>
01747 
01748             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
01749             <span class="keywordflow">if</span> (LeftX &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
01750                 <span class="keywordflow">if</span> (Element == <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>) {
01751                     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = X+1;
01752                 } <span class="keywordflow">else</span> {
01753                     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = LeftX;
01754                 }
01755             }
01756             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
01757             <span class="keywordflow">if</span> ((X+1) &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
01758                 <span class="keywordflow">if</span> (Element == <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>) {
01759                     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = LeftX;
01760                 } <span class="keywordflow">else</span> {
01761                     Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = X+1;
01762                 }
01763             }
01764             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01765                 RowIndex = 0;
01766             }
01767             <span class="keywordflow">if</span> (NumWritten &lt; *Length) {
01768                 X = 0;
01769                 Y++;
01770                 <span class="keywordflow">if</span> (Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y) {
01771                     <span class="keywordflow">break</span>;
01772                 }
01773             } <span class="keywordflow">else</span> {
01774                 <span class="keywordflow">break</span>;
01775             }
01776         }
01777     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ElementType == <a class="code" href="../../d5/d5/conmsg_8h.html#a11">CONSOLE_ATTRIBUTE</a>) {
01778         <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attr;
01779 
01780 <span class="preprocessor">#ifdef WWSB_FE</span>
01781 <span class="preprocessor"></span>        COORD TPoint;
01782         TPoint.X = X;
01783         TPoint.Y = Y;
01784 
01785         <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt;= (*Length - NumWritten)) {
01786             <a class="code" href="../../d0/d3/dbcs_8h.html#a33">BisectWriteAttr</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(*Length-NumWritten),TPoint,ScreenInfo);
01787         }
01788         <span class="keywordflow">else</span>{
01789             <a class="code" href="../../d0/d3/dbcs_8h.html#a33">BisectWriteAttr</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-X),TPoint,ScreenInfo);
01790         }
01791 <span class="preprocessor">#endif</span>
01792 <span class="preprocessor"></span>
01793         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01794 
01795             <span class="comment">//</span>
01796             <span class="comment">// copy the attrs into the screen buffer arrays</span>
01797             <span class="comment">//</span>
01798 
01799             Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01800             <span class="keywordflow">if</span> ((ULONG)(ScreenInfo-&gt;ScreenBufferSize.X - X) &gt;= (*Length - NumWritten)) {
01801                 X=(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(X+*Length - NumWritten - 1);
01802                 NumWritten = *Length;
01803             }
01804             <span class="keywordflow">else</span> {
01805                 NumWritten += ScreenInfo-&gt;ScreenBufferSize.X - X;
01806                 X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
01807             }
01808 
01809             <span class="comment">// recalculate last non-space char</span>
01810 
01811             <span class="comment">//</span>
01812             <span class="comment">//  merge the two attribute strings.</span>
01813             <span class="comment">//</span>
01814 
01815             Attr.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((Y == WriteCoord.Y) ? (X-WriteCoord.X+1) : (X+1));
01816 <span class="preprocessor">#ifdef WWSB_FE</span>
01817 <span class="preprocessor"></span>            Attr.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = Element &amp; ~COMMON_LVB_SBCSDBCS;
01818 <span class="preprocessor">#else</span>
01819 <span class="preprocessor"></span>            Attr.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = Element;
01820 <span class="preprocessor">#endif</span>
01821 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (1 != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> ||
01822                 memcmp(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,&amp;Attr,<span class="keyword">sizeof</span>(Attr))) {
01823                 <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
01824                 WORD NewAttrsLength;
01825 
01826                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
01827                                  Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
01828                                  &amp;Attr,
01829                                  1,
01830                                  &amp;NewAttrs,
01831                                  &amp;NewAttrsLength,
01832                                  (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(X-Attr.Length+1),
01833                                  X,
01834                                  Row,
01835                                  ScreenInfo
01836                                 ))) {
01837                     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,WriteCoord.Y,Y);
01838                     <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01839                 }
01840                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
01841                     <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
01842                 }
01843                 <span class="keywordflow">else</span> {
01844                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
01845                 }
01846                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
01847                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
01848                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01849                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
01850             }
01851 
01852             <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
01853                 RowIndex = 0;
01854             }
01855             <span class="keywordflow">if</span> (NumWritten &lt; *Length) {
01856                 X = 0;
01857                 Y++;
01858                 <span class="keywordflow">if</span> (Y&gt;=ScreenInfo-&gt;ScreenBufferSize.Y) {
01859                     <span class="keywordflow">break</span>;
01860                 }
01861             } <span class="keywordflow">else</span> {
01862                 <span class="keywordflow">break</span>;
01863             }
01864         }
01865         <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,WriteCoord.Y,Y);
01866     } <span class="keywordflow">else</span> {
01867         *Length = 0;
01868         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01869     }
01870 
01871     <span class="comment">//</span>
01872     <span class="comment">// determine write region.  if we're still on the same line we started</span>
01873     <span class="comment">// on, left X is the X we started with and right X is the one we're on</span>
01874     <span class="comment">// now.  otherwise, left X is 0 and right X is the rightmost column of</span>
01875     <span class="comment">// the screen buffer.</span>
01876     <span class="comment">//</span>
01877     <span class="comment">// then update the screen.</span>
01878     <span class="comment">//</span>
01879 
01880 <span class="preprocessor">#ifdef WWSB_FE</span>
01881 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ScreenInfo-&gt;ConvScreenInfo) {
01882         WriteRegion.Top = WriteCoord.Y + ScreenInfo-&gt;Window.Left + ScreenInfo-&gt;ConvScreenInfo-&gt;CaInfo.coordConView.Y;
01883         WriteRegion.Bottom = Y + ScreenInfo-&gt;Window.Left + ScreenInfo-&gt;ConvScreenInfo-&gt;CaInfo.coordConView.Y;
01884         <span class="keywordflow">if</span> (Y != WriteCoord.Y) {
01885             WriteRegion.Left = 0;
01886             WriteRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer-&gt;ScreenBufferSize.X-1);
01887         }
01888         <span class="keywordflow">else</span> {
01889             WriteRegion.Left = WriteCoord.X + ScreenInfo-&gt;Window.Top + ScreenInfo-&gt;ConvScreenInfo-&gt;CaInfo.coordConView.X;
01890             WriteRegion.Right = X + ScreenInfo-&gt;Window.Top + ScreenInfo-&gt;ConvScreenInfo-&gt;CaInfo.coordConView.X;
01891         }
01892         WriteConvRegionToScreen(ScreenInfo-&gt;Console-&gt;CurrentScreenBuffer,
01893                                 ScreenInfo-&gt;ConvScreenInfo,
01894                                 &amp;WriteRegion
01895                                );
01896         ScreenInfo-&gt;BisectFlag &amp;= ~(BISECT_LEFT | BISECT_RIGHT | BISECT_TOP | BISECT_BOTTOM);
01897         *Length = NumWritten;
01898         <span class="keywordflow">return</span> STATUS_SUCCESS;
01899     }
01900 <span class="preprocessor">#endif</span>
01901 <span class="preprocessor"></span>
01902     WriteRegion.Top = WriteCoord.Y;
01903     WriteRegion.Bottom = Y;
01904     <span class="keywordflow">if</span> (Y != WriteCoord.Y) {
01905         WriteRegion.Left = 0;
01906         WriteRegion.Right = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;ScreenBufferSize.X-1);
01907     }
01908     <span class="keywordflow">else</span> {
01909         WriteRegion.Left = WriteCoord.X;
01910         WriteRegion.Right = X;
01911     }
01912     <a class="code" href="../../d8/d2/__output_8h.html#a16">WWSB_WriteToScreen</a>(ScreenInfo,&amp;WriteRegion);
01913     *Length = NumWritten;
01914     <span class="keywordflow">return</span> STATUS_SUCCESS;
01915 }
01916 
01917 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01918"></a><a class="code" href="../../d8/d2/__output_8h.html#a19">01918</a> <a class="code" href="../../d8/d2/__output_8h.html#a19">WWSB_FillRectangle</a>(
01919     IN CHAR_INFO Fill,
01920     IN OUT <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01921     IN PSMALL_RECT TargetRect
01922     )
01923 
01924 <span class="comment">/*++</span>
01925 <span class="comment"></span>
01926 <span class="comment">Routine Description:</span>
01927 <span class="comment"></span>
01928 <span class="comment">    This routine fills a rectangular region in the screen</span>
01929 <span class="comment">    buffer.  no clipping is done.</span>
01930 <span class="comment"></span>
01931 <span class="comment">Arguments:</span>
01932 <span class="comment"></span>
01933 <span class="comment">    Fill - element to copy to each element in target rect</span>
01934 <span class="comment"></span>
01935 <span class="comment">    ScreenInfo - pointer to screen info</span>
01936 <span class="comment"></span>
01937 <span class="comment">    TargetRect - rectangle in screen buffer to fill</span>
01938 <span class="comment"></span>
01939 <span class="comment">Return Value:</span>
01940 <span class="comment"></span>
01941 <span class="comment">--*/</span>
01942 
01943 {
01944     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,j;
01945     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> XSize;
01946     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
01947     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
01948     PWCHAR Char;
01949     <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">ATTR_PAIR</a> Attr;
01950 <span class="preprocessor">#ifdef WWSB_FE</span>
01951 <span class="preprocessor"></span>    PCHAR AttrP;
01952     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Width;
01953 <span class="preprocessor">#endif</span>
01954 <span class="preprocessor"></span>    <a class="code" href="../../d8/d5/consrv_8h.html#a3">DBGOUTPUT</a>((<span class="stringliteral">"FillRectangle\n"</span>));
01955 <span class="preprocessor">#ifdef WWFE_SB</span>
01956 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
01957 <span class="preprocessor">#endif</span>
01958 <span class="preprocessor"></span>
01959     XSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Right - TargetRect-&gt;Left + 1);
01960 
01961     ScreenInfo-&gt;BufferInfo.TextInfo.Flags |= <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>;
01962     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+TargetRect-&gt;Top) % ScreenInfo-&gt;ScreenBufferSize.Y;
01963     <span class="keywordflow">for</span> (i=TargetRect-&gt;Top;i&lt;=TargetRect-&gt;Bottom;i++) {
01964 
01965         <span class="comment">//</span>
01966         <span class="comment">// copy the chars and attrs into their respective arrays</span>
01967         <span class="comment">//</span>
01968 
01969 <span class="preprocessor">#ifdef WWSB_FE</span>
01970 <span class="preprocessor"></span>        {
01971             COORD TPoint;
01972 
01973             TPoint.X = TargetRect-&gt;Left;
01974             TPoint.Y = i;
01975             <a class="code" href="../../d0/d3/dbcs_8h.html#a31">BisectWrite</a>(XSize,TPoint,ScreenInfo);
01976             Width = IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,
01977                                        ScreenInfo-&gt;Console-&gt;OutputCP,Fill.Char.UnicodeChar);
01978         }
01979 <span class="preprocessor">#endif</span>
01980 <span class="preprocessor"></span>
01981         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
01982         Char = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o4">Chars</a>[TargetRect-&gt;Left];
01983 <span class="preprocessor">#ifdef WWSB_FE</span>
01984 <span class="preprocessor"></span>        AttrP = &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[TargetRect-&gt;Left];
01985 <span class="preprocessor">#endif</span>
01986 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (j=0;j&lt;XSize;j++) {
01987 <span class="preprocessor">#ifdef WWSB_FE</span>
01988 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Width){
01989                 <span class="keywordflow">if</span> (j &lt; XSize-1){
01990                     *Char++ = Fill.Char.UnicodeChar;
01991                     *Char++ = Fill.Char.UnicodeChar;
01992                     *AttrP++ = ATTR_LEADING_BYTE;
01993                     *AttrP++ = ATTR_TRAILING_BYTE;
01994                     j++;
01995                 }
01996                 <span class="keywordflow">else</span>{
01997                     *Char++ = <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>;
01998                     *AttrP++ = 0 ;
01999                 }
02000             }
02001             <span class="keywordflow">else</span>{
02002 <span class="preprocessor">#endif</span>
02003 <span class="preprocessor"></span>                *Char++ = Fill.Char.UnicodeChar;
02004 <span class="preprocessor">#ifdef WWSB_FE</span>
02005 <span class="preprocessor"></span>                *AttrP++ = 0 ;
02006             }
02007 <span class="preprocessor">#endif</span>
02008 <span class="preprocessor"></span>        }
02009 
02010         <span class="comment">// recalculate first and last non-space char</span>
02011 
02012         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>;
02013         <span class="keywordflow">if</span> (TargetRect-&gt;Left &lt; Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>) {
02014             <span class="keywordflow">if</span> (Fill.Char.UnicodeChar == <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>) {
02015                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Right+1);
02016             }
02017             <span class="keywordflow">else</span> {
02018                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Left);
02019             }
02020         }
02021 
02022         Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>;
02023         <span class="keywordflow">if</span> (TargetRect-&gt;Right &gt;= Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>) {
02024             <span class="keywordflow">if</span> (Fill.Char.UnicodeChar == <a class="code" href="../../d9/d5/verifier_8c.html#a6">UNICODE_SPACE</a>) {
02025                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Left);
02026             }
02027             <span class="keywordflow">else</span> {
02028                 Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TargetRect-&gt;Right+1);
02029             }
02030         }
02031 
02032         Attr.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o0">Length</a> = XSize;
02033         Attr.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a> = Fill.Attributes;
02034 
02035         <span class="comment">//</span>
02036         <span class="comment">//  merge the two attribute strings.</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="keywordflow">if</span> (1 != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> ||
02040             memcmp(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,&amp;Attr,<span class="keyword">sizeof</span>(Attr))) {
02041             <a class="code" href="../../d3/d2/struct__ATTR__PAIR.html">PATTR_PAIR</a> NewAttrs;
02042             WORD NewAttrsLength;
02043 
02044             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d6/d2/output_8c.html#a48">MergeAttrStrings</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>,
02045                              Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a>,
02046                              &amp;Attr,
02047                              1,
02048                              &amp;NewAttrs,
02049                              &amp;NewAttrsLength,
02050                              TargetRect-&gt;Left,
02051                              TargetRect-&gt;Right,
02052                              Row,
02053                              ScreenInfo
02054                             ))) {
02055                 <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetRect-&gt;Top,TargetRect-&gt;Bottom);
02056                 <span class="keywordflow">return</span>;
02057             }
02058             <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> &gt; 1) {
02059                 <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a>);
02060             }
02061             <span class="keywordflow">else</span> {
02062                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> == &amp;Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>);
02063             }
02064             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o2">Attrs</a> = NewAttrs;
02065             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> = NewAttrsLength;
02066             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02067             Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> = <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>;
02068         }
02069         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
02070             RowIndex = 0;
02071         }
02072     }
02073     <a class="code" href="../../d6/d2/output_8c.html#a49">ResetTextFlags</a>(ScreenInfo,TargetRect-&gt;Top,TargetRect-&gt;Bottom);
02074 }
02075 
02076 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02077"></a><a class="code" href="../../d8/d2/__output_8h.html#a20">02077</a> <a class="code" href="../../d8/d2/__output_8h.html#a20">WWSB_PolyTextOutCandidate</a>(
02078     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02079     IN PSMALL_RECT Region
02080     )
02081 
02082 <span class="comment">/*</span>
02083 <span class="comment"></span>
02084 <span class="comment">    This function returns TRUE if the input region is reasonable to</span>
02085 <span class="comment">    pass to ConsolePolyTextOut.  The criteria are that there is only</span>
02086 <span class="comment">    one attribute per line.</span>
02087 <span class="comment"></span>
02088 <span class="comment">*/</span>
02089 
02090 {
02091     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RowIndex;
02092     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a> Row;
02093     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i;
02094 
02095 <span class="preprocessor">#ifdef WWSB_FE</span>
02096 <span class="preprocessor"></span>    <span class="keywordflow">if</span>((ScreenInfo-&gt;Console-&gt;Flags &amp; <a class="code" href="../../d1/d7/server_8h.html#a9">CONSOLE_VDM_REGISTERED</a> &amp;&amp;
02097         ((<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)(ScreenInfo-&gt;Console-&gt;EudcInformation))-&gt;LocalVDMEudcMode)){
02098         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02099     }
02100     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) &amp;&amp;
02101         !(ScreenInfo-&gt;Console-&gt;FullScreenFlags &amp; CONSOLE_FULLSCREEN) &amp;&amp;
02102         ((<a class="code" href="../../d2/d7/struct__EUDC__INFORMATION.html">PEUDC_INFORMATION</a>)(ScreenInfo-&gt;Console-&gt;EudcInformation))-&gt;LocalKeisenEudcMode
02103        ) {
02104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02105     }
02106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>);
02107     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp; CONSOLE_CONVERSION_AREA_REDRAW) {
02108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02109     }
02110 <span class="preprocessor">#endif</span>
02111 <span class="preprocessor"></span>
02112     <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a4">SINGLE_ATTRIBUTES_PER_LINE</a>) {
02113         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02114     }
02115 
02116     <span class="comment">//</span>
02117     <span class="comment">// make sure there is only one attr per line.</span>
02118     <span class="comment">//</span>
02119 
02120     RowIndex = (ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+Region-&gt;Top) % ScreenInfo-&gt;ScreenBufferSize.Y;
02121     <span class="keywordflow">for</span> (i=Region-&gt;Top;i&lt;=Region-&gt;Bottom;i++) {
02122         Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[RowIndex];
02123         <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o0">Length</a> != 1) {
02124             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02125         }
02126         <span class="keywordflow">if</span> (++RowIndex == ScreenInfo-&gt;ScreenBufferSize.Y) {
02127             RowIndex = 0;
02128         }
02129     }
02130     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02131 }
02132 
02133 
<a name="l02134"></a><a class="code" href="../../d8/d2/__output_8h.html#a11">02134</a> <span class="preprocessor">#define MAX_POLY_LINES 80</span>
<a name="l02135"></a><a class="code" href="../../d8/d2/__output_8h.html#a12">02135</a> <span class="preprocessor"></span><span class="preprocessor">#define VERY_BIG_NUMBER 0x0FFFFFFF</span>
02136 <span class="preprocessor"></span>
02137 <span class="preprocessor">#ifdef WWSB_FE</span>
02138 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_KEISEN_INFORMATION {
02139     COORD Coord;
02140     WORD <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
02141 } KEISEN_INFORMATION, *PKEISEN_INFORMATION;
02142 <span class="preprocessor">#endif</span>
02143 <span class="preprocessor"></span>
02144 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02145"></a><a class="code" href="../../d8/d2/__output_8h.html#a21">02145</a> <a class="code" href="../../d8/d2/__output_8h.html#a21">WWSB_ConsolePolyTextOut</a>(
02146     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
02147     IN PSMALL_RECT Region
02148     )
02149 
02150 <span class="comment">/*</span>
02151 <span class="comment"></span>
02152 <span class="comment">    This function calls PolyTextOut.  The only restriction is that</span>
02153 <span class="comment">    there can't be more than one attribute per line in the region.</span>
02154 <span class="comment"></span>
02155 <span class="comment">*/</span>
02156 
02157 {
02158     <a class="code" href="../../d9/d4/struct__ROW.html">PROW</a>  Row,LastRow;
02159     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> i,k;
02160     WORD Attr;
02161     POLYTEXTW TextInfo[<a class="code" href="../../d8/d2/__output_8h.html#a11">MAX_POLY_LINES</a>];
02162     RECT  TextRect;
02163     RECTL BoundingRect;
02164     <span class="keywordtype">int</span>   xSize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X;
02165     <span class="keywordtype">int</span>   ySize = <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y;
02166     ULONG Flags = ScreenInfo-&gt;BufferInfo.TextInfo.Flags;
02167     <span class="keywordtype">int</span>   WindowLeft = ScreenInfo-&gt;Window.Left;
02168     <span class="keywordtype">int</span>   RegionLeft = Region-&gt;Left;
02169     <span class="keywordtype">int</span>   RegionRight = Region-&gt;Right + 1;
02170     <span class="keywordtype">int</span>   DefaultLeft  = (RegionLeft - WindowLeft) * xSize;
02171     <span class="keywordtype">int</span>   DefaultRight = (RegionRight - WindowLeft) * xSize;
02172     <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console = ScreenInfo-&gt;Console;
02173     PWCHAR TransPolyTextOut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
02174 <span class="preprocessor">#ifdef WWSB_FE</span>
02175 <span class="preprocessor"></span>    KEISEN_INFORMATION KeisenInfo[<a class="code" href="../../d8/d2/__output_8h.html#a11">MAX_POLY_LINES</a>];
02176     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> j;
02177     WORD OldAttr;
02178 <span class="preprocessor">#endif</span>
02179 <span class="preprocessor"></span>
02180     <span class="comment">//</span>
02181     <span class="comment">// initialize the text rect and window position.</span>
02182     <span class="comment">//</span>
02183 
02184     TextRect.top = (Region-&gt;Top - ScreenInfo-&gt;Window.Top) * ySize;
02185     <span class="comment">// TextRect.bottom is invalid.</span>
02186     BoundingRect.top = TextRect.top;
02187     BoundingRect.left = <a class="code" href="../../d8/d2/__output_8h.html#a12">VERY_BIG_NUMBER</a>;
02188     BoundingRect.right = 0;
02189 
02190     <span class="comment">//</span>
02191     <span class="comment">// copy the chars and attrs from their respective arrays</span>
02192     <span class="comment">//</span>
02193 
02194     Row = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows
02195            [ScreenInfo-&gt;BufferInfo.TextInfo.FirstRow+Region-&gt;Top];
02196     LastRow = &amp;ScreenInfo-&gt;BufferInfo.TextInfo.Rows[ScreenInfo-&gt;ScreenBufferSize.Y];
02197     <span class="keywordflow">if</span> (Row &gt;= LastRow)
02198         Row -= ScreenInfo-&gt;ScreenBufferSize.Y;
02199 
02200     Attr = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
02201     <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> != Attr) {
02202 <span class="preprocessor">#ifdef WWSB_FE</span>
02203 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (Attr &amp; COMMON_LVB_REVERSE_VIDEO)
02204         {
02205             SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr)));
02206             SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr &gt;&gt; 4)));
02207         }
02208         <span class="keywordflow">else</span>{
02209 <span class="preprocessor">#endif</span>
02210 <span class="preprocessor"></span>            SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr)));
02211             SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr &gt;&gt; 4)));
02212 <span class="preprocessor">#ifdef WWSB_FE</span>
02213 <span class="preprocessor"></span>        }
02214 <span class="preprocessor">#endif</span>
02215 <span class="preprocessor"></span>        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> = Attr;
02216     }
02217 
02218     <span class="comment">/*</span>
02219 <span class="comment">     * Temporarly use the process heap to isolate the heap trash problem</span>
02220 <span class="comment">     * TransPolyTextOut = (PWCHAR)ConsoleHeapAlloc(</span>
02221 <span class="comment">     *                                    MAKE_TAG( TMP_DBCS_TAG ),</span>
02222 <span class="comment">     *                                    ScreenInfo-&gt;ScreenBufferSize.X*MAX_POLY_LINES*sizeof(WCHAR));</span>
02223 <span class="comment">     */</span>
02224     TransPolyTextOut = (PWCHAR)LocalAlloc(LPTR, ScreenInfo-&gt;ScreenBufferSize.X*<a class="code" href="../../d8/d2/__output_8h.html#a11">MAX_POLY_LINES</a>*<span class="keyword">sizeof</span>(WCHAR));
02225     <span class="keywordflow">if</span> (TransPolyTextOut == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02226     {
02227         KdPrint((<span class="stringliteral">"CONSRV: ConsoleTextOut cannot allocate memory\n"</span>));
02228         <span class="keywordflow">return</span> ;
02229     }
02230 
02231     <span class="keywordflow">for</span> (i=Region-&gt;Top;i&lt;=Region-&gt;Bottom;) {
02232         PWCHAR TmpChar;
02233         TmpChar = TransPolyTextOut;
02234         <span class="keywordflow">for</span>(k=0;i&lt;=Region-&gt;Bottom&amp;&amp;k&lt;<a class="code" href="../../d8/d2/__output_8h.html#a11">MAX_POLY_LINES</a>;i++) {
02235             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> NumberOfChars;
02236             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> LeftChar,RightChar;
02237 
02238             <span class="comment">//</span>
02239             <span class="comment">// make the bounding rect smaller, if we can.  the TEXT_VALID_HINT</span>
02240             <span class="comment">// flag gets set each time we write to the screen buffer.  it gets</span>
02241             <span class="comment">// turned off any time we get asked to redraw the screen</span>
02242             <span class="comment">// and we don't know exactly what needs to be redrawn</span>
02243             <span class="comment">// (i.e. paint messages).</span>
02244             <span class="comment">//</span>
02245             <span class="comment">// we have the left and right bounds of the text on the</span>
02246             <span class="comment">// line.  the opaqueing rectangle and the number of</span>
02247             <span class="comment">// chars get set according to those values.</span>
02248             <span class="comment">//</span>
02249 
02250             TextRect.left  = DefaultLeft;
02251             TextRect.right = DefaultRight;
02252 
02253             <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a3">TEXT_VALID_HINT</a>)
02254             {
02255             <span class="comment">// We compute an opaquing interval.  If A is the old interval of text,</span>
02256             <span class="comment">// B is the new interval, and R is the Region, then the opaquing interval</span>
02257             <span class="comment">// must be R*(A+B), where * represents intersection and + represents union.</span>
02258 
02259                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a> != <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>)
02260                 {
02261                 <span class="comment">// The min determines the left of (A+B).  The max intersects that with</span>
02262                 <span class="comment">// the left of the region.</span>
02263 
02264                     TextRect.left = (
02265                                       <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>
02266                                       (
02267                                         <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>
02268                                         (
02269                                           Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,
02270                                           Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o3">OldLeft</a>
02271                                         ),
02272                                         RegionLeft
02273                                       )
02274                                       -WindowLeft
02275                                     ) * xSize;
02276                 }
02277 
02278                 <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a> != <a class="code" href="../../d7/d2/output_8h.html#a5">INVALID_OLD_LENGTH</a>)
02279                 {
02280                 <span class="comment">// The max determines the right of (A+B).  The min intersects that with</span>
02281                 <span class="comment">// the right of the region.</span>
02282 
02283                     TextRect.right = (
02284                                        <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>
02285                                        (
02286                                          <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>
02287                                          (
02288                                            Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,
02289                                            Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o1">OldRight</a>
02290                                          ),
02291                                          RegionRight
02292                                        )
02293                                        -WindowLeft
02294                                      ) * xSize;
02295                 }
02296             }
02297 
02298             <span class="comment">//</span>
02299             <span class="comment">// We've got to draw any new text that appears in the region, so we just</span>
02300             <span class="comment">// intersect the new text interval with the region.</span>
02301             <span class="comment">//</span>
02302 
02303             LeftChar = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o2">Left</a>,RegionLeft);
02304             RightChar = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.<a class="code" href="../../d6/d9/struct__CHAR__ROW.html#o0">Right</a>,RegionRight);
02305             NumberOfChars = RightChar - LeftChar;
02306 <span class="preprocessor">#ifdef WWSB_FE</span>
02307 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o0">CharRow</a>.KAttrs[RightChar-1] &amp; ATTR_LEADING_BYTE){
02308                 <span class="keywordflow">if</span>(TextRect.right &lt;= ScreenInfo-&gt;Window.Right*xSize) {
02309                     TextRect.right += xSize;
02310                 }
02311             }
02312 <span class="preprocessor">#endif</span>
02313 <span class="preprocessor"></span>
02314             <span class="comment">//</span>
02315             <span class="comment">// Empty rows are represented by CharRow.Right=0, CharRow.Left=MAX, so we</span>
02316             <span class="comment">// may have NumberOfChars&lt;0 at this point if there is no text that needs</span>
02317             <span class="comment">// drawing.  (I.e. the intersection was empty.)</span>
02318             <span class="comment">//</span>
02319 
02320             <span class="keywordflow">if</span> (NumberOfChars &lt; 0) {
02321                 NumberOfChars = 0;
02322                 LeftChar = 0;
02323                 RightChar = 0;
02324             }
02325 
02326             <span class="comment">//</span>
02327             <span class="comment">// We may also have TextRect.right&lt;TextRect.left if the screen</span>
02328             <span class="comment">// is already cleared, and we really don't need to do anything at all.</span>
02329             <span class="comment">//</span>
02330 
02331             <span class="keywordflow">if</span> (TextRect.right &gt; TextRect.left)
02332             {
02333                 NumberOfChars = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d0/d3/dbcs_8h.html#a36">RemoveDbcsMarkAll</a>(ScreenInfo,Row,&amp;LeftChar,&amp;TextRect,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,TmpChar,NumberOfChars);
02334                 TextInfo[k].x = (LeftChar-WindowLeft) * xSize;
02335                 TextInfo[k].y = TextRect.top;
02336                 TextRect.bottom =  TextRect.top + ySize;
02337                 TextInfo[k].n = NumberOfChars;
02338                 TextInfo[k].lpstr = TmpChar;
02339 <span class="preprocessor">#ifdef WWSB_FE</span>
02340 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (CheckBisectStringW(ScreenInfo,
02341                                        Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o62">OutputCP</a>,
02342                                        TmpChar,
02343                                        NumberOfChars,
02344                                        (TextRect.right-<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(TextRect.left,TextInfo[k].x))/xSize
02345                                       )
02346                    ) {
02347                     TextRect.right += xSize;
02348                 }
02349 <span class="preprocessor">#endif</span>
02350 <span class="preprocessor"></span>                TmpChar += NumberOfChars;
02351                 TextInfo[k].rcl = TextRect;
02352                 TextInfo[k].pdx = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02353                 TextInfo[k].uiFlags = ETO_OPAQUE;
02354 <span class="preprocessor">#ifdef WWSB_FE</span>
02355 <span class="preprocessor"></span>                KeisenInfo[k].n = DefaultRight-DefaultLeft ;
02356                 KeisenInfo[k].Coord.Y = (WORD)TextRect.top;
02357                 KeisenInfo[k].Coord.X = (WORD)DefaultLeft;
02358 <span class="preprocessor">#endif</span>
02359 <span class="preprocessor"></span>                k++;
02360 
02361                 <span class="keywordflow">if</span> (BoundingRect.left &gt; TextRect.left) {
02362                     BoundingRect.left = TextRect.left;
02363                 }
02364                 <span class="keywordflow">if</span> (BoundingRect.right &lt; TextRect.right) {
02365                     BoundingRect.right = TextRect.right;
02366                 }
02367             }
02368 
02369             <span class="comment">// Advance the high res bounds.</span>
02370 
02371             TextRect.top += ySize;
02372 
02373             <span class="comment">// Advance the row pointer.</span>
02374 
02375             <span class="keywordflow">if</span> (++Row &gt;= LastRow)
02376                 Row = ScreenInfo-&gt;BufferInfo.TextInfo.Rows;
02377 
02378             <span class="comment">// Draw now if the attributes are about to change.</span>
02379 
02380 <span class="preprocessor">#ifdef WWSB_FE</span>
02381 <span class="preprocessor"></span>            OldAttr = Attr ;
02382 <span class="preprocessor">#endif</span>
02383 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Attr != Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>) {
02384                 Attr = Row-&gt;<a class="code" href="../../d9/d4/struct__ROW.html#o1">AttrRow</a>.<a class="code" href="../../d4/d2/struct__ATTR__ROW.html#o1">AttrPair</a>.<a class="code" href="../../d3/d2/struct__ATTR__PAIR.html#o1">Attr</a>;
02385                 i++;
02386                 <span class="keywordflow">break</span>;
02387             }
02388         }
02389 
02390         <span class="keywordflow">if</span> (k)
02391         {
02392             BoundingRect.bottom = TextRect.top;
02393             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BoundingRect.left != <a class="code" href="../../d8/d2/__output_8h.html#a12">VERY_BIG_NUMBER</a>);
02394             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BoundingRect.left &lt;= BoundingRect.right);
02395             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(BoundingRect.top &lt;= BoundingRect.bottom);
02396             GdiConsoleTextOut(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>,
02397                               TextInfo,
02398                               k,
02399                               &amp;BoundingRect);
02400 <span class="preprocessor">#ifdef WWSB_FE</span>
02401 <span class="preprocessor"></span>            <span class="keywordflow">for</span> ( j = 0 ; j &lt; k ; j++){
02402                 RECT TextRect;
02403 
02404                 TextRect.left   = KeisenInfo[j].Coord.X;
02405                 TextRect.top    = KeisenInfo[j].Coord.Y;
02406                 TextRect.right  = KeisenInfo[j].n + TextRect.left;
02407                 TextRect.bottom = KeisenInfo[j].Coord.Y + ySize;
02408                 <a class="code" href="../../d0/d3/dbcs_8h.html#a42">TextOutCommonLVB</a>(ScreenInfo-&gt;Console, OldAttr, TextRect);
02409             }
02410 <span class="preprocessor">#endif</span>
02411 <span class="preprocessor"></span>        }
02412         <span class="keywordflow">if</span> (Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> != Attr) {
02413 <span class="preprocessor">#ifdef WWSB_FE</span>
02414 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Attr &amp; COMMON_LVB_REVERSE_VIDEO)
02415             {
02416                 SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr)));
02417                 SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr &gt;&gt; 4)));
02418             }
02419             <span class="keywordflow">else</span>{
02420 <span class="preprocessor">#endif</span>
02421 <span class="preprocessor"></span>                SetTextColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr)));
02422                 SetBkColor(Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o10">hDC</a>, <a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(Attr &gt;&gt; 4)));
02423 <span class="preprocessor">#ifdef WWSB_FE</span>
02424 <span class="preprocessor"></span>            }
02425 <span class="preprocessor">#endif</span>
02426 <span class="preprocessor"></span>            Console-&gt;<a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html#o33">LastAttributes</a> = Attr;
02427             BoundingRect.top = TextRect.top;
02428             BoundingRect.left = <a class="code" href="../../d8/d2/__output_8h.html#a12">VERY_BIG_NUMBER</a>;
02429             BoundingRect.right = 0;
02430         }
02431     }
02432     GdiFlush();
02433     <span class="comment">/*</span>
02434 <span class="comment">     * ConsoleHeapFree(TransPolyTextOut);</span>
02435 <span class="comment">     */</span>
02436     LocalFree(TransPolyTextOut);
02437 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:12 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
