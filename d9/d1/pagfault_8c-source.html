<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pagfault.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pagfault.c</h1><a href="../../d8/d2/pagfault_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   pagfault.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the pager for memory management.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Lou Perazzoli (loup) 10-Apr-1989</span>
00016 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
00024 <span class="preprocessor">#if defined ( _WIN64)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#if DBGXX</span>
00026 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00027 MiCheckPageTableInPage(
00028     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn,
00029     IN <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> Support
00030 );
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a0">00034</a> <span class="preprocessor">#define STATUS_ISSUE_PAGING_IO (0xC0033333)</span>
<a name="l00035"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a1">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_PTE_CHANGED 0x87303000</span>
<a name="l00036"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a2">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define STATUS_REFAULT 0xC7303001</span>
00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a5">00038</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d5/d1/mminit_8c.html#a5">MmSharedUserDataPte</a>;
00039 
<a name="l00040"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a6">00040</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>;
<a name="l00041"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a7">00041</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>;
00042 
<a name="l00043"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a3">00043</a> <span class="preprocessor">#define MI_PROTOTYPE_WSINDEX    ((ULONG)-1)</span>
00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a8">00045</a> <a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">MMINPAGE_SUPPORT_LIST</a> <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>;
00046 
00047 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00048 <a class="code" href="../../d8/d2/pagfault_8c.html#a9">MiHandleBankedSection</a> (
00049     IN PVOID VirtualAddress,
00050     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
00051     );
00052 
00053 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00054 <a class="code" href="../../d8/d2/pagfault_8c.html#a10">MiCompleteProtoPteFault</a> (
00055     IN BOOLEAN StoreInstruction,
00056     IN PVOID FaultingAddress,
00057     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00058     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte
00059     );
00060 
00061 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiCheckPdeForSessionSpace)</span>
00063 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionCopyOnWrite)</span>
00064 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00065 <span class="preprocessor"></span>
00066 
00067 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00068"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a11">00068</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (
00069     IN BOOLEAN StoreInstruction,
00070     IN PVOID VirtualAddress,
00071     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00072     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
00073     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00074     OUT PLOGICAL ApcNeeded
00075     )
00076 
00077 <span class="comment">/*++</span>
00078 <span class="comment"></span>
00079 <span class="comment">Routine Description:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    This routine dispatches a page fault to the appropriate</span>
00082 <span class="comment">    routine to complete the fault.</span>
00083 <span class="comment"></span>
00084 <span class="comment">Arguments:</span>
00085 <span class="comment"></span>
00086 <span class="comment">    StoreInstruction - Supplies TRUE if the instruction is trying</span>
00087 <span class="comment">                       to modify the faulting address (i.e. write</span>
00088 <span class="comment">                       access required).</span>
00089 <span class="comment"></span>
00090 <span class="comment">    VirtualAddress - Supplies the faulting address.</span>
00091 <span class="comment"></span>
00092 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
00093 <span class="comment"></span>
00094 <span class="comment">    PointerProtoPte - Supplies a pointer to the prototype PTE to fault in,</span>
00095 <span class="comment">                      NULL if no prototype PTE exists.</span>
00096 <span class="comment"></span>
00097 <span class="comment">    Process - Supplies a pointer to the process object.  If this</span>
00098 <span class="comment">              parameter is NULL, then the fault is for system</span>
00099 <span class="comment">              space and the process's working set lock is not held.</span>
00100 <span class="comment">              If this parameter is HYDRA_PROCESS, then the fault is for session</span>
00101 <span class="comment">              space and the process's working set lock is not held - rather</span>
00102 <span class="comment">              the session space's working set lock is held.</span>
00103 <span class="comment"></span>
00104 <span class="comment">    ApcNeeded - Supplies a pointer to a location set to TRUE if an I/O</span>
00105 <span class="comment">                completion APC is needed to complete partial IRPs that</span>
00106 <span class="comment">                collided.</span>
00107 <span class="comment"></span>
00108 <span class="comment">                It is the caller's responsibility to initialize this (usually</span>
00109 <span class="comment">                to FALSE) on entry.  However, since this routine may be called</span>
00110 <span class="comment">                multiple times for a single fault (for the page directory,</span>
00111 <span class="comment">                page table and the page itself), it is possible for it to</span>
00112 <span class="comment">                occasionally be TRUE on entry.</span>
00113 <span class="comment"></span>
00114 <span class="comment">                If it is FALSE on exit, no completion APC is needed.</span>
00115 <span class="comment"></span>
00116 <span class="comment">Return Value:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    status.</span>
00119 <span class="comment"></span>
00120 <span class="comment">Environment:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    Kernel mode, working set lock held.</span>
00123 <span class="comment"></span>
00124 <span class="comment">--*/</span>
00125 
00126 {
00127     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00128     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00129     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> ReadBlock;
00130     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> SavedPte;
00131     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> CapturedEvent;
00132     KIRQL OldIrql;
00133     PPFN_NUMBER Page;
00134     PFN_NUMBER PageFrameIndex;
00135     LONG NumberOfBytes;
00136     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CheckPte;
00137     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ReadPte;
00138     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnClusterPage;
00139     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00140     <a class="code" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a> NotifyRoutine;
00141     KIRQL PreviousIrql;
00142     LOGICAL WsLockChanged;
00143     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00144 
00145     <a class="code" href="../../d2/d1/mm_8h.html#a42">PERFINFO_DISPATCHFAULT_DECL</a>();
00146 
00147     WsLockChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00148 
00149 ProtoPteNotResident:
00150 
00151     <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">// Acquire the PFN lock to synchronize access to prototype PTEs.</span>
00155         <span class="comment">// This is required as the working set lock will not prevent</span>
00156         <span class="comment">// multiple processes from operating on the same prototype PTE.</span>
00157         <span class="comment">//</span>
00158 
00159         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">// Make sure the protoptes are in memory.  For</span>
00163         <span class="comment">// user mode faults, this should already be the case.</span>
00164         <span class="comment">//</span>
00165 
00166         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
00167             CheckPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerProtoPte);
00168 
00169             <span class="keywordflow">if</span> (CheckPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00170 
00171                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>));
00172 
00173                 <span class="comment">//</span>
00174                 <span class="comment">// The page that contains the prototype PTE is not in memory.</span>
00175                 <span class="comment">//</span>
00176 
00177                 VirtualAddress = PointerProtoPte;
00178                 PointerPte = CheckPte;
00179                 PointerProtoPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00180                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00181 
00182                 <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
00183                     <span class="comment">//</span>
00184                     <span class="comment">// We were called while holding this session space's</span>
00185                     <span class="comment">// working set lock.  But we need to fault in a</span>
00186                     <span class="comment">// prototype PTE which is in system paged pool. This</span>
00187                     <span class="comment">// must be done under the system working set lock.</span>
00188                     <span class="comment">//</span>
00189                     <span class="comment">// So we release the session space WSL lock and get</span>
00190                     <span class="comment">// the system working set lock.  When done</span>
00191                     <span class="comment">// we return STATUS_MORE_PROCESSING_REQUIRED</span>
00192                     <span class="comment">// so our caller will call us again to handle the</span>
00193                     <span class="comment">// actual prototype PTE fault.</span>
00194                     <span class="comment">//</span>
00195 
00196                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00197                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00198 
00199                     <span class="comment">//</span>
00200                     <span class="comment">// Lock the system working set for paged pool</span>
00201                     <span class="comment">//</span>
00202 
00203                     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (PreviousIrql);
00204 
00205                     <span class="comment">//</span>
00206                     <span class="comment">// System working set is locked so set Process to show it.</span>
00207                     <span class="comment">//</span>
00208 
00209                     Process = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00210 
00211                     WsLockChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00212 
00213                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00214                 }
00215                 <span class="keywordflow">else</span> {
00216                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00217                 }
00218 
00219                 <span class="keywordflow">goto</span> ProtoPteNotResident;
00220             }
00221         }
00222 
00223         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
00224 
00225             <span class="comment">//</span>
00226             <span class="comment">// PTE was already made valid by the cache manager support</span>
00227             <span class="comment">// routines.</span>
00228             <span class="comment">//</span>
00229 
00230             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00231 
00232             <span class="keywordflow">if</span> (WsLockChanged == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00233                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00234                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00235             }
00236 
00237             <span class="keywordflow">return</span> STATUS_SUCCESS;
00238         }
00239 
00240         ReadPte = PointerProtoPte;
00241 
00242         <a class="code" href="../../d2/d1/mm_8h.html#a58">PERFINFO_HARDFAULT_INFO</a>(PointerProtoPte);
00243 
00244         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a15">MiResolveProtoPteFault</a> (StoreInstruction,
00245                                          VirtualAddress,
00246                                          PointerPte,
00247                                          PointerProtoPte,
00248                                          &amp;ReadBlock,
00249                                          Process,
00250                                          ApcNeeded);
00251         <span class="comment">//</span>
00252         <span class="comment">// Returns with PFN lock released.</span>
00253         <span class="comment">//</span>
00254 
00255         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00256 
00257     } <span class="keywordflow">else</span> {
00258 
00259         TempPte = *PointerPte;
00260         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0);
00261 
00262         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition != 0) {
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">// This is a transition page.</span>
00266             <span class="comment">//</span>
00267 
00268             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a13">MiResolveTransitionFault</a> (VirtualAddress,
00269                                                PointerPte,
00270                                                Process,
00271                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00272                                                ApcNeeded);
00273 
00274         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == 0) {
00275 
00276             <span class="comment">//</span>
00277             <span class="comment">// Demand zero fault.</span>
00278             <span class="comment">//</span>
00279 
00280             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (VirtualAddress,
00281                                                PointerPte,
00282                                                Process,
00283                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00284         } <span class="keywordflow">else</span> {
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">// Page resides in paging file.</span>
00288             <span class="comment">//</span>
00289 
00290             ReadPte = PointerPte;
00291             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00292             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a14">MiResolvePageFileFault</a> (VirtualAddress,
00293                                              PointerPte,
00294                                              &amp;ReadBlock,
00295                                              Process);
00296         }
00297     }
00298 
00299     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00300 
00301     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00302 
00303         <span class="keywordflow">if</span> (WsLockChanged == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00304             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00305             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00306         }
00307 
00308         <span class="keywordflow">return</span> status;
00309     }
00310 
00311     <span class="keywordflow">if</span> (status == <a class="code" href="../../d8/d2/pagfault_8c.html#a0">STATUS_ISSUE_PAGING_IO</a>) {
00312 
00313         SavedPte = *ReadPte;
00314 
00315         CapturedEvent = (<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a>)ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o9">Pfn</a>-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event;
00316 
00317         CurrentThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00318 
00319         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
00320             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00321         }
00322         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// APCs must be explicitly disabled to prevent suspend APCs from</span>
00326             <span class="comment">// interrupting this thread before the I/O has been issued.</span>
00327             <span class="comment">// Otherwise a shared page I/O can stop any other thread that</span>
00328             <span class="comment">// references it indefinitely until the suspend is released.</span>
00329             <span class="comment">//</span>
00330 
00331             CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00332 
00333             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 2);
00334             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> += 1;
00335 
00336             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00337             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
00338         }
00339         <span class="keywordflow">else</span> {
00340             <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00341         }
00342 
00343 <span class="preprocessor">#if DBG</span>
00344 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a59">MM_DBG_PAGEFAULT</a>) {
00345             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MMFAULT: va: %p size: %lx process: %s file: %Z\n"</span>,
00346                 VirtualAddress,
00347                 ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>,
00348                 Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a> ? (PUCHAR)<span class="stringliteral">"Session Space"</span> : (Process ? Process-&gt;ImageFileName : (PUCHAR)<span class="stringliteral">"SystemVa"</span>),
00349                 &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o7">FilePointer</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>
00350             );
00351         }
00352 <span class="preprocessor">#endif //DBG</span>
00353 <span class="preprocessor"></span>
00354         <a class="code" href="../../d2/d1/mm_8h.html#a57">PERFINFO_HARDFAULT</a>(VirtualAddress, ReadBlock);
00355 
00356 <span class="preprocessor">#if defined(_PREFETCH_)</span>
00357 <span class="preprocessor"></span>
00358         <span class="comment">//</span>
00359         <span class="comment">// Assert no reads issued here are marked as prefetched.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ReadBlock-&gt;PrefetchMdl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00363 
00364 <span class="preprocessor">#endif</span>
00365 <span class="preprocessor"></span>
00366         <span class="comment">//</span>
00367         <span class="comment">// Issue the read request.</span>
00368         <span class="comment">//</span>
00369         
00370         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a89">IoPageRead</a> ( ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o7">FilePointer</a>,
00371                              &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>,
00372                              &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o2">ReadOffset</a>,
00373                              &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">Event</a>,
00374                              &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o1">IoStatus</a>);
00375         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00376         
00377             <span class="comment">//</span>
00378             <span class="comment">// Set the event as the I/O system doesn't set it on errors.</span>
00379             <span class="comment">//</span>
00380         
00381         
00382             ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o1">IoStatus</a>.Status = status;
00383             ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o1">IoStatus</a>.Information = 0;
00384             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">Event</a>,
00385                         0,
00386                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00387         }
00388         
00389         <span class="comment">//</span>
00390         <span class="comment">// Wait for the I/O operation.</span>
00391         <span class="comment">//</span>
00392         
00393         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a17">MiWaitForInPageComplete</a> (ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o9">Pfn</a>,
00394                                           ReadPte,
00395                                           VirtualAddress,
00396                                           &amp;SavedPte,
00397                                           CapturedEvent,
00398                                           Process);
00399         
00400         <span class="keywordflow">if</span> (CurrentThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00401             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00402 
00403             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 3);
00404             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> != 0);
00405 
00406             CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> -= 1;
00407 
00408             <span class="keywordflow">if</span> ((CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> == 1) &amp;&amp;
00409                 (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 0)) {
00410                 *ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00411                 CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> = 0;
00412             }
00413         }
00414 
00415         <a class="code" href="../../d2/d1/mm_8h.html#a59">PERFINFO_HARDFAULT_IOTIME</a>();
00416 
00417         <span class="comment">//</span>
00418         <span class="comment">// MiWaitForInPageComplete RETURNS WITH THE WORKING SET LOCK</span>
00419         <span class="comment">// AND PFN LOCK HELD!!!</span>
00420         <span class="comment">//</span>
00421 
00422         <span class="comment">//</span>
00423         <span class="comment">// This is the thread which owns the event, clear the event field</span>
00424         <span class="comment">// in the PFN database.</span>
00425         <span class="comment">//</span>
00426 
00427         Pfn1 = ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o9">Pfn</a>;
00428         Page = &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o12">Page</a>[0];
00429         NumberOfBytes = (LONG)ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00430         CheckPte = ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o8">BasePte</a>;
00431 
00432         <span class="keywordflow">while</span> (NumberOfBytes &gt; 0) {
00433 
00434             <span class="comment">//</span>
00435             <span class="comment">// Don't remove the page we just brought in to</span>
00436             <span class="comment">// satisfy this page fault.</span>
00437             <span class="comment">//</span>
00438 
00439             <span class="keywordflow">if</span> (CheckPte != ReadPte) {
00440                 PfnClusterPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
00441                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
00442 <span class="preprocessor">#if DBG</span>
00443 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError) {
00444                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (status != STATUS_SUCCESS);
00445                 }
00446 <span class="preprocessor">#endif //DBG</span>
00447 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress != 0) {
00448 
00449                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
00450                     PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress = 0;
00451 
00452                     <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0) {
00453                         PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00454                     }
00455                 }
00456                 <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(PfnClusterPage, 9);
00457                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
00458             } <span class="keywordflow">else</span> {
00459                 PageFrameIndex = *Page;
00460             }
00461 
00462             CheckPte += 1;
00463             Page += 1;
00464             NumberOfBytes -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00465         }
00466 
00467         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00468 
00469             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex), 9);
00470             <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
00471 
00472             <span class="keywordflow">if</span> (status == <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>) {
00473 
00474                 <span class="comment">//</span>
00475                 <span class="comment">// State of PTE changed during I/O operation, just</span>
00476                 <span class="comment">// return success and refault.</span>
00477                 <span class="comment">//</span>
00478 
00479                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00480 
00481                 <span class="keywordflow">if</span> (WsLockChanged == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00482                     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00483                     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00484                 }
00485 
00486                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00487 
00488             }
00489 
00490             <span class="comment">//</span>
00491             <span class="comment">// An I/O error occurred during the page read</span>
00492             <span class="comment">// operation.  All the pages which were just</span>
00493             <span class="comment">// put into transition should be put onto the</span>
00494             <span class="comment">// free list if InPageError is set, and their</span>
00495             <span class="comment">// PTEs restored to the proper contents.</span>
00496             <span class="comment">//</span>
00497 
00498             Page = &amp;ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o12">Page</a>[0];
00499 
00500             NumberOfBytes = ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>.<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>;
00501 
00502             <span class="keywordflow">while</span> (NumberOfBytes &gt; 0) {
00503 
00504                 PfnClusterPage = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
00505 
00506                 <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 1) {
00507 
00508                     <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
00509 
00510                         PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError = 0;
00511 
00512                         <span class="comment">//</span>
00513                         <span class="comment">// Only restore the transition PTE if the address</span>
00514                         <span class="comment">// space still exists.  Another thread may have </span>
00515                         <span class="comment">// deleted the VAD while this thread waited for the</span>
00516                         <span class="comment">// fault to complete - in this case, the frame</span>
00517                         <span class="comment">// will be marked as free already.</span>
00518                         <span class="comment">//</span>
00519 
00520                         <span class="keywordflow">if</span> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
00521                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnClusterPage-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation ==
00522                                                             <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>);
00523                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (PfnClusterPage);
00524                             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (*Page);
00525                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
00526                                                 *Page);
00527                         }
00528                     }
00529                 }
00530                 Page += 1;
00531                 NumberOfBytes -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00532             }
00533             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00534 
00535             <span class="keywordflow">if</span> (WsLockChanged == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00536                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00537                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00538             }
00539 
00540             <span class="keywordflow">if</span> (status == <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>) {
00541 
00542                 <span class="comment">//</span>
00543                 <span class="comment">// The I/O operation to bring in a system page failed</span>
00544                 <span class="comment">// due to insufficent resources.  Delay a bit, then</span>
00545                 <span class="comment">// return success and refault.</span>
00546                 <span class="comment">//</span>
00547 
00548                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
00549                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00550             }
00551 
00552             <span class="keywordflow">return</span> status;
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">// PTE is still in transition state, same protection, etc.</span>
00557         <span class="comment">//</span>
00558 
00559         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0);
00560 
00561         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0) {
00562             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 9);
00563         }
00564 
00565         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
00566         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
00567 
00568         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a108">MI_MAKE_TRANSITION_PTE_VALID</a> (TempPte, ReadPte);
00569         <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write) {
00570             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
00571         }
00572         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (ReadPte, TempPte);
00573 
00574         <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00575 
00576             <span class="comment">//</span>
00577             <span class="comment">// The prototype PTE has been made valid, now make the</span>
00578             <span class="comment">// original PTE valid.</span>
00579             <span class="comment">//</span>
00580 
00581             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
00582 <span class="preprocessor">#if DBG</span>
00583 <span class="preprocessor"></span>                <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> oldstatus = status;
00584 <span class="preprocessor">#endif //DBG</span>
00585 <span class="preprocessor"></span>
00586                 <span class="comment">//</span>
00587                 <span class="comment">// PTE is not valid, continue with operation.</span>
00588                 <span class="comment">//</span>
00589 
00590                 status = <a class="code" href="../../d8/d2/pagfault_8c.html#a10">MiCompleteProtoPteFault</a> (StoreInstruction,
00591                                                   VirtualAddress,
00592                                                   PointerPte,
00593                                                   PointerProtoPte);
00594 
00595                 <span class="comment">//</span>
00596                 <span class="comment">// Returns with PFN lock released!</span>
00597                 <span class="comment">//</span>
00598 
00599 <span class="preprocessor">#if DBG</span>
00600 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
00601                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM:PAGFAULT - va %p  %p  %p  status:%lx\n"</span>,
00602                         VirtualAddress, PointerPte, PointerProtoPte, oldstatus);
00603                 }
00604 <span class="preprocessor">#endif //DBG</span>
00605 <span class="preprocessor"></span>            }
00606         } <span class="keywordflow">else</span> {
00607 
00608 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00609 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(ReadPte) == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PTE_BASE)) {
00610                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
00611             }
00612 <span class="preprocessor">#endif</span>
00613 <span class="preprocessor"></span>
00614             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0) {
00615                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00616             }
00617 
00618             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00619             <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (VirtualAddress,
00620                                         ReadPte,
00621                                         Pfn1,
00622                                         0);
00623         }
00624 
00625         <span class="comment">//</span>
00626         <span class="comment">// Note this routine could release and reacquire the PFN lock!</span>
00627         <span class="comment">//</span>
00628 
00629         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00630         <a class="code" href="../../d4/d8/mi_8h.html#a800">MiFlushInPageSupportBlock</a>();
00631         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00632 
00633         <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
00634             status = STATUS_PAGE_FAULT_PAGING_FILE;
00635         }
00636         NotifyRoutine = <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a>;
00637         <span class="keywordflow">if</span> (NotifyRoutine) {
00638             (*NotifyRoutine) (
00639                 ReadBlock-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o7">FilePointer</a>,
00640                 VirtualAddress
00641                 );
00642         }
00643     }
00644 
00645     <span class="comment">//</span>
00646     <span class="comment">// Stop high priority threads from consuming the CPU on collided</span>
00647     <span class="comment">// faults for pages that are still marked with inpage errors.  All</span>
00648     <span class="comment">// the threads must let go of the page so it can be freed and the</span>
00649     <span class="comment">// inpage I/O reissued to the filesystem.</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(status)) {
00653         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
00654         status = STATUS_SUCCESS;
00655     }
00656 
00657     <span class="keywordflow">if</span> ((status == <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>) ||
00658         (status == <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>)) {
00659         status = STATUS_SUCCESS;
00660     }
00661 
00662     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00663 
00664     <span class="keywordflow">if</span> (WsLockChanged == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00665         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00666         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00667     }
00668 
00669     <span class="keywordflow">return</span> status;
00670 }
00671 
00672 
00673 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00674"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a12">00674</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (
00675     IN PVOID VirtualAddress,
00676     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00677     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00678     IN ULONG PrototypePte
00679     )
00680 
00681 <span class="comment">/*++</span>
00682 <span class="comment"></span>
00683 <span class="comment">Routine Description:</span>
00684 <span class="comment"></span>
00685 <span class="comment">    This routine resolves a demand zero page fault.</span>
00686 <span class="comment"></span>
00687 <span class="comment">    If the PrototypePte argument is TRUE, the PFN lock is</span>
00688 <span class="comment">    held, the lock cannot be dropped, and the page should</span>
00689 <span class="comment">    not be added to the working set at this time.</span>
00690 <span class="comment"></span>
00691 <span class="comment">Arguments:</span>
00692 <span class="comment"></span>
00693 <span class="comment">    VirtualAddress - Supplies the faulting address.</span>
00694 <span class="comment"></span>
00695 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
00696 <span class="comment"></span>
00697 <span class="comment">    Process - Supplies a pointer to the process object.  If this</span>
00698 <span class="comment">              parameter is NULL, then the fault is for system</span>
00699 <span class="comment">              space and the process's working set lock is not held.</span>
00700 <span class="comment"></span>
00701 <span class="comment">    PrototypePte - Supplies TRUE if this is a prototype PTE.</span>
00702 <span class="comment"></span>
00703 <span class="comment">Return Value:</span>
00704 <span class="comment"></span>
00705 <span class="comment">    status, either STATUS_SUCCESS or STATUS_REFAULT.</span>
00706 <span class="comment"></span>
00707 <span class="comment">Environment:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    Kernel mode, PFN lock held conditionally.</span>
00710 <span class="comment"></span>
00711 <span class="comment">--*/</span>
00712 
00713 
00714 {
00715     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00716     PFN_NUMBER PageFrameIndex;
00717     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00718     ULONG PageColor;
00719     KIRQL OldIrql;
00720     LOGICAL NeedToZero;
00721     LOGICAL BarrierNeeded;
00722     ULONG BarrierStamp;
00723 
00724     NeedToZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00725     BarrierNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00726 
00727     <a class="code" href="../../d2/d1/mm_8h.html#a86">PERFINFO_PRIVATE_PAGE_DEMAND_ZERO</a>(VirtualAddress);
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// Check to see if a page is available, if a wait is</span>
00731     <span class="comment">// returned, do not continue, just return success.</span>
00732     <span class="comment">//</span>
00733 
00734     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>) {
00735         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00736     }
00737 
00738     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
00739 
00740     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
00741         <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (Process,
00742                                           VirtualAddress)) {
00743 
00744             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Process != <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a> &amp;&amp; (!<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>)) {
00745                 <span class="comment">//</span>
00746                 <span class="comment">// If a fork operation is in progress and the faulting thread</span>
00747                 <span class="comment">// is not the thread performing the fork operation, block until</span>
00748                 <span class="comment">// the fork is completed.</span>
00749                 <span class="comment">//</span>
00750 
00751                 <span class="keywordflow">if</span> ((Process-&gt;ForkInProgress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00752                     (Process-&gt;ForkInProgress != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) {
00753                     <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (Process);
00754                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00755                     <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
00756                 }
00757 
00758                 Process-&gt;NumberOfPrivatePages += 1;
00759                 PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (VirtualAddress,
00760                                                    &amp;Process-&gt;NextPageColor);
00761 
00762                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(PointerPte));
00763 
00764                 PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
00765                 <span class="keywordflow">if</span> (PageFrameIndex) {
00766 
00767                     <span class="comment">//</span>
00768                     <span class="comment">// This barrier check is needed after zeroing the page</span>
00769                     <span class="comment">// and before setting the PTE valid.  Note since the PFN</span>
00770                     <span class="comment">// database entry is used to hold the sequence timestamp,</span>
00771                     <span class="comment">// it must be captured now.  Check it at the last possible</span>
00772                     <span class="comment">// moment.</span>
00773                     <span class="comment">//</span>
00774         
00775                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00776                     BarrierStamp = (ULONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
00777                 }
00778                 <span class="keywordflow">else</span> {
00779                     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00780                     NeedToZero = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00781                 }
00782                 BarrierNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00783 
00784             } <span class="keywordflow">else</span> {
00785                 PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (VirtualAddress,
00786                                                       &amp;<a class="code" href="../../d4/d8/mi_8h.html#a693">MmSystemPageColor</a>);
00787                 <span class="comment">//</span>
00788                 <span class="comment">// As this is a system page, there is no need to</span>
00789                 <span class="comment">// remove a page of zeroes, it must be initialized by</span>
00790                 <span class="comment">// the system before being used.</span>
00791                 <span class="comment">//</span>
00792 
00793                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>) {
00794                     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (PageColor);
00795                 } <span class="keywordflow">else</span> {
00796                     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
00797                 }
00798             }
00799 
00800             <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o4">DemandZeroCount</a> += 1;
00801 
00802             <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
00803 
00804             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>) {
00805                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00806             }
00807 
00808             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00809 
00810             <span class="keywordflow">if</span> (NeedToZero) {
00811 
00812                 <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, PageColor);
00813 
00814                 <span class="comment">//</span>
00815                 <span class="comment">// Note the stamping must occur after the page is zeroed.</span>
00816                 <span class="comment">//</span>
00817         
00818                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;BarrierStamp);
00819             }
00820 
00821             <span class="comment">//</span>
00822             <span class="comment">// As this page is demand zero, set the modified bit in the</span>
00823             <span class="comment">// PFN database element and set the dirty bit in the PTE.</span>
00824             <span class="comment">//</span>
00825 
00826             <a class="code" href="../../d2/d1/mm_8h.html#a93">PERFINFO_SOFTFAULT</a>(Pfn1, VirtualAddress, PERFINFO_LOG_TYPE_DEMANDZEROFAULT)
00827 
00828             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
00829                                PageFrameIndex,
00830                                PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
00831                                PointerPte);
00832 
00833             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write != 0) {
00834                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
00835             }
00836 
00837             <span class="keywordflow">if</span> (BarrierNeeded) {
00838                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a197">MI_BARRIER_SYNCHRONIZE</a> (BarrierStamp);
00839             }
00840 
00841             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
00842 
00843             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>) {
00844                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0);
00845 
00846                 <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
00847 
00848                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00849 
00850                 <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
00851 
00852                 <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (VirtualAddress,
00853                                             PointerPte,
00854                                             Pfn1,
00855                                             0);
00856             }
00857             <span class="keywordflow">return</span> STATUS_PAGE_FAULT_DEMAND_ZERO;
00858         }
00859     }
00860     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>) {
00861         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00862     }
00863     <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
00864 }
00865 
00866 
00867 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00868"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a13">00868</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a13">MiResolveTransitionFault</a> (
00869     IN PVOID FaultingAddress,
00870     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00871     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
00872     IN ULONG PfnLockHeld,
00873     OUT PLOGICAL ApcNeeded
00874     )
00875 
00876 <span class="comment">/*++</span>
00877 <span class="comment"></span>
00878 <span class="comment">Routine Description:</span>
00879 <span class="comment"></span>
00880 <span class="comment">    This routine resolves a transition page fault.</span>
00881 <span class="comment"></span>
00882 <span class="comment">Arguments:</span>
00883 <span class="comment"></span>
00884 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
00885 <span class="comment"></span>
00886 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
00887 <span class="comment"></span>
00888 <span class="comment">    CurrentProcess - Supplies a pointer to the process object.  If this</span>
00889 <span class="comment">                     parameter is NULL, then the fault is for system</span>
00890 <span class="comment">                     space and the process's working set lock is not held.</span>
00891 <span class="comment"></span>
00892 <span class="comment">    PfnLockHeld - Supplies TRUE if the PFN lock is held, FALSE if not.</span>
00893 <span class="comment"></span>
00894 <span class="comment">    ApcNeeded - Supplies a pointer to a location set to TRUE if an I/O</span>
00895 <span class="comment">                completion APC is needed to complete partial IRPs that</span>
00896 <span class="comment">                collided.</span>
00897 <span class="comment"></span>
00898 <span class="comment">                It is the caller's responsibility to initialize this (usually</span>
00899 <span class="comment">                to FALSE) on entry.  However, since this routine may be called</span>
00900 <span class="comment">                multiple times for a single fault (for the page directory,</span>
00901 <span class="comment">                page table and the page itself), it is possible for it to</span>
00902 <span class="comment">                occasionally be TRUE on entry.</span>
00903 <span class="comment"></span>
00904 <span class="comment">                If it is FALSE on exit, no completion APC is needed.</span>
00905 <span class="comment"></span>
00906 <span class="comment">Return Value:</span>
00907 <span class="comment"></span>
00908 <span class="comment">    status, either STATUS_SUCCESS, STATUS_REFAULT or an I/O status</span>
00909 <span class="comment">    code.</span>
00910 <span class="comment"></span>
00911 <span class="comment">Environment:</span>
00912 <span class="comment"></span>
00913 <span class="comment">    Kernel mode, PFN lock may optionally be held.</span>
00914 <span class="comment"></span>
00915 <span class="comment">--*/</span>
00916 
00917 {
00918     PFN_NUMBER PageFrameIndex;
00919     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00920     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00921     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00922     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> PfnStatus;
00923     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> CapturedEvent;
00924     KIRQL OldIrql;
00925     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">// ***********************************************************</span>
00929     <span class="comment">//      Transition PTE.</span>
00930     <span class="comment">// ***********************************************************</span>
00931     <span class="comment">//</span>
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">// A transition PTE is either on the free or modified list,</span>
00935     <span class="comment">// on neither list because of its ReferenceCount</span>
00936     <span class="comment">// or currently being read in from the disk (read in progress).</span>
00937     <span class="comment">// If the page is read in progress, this is a collided page</span>
00938     <span class="comment">// and must be handled accordingly.</span>
00939     <span class="comment">//</span>
00940 
00941     <span class="keywordflow">if</span> (!PfnLockHeld) {
00942         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00943     }
00944 
00945     TempPte = *PointerPte;
00946 
00947     <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Valid == 0) &amp;&amp;
00948         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
00949         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)) {
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// Still in transition format.</span>
00953         <span class="comment">//</span>
00954 
00955         <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o2">TransitionCount</a> += 1;
00956 
00957         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;TempPte);
00958         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00959 
00960         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError) {
00961 
00962             <span class="comment">//</span>
00963             <span class="comment">// There was an in-page read error and there are other</span>
00964             <span class="comment">// threads colliding for this page, delay to let the</span>
00965             <span class="comment">// other threads complete and return.</span>
00966             <span class="comment">//</span>
00967 
00968             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.ReadStatus));
00969             <span class="keywordflow">if</span> (!PfnLockHeld) {
00970                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00971             }
00972 
00973             <span class="keywordflow">return</span> Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.ReadStatus;
00974         }
00975 
00976         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress) {
00977 
00978             <span class="comment">//</span>
00979             <span class="comment">// Collided page fault.</span>
00980             <span class="comment">//</span>
00981 
00982 <span class="preprocessor">#if DBG</span>
00983 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a67">MM_DBG_COLLIDED_PAGE</a>) {
00984                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:collided page fault\n"</span>);
00985             }
00986 <span class="preprocessor">#endif</span>
00987 <span class="preprocessor"></span>
00988             CapturedEvent = (<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a>)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event;
00989 
00990             CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00991 
00992             <span class="keywordflow">if</span> (CapturedEvent-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o6">u</a>.Thread == CurrentThread) {
00993 
00994                 <span class="comment">//</span>
00995                 <span class="comment">// This detects MmCopyToCachedPage deadlocks where both the</span>
00996                 <span class="comment">// user and system address point at the same physical page.</span>
00997                 <span class="comment">//</span>
00998                 <span class="comment">// It also detects when the Io APC completion routine accesses</span>
00999                 <span class="comment">// the same user page (ie: during an overlapped I/O) that</span>
01000                 <span class="comment">// the user thread has already faulted on.</span>
01001                 <span class="comment">//</span>
01002                 <span class="comment">// Both cases above can result in fatal deadlocks and so must</span>
01003                 <span class="comment">// be detected here.  Return a unique status code so the</span>
01004                 <span class="comment">// (legitimate) callers know this has happened so it can be</span>
01005                 <span class="comment">// handled properly.  In the first case above this means</span>
01006                 <span class="comment">// restarting the entire operation immediately.  In the second</span>
01007                 <span class="comment">// case above it means requesting a callback from the Mm</span>
01008                 <span class="comment">// once the first fault has completed.</span>
01009                 <span class="comment">//</span>
01010                 <span class="comment">// Note that non-legitimate callers must get back a failure</span>
01011                 <span class="comment">// status so the thread can be terminated.</span>
01012                 <span class="comment">//</span>
01013 
01014                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 1) ||
01015                         (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 2));
01016 
01017                 CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> = 1;
01018 
01019                 <span class="keywordflow">if</span> (!PfnLockHeld) {
01020                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01021                 }
01022                 <span class="keywordflow">return</span> STATUS_MULTIPLE_FAULT_VIOLATION;
01023             }
01024 
01025             <span class="comment">//</span>
01026             <span class="comment">// Increment the reference count for the page so it won't be</span>
01027             <span class="comment">// reused until all collisions have been completed.</span>
01028             <span class="comment">//</span>
01029 
01030             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01031             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01032             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LockCharged == 1);
01033 
01034             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01035 
01036             CapturedEvent-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o3">WaitCount</a> += 1;
01037 
01038             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01039 
01040             <span class="keywordflow">if</span> (CurrentProcess == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01041                 CurrentThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01042                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01043             }
01044             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01045 
01046                 <span class="comment">//</span>
01047                 <span class="comment">// APCs must be explicitly disabled to prevent suspend APCs from</span>
01048                 <span class="comment">// interrupting this thread before the wait has been issued.</span>
01049                 <span class="comment">// Otherwise the APC can result in this page being locked</span>
01050                 <span class="comment">// indefinitely until the suspend is released.</span>
01051                 <span class="comment">//</span>
01052     
01053                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 2);
01054                 CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> += 1;
01055 
01056                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01057                 <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01058             }
01059             <span class="keywordflow">else</span> {
01060                 CurrentThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01061                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01062             }
01063 
01064             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a17">MiWaitForInPageComplete</a> (Pfn1,
01065                                               PointerPte,
01066                                               FaultingAddress,
01067                                               &amp;TempPte,
01068                                               CapturedEvent,
01069                                               CurrentProcess);
01070             <span class="comment">//</span>
01071             <span class="comment">// MiWaitForInPageComplete RETURNS WITH THE WORKING SET LOCK</span>
01072             <span class="comment">// AND PFN LOCK HELD!!!</span>
01073             <span class="comment">//</span>
01074 
01075             <span class="keywordflow">if</span> (CurrentThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01076                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01077 
01078                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> &lt;= 3);
01079                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> != 0);
01080 
01081                 CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> -= 1;
01082 
01083                 <span class="keywordflow">if</span> ((CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> == 1) &amp;&amp;
01084                     (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o2">NestedFaultCount</a> == 0)) {
01085                     *ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01086                     CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o3">ApcNeeded</a> = 0;
01087                 }
01088             }
01089 
01090             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
01091 
01092             <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01093                 PfnStatus = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.ReadStatus;
01094                 <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 9);
01095                 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
01096 
01097                 <span class="comment">//</span>
01098                 <span class="comment">// Check to see if an I/O error occurred on this page.</span>
01099                 <span class="comment">// If so, try to free the physical page, wait a</span>
01100                 <span class="comment">// half second and return a status of PTE_CHANGED.</span>
01101                 <span class="comment">// This will result in success being returned to</span>
01102                 <span class="comment">// the user and the fault will occur again and should</span>
01103                 <span class="comment">// not be a transition fault this time.</span>
01104                 <span class="comment">//</span>
01105 
01106                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 1) {
01107                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(PfnStatus));
01108                     status = PfnStatus;
01109                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0) {
01110 
01111                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError = 0;
01112 
01113                         <span class="comment">//</span>
01114                         <span class="comment">// Only restore the transition PTE if the address</span>
01115                         <span class="comment">// space still exists.  Another thread may have </span>
01116                         <span class="comment">// deleted the VAD while this thread waited for the</span>
01117                         <span class="comment">// fault to complete - in this case, the frame</span>
01118                         <span class="comment">// will be marked as free already.</span>
01119                         <span class="comment">//</span>
01120 
01121                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation != <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>) {
01122                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation ==
01123                                                             <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>);
01124                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01125                             <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (PageFrameIndex);
01126 
01127                             <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a>(<a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>],
01128                                                PageFrameIndex);
01129                         }
01130                     }
01131                 }
01132 
01133 <span class="preprocessor">#if DBG</span>
01134 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a67">MM_DBG_COLLIDED_PAGE</a>) {
01135                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:decrement ref count - pte changed\n"</span>);
01136                     <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
01137                 }
01138 <span class="preprocessor">#endif</span>
01139 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!PfnLockHeld) {
01140                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01141                 }
01142 
01143                 <span class="comment">//</span>
01144                 <span class="comment">// Instead of returning status, always return STATUS_REFAULT.</span>
01145                 <span class="comment">// This is to support filesystems that save state in the</span>
01146                 <span class="comment">// ETHREAD of the thread that serviced the fault !  Since</span>
01147                 <span class="comment">// collided threads never enter the filesystem, their ETHREADs</span>
01148                 <span class="comment">// haven't been hacked up.  Since this only matters when</span>
01149                 <span class="comment">// errors occur (specifically STATUS_VERIFY_REQUIRED today),</span>
01150                 <span class="comment">// retry any failed I/O in the context of each collider</span>
01151                 <span class="comment">// to give the filesystems ample opportunity.</span>
01152                 <span class="comment">//</span>
01153 
01154                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01155             }
01156 
01157         } <span class="keywordflow">else</span> {
01158 
01159             <span class="comment">//</span>
01160             <span class="comment">// PTE refers to a normal transition PTE.</span>
01161             <span class="comment">//</span>
01162 
01163             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0);
01164             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>) {
01165 
01166                 <span class="comment">//</span>
01167                 <span class="comment">// This page must contain an MmSt allocation of prototype PTEs.</span>
01168                 <span class="comment">// Because these types of pages reside in paged pool (or special</span>
01169                 <span class="comment">// pool) and are part of the system working set, they can be</span>
01170                 <span class="comment">// trimmed at any time regardless of the share count.  However,</span>
01171                 <span class="comment">// if the share count is nonzero, then the page state will</span>
01172                 <span class="comment">// remain active and the page will remain in memory - but the</span>
01173                 <span class="comment">// PTE will be set to the transition state.  Make the page</span>
01174                 <span class="comment">// valid without incrementing the reference count, but</span>
01175                 <span class="comment">// increment the share count.</span>
01176                 <span class="comment">//</span>
01177 
01178                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>)) &amp;&amp;
01179                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>))) ||
01180                         ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>)) &amp;&amp;
01181                         (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>))));
01182 
01183                 <span class="comment">//</span>
01184                 <span class="comment">// Don't increment the valid PTE count for the</span>
01185                 <span class="comment">// page table page.</span>
01186                 <span class="comment">//</span>
01187 
01188                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount != 0);
01189                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
01190 
01191             } <span class="keywordflow">else</span> {
01192 
01193                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
01194 
01195                 <span class="comment">//</span>
01196                 <span class="comment">// Update the PFN database - the reference count must be</span>
01197                 <span class="comment">// incremented as the share count is going to go from zero to 1.</span>
01198                 <span class="comment">//</span>
01199 
01200                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
01201 
01202                 <span class="comment">//</span>
01203                 <span class="comment">// The PFN reference count will be 1 already here if the</span>
01204                 <span class="comment">// modified writer has begun a write of this page.  Otherwise</span>
01205                 <span class="comment">// it's ordinarily 0.</span>
01206                 <span class="comment">//</span>
01207 
01208                 <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 8);
01209 
01210                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01211             }
01212         }
01213 
01214         <span class="comment">//</span>
01215         <span class="comment">// Join with collided page fault code to handle updating</span>
01216         <span class="comment">// the transition PTE.</span>
01217         <span class="comment">//</span>
01218 
01219         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError == 0);
01220 
01221         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0) {
01222             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 9);
01223         }
01224 
01225         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01226         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
01227 
01228         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a108">MI_MAKE_TRANSITION_PTE_VALID</a> (TempPte, PointerPte);
01229 
01230         <span class="comment">//</span>
01231         <span class="comment">// If the modified field is set in the PFN database and this</span>
01232         <span class="comment">// page is not copy on modify, then set the dirty bit.</span>
01233         <span class="comment">// This can be done as the modified page will not be</span>
01234         <span class="comment">// written to the paging file until this PTE is made invalid.</span>
01235         <span class="comment">//</span>
01236 
01237         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write &amp;&amp;
01238                         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0)) {
01239             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01240         } <span class="keywordflow">else</span> {
01241             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (TempPte);
01242         }
01243 
01244         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01245 
01246         <span class="keywordflow">if</span> (!PfnLockHeld) {
01247 
01248             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0) {
01249                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01250             }
01251 
01252             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01253 
01254             <a class="code" href="../../d2/d1/mm_8h.html#a93">PERFINFO_SOFTFAULT</a>(Pfn1, FaultingAddress, PERFINFO_LOG_TYPE_TRANSITIONFAULT)
01255 
01256             <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (FaultingAddress,
01257                                         PointerPte,
01258                                         Pfn1,
01259                                         0);
01260         }
01261         <span class="keywordflow">return</span> STATUS_PAGE_FAULT_TRANSITION;
01262     } <span class="keywordflow">else</span> {
01263         <span class="keywordflow">if</span> (!PfnLockHeld) {
01264             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01265         }
01266     }
01267     <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01268 }
01269 
01270 
01271 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01272"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a14">01272</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a14">MiResolvePageFileFault</a> (
01273     IN PVOID FaultingAddress,
01274     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01275     OUT <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> *ReadBlock,
01276     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01277     )
01278 
01279 <span class="comment">/*++</span>
01280 <span class="comment"></span>
01281 <span class="comment">Routine Description:</span>
01282 <span class="comment"></span>
01283 <span class="comment">    This routine builds the MDL and other structures to allow a</span>
01284 <span class="comment">    read operation on a page file for a page fault.</span>
01285 <span class="comment"></span>
01286 <span class="comment">Arguments:</span>
01287 <span class="comment"></span>
01288 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
01289 <span class="comment"></span>
01290 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
01291 <span class="comment"></span>
01292 <span class="comment">    ReadBlock - Supplies a pointer to put the address of the read block which</span>
01293 <span class="comment">                needs to be completed before an I/O can be issued.</span>
01294 <span class="comment"></span>
01295 <span class="comment">    Process - Supplies a pointer to the process object.  If this</span>
01296 <span class="comment">              parameter is NULL, then the fault is for system</span>
01297 <span class="comment">              space and the process's working set lock is not held.</span>
01298 <span class="comment"></span>
01299 <span class="comment">Return Value:</span>
01300 <span class="comment"></span>
01301 <span class="comment">    status.  A status value of STATUS_ISSUE_PAGING_IO is returned</span>
01302 <span class="comment">    if this function completes successfully.</span>
01303 <span class="comment"></span>
01304 <span class="comment">Environment:</span>
01305 <span class="comment"></span>
01306 <span class="comment">    Kernel mode, PFN lock held.</span>
01307 <span class="comment"></span>
01308 <span class="comment">--*/</span>
01309 
01310 {
01311     LARGE_INTEGER StartingOffset;
01312     PFN_NUMBER PageFrameIndex;
01313     ULONG PageFileNumber;
01314     ULONG WorkingSetIndex;
01315     ULONG PageColor;
01316     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01317     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
01318     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> ReadBlockLocal;
01319 
01320     <span class="comment">// **************************************************</span>
01321     <span class="comment">//    Page File Read</span>
01322     <span class="comment">// **************************************************</span>
01323 
01324     <span class="comment">//</span>
01325     <span class="comment">// Calculate the VBN for the in-page operation.</span>
01326     <span class="comment">//</span>
01327 
01328     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01329     TempPte = *PointerPte;
01330 
01331     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01332         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01333         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01334     }
01335 
01336     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0);
01337     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0);
01338 
01339     PageFileNumber = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a169">GET_PAGING_FILE_NUMBER</a> (TempPte);
01340     StartingOffset.LowPart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a170">GET_PAGING_FILE_OFFSET</a> (TempPte);
01341 
01342     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingOffset.LowPart &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">Size</a>);
01343 
01344     StartingOffset.HighPart = 0;
01345     StartingOffset.QuadPart = StartingOffset.QuadPart &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01346 
01347     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01348     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (Process,
01349                                      FaultingAddress)) {
01350 
01351         <span class="comment">//</span>
01352         <span class="comment">// A wait operation was performed which dropped the locks,</span>
01353         <span class="comment">// repeat this fault.</span>
01354         <span class="comment">//</span>
01355 
01356         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01357         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01358     }
01359 
01360     ReadBlockLocal = <a class="code" href="../../d8/d2/pagfault_8c.html#a29">MiGetInPageSupportBlock</a> ();
01361     <span class="keywordflow">if</span> (ReadBlockLocal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01362         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01363         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01364     }
01365     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o5">PageReadCount</a> += 1;
01366     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o6">PageReadIoCount</a> += 1;
01367 
01368     *ReadBlock = ReadBlockLocal;
01369 
01370     <span class="comment">//fixfix can any of this be moved to after PFN lock released?</span>
01371 
01372     ReadBlockLocal-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o7">FilePointer</a> = <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[PageFileNumber]-&gt;<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">File</a>;
01373 
01374 <span class="preprocessor">#if DBG</span>
01375 <span class="preprocessor"></span>
01376     <span class="keywordflow">if</span> (((StartingOffset.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &lt; 8192) &amp;&amp; (PageFileNumber == 0)) {
01377         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartingOffset.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>] &amp; ~0x1f) !=
01378                ((ULONG_PTR)PointerPte &lt;&lt; 3)) {
01379             <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartingOffset.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>] &amp; ~0x1f) !=
01380                   ((ULONG_PTR)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(FaultingAddress)) &lt;&lt; 3)) {
01381 
01382                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MMINPAGE: Mismatch PointerPte %p Offset %I64X info %p\n"</span>,
01383                          PointerPte,
01384                          StartingOffset.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>,
01385                          <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[StartingOffset.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>]);
01386 
01387                 DbgBreakPoint();
01388             }
01389         }
01390     }
01391 
01392 <span class="preprocessor">#endif //DBG</span>
01393 <span class="preprocessor"></span>
01394     ReadBlockLocal-&gt;ReadOffset = StartingOffset;
01395 
01396     <span class="comment">//</span>
01397     <span class="comment">// Get a page and put the PTE into the transition state with the</span>
01398     <span class="comment">// read-in-progress flag set.</span>
01399     <span class="comment">//</span>
01400 
01401     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
01402         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
01403     }
01404     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01405         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a>(FaultingAddress);
01406     }
01407     <span class="keywordflow">else</span> {
01408         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (FaultingAddress,
01409                                               &amp;Process-&gt;NextPageColor);
01410     }
01411 
01412     ReadBlockLocal-&gt;BasePte = PointerPte;
01413 
01414     <span class="comment">//</span>
01415     <span class="comment">// Build MDL for request.</span>
01416     <span class="comment">//</span>
01417 
01418     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(&amp;ReadBlockLocal-&gt;Mdl, <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(FaultingAddress), <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01419     ReadBlockLocal-&gt;Mdl.MdlFlags |= (<a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>);
01420 
01421     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(PointerPte)) {
01422         WorkingSetIndex = 1;
01423     } <span class="keywordflow">else</span> {
01424         WorkingSetIndex = <a class="code" href="../../d8/d2/pagfault_8c.html#a3">MI_PROTOTYPE_WSINDEX</a>;
01425     }
01426 
01427     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
01428 
01429     ReadBlockLocal-&gt;Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01430     ReadBlockLocal-&gt;Page[0] = PageFrameIndex;
01431 
01432     <a class="code" href="../../d8/d2/pagfault_8c.html#a23">MiInitializeReadInProgressPfn</a> (
01433                            &amp;ReadBlockLocal-&gt;Mdl,
01434                            PointerPte,
01435                            &amp;ReadBlockLocal-&gt;Event,
01436                            WorkingSetIndex);
01437 
01438     <a class="code" href="../../d4/d8/mi_8h.html#a176">MI_RETRIEVE_USED_PAGETABLE_ENTRIES_FROM_PTE</a> (ReadBlockLocal, &amp;TempPte);
01439 
01440     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01441 
01442     <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a0">STATUS_ISSUE_PAGING_IO</a>;
01443 }
01444 
01445 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01446"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a15">01446</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a15">MiResolveProtoPteFault</a> (
01447     IN BOOLEAN StoreInstruction,
01448     IN PVOID FaultingAddress,
01449     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01450     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
01451     OUT <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> *ReadBlock,
01452     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
01453     OUT PLOGICAL ApcNeeded
01454     )
01455 
01456 <span class="comment">/*++</span>
01457 <span class="comment"></span>
01458 <span class="comment">Routine Description:</span>
01459 <span class="comment"></span>
01460 <span class="comment">    This routine resolves a prototype PTE fault.</span>
01461 <span class="comment"></span>
01462 <span class="comment">Arguments:</span>
01463 <span class="comment"></span>
01464 <span class="comment">    StoreInstruction - Supplies TRUE if the instruction is trying</span>
01465 <span class="comment">                       to modify the faulting address (i.e. write</span>
01466 <span class="comment">                       access required).</span>
01467 <span class="comment"></span>
01468 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
01469 <span class="comment"></span>
01470 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
01471 <span class="comment"></span>
01472 <span class="comment">    PointerProtoPte - Supplies a pointer to the prototype PTE to fault in.</span>
01473 <span class="comment"></span>
01474 <span class="comment">    ReadBlock - Supplies a pointer to put the address of the read block which</span>
01475 <span class="comment">                needs to be completed before an I/O can be issued.</span>
01476 <span class="comment"></span>
01477 <span class="comment">    Process - Supplies a pointer to the process object.  If this</span>
01478 <span class="comment">              parameter is NULL, then the fault is for system</span>
01479 <span class="comment">              space and the process's working set lock is not held.</span>
01480 <span class="comment"></span>
01481 <span class="comment">    ApcNeeded - Supplies a pointer to a location set to TRUE if an I/O</span>
01482 <span class="comment">                completion APC is needed to complete partial IRPs that</span>
01483 <span class="comment">                collided.</span>
01484 <span class="comment"></span>
01485 <span class="comment">Return Value:</span>
01486 <span class="comment"></span>
01487 <span class="comment">    status, either STATUS_SUCCESS, STATUS_REFAULT, or an I/O status</span>
01488 <span class="comment">    code.</span>
01489 <span class="comment"></span>
01490 <span class="comment">Environment:</span>
01491 <span class="comment"></span>
01492 <span class="comment">    Kernel mode, PFN lock held.</span>
01493 <span class="comment"></span>
01494 <span class="comment">--*/</span>
01495 {
01496     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01497     PFN_NUMBER PageFrameIndex;
01498     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01499     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01500     ULONG CopyOnWrite;
01501     LOGICAL PfnHeld;
01502 
01503     PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01504 
01505     <span class="comment">//</span>
01506     <span class="comment">// Acquire the PFN database mutex as the routine to locate a working</span>
01507     <span class="comment">// set entry decrements the share count of PFN elements.</span>
01508     <span class="comment">//</span>
01509 
01510     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01511 
01512 <span class="preprocessor">#if DBG</span>
01513 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
01514         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:actual fault %p va %p\n"</span>,PointerPte, FaultingAddress);
01515         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01516     }
01517 <span class="preprocessor">#endif //DBG</span>
01518 <span class="preprocessor"></span>
01519     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 1);
01520     TempPte = *PointerProtoPte;
01521 
01522     <span class="comment">//</span>
01523     <span class="comment">// The page containing the prototype PTE is resident,</span>
01524     <span class="comment">// handle the fault referring to the prototype PTE.</span>
01525     <span class="comment">// If the prototype PTE is already valid, make this</span>
01526     <span class="comment">// PTE valid and up the share count etc.</span>
01527     <span class="comment">//</span>
01528 
01529     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid) {
01530 
01531         <span class="comment">//</span>
01532         <span class="comment">// Prototype PTE is valid.</span>
01533         <span class="comment">//</span>
01534 
01535         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
01536         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01537         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01538         status = STATUS_SUCCESS;
01539 
01540         <span class="comment">//</span>
01541         <span class="comment">// Count this as a transition fault.</span>
01542         <span class="comment">//</span>
01543 
01544         <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o2">TransitionCount</a> += 1;
01545         PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01546 
01547         <a class="code" href="../../d2/d1/mm_8h.html#a93">PERFINFO_SOFTFAULT</a>(Pfn1, FaultingAddress, PERFINFO_LOG_TYPE_ADDVALIDPAGETOWS)
01548 
01549     } <span class="keywordflow">else</span> {
01550 
01551         <span class="comment">//</span>
01552         <span class="comment">// Check to make sure the prototype PTE is committed.</span>
01553         <span class="comment">//</span>
01554 
01555         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01556 
01557 <span class="preprocessor">#if DBG</span>
01558 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) {
01559                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access vio2 - %p\n"</span>,FaultingAddress);
01560                 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01561                 DbgBreakPoint();
01562             }
01563 <span class="preprocessor">#endif //DEBUG</span>
01564 <span class="preprocessor"></span>
01565             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01566             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01567         }
01568 
01569         <span class="comment">//</span>
01570         <span class="comment">// If the PTE indicates that the protection field to be</span>
01571         <span class="comment">// checked is in the prototype PTE, check it now.</span>
01572         <span class="comment">//</span>
01573 
01574         CopyOnWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01575 
01576         <span class="keywordflow">if</span> (PointerPte-&gt;u.Soft.PageFileHigh != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01577             <span class="keywordflow">if</span> (PointerPte-&gt;u.Proto.ReadOnly == 0) {
01578 
01579                 <span class="comment">//</span>
01580                 <span class="comment">// Check for kernel mode access, we have already verified</span>
01581                 <span class="comment">// that the user has access to the virtual address.</span>
01582                 <span class="comment">//</span>
01583 
01584 <span class="preprocessor">#if 0 // removed this assert since mapping drivers via MmMapViewInSystemSpace</span>
01585 <span class="preprocessor"></span>      <span class="comment">// file violates the assert.</span>
01586 
01587                 {
01588                     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Sub;
01589                     <span class="keywordflow">if</span> (PointerProtoPte-&gt;u.Soft.Prototype == 1) {
01590                         Sub = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (PointerProtoPte);
01591                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Sub-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection ==
01592                                     PointerProtoPte-&gt;u.Soft.Protection);
01593                     }
01594                 }
01595 
01596 <span class="preprocessor">#endif //DBG</span>
01597 <span class="preprocessor"></span>
01598                 status = <a class="code" href="../../d4/d8/mi_8h.html#a833">MiAccessCheck</a> (PointerProtoPte,
01599                                         StoreInstruction,
01600                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01601                                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a> (PointerProtoPte),
01602                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01603 
01604                 <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01605 <span class="preprocessor">#if DBG</span>
01606 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) {
01607                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access vio3 - %p\n"</span>,FaultingAddress);
01608                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01609                         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerProtoPte);
01610                         DbgBreakPoint();
01611                     }
01612 <span class="preprocessor">#endif</span>
01613 <span class="preprocessor"></span>                    <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01614                     <span class="keywordflow">return</span> status;
01615                 }
01616                 <span class="keywordflow">if</span> ((PointerProtoPte-&gt;u.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) ==
01617                      <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) {
01618                     CopyOnWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01619                 }
01620             }
01621         } <span class="keywordflow">else</span> {
01622             <span class="keywordflow">if</span> ((PointerPte-&gt;u.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) ==
01623                  <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) {
01624                 CopyOnWrite = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01625             }
01626         }
01627 
01628         <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a>(TempPte)) &amp;&amp; (CopyOnWrite)) {
01629 
01630             <span class="comment">//</span>
01631             <span class="comment">// The prototype PTE is demand zero and copy on</span>
01632             <span class="comment">// write.  Make this PTE a private demand zero PTE.</span>
01633             <span class="comment">//</span>
01634 
01635             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01636 
01637             PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01638 
01639             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01640 
01641             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (FaultingAddress,
01642                                                PointerPte,
01643                                                Process,
01644                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01645             <span class="keywordflow">return</span> status;
01646         }
01647 
01648         <span class="comment">//</span>
01649         <span class="comment">// Make the prototype PTE valid, the prototype PTE is in</span>
01650         <span class="comment">// one of 4 case:</span>
01651         <span class="comment">//   demand zero</span>
01652         <span class="comment">//   transition</span>
01653         <span class="comment">//   paging file</span>
01654         <span class="comment">//   mapped file</span>
01655         <span class="comment">//</span>
01656 
01657         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01658 
01659             <span class="comment">//</span>
01660             <span class="comment">// Mapped File.</span>
01661             <span class="comment">//</span>
01662 
01663             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a16">MiResolveMappedFileFault</a> (FaultingAddress,
01664                                                PointerProtoPte,
01665                                                ReadBlock,
01666                                                Process);
01667 
01668             <span class="comment">//</span>
01669             <span class="comment">// Returns with PFN lock held.</span>
01670             <span class="comment">//</span>
01671 
01672             PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01673 
01674         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
01675 
01676             <span class="comment">//</span>
01677             <span class="comment">// Transition.</span>
01678             <span class="comment">//</span>
01679 
01680             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a13">MiResolveTransitionFault</a> (FaultingAddress,
01681                                               PointerProtoPte,
01682                                               Process,
01683                                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01684                                               ApcNeeded);
01685 
01686             <span class="comment">//</span>
01687             <span class="comment">// Returns with PFN lock held.</span>
01688             <span class="comment">//</span>
01689 
01690             PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01691 
01692         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == 0) {
01693 
01694             <span class="comment">//</span>
01695             <span class="comment">// Demand Zero</span>
01696             <span class="comment">//</span>
01697 
01698             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (FaultingAddress,
01699                                                PointerProtoPte,
01700                                                Process,
01701                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01702 
01703             <span class="comment">//</span>
01704             <span class="comment">// Returns with PFN lock held!</span>
01705             <span class="comment">//</span>
01706 
01707             PfnHeld = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01708 
01709         } <span class="keywordflow">else</span> {
01710 
01711             <span class="comment">//</span>
01712             <span class="comment">// Paging file.</span>
01713             <span class="comment">//</span>
01714 
01715             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a14">MiResolvePageFileFault</a> (FaultingAddress,
01716                                              PointerProtoPte,
01717                                              ReadBlock,
01718                                              Process);
01719 
01720             <span class="comment">//</span>
01721             <span class="comment">// Returns with PFN lock released.</span>
01722             <span class="comment">//</span>
01723             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01724         }
01725     }
01726 
01727     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01728 
01729         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 0);
01730 
01731         <a class="code" href="../../d8/d2/pagfault_8c.html#a10">MiCompleteProtoPteFault</a> (StoreInstruction,
01732                                  FaultingAddress,
01733                                  PointerPte,
01734                                  PointerProtoPte);
01735 
01736     } <span class="keywordflow">else</span> {
01737 
01738         <span class="keywordflow">if</span> (PfnHeld) {
01739             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01740         }
01741 
01742         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01743 
01744         <span class="comment">//</span>
01745         <span class="comment">// Stop high priority threads from consuming the CPU on collided</span>
01746         <span class="comment">// faults for pages that are still marked with inpage errors.  All</span>
01747         <span class="comment">// the threads must let go of the page so it can be freed and the</span>
01748         <span class="comment">// inpage I/O reissued to the filesystem.</span>
01749         <span class="comment">//</span>
01750     
01751         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(status)) {
01752             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, (PLARGE_INTEGER)&amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
01753             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
01754         }
01755     }
01756 
01757     <span class="keywordflow">return</span> status;
01758 }
01759 
01760 
01761 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01762"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a10">01762</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a10">MiCompleteProtoPteFault</a> (
01763     IN BOOLEAN StoreInstruction,
01764     IN PVOID FaultingAddress,
01765     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01766     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte
01767     )
01768 
01769 <span class="comment">/*++</span>
01770 <span class="comment"></span>
01771 <span class="comment">Routine Description:</span>
01772 <span class="comment"></span>
01773 <span class="comment">    This routine completes a prototype PTE fault.  It is invoked</span>
01774 <span class="comment">    after a read operation has completed bringing the data into</span>
01775 <span class="comment">    memory.</span>
01776 <span class="comment"></span>
01777 <span class="comment">Arguments:</span>
01778 <span class="comment"></span>
01779 <span class="comment">    StoreInstruction - Supplies TRUE if the instruction is trying</span>
01780 <span class="comment">                       to modify the faulting address (i.e. write</span>
01781 <span class="comment">                       access required).</span>
01782 <span class="comment"></span>
01783 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
01784 <span class="comment"></span>
01785 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
01786 <span class="comment"></span>
01787 <span class="comment">    PointerProtoPte - Supplies a pointer to the prototype PTE to fault in,</span>
01788 <span class="comment">                      NULL if no prototype PTE exists.</span>
01789 <span class="comment"></span>
01790 <span class="comment">Return Value:</span>
01791 <span class="comment"></span>
01792 <span class="comment">    status.</span>
01793 <span class="comment"></span>
01794 <span class="comment">Environment:</span>
01795 <span class="comment"></span>
01796 <span class="comment">    Kernel mode, PFN lock held.</span>
01797 <span class="comment"></span>
01798 <span class="comment">--*/</span>
01799 {
01800     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01801     <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> ProtoProtect;
01802     PFN_NUMBER PageFrameIndex;
01803     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01804     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
01805     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ContainingPageTablePointer;
01806 <span class="preprocessor">#if defined(_PREFETCH_)</span>
01807 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
01808     LONGLONG FileOffset;
01809     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
01810 <span class="preprocessor">#endif</span>
01811 <span class="preprocessor"></span>
01812     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
01813 
01814     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerProtoPte);
01815     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageFrameIndex);
01816     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
01817 
01818 <span class="preprocessor">#if defined(_PREFETCH_)</span>
01819 <span class="preprocessor"></span>
01820     <span class="comment">//</span>
01821     <span class="comment">// Capture prefetch fault information.</span>
01822     <span class="comment">//</span>
01823 
01824     FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01825 
01826     <span class="keywordflow">if</span> (CCPF_IS_PREFETCHER_ACTIVE()) {
01827 
01828         <span class="keywordflow">if</span> (FaultingAddress &lt; MM_HIGHEST_USER_ADDRESS) {
01829 
01830             TempPte = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>;
01831 
01832             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
01833 
01834                 Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;TempPte);
01835     
01836                 <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) {
01837                 
01838                     FileObject = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
01839                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length &gt; 0);
01840     
01841                     FileOffset = <a class="code" href="../../d4/d8/mi_8h.html#a93">MI_STARTING_OFFSET</a> (Subsection,
01842                                                      PointerProtoPte);
01843                 }
01844             }
01845         }
01846     }
01847 
01848 <span class="preprocessor">#endif</span>
01849 <span class="preprocessor"></span>
01850     <span class="comment">//</span>
01851     <span class="comment">// Prototype PTE is now valid, make the PTE valid.</span>
01852     <span class="comment">//</span>
01853 
01854     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerProtoPte-&gt;u.Hard.Valid == 1);
01855 
01856     <span class="comment">//</span>
01857     <span class="comment">// A PTE just went from not present, not transition to</span>
01858     <span class="comment">// present.  The share count and valid count must be</span>
01859     <span class="comment">// updated in the page table page which contains this</span>
01860     <span class="comment">// PTE.</span>
01861     <span class="comment">//</span>
01862 
01863     ContainingPageTablePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
01864     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(ContainingPageTablePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01865     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
01866 
01867     ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = 0;
01868     <span class="keywordflow">if</span> (PointerPte-&gt;u.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01869 
01870         <span class="comment">//</span>
01871         <span class="comment">// The protection code for the prototype PTE comes from this</span>
01872         <span class="comment">// PTE.</span>
01873         <span class="comment">//</span>
01874 
01875         ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(PointerPte);
01876 
01877     } <span class="keywordflow">else</span> {
01878 
01879         <span class="comment">//</span>
01880         <span class="comment">// Take the protection from the prototype PTE.</span>
01881         <span class="comment">//</span>
01882 
01883         ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01884         ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.SameProtectAsProto = 1;
01885 
01886         <span class="keywordflow">if</span> (StoreInstruction == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; (ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a51">MM_PROTECTION_WRITE_MASK</a>) == 0) {
01887 
01888             <span class="comment">//</span>
01889             <span class="comment">// This is the errant case where the user is trying to write</span>
01890             <span class="comment">// to a readonly subsection in the image.  Since we're more than</span>
01891             <span class="comment">// halfway through the fault, take the easy way to clean this up -</span>
01892             <span class="comment">// treat the access as a read for the rest of this trip through</span>
01893             <span class="comment">// the fault.  We'll then immediately refault when the instruction</span>
01894             <span class="comment">// is rerun (because it's really a write), and then we'll notice</span>
01895             <span class="comment">// that the user's PTE is not copy-on-write (or even writable!)</span>
01896             <span class="comment">// and return a clean access violation.</span>
01897             <span class="comment">//</span>
01898 
01899 <span class="preprocessor">#if DBG</span>
01900 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: user tried to write to a readonly subsection in the image! %p %p %p\n"</span>,
01901                 FaultingAddress,
01902                 PointerPte,
01903                 PointerProtoPte);
01904 <span class="preprocessor">#endif</span>
01905 <span class="preprocessor"></span>            StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01906         }
01907     }
01908 
01909     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01910                        PageFrameIndex,
01911                        ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection,
01912                        PointerPte);
01913 
01914     <span class="comment">//</span>
01915     <span class="comment">// If this is a store instruction and the page is not copy on</span>
01916     <span class="comment">// write, then set the modified bit in the PFN database and</span>
01917     <span class="comment">// the dirty bit in the PTE.  The PTE is not set dirty even</span>
01918     <span class="comment">// if the modified bit is set so writes to the page can be</span>
01919     <span class="comment">// tracked for FlushVirtualMemory.</span>
01920     <span class="comment">//</span>
01921 
01922     <span class="keywordflow">if</span> ((StoreInstruction) &amp;&amp; (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0)) {
01923 
01924 <span class="preprocessor">#if DBG</span>
01925 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01926 
01927             PVOID Va;
01928 
01929             Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01930 
01931             <span class="comment">//</span>
01932             <span class="comment">// Session space backed by the filesystem should not be writable.</span>
01933             <span class="comment">//</span>
01934 
01935             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (Va));
01936         }
01937 <span class="preprocessor">#endif</span>
01938 <span class="preprocessor"></span>
01939         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01940         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01941         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01942                       (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01943              <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01944              Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
01945         }
01946     }
01947 
01948     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01949 
01950     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01951         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01952     }
01953 
01954     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01955 
01956     <a class="code" href="../../d2/d1/mm_8h.html#a93">PERFINFO_SOFTFAULT</a>(Pfn1, FaultingAddress, PERFINFO_LOG_TYPE_PROTOPTEFAULT);
01957 
01958     <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (FaultingAddress,
01959                                 PointerPte,
01960                                 Pfn1,
01961                                 (ULONG) ProtoProtect.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long);
01962 
01963 <span class="preprocessor">#if defined(_PREFETCH_)</span>
01964 <span class="preprocessor"></span>
01965     <span class="comment">//</span>
01966     <span class="comment">// Log prefetch fault information now that thw PFN lock has been released</span>
01967     <span class="comment">// and the PTE has been made valid.  This minimizes PFN lock contention,</span>
01968     <span class="comment">// allows CcPfLogPageFault to allocate (and fault on) pool, and allows other</span>
01969     <span class="comment">// threads in this process to execute without faulting on this address.</span>
01970     <span class="comment">//</span>
01971     <span class="comment">// Note that the process' working set mutex is still held so any other</span>
01972     <span class="comment">// faults or operations on user addresses by other threads in this process</span>
01973     <span class="comment">// will block for the duration of this call.</span>
01974     <span class="comment">//</span>
01975         
01976     <span class="keywordflow">if</span> (FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01977         CcPfLogPageFault (FileObject, FileOffset, <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>());
01978     }
01979 
01980 <span class="preprocessor">#endif</span>
01981 <span class="preprocessor"></span>
01982     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(FaultingAddress));
01983 
01984     <span class="keywordflow">return</span> STATUS_SUCCESS;
01985 }
01986 
01987 
01988 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01989"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a16">01989</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a16">MiResolveMappedFileFault</a> (
01990     IN PVOID FaultingAddress,
01991     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01992     OUT <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> *ReadBlock,
01993     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01994     )
01995 
01996 <span class="comment">/*++</span>
01997 <span class="comment"></span>
01998 <span class="comment">Routine Description:</span>
01999 <span class="comment"></span>
02000 <span class="comment">    This routine builds the MDL and other structures to allow a</span>
02001 <span class="comment">    read operation on a mapped file for a page fault.</span>
02002 <span class="comment"></span>
02003 <span class="comment">Arguments:</span>
02004 <span class="comment"></span>
02005 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
02006 <span class="comment"></span>
02007 <span class="comment">    PointerPte - Supplies the PTE for the faulting address.</span>
02008 <span class="comment"></span>
02009 <span class="comment">    ReadBlock - Supplies a pointer to put the address of the read block which</span>
02010 <span class="comment">                needs to be completed before an I/O can be issued.</span>
02011 <span class="comment"></span>
02012 <span class="comment">    Process - Supplies a pointer to the process object.  If this</span>
02013 <span class="comment">              parameter is NULL, then the fault is for system</span>
02014 <span class="comment">              space and the process's working set lock is not held.</span>
02015 <span class="comment"></span>
02016 <span class="comment">Return Value:</span>
02017 <span class="comment"></span>
02018 <span class="comment">    status.  A status value of STATUS_ISSUE_PAGING_IO is returned</span>
02019 <span class="comment">    if this function completes successfully.</span>
02020 <span class="comment"></span>
02021 <span class="comment">Environment:</span>
02022 <span class="comment"></span>
02023 <span class="comment">    Kernel mode, PFN lock held.</span>
02024 <span class="comment"></span>
02025 <span class="comment">--*/</span>
02026 
02027 {
02028     PFN_NUMBER PageFrameIndex;
02029     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02030     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02031     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
02032     ULONG ReadSize;
02033     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
02034     PPFN_NUMBER Page;
02035     PPFN_NUMBER EndPage;
02036     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
02037     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CheckPte;
02038     LARGE_INTEGER StartingOffset;
02039     LARGE_INTEGER TempOffset;
02040     PPFN_NUMBER FirstMdlPage;
02041     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> ReadBlockLocal;
02042     ULONG PageColor;
02043     ULONG ClusterSize;
02044     ULONG Result;
02045 
02046     ClusterSize = 0;
02047 
02048     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Soft.Prototype == 1);
02049 
02050     <span class="comment">// *********************************************</span>
02051     <span class="comment">//   Mapped File (subsection format)</span>
02052     <span class="comment">// *********************************************</span>
02053 
02054     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
02055         Result = <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, FaultingAddress);
02056     }
02057     <span class="keywordflow">else</span> {
02058         Result = <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (Process, FaultingAddress);
02059     }
02060 
02061     <span class="keywordflow">if</span> (Result) {
02062 
02063         <span class="comment">//</span>
02064         <span class="comment">// A wait operation was performed which dropped the locks,</span>
02065         <span class="comment">// repeat this fault.</span>
02066         <span class="comment">//</span>
02067 
02068         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02069     }
02070 
02071 <span class="preprocessor">#if DBG</span>
02072 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
02073         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a> (PointerPte);
02074     }
02075 <span class="preprocessor">#endif //DBG</span>
02076 <span class="preprocessor"></span>
02077     <span class="comment">//</span>
02078     <span class="comment">// Calculate address of subsection for this prototype PTE.</span>
02079     <span class="comment">//</span>
02080 
02081     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (PointerPte);
02082 
02083 <span class="preprocessor">#ifdef LARGE_PAGES</span>
02084 <span class="preprocessor"></span>
02085     <span class="comment">//</span>
02086     <span class="comment">// Check to see if this subsection maps a large page, if</span>
02087     <span class="comment">// so, just fill the TB and return a status of PTE_CHANGED.</span>
02088     <span class="comment">//</span>
02089 
02090     <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages == 1) {
02091         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02092         KeFillLargeEntryTb ((PHARDWARE_PTE)(Subsection + 1),
02093                              FaultingAddress,
02094                              Subsection-&gt;StartingSector);
02095 
02096         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02097     }
02098 <span class="preprocessor">#endif //LARGE_PAGES</span>
02099 <span class="preprocessor"></span>
02100     <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.FailAllIo) {
02101         <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR;
02102     }
02103 
02104     <span class="keywordflow">if</span> (PointerPte &gt;= &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>]) {
02105 
02106         <span class="comment">//</span>
02107         <span class="comment">// Attempt to read past the end of this subsection.</span>
02108         <span class="comment">//</span>
02109 
02110         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
02111     }
02112 
02113     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02114 
02115     ReadBlockLocal = <a class="code" href="../../d8/d2/pagfault_8c.html#a29">MiGetInPageSupportBlock</a> ();
02116     <span class="keywordflow">if</span> (ReadBlockLocal == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02117         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02118     }
02119     *ReadBlock = ReadBlockLocal;
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// Build MDL for request.</span>
02123     <span class="comment">//</span>
02124 
02125     Mdl = &amp;ReadBlockLocal-&gt;Mdl;
02126 
02127     FirstMdlPage = &amp;ReadBlockLocal-&gt;Page[0];
02128     Page = FirstMdlPage;
02129 
02130 <span class="preprocessor">#if DBG</span>
02131 <span class="preprocessor"></span>    RtlFillMemoryUlong( Page, (<a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a>+1) * <span class="keyword">sizeof</span>(PFN_NUMBER), 0xf1f1f1f1);
02132 <span class="preprocessor">#endif //DBG</span>
02133 <span class="preprocessor"></span>
02134     ReadSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02135     BasePte = PointerPte;
02136 
02137     <span class="comment">//</span>
02138     <span class="comment">// Should we attempt to perform page fault clustering?</span>
02139     <span class="comment">//</span>
02140 
02141     <span class="keywordflow">if</span> ((!CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o23">DisablePageFaultClustering</a>) &amp;&amp;
02142         <a class="code" href="../../d2/d1/mm_8h.html#a125">PERFINFO_DO_PAGEFAULT_CLUSTERING</a>() &amp;&amp;
02143         (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting == 0)) {
02144 
02145         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> * 2))
02146                  ||
02147          (((Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image != 0) ||
02148             (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a>)) &amp;&amp;
02149          (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a> + 16)))) {
02150 
02151             <span class="comment">//</span>
02152             <span class="comment">// Cluster up to n pages.  This one + n-1.</span>
02153             <span class="comment">//</span>
02154 
02155             <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image == 0) {
02156                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o21">ReadClusterSize</a> &lt;=
02157                             <a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a>);
02158                 ClusterSize = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o21">ReadClusterSize</a>;
02159             } <span class="keywordflow">else</span> {
02160                 ClusterSize = <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a>;
02161                 <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection &amp;
02162                                             <a class="code" href="../../d4/d8/mi_8h.html#a54">MM_PROTECTION_EXECUTE_MASK</a> ) {
02163                     ClusterSize = <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a>;
02164                 }
02165             }
02166             EndPage = Page + ClusterSize;
02167 
02168             CheckPte = PointerPte + 1;
02169 
02170             <span class="comment">//</span>
02171             <span class="comment">// Try to cluster within the page of PTEs.</span>
02172             <span class="comment">//</span>
02173 
02174             <span class="keywordflow">while</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(CheckPte) == 0) &amp;&amp;
02175                (Page &lt; EndPage) &amp;&amp;
02176                (CheckPte &lt;
02177                  &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>])
02178                       &amp;&amp; (CheckPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == BasePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)) {
02179 
02180                 Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
02181                 ReadSize += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02182                 Page += 1;
02183                 CheckPte += 1;
02184             }
02185 
02186             <span class="keywordflow">if</span> ((Page &lt; EndPage) &amp;&amp; (!CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o22">ForwardClusterOnly</a>)) {
02187 
02188                 <span class="comment">//</span>
02189                 <span class="comment">// Attempt to cluster going backwards from the PTE.</span>
02190                 <span class="comment">//</span>
02191 
02192                 CheckPte = PointerPte - 1;
02193 
02194                 <span class="keywordflow">while</span> ((((ULONG_PTR)CheckPte &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) !=
02195                                             (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))) &amp;&amp;
02196                         (Page &lt; EndPage) &amp;&amp;
02197                          (CheckPte &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>) &amp;&amp;
02198                          (CheckPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == BasePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long)) {
02199 
02200                     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
02201                     ReadSize += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
02202                     Page += 1;
02203                     CheckPte -= 1;
02204                 }
02205                 BasePte = CheckPte + 1;
02206             }
02207         }
02208     }
02209 
02210     <span class="comment">//</span>
02211     <span class="comment">//</span>
02212     <span class="comment">// Calculate the offset to read into the file.</span>
02213     <span class="comment">//  offset = base + ((thispte - basepte) &lt;&lt; PAGE_SHIFT)</span>
02214     <span class="comment">//</span>
02215 
02216     StartingOffset.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection, BasePte);
02217 
02218     TempOffset = <a class="code" href="../../d4/d8/mi_8h.html#a953">MiEndingOffset</a>(Subsection);
02219 
02220     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartingOffset.QuadPart &lt; TempOffset.QuadPart);
02221 
02222     <span class="comment">//</span>
02223     <span class="comment">// Remove pages to fill in the MDL.  This is done here as the</span>
02224     <span class="comment">// base PTE has been determined and can be used for virtual</span>
02225     <span class="comment">// aliasing checks.</span>
02226     <span class="comment">//</span>
02227 
02228     EndPage = FirstMdlPage;
02229     CheckPte = BasePte;
02230 
02231     <span class="keywordflow">while</span> (EndPage &lt; Page) {
02232         <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
02233             PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02234         }
02235         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02236             PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (CheckPte);
02237         }
02238         <span class="keywordflow">else</span> {
02239             PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (CheckPte,
02240                                                    &amp;Process-&gt;NextPageColor);
02241         }
02242         *EndPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02243 
02244         EndPage += 1;
02245         CheckPte += 1;
02246     }
02247 
02248     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
02249         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a126">MI_GET_PAGE_COLOR_FROM_SESSION</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02250     }
02251     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02252         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (CheckPte);
02253     }
02254     <span class="keywordflow">else</span> {
02255         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (CheckPte,
02256                                                &amp;Process-&gt;NextPageColor);
02257     }
02258 
02259     <span class="comment">//</span>
02260     <span class="comment">// Check to see if the read will go past the end of the file,</span>
02261     <span class="comment">// if so, correct the read size and get a zeroed page.</span>
02262     <span class="comment">//</span>
02263 
02264     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o6">PageReadIoCount</a> += 1;
02265     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o5">PageReadCount</a> += ReadSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
02266 
02267     <span class="keywordflow">if</span> ((Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.Image) &amp;&amp;
02268         (((UINT64)StartingOffset.QuadPart + ReadSize) &gt; (UINT64)TempOffset.QuadPart)) {
02269 
02270         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ULONG)(TempOffset.QuadPart - StartingOffset.QuadPart)
02271                 &gt; (ReadSize - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
02272 
02273         ReadSize = (ULONG)(TempOffset.QuadPart - StartingOffset.QuadPart);
02274 
02275         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (PageColor);
02276 
02277     } <span class="keywordflow">else</span> {
02278 
02279         <span class="comment">//</span>
02280         <span class="comment">// We are reading a complete page, no need to get a zeroed page.</span>
02281         <span class="comment">//</span>
02282 
02283         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02284     }
02285 
02286     <span class="comment">//</span>
02287     <span class="comment">// Increment the PFN reference count in the control area for</span>
02288     <span class="comment">// the subsection (PFN MUTEX is required to modify this field).</span>
02289     <span class="comment">//</span>
02290 
02291     Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a> += 1;
02292     *Page = PageFrameIndex;
02293 
02294     PageFrameIndex = *(FirstMdlPage + (PointerPte - BasePte));
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">// Get a page and put the PTE into the transition state with the</span>
02298     <span class="comment">// read-in-progress flag set.</span>
02299     <span class="comment">//</span>
02300 
02301     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02302 
02303     <span class="comment">//</span>
02304     <span class="comment">// Initialize MDL for request.</span>
02305     <span class="comment">//</span>
02306 
02307     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>(Mdl,
02308                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (BasePte),
02309                     ReadSize);
02310     Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= (<a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a18">MDL_IO_PAGE_READ</a>);
02311 
02312 <span class="preprocessor">#if DBG</span>
02313 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ReadSize &gt; ((ClusterSize + 1) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
02314         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT, 0x777,(ULONG_PTR)Mdl, (ULONG_PTR)Subsection,
02315                         (ULONG)TempOffset.LowPart);
02316     }
02317 <span class="preprocessor">#endif //DBG</span>
02318 <span class="preprocessor"></span>
02319     <a class="code" href="../../d8/d2/pagfault_8c.html#a23">MiInitializeReadInProgressPfn</a> (Mdl,
02320                                    BasePte,
02321                                    &amp;ReadBlockLocal-&gt;Event,
02322                                    <a class="code" href="../../d8/d2/pagfault_8c.html#a3">MI_PROTOTYPE_WSINDEX</a>);
02323 
02324     <a class="code" href="../../d4/d8/mi_8h.html#a177">MI_ZERO_USED_PAGETABLE_ENTRIES_IN_INPAGE_SUPPORT</a>(ReadBlockLocal);
02325 
02326     ReadBlockLocal-&gt;ReadOffset = StartingOffset;
02327     ReadBlockLocal-&gt;FilePointer = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>;
02328     ReadBlockLocal-&gt;BasePte = BasePte;
02329     ReadBlockLocal-&gt;Pfn = Pfn1;
02330 
02331     <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a0">STATUS_ISSUE_PAGING_IO</a>;
02332 }
02333 
02334 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02335"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a17">02335</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a17">MiWaitForInPageComplete</a> (
02336     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2,
02337     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02338     IN PVOID FaultingAddress,
02339     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPteContents,
02340     IN <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> InPageSupport,
02341     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
02342     )
02343 
02344 <span class="comment">/*++</span>
02345 <span class="comment"></span>
02346 <span class="comment">Routine Description:</span>
02347 <span class="comment"></span>
02348 <span class="comment">    Waits for a page read to complete.</span>
02349 <span class="comment"></span>
02350 <span class="comment">Arguments:</span>
02351 <span class="comment"></span>
02352 <span class="comment">    Pfn - Supplies a pointer to the PFN element for the page being read.</span>
02353 <span class="comment"></span>
02354 <span class="comment">    PointerPte - Supplies a pointer to the pte that is in the transition</span>
02355 <span class="comment">                 state.</span>
02356 <span class="comment"></span>
02357 <span class="comment">    FaultingAddress - Supplies the faulting address.</span>
02358 <span class="comment"></span>
02359 <span class="comment">    PointerPteContents - Supplies the contents of the PTE before the</span>
02360 <span class="comment">                         working set lock was released.</span>
02361 <span class="comment"></span>
02362 <span class="comment">    InPageSupport - Supplies a pointer to the inpage support structure</span>
02363 <span class="comment">                    for this read operation.</span>
02364 <span class="comment"></span>
02365 <span class="comment">Return Value:</span>
02366 <span class="comment"></span>
02367 <span class="comment">    Returns the status of the in page.</span>
02368 <span class="comment"></span>
02369 <span class="comment">    Note that the working set lock is held upon return !!!</span>
02370 <span class="comment"></span>
02371 <span class="comment">Environment:</span>
02372 <span class="comment"></span>
02373 <span class="comment">    Kernel mode, APCs disabled.  Neither the working set lock nor</span>
02374 <span class="comment">    the PFN lock may be held.</span>
02375 <span class="comment"></span>
02376 <span class="comment">--*/</span>
02377 
02378 {
02379     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NewPointerPte;
02380     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
02381     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02382     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
02383     PULONG Va;
02384     PPFN_NUMBER Page;
02385     PPFN_NUMBER LastPage;
02386     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
02387     ULONG Protection;
02388     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
02389     KIRQL OldIrql;
02390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02391     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status2;
02392 
02393     <span class="comment">//</span>
02394     <span class="comment">// Wait for the I/O to complete.  Note that we can't wait for all</span>
02395     <span class="comment">// the objects simultaneously as other threads/processes could be</span>
02396     <span class="comment">// waiting for the same event.  The first thread which completes</span>
02397     <span class="comment">// the wait and gets the PFN mutex may reuse the event for another</span>
02398     <span class="comment">// fault before this thread completes its wait.</span>
02399     <span class="comment">//</span>
02400 
02401     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;InPageSupport-&gt;Event,
02402                            <a class="code" href="../../d4/d9/ke_8h.html#a407a207">WrPageIn</a>,
02403                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02404                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02405                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02406 
02407     <span class="keywordflow">if</span> (CurrentProcess == <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>) {
02408         <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
02409     }
02410     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentProcess != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02411         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
02412     }
02413     <span class="keywordflow">else</span> {
02414         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
02415     }
02416 
02417     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02418 
02419     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;u3.e2.ReferenceCount != 0);
02420 
02421     <span class="comment">//</span>
02422     <span class="comment">// Check to see if this is the first thread to complete the in-page</span>
02423     <span class="comment">// operation.</span>
02424     <span class="comment">//</span>
02425 
02426     Pfn = InPageSupport-&gt;Pfn;
02427     <span class="keywordflow">if</span> (Pfn2 != Pfn) {
02428         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;PteFrame != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
02429         Pfn2-&gt;u3.e1.ReadInProgress = 0;
02430     }
02431 
02432     <span class="comment">//</span>
02433     <span class="comment">// Another thread has already serviced the read, check the</span>
02434     <span class="comment">// io-error flag in the PFN database to ensure the in-page</span>
02435     <span class="comment">// was successful.</span>
02436     <span class="comment">//</span>
02437 
02438     <span class="keywordflow">if</span> (Pfn2-&gt;u3.e1.InPageError == 1) {
02439         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Pfn2-&gt;u1.ReadStatus));
02440         <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (InPageSupport);
02441 
02442         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(Pfn2-&gt;u1.ReadStatus)) {
02443             <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02444         }
02445         <span class="keywordflow">return</span> Pfn2-&gt;u1.ReadStatus;
02446     }
02447 
02448     <span class="keywordflow">if</span> (InPageSupport-&gt;Completed == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02449 
02450 <span class="preprocessor">#if defined(_PREFETCH_)</span>
02451 <span class="preprocessor"></span>
02452         <span class="comment">//</span>
02453         <span class="comment">// The ReadInProgress bit for the dummy page is constantly cleared</span>
02454         <span class="comment">// below as there are generally multiple inpage blocks pointing to</span>
02455         <span class="comment">// the same dummy page.</span>
02456         <span class="comment">//</span>
02457 
02458         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 1) ||
02459                 (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> == MI_PF_DUMMY_PAGE_PTE));
02460 <span class="preprocessor">#else</span>
02461 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 1);
02462 <span class="preprocessor">#endif</span>
02463 <span class="preprocessor"></span>
02464         InPageSupport-&gt;Completed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02465 
02466         Mdl = &amp;InPageSupport-&gt;Mdl;
02467 
02468 <span class="preprocessor">#if defined(_PREFETCH_)</span>
02469 <span class="preprocessor"></span>
02470         <span class="keywordflow">if</span> (InPageSupport-&gt;PrefetchMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02471 
02472             <span class="comment">//</span>
02473             <span class="comment">// This is a prefetcher-issued read.</span>
02474             <span class="comment">//</span>
02475 
02476             Mdl = InPageSupport-&gt;PrefetchMdl;
02477         }
02478 
02479 <span class="preprocessor">#endif</span>
02480 <span class="preprocessor"></span>
02481         <span class="keywordflow">if</span> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02482 <span class="preprocessor">#if DBG</span>
02483 <span class="preprocessor"></span>            Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>;
02484 <span class="preprocessor">#endif //DBG</span>
02485 <span class="preprocessor"></span>
02486             <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a>, Mdl);
02487 
02488 <span class="preprocessor">#if DBG</span>
02489 <span class="preprocessor"></span>            Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> &amp;= ~<a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>;
02490 <span class="preprocessor">#endif //DBG</span>
02491 <span class="preprocessor"></span>        }
02492 
02493         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>);
02494 
02495         Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress = 0;
02496         Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02497 
02498 <span class="preprocessor">#if defined (_WIN64)</span>
02499 <span class="preprocessor"></span>        <span class="comment">//</span>
02500         <span class="comment">// Page directory and page table pages are never clustered,</span>
02501         <span class="comment">// ensure this is never violated as only one UsedPageTableEntries</span>
02502         <span class="comment">// is kept in the inpage support block.</span>
02503         <span class="comment">//</span>
02504 
02505         <span class="keywordflow">if</span> (InPageSupport-&gt;UsedPageTableEntries) {
02506             Page = (PPFN_NUMBER)(Mdl + 1);
02507             LastPage = Page + ((Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02508             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Page == LastPage);
02509         }
02510 
02511 <span class="preprocessor">#if DBGXX</span>
02512 <span class="preprocessor"></span>        MiCheckPageTableInPage (Pfn, InPageSupport);
02513 <span class="preprocessor">#endif</span>
02514 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02515 <span class="preprocessor"></span>
02516         <a class="code" href="../../d4/d8/mi_8h.html#a179">MI_INSERT_USED_PAGETABLE_ENTRIES_IN_PFN</a>(Pfn, InPageSupport);
02517 
02518         <span class="comment">//</span>
02519         <span class="comment">// Check the IO_STATUS_BLOCK to ensure the in-page completed successfully.</span>
02520         <span class="comment">//</span>
02521 
02522         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(InPageSupport-&gt;IoStatus.Status)) {
02523 
02524             <span class="keywordflow">if</span> (InPageSupport-&gt;IoStatus.Status == STATUS_END_OF_FILE) {
02525 
02526                 <span class="comment">//</span>
02527                 <span class="comment">// An attempt was made to read past the end of file</span>
02528                 <span class="comment">// zero all the remaining bytes in the read.</span>
02529                 <span class="comment">//</span>
02530 
02531                 Page = (PPFN_NUMBER)(Mdl + 1);
02532                 LastPage = Page + ((Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02533 
02534                 <span class="keywordflow">while</span> (Page &lt;= LastPage) {
02535                     <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (*Page, 0);
02536 
02537                     <a class="code" href="../../d4/d8/mi_8h.html#a178">MI_ZERO_USED_PAGETABLE_ENTRIES_IN_PFN</a>(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(*Page));
02538 
02539                     Page += 1;
02540                 }
02541 
02542             } <span class="keywordflow">else</span> {
02543 
02544                 <span class="comment">//</span>
02545                 <span class="comment">// In page io error occurred.</span>
02546                 <span class="comment">//</span>
02547 
02548                 status = InPageSupport-&gt;IoStatus.Status;
02549                 status2 = InPageSupport-&gt;IoStatus.Status;
02550 
02551                 <span class="keywordflow">if</span> (status != STATUS_VERIFY_REQUIRED) {
02552 
02553                     LOGICAL Retry;
02554 
02555                     Retry = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02556 <span class="preprocessor">#if DBG</span>
02557 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM: inpage I/O error %X\n"</span>,
02558                                     InPageSupport-&gt;IoStatus.Status);
02559 <span class="preprocessor">#endif</span>
02560 <span class="preprocessor"></span>
02561                     <span class="comment">//</span>
02562                     <span class="comment">// If this page is for paged pool or for paged</span>
02563                     <span class="comment">// kernel code or page table pages, bugcheck.</span>
02564                     <span class="comment">//</span>
02565 
02566                     <span class="keywordflow">if</span> ((FaultingAddress &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
02567                         (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(FaultingAddress))) {
02568 
02569                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(status)) {
02570                             
02571                             <a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a> -= 1;
02572                             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a> != 0) {
02573                                 Retry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02574                             } <span class="keywordflow">else</span> {
02575                                 <a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
02576                             }
02577                         }
02578 
02579                         <span class="keywordflow">if</span> (Retry == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02580 
02581                             ULONG_PTR PteContents;
02582     
02583                             <span class="comment">//</span>
02584                             <span class="comment">// The prototype PTE resides in paged pool which may</span>
02585                             <span class="comment">// not be resident at this point.  Check first.</span>
02586                             <span class="comment">//</span>
02587     
02588                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02589                                 PteContents = *(PULONG_PTR)PointerPte;
02590                             }
02591                             <span class="keywordflow">else</span> {
02592                                 PteContents = (ULONG_PTR)-1;
02593                             }
02594     
02595                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (KERNEL_DATA_INPAGE_ERROR,
02596                                           (ULONG_PTR)PointerPte,
02597                                           status,
02598                                           (ULONG_PTR)FaultingAddress,
02599                                           PteContents);
02600                         }
02601                         status2 = <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02602                     }
02603                     <span class="keywordflow">else</span> {
02604 
02605                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a85">MmIsRetryIoStatus</a>(status)) {
02606                             
02607                             <a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a> -= 1;
02608                             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a> != 0) {
02609                                 Retry = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02610                             } <span class="keywordflow">else</span> {
02611                                 <a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a430">MiUserIoRetryLevel</a>;
02612                             }
02613                         }
02614 
02615                         <span class="keywordflow">if</span> (Retry == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02616                             status2 = <a class="code" href="../../d8/d2/pagfault_8c.html#a2">STATUS_REFAULT</a>;
02617                         }
02618                     }
02619                 }
02620 
02621                 Page = (PPFN_NUMBER)(Mdl + 1);
02622                 LastPage = Page + ((Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02623 
02624                 <span class="keywordflow">while</span> (Page &lt;= LastPage) {
02625                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
02626                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
02627                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError = 1;
02628                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.ReadStatus = status;
02629 
02630 <span class="preprocessor">#if DBG</span>
02631 <span class="preprocessor"></span>                    {
02632                         KIRQL Old;
02633                         Va = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (*Page,&amp;Old);
02634                         RtlFillMemoryUlong (Va, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, 0x50444142);
02635                         <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (Old);
02636                     }
02637 <span class="preprocessor">#endif //DBG</span>
02638 <span class="preprocessor"></span>                    Page += 1;
02639                 }
02640 
02641                 <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (InPageSupport);
02642                 <span class="keywordflow">return</span> status2;
02643             }
02644         } <span class="keywordflow">else</span> {
02645 
02646             <a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
02647             <a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a> = <a class="code" href="../../d4/d8/mi_8h.html#a430">MiUserIoRetryLevel</a>;
02648 
02649             <span class="keywordflow">if</span> (InPageSupport-&gt;IoStatus.Information != Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a>) {
02650 
02651                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (InPageSupport-&gt;IoStatus.Information != 0);
02652 
02653                 <span class="comment">//</span>
02654                 <span class="comment">// Less than a full page was read - zero the remainder</span>
02655                 <span class="comment">// of the page.</span>
02656                 <span class="comment">//</span>
02657 
02658                 Page = (PPFN_NUMBER)(Mdl + 1);
02659                 LastPage = Page + ((Mdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02660                 Page += ((InPageSupport-&gt;IoStatus.Information - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02661 
02662                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (InPageSupport-&gt;IoStatus.Information);
02663 
02664                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> != 0) {
02665                     KIRQL Old;
02666                     Va = (PULONG)((PCHAR)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (*Page, &amp;Old)
02667                                 + <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
02668 
02669                     RtlZeroMemory (Va, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>);
02670                     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (Old);
02671                 }
02672 
02673                 <span class="comment">//</span>
02674                 <span class="comment">// Zero any remaining pages within the MDL.</span>
02675                 <span class="comment">//</span>
02676 
02677                 Page += 1;
02678 
02679                 <span class="keywordflow">while</span> (Page &lt;= LastPage) {
02680                     <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (*Page, 0);
02681                     Page += 1;
02682                 }
02683             }
02684         }
02685     }
02686 
02687     <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (InPageSupport);
02688 
02689     <span class="comment">//</span>
02690     <span class="comment">// Check to see if the faulting PTE has changed.</span>
02691     <span class="comment">//</span>
02692 
02693     NewPointerPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a18">MiFindActualFaultingPte</a> (FaultingAddress);
02694 
02695     <span class="comment">//</span>
02696     <span class="comment">// If this PTE is in prototype PTE format, make the pointer to the</span>
02697     <span class="comment">// PTE point to the prototype PTE.</span>
02698     <span class="comment">//</span>
02699 
02700     <span class="keywordflow">if</span> (NewPointerPte == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02701         <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>;
02702     }
02703 
02704     <span class="keywordflow">if</span> (NewPointerPte != PointerPte) {
02705 
02706         <span class="comment">//</span>
02707         <span class="comment">// Check to make sure the NewPointerPte is not a prototype PTE</span>
02708         <span class="comment">// which refers to the page being made valid.</span>
02709         <span class="comment">//</span>
02710 
02711         <span class="keywordflow">if</span> (NewPointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
02712             <span class="keywordflow">if</span> (NewPointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
02713 
02714                 ProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (FaultingAddress,
02715                                                   &amp;Protection);
02716 
02717             } <span class="keywordflow">else</span> {
02718                 ProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (NewPointerPte);
02719             }
02720 
02721             <span class="comment">//</span>
02722             <span class="comment">// Make sure the prototype PTE refers to the PTE made valid.</span>
02723             <span class="comment">//</span>
02724 
02725             <span class="keywordflow">if</span> (ProtoPte != PointerPte) {
02726                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>;
02727             }
02728 
02729             <span class="comment">//</span>
02730             <span class="comment">// If the only difference is the owner mask, everything is okay.</span>
02731             <span class="comment">//</span>
02732 
02733             <span class="keywordflow">if</span> (ProtoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != PointerPteContents-&gt;u.Long) {
02734                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>;
02735             }
02736         } <span class="keywordflow">else</span> {
02737             <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>;
02738         }
02739     } <span class="keywordflow">else</span> {
02740 
02741         <span class="keywordflow">if</span> (NewPointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != PointerPteContents-&gt;u.Long) {
02742             <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a1">STATUS_PTE_CHANGED</a>;
02743         }
02744     }
02745     <span class="keywordflow">return</span> STATUS_SUCCESS;
02746 }
02747 
02748 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
<a name="l02749"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a18">02749</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a18">MiFindActualFaultingPte</a> (
02750     IN PVOID FaultingAddress
02751     )
02752 
02753 <span class="comment">/*++</span>
02754 <span class="comment"></span>
02755 <span class="comment">Routine Description:</span>
02756 <span class="comment"></span>
02757 <span class="comment">    This routine locates the actual PTE which must be made resident in order</span>
02758 <span class="comment">    to complete this fault.  Note that for certain cases multiple faults</span>
02759 <span class="comment">    are required to make the final page resident.</span>
02760 <span class="comment"></span>
02761 <span class="comment">Arguments:</span>
02762 <span class="comment"></span>
02763 <span class="comment">    FaultingAddress - Supplies the virtual address which caused the</span>
02764 <span class="comment">                      fault.</span>
02765 <span class="comment"></span>
02766 <span class="comment">    PointerPte - Supplies the pointer to the PTE which is in prototype</span>
02767 <span class="comment">                 PTE format.</span>
02768 <span class="comment"></span>
02769 <span class="comment"></span>
02770 <span class="comment">Return Value:</span>
02771 <span class="comment"></span>
02772 <span class="comment"></span>
02773 <span class="comment">Environment:</span>
02774 <span class="comment"></span>
02775 <span class="comment">    Kernel mode, APCs disabled, working set mutex held.</span>
02776 <span class="comment"></span>
02777 <span class="comment">--*/</span>
02778 
02779 {
02780     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPteAddress;
02781     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02782     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerFaultingPte;
02783     ULONG Protection;
02784 
02785     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(FaultingAddress)) {
02786         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02787     }
02788 
02789 <span class="preprocessor">#if defined (_WIN64)</span>
02790 <span class="preprocessor"></span>
02791     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (FaultingAddress);
02792 
02793     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02794 
02795         <span class="comment">//</span>
02796         <span class="comment">// Page directory page is not valid.</span>
02797         <span class="comment">//</span>
02798 
02799         <span class="keywordflow">return</span> PointerPte;
02800     }
02801 
02802 <span class="preprocessor">#endif</span>
02803 <span class="preprocessor"></span>
02804     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (FaultingAddress);
02805 
02806     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02807 
02808         <span class="comment">//</span>
02809         <span class="comment">// Page table page is not valid.</span>
02810         <span class="comment">//</span>
02811 
02812         <span class="keywordflow">return</span> PointerPte;
02813     }
02814 
02815     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FaultingAddress);
02816 
02817     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
02818 
02819         <span class="comment">//</span>
02820         <span class="comment">// Page is already valid, no need to fault it in.</span>
02821         <span class="comment">//</span>
02822 
02823         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02824     }
02825 
02826     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) {
02827 
02828         <span class="comment">//</span>
02829         <span class="comment">// Page is not a prototype PTE, make this PTE valid.</span>
02830         <span class="comment">//</span>
02831 
02832         <span class="keywordflow">return</span> PointerPte;
02833     }
02834 
02835     <span class="comment">//</span>
02836     <span class="comment">// Check to see if the PTE which maps the prototype PTE is valid.</span>
02837     <span class="comment">//</span>
02838 
02839     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
02840 
02841         <span class="comment">//</span>
02842         <span class="comment">// Protection is here, PTE must be located in VAD.</span>
02843         <span class="comment">//</span>
02844 
02845         ProtoPteAddress = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (FaultingAddress,
02846                                                     &amp;Protection);
02847 
02848         <span class="keywordflow">if</span> (ProtoPteAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02849 
02850             <span class="comment">//</span>
02851             <span class="comment">// No prototype PTE means another thread has deleted the VAD while</span>
02852             <span class="comment">// this thread waited for the inpage to complete.  Certainly NULL</span>
02853             <span class="comment">// must be returned so a stale PTE is not modified - the instruction</span>
02854             <span class="comment">// will then be reexecuted and an access violation delivered.</span>
02855             <span class="comment">//</span>
02856 
02857             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02858         }
02859 
02860     } <span class="keywordflow">else</span> {
02861 
02862         <span class="comment">//</span>
02863         <span class="comment">// Protection is in ProtoPte.</span>
02864         <span class="comment">//</span>
02865 
02866         ProtoPteAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (PointerPte);
02867     }
02868 
02869     PointerFaultingPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a18">MiFindActualFaultingPte</a> (ProtoPteAddress);
02870 
02871     <span class="keywordflow">if</span> (PointerFaultingPte == (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02872         <span class="keywordflow">return</span> PointerPte;
02873     } <span class="keywordflow">else</span> {
02874         <span class="keywordflow">return</span> PointerFaultingPte;
02875     }
02876 
02877 }
02878 
02879 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
<a name="l02880"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a19">02880</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (
02881     IN PVOID VirtualAddress,
02882     OUT PULONG ProtectCode
02883     )
02884 
02885 <span class="comment">/*++</span>
02886 <span class="comment"></span>
02887 <span class="comment">Routine Description:</span>
02888 <span class="comment"></span>
02889 <span class="comment">    This function examines the virtual address descriptors to see</span>
02890 <span class="comment">    if the specified virtual address is contained within any of</span>
02891 <span class="comment">    the descriptors.  If a virtual address descriptor is found</span>
02892 <span class="comment">    which contains the specified virtual address, a PTE is built</span>
02893 <span class="comment">    from information within the virtual address descriptor and</span>
02894 <span class="comment">    returned to the caller.</span>
02895 <span class="comment"></span>
02896 <span class="comment">Arguments:</span>
02897 <span class="comment"></span>
02898 <span class="comment">    VirtualAddress - Supplies the virtual address to locate within</span>
02899 <span class="comment">                     a virtual address descriptor.</span>
02900 <span class="comment"></span>
02901 <span class="comment">Return Value:</span>
02902 <span class="comment"></span>
02903 <span class="comment">    Returns the PTE which corresponds to the supplied virtual address.</span>
02904 <span class="comment">    If no virtual address descriptor is found, a zero pte is returned.</span>
02905 <span class="comment"></span>
02906 <span class="comment">Environment:</span>
02907 <span class="comment"></span>
02908 <span class="comment">    Kernel mode, APCs disabled, working set mutex held.</span>
02909 <span class="comment"></span>
02910 <span class="comment">--*/</span>
02911 
02912 {
02913     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
02914     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02915     PLIST_ENTRY NextEntry;
02916     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
02917 
02918     <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
02919 
02920 <span class="preprocessor">#if defined(MM_SHARED_USER_DATA_VA)</span>
02921 <span class="preprocessor"></span>
02922         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress) == (PVOID) MM_SHARED_USER_DATA_VA) {
02923 
02924             <span class="comment">//</span>
02925             <span class="comment">// This is the page that is double mapped between</span>
02926             <span class="comment">// user mode and kernel mode.  Map in as read only.</span>
02927             <span class="comment">// On MIPS this is hardwired in the TB.</span>
02928             <span class="comment">//</span>
02929 
02930             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
02931             <span class="keywordflow">return</span> &amp;<a class="code" href="../../d5/d1/mminit_8c.html#a5">MmSharedUserDataPte</a>;
02932         }
02933 
02934 <span class="preprocessor">#endif</span>
02935 <span class="preprocessor"></span>
02936         Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (VirtualAddress);
02937         <span class="keywordflow">if</span> (Vad == (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02938 
02939             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
02940             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02941         }
02942 
02943         <span class="comment">//</span>
02944         <span class="comment">// A virtual address descriptor which contains the virtual address</span>
02945         <span class="comment">// has been located.  Build the PTE from the information within</span>
02946         <span class="comment">// the virtual address descriptor.</span>
02947         <span class="comment">//</span>
02948 
02949 <span class="preprocessor">#ifdef LARGE_PAGES</span>
02950 <span class="preprocessor"></span>
02951         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.LargePages == 1) {
02952 
02953             KIRQL OldIrql;
02954             <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02955 
02956             <span class="comment">//</span>
02957             <span class="comment">// The first prototype PTE points to the subsection for the</span>
02958             <span class="comment">// large page mapping.</span>
02959 
02960             Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a>;
02961 
02962             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages == 1);
02963 
02964             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
02965             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02966             KeFillLargeEntryTb ((PHARDWARE_PTE)(Subsection + 1),
02967                                  VirtualAddress,
02968                                  Subsection-&gt;StartingSector);
02969 
02970             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
02971             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a48">MM_LARGE_PAGES</a>;
02972             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02973         }
02974 <span class="preprocessor">#endif //LARGE_PAGES</span>
02975 <span class="preprocessor"></span>
02976         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 1) {
02977 
02978             <span class="comment">//</span>
02979             <span class="comment">// This is a banked section.</span>
02980             <span class="comment">//</span>
02981 
02982             <a class="code" href="../../d8/d2/pagfault_8c.html#a9">MiHandleBankedSection</a> (VirtualAddress, Vad);
02983             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
02984             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02985         }
02986 
02987         <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory == 1) {
02988 
02989             <span class="comment">//</span>
02990             <span class="comment">// This is a private region of memory.  Check to make</span>
02991             <span class="comment">// sure the virtual address has been committed.  Note that</span>
02992             <span class="comment">// addresses are dense from the bottom up.</span>
02993             <span class="comment">//</span>
02994 
02995             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
02996 
02997                 <span class="comment">//</span>
02998                 <span class="comment">// These mappings only fault if the access is bad.</span>
02999                 <span class="comment">//</span>
03000 
03001                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress)-&gt;u.Long == <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
03002                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03003                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03004             }
03005 
03006             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.MemCommit == 1) {
03007                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a230">MI_GET_PROTECTION_FROM_VAD</a>(Vad);
03008                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03009             }
03010 
03011             <span class="comment">//</span>
03012             <span class="comment">// The address is reserved but not committed.</span>
03013             <span class="comment">//</span>
03014 
03015             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03016             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03017 
03018         } <span class="keywordflow">else</span> {
03019 
03020             <span class="comment">//</span>
03021             <span class="comment">// This virtual address descriptor refers to a</span>
03022             <span class="comment">// section, calculate the address of the prototype PTE</span>
03023             <span class="comment">// and construct a pointer to the PTE.</span>
03024             <span class="comment">//</span>
03025             <span class="comment">//*******************************************************</span>
03026             <span class="comment">//*******************************************************</span>
03027             <span class="comment">// well here's an interesting problem, how do we know</span>
03028             <span class="comment">// how to set the attributes on the PTE we are creating</span>
03029             <span class="comment">// when we can't look at the prototype PTE without</span>
03030             <span class="comment">// potentially incurring a page fault.  In this case</span>
03031             <span class="comment">// PteTemplate would be zero.</span>
03032             <span class="comment">//*******************************************************</span>
03033             <span class="comment">//*******************************************************</span>
03034             <span class="comment">//</span>
03035 
03036             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.ImageMap == 1) {
03037 
03038                 <span class="comment">//</span>
03039                 <span class="comment">// PTE and proto PTEs have the same protection for images.</span>
03040                 <span class="comment">//</span>
03041 
03042                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>;
03043             } <span class="keywordflow">else</span> {
03044                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a230">MI_GET_PROTECTION_FROM_VAD</a>(Vad);
03045             }
03046             PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a246">MiGetProtoPteAddress</a>(Vad,
03047                                                 <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress));
03048             <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03049                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03050             }
03051             <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.ExtendableFile) {
03052 
03053                 <span class="comment">//</span>
03054                 <span class="comment">// Make sure the data has been committed.</span>
03055                 <span class="comment">//</span>
03056 
03057                 <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress) - Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) &gt;
03058                     (ULONG_PTR)((Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.ExtendedInfo-&gt;CommittedSize - 1)
03059                                                  &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
03060                     *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03061                 }
03062             }
03063             <span class="keywordflow">return</span> PointerPte;
03064         }
03065 
03066     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) {
03067 
03068         <span class="comment">//</span>
03069         <span class="comment">// The virtual address is within the space occupied by PDEs,</span>
03070         <span class="comment">// make the PDE valid.</span>
03071         <span class="comment">//</span>
03072 
03073         <span class="keywordflow">if</span> (((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)VirtualAddress &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>)) &amp;&amp;
03074             ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)VirtualAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>.LastPteForPagedPool)) {
03075 
03076             *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03077             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03078         }
03079 
03080         *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>;
03081         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03082     }
03083     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03084 
03085         <span class="comment">//</span>
03086         <span class="comment">// See if the session space address is copy on write.</span>
03087         <span class="comment">//</span>
03088 
03089         <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a> ();
03090     
03091         PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03092         *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03093 
03094         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
03095     
03096         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
03097     
03098             Image = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
03099     
03100             <span class="keywordflow">if</span> ((VirtualAddress &gt;= Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a>) &amp;&amp; (VirtualAddress &lt;= Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o2">LastAddress</a>)) {
03101                 PointerPte = Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o4">PrototypePtes</a> +
03102                     (((PCHAR)VirtualAddress - (PCHAR)Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a>) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03103                 *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
03104                 <span class="keywordflow">break</span>;
03105             }
03106     
03107             NextEntry = NextEntry-&gt;Flink;
03108         }
03109 
03110         <span class="keywordflow">return</span> PointerPte;
03111     }
03112 
03113     <span class="comment">//</span>
03114     <span class="comment">// Address is in system space.</span>
03115     <span class="comment">//</span>
03116 
03117     *ProtectCode = <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>;
03118     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03119 }
03120 
03121 <span class="preprocessor">#if !defined (_WIN64)</span>
03122 <span class="preprocessor"></span>
03123 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03124 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l03125"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a20">03125</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (
03126     IN PVOID VirtualAddress
03127     )
03128 
03129 <span class="comment">/*++</span>
03130 <span class="comment"></span>
03131 <span class="comment">Routine Description:</span>
03132 <span class="comment"></span>
03133 <span class="comment">    This function copies the Page Table Entry for the corresponding</span>
03134 <span class="comment">    virtual address from the system process's page directory.</span>
03135 <span class="comment"></span>
03136 <span class="comment">    This allows page table pages to be lazily evaluated for things</span>
03137 <span class="comment">    like paged pool and per-session mappings.</span>
03138 <span class="comment"></span>
03139 <span class="comment">Arguments:</span>
03140 <span class="comment"></span>
03141 <span class="comment">    VirtualAddress - Supplies the virtual address in question.</span>
03142 <span class="comment"></span>
03143 <span class="comment">Return Value:</span>
03144 <span class="comment"></span>
03145 <span class="comment">    Either success or access violation.</span>
03146 <span class="comment"></span>
03147 <span class="comment">Environment:</span>
03148 <span class="comment"></span>
03149 <span class="comment">    Kernel mode, DISPATCH level or below.</span>
03150 <span class="comment"></span>
03151 <span class="comment">--*/</span>
03152 {
03153     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03154     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03156 
03157     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03158 
03159         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03160 
03161             <span class="comment">//</span>
03162             <span class="comment">// Virtual address in the session space range.</span>
03163             <span class="comment">//</span>
03164 
03165             <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a> (VirtualAddress);
03166         }
03167 
03168         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03169 
03170             <span class="comment">//</span>
03171             <span class="comment">// PTE for the session space range.</span>
03172             <span class="comment">//</span>
03173 
03174             <span class="keywordflow">return</span> <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a> (VirtualAddress);
03175         }
03176     }
03177 
03178     status = STATUS_SUCCESS;
03179 
03180     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a191">MI_IS_KERNEL_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) {
03181 
03182         <span class="comment">//</span>
03183         <span class="comment">// PTE for paged pool.</span>
03184         <span class="comment">//</span>
03185 
03186         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
03187         status = STATUS_WAIT_1;
03188     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a>) {
03189 
03190         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
03191 
03192     } <span class="keywordflow">else</span> {
03193 
03194         <span class="comment">//</span>
03195         <span class="comment">// Virtual address in paged pool range.</span>
03196         <span class="comment">//</span>
03197 
03198         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
03199     }
03200 
03201     <span class="comment">//</span>
03202     <span class="comment">// Locate the PDE for this page and make it valid.</span>
03203     <span class="comment">//</span>
03204 
03205     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03206         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
03207 <span class="preprocessor">#if !defined (_X86PAE_)</span>
03208 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde,
03209                             <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> [((ULONG_PTR)PointerPde &amp;
03210                                ((<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>) * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>)]);
03211 <span class="preprocessor">#else</span>
03212 <span class="preprocessor"></span>        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde,
03213                             <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a> [((ULONG_PTR)PointerPde &amp;
03214                                (PD_PER_SYSTEM * (<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>) * <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a102">PDE_PER_PAGE</a>) - 1)) / <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>)]);
03215 <span class="preprocessor">#endif</span>
03216 <span class="preprocessor"></span>        KeFillEntryTb ((PHARDWARE_PTE)PointerPde, PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03217     }
03218     <span class="keywordflow">return</span> status;
03219 }
03220 
03221 
03222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03223 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
<a name="l03224"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a21">03224</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a>(
03225     IN PVOID VirtualAddress
03226     )
03227 
03228 <span class="comment">/*++</span>
03229 <span class="comment"></span>
03230 <span class="comment">Routine Description:</span>
03231 <span class="comment"></span>
03232 <span class="comment">    This function copies the Page Table Entry for the corresponding</span>
03233 <span class="comment">    session virtual address from the current session's data structures.</span>
03234 <span class="comment"></span>
03235 <span class="comment">    This allows page table pages to be lazily evaluated for session mappings.</span>
03236 <span class="comment">    The caller must check for the current process having a session space.</span>
03237 <span class="comment"></span>
03238 <span class="comment">Arguments:</span>
03239 <span class="comment"></span>
03240 <span class="comment">    VirtualAddress - Supplies the virtual address in question.</span>
03241 <span class="comment"></span>
03242 <span class="comment">Return Value:</span>
03243 <span class="comment"></span>
03244 <span class="comment">    STATUS_WAIT_1 - The mapping has been made valid, retry the fault.</span>
03245 <span class="comment"></span>
03246 <span class="comment">    STATUS_SUCCESS - Did not handle the fault, continue further processing.</span>
03247 <span class="comment"></span>
03248 <span class="comment">    !STATUS_SUCCESS - An access violation has occurred - raise an exception.</span>
03249 <span class="comment"></span>
03250 <span class="comment">Environment:</span>
03251 <span class="comment"></span>
03252 <span class="comment">    Kernel mode, DISPATCH level or below.</span>
03253 <span class="comment"></span>
03254 <span class="comment">--*/</span>
03255 
03256 {
03257     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03258     PVOID  SessionVirtualAddress;
03259     ULONG  <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03260 
03261     <span class="comment">//</span>
03262     <span class="comment">// Caller should have checked for this.</span>
03263     <span class="comment">//</span>
03264 
03265     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03266 
03267     <span class="comment">//</span>
03268     <span class="comment">// First check whether the reference was to a page table page which maps</span>
03269     <span class="comment">// session space.  If so, the PDE is retrieved from the session space</span>
03270     <span class="comment">// data structure and made valid.</span>
03271     <span class="comment">//</span>
03272 
03273     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03274 
03275         <span class="comment">//</span>
03276         <span class="comment">// Verify that the current process has a session space.</span>
03277         <span class="comment">//</span>
03278 
03279         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
03280 
03281         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03282 
03283 <span class="preprocessor">#if DBG</span>
03284 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiCheckPdeForSessionSpace: No current session for PTE %p\n"</span>,
03285                 VirtualAddress);
03286 
03287             DbgBreakPoint();
03288 <span class="preprocessor">#endif</span>
03289 <span class="preprocessor"></span>            <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
03290         }
03291 
03292         SessionVirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> ((<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>) VirtualAddress);
03293 
03294         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
03295 
03296         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
03297 
03298             <span class="comment">//</span>
03299             <span class="comment">// The PDE is already valid - another thread must have</span>
03300             <span class="comment">// won the race.  Just return.</span>
03301             <span class="comment">//</span>
03302 
03303             <span class="keywordflow">return</span> STATUS_WAIT_1;
03304         }
03305 
03306         <span class="comment">//</span>
03307         <span class="comment">// Calculate the session space PDE index and load the</span>
03308         <span class="comment">// PDE from the session space table for this session.</span>
03309         <span class="comment">//</span>
03310 
03311         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (SessionVirtualAddress);
03312 
03313         PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03314 
03315         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
03316             KeFillEntryTb ((PHARDWARE_PTE)PointerPde, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03317             <span class="keywordflow">return</span> STATUS_WAIT_1;
03318         }
03319 
03320 <span class="preprocessor">#if DBG</span>
03321 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiCheckPdeForSessionSpace: No Session PDE for PTE %p, %p\n"</span>,
03322             PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long, SessionVirtualAddress);
03323 
03324         DbgBreakPoint();
03325 <span class="preprocessor">#endif</span>
03326 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
03327     }
03328 
03329     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03330 
03331         <span class="comment">//</span>
03332         <span class="comment">// Not a session space fault - tell the caller to try other handlers.</span>
03333         <span class="comment">//</span>
03334 
03335         <span class="keywordflow">return</span> STATUS_SUCCESS;
03336     }
03337 
03338     <span class="comment">//</span>
03339     <span class="comment">// Handle PDE faults for references in the session space.</span>
03340     <span class="comment">// Verify that the current process has a session space.</span>
03341     <span class="comment">//</span>
03342 
03343     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
03344 
03345     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03346 
03347 <span class="preprocessor">#if DBG</span>
03348 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiCheckPdeForSessionSpace: No current session for VA %p\n"</span>,
03349             VirtualAddress);
03350 
03351         DbgBreakPoint();
03352 <span class="preprocessor">#endif</span>
03353 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
03354     }
03355 
03356     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
03357 
03358     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03359 
03360         <span class="comment">//</span>
03361         <span class="comment">// Calculate the session space PDE index and load the</span>
03362         <span class="comment">// PDE from the session space table for this session.</span>
03363         <span class="comment">//</span>
03364 
03365         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (VirtualAddress);
03366 
03367         PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03368 
03369         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
03370 
03371             KeFillEntryTb ((PHARDWARE_PTE)PointerPde,
03372                            <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress),
03373                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03374 
03375             <span class="keywordflow">return</span> STATUS_WAIT_1;
03376         }
03377 
03378 <span class="preprocessor">#if DBG</span>
03379 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiCheckPdeForSessionSpace: No Session PDE for VA %p, %p\n"</span>,
03380             PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long, VirtualAddress);
03381 
03382         DbgBreakPoint();
03383 <span class="preprocessor">#endif</span>
03384 <span class="preprocessor"></span>
03385         <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
03386     }
03387 
03388     <span class="comment">//</span>
03389     <span class="comment">// Tell the caller to continue with other fault handlers.</span>
03390     <span class="comment">//</span>
03391 
03392     <span class="keywordflow">return</span> STATUS_SUCCESS;
03393 }
03394 <span class="preprocessor">#endif</span>
03395 <span class="preprocessor"></span>
03396 
03397 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03398"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a22">03398</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (
03399     IN PFN_NUMBER PageFrameIndex,
03400     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03401     IN ULONG ModifiedState
03402     )
03403 
03404 <span class="comment">/*++</span>
03405 <span class="comment"></span>
03406 <span class="comment">Routine Description:</span>
03407 <span class="comment"></span>
03408 <span class="comment">    This function initializes the specified PFN element to the</span>
03409 <span class="comment">    active and valid state.</span>
03410 <span class="comment"></span>
03411 <span class="comment">Arguments:</span>
03412 <span class="comment"></span>
03413 <span class="comment">    PageFrameIndex - Supplies the page frame number to initialize.</span>
03414 <span class="comment"></span>
03415 <span class="comment">    PointerPte - Supplies the pointer to the PTE which caused the</span>
03416 <span class="comment">                 page fault.</span>
03417 <span class="comment"></span>
03418 <span class="comment">    ModifiedState - Supplies the state to set the modified field in the PFN</span>
03419 <span class="comment">                    element for this page, either 0 or 1.</span>
03420 <span class="comment"></span>
03421 <span class="comment">Return Value:</span>
03422 <span class="comment"></span>
03423 <span class="comment">    None.</span>
03424 <span class="comment"></span>
03425 <span class="comment">Environment:</span>
03426 <span class="comment"></span>
03427 <span class="comment">    Kernel mode, APCs disabled, PFN mutex held.</span>
03428 <span class="comment"></span>
03429 <span class="comment">--*/</span>
03430 
03431 {
03432     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03433     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
03434     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
03435     PFN_NUMBER PteFramePage;
03436 
03437     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
03438 
03439     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03440     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
03441 
03442     <span class="comment">//</span>
03443     <span class="comment">// If the PTE is currently valid, an address space is being built,</span>
03444     <span class="comment">// just make the original PTE demand zero.</span>
03445     <span class="comment">//</span>
03446 
03447     <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
03448         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
03449 
03450 <span class="preprocessor">#if defined(_IA64_)</span>
03451 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Execute == 1) {
03452             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>;
03453         }
03454 <span class="preprocessor">#endif</span>
03455 <span class="preprocessor"></span>
03456         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a119">MI_IS_CACHING_DISABLED</a> (PointerPte)) {
03457             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
03458         }
03459 
03460     } <span class="keywordflow">else</span> {
03461         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = *PointerPte;
03462         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
03463                     (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
03464     }
03465 
03466     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03467 
03468 <span class="preprocessor">#if DBG</span>
03469 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) {
03470         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:incrementing ref count &gt; 1 \n"</span>);
03471         <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
03472         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
03473     }
03474 <span class="preprocessor">#endif</span>
03475 <span class="preprocessor"></span>
03476     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03477     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
03478     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = ModifiedState;
03479 
03480 <span class="preprocessor">#if defined (_WIN64)</span>
03481 <span class="preprocessor"></span>    Pfn1-&gt;UsedPageTableEntries = 0;
03482 <span class="preprocessor">#endif</span>
03483 <span class="preprocessor"></span>
03484 <span class="preprocessor">#if PFN_CONSISTENCY</span>
03485 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 0;
03486 <span class="preprocessor">#endif</span>
03487 <span class="preprocessor"></span>    <span class="comment">//</span>
03488     <span class="comment">// Determine the page frame number of the page table page which</span>
03489     <span class="comment">// contains this PTE.</span>
03490     <span class="comment">//</span>
03491 
03492     PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03493     <span class="keywordflow">if</span> (PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03494 <span class="preprocessor">#if !defined (_WIN64)</span>
03495 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
03496 <span class="preprocessor">#endif</span>
03497 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03498                           0x61940, 
03499                           (ULONG_PTR)PointerPte,
03500                           (ULONG_PTR)PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
03501                           (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
03502 <span class="preprocessor">#if !defined (_WIN64)</span>
03503 <span class="preprocessor"></span>        }
03504 <span class="preprocessor">#endif</span>
03505 <span class="preprocessor"></span>    }
03506     PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
03507     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteFramePage != 0);
03508     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
03509 
03510     <span class="comment">//</span>
03511     <span class="comment">// Increment the share count for the page table page containing</span>
03512     <span class="comment">// this PTE.</span>
03513     <span class="comment">//</span>
03514 
03515     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteFramePage);
03516 
03517     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03518 
03519     <span class="keywordflow">return</span>;
03520 }
03521 
03522 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03523"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a23">03523</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a23">MiInitializeReadInProgressPfn</a> (
03524     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
03525     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte,
03526     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event,
03527     IN WSLE_NUMBER WorkingSetIndex
03528     )
03529 
03530 <span class="comment">/*++</span>
03531 <span class="comment"></span>
03532 <span class="comment">Routine Description:</span>
03533 <span class="comment"></span>
03534 <span class="comment">    This function initializes the specified PFN element to the</span>
03535 <span class="comment">    transition / read-in-progress state for an in-page operation.</span>
03536 <span class="comment"></span>
03537 <span class="comment"></span>
03538 <span class="comment">Arguments:</span>
03539 <span class="comment"></span>
03540 <span class="comment">    Mdl - Supplies a pointer to the MDL.</span>
03541 <span class="comment"></span>
03542 <span class="comment">    BasePte - Supplies the pointer to the PTE which the first page in</span>
03543 <span class="comment">              the MDL maps.</span>
03544 <span class="comment"></span>
03545 <span class="comment">    Event - Supplies the event which is to be set when the I/O operation</span>
03546 <span class="comment">            completes.</span>
03547 <span class="comment"></span>
03548 <span class="comment">    WorkingSetIndex - Supplies the working set index flag, a value of</span>
03549 <span class="comment">                      -1 indicates no WSLE is required because</span>
03550 <span class="comment">                      this is a prototype PTE.</span>
03551 <span class="comment"></span>
03552 <span class="comment">Return Value:</span>
03553 <span class="comment"></span>
03554 <span class="comment">    None.</span>
03555 <span class="comment"></span>
03556 <span class="comment">Environment:</span>
03557 <span class="comment"></span>
03558 <span class="comment">    Kernel mode, APCs disabled, PFN mutex held.</span>
03559 <span class="comment"></span>
03560 <span class="comment">--*/</span>
03561 
03562 {
03563     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03564     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
03565     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
03566     PFN_NUMBER PteFramePage;
03567     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03568     LONG NumberOfBytes;
03569     PPFN_NUMBER Page;
03570 
03571     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
03572 
03573     Page = (PPFN_NUMBER)(Mdl + 1);
03574 
03575     NumberOfBytes = Mdl-&gt;ByteCount;
03576 
03577     <span class="keywordflow">while</span> (NumberOfBytes &gt; 0) {
03578 
03579         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
03580         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
03581         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = BasePte;
03582         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = *BasePte;
03583         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
03584         <a class="code" href="../../d4/d8/mi_8h.html#a187">MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE</a> (Pfn1, 10);
03585         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03586 
03587         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
03588         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress = 1;
03589         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.InPageError = 0;
03590 
03591 <span class="preprocessor">#if PFN_CONSISTENCY</span>
03592 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 0;
03593 <span class="preprocessor">#endif</span>
03594 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (WorkingSetIndex == <a class="code" href="../../d8/d2/pagfault_8c.html#a3">MI_PROTOTYPE_WSINDEX</a>) {
03595             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
03596         }
03597 
03598         <span class="comment">//</span>
03599         <span class="comment">// Determine the page frame number of the page table page which</span>
03600         <span class="comment">// contains this PTE.</span>
03601         <span class="comment">//</span>
03602 
03603         PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BasePte);
03604         <span class="keywordflow">if</span> (PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03605 <span class="preprocessor">#if !defined (_WIN64)</span>
03606 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (BasePte))) {
03607 <span class="preprocessor">#endif</span>
03608 <span class="preprocessor"></span>                <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03609                               0x61940, 
03610                               (ULONG_PTR)BasePte,
03611                               (ULONG_PTR)PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
03612                               (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(BasePte));
03613 <span class="preprocessor">#if !defined (_WIN64)</span>
03614 <span class="preprocessor"></span>            }
03615 <span class="preprocessor">#endif</span>
03616 <span class="preprocessor"></span>        }
03617 
03618         PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
03619         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
03620 
03621         <span class="comment">//</span>
03622         <span class="comment">// Put the PTE into the transition state, no cache flush needed as</span>
03623         <span class="comment">// PTE is still not valid.</span>
03624         <span class="comment">//</span>
03625 
03626         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a107">MI_MAKE_TRANSITION_PTE</a> (TempPte,
03627                                 *Page,
03628                                 BasePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
03629                                 BasePte);
03630         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (BasePte, TempPte);
03631 
03632         <span class="comment">//</span>
03633         <span class="comment">// Increment the share count for the page table page containing</span>
03634         <span class="comment">// this PTE as the PTE just went into the transition state.</span>
03635         <span class="comment">//</span>
03636 
03637         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteFramePage != 0);
03638         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteFramePage);
03639         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03640 
03641         NumberOfBytes -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03642         Page += 1;
03643         BasePte += 1;
03644     }
03645 
03646     <span class="keywordflow">return</span>;
03647 }
03648 
03649 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03650"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a24">03650</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a24">MiInitializeTransitionPfn</a> (
03651     IN PFN_NUMBER PageFrameIndex,
03652     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03653     IN WSLE_NUMBER WorkingSetIndex
03654     )
03655 
03656 <span class="comment">/*++</span>
03657 <span class="comment"></span>
03658 <span class="comment">Routine Description:</span>
03659 <span class="comment"></span>
03660 <span class="comment">    This function initializes the specified PFN element to the</span>
03661 <span class="comment">    transition state.  Main use is by MapImageFile to make the</span>
03662 <span class="comment">    page which contains the image header transition in the</span>
03663 <span class="comment">    prototype PTEs.</span>
03664 <span class="comment"></span>
03665 <span class="comment">Arguments:</span>
03666 <span class="comment"></span>
03667 <span class="comment">    PageFrameIndex - Supplies the page frame index to be initialized.</span>
03668 <span class="comment"></span>
03669 <span class="comment">    PointerPte - Supplies an invalid, non-transition PTE to initialize.</span>
03670 <span class="comment"></span>
03671 <span class="comment">    WorkingSetIndex - Supplies the working set index flag, a value of</span>
03672 <span class="comment">                      MI_PROTOTYPE_WSINDEX indicates no WSLE is required</span>
03673 <span class="comment">                      because this is a prototype PTE.</span>
03674 <span class="comment"></span>
03675 <span class="comment">Return Value:</span>
03676 <span class="comment"></span>
03677 <span class="comment">    None.</span>
03678 <span class="comment"></span>
03679 <span class="comment">Environment:</span>
03680 <span class="comment"></span>
03681 <span class="comment">    Kernel mode, APCs disabled, PFN mutex held.</span>
03682 <span class="comment"></span>
03683 <span class="comment">--*/</span>
03684 
03685 {
03686     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03687     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
03688     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
03689     PFN_NUMBER PteFramePage;
03690     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03691 
03692     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
03693     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03694     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03695     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
03696     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = *PointerPte;
03697     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
03698               (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1)));
03699 
03700     <span class="comment">//</span>
03701     <span class="comment">// Don't change the reference count (it should already be 1).</span>
03702     <span class="comment">//</span>
03703 
03704     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
03705 
03706     <span class="keywordflow">if</span> (WorkingSetIndex == <a class="code" href="../../d8/d2/pagfault_8c.html#a3">MI_PROTOTYPE_WSINDEX</a>) {
03707         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte = 1;
03708     }
03709 
03710     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a178">TransitionPage</a>;
03711 
03712     <span class="comment">//</span>
03713     <span class="comment">// Determine the page frame number of the page table page which</span>
03714     <span class="comment">// contains this PTE.</span>
03715     <span class="comment">//</span>
03716 
03717     PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03718     <span class="keywordflow">if</span> (PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03719 <span class="preprocessor">#if !defined (_WIN64)</span>
03720 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
03721 <span class="preprocessor">#endif</span>
03722 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03723                           0x61940, 
03724                           (ULONG_PTR)PointerPte,
03725                           (ULONG_PTR)PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
03726                           (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
03727 <span class="preprocessor">#if !defined (_WIN64)</span>
03728 <span class="preprocessor"></span>        }
03729 <span class="preprocessor">#endif</span>
03730 <span class="preprocessor"></span>    }
03731 
03732     PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
03733     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
03734 
03735 <span class="preprocessor">#if PFN_CONSISTENCY</span>
03736 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 0;
03737 <span class="preprocessor">#endif</span>
03738 <span class="preprocessor"></span>
03739     <span class="comment">//</span>
03740     <span class="comment">// Put the PTE into the transition state, no cache flush needed as</span>
03741     <span class="comment">// PTE is still not valid.</span>
03742     <span class="comment">//</span>
03743 
03744     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a107">MI_MAKE_TRANSITION_PTE</a> (TempPte,
03745                             PageFrameIndex,
03746                             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
03747                             PointerPte);
03748 
03749     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, TempPte);
03750 
03751     <span class="comment">//</span>
03752     <span class="comment">// Increment the share count for the page table page containing</span>
03753     <span class="comment">// this PTE as the PTE just went into the transition state.</span>
03754     <span class="comment">//</span>
03755 
03756     Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteFramePage);
03757     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteFramePage != 0);
03758     Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03759 
03760     <span class="keywordflow">return</span>;
03761 }
03762 
03763 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03764"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a25">03764</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a25">MiInitializeCopyOnWritePfn</a> (
03765     IN PFN_NUMBER PageFrameIndex,
03766     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03767     IN WSLE_NUMBER WorkingSetIndex,
03768     IN PVOID SessionPointer
03769     )
03770 
03771 <span class="comment">/*++</span>
03772 <span class="comment"></span>
03773 <span class="comment">Routine Description:</span>
03774 <span class="comment"></span>
03775 <span class="comment">    This function initializes the specified PFN element to the</span>
03776 <span class="comment">    active and valid state for a copy on write operation.</span>
03777 <span class="comment"></span>
03778 <span class="comment">    In this case the page table page which contains the PTE has</span>
03779 <span class="comment">    the proper ShareCount.</span>
03780 <span class="comment"></span>
03781 <span class="comment">Arguments:</span>
03782 <span class="comment"></span>
03783 <span class="comment">    PageFrameIndex - Supplies the page frame number to initialize.</span>
03784 <span class="comment"></span>
03785 <span class="comment">    PointerPte - Supplies the pointer to the PTE which caused the</span>
03786 <span class="comment">                 page fault.</span>
03787 <span class="comment"></span>
03788 <span class="comment">    WorkingSetIndex - Supplies the working set index for the corresponding</span>
03789 <span class="comment">                      virtual address.</span>
03790 <span class="comment"></span>
03791 <span class="comment">    SessionPointer - Supplies the session space pointer if this fault is for</span>
03792 <span class="comment">                     a session space page or NULL if this is for a user page.</span>
03793 <span class="comment"></span>
03794 <span class="comment"></span>
03795 <span class="comment">Return Value:</span>
03796 <span class="comment"></span>
03797 <span class="comment">    None.</span>
03798 <span class="comment"></span>
03799 <span class="comment">Environment:</span>
03800 <span class="comment"></span>
03801 <span class="comment">    Kernel mode, APCs disabled, PFN mutex held.</span>
03802 <span class="comment"></span>
03803 <span class="comment">--*/</span>
03804 
03805 {
03806     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03807     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteFramePointer;
03808     PFN_NUMBER PteFramePage;
03809     PVOID VirtualAddress;
03810     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
03811 
03812     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03813     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
03814 
03815     <span class="comment">//</span>
03816     <span class="comment">// Get the protection for the page.</span>
03817     <span class="comment">//</span>
03818 
03819     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03820 
03821     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
03822 
03823     <span class="keywordflow">if</span> (SessionPointer) {
03824         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>;
03825         SessionSpace = (<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>) SessionPointer;
03826         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Protection =
03827             <a class="code" href="../../d4/d8/mi_8h.html#a41">MM_EXECUTE_READWRITE</a>;
03828     }
03829     <span class="keywordflow">else</span> {
03830         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
03831                 <a class="code" href="../../d4/d8/mi_8h.html#a112">MI_MAKE_PROTECT_NOT_WRITE_COPY</a> (
03832                                     <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o3">Protection</a>);
03833     }
03834 
03835     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
03836     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03837     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03838     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
03839     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = WorkingSetIndex;
03840 
03841     <span class="comment">//</span>
03842     <span class="comment">// Determine the page frame number of the page table page which</span>
03843     <span class="comment">// contains this PTE.</span>
03844     <span class="comment">//</span>
03845 
03846     PteFramePointer = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03847     <span class="keywordflow">if</span> (PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03848 <span class="preprocessor">#if !defined (_WIN64)</span>
03849 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
03850 <span class="preprocessor">#endif</span>
03851 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
03852                           0x61940, 
03853                           (ULONG_PTR)PointerPte,
03854                           (ULONG_PTR)PteFramePointer-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
03855                           (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
03856 <span class="preprocessor">#if !defined (_WIN64)</span>
03857 <span class="preprocessor"></span>        }
03858 <span class="preprocessor">#endif</span>
03859 <span class="preprocessor"></span>    }
03860 
03861     PteFramePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PteFramePointer);
03862     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteFramePage != 0);
03863 
03864     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = PteFramePage;
03865 
03866 <span class="preprocessor">#if PFN_CONSISTENCY</span>
03867 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
03868 
03869     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 0;
03870 <span class="preprocessor">#endif</span>
03871 <span class="preprocessor"></span>
03872     <span class="comment">//</span>
03873     <span class="comment">// Set the modified flag in the PFN database as we are writing</span>
03874     <span class="comment">// into this page and the dirty bit is already set in the PTE.</span>
03875     <span class="comment">//</span>
03876 
03877     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
03878 
03879     <span class="keywordflow">return</span>;
03880 }
03881 
03882 BOOLEAN
<a name="l03883"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a26">03883</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a> (
03884     IN PVOID VirtualAddress
03885     )
03886 
03887 <span class="comment">/*++</span>
03888 <span class="comment"></span>
03889 <span class="comment">Routine Description:</span>
03890 <span class="comment"></span>
03891 <span class="comment">    For a given virtual address this function returns TRUE if no page fault</span>
03892 <span class="comment">    will occur for a read operation on the address, FALSE otherwise.</span>
03893 <span class="comment"></span>
03894 <span class="comment">    Note that after this routine was called, if appropriate locks are not</span>
03895 <span class="comment">    held, a non-faulting address could fault.</span>
03896 <span class="comment"></span>
03897 <span class="comment">Arguments:</span>
03898 <span class="comment"></span>
03899 <span class="comment">    VirtualAddress - Supplies the virtual address to check.</span>
03900 <span class="comment"></span>
03901 <span class="comment">Return Value:</span>
03902 <span class="comment"></span>
03903 <span class="comment">    TRUE if a no page fault would be generated reading the virtual address,</span>
03904 <span class="comment">    FALSE otherwise.</span>
03905 <span class="comment"></span>
03906 <span class="comment">Environment:</span>
03907 <span class="comment"></span>
03908 <span class="comment">    Kernel mode.</span>
03909 <span class="comment"></span>
03910 <span class="comment">--*/</span>
03911 
03912 {
03913     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03914 
03915 <span class="preprocessor">#if defined(_ALPHA_) || defined(_IA64_)</span>
03916 <span class="preprocessor"></span>
03917     <span class="comment">//</span>
03918     <span class="comment">// If this is within the physical addressing range, just return TRUE.</span>
03919     <span class="comment">//</span>
03920 
03921     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress)) {
03922         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03923     }
03924 
03925 <span class="preprocessor">#endif // _ALPHA_ || _IA64_</span>
03926 <span class="preprocessor"></span>
03927 <span class="preprocessor">#if defined (_WIN64)</span>
03928 <span class="preprocessor"></span>    PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (VirtualAddress);
03929     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03930         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03931     }
03932 <span class="preprocessor">#endif</span>
03933 <span class="preprocessor"></span>
03934     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
03935     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03936         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03937     }
03938 <span class="preprocessor">#ifdef _X86_</span>
03939 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
03940         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03941     }
03942 <span class="preprocessor">#endif //_X86_</span>
03943 <span class="preprocessor"></span>
03944     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
03945     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03946         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03947     }
03948 
03949 <span class="preprocessor">#ifdef _X86_</span>
03950 <span class="preprocessor"></span>    <span class="comment">//</span>
03951     <span class="comment">// Make sure we're not treating a page directory as a page table here for</span>
03952     <span class="comment">// the case where the page directory is mapping a large page.  This is</span>
03953     <span class="comment">// because the large page bit is valid in PDE formats, but reserved in</span>
03954     <span class="comment">// PTE formats and will cause a trap.  A virtual address like c0200000</span>
03955     <span class="comment">// triggers this case.  It's not enough to just check the large page bit</span>
03956     <span class="comment">// in the PTE below because of course that bit's been reused by other</span>
03957     <span class="comment">// steppings of the processor so we have to look at the address too.</span>
03958     <span class="comment">//</span>
03959     <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
03960         PVOID Va;
03961 
03962         Va = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a160">MiGetVirtualAddressMappedByPde</a> (PointerPte);
03963         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(Va)) {
03964             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03965         }
03966     }
03967 <span class="preprocessor">#endif</span>
03968 <span class="preprocessor"></span>
03969     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03970 }
03971 
03972 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03973"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a27">03973</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (
03974     IN PFN_NUMBER PageFrameIndex,
03975     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03976     IN PFN_NUMBER ContainingPageFrame
03977     )
03978 
03979 <span class="comment">/*++</span>
03980 <span class="comment"></span>
03981 <span class="comment">Routine Description:</span>
03982 <span class="comment"></span>
03983 <span class="comment">    This function initializes the specified PFN element to the</span>
03984 <span class="comment">    active and valid state with the dirty bit on in the PTE and</span>
03985 <span class="comment">    the PFN database marked as modified.</span>
03986 <span class="comment"></span>
03987 <span class="comment">    As this PTE is not visible from the current process, the containing</span>
03988 <span class="comment">    page frame must be supplied at the PTE contents field for the</span>
03989 <span class="comment">    PFN database element are set to demand zero.</span>
03990 <span class="comment"></span>
03991 <span class="comment">Arguments:</span>
03992 <span class="comment"></span>
03993 <span class="comment">    PageFrameIndex - Supplies the page frame number of which to initialize.</span>
03994 <span class="comment"></span>
03995 <span class="comment">    PointerPte - Supplies the pointer to the PTE which caused the</span>
03996 <span class="comment">                 page fault.</span>
03997 <span class="comment"></span>
03998 <span class="comment">    ContainingPageFrame - Supplies the page frame number of the page</span>
03999 <span class="comment">                          table page which contains this PTE.</span>
04000 <span class="comment">                          If the ContainingPageFrame is 0, then</span>
04001 <span class="comment">                          the ShareCount for the</span>
04002 <span class="comment">                          containing page is not incremented.</span>
04003 <span class="comment"></span>
04004 <span class="comment">Return Value:</span>
04005 <span class="comment"></span>
04006 <span class="comment">    None.</span>
04007 <span class="comment"></span>
04008 <span class="comment">Environment:</span>
04009 <span class="comment"></span>
04010 <span class="comment">    Kernel mode, APCs disabled, PFN mutex held.</span>
04011 <span class="comment"></span>
04012 <span class="comment">--*/</span>
04013 
04014 {
04015     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04016     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
04017 
04018     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
04019     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a> = PointerPte;
04020     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
04021     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
04022     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
04023 
04024 <span class="preprocessor">#if DBG</span>
04025 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) {
04026         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:incrementing ref count &gt; 1 \n"</span>);
04027         <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a>(Pfn1);
04028         <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
04029     }
04030 <span class="preprocessor">#endif</span>
04031 <span class="preprocessor"></span>
04032     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
04033     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
04034     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
04035 
04036 <span class="preprocessor">#if PFN_CONSISTENCY</span>
04037 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04038 
04039     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 0;
04040 <span class="preprocessor">#endif</span>
04041 <span class="preprocessor"></span>
04042     <span class="comment">//</span>
04043     <span class="comment">// Increment the share count for the page table page containing</span>
04044     <span class="comment">// this PTE.</span>
04045     <span class="comment">//</span>
04046 
04047     <span class="keywordflow">if</span> (ContainingPageFrame != 0) {
04048         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = ContainingPageFrame;
04049         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (ContainingPageFrame);
04050         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
04051     }
04052     <span class="keywordflow">return</span>;
04053 }
04054 
04055 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04056"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a28">04056</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (
04057     IN PVOID VirtualAddress,
04058     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
04059     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
04060     IN ULONG WsleMask
04061     )
04062 
04063 <span class="comment">/*++</span>
04064 <span class="comment"></span>
04065 <span class="comment">Routine Description:</span>
04066 <span class="comment"></span>
04067 <span class="comment">    This routine adds the specified virtual address into the</span>
04068 <span class="comment">    appropriate working set list.</span>
04069 <span class="comment"></span>
04070 <span class="comment">Arguments:</span>
04071 <span class="comment"></span>
04072 <span class="comment">    VirtualAddress - Supplies the address to add to the working set list.</span>
04073 <span class="comment"></span>
04074 <span class="comment">    PointerPte - Supplies a pointer to the pte that is now valid.</span>
04075 <span class="comment"></span>
04076 <span class="comment">    Pfn1 - Supplies the PFN database element for the physical page</span>
04077 <span class="comment">           mapped by the virtual address.</span>
04078 <span class="comment"></span>
04079 <span class="comment">    WsleMask - Supplies a mask (protection and flags) to OR into the</span>
04080 <span class="comment">               working set list entry.</span>
04081 <span class="comment"></span>
04082 <span class="comment">Return Value:</span>
04083 <span class="comment"></span>
04084 <span class="comment">    None.</span>
04085 <span class="comment"></span>
04086 <span class="comment">Environment:</span>
04087 <span class="comment"></span>
04088 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
04089 <span class="comment"></span>
04090 <span class="comment">--*/</span>
04091 
04092 {
04093     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
04094     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04095     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
04096     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
04097 
04098     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(PointerPte));
04099     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
04100 
04101     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) || <a class="code" href="../../d4/d8/mi_8h.html#a355">MI_IS_SESSION_PTE</a> (VirtualAddress)) {
04102         <span class="comment">//</span>
04103         <span class="comment">// Current process's session space working set.</span>
04104         <span class="comment">//</span>
04105 
04106         WsInfo = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
04107         Wsle = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
04108     }
04109     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a194">MI_IS_PROCESS_SPACE_ADDRESS</a>(VirtualAddress)) {
04110 
04111         <span class="comment">//</span>
04112         <span class="comment">// Per process working set.</span>
04113         <span class="comment">//</span>
04114 
04115         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04116         WsInfo = &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>;
04117         Wsle = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
04118 
04119         <a class="code" href="../../d2/d1/mm_8h.html#a33">PERFINFO_ADDTOWS</a>(Pfn1, VirtualAddress, Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>)
04120     } <span class="keywordflow">else</span> {
04121 
04122         <span class="comment">//</span>
04123         <span class="comment">// System cache working set.</span>
04124         <span class="comment">//</span>
04125 
04126         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
04127         Wsle = <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>;
04128 
04129         <a class="code" href="../../d2/d1/mm_8h.html#a33">PERFINFO_ADDTOWS</a>(Pfn1, VirtualAddress, (HANDLE) -1);
04130     }
04131 
04132     WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (WsInfo);
04133     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
04134                   VirtualAddress,
04135                   WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
04136                   Pfn1);
04137     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long |= WsleMask;
04138 
04139 <span class="preprocessor">#if DBG</span>
04140 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(VirtualAddress)) {
04141         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o4">SameProtectAsProto</a>);
04142     }
04143 <span class="preprocessor">#endif //DBG</span>
04144 <span class="preprocessor"></span>
04145     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
04146 
04147     KeFillEntryTb ((PHARDWARE_PTE)PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04148     <span class="keywordflow">return</span>;
04149 }
04150 
04151 <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a>
<a name="l04152"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a29">04152</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a29">MiGetInPageSupportBlock</a> (
04153     VOID
04154     )
04155 
04156 <span class="comment">/*++</span>
04157 <span class="comment"></span>
04158 <span class="comment">Routine Description:</span>
04159 <span class="comment"></span>
04160 <span class="comment">    This routine acquires an inpage support block.  If none are available,</span>
04161 <span class="comment">    the PFN lock will be released and reacquired to add an entry to the list.</span>
04162 <span class="comment">    FALSE will then be returned.</span>
04163 <span class="comment"></span>
04164 <span class="comment">Arguments:</span>
04165 <span class="comment"></span>
04166 <span class="comment">    None.</span>
04167 <span class="comment"></span>
04168 <span class="comment">Return Value:</span>
04169 <span class="comment"></span>
04170 <span class="comment">    A non-null pointer to an inpage block if one is already available.</span>
04171 <span class="comment">    The PFN lock is not released in this path.</span>
04172 <span class="comment"></span>
04173 <span class="comment">    NULL is returned if no inpage blocks were available.  In this path, the</span>
04174 <span class="comment">    PFN lock is released and an entry is added - but NULL is still returned</span>
04175 <span class="comment">    so the caller is aware that the state has changed due to the lock release</span>
04176 <span class="comment">    and reacquisition.</span>
04177 <span class="comment"></span>
04178 <span class="comment">Environment:</span>
04179 <span class="comment"></span>
04180 <span class="comment">    Kernel mode, PFN lock held.</span>
04181 <span class="comment"></span>
04182 <span class="comment">--*/</span>
04183 
04184 {
04185     KIRQL OldIrql;
04186     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> Support;
04187     PLIST_ENTRY NextEntry;
04188 
04189     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04190 
04191     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> == 0) {
04192         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty(&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>));
04193         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
04194         Support = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
04195                                          <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">MMINPAGE_SUPPORT</a>),
04196                                          'nImM');
04197         <span class="keywordflow">if</span> (Support == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04198             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04199             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04200         }
04201 
04202         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">Event</a>, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04203         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04204 
04205         <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> += 1;
04206         Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o6">u</a>.Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04207 <span class="preprocessor">#if defined(_PREFETCH_)</span>
04208 <span class="preprocessor"></span>        Support-&gt;PrefetchMdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04209 <span class="preprocessor">#endif</span>
04210 <span class="preprocessor"></span>        InsertTailList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>,
04211                         &amp;Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o13">ListEntry</a>);
04212         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04213     }
04214 
04215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!IsListEmpty(&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>));
04216     <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> -= 1;
04217     NextEntry = RemoveHeadList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>);
04218     Support = CONTAINING_RECORD (NextEntry,
04219                                  <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">MMINPAGE_SUPPORT</a>,
04220                                  ListEntry );
04221 
04222 <span class="preprocessor">#if defined(_PREFETCH_)</span>
04223 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((Support-&gt;PrefetchMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
04224         (Support-&gt;PrefetchMdl != &amp;Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>)) {
04225 
04226         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
04227 
04228         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Support-&gt;PrefetchMdl);
04229         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Support);
04230 
04231         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04232         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04233     }
04234 <span class="preprocessor">#endif</span>
04235 <span class="preprocessor"></span>
04236     Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o10">Completed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04237     Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o3">WaitCount</a> = 1;
04238     Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o6">u</a>.Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04239     Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o13">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04240 <span class="preprocessor">#if defined(_PREFETCH_)</span>
04241 <span class="preprocessor"></span>    Support-&gt;PrefetchMdl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04242 <span class="preprocessor">#endif</span>
04243 <span class="preprocessor"></span><span class="preprocessor">#if defined (_WIN64)</span>
04244 <span class="preprocessor"></span>    Support-&gt;UsedPageTableEntries = 0;
04245 <span class="preprocessor">#endif</span>
04246 <span class="preprocessor"></span>    <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;Support-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">Event</a>);
04247     <span class="keywordflow">return</span> Support;
04248 }
04249 
04250 
04251 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04252"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a30">04252</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (
04253     IN <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> Support
04254     )
04255 
04256 <span class="comment">/*++</span>
04257 <span class="comment"></span>
04258 <span class="comment">Routine Description:</span>
04259 <span class="comment"></span>
04260 <span class="comment">    This routine returns the in page support block to a list</span>
04261 <span class="comment">    of freed blocks.</span>
04262 <span class="comment"></span>
04263 <span class="comment">Arguments:</span>
04264 <span class="comment"></span>
04265 <span class="comment">    Support - Supplies the in page support block to put on the free list.</span>
04266 <span class="comment"></span>
04267 <span class="comment">Return Value:</span>
04268 <span class="comment"></span>
04269 <span class="comment">    None.</span>
04270 <span class="comment"></span>
04271 <span class="comment">Environment:</span>
04272 <span class="comment"></span>
04273 <span class="comment">    Kernel mode, PFN lock held.</span>
04274 <span class="comment"></span>
04275 <span class="comment">--*/</span>
04276 
04277 {
04278 
04279     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04280 
04281     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Support-&gt;u.Thread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04282     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Support-&gt;WaitCount != 0);
04283 <span class="preprocessor">#if defined (_PREFETCH_)</span>
04284 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Support-&gt;ListEntry.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
04285             (Support-&gt;PrefetchMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
04286 <span class="preprocessor">#else</span>
04287 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Support-&gt;ListEntry.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04288 <span class="preprocessor">#endif</span>
04289 <span class="preprocessor"></span>    Support-&gt;WaitCount -= 1;
04290     <span class="keywordflow">if</span> (Support-&gt;WaitCount == 0) {
04291         Support-&gt;u.Thread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04292         InsertTailList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>,
04293                         &amp;Support-&gt;ListEntry);
04294         <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> += 1;
04295     }
04296     <span class="keywordflow">return</span>;
04297 }
04298 
04299 
04300 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04301"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a31">04301</a> <a class="code" href="../../d4/d8/mi_8h.html#a800">MiFlushInPageSupportBlock</a> (
04302     )
04303 
04304 <span class="comment">/*++</span>
04305 <span class="comment"></span>
04306 <span class="comment">Routine Description:</span>
04307 <span class="comment"></span>
04308 <span class="comment">    This routine examines the number of freed in page support blocks,</span>
04309 <span class="comment">    and if more than 4, frees the blocks back to the NonPagedPool.</span>
04310 <span class="comment"></span>
04311 <span class="comment"></span>
04312 <span class="comment">   ****** NB: The PFN LOCK is RELEASED and reacquired during this call ******</span>
04313 <span class="comment"></span>
04314 <span class="comment"></span>
04315 <span class="comment">Arguments:</span>
04316 <span class="comment"></span>
04317 <span class="comment">    None.</span>
04318 <span class="comment"></span>
04319 <span class="comment">Return Value:</span>
04320 <span class="comment"></span>
04321 <span class="comment">    None.</span>
04322 <span class="comment"></span>
04323 <span class="comment">Environment:</span>
04324 <span class="comment"></span>
04325 <span class="comment">    Kernel mode, PFN lock held.</span>
04326 <span class="comment"></span>
04327 <span class="comment">--*/</span>
04328 
04329 #define <a class="code" href="../../d8/d2/pagfault_8c.html#a4">MMMAX_INPAGE_SUPPORT</a> 4
04330 
04331 {
04332     KIRQL OldIrql;
04333     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> Support[10];
04334     ULONG i = 0;
04335     PLIST_ENTRY NextEntry;
04336 
04337     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
04338 
04339     <span class="keywordflow">while</span> ((<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> &gt; <a class="code" href="../../d8/d2/pagfault_8c.html#a4">MMMAX_INPAGE_SUPPORT</a>) &amp;&amp; (i &lt; 10)) {
04340         NextEntry = RemoveHeadList (&amp;<a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">ListHead</a>);
04341         Support[i] = CONTAINING_RECORD (NextEntry,
04342                                         <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">MMINPAGE_SUPPORT</a>,
04343                                         ListEntry );
04344         Support[i]-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o13">ListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04345         i += 1;
04346         <a class="code" href="../../d5/d1/mminit_8c.html#a6">MmInPageSupportList</a>.<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">Count</a> -= 1;
04347     }
04348 
04349     <span class="keywordflow">if</span> (i == 0) {
04350         <span class="keywordflow">return</span>;
04351     }
04352 
04353     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
04354 
04355     <span class="keywordflow">do</span> {
04356         i -= 1;
04357 
04358 <span class="preprocessor">#if defined (_PREFETCH_)</span>
04359 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((Support[i]-&gt;PrefetchMdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
04360             (Support[i]-&gt;PrefetchMdl != &amp;Support[i]-&gt;<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">Mdl</a>)) {
04361             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Support[i]-&gt;PrefetchMdl);
04362         }
04363 <span class="preprocessor">#endif</span>
04364 <span class="preprocessor"></span>
04365         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Support[i]);
04366     } <span class="keywordflow">while</span> (i &gt; 0);
04367 
04368     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04369 
04370     <span class="keywordflow">return</span>;
04371 }
04372 
04373 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04374"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a9">04374</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a9">MiHandleBankedSection</a> (
04375     IN PVOID VirtualAddress,
04376     IN <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad
04377     )
04378 
04379 <span class="comment">/*++</span>
04380 <span class="comment"></span>
04381 <span class="comment">Routine Description:</span>
04382 <span class="comment"></span>
04383 <span class="comment">    This routine invalidates a bank of video memory, calls out to the</span>
04384 <span class="comment">    video driver and then enables the next bank of video memory.</span>
04385 <span class="comment"></span>
04386 <span class="comment">Arguments:</span>
04387 <span class="comment"></span>
04388 <span class="comment">    VirtualAddress - Supplies the address of the faulting page.</span>
04389 <span class="comment"></span>
04390 <span class="comment">    Vad - Supplies the VAD which maps the range.</span>
04391 <span class="comment"></span>
04392 <span class="comment">Return Value:</span>
04393 <span class="comment"></span>
04394 <span class="comment">    None.</span>
04395 <span class="comment"></span>
04396 <span class="comment">Environment:</span>
04397 <span class="comment"></span>
04398 <span class="comment">    Kernel mode, PFN lock held.</span>
04399 <span class="comment"></span>
04400 <span class="comment">--*/</span>
04401 
04402 {
04403     <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">PMMBANKED_SECTION</a> Bank;
04404     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04405     ULONG BankNumber;
04406     ULONG size;
04407 
04408     Bank = Vad-&gt;u4.Banked;
04409     size = Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o2">BankSize</a>;
04410 
04411     RtlFillMemory (Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o6">CurrentMappedPte</a>,
04412                    size &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>),
04413                    (UCHAR)<a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
04414 
04415     <span class="comment">//</span>
04416     <span class="comment">// Flush the TB as we have invalidated all the PTEs in this range</span>
04417     <span class="comment">//</span>
04418 
04419     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04420 
04421     <span class="comment">//</span>
04422     <span class="comment">// Calculate new bank address and bank number.</span>
04423     <span class="comment">//</span>
04424 
04425     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
04426                         (PVOID)((ULONG_PTR)VirtualAddress &amp; ~((LONG)size - 1)));
04427     Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o6">CurrentMappedPte</a> = PointerPte;
04428 
04429     BankNumber = (ULONG)(((PCHAR)PointerPte - (PCHAR)Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o1">BasedPte</a>) &gt;&gt; Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o3">BankShift</a>);
04430 
04431     (Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o4">BankedRoutine</a>)(BankNumber, BankNumber, Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o5">Context</a>);
04432 
04433     <span class="comment">//</span>
04434     <span class="comment">// Set the new range valid.</span>
04435     <span class="comment">//</span>
04436 
04437     RtlMoveMemory (PointerPte,
04438                    &amp;Bank-&gt;<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o7">BankTemplate</a>[0],
04439                    size &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a>));
04440 
04441     <span class="keywordflow">return</span>;
04442 }
04443 
04444 
04445 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04446"></a><a class="code" href="../../d8/d2/pagfault_8c.html#a32">04446</a> <a class="code" href="../../d8/d2/pagfault_8c.html#a32">MiSessionCopyOnWrite</a> (
04447     IN <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace,
04448     IN PVOID FaultingAddress,
04449     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
04450     )
04451 
04452 <span class="comment">/*++</span>
04453 <span class="comment"></span>
04454 <span class="comment">Routine Description:</span>
04455 <span class="comment"></span>
04456 <span class="comment">    This function handles copy on write for image mapped session space.</span>
04457 <span class="comment"></span>
04458 <span class="comment">Arguments:</span>
04459 <span class="comment"></span>
04460 <span class="comment">    SessionSpace - Supplies the session space being referenced.</span>
04461 <span class="comment"></span>
04462 <span class="comment">    FaultingAddress - Supplies the address which caused the page fault.</span>
04463 <span class="comment"></span>
04464 <span class="comment">    PointerPte - Supplies the pointer to the PTE which caused the page fault.</span>
04465 <span class="comment"></span>
04466 <span class="comment">Return Value:</span>
04467 <span class="comment"></span>
04468 <span class="comment">    STATUS_SUCCESS.</span>
04469 <span class="comment"></span>
04470 <span class="comment">Environment:</span>
04471 <span class="comment"></span>
04472 <span class="comment">    Kernel mode, APCs disabled, session WSL held.</span>
04473 <span class="comment"></span>
04474 <span class="comment">--*/</span>
04475 
04476 {
04477     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04478     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
04479     PFN_NUMBER PageFrameIndex;
04480     PFN_NUMBER NewPageIndex;
04481     PULONG CopyTo;
04482     KIRQL OldIrql;
04483     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04484     PVOID VirtualAddress;
04485     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
04486 
04487 <span class="preprocessor">#if defined(_IA64_)</span>
04488 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER (FaultingAddress);
04489 <span class="preprocessor">#endif</span>
04490 <span class="preprocessor"></span>
04491     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
04492     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
04493 
04494     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1);
04495 
04496     <span class="comment">//</span>
04497     <span class="comment">// Acquire the PFN mutex.</span>
04498     <span class="comment">//</span>
04499 
04500     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
04501 
04502     WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
04503                                     SessionSpace-&gt;Vm.VmWorkingSetList,
04504                                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex);
04505 
04506     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04507 
04508     <span class="comment">//</span>
04509     <span class="comment">// The page must be copied into a new page.</span>
04510     <span class="comment">//</span>
04511 
04512     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a>(<a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
04513 
04514         <span class="comment">//</span>
04515         <span class="comment">// A wait operation was performed to obtain an available</span>
04516         <span class="comment">// page and the working set mutex and PFN mutexes have</span>
04517         <span class="comment">// been released and various things may have changed for</span>
04518         <span class="comment">// the worse.  Rather than examine all the conditions again,</span>
04519         <span class="comment">// return and if things are still proper, the fault will</span>
04520         <span class="comment">// be taken again.</span>
04521         <span class="comment">//</span>
04522 
04523         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04524         <span class="keywordflow">return</span> STATUS_SUCCESS;
04525     }
04526 
04527     <span class="comment">//</span>
04528     <span class="comment">// Verify that the page did not go into transition while the</span>
04529     <span class="comment">// PFN lock was released.  If it changed state, refault it in.</span>
04530     <span class="comment">//</span>
04531 
04532     TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
04533 
04534     <span class="keywordflow">if</span> (!(TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)) {
04535         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04536         <span class="keywordflow">return</span> STATUS_SUCCESS;
04537     }
04538 
04539     <span class="comment">//</span>
04540     <span class="comment">// Increment the number of private pages.</span>
04541     <span class="comment">//</span>
04542 
04543     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o1">CopyOnWriteCount</a> += 1;
04544 
04545     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o26">CopyOnWriteCount</a> += 1;
04546 
04547     <span class="comment">//</span>
04548     <span class="comment">// A page is being copied and made private, the global state of</span>
04549     <span class="comment">// the shared page does not need to be updated at this point because</span>
04550     <span class="comment">// it is guaranteed to be clean - no POSIX-style forking is allowed on</span>
04551     <span class="comment">// session addresses.</span>
04552     <span class="comment">//</span>
04553 
04554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 0);
04555     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(*PointerPte));
04556 
04557     <span class="comment">//</span>
04558     <span class="comment">// Get a new page with the same color as this page.</span>
04559     <span class="comment">//</span>
04560 
04561     NewPageIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a131">MI_GET_SECONDARY_COLOR</a> (PageFrameIndex,
04562                                                             Pfn1));
04563 
04564     <a class="code" href="../../d8/d2/pagfault_8c.html#a25">MiInitializeCopyOnWritePfn</a> (NewPageIndex,
04565                                 PointerPte,
04566                                 WorkingSetIndex,
04567                                 SessionSpace);
04568 
04569     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04570 
04571     <span class="comment">//</span>
04572     <span class="comment">// Copy the accessed readonly page into the newly allocated writable page.</span>
04573     <span class="comment">//</span>
04574 
04575     CopyTo = (PULONG)<a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (NewPageIndex, &amp;OldIrql);
04576 
04577     RtlCopyMemory (CopyTo, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04578 
04579     <a class="code" href="../../d4/d8/mi_8h.html#a244">MiUnmapPageInHyperSpace</a> (OldIrql);
04580 
04581     <span class="comment">//</span>
04582     <span class="comment">// Since the page was a copy on write page, make it</span>
04583     <span class="comment">// accessed, dirty and writable.  Also clear the copy-on-write</span>
04584     <span class="comment">// bit in the PTE.</span>
04585     <span class="comment">//</span>
04586 
04587     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
04588     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
04589     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (&amp;TempPte, 1);
04590     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite = 0;
04591     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = NewPageIndex;
04592 
04593     <span class="comment">//</span>
04594     <span class="comment">// If the modify bit is set in the PFN database for the</span>
04595     <span class="comment">// page, the data cache must be flushed.  This is due to the</span>
04596     <span class="comment">// fact that this process may have been cloned and the cache</span>
04597     <span class="comment">// still contains stale data destined for the page we are</span>
04598     <span class="comment">// going to remove.</span>
04599     <span class="comment">//</span>
04600 
04601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04602 
04603     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04604 
04605     <span class="comment">//</span>
04606     <span class="comment">// Flush the TB entry for this page.</span>
04607     <span class="comment">//</span>
04608 
04609     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (FaultingAddress,
04610                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04611                                 <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04612                                 (PHARDWARE_PTE)PointerPte,
04613                                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
04614                                 PreviousPte);
04615 
04616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 1);
04617 
04618     <span class="comment">//</span>
04619     <span class="comment">// Decrement the share count for the page which was copied</span>
04620     <span class="comment">// as this PTE no longer refers to it.</span>
04621     <span class="comment">//</span>
04622 
04623     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
04624 
04625     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04626     <span class="keywordflow">return</span> STATUS_SUCCESS;
04627 }
04628 
04629 <span class="preprocessor">#if DBG</span>
04630 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04631 MiCheckFileState (
04632     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn
04633     )
04634 
04635 {
04636     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
04637     LARGE_INTEGER StartingOffset;
04638 
04639     <span class="keywordflow">if</span> (Pfn-&gt;u3.e1.PrototypePte == 0) {
04640         <span class="keywordflow">return</span>;
04641     }
04642     <span class="keywordflow">if</span> (Pfn-&gt;OriginalPte.u.Soft.Prototype == 0) {
04643         <span class="keywordflow">return</span>;
04644     }
04645 
04646     Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (&amp;(Pfn-&gt;OriginalPte));
04647     <span class="keywordflow">if</span> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.NoModifiedWriting) {
04648         <span class="keywordflow">return</span>;
04649     }
04650     StartingOffset.QuadPart = <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a> (Subsection,
04651                                                   Pfn-&gt;PteAddress);
04652     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"file: %lx offset: %I64X\n"</span>,
04653             Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">ControlArea</a>-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">FilePointer</a>,
04654             StartingOffset.QuadPart);
04655     <span class="keywordflow">return</span>;
04656 }
04657 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:07 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
