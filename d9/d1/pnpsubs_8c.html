<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpsubs.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpsubs.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d0/d1/pnpsubs_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a0">IopDisableDevice</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a1">IopCreateMadeupNode</a> (IN PUNICODE_STRING ServiceKeyName, OUT PHANDLE <a class="el" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>, OUT PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, OUT PULONG InstanceNumber, IN BOOLEAN ResourceOwned)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a2">IopRemoveStringFromValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a3">IopAppendStringToValueKey</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PWSTR <a class="el" href="../../d8/d2/rtrenval_8c.html#a3">ValueName</a>, IN PUNICODE_STRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a> (OUT PUNICODE_STRING Destination, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>, IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a5">IopPrepareDriverLoading</a> (IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN HANDLE KeyHandle, IN PIMAGE_NT_HEADERS <a class="el" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ULONG ServiceInstanceOrdinal, OUT PUNICODE_STRING DeviceInstanceRegistryPath OPTIONAL, OUT PHANDLE DeviceInstanceHandle OPTIONAL, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN ACCESS_MASK DesiredAccess, IN ULONG CreateOptions, OUT PULONG Disposition OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a9">IopOpenServiceEnumKeys</a> (IN PUNICODE_STRING ServiceKeyName, IN ACCESS_MASK DesiredAccess, OUT PHANDLE ServiceHandle OPTIONAL, OUT PHANDLE ServiceEnumHandle OPTIONAL, IN BOOLEAN CreateEnum)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a10">IopGetDeviceInstanceCsConfigFlags</a> (IN PUNICODE_STRING DeviceInstance, OUT PULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a11">IopGetServiceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, OUT PULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a12">IopSetServiceInstanceCsConfigFlags</a> (IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ULONG CsConfigFlags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a13">IopOpenCurrentHwProfileDeviceInstanceKey</a> (OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN PUNICODE_STRING ServiceKeyName, IN ULONG Instance, IN ACCESS_MASK DesiredAccess, IN BOOLEAN Create)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a14">IopApplyFunctionToSubKeys</a> (IN HANDLE BaseHandle OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a> OPTIONAL, IN ACCESS_MASK DesiredAccess, IN ULONG Flags, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> SubKeyCallbackRoutine, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a15">IopRegMultiSzToUnicodeStrings</a> (IN PKEY_VALUE_FULL_INFORMATION KeyValueInformation, OUT PUNICODE_STRING *UnicodeStringList, OUT PULONG UnicodeStringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a16">IopApplyFunctionToServiceInstances</a> (IN HANDLE ServiceKeyHandle OPTIONAL, IN PUNICODE_STRING ServiceKeyName OPTIONAL, IN ACCESS_MASK DesiredAccess, IN BOOLEAN IgnoreNonCriticalErrors, IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a> DevInstCallbackRoutine, IN OUT PVOID Context, OUT PULONG ServiceInstanceOrdinal OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a17">IopMarkDuplicateDevice</a> (IN PUNICODE_STRING TargetKeyName, IN ULONG TargetInstance, IN PUNICODE_STRING SourceKeyName, IN ULONG SourceInstance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a18">IopIsDuplicatedDevices</a> (IN PCM_RESOURCE_LIST Configuration1, IN PCM_RESOURCE_LIST Configuration2, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1 OPTIONAL, IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2 OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a19">IopFreeUnicodeStringList</a> (IN PUNICODE_STRING UnicodeStringList, IN ULONG StringCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a20">IopDriverLoadingFailed</a> (IN HANDLE ServiceHandle OPTIONAL, IN PUNICODE_STRING ServiceName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a21">IopIsAnyDeviceInstanceEnabled</a> (IN PUNICODE_STRING ServiceKeyName, IN HANDLE ServiceHandle OPTIONAL, IN BOOLEAN LegacyIncluded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a22">IopIsDeviceInstanceEnabled</a> (IN HANDLE DeviceInstanceHandle OPTIONAL, IN PUNICODE_STRING DeviceInstance, IN BOOLEAN DisableIfEnabled)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a23">IopDetermineResourceListSize</a> (IN PCM_RESOURCE_LIST ResourceList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a24">IopReferenceDriverObjectByName</a> (IN PUNICODE_STRING DriverName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a25">IopDeviceObjectFromDeviceInstance</a> (IN HANDLE DeviceInstanceHandle OPTIONAL, IN PUNICODE_STRING DeviceInstance OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a26">IopDeviceObjectToDeviceInstance</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PHANDLE DeviceInstanceHandle, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a27">IopCleanupDeviceRegistryValues</a> (IN PUNICODE_STRING InstancePath, IN BOOLEAN KeepReference)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a28">IopGetDeviceResourcesFromRegistry</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN ULONG ResourceType, IN ULONG Preference, OUT PVOID *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a29">IopReadDeviceConfiguration</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN ULONG Flags, OUT PCM_RESOURCE_LIST *CmResource, OUT PULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a30">IopCmResourcesToIoResources</a> (IN ULONG SlotNumber, IN PCM_RESOURCE_LIST CmResourceList, IN ULONG Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a31">IopFilterResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList, IN PCM_RESOURCE_LIST CmList, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *FilteredList, OUT PBOOLEAN ExactMatch)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a32">IopMergeFilteredResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoList1, IN PIO_RESOURCE_REQUIREMENTS_LIST IoList2, IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a33">IopMergeCmResourceLists</a> (IN PCM_RESOURCE_LIST List1, IN PCM_RESOURCE_LIST List2, IN OUT PCM_RESOURCE_LIST *MergedList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a34">IopIsLegacyDriver</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a35">IopGetGroupOrderIndex</a> (IN HANDLE ServiceHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a36">IopDeleteLegacyKey</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a37">IopDeviceNodeCapabilitiesToRegistry</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a38">IopDeviceCapabilitiesToRegistry</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> Capabilities)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a39">IopRestartDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a40">IopDeleteKeyRecursiveCallback</a> (IN HANDLE KeyHandle, IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>, IN OUT PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a> (IN HANDLE ParentKey OPTIONAL, IN PWCHAR <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="pnpsubs.c::IopAppendStringToValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAppendStringToValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00546">546</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00555                    :
00556 
00557     This routine appends a string to a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00558     under an already opened registry handle.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present
00559     and <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a <span class="keyword">new</span> value entry will be created <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00560     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>.
00561 
00562 Parameters:
00563 
00564     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00565         be modified.
00566 
00567     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a pointer to a string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00568 
00569     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to append to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00570 
00571     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00572         value entry should be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not present.
00573 
00574 Return Value:
00575 
00576     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00577 
00578 --*/
00579 
00580 {
00581     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00582     PWSTR destinationString, p;
00583     UNICODE_STRING unicodeValueName;
00584     ULONG size;
00585     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00586 
00587     <span class="keywordflow">if</span> ( !<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> || (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length &lt; <span class="keyword">sizeof</span>(WCHAR)) ) {
00588         <span class="keywordflow">return</span> STATUS_SUCCESS;
00589     }
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">// Read registry value entry data</span>
00593     <span class="comment">//</span>
00594 
00595     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00596 
00597     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00598         <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00599 
00600             <span class="comment">//</span>
00601             <span class="comment">// if no valid entry exists and user said ok to create one</span>
00602             <span class="comment">//</span>
00603 
00604             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605         } <span class="keywordflow">else</span> {
00606             <span class="keywordflow">return</span> status;
00607         }
00608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;Type != REG_MULTI_SZ) {
00609 
00610         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00611 
00612         <span class="keywordflow">if</span>(<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
00613             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00614         } <span class="keywordflow">else</span> {
00615             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
00616         }
00617 
00618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(keyValueInformation-&gt;DataLength &lt; <span class="keyword">sizeof</span>(WCHAR) ||
00619               *(PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation) == UNICODE_NULL) {  <span class="comment">// empty or one NULL WCHAR</span>
00620 
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00622         keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Allocate a buffer to hold new data for the specified key value entry</span>
00627     <span class="comment">// Make sure the buffer is at least an empty MULTI_SZ big.</span>
00628     <span class="comment">//</span>
00629 
00630     <span class="keywordflow">if</span> (keyValueInformation) {
00631         size = keyValueInformation-&gt;DataLength + <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span> (UNICODE_NULL);
00632     } <span class="keywordflow">else</span> {
00633         size =  <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + 2 * <span class="keyword">sizeof</span>(UNICODE_NULL);
00634     }
00635 
00636     destinationString = p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
00637     <span class="keywordflow">if</span> (destinationString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00638         <span class="keywordflow">if</span> (keyValueInformation) {
00639             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00640         }
00641         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00642     }
00643 
00644     <span class="comment">//</span>
00645     <span class="comment">// Copy the existing data to our newly allocated buffer, if any</span>
00646     <span class="comment">//</span>
00647 
00648     <span class="keywordflow">if</span> (keyValueInformation) {
00649 
00650         <span class="comment">//</span>
00651         <span class="comment">// Note we  need to remove a UNICODE_NULL because the</span>
00652         <span class="comment">// MULTI_SZ has two terminating UNICODE_NULL.</span>
00653         <span class="comment">//</span>
00654 
00655         RtlMoveMemory(p,
00656                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00657                       keyValueInformation-&gt;DataLength - <span class="keyword">sizeof</span>(WCHAR)
00658                       );
00659         p += keyValueInformation-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR) - 1;
00660 
00661         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00662     }
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">// Append the user specified unicode string to our buffer</span>
00666     <span class="comment">//</span>
00667     RtlMoveMemory(p,
00668                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00669                   <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length
00670                   );
00671     p += <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00672     *p = UNICODE_NULL;
00673     p++;
00674     *p = UNICODE_NULL;
00675 
00676     <span class="comment">//</span>
00677     <span class="comment">// Finally write the data to the specified registy value entry</span>
00678     <span class="comment">//</span>
00679 
00680     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, ValueName);
00681     status = ZwSetValueKey(
00682                 Handle,
00683                 &amp;unicodeValueName,
00684                 TITLE_INDEX_VALUE,
00685                 REG_MULTI_SZ,
00686                 destinationString,
00687                 size
00688                 );
00689 
00690     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(destinationString);
00691     <span class="keywordflow">return</span> status;
00692 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pnpsubs.c::IopApplyFunctionToServiceInstances" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToServiceInstances           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreNonCriticalErrors</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DevInstCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ServiceInstanceOrdinal&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">2209</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00899">PNP_SCRATCH_BUFFER_SIZE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02221                    :
02222 
02223     This routine enumerates all device instances referenced by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance
02224     ordinal entries under a service's <span class="keyword">volatile</span> Enum key, and calls
02225     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each instance's corresponding subkey
02226     under HKLM\System\Enum.
02227 
02228 Arguments:
02229 
02230     ServiceKeyHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry. If <span class="keyword">this</span> parameter
02231         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key name must be given in
02232         ServiceKeyName (<span class="keywordflow">if</span> both parameters are specified, then ServiceKeyHandle
02233         is used, and ServiceKeyName is ignored).
02234 
02235     ServiceKeyName - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry key (under
02236         HKLM\CurrentControlSet\Services). If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
02237         then ServiceKeyHandle must contain a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired service key.
02238 
02239     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
02240         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumerated device instance keys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02241         specified (i.e., DesiredAccess is zero), then no handle will be opened
02242         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance keys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span>
02243         its DeviceInstanceHandle parameter.
02244 
02245     IgnoreNonCriticalErrors - Specifies whether <span class="keyword">this</span> function should
02246         immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on critical ones.
02247         An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an enumerated device instance
02248         key cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
02249 
02250     DevInstCallbackRoutine - Supplies a pointer to a function that will
02251         be called <span class="keywordflow">for</span> each device instance key referenced by a service instance
02252         entry under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service's <span class="keyword">volatile</span> Enum subkey. The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02253         function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
02254 
02255             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
02256                 IN     HANDLE DeviceInstanceHandle,
02257                 IN     PUNICODE_STRING DeviceInstancePath,
02258                 IN OUT PVOID Context
02259                 );
02260 
02261         where DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated device instance
02262         key, DeviceInstancePath <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (relative to
02263         HKLM\System\Enum) to <span class="keyword">this</span> device instance, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
02264         user-defined data.
02265 
02266         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
02267         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
02268 
02269     Context - Supplies a pointer to user-defined data that will be passed
02270         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each device instance key invocation.
02271 
02272     ServiceInstanceOrdinal - Optionally, receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service instance ordinal (1 based)
02273         that terminated the enumeration, or the total number of instances enumerated
02274         if the enumeration completed without being aborted.
02275 
02276 Return Value:
02277 
02278     NT status code indicating whether the device instance keys were successfully
02279     enumerated.  Note that this does not provide information on the success or
02280     failure of the callback routine--if desired, this information should be
02281     stored in the Context structure.
02282 
02283 --*/
02284 
02285 {
02286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02287     HANDLE ServiceEnumHandle, SystemEnumHandle, DeviceInstanceHandle;
02288     UNICODE_STRING TempUnicodeString;
02289     ULONG ServiceInstanceCount, i, junk;
02290     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
02291     WCHAR ValueNameString[20];
02292     BOOLEAN ContinueEnumeration;
02293 
02294     <span class="comment">//</span>
02295     <span class="comment">// First, open up the volatile Enum subkey under the specified service entry.</span>
02296     <span class="comment">//</span>
02297 
02298     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
02299         PiWstrToUnicodeString(&amp;TempUnicodeString, REGSTR_KEY_ENUM);
02300         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;ServiceEnumHandle,
02301                                        ServiceKeyHandle,
02302                                        &amp;TempUnicodeString,
02303                                        KEY_READ
02304                                        );
02305     } <span class="keywordflow">else</span> {
02306         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
02307                                         KEY_READ,
02308                                         NULL,
02309                                         &amp;ServiceEnumHandle,
02310                                         FALSE
02311                                        );
02312     }
02313     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02314         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02315     }
02316 
02317     <span class="comment">//</span>
02318     <span class="comment">// Find out how many instances are referenced in the service's Enum key.</span>
02319     <span class="comment">//</span>
02320 
02321     ServiceInstanceCount = 0;   <span class="comment">// assume none.</span>
02322 
02323     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(ServiceEnumHandle,
02324                                  REGSTR_VALUE_COUNT,
02325                                  &amp;KeyValueInformation
02326                                 );
02327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02328 
02329         <span class="keywordflow">if</span>((KeyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02330            (KeyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02331 
02332             ServiceInstanceCount = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02333 
02334         }
02335         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02336 
02337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_NAME_NOT_FOUND) {
02338         <span class="keywordflow">goto</span> PrepareForReturn;
02339     } <span class="keywordflow">else</span> {
02340         <span class="comment">//</span>
02341         <span class="comment">// If 'Count' value entry not found, consider this to mean there are simply</span>
02342         <span class="comment">// no device instance controlled by this service.</span>
02343         <span class="comment">//</span>
02344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02345     }
02346 
02347     <span class="comment">//</span>
02348     <span class="comment">// Now, enumerate each service instance, and call the specified callback function</span>
02349     <span class="comment">// for the corresponding device instance.</span>
02350     <span class="comment">//</span>
02351 
02352     <span class="keywordflow">if</span> (ServiceInstanceCount) {
02353 
02354         <span class="keywordflow">if</span> (DesiredAccess) {
02355             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SystemEnumHandle,
02356                                            NULL,
02357                                            &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02358                                            KEY_READ
02359                                            );
02360             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02361                 <span class="keywordflow">goto</span> PrepareForReturn;
02362             }
02363         } <span class="keywordflow">else</span> {
02364             <span class="comment">//</span>
02365             <span class="comment">// Set DeviceInstanceHandle to NULL, since we won't be opening up the</span>
02366             <span class="comment">// device instance keys.</span>
02367             <span class="comment">//</span>
02368             DeviceInstanceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02369         }
02370         KeyValueInformation = (PKEY_VALUE_FULL_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
02371                                                               PagedPool,
02372                                                               PNP_SCRATCH_BUFFER_SIZE);
02373         <span class="keywordflow">if</span> (!KeyValueInformation) {
02374             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
02375             <span class="keywordflow">goto</span> PrepareForReturn;
02376         }
02377         i = 0;
02378         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02379             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey (           <span class="comment">// i was initialized to zero above.</span>
02380                             ServiceEnumHandle,
02381                             i++,
02382                             KeyValueFullInformation,
02383                             KeyValueInformation,
02384                             PNP_SCRATCH_BUFFER_SIZE,
02385                             &amp;junk
02386                             );
02387 
02388             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (Status)) {
02389                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
02390                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02391                     <span class="keywordflow">break</span>;
02392                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(IgnoreNonCriticalErrors) {
02393                     <span class="keywordflow">continue</span>;
02394                 } <span class="keywordflow">else</span> {
02395                     <span class="keywordflow">break</span>;
02396                 }
02397             }
02398 
02399             <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type != REG_SZ) {
02400                 <span class="keywordflow">continue</span>;
02401             }
02402 
02403             ContinueEnumeration = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02404             TempUnicodeString.Length = 0;
02405             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;TempUnicodeString,
02406                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation),
02407                                            KeyValueInformation-&gt;DataLength
02408                                            );
02409             <span class="keywordflow">if</span> (TempUnicodeString.Length) {
02410 
02411                 <span class="comment">//</span>
02412                 <span class="comment">// We have retrieved a (non-empty) string for this service instance.</span>
02413                 <span class="comment">// If the user specified a non-zero value for the DesiredAccess</span>
02414                 <span class="comment">// parameter, we will attempt to open up the corresponding device</span>
02415                 <span class="comment">// instance key under HKLM\System\Enum.</span>
02416                 <span class="comment">//</span>
02417                 <span class="keywordflow">if</span> (DesiredAccess) {
02418                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
02419                                                    SystemEnumHandle,
02420                                                    &amp;TempUnicodeString,
02421                                                    DesiredAccess
02422                                                    );
02423                 }
02424 
02425                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02426                     <span class="comment">//</span>
02427                     <span class="comment">// Invoke the specified callback routine for this device instance.</span>
02428                     <span class="comment">//</span>
02429                     ContinueEnumeration = DevInstCallbackRoutine(DeviceInstanceHandle,
02430                                                                  &amp;TempUnicodeString,
02431                                                                  Context
02432                                                                 );
02433                     <span class="keywordflow">if</span> (DesiredAccess) {
02434                         ZwClose(DeviceInstanceHandle);
02435                     }
02436                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IgnoreNonCriticalErrors) {
02437                     <span class="keywordflow">continue</span>;
02438                 } <span class="keywordflow">else</span> {
02439                     <span class="keywordflow">break</span>;
02440                 }
02441             } <span class="keywordflow">else</span> {
02442                 <span class="keywordflow">continue</span>;
02443             }
02444             <span class="keywordflow">if</span> (!ContinueEnumeration) {
02445                 <span class="keywordflow">break</span>;
02446             }
02447         }
02448 
02449         <span class="keywordflow">if</span>(DesiredAccess) {
02450             ZwClose(SystemEnumHandle);
02451         }
02452         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyValueInformation);
02453     }
02454 
02455     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceInstanceOrdinal)) {
02456         *ServiceInstanceOrdinal = i;
02457     }
02458 
02459 PrepareForReturn:
02460 
02461     ZwClose(ServiceEnumHandle);
02462 
02463     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02464 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pnpsubs.c::IopApplyFunctionToSubKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopApplyFunctionToSubKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d8/d3/rtvbatcr_8c.html#a3">KeyName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a121">PIOP_SUBKEY_CALLBACK_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SubKeyCallbackRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">1844</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00914">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>01855                    :
01856 
01857     This routine enumerates all subkeys under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified key, and calls
01858     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified callback routine <span class="keywordflow">for</span> each subkey.
01859 
01860 Arguments:
01861 
01862     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>. If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also
01863         specified, then <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> represents a subkey under <span class="keyword">this</span> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>
01864         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys are enumerated under <span class="keyword">this</span> handle.  If <span class="keyword">this</span>
01865         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base key must be
01866         given in <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
01867 
01868     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Optional name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key whose subkeys are to be enumerated.
01869 
01870     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine
01871         needs to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys.  If no desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified (i.e.,
01872         DesiredAccess is zero), then no handle will be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01873         subkeys, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback will be passed a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">for</span> its SubKeyHandle
01874         parameter.
01875 
01876     Flags - Controls <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> behavior of subkey enumeration.  Currently, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01877         following flags are defined:
01878 
01879         <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a> - Specifies whether <span class="keyword">this</span>
01880             function should immediately terminate on all errors, or <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on
01881             critical ones.  An example of a non-critical error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> when an
01882             enumerated subkey cannot be opened <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access.
01883 
01884         FUNCTION_SUBKEY_DELETE_SUBKEYS - Specifies that each subkey should be
01885             deleted after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified SubKeyCallBackRoutine has been performed
01886             on <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Note that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NOT a recursive <span class="keyword">delete</span> on each of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01887             subkeys, just an attempt to <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey itself.  It <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey
01888             contains children, <span class="keyword">this</span> will fail.
01889 
01890     SubKeyCallbackRoutine - Supplies a pointer to a function that will
01891         be called <span class="keywordflow">for</span> each subkey found under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01892         specified key.  The prototype of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01893         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> as follows:
01894 
01895             <span class="keyword">typedef</span> BOOLEAN (*PIOP_SUBKEY_CALLBACK_ROUTINE) (
01896                 IN     HANDLE SubKeyHandle,
01897                 IN     PUNICODE_STRING SubKeyName,
01898                 IN OUT PVOID Context
01899                 );
01900 
01901         where SubKeyHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to an enumerated subkey under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01902         specified key, SubKeyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> its name, and Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a pointer to
01903         user-defined data.
01904 
01905         This function should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to <span class="keywordflow">continue</span> enumeration, or
01906         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to terminate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01907 
01908     Context - Supplies a pointer to user-defined data that will be passed
01909         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each subkey invocation.
01910 
01911 Return Value:
01912 
01913     NT status code indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkeys were successfully
01914     enumerated.  Note that <span class="keyword">this</span> does not provide information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01915     success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine--<span class="keywordflow">if</span> desired, <span class="keyword">this</span>
01916     information should be stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Context structure.
01917 
01918 --*/
01919 
01920 {
01921     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01922     BOOLEAN CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, ContinueEnumeration;
01923     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, SubKeyHandle;
01924     ULONG i, RequiredBufferLength;
01925     PKEY_BASIC_INFORMATION KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01926     <span class="comment">// Use an initial key name buffer size large enough for a 20-character key</span>
01927     <span class="comment">// (+ terminating NULL)</span>
01928     ULONG KeyInformationLength = <span class="keyword">sizeof</span>(KEY_BASIC_INFORMATION) + (20 * <span class="keyword">sizeof</span>(WCHAR));
01929     UNICODE_STRING SubKeyName;
01930 
01931     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(KeyName)) {
01932 
01933         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;Handle,
01934                                        BaseHandle,
01935                                        KeyName,
01936                                        KEY_READ
01937                                        );
01938         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01939             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01940         } <span class="keywordflow">else</span> {
01941             CloseHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01942         }
01943 
01944     } <span class="keywordflow">else</span> {
01945 
01946         <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = BaseHandle;
01947     }
01948 
01949     <span class="comment">//</span>
01950     <span class="comment">// Enumerate the subkeys until we run out of them.</span>
01951     <span class="comment">//</span>
01952     i = 0;
01953     SubKeyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01954 
01955     <span class="keywordflow">while</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01956 
01957         <span class="keywordflow">if</span>(!KeyInformation) {
01958 
01959             KeyInformation = (PKEY_BASIC_INFORMATION)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
01960                                                                     KeyInformationLength
01961                                                                    );
01962             <span class="keywordflow">if</span>(!KeyInformation) {
01963                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01964                 <span class="keywordflow">break</span>;
01965             }
01966         }
01967 
01968         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateKey(Handle,
01969                                 i,
01970                                 KeyBasicInformation,
01971                                 KeyInformation,
01972                                 KeyInformationLength,
01973                                 &amp;RequiredBufferLength
01974                                );
01975 
01976         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01977             <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01978                 <span class="comment">//</span>
01979                 <span class="comment">// Try again with larger buffer.</span>
01980                 <span class="comment">//</span>
01981                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
01982                 KeyInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01983                 KeyInformationLength = RequiredBufferLength;
01984                 <span class="keywordflow">continue</span>;
01985 
01986             } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01987                 <span class="comment">//</span>
01988                 <span class="comment">// break out of loop</span>
01989                 <span class="comment">//</span>
01990                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01991                 <span class="keywordflow">break</span>;
01992 
01993             } <span class="keywordflow">else</span> {
01994                 <span class="comment">//</span>
01995                 <span class="comment">// This is a non-critical error.</span>
01996                 <span class="comment">//</span>
01997                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
01998                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
01999                 } <span class="keywordflow">else</span> {
02000                     <span class="keywordflow">break</span>;
02001                 }
02002             }
02003         }
02004 
02005         <span class="comment">//</span>
02006         <span class="comment">// Initialize a unicode string with this key name.  Note that this string</span>
02007         <span class="comment">// WILL NOT be NULL-terminated.</span>
02008         <span class="comment">//</span>
02009         SubKeyName.Length = SubKeyName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyInformation-&gt;NameLength;
02010         SubKeyName.Buffer = KeyInformation-&gt;Name;
02011 
02012         <span class="comment">//</span>
02013         <span class="comment">// If DesiredAccess is non-zero, open a handle to this subkey.</span>
02014         <span class="comment">//</span>
02015         <span class="keywordflow">if</span>(DesiredAccess) {
02016             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;SubKeyHandle,
02017                                            Handle,
02018                                            &amp;SubKeyName,
02019                                            DesiredAccess
02020                                            );
02021             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
02022                 <span class="comment">//</span>
02023                 <span class="comment">// This is a non-critical error.</span>
02024                 <span class="comment">//</span>
02025                 <span class="keywordflow">if</span>(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a90">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>) {
02026                     <span class="keywordflow">goto</span> ContinueWithNextSubKey;
02027                 } <span class="keywordflow">else</span> {
02028                     <span class="keywordflow">break</span>;
02029                 }
02030             }
02031         }
02032 
02033         <span class="comment">//</span>
02034         <span class="comment">// Invoke the supplied callback function for this subkey.</span>
02035         <span class="comment">//</span>
02036         ContinueEnumeration = SubKeyCallbackRoutine(SubKeyHandle, &amp;SubKeyName, Context);
02037 
02038         <span class="keywordflow">if</span> (DesiredAccess) {
02039             <span class="keywordflow">if</span> (ContinueEnumeration &amp;&amp;
02040                 (Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02041                 <span class="comment">//</span>
02042                 <span class="comment">// Delete the key when asked to, only if the callback routine</span>
02043                 <span class="comment">// was successful, otherwise we may not be able to.</span>
02044                 <span class="comment">//</span>
02045                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteKey(SubKeyHandle);
02046             }
02047             ZwClose(SubKeyHandle);
02048         }
02049 
02050         <span class="keywordflow">if</span>(!ContinueEnumeration) {
02051             <span class="comment">//</span>
02052             <span class="comment">// Enumeration has been aborted.</span>
02053             <span class="comment">//</span>
02054             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02055             <span class="keywordflow">break</span>;
02056 
02057         }
02058 
02059 ContinueWithNextSubKey:
02060         <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a91">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>)) {
02061             <span class="comment">//</span>
02062             <span class="comment">// Only increment the enumeration index for non-deleted subkeys</span>
02063             <span class="comment">//</span>
02064             i++;
02065         }
02066     }
02067 
02068     <span class="keywordflow">if</span>(KeyInformation) {
02069         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(KeyInformation);
02070     }
02071 
02072     <span class="keywordflow">if</span>(CloseHandle) {
02073         ZwClose(Handle);
02074     }
02075 
02076     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02077 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="pnpsubs.c::IopCleanupDeviceRegistryValues" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCleanupDeviceRegistryValues           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>InstancePath</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>KeepReference</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03960">3960</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
<pre class="fragment"><div>03967                    :
03968 
03969     This routine cleans up a device instance key when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no
03970     longer present/enumerated.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> registered to a Service
03971     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Service's <span class="keyword">enum</span> key will also been cleaned up.
03972 
03973     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller must lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryDeciceResource
03974 
03975 Arguments:
03976 
03977     InstancePath - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key.
03978 
03979     KeepReference - supplies a <span class="keywordtype">boolean</span> value to indicate <span class="keywordflow">if</span> we should remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03980         device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to device object mapping.
03981 
03982 Return Value:
03983 
03984     status
03985 
03986 --*/
03987 
03988 {
03989     HANDLE handle, instanceHandle;
03990     UNICODE_STRING unicodeValueName;
03991     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03992     ULONG count = 0;
03993     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03994 
03995     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03996 
03997     <span class="comment">//</span>
03998     <span class="comment">// Open System\CurrentControlSet\Enum</span>
03999     <span class="comment">//</span>
04000 
04001     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04002                                    NULL,
04003                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
04004                                    KEY_ALL_ACCESS
04005                                    );
04006 
04007     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04008         <span class="keywordflow">return</span> status;
04009     }
04010 
04011     <span class="comment">//</span>
04012     <span class="comment">// Open the device instance key</span>
04013     <span class="comment">//</span>
04014 
04015     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;instanceHandle,
04016                                    handle,
04017                                    InstancePath,
04018                                    KEY_ALL_ACCESS
04019                                    );
04020 
04021     ZwClose(handle);
04022     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04023 
04024         <span class="comment">//</span>
04025         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
04026         <span class="comment">//</span>
04027 
04028         <span class="keywordflow">return</span> status;
04029     }
04030 
04031     <span class="comment">//</span>
04032     <span class="comment">// Delete the DeviceReference value name under Control key</span>
04033     <span class="comment">//</span>
04034 
04035     <span class="keywordflow">if</span> (!KeepReference) {
04036 
04037         <span class="comment">//</span>
04038         <span class="comment">// BUGBUG (lonnym)--verify that removal of the following code fragment is valid.</span>
04039         <span class="comment">//</span>
04040 <span class="preprocessor">#if 0</span>
04041 <span class="preprocessor"></span>        <span class="comment">//</span>
04042         <span class="comment">// Set the 'FoundAtEnum' value to false.</span>
04043         <span class="comment">//</span>
04044 
04045         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_FOUNDATENUM);
04046         tmpValue = 0;
04047         ZwSetValueKey(instanceHandle,
04048                       &amp;unicodeValueName,
04049                       TITLE_INDEX_VALUE,
04050                       REG_DWORD,
04051                       &amp;tmpValue,
04052                       <span class="keyword">sizeof</span>(tmpValue)
04053                       );
04054 <span class="preprocessor">#endif // (lonnym, verify removal to here)</span>
04055 <span class="preprocessor"></span>
04056         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
04057         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04058                                        instanceHandle,
04059                                        &amp;unicodeValueName,
04060                                        KEY_ALL_ACCESS
04061                                        );
04062         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
04063             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_REFERENCE);
04064             ZwDeleteValueKey(handle, &amp;unicodeValueName);
04065             ZwClose(handle);
04066         }
04067 
04068         <span class="comment">//</span>
04069         <span class="comment">// Deregister the device from its controlling service's service enum key</span>
04070         <span class="comment">//</span>
04071 
04072         status = PiDeviceRegistration( InstancePath, FALSE, NULL );
04073     }
04074 
04075     ZwClose(instanceHandle);
04076 
04077     <span class="keywordflow">return</span> status;
04078 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pnpsubs.c::IopCmResourcesToIoResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PIO_RESOURCE_REQUIREMENTS_LIST IopCmResourcesToIoResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04392">4392</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">CmResourceTypeReserved</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>.
<p>
<pre class="fragment"><div>04400                    :
04401 
04402     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input CmResourceList to IO_RESOURCE_REQUIREMENTS_LIST.
04403 
04404 Arguments:
04405 
04406     SlotNumber - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SlotNumber <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources refer to.
04407 
04408     CmResourceList - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cm resource list to convert.
04409 
04410     Priority - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logconfig
04411 
04412 Return Value:
04413 
04414     returns a IO_RESOURCE_REQUIREMENTS_LISTST <span class="keywordflow">if</span> succeeds.  Otherwise a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
04415     returned.
04416 
04417 --*/
04418 {
04419     PIO_RESOURCE_REQUIREMENTS_LIST ioResReqList;
04420     ULONG count = 0, size, i, j;
04421     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04422     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04423     PIO_RESOURCE_DESCRIPTOR ioDesc;
04424 
04425     <span class="comment">//</span>
04426     <span class="comment">// First determine number of descriptors required.</span>
04427     <span class="comment">//</span>
04428 
04429     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04430     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04431         count += cmFullDesc-&gt;PartialResourceList.Count;
04432         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04433         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04434             size = 0;
04435             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04436             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04437                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04438                  count--;
04439                  <span class="keywordflow">break</span>;
04440             }
04441             cmPartDesc++;
04442             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04443         }
04444         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04445     }
04446 
04447     <span class="keywordflow">if</span> (count == 0) {
04448         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04449     }
04450 
04451     <span class="comment">//</span>
04452     <span class="comment">// Count the extra descriptors for InterfaceType and BusNumber information.</span>
04453     <span class="comment">//</span>
04454 
04455     count += CmResourceList-&gt;Count - 1;
04456 
04457     <span class="comment">//</span>
04458     <span class="comment">// Allocate heap space for IO RESOURCE REQUIREMENTS LIST</span>
04459     <span class="comment">//</span>
04460 
04461     count++;           <span class="comment">// add one for CmResourceTypeConfigData</span>
04462     ioResReqList = (PIO_RESOURCE_REQUIREMENTS_LIST)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04463                        PagedPool,
04464                        <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
04465                            count * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR)
04466                        );
04467     <span class="keywordflow">if</span> (!ioResReqList) {
04468         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04469     }
04470 
04471     <span class="comment">//</span>
04472     <span class="comment">// Parse the cm resource descriptor and build its corresponding IO resource descriptor</span>
04473     <span class="comment">//</span>
04474 
04475     ioResReqList-&gt;InterfaceType = CmResourceList-&gt;List[0].InterfaceType;
04476     ioResReqList-&gt;BusNumber = CmResourceList-&gt;List[0].BusNumber;
04477     ioResReqList-&gt;SlotNumber = SlotNumber;
04478     ioResReqList-&gt;Reserved[0] = 0;
04479     ioResReqList-&gt;Reserved[1] = 0;
04480     ioResReqList-&gt;Reserved[2] = 0;
04481     ioResReqList-&gt;AlternativeLists = 1;
04482     ioResReqList-&gt;List[0].Version = 1;
04483     ioResReqList-&gt;List[0].Revision = 1;
04484     ioResReqList-&gt;List[0].Count = count;
04485 
04486     <span class="comment">//</span>
04487     <span class="comment">// Generate a CmResourceTypeConfigData descriptor</span>
04488     <span class="comment">//</span>
04489 
04490     ioDesc = &amp;ioResReqList-&gt;List[0].Descriptors[0];
04491     ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04492     ioDesc-&gt;Type = CmResourceTypeConfigData;
04493     ioDesc-&gt;ShareDisposition = CmResourceShareShared;
04494     ioDesc-&gt;Flags = 0;
04495     ioDesc-&gt;Spare1 = 0;
04496     ioDesc-&gt;Spare2 = 0;
04497     ioDesc-&gt;u.ConfigData.Priority = Priority;
04498     ioDesc++;
04499 
04500     cmFullDesc = &amp;CmResourceList-&gt;List[0];
04501     <span class="keywordflow">for</span> (i = 0; i &lt; CmResourceList-&gt;Count; i++) {
04502         <span class="keywordflow">if</span> (i != 0) {
04503 
04504             <span class="comment">//</span>
04505             <span class="comment">// Set up descriptor to remember the InterfaceType and BusNumber.</span>
04506             <span class="comment">//</span>
04507 
04508             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04509             ioDesc-&gt;Type = <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>;
04510             ioDesc-&gt;ShareDisposition = CmResourceShareUndetermined;
04511             ioDesc-&gt;Flags = 0;
04512             ioDesc-&gt;Spare1 = 0;
04513             ioDesc-&gt;Spare2 = 0;
04514             <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04515                 ioDesc-&gt;u.DevicePrivate.Data[0] = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04516             } <span class="keywordflow">else</span> {
04517                 ioDesc-&gt;u.DevicePrivate.Data[0] = cmFullDesc-&gt;InterfaceType;
04518             }
04519             ioDesc-&gt;u.DevicePrivate.Data[1] = cmFullDesc-&gt;BusNumber;
04520             ioDesc-&gt;u.DevicePrivate.Data[2] = 0;
04521             ioDesc++;
04522         }
04523         cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04524         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04525             ioDesc-&gt;Option = IO_RESOURCE_PREFERRED;
04526             ioDesc-&gt;Type = cmPartDesc-&gt;Type;
04527             ioDesc-&gt;ShareDisposition = cmPartDesc-&gt;ShareDisposition;
04528             ioDesc-&gt;Flags = cmPartDesc-&gt;Flags;
04529             ioDesc-&gt;Spare1 = 0;
04530             ioDesc-&gt;Spare2 = 0;
04531 
04532             size = 0;
04533             <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04534             <span class="keywordflow">case</span> CmResourceTypePort:
04535                  ioDesc-&gt;u.Port.MinimumAddress = cmPartDesc-&gt;u.Port.Start;
04536                  ioDesc-&gt;u.Port.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Port.Start.QuadPart +
04537                                                              cmPartDesc-&gt;u.Port.Length - 1;
04538                  ioDesc-&gt;u.Port.Alignment = 1;
04539                  ioDesc-&gt;u.Port.Length = cmPartDesc-&gt;u.Port.Length;
04540                  ioDesc++;
04541                  <span class="keywordflow">break</span>;
04542             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04543 <span class="preprocessor">#if defined(_X86_)</span>
04544 <span class="preprocessor"></span>                ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04545                    cmPartDesc-&gt;u.Interrupt.Level;
04546 <span class="preprocessor">#else</span>
04547 <span class="preprocessor"></span>                 ioDesc-&gt;u.Interrupt.MinimumVector = ioDesc-&gt;u.Interrupt.MaximumVector =
04548                     cmPartDesc-&gt;u.Interrupt.Vector;
04549 <span class="preprocessor">#endif</span>
04550 <span class="preprocessor"></span>                 ioDesc++;
04551                  <span class="keywordflow">break</span>;
04552             <span class="keywordflow">case</span> CmResourceTypeMemory:
04553                  ioDesc-&gt;u.Memory.MinimumAddress = cmPartDesc-&gt;u.Memory.Start;
04554                  ioDesc-&gt;u.Memory.MaximumAddress.QuadPart = cmPartDesc-&gt;u.Memory.Start.QuadPart +
04555                                                                cmPartDesc-&gt;u.Memory.Length - 1;
04556                  ioDesc-&gt;u.Memory.Alignment = 1;
04557                  ioDesc-&gt;u.Memory.Length = cmPartDesc-&gt;u.Memory.Length;
04558                  ioDesc++;
04559                  <span class="keywordflow">break</span>;
04560             <span class="keywordflow">case</span> CmResourceTypeDma:
04561                  ioDesc-&gt;u.Dma.MinimumChannel = cmPartDesc-&gt;u.Dma.Channel;
04562                  ioDesc-&gt;u.Dma.MaximumChannel = cmPartDesc-&gt;u.Dma.Channel;
04563                  ioDesc++;
04564                  <span class="keywordflow">break</span>;
04565             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04566                  size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04567                  <span class="keywordflow">break</span>;
04568             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04569                  ioDesc-&gt;u.BusNumber.MinBusNumber = cmPartDesc-&gt;u.BusNumber.Start;
04570                  ioDesc-&gt;u.BusNumber.MaxBusNumber = cmPartDesc-&gt;u.BusNumber.Start +
04571                                                     cmPartDesc-&gt;u.BusNumber.Length - 1;
04572                  ioDesc-&gt;u.BusNumber.Length = cmPartDesc-&gt;u.BusNumber.Length;
04573                  ioDesc++;
04574                  <span class="keywordflow">break</span>;
04575             <span class="keywordflow">default</span>:
04576                  ioDesc-&gt;u.DevicePrivate.Data[0] = cmPartDesc-&gt;u.DevicePrivate.Data[0];
04577                  ioDesc-&gt;u.DevicePrivate.Data[1] = cmPartDesc-&gt;u.DevicePrivate.Data[1];
04578                  ioDesc-&gt;u.DevicePrivate.Data[2] = cmPartDesc-&gt;u.DevicePrivate.Data[2];
04579                  ioDesc++;
04580                  <span class="keywordflow">break</span>;
04581             }
04582             cmPartDesc++;
04583             cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04584         }
04585         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04586     }
04587     ioResReqList-&gt;ListSize = (ULONG)((ULONG_PTR)ioDesc - (ULONG_PTR)ioResReqList);
04588     <span class="keywordflow">return</span> ioResReqList;
04589 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pnpsubs.c::IopConcatenateUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopConcatenateUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Destination</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING <a class="el" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00695">695</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00037">String1</a>, <a class="el" href="../../d0/d9/tcmpmem_8c-source.html#l00038">String2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00703                    :
00704 
00705     This routine returns a buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> concatenation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00706     two specified strings.  Since <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> optional, <span class="keyword">this</span> function may
00707     also be used to make a copy of a unicode string.  Paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> space
00708     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> destination string.  Caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00709     space once done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00710 
00711 Parameters:
00712 
00713     Destination - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00714         newly created key.
00715 
00716     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frist UNICODE_STRING.
00717 
00718     <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a> - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second UNICODE_STRING.
00719 
00720 Return Value:
00721 
00722     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00723 
00724 --*/
00725 
00726 {
00727     ULONG length;
00728     PWSTR buffer;
00729 
00730     length = <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00731     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(String2)) {
00732         length += <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length;
00733     }
00734     buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, length);
00735     <span class="keywordflow">if</span> (!buffer) {
00736         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00737     }
00738     Destination-&gt;Buffer = buffer;
00739     Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length - <span class="keyword">sizeof</span>(UNICODE_NULL);
00740     Destination-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00741     RtlMoveMemory (Destination-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Buffer, <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length);
00742     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(String2)) {
00743         RtlMoveMemory((PUCHAR)Destination-&gt;Buffer + <a class="code" href="../../d9/d9/tcmpmem_8c.html#a1">String1</a>-&gt;Length,
00744                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Buffer,
00745                       <a class="code" href="../../d9/d9/tcmpmem_8c.html#a2">String2</a>-&gt;Length
00746                      );
00747     }
00748     buffer[length / <span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00749     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnpsubs.c::IopCreateMadeupNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCreateMadeupNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>InstanceNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceOwned</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">91</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00177">CmRegistryMachineSystemCurrentControlSetEnumRootName</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00086">ReturnedHandle</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00101                    :
00102 
00103     This routine creates a <span class="keyword">new</span> instance node under System\Enum\Root\*Madeup&lt;Name&gt;
00104     key and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required <span class="keywordflow">default</span> value entries.  Also a value entry under
00105     Service\ServiceKeyName\Enum <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created madeup
00106     entry.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keyname of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> key are returned to caller.
00107     Caller must free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unicode string when he <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00108 
00109 Parameters:
00110 
00111     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00112         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
00113         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
00114         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
00115 
00116     <a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117         newly created key.
00118 
00119     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly created
00120         key.
00121 
00122     InstanceNumber - supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> InstanceNumber value
00123         entry created under service\name\<span class="keyword">enum</span> subkey.
00124 
00125     ResourceOwned - supplies a BOOLEAN variable to indicate <span class="keywordflow">if</span> caller owns
00126         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry resource exclusively.
00127 
00128 Return Value:
00129 
00130     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00131 
00132 --*/
00133 
00134 {
00135     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00136     UNICODE_STRING tmpKeyName, unicodeInstanceName, unicodeString;
00137     UNICODE_STRING rootKeyName, unicodeValueName, unicodeKeyName;
00138     HANDLE handle, enumRootHandle, hTreeHandle;
00139     ULONG instance;
00140     UCHAR unicodeBuffer[20];
00141     ULONG tmpValue, disposition = 0;
00142     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00143     PWSTR p;
00144     BOOLEAN releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00145     BOOLEAN successful;
00146 
00147     <span class="keywordflow">if</span> (!ResourceOwned) {
00148         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00149         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00150         releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">// Open LocalMachine\System\CurrentControlSet\Enum\Root</span>
00155     <span class="comment">//</span>
00156 
00157     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumRootHandle,
00158                                    NULL,
00159                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumRootName,
00160                                    KEY_ALL_ACCESS
00161                                    );
00162 
00163     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00164         <span class="keywordflow">goto</span> local_exit0;
00165     }
00166 
00167     <span class="comment">//</span>
00168     <span class="comment">// Open, and create if not already exist, System\Enum\Root\LEGACY_&lt;ServiceName&gt;</span>
00169     <span class="comment">// First, try to find the ServiceName by extracting it from user supplied</span>
00170     <span class="comment">// ServiceKeyName.</span>
00171     <span class="comment">//</span>
00172 
00173     PiWstrToUnicodeString(&amp;tmpKeyName, REGSTR_KEY_MADEUP);
00174     successful = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>( &amp;unicodeKeyName,
00175                                                &amp;tmpKeyName,
00176                                                ServiceKeyName);
00177 
00178     <span class="keywordflow">if</span> (!successful) {
00179         ZwClose(enumRootHandle);
00180         status = STATUS_INSUFFICIENT_RESOURCES;
00181         <span class="keywordflow">goto</span> local_exit0;
00182     }
00183 
00184     <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>(&amp;unicodeKeyName, &amp;unicodeKeyName, FALSE);
00185     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a376">IopFixupDeviceId</a>(unicodeKeyName.Buffer)) {
00186         status = STATUS_INVALID_PARAMETER;
00187         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00188         <span class="keywordflow">goto</span> local_exit0;
00189     }
00190 
00191     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00192                                      enumRootHandle,
00193                                      &amp;unicodeKeyName,
00194                                      KEY_ALL_ACCESS,
00195                                      REG_OPTION_NON_VOLATILE,
00196                                      NULL
00197                                      );
00198     ZwClose(enumRootHandle);
00199     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00200         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00201         <span class="keywordflow">goto</span> local_exit0;
00202     }
00203 
00204     instance = 1;
00205 
00206     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00207     status = ZwSetValueKey(
00208                 handle,
00209                 &amp;unicodeValueName,
00210                 TITLE_INDEX_VALUE,
00211                 REG_DWORD,
00212                 &amp;instance,
00213                 <span class="keyword">sizeof</span>(instance)
00214                 );
00215 
00216     instance--;
00217     *InstanceNumber = instance;
00218     PiUlongToInstanceKeyUnicodeString(&amp;unicodeInstanceName,
00219                                       unicodeBuffer + <span class="keyword">sizeof</span>(WCHAR), <span class="comment">// reserve first WCHAR space</span>
00220                                       20 - <span class="keyword">sizeof</span>(WCHAR),
00221                                       instance
00222                                       );
00223     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( ReturnedHandle,
00224                                      handle,
00225                                      &amp;unicodeInstanceName,
00226                                      KEY_ALL_ACCESS,
00227                                      REG_OPTION_NON_VOLATILE,
00228                                      &amp;disposition
00229                                      );
00230     ZwClose(handle);
00231     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00232         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00233         <span class="keywordflow">goto</span> local_exit0;
00234     }
00235 
00236     <span class="comment">//</span>
00237     <span class="comment">// Prepare newly created registry key name for returning to caller</span>
00238     <span class="comment">//</span>
00239 
00240     *(PWSTR)unicodeBuffer = OBJ_NAME_PATH_SEPARATOR;
00241     unicodeInstanceName.Buffer = (PWSTR)unicodeBuffer;
00242     unicodeInstanceName.Length += <span class="keyword">sizeof</span>(WCHAR);
00243     unicodeInstanceName.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
00244     PiWstrToUnicodeString(&amp;rootKeyName, REGSTR_KEY_ROOTENUM);
00245     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tmpKeyName, L<span class="stringliteral">"\\"</span>);
00246     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;unicodeString, &amp;tmpKeyName, &amp;unicodeKeyName);
00247     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00248     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;tmpKeyName, &amp;rootKeyName, &amp;unicodeString);
00249     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00250     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(KeyName, &amp;tmpKeyName, &amp;unicodeInstanceName);
00251 
00252     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00253 
00254         <span class="comment">//</span>
00255         <span class="comment">// Create all the default value entry for the newly created key.</span>
00256         <span class="comment">// Service = ServiceKeyName</span>
00257         <span class="comment">// FoundAtEnum = 1</span>
00258         <span class="comment">// Class = "LegacyDriver"</span>
00259         <span class="comment">// ClassGUID = GUID for legacy driver class</span>
00260         <span class="comment">// ConfigFlags = 0</span>
00261         <span class="comment">//</span>
00262         <span class="comment">// Create "Control" subkey with "NewlyCreated" value key</span>
00263         <span class="comment">//</span>
00264 
00265         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00266         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
00267                                          *ReturnedHandle,
00268                                          &amp;unicodeValueName,
00269                                          KEY_ALL_ACCESS,
00270                                          REG_OPTION_VOLATILE,
00271                                          NULL
00272                                          );
00273         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00274             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEWLY_CREATED);
00275             tmpValue = 0;
00276             ZwSetValueKey(handle,
00277                           &amp;unicodeValueName,
00278                           TITLE_INDEX_VALUE,
00279                           REG_DWORD,
00280                           &amp;tmpValue,
00281                           <span class="keyword">sizeof</span>(tmpValue)
00282                           );
00283             ZwClose(handle);
00284         }
00285 
00286         handle = *<a class="code" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>;
00287 
00288         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_SERVICE);
00289         p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
00290                                   ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00291         <span class="keywordflow">if</span>(p) {
00292             RtlMoveMemory(p, ServiceKeyName-&gt;Buffer, ServiceKeyName-&gt;Length);
00293             p[ServiceKeyName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
00294             ZwSetValueKey(
00295                         handle,
00296                         &amp;unicodeValueName,
00297                         TITLE_INDEX_VALUE,
00298                         REG_SZ,
00299                         p,
00300                         ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00301                         );
00302             <span class="comment">//</span>
00303             <span class="comment">// We'll keep the null-terminated service name buffer around for a while,</span>
00304             <span class="comment">// because we may need it later on for the DeviceDesc in case the service</span>
00305             <span class="comment">// has no DisplayName.</span>
00306             <span class="comment">//</span>
00307             <span class="comment">// ExFreePool(p);</span>
00308         }
00309 
00310         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_LEGACY);
00311         tmpValue = 1;
00312         ZwSetValueKey(
00313                     handle,
00314                     &amp;unicodeValueName,
00315                     TITLE_INDEX_VALUE,
00316                     REG_DWORD,
00317                     &amp;tmpValue,
00318                     <span class="keyword">sizeof</span>(tmpValue)
00319                     );
00320 
00321         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CONFIG_FLAGS);
00322         tmpValue = 0;
00323         ZwSetValueKey(
00324                     handle,
00325                     &amp;unicodeValueName,
00326                     TITLE_INDEX_VALUE,
00327                     REG_DWORD,
00328                     &amp;tmpValue,
00329                     <span class="keyword">sizeof</span>(tmpValue)
00330                     );
00331 
00332         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASS);
00333         ZwSetValueKey(
00334                     handle,
00335                     &amp;unicodeValueName,
00336                     TITLE_INDEX_VALUE,
00337                     REG_SZ,
00338                     REGSTR_VALUE_LEGACY_DRIVER,
00339                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER)
00340                     );
00341 
00342         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_CLASSGUID);
00343         ZwSetValueKey(
00344                     handle,
00345                     &amp;unicodeValueName,
00346                     TITLE_INDEX_VALUE,
00347                     REG_SZ,
00348                     REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID,
00349                     <span class="keyword">sizeof</span>(REGSTR_VALUE_LEGACY_DRIVER_CLASS_GUID)
00350                     );
00351 
00352 
00353         <span class="comment">//</span>
00354         <span class="comment">// Initialize DeviceDesc= value entry.  If the service key has a "DisplayName"</span>
00355         <span class="comment">// value entry, it is used as the DeviceDesc value.  Otherwise, the service key</span>
00356         <span class="comment">// name is used.</span>
00357         <span class="comment">//</span>
00358 
00359         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
00360                                         KEY_READ,
00361                                         &amp;handle,
00362                                         NULL,
00363                                         FALSE
00364                                         );
00365         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00366 
00367             keyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368             unicodeString.Length = 0;
00369             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00370                                          REGSTR_VALUE_DISPLAY_NAME,
00371                                          &amp;keyValueInformation
00372                                         );
00373             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00374                 <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_SZ) {
00375                     <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &gt; <span class="keyword">sizeof</span>(UNICODE_NULL)) {
00376                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeString,
00377                                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00378                                                        keyValueInformation-&gt;DataLength
00379                                                        );
00380                     }
00381                 }
00382             }
00383             <span class="keywordflow">if</span> ((unicodeString.Length == 0) &amp;&amp; p) {
00384 
00385                 <span class="comment">//</span>
00386                 <span class="comment">// No DisplayName--use the service key name.</span>
00387                 <span class="comment">//</span>
00388 
00389                 unicodeString.Length = ServiceKeyName-&gt;Length;
00390                 unicodeString.MaximumLength = ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00391                 unicodeString.Buffer = p;
00392             }
00393 
00394             <span class="keywordflow">if</span>(unicodeString.Length) {
00395                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DEVICE_DESC);
00396                 ZwSetValueKey(*ReturnedHandle,
00397                               &amp;unicodeValueName,
00398                               TITLE_INDEX_VALUE,
00399                               REG_SZ,
00400                               unicodeString.Buffer,
00401                               unicodeString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
00402                               );
00403             }
00404             <span class="keywordflow">if</span> (keyValueInformation) {
00405                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00406             }
00407             ZwClose(handle);
00408         }
00409 
00410         <span class="keywordflow">if</span>(p) {
00411             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
00412         }
00413     }
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Create new value entry under ServiceKeyName\Enum to reflect the newly</span>
00417     <span class="comment">// added made-up device instance node.</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00421     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00422     releaseResource = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00423 
00424     status = <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( KeyName, TRUE, NULL );
00425 
00426     <span class="keywordflow">if</span> (ResourceOwned) {
00427         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00428         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00429     }
00430     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tmpKeyName);
00431     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
00435         <span class="comment">//</span>
00436 
00437         ZwClose(*ReturnedHandle);
00438         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(KeyName);
00439     }
00440 local_exit0:
00441     <span class="keywordflow">if</span> (releaseResource) {
00442         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00443         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00444     }
00445     <span class="keywordflow">return</span> status;
00446 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpsubs.c::IopCreateRegistryKeyEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCreateRegistryKeyEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateOptions</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG Disposition&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">1156</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/mapper_8c-source.html#l01955">ComPortDBAdd()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03624">IoOpenDeviceInterfaceRegistryKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00680">IopGetRootDevices()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l02009">IopIsFirmwareDisabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">IopPrepareDriverLoading()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l09922">IopProcessSetInterfaceState()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03929">IopRegisterDeviceInterface()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01931">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02663">PnPBiosCopyIoDecode()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>.
<p>
<pre class="fragment"><div>01167                    :
01168 
01169     Opens or creates a registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
01170     passed in based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node. This name may specify a key
01171     that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, in which <span class="keywordflow">case</span> each intermediate subkey
01172     will be created (<span class="keywordflow">if</span> Create is TRUE).
01173 
01174     NOTE: Creating a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (i.e., more than one of the keys in the path
01175     <span class="keywordflow">do</span> not presently exist) requires that a BaseHandle be specified.
01176 
01177 Arguments:
01178 
01179     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
01180         was opened.
01181 
01182     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
01183         If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> specifies a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> that must be created, then <span class="keyword">this</span> parameter
01184         must be specified, and <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> must be a relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01185 
01186     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created (possibly a registry path)
01187 
01188     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01189         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01190 
01191     CreateOptions - Options passed to ZwCreateKey.
01192 
01193     Disposition - If <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> optional pointer receives a ULONG indicating
01194         whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key was newly created:
01195 
01196             REG_CREATED_NEW_KEY - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keyword">new</span> Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was created
01197             REG_OPENED_EXISTING_KEY - An existing Registry <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> was opened
01198 
01199 Return Value:
01200 
01201    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01202 
01203 --*/
01204 
01205 {
01206     OBJECT_ATTRIBUTES objectAttributes;
01207     ULONG disposition, baseHandleIndex = 0, keyHandleIndex = 1, closeBaseHandle;
01208     HANDLE handles[2];
01209     BOOLEAN continueParsing;
01210     PWCHAR pathEndPtr, pathCurPtr, pathBeginPtr;
01211     ULONG pathComponentLength;
01212     UNICODE_STRING unicodeString;
01213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01214 
01215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01216 
01217     InitializeObjectAttributes( &amp;objectAttributes,
01218                                 KeyName,
01219                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01220                                 BaseHandle,
01221                                 (PSECURITY_DESCRIPTOR) NULL
01222                                 );
01223     <span class="comment">//</span>
01224     <span class="comment">// Attempt to create the path as specified. We have to try it this</span>
01225     <span class="comment">// way first, because it allows us to create a key without a BaseHandle</span>
01226     <span class="comment">// (if only the last component of the registry path is not present).</span>
01227     <span class="comment">//</span>
01228     status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01229                          DesiredAccess,
01230                          &amp;objectAttributes,
01231                          0,
01232                          (PUNICODE_STRING) NULL,
01233                          CreateOptions,
01234                          &amp;disposition
01235                          );
01236 
01237     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND &amp;&amp; ARGUMENT_PRESENT(BaseHandle)) {
01238         <span class="comment">//</span>
01239         <span class="comment">// If we get to here, then there must be more than one element of the</span>
01240         <span class="comment">// registry path that does not currently exist.  We will now parse the</span>
01241         <span class="comment">// specified path, extracting each component and doing a ZwCreateKey on it.</span>
01242         <span class="comment">//</span>
01243         handles[baseHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01244         handles[keyHandleIndex] = BaseHandle;
01245         closeBaseHandle = 0;
01246         continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01247         pathBeginPtr = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer;
01248         pathEndPtr = (PWCHAR)((PCHAR)pathBeginPtr + <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length);
01249         status = STATUS_SUCCESS;
01250 
01251         <span class="keywordflow">while</span>(continueParsing) {
01252             <span class="comment">//</span>
01253             <span class="comment">// There's more to do, so close the previous base handle (if necessary),</span>
01254             <span class="comment">// and replace it with the current key handle.</span>
01255             <span class="comment">//</span>
01256             <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01257                 ZwClose(handles[baseHandleIndex]);
01258             }
01259             baseHandleIndex = keyHandleIndex;
01260             keyHandleIndex = (keyHandleIndex + 1) &amp; 1;  <span class="comment">// toggle between 0 and 1.</span>
01261             handles[keyHandleIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01262 
01263             <span class="comment">//</span>
01264             <span class="comment">// Extract next component out of the specified registry path.</span>
01265             <span class="comment">//</span>
01266             <span class="keywordflow">for</span>(pathCurPtr = pathBeginPtr;
01267                 ((pathCurPtr &lt; pathEndPtr) &amp;&amp; (*pathCurPtr != OBJ_NAME_PATH_SEPARATOR));
01268                 pathCurPtr++);
01269 
01270             <span class="keywordflow">if</span>((pathComponentLength = (ULONG)((PCHAR)pathCurPtr - (PCHAR)pathBeginPtr))) {
01271                 <span class="comment">//</span>
01272                 <span class="comment">// Then we have a non-empty path component (key name).  Attempt</span>
01273                 <span class="comment">// to create this key.</span>
01274                 <span class="comment">//</span>
01275                 unicodeString.Buffer = pathBeginPtr;
01276                 unicodeString.Length = unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)pathComponentLength;
01277 
01278                 InitializeObjectAttributes(&amp;objectAttributes,
01279                                            &amp;unicodeString,
01280                                            OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01281                                            handles[baseHandleIndex],
01282                                            (PSECURITY_DESCRIPTOR) NULL
01283                                           );
01284                 status = ZwCreateKey(&amp;(handles[keyHandleIndex]),
01285                                      DesiredAccess,
01286                                      &amp;objectAttributes,
01287                                      0,
01288                                      (PUNICODE_STRING) NULL,
01289                                      CreateOptions,
01290                                      &amp;disposition
01291                                     );
01292                 <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01293                     <span class="comment">//</span>
01294                     <span class="comment">// Increment the closeBaseHandle value, which basically tells us whether</span>
01295                     <span class="comment">// the BaseHandle passed in has been 'shifted out' of our way, so that</span>
01296                     <span class="comment">// we should start closing our base handles when we're finished with them.</span>
01297                     <span class="comment">//</span>
01298                     closeBaseHandle++;
01299                 } <span class="keywordflow">else</span> {
01300                     continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01301                     <span class="keywordflow">continue</span>;
01302                 }
01303             } <span class="keywordflow">else</span> {
01304                 <span class="comment">//</span>
01305                 <span class="comment">// Either a path separator ('\') was included at the beginning of</span>
01306                 <span class="comment">// the path, or we hit 2 consecutive separators.</span>
01307                 <span class="comment">//</span>
01308                 status = STATUS_INVALID_PARAMETER;
01309                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01310                 <span class="keywordflow">continue</span>;
01311             }
01312 
01313             <span class="keywordflow">if</span>((pathCurPtr == pathEndPtr) ||
01314                ((pathBeginPtr = pathCurPtr + 1) == pathEndPtr)) {
01315                 <span class="comment">//</span>
01316                 <span class="comment">// Then we've reached the end of the path</span>
01317                 <span class="comment">//</span>
01318                 continueParsing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01319             }
01320         }
01321 
01322         <span class="keywordflow">if</span>(closeBaseHandle &gt; 1) {
01323             ZwClose(handles[baseHandleIndex]);
01324         }
01325     }
01326 
01327     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01328         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = handles[keyHandleIndex];
01329 
01330         <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Disposition)) {
01331             *Disposition = disposition;
01332         }
01333     }
01334 
01335     <span class="keywordflow">return</span> status;
01336 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="pnpsubs.c::IopDeleteKeyRecursive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeleteKeyRecursive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ParentKey&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">5902</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>.
<p>
<pre class="fragment"><div>05908                    :
05909 
05910     Recursively deletes all subkeys of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>, then deletes <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.
05911 
05912 Arguments:
05913 
05914     ParentKey - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent key of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> then <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
05915         expected to start with \Registry.
05916 
05917     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of subkey to <span class="keyword">delete</span>, as a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> terminated UNICODE string.
05918 
05919 Return Value:
05920 
05921     STATUS_SUCCESS <span class="keywordflow">if</span> no errors, otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate error.
05922 
05923 --*/
05924 {
05925     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status = STATUS_SUCCESS;
05926     BOOLEAN        result;
05927     HANDLE         hKey;
05928     UNICODE_STRING unicodeKeyName;
05929 
05930     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05931 
05932     <span class="comment">//</span>
05933     <span class="comment">// Attempt to open the key name we were given</span>
05934     <span class="comment">//</span>
05935     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeKeyName, KeyName);
05936     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hKey,
05937                                    ParentKey,
05938                                    &amp;unicodeKeyName,
05939                                    KEY_ALL_ACCESS
05940                                    );
05941     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05942         <span class="comment">//</span>
05943         <span class="comment">// Recusively delete all subkeys</span>
05944         <span class="comment">//</span>
05945         result = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a40">IopDeleteKeyRecursiveCallback</a>(hKey,
05946                                                &amp;unicodeKeyName,
05947                                                (PVOID)&amp;status);
05948         <span class="keywordflow">if</span> (result) {
05949             <span class="comment">//</span>
05950             <span class="comment">// It is safe to delete this key</span>
05951             <span class="comment">//</span>
05952             status = ZwDeleteKey(hKey);
05953         }
05954         ZwClose(hKey);
05955     }
05956 
05957     <span class="keywordflow">return</span> status;
05958 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="pnpsubs.c::IopDeleteKeyRecursiveCallback" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopDeleteKeyRecursiveCallback           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">5846</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00914">FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00913">FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01690">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, and <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05846">IopDeleteKeyRecursiveCallback()</a>.
<p>
<pre class="fragment"><div>05853                    :
05854 
05855     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a callback routine to IopApplyFunctionToSubkeys, that gets called
05856     through <a class="code" href="../../d9/d0/pnpiop_8h.html#a308">IopDeleteKeyRecursive</a>.  This routine prepares a given key <span class="keywordflow">for</span>
05857     deletion by deleting all of its subkeys.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done, <span class="keyword">using</span>
05858     IopApplyFunctionToSubkeys, with instructions to <span class="keyword">delete</span> all enumerated
05859     subkeys, and calling <span class="keyword">this</span> routine as a callback routine, <span class="keywordflow">if</span> necessary, until
05860     no subkeys remain.  KeyHandle can then be successfully deleted by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05861     caller.
05862 
05863 Arguments:
05864 
05865     KeyHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to a subkey that has been enumerated by
05866         IopApplyFunctionToSubkeys.
05867 
05868     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey whose handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by KeyHandle.
05869 
05870     Context - Supplies a pointer to user-defined data that will be passed
05871         in to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine at each subkey invocation.
05872 
05873 Return Value:
05874 
05875     BOOLEAN that returns whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given key can be safely deleted.
05876 
05877 --*/
05878 {
05879     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05880 
05881     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05882 
05883     UNREFERENCED_PARAMETER(KeyName);
05884 
05885     <span class="comment">//</span>
05886     <span class="comment">// delete any subkeys, recursively if necessary</span>
05887     <span class="comment">//</span>
05888     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a12">IopApplyFunctionToSubKeys</a>(
05889         KeyHandle,
05890         NULL,
05891         KEY_ALL_ACCESS,
05892         FUNCTIONSUBKEY_FLAG_IGNORE_NON_CRITICAL_ERRORS |
05893         FUNCTIONSUBKEY_FLAG_DELETE_SUBKEYS,
05894         IopDeleteKeyRecursiveCallback,
05895         Context);
05896 
05897     *((<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> *)Context) = status;
05898     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
05899 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pnpsubs.c::IopDeleteLegacyKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDeleteLegacyKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">5453</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03841">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>05459                    :
05460 
05461     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy= value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver's legacy_xxx key
05462     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one.  If yes, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Legacy key.
05463 
05464 Parameters:
05465 
05466     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object.
05467 
05468 Return Value:
05469 
05470     None.  If anything fails in <span class="keyword">this</span> routine, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy key stays.
05471 
05472 --*/
05473 
05474 {
05475     WCHAR buffer[100];
05476     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05477     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName;
05478     ULONG length;
05479     HANDLE handle, handle1, handlex, enumHandle;
05480     ULONG legacy;
05481     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05482     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
05483     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05484 
05485     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
05486 
05487     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05488     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
05489 
05490     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
05491                                    NULL,
05492                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
05493                                    KEY_ALL_ACCESS
05494                                    );
05495 
05496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05497         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05498     }
05499 
05500     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), L<span class="stringliteral">"ROOT\\LEGACY_%s"</span>, serviceName-&gt;Buffer);
05501     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
05502     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
05503     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
05504     deviceName.Buffer = buffer;
05505 
05506     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
05507                                    enumHandle,
05508                                    &amp;deviceName,
05509                                    KEY_ALL_ACCESS
05510                                    );
05511 
05512     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05513 
05514         deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
05515                    OBJ_NAME_PATH_SEPARATOR;
05516         deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
05517         PiUlongToInstanceKeyUnicodeString(
05518                                 &amp;instanceName,
05519                                 buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
05520                                 <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
05521                                 0
05522                                 );
05523         deviceName.Length += instanceName.Length;
05524 
05525 
05526         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05527                                        handle1,
05528                                        &amp;instanceName,
05529                                        KEY_ALL_ACCESS
05530                                        );
05531         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05532             legacy = 1;
05533             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05534                                           REGSTR_VALUE_LEGACY,
05535                                           &amp;keyValueInformation);
05536             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05537                 <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
05538                     (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
05539                     legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
05540                 }
05541                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05542             }
05543             <span class="keywordflow">if</span> (legacy != 0) {
05544 
05545                 <span class="comment">//</span>
05546                 <span class="comment">// We also want to delete the madeup device node</span>
05547                 <span class="comment">//</span>
05548 
05549                 deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
05550                 <span class="keywordflow">if</span> (deviceObject) {
05551 
05552                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNodex, devNodey;
05553 
05554                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05555                     <span class="keywordflow">if</span> (deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
05556 
05557                         <span class="comment">//</span>
05558                         <span class="comment">// Now mark this one deleted.</span>
05559                         <span class="comment">//</span>
05560                         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode)) {
05561                             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
05562                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
05563                         }
05564 
05565                         <span class="comment">//</span>
05566                         <span class="comment">// This is actually doing nothing because DeviceNode-&gt;ResourceList is NULL.</span>
05567                         <span class="comment">//</span>
05568 
05569                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, FALSE);
05570                         devNodex = deviceNode;
05571                         <span class="keywordflow">while</span> (devNodex) {
05572                             devNodey = devNodex;
05573                             devNodex = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
05574                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05575                             devNodey-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05576                         }
05577 
05578                         deviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>;  <span class="comment">// remove its boot config if any</span>
05579                         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
05580                     }
05581                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
05582                 }
05583 
05584                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
05585                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05586                                                handle,
05587                                                &amp;unicodeName,
05588                                                KEY_ALL_ACCESS
05589                                                );
05590                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05591                     ZwDeleteKey(handlex);
05592                 }
05593                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
05594                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handlex,
05595                                                handle,
05596                                                &amp;unicodeName,
05597                                                KEY_ALL_ACCESS
05598                                                );
05599                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05600                     ZwDeleteKey(handlex);
05601                 }
05602 
05603                 ZwClose(enumHandle);
05604 
05605                 <span class="comment">//</span>
05606                 <span class="comment">// We need to call IopCleanupDeviceRegistryValue even we are going to</span>
05607                 <span class="comment">// delete it.  Because, it also cleans up related value names in other</span>
05608                 <span class="comment">// keys.</span>
05609                 <span class="comment">//</span>
05610 
05611                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a25">IopCleanupDeviceRegistryValues</a>(&amp;deviceName, FALSE);
05612                 ZwDeleteKey(handle);
05613                 ZwDeleteKey(handle1);
05614             } <span class="keywordflow">else</span> {
05615                 ZwClose(handle);
05616                 ZwClose(handle1);
05617                 ZwClose(enumHandle);
05618             }
05619         } <span class="keywordflow">else</span> {
05620             ZwClose(handle1);
05621             ZwClose(enumHandle);
05622         }
05623     } <span class="keywordflow">else</span> {
05624         ZwClose(enumHandle);
05625     }
05626 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05627     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
05628     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05629     <span class="keywordflow">return</span>;
05630 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pnpsubs.c::IopDetermineResourceListSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG IopDetermineResourceListSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ResourceList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03631">3631</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>.
<p>
<pre class="fragment"><div>03637                    :
03638 
03639     This routine determines size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in ResourceList
03640     structure.
03641 
03642 Arguments:
03643 
03644     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
03645 
03646 Return Value:
03647 
03648     size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list structure.
03649 
03650 --*/
03651 
03652 {
03653     ULONG totalSize, listSize, descriptorSize, i, j;
03654     PCM_FULL_RESOURCE_DESCRIPTOR fullResourceDesc;
03655     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
03656 
03657     <span class="keywordflow">if</span> (!ResourceList) {
03658         totalSize = 0;
03659     } <span class="keywordflow">else</span> {
03660         totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, List);
03661         fullResourceDesc = &amp;ResourceList-&gt;List[0];
03662         <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
03663             listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
03664                                     PartialResourceList) +
03665                        FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
03666                                     PartialDescriptors);
03667             partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
03668             <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
03669                 descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
03670                 <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
03671                     descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
03672                 }
03673                 listSize += descriptorSize;
03674                 partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
03675                                         ((PUCHAR)partialDescriptor + descriptorSize);
03676             }
03677             totalSize += listSize;
03678             fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
03679                                       ((PUCHAR)fullResourceDesc + listSize);
03680         }
03681     }
03682     <span class="keywordflow">return</span> totalSize;
03683 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="pnpsubs.c::IopDeviceCapabilitiesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceCapabilitiesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Capabilities</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05675">5675</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/io_8h.html#a365">DEVICE_CAPABILITIES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01867">FIELD_SIZE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d3/d4/editreg_8c-source.html#l00332">Version</a>.
<p>
<pre class="fragment"><div>05682                    :
05683 
05684     This routine updates device capabilities, must be called after a valid device instance key has been created
05685     Called directly from <a class="code" href="../../d6/d0/pnpenum_8c.html#a35">IopProcessNewDeviceNode</a>, and indirecly via <a class="code" href="../../d9/d0/pnpiop_8h.html#a328">IopDeviceNodeCapabilitiesToRegistry</a>
05686     after device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started.
05687 
05688 Arguments:
05689 
05690     DeviceObject - supplies a pointer to a device object whose registry
05691         values are to be updated.
05692 
05693 Return Value:
05694 
05695     status
05696 
05697 --*/
05698 
05699 {
05700     HANDLE handle;
05701     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05702     UNICODE_STRING unicodeName;
05703     ULONG tmpValue;
05704 
05705     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05706 
05707     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != NULL);
05708     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Capabilities != NULL);
05709 
05710     <span class="comment">//</span>
05711     <span class="comment">// Open the device instance key</span>
05712     <span class="comment">//</span>
05713     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceNode-&gt;PhysicalDeviceObject, &amp;handle, KEY_ALL_ACCESS);
05714     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05715         <span class="keywordflow">return</span> status;
05716     }
05717 
05718     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
05719         Capabilities-&gt;SurpriseRemovalOK = 0;
05720     }
05721 
05722     <span class="comment">//</span>
05723     <span class="comment">// Assert the bit fields are completely contained in a ULONG. This is a</span>
05724     <span class="comment">// public structure, so it shouldn't ever change, but paranoia is a good</span>
05725     <span class="comment">// thing...</span>
05726     <span class="comment">//</span>
05727     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Address) -
05728             FIELD_OFFSET(<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a>, Version) -
05729             FIELD_SIZE  (DEVICE_CAPABILITIES, Version)) == <span class="keyword">sizeof</span>(ULONG));
05730 
05731     DeviceNode-&gt;CapabilityFlags =
05732         *((PULONG) (((PUCHAR) Capabilities) +
05733         FIELD_OFFSET(DEVICE_CAPABILITIES, Version) +
05734         <a class="code" href="../../d9/d0/pnpiop_8h.html#a100">FIELD_SIZE</a>(DEVICE_CAPABILITIES, Version)));
05735 
05736     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_CAPABILITIES);
05737     tmpValue = (Capabilities-&gt;LockSupported)          |
05738                (Capabilities-&gt;EjectSupported    &lt;&lt; 1) |
05739                (Capabilities-&gt;WarmEjectSupported&lt;&lt; 1) |
05740                (Capabilities-&gt;Removable         &lt;&lt; 2) |
05741                (Capabilities-&gt;DockDevice        &lt;&lt; 3) |
05742                (Capabilities-&gt;UniqueID          &lt;&lt; 4) |
05743                (Capabilities-&gt;SilentInstall     &lt;&lt; 5) |
05744                (Capabilities-&gt;RawDeviceOK       &lt;&lt; 6) |
05745                (Capabilities-&gt;SurpriseRemovalOK &lt;&lt; 7) |
05746                (Capabilities-&gt;HardwareDisabled  &lt;&lt; 8) |
05747                (Capabilities-&gt;NonDynamic        &lt;&lt; 9);
05748 
05749     status = ZwSetValueKey(
05750                   handle,
05751                   &amp;unicodeName,
05752                   TITLE_INDEX_VALUE,
05753                   REG_DWORD,
05754                   &amp;tmpValue,
05755                   <span class="keyword">sizeof</span>(tmpValue)
05756                   );
05757 
05758     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_UI_NUMBER);
05759     tmpValue = Capabilities-&gt;UINumber;
05760     <span class="keywordflow">if</span>(tmpValue != (ULONG)-1) {
05761         ZwSetValueKey(handle,
05762                       &amp;unicodeName,
05763                       TITLE_INDEX_VALUE,
05764                       REG_DWORD,
05765                       &amp;tmpValue,
05766                       <span class="keyword">sizeof</span>(tmpValue)
05767                       );
05768     } <span class="keywordflow">else</span> {
05769         ZwDeleteValueKey(handle, &amp;unicodeName);
05770     }
05771 
05772     ZwClose(handle);
05773     <span class="keywordflow">return</span> status;
05774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="pnpsubs.c::IopDeviceNodeCapabilitiesToRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceNodeCapabilitiesToRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05633">5633</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l05524">IopDeviceCapabilitiesToRegistry()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03694">IopQueryDeviceCapabilities()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00879">IopInitializeDeviceInstanceKey()</a>, and <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00994">IopStartAndEnumerateDevice()</a>.
<p>
<pre class="fragment"><div>05639                    :
05640 
05641     Called after start to refresh Capability flags
05642 
05643 Arguments:
05644 
05645     DeviceObject - supplies a pointer to a device object whose registry
05646         values are to be updated.
05647 
05648 Return Value:
05649 
05650     status
05651 
05652 --*/
05653 
05654 {
05655     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05656     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
05657 
05658     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05659 
05660     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode != NULL);
05661 
05662     <span class="comment">//</span>
05663     <span class="comment">// Open the device instance key</span>
05664     <span class="comment">//</span>
05665 
05666     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(DeviceNode, &amp;capabilities);
05667     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05668         <span class="keywordflow">return</span> status;
05669     }
05670 
05671     <span class="keywordflow">return</span> <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a35">IopDeviceCapabilitiesToRegistry</a>(DeviceNode,&amp;capabilities);
05672 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pnpsubs.c::IopDeviceObjectFromDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> IopDeviceObjectFromDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING DeviceInstance&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">3759</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00037">IO_TYPE_DEVICE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01176">_DEVICE_OBJECT::Type</a>.
<p>
<pre class="fragment"><div>03766                    :
03767 
03768     This routine receives a DeviceInstance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> (or DeviceInstance handle) and
03769     returns a reference to a bus device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceInstance.
03770 
03771     Note, caller must owner <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a> before calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function,
03772 
03773 Arguments:
03774 
03775     DeviceInstanceHandle - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry Device Instance key.
03776         If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstance must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03777 
03778     DeviceInstance - supplies a UNICODE_STRING to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
03779         <span class="keywordflow">if</span> <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DeviceInstanceHandle must specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
03780         to its registry key.
03781 
03782 Returns:
03783 
03784     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> reference to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired bus device object.
03785 
03786 --*/
03787 
03788 {
03789     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03790     HANDLE handle, deviceHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03791     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03792     UNICODE_STRING unicodeName;
03793     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03794     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03795 
03796     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03797 
03798     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03799 
03800         <span class="comment">//</span>
03801         <span class="comment">// Treat HTREE\ROOT\0 specially</span>
03802         <span class="comment">//</span>
03803         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ROOT_DEVNODE);
03804 
03805         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeName, DeviceInstance, TRUE)) {
03806 
03807             deviceReference = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
03808             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceReference);
03809             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03810 
03811             <span class="keywordflow">return</span> deviceReference;
03812         }
03813 
03814         <span class="comment">//</span>
03815         <span class="comment">// first open System\CCS\Enum key and then the device instance key.</span>
03816         <span class="comment">//</span>
03817 
03818         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03819                                        NULL,
03820                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03821                                        KEY_READ
03822                                        );
03823 
03824         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03825             <span class="keywordflow">return</span> deviceReference;
03826         }
03827 
03828         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceInstance);
03829         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceHandle,
03830                                        handle,
03831                                        DeviceInstance,
03832                                        KEY_READ
03833                                        );
03834         ZwClose(handle);
03835         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03836             <span class="keywordflow">return</span> deviceReference;
03837         }
03838         DeviceInstanceHandle = deviceHandle;
03839     }
03840 
03841     <span class="comment">//</span>
03842     <span class="comment">// Read the address of device object</span>
03843     <span class="comment">//</span>
03844 
03845     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03846     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03847                                    DeviceInstanceHandle,
03848                                    &amp;unicodeName,
03849                                    KEY_READ
03850                                    );
03851     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03852         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03853     }
03854 
03855     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
03856                                   REGSTR_VALUE_DEVICE_REFERENCE,
03857                                   &amp;keyValueInformation);
03858     ZwClose(handle);
03859     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03860         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03861             (keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG_PTR))) {
03862 
03863             deviceReference = *(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03864         }
03865         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03866     }
03867     <span class="keywordflow">if</span> (!deviceReference) {
03868         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03869     }
03870 
03871     <span class="comment">//</span>
03872     <span class="comment">// Make sure the address of the device object is not clobbered,</span>
03873     <span class="comment">// unfortunately if the address is truly bogus we will bugcheck since</span>
03874     <span class="comment">// try/except doesn't work for kernel addresses.</span>
03875     <span class="comment">//</span>
03876 
03877     <span class="keywordflow">if</span> (deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o0">Type</a> != <a class="code" href="../../d0/d5/io_8h.html#a2">IO_TYPE_DEVICE</a>) {
03878         deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03879     } <span class="keywordflow">else</span> {
03880         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceReference-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03881         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> == deviceReference)) {
03882             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceReference);
03883         } <span class="keywordflow">else</span> {
03884             deviceReference = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03885         }
03886     }
03887 
03888 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03889     <span class="keywordflow">if</span> (deviceHandle) {
03890         ZwClose(deviceHandle);
03891     }
03892     <span class="keywordflow">return</span> deviceReference;
03893 
03894 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pnpsubs.c::IopDeviceObjectToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDeviceObjectToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstanceHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03897">3897</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>03905                    :
03906 
03907     This routine receives a DeviceObject pointer and returns a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
03908     instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> under registry System\ENUM key.
03909 
03910     Note, caller must owner <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a> before calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function,
03911 
03912 Arguments:
03913 
03914     DeviceObject - supplies a pointer to a physical device object.
03915 
03916     DeviceInstanceHandle - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry
03917              device instance key.
03918 
03919     DesiredAccess - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to <span class="keyword">this</span> key.
03920 
03921 Returns:
03922 
03923     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03924 
03925 --*/
03926 
03927 {
03928     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03929     HANDLE handle;
03930     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03931 
03932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03933 
03934     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03935                                    NULL,
03936                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03937                                    KEY_READ
03938                                    );
03939 
03940     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03941         <span class="keywordflow">return</span> status;
03942     }
03943 
03944     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03945     <span class="keywordflow">if</span> (deviceNode &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length != 0)) {
03946         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
03947                                        handle,
03948                                        &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>,
03949                                        DesiredAccess
03950                                        );
03951     } <span class="keywordflow">else</span> {
03952         status = STATUS_INVALID_DEVICE_REQUEST;
03953     }
03954     ZwClose(handle);
03955 
03956     <span class="keywordflow">return</span> status;
03957 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnpsubs.c::IopDisableDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDisableDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03125">3125</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00831">IopClearDevNodeProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00927">IopRemoveDevice()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03132                    :
03133 
03134     This routine tries to ask a bus driver stopping decoding resources
03135 
03136 Arguments:
03137 
03138     DeviceNode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to be disabled.
03139 
03140     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance handle.
03141 
03142 Returns:
03143 
03144     None.
03145 
03146 --*/
03147 
03148 {
03149     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03150 
03151     <span class="comment">//</span>
03152     <span class="comment">// If the device has boot config, we will query-remove and remove the device to free</span>
03153     <span class="comment">// the boot config if possible.</span>
03154     <span class="comment">//</span>
03155 
03156     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_QUERY_REMOVE_DEVICE);
03157 
03158     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03159 
03160         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_REMOVE_DEVICE);
03161         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
03162         <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(DeviceNode, TRUE);
03163 
03164     } <span class="keywordflow">else</span> {
03165 
03166         <a class="code" href="../../d0/d1/pnpirp_8c.html#a21">IopRemoveDevice</a> (DeviceNode-&gt;PhysicalDeviceObject, IRP_MN_CANCEL_REMOVE_DEVICE);
03167     }
03168 
03169     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode)) {
03170         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_NOT_CONFIGURED) ||
03171                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_FAILED_INSTALL) ||
03172                <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(DeviceNode, CM_PROB_REINSTALL));
03173 
03174         <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(DeviceNode);
03175     }
03176 
03177     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(DeviceNode, CM_PROB_DISABLED);
03178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pnpsubs.c::IopDriverLoadingFailed" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDriverLoadingFailed           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">2779</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00835">IopSetDevNodeProblem</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02786                    :
02787 
02788     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when driver failed to start.  All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device
02789     instances controlled by <span class="keyword">this</span> driver/service are marked as failing to
02790     start.
02791 
02792 Arguments:
02793 
02794     ServiceKeyHandle - Optionally, supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver service node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02795         registry that controls <span class="keyword">this</span> device instance.  If <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
02796         then ServiceKeyName <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry.
02797 
02798     ServiceKeyName - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service entry that controls
02799         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance. This must be specified <span class="keywordflow">if</span> ServiceKeyHandle isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> given.
02800 
02801 Returns:
02802 
02803     None.
02804 
02805 --*/
02806 
02807 {
02808     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02809     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
02810     BOOLEAN closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, deletePdo;
02811     HANDLE handle, serviceEnumHandle, controlHandle;
02812     HANDLE sysEnumHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02813     ULONG deviceFlags, count, newCount, i, j;
02814     UNICODE_STRING unicodeValueName, deviceInstanceName;
02815     WCHAR unicodeBuffer[20];
02816 
02817     <span class="comment">//</span>
02818     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
02819     <span class="comment">//</span>
02820 
02821     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
02822         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceName,
02823                                         KEY_READ,
02824                                         &amp;ServiceHandle,
02825                                         &amp;serviceEnumHandle,
02826                                         FALSE
02827                                         );
02828         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02829     } <span class="keywordflow">else</span> {
02830         PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_ENUM);
02831         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceEnumHandle,
02832                                        ServiceHandle,
02833                                        &amp;unicodeValueName,
02834                                        KEY_READ
02835                                        );
02836     }
02837     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
02838 
02839         <span class="comment">//</span>
02840         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
02841         <span class="comment">//</span>
02842 
02843         <span class="keywordflow">return</span> status;
02844     }
02845 
02846     <span class="comment">//</span>
02847     <span class="comment">// Set "STARTFAILED" flags.  So, we won't load it again.</span>
02848     <span class="comment">//</span>
02849 
02850     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeValueName, L<span class="stringliteral">"INITSTARTFAILED"</span>);
02851     deviceFlags = 1;
02852     ZwSetValueKey(
02853                 serviceEnumHandle,
02854                 &amp;unicodeValueName,
02855                 TITLE_INDEX_VALUE,
02856                 REG_DWORD,
02857                 &amp;deviceFlags,
02858                 <span class="keyword">sizeof</span>(deviceFlags)
02859                 );
02860 
02861     <span class="comment">//</span>
02862     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
02863     <span class="comment">// Enum key.</span>
02864     <span class="comment">//</span>
02865 
02866     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
02867                                    REGSTR_VALUE_COUNT,
02868                                    &amp;keyValueInformation
02869                                    );
02870     count = 0;
02871     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02872         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
02873             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
02874 
02875             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
02876         }
02877         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02878     }
02879     <span class="keywordflow">if</span> (count == 0) {
02880         ZwClose(serviceEnumHandle);
02881         <span class="keywordflow">if</span> (closeHandle) {
02882             ZwClose(ServiceHandle);
02883         }
02884         <span class="keywordflow">return</span> status;
02885     }
02886 
02887     <span class="comment">//</span>
02888     <span class="comment">// Open HTREE\ROOT\0 key so later we can remove device instance key</span>
02889     <span class="comment">// from its AttachedComponents value name.</span>
02890     <span class="comment">//</span>
02891 
02892     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;sysEnumHandle,
02893                                    NULL,
02894                                    &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
02895                                    KEY_ALL_ACCESS
02896                                    );
02897 
02898     <span class="comment">//</span>
02899     <span class="comment">// Walk through each registered device instance to mark its Problem and</span>
02900     <span class="comment">// StatusFlags as fail to start and reset its ActiveService</span>
02901     <span class="comment">//</span>
02902 
02903     newCount = count;
02904     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
02905         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02906         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
02907                      ServiceHandle,
02908                      ServiceName,
02909                      i,
02910                      &amp;deviceInstanceName,
02911                      &amp;handle,
02912                      KEY_ALL_ACCESS
02913                      );
02914 
02915         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02916 
02917             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
02918             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02919 
02920             <span class="comment">//</span>
02921             <span class="comment">// If the device instance is a detected device reported during driver's</span>
02922             <span class="comment">// DriverEntry we need to clean it up.</span>
02923             <span class="comment">//</span>
02924 
02925             deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
02926             <span class="keywordflow">if</span> (deviceObject) {
02927                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02928                 <span class="keywordflow">if</span> (deviceNode) {
02929 
02930                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, TRUE);
02931 
02932                     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)) {
02933 
02934                         <span class="comment">//</span>
02935                         <span class="comment">// Now mark this one deleted.</span>
02936                         <span class="comment">//</span>
02937                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>;
02938 
02939                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_DEVICE_NOT_THERE);
02940                         deletePdo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02941                     }
02942                 }
02943                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);  <span class="comment">// added via IopDeviceObjectFromDeviceInstance</span>
02944             }
02945 
02946             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02947             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
02948 
02949             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
02950             controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02951             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlHandle,
02952                                            handle,
02953                                            &amp;unicodeValueName,
02954                                            KEY_ALL_ACCESS
02955                                            );
02956             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02957 
02958                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(controlHandle,
02959                                              REGSTR_VALUE_NEWLY_CREATED,
02960                                              &amp;keyValueInformation);
02961                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02962                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
02963                 }
02964                 <span class="keywordflow">if</span> ((status != STATUS_OBJECT_NAME_NOT_FOUND) &amp;&amp;
02965                     (status != STATUS_OBJECT_PATH_NOT_FOUND)) {
02966 
02967                     <span class="comment">//</span>
02968                     <span class="comment">// Remove the instance value name from service enum key</span>
02969                     <span class="comment">//</span>
02970 
02971                     PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
02972                     status = ZwDeleteValueKey (serviceEnumHandle, &amp;unicodeValueName);
02973                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02974 
02975                         <span class="comment">//</span>
02976                         <span class="comment">// If we can successfaully remove the instance value entry</span>
02977                         <span class="comment">// from service enum key, we then remove the device instance key</span>
02978                         <span class="comment">// Otherwise, we go thru normal path to mark driver loading failed</span>
02979                         <span class="comment">// in the device instance key.</span>
02980                         <span class="comment">//</span>
02981 
02982                         newCount--;
02983 
02984                         ZwDeleteKey(controlHandle);
02985                         ZwDeleteKey(handle);
02986 
02987 
02988                         <span class="comment">//</span>
02989                         <span class="comment">// We also want to delete the ROOT\LEGACY_&lt;driver&gt; key</span>
02990                         <span class="comment">//</span>
02991 
02992                         <span class="keywordflow">if</span> (sysEnumHandle) {
02993                             deviceInstanceName.Length -= 5 * <span class="keyword">sizeof</span>(WCHAR);
02994                             deviceInstanceName.Buffer[deviceInstanceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
02995                                                  UNICODE_NULL;
02996                             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
02997                                                            sysEnumHandle,
02998                                                            &amp;deviceInstanceName,
02999                                                            KEY_ALL_ACCESS
03000                                                            );
03001                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03002                                 ZwDeleteKey(handle);
03003                             }
03004                         }
03005 
03006                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
03007 
03008                         <span class="comment">//</span>
03009                         <span class="comment">// If there is a PDO for this device, remove it</span>
03010                         <span class="comment">//</span>
03011 
03012                         <span class="keywordflow">if</span> (deletePdo) {
03013                             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
03014                         }
03015 
03016                         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
03017                         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03018 
03019                         <span class="keywordflow">continue</span>;
03020                     }
03021                 }
03022             }
03023 
03024             <span class="comment">//</span>
03025             <span class="comment">// Reset Control\ActiveService value name.</span>
03026             <span class="comment">//</span>
03027 
03028             <span class="keywordflow">if</span> (controlHandle) {
03029                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
03030                 ZwDeleteValueKey(controlHandle, &amp;unicodeValueName);
03031                 ZwClose(controlHandle);
03032             }
03033 
03034             ZwClose(handle);
03035             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceName.Buffer);
03036 
03037             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
03038             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03039 
03040         }
03041     }
03042 
03043     <span class="comment">//</span>
03044     <span class="comment">// If some instance value entry is deleted, we need to update the count of instance</span>
03045     <span class="comment">// value entries and rearrange the instance value entries under service enum key.</span>
03046     <span class="comment">//</span>
03047 
03048     <span class="keywordflow">if</span> (newCount != count) {
03049 
03050         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03051         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
03052 
03053         <span class="keywordflow">if</span> (newCount != 0) {
03054             j = 0;
03055             i = 0;
03056             <span class="keywordflow">while</span> (i &lt; count) {
03057                 PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, i);
03058                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(serviceEnumHandle,
03059                                              unicodeValueName.Buffer,
03060                                              &amp;keyValueInformation
03061                                              );
03062                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03063                     <span class="keywordflow">if</span> (i != j) {
03064 
03065                         <span class="comment">//</span>
03066                         <span class="comment">// Need to change the instance i to instance j</span>
03067                         <span class="comment">//</span>
03068 
03069                         ZwDeleteValueKey(serviceEnumHandle, &amp;unicodeValueName);
03070 
03071                         PiUlongToUnicodeString(&amp;unicodeValueName, unicodeBuffer, 20, j);
03072                         ZwSetValueKey (serviceEnumHandle,
03073                                        &amp;unicodeValueName,
03074                                        TITLE_INDEX_VALUE,
03075                                        REG_SZ,
03076                                        (PVOID)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
03077                                        keyValueInformation-&gt;DataLength
03078                                        );
03079                     }
03080                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03081                     j++;
03082                 }
03083                 i++;
03084             }
03085         }
03086 
03087         <span class="comment">//</span>
03088         <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
03089         <span class="comment">//</span>
03090 
03091         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_COUNT);
03092 
03093         ZwSetValueKey(serviceEnumHandle,
03094                       &amp;unicodeValueName,
03095                       TITLE_INDEX_VALUE,
03096                       REG_DWORD,
03097                       &amp;newCount,
03098                       <span class="keyword">sizeof</span> (newCount)
03099                       );
03100         PiWstrToUnicodeString( &amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
03101 
03102         ZwSetValueKey(serviceEnumHandle,
03103                       &amp;unicodeValueName,
03104                       TITLE_INDEX_VALUE,
03105                       REG_DWORD,
03106                       &amp;newCount,
03107                       <span class="keyword">sizeof</span> (newCount)
03108                       );
03109 
03110         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
03111         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03112     }
03113     ZwClose(serviceEnumHandle);
03114     <span class="keywordflow">if</span> (closeHandle) {
03115         ZwClose(ServiceHandle);
03116     }
03117     <span class="keywordflow">if</span> (sysEnumHandle) {
03118         ZwClose(sysEnumHandle);
03119     }
03120 
03121     <span class="keywordflow">return</span> STATUS_SUCCESS;
03122 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="pnpsubs.c::IopFilterResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFilterResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>CmList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>FilteredList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactMatch</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04592">4592</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>04601                    :
04602 
04603     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input IoList based on input BootConfig.
04604 
04605 
04606 Arguments:
04607 
04608     IoList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to an IoResourceRequirementsList
04609 
04610     CmList - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to a BootConfig.
04611 
04612     FilteredList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filtered resource
04613              requirements list.
04614 
04615 Return Value:
04616 
04617     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
04618 
04619 --*/
04620 {
04621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04622     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
04623     PIO_RESOURCE_LIST ioResourceList, newIoResourceList, selectedResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04624     PIO_RESOURCE_DESCRIPTOR ioResourceDescriptor, ioResourceDescriptorEnd;
04625     PIO_RESOURCE_DESCRIPTOR newIoResourceDescriptor, configDataDescriptor;
04626     LONG ioResourceDescriptorCount = 0;
04627     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> version;
04628     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04629     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
04630     ULONG cmDescriptorCount = 0;
04631     ULONG size, i, j, oldCount, phase;
04632     LONG k, alternativeLists;
04633     BOOLEAN exactMatch;
04634 
04635     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04636 
04637     *FilteredList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04638     *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04639 
04640     <span class="comment">//</span>
04641     <span class="comment">// Make sure there is some resource requirements to be filtered.</span>
04642     <span class="comment">// If no, we will convert CmList/BootConfig to an IoResourceRequirementsList</span>
04643     <span class="comment">//</span>
04644 
04645     <span class="keywordflow">if</span> (IoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList-&gt;AlternativeLists == 0) {
04646         <span class="keywordflow">if</span> (CmList &amp;&amp; CmList-&gt;Count != 0) {
04647             *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
04648         }
04649         <span class="keywordflow">return</span> STATUS_SUCCESS;
04650     }
04651 
04652     <span class="comment">//</span>
04653     <span class="comment">// Make a copy of the Io Resource Requirements List</span>
04654     <span class="comment">//</span>
04655 
04656     ioList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, IoList-&gt;ListSize);
04657     <span class="keywordflow">if</span> (ioList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04658         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04659     }
04660 
04661     RtlMoveMemory(ioList, IoList, IoList-&gt;ListSize);
04662 
04663     <span class="comment">//</span>
04664     <span class="comment">// If there is no BootConfig, simply return the copy of the input Io list.</span>
04665     <span class="comment">//</span>
04666 
04667     <span class="keywordflow">if</span> (CmList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || CmList-&gt;Count == 0) {
04668         *FilteredList = ioList;
04669         <span class="keywordflow">return</span> STATUS_SUCCESS;
04670     }
04671 
04672     <span class="comment">//</span>
04673     <span class="comment">// First determine minimum number of descriptors required.</span>
04674     <span class="comment">//</span>
04675 
04676     cmFullDesc = &amp;CmList-&gt;List[0];
04677     <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04678         cmDescriptorCount += cmFullDesc-&gt;PartialResourceList.Count;
04679         cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04680         <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04681             size = 0;
04682             <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04683             <span class="keywordflow">case</span> CmResourceTypeConfigData:
04684             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04685                  cmDescriptorCount--;
04686                  <span class="keywordflow">break</span>;
04687             <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04688                  size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04689                  cmDescriptorCount--;
04690                  <span class="keywordflow">break</span>;
04691             <span class="keywordflow">default</span>:
04692 
04693                  <span class="comment">//</span>
04694                  <span class="comment">// Invalid cmresource list.  Ignore it and use io resources</span>
04695                  <span class="comment">//</span>
04696 
04697                  <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04698                      cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04699                      cmDescriptorCount--;
04700                  }
04701             }
04702             cmDescriptor++;
04703             cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04704         }
04705         cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04706     }
04707 
04708     <span class="keywordflow">if</span> (cmDescriptorCount == 0) {
04709         *FilteredList = ioList;
04710         <span class="keywordflow">return</span> STATUS_SUCCESS;
04711     }
04712 
04713     <span class="comment">//</span>
04714     <span class="comment">// cmDescriptorCount is the number of BootConfig Descriptors needs.</span>
04715     <span class="comment">//</span>
04716     <span class="comment">// For each IO list Alternative ...</span>
04717     <span class="comment">//</span>
04718 
04719     ioResourceList = ioList-&gt;List;
04720     k = ioList-&gt;AlternativeLists;
04721     <span class="keywordflow">while</span> (--k &gt;= 0) {
04722         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04723         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04724         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04725             ioResourceDescriptor-&gt;Spare1 = 0;
04726             ioResourceDescriptor++;
04727         }
04728         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
04729     }
04730 
04731     ioResourceList = ioList-&gt;List;
04732     k = alternativeLists = ioList-&gt;AlternativeLists;
04733     <span class="keywordflow">while</span> (--k &gt;= 0) {
04734         version = ioResourceList-&gt;Version;
04735         <span class="keywordflow">if</span> (version == 0xffff) {  <span class="comment">// Convert bogus version to valid number</span>
04736             version = 1;
04737         }
04738 
04739         <span class="comment">//</span>
04740         <span class="comment">// We use Version field to store number of BootConfig found.</span>
04741         <span class="comment">// Count field to store new number of descriptor in the alternative list.</span>
04742         <span class="comment">//</span>
04743 
04744         ioResourceList-&gt;Version = 0;
04745         oldCount = ioResourceList-&gt;Count;
04746 
04747         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04748         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
04749 
04750         <span class="keywordflow">if</span> (ioResourceDescriptor == ioResourceDescriptorEnd) {
04751 
04752             <span class="comment">//</span>
04753             <span class="comment">// An alternative list with zero descriptor count</span>
04754             <span class="comment">//</span>
04755 
04756             ioResourceList-&gt;Version = 0xffff;  <span class="comment">// Mark it as invalid</span>
04757             ioList-&gt;AlternativeLists--;
04758             <span class="keywordflow">continue</span>;
04759         }
04760 
04761         exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04762 
04763         <span class="comment">//</span>
04764         <span class="comment">// For each Cm Resource descriptor ... except DevicePrivate and</span>
04765         <span class="comment">// DeviceSpecific...</span>
04766         <span class="comment">//</span>
04767 
04768         cmFullDesc = &amp;CmList-&gt;List[0];
04769         <span class="keywordflow">for</span> (i = 0; i &lt; CmList-&gt;Count; i++) {
04770             cmDescriptor = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04771             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
04772                 size = 0;
04773                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04774                 <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04775                      <span class="keywordflow">break</span>;
04776                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04777                      size = cmDescriptor-&gt;u.DeviceSpecificData.DataSize;
04778                      <span class="keywordflow">break</span>;
04779                 <span class="keywordflow">default</span>:
04780                     <span class="keywordflow">if</span> (cmDescriptor-&gt;Type == CmResourceTypeNull ||
04781                         cmDescriptor-&gt;Type &gt;= CmResourceTypeMaximum) {
04782                         <span class="keywordflow">break</span>;
04783                     }
04784 
04785                     <span class="comment">//</span>
04786                     <span class="comment">// Check CmDescriptor against current Io Alternative list</span>
04787                     <span class="comment">//</span>
04788 
04789                     <span class="keywordflow">for</span> (phase = 0; phase &lt; 2; phase++) {
04790                         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
04791                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04792                             <span class="keywordflow">if</span> ((ioResourceDescriptor-&gt;Type == cmDescriptor-&gt;Type) &amp;&amp;
04793                                 (ioResourceDescriptor-&gt;Spare1 == 0)) {
04794                                 ULONGLONG min1, max1, min2, max2;
04795                                 ULONG len1 = 1, len2 = 1, align1, align2;
04796                                 UCHAR share1, share2;
04797 
04798                                 share2 = ioResourceDescriptor-&gt;ShareDisposition;
04799                                 share1 = cmDescriptor-&gt;ShareDisposition;
04800                                 <span class="keywordflow">if</span> ((share1 == CmResourceShareUndetermined) ||
04801                                     (share1 &gt; CmResourceShareShared)) {
04802                                     share1 = share2;
04803                                 }
04804                                 <span class="keywordflow">if</span> ((share2 == CmResourceShareUndetermined) ||
04805                                     (share2 &gt; CmResourceShareShared)) {
04806                                     share2 = share1;
04807                                 }
04808                                 align1 = align2 = 1;
04809 
04810                                 <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04811                                 <span class="keywordflow">case</span> CmResourceTypePort:
04812                                 <span class="keywordflow">case</span> CmResourceTypeMemory:
04813                                     min1 = cmDescriptor-&gt;u.Port.Start.QuadPart;
04814                                     max1 = cmDescriptor-&gt;u.Port.Start.QuadPart + cmDescriptor-&gt;u.Port.Length - 1;
04815                                     len1 = cmDescriptor-&gt;u.Port.Length;
04816                                     min2 = ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart;
04817                                     max2 = ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart;
04818                                     len2 = ioResourceDescriptor-&gt;u.Port.Length;
04819                                     align2 = ioResourceDescriptor-&gt;u.Port.Alignment;
04820                                     <span class="keywordflow">break</span>;
04821                                 <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04822                                     max1 = min1 = cmDescriptor-&gt;u.Interrupt.Vector;
04823                                     min2 = ioResourceDescriptor-&gt;u.Interrupt.MinimumVector;
04824                                     max2 = ioResourceDescriptor-&gt;u.Interrupt.MaximumVector;
04825                                     <span class="keywordflow">break</span>;
04826                                 <span class="keywordflow">case</span> CmResourceTypeDma:
04827                                     min1 = max1 =cmDescriptor-&gt;u.Dma.Channel;
04828                                     min2 = ioResourceDescriptor-&gt;u.Dma.MinimumChannel;
04829                                     max2 = ioResourceDescriptor-&gt;u.Dma.MaximumChannel;
04830                                     <span class="keywordflow">break</span>;
04831                                 <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04832                                     min1 = cmDescriptor-&gt;u.BusNumber.Start;
04833                                     max1 = cmDescriptor-&gt;u.BusNumber.Start + cmDescriptor-&gt;u.BusNumber.Length - 1;
04834                                     len1 = cmDescriptor-&gt;u.BusNumber.Length;
04835                                     min2 = ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber;
04836                                     max2 = ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber;
04837                                     len2 = ioResourceDescriptor-&gt;u.BusNumber.Length;
04838                                     <span class="keywordflow">break</span>;
04839                                 <span class="keywordflow">default</span>:
04840                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04841                                     <span class="keywordflow">break</span>;
04842                                 }
04843                                 <span class="keywordflow">if</span> (phase == 0) {
04844                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 == min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1) {
04845 
04846                                         <span class="comment">//</span>
04847                                         <span class="comment">// For phase 0 match, we want near exact match...</span>
04848                                         <span class="comment">//</span>
04849 
04850                                         <span class="keywordflow">if</span> (max2 != max1) {
04851                                             exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04852                                         }
04853                                         ioResourceList-&gt;Version++;
04854                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04855                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04856                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04857 
04858                                             ioDesc = ioResourceDescriptor;
04859                                             ioDesc--;
04860                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04861                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04862                                                 ioResourceList-&gt;Count--;
04863                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04864                                                     ioDesc--;
04865                                                 } <span class="keywordflow">else</span> {
04866                                                     <span class="keywordflow">break</span>;
04867                                                 }
04868                                             }
04869                                         }
04870                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04871                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04872                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypePort ||
04873                                             ioResourceDescriptor-&gt;Type == CmResourceTypeMemory) {
04874                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04875                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04876                                             ioResourceDescriptor-&gt;u.Port.Alignment = 1;
04877                                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type == CmResourceTypeBusNumber) {
04878                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04879                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04880                                         }
04881                                         ioResourceDescriptor++;
04882                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04883                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04884                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04885                                                 ioResourceDescriptor++;
04886                                                 ioResourceList-&gt;Count--;
04887                                             } <span class="keywordflow">else</span> {
04888                                                 <span class="keywordflow">break</span>;
04889                                             }
04890                                         }
04891                                         phase = 1;   <span class="comment">// skip phase 1</span>
04892                                         <span class="keywordflow">break</span>;
04893                                     } <span class="keywordflow">else</span> {
04894                                         ioResourceDescriptor++;
04895                                     }
04896                                 } <span class="keywordflow">else</span> {
04897                                     exactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04898                                     <span class="keywordflow">if</span> (share1 == share2 &amp;&amp; min2 &lt;= min1 &amp;&amp; max2 &gt;= max1 &amp;&amp; len2 &gt;= len1 &amp;&amp;
04899                                         (min1 &amp; (align2 - 1)) == 0) {
04900 
04901                                         <span class="comment">//</span>
04902                                         <span class="comment">// Io range covers Cm range ... Change the Io range to what is specified</span>
04903                                         <span class="comment">// in BootConfig.</span>
04904                                         <span class="comment">//</span>
04905                                         <span class="comment">//</span>
04906 
04907                                         <span class="keywordflow">switch</span> (cmDescriptor-&gt;Type) {
04908                                         <span class="keywordflow">case</span> CmResourceTypePort:
04909                                         <span class="keywordflow">case</span> CmResourceTypeMemory:
04910                                             ioResourceDescriptor-&gt;u.Port.MinimumAddress.QuadPart = min1;
04911                                             ioResourceDescriptor-&gt;u.Port.MaximumAddress.QuadPart = min1 + len2 - 1;
04912                                             <span class="keywordflow">break</span>;
04913                                         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04914                                         <span class="keywordflow">case</span> CmResourceTypeDma:
04915                                             ioResourceDescriptor-&gt;u.Interrupt.MinimumVector = (ULONG)min1;
04916                                             ioResourceDescriptor-&gt;u.Interrupt.MaximumVector = (ULONG)max1;
04917                                             <span class="keywordflow">break</span>;
04918                                         <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04919                                             ioResourceDescriptor-&gt;u.BusNumber.MinBusNumber = (ULONG)min1;
04920                                             ioResourceDescriptor-&gt;u.BusNumber.MaxBusNumber = (ULONG)(min1 + len2 - 1);
04921                                             <span class="keywordflow">break</span>;
04922                                         }
04923                                         ioResourceList-&gt;Version++;
04924                                         ioResourceDescriptor-&gt;Spare1 = 0x80;
04925                                         ioResourceDescriptor-&gt;Flags = cmDescriptor-&gt;Flags;
04926                                         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04927                                             PIO_RESOURCE_DESCRIPTOR ioDesc;
04928 
04929                                             ioDesc = ioResourceDescriptor;
04930                                             ioDesc--;
04931                                             <span class="keywordflow">while</span> (ioDesc &gt;= ioResourceList-&gt;Descriptors) {
04932                                                 ioDesc-&gt;Type = CmResourceTypeNull;
04933                                                 ioResourceList-&gt;Count--;
04934                                                 <span class="keywordflow">if</span> (ioDesc-&gt;Option == IO_RESOURCE_ALTERNATIVE) {
04935                                                     ioDesc--;
04936                                                 } <span class="keywordflow">else</span> {
04937                                                     <span class="keywordflow">break</span>;
04938                                                 }
04939                                             }
04940                                         }
04941                                         ioResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
04942                                         ioResourceDescriptor++;
04943                                         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
04944                                             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
04945                                                 ioResourceDescriptor-&gt;Type = CmResourceTypeNull;
04946                                                 ioResourceList-&gt;Count--;
04947                                                 ioResourceDescriptor++;
04948                                             } <span class="keywordflow">else</span> {
04949                                                 <span class="keywordflow">break</span>;
04950                                             }
04951                                         }
04952                                         <span class="keywordflow">break</span>;
04953                                     } <span class="keywordflow">else</span> {
04954                                         ioResourceDescriptor++;
04955                                     }
04956                                 }
04957                             } <span class="keywordflow">else</span> {
04958                                 ioResourceDescriptor++;
04959                             }
04960                         } <span class="comment">// Don't add any instruction after this ...</span>
04961                     } <span class="comment">// phase</span>
04962                 } <span class="comment">// switch</span>
04963 
04964                 <span class="comment">//</span>
04965                 <span class="comment">// Move to next Cm Descriptor</span>
04966                 <span class="comment">//</span>
04967 
04968                 cmDescriptor++;
04969                 cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor + size);
04970             }
04971 
04972             <span class="comment">//</span>
04973             <span class="comment">// Move to next Cm List</span>
04974             <span class="comment">//</span>
04975 
04976             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor;
04977         }
04978 
04979         <span class="keywordflow">if</span> (ioResourceList-&gt;Version != (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)cmDescriptorCount) {
04980 
04981             <span class="comment">//</span>
04982             <span class="comment">// If the current alternative list does not cover all the boot config</span>
04983             <span class="comment">// descriptors, make it as invalid.</span>
04984             <span class="comment">//</span>
04985 
04986             ioResourceList-&gt;Version = 0xffff;
04987             ioList-&gt;AlternativeLists--;
04988         } <span class="keywordflow">else</span> {
04989             <span class="keywordflow">if</span> ((ioResourceList-&gt;Count == cmDescriptorCount) ||
04990                 (ioResourceList-&gt;Count == (cmDescriptorCount + 1) &amp;&amp;
04991                  ioResourceList-&gt;Descriptors[0].Type == CmResourceTypeConfigData)) {
04992                 <span class="keywordflow">if</span> (selectedResourceList) {
04993                     ioResourceList-&gt;Version = 0xffff;
04994                     ioList-&gt;AlternativeLists--;
04995                 } <span class="keywordflow">else</span> {
04996                     selectedResourceList = ioResourceList;
04997                     ioResourceDescriptorCount += ioResourceList-&gt;Count;
04998                     ioResourceList-&gt;Version = version;
04999                     <span class="keywordflow">if</span> (exactMatch) {
05000                         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05001                     }
05002                 }
05003             } <span class="keywordflow">else</span> {
05004                 ioResourceDescriptorCount += ioResourceList-&gt;Count;
05005                 ioResourceList-&gt;Version = version;
05006             }
05007         }
05008         ioResourceList-&gt;Count = oldCount;
05009 
05010         <span class="comment">//</span>
05011         <span class="comment">// Move to next Io alternative list.</span>
05012         <span class="comment">//</span>
05013 
05014         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05015     }
05016 
05017     <span class="comment">//</span>
05018     <span class="comment">// If there is not any valid alternative, convert CmList to Io list.</span>
05019     <span class="comment">//</span>
05020 
05021     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists == 0) {
05022          *FilteredList = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, CmList, LCPRI_BOOTCONFIG);
05023         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05024         <span class="keywordflow">return</span> STATUS_SUCCESS;
05025     }
05026 
05027     <span class="comment">//</span>
05028     <span class="comment">// we have finished filtering the resource requirements list.  Now allocate memory</span>
05029     <span class="comment">// and rebuild a new list.</span>
05030     <span class="comment">//</span>
05031 
05032     size = <span class="keyword">sizeof</span>(IO_RESOURCE_REQUIREMENTS_LIST) +
05033                <span class="keyword">sizeof</span>(IO_RESOURCE_LIST) * (ioList-&gt;AlternativeLists - 1) +
05034                <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR) * (ioResourceDescriptorCount);
05035     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
05036     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05037         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05038         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05039     }
05040 
05041     <span class="comment">//</span>
05042     <span class="comment">// Walk through the io resource requirements list and pick up any valid descriptor.</span>
05043     <span class="comment">//</span>
05044 
05045     newList-&gt;ListSize = size;
05046     newList-&gt;InterfaceType = CmList-&gt;List-&gt;InterfaceType;
05047     newList-&gt;BusNumber = CmList-&gt;List-&gt;BusNumber;
05048     newList-&gt;SlotNumber = ioList-&gt;SlotNumber;
05049     <span class="keywordflow">if</span> (ioList-&gt;AlternativeLists &gt; 1) {
05050         *ExactMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05051     }
05052     newList-&gt;AlternativeLists = ioList-&gt;AlternativeLists;
05053     ioResourceList = ioList-&gt;List;
05054     newIoResourceList = newList-&gt;List;
05055     <span class="keywordflow">while</span> (--alternativeLists &gt;= 0) {
05056         ioResourceDescriptor = ioResourceList-&gt;Descriptors;
05057         ioResourceDescriptorEnd = ioResourceDescriptor + ioResourceList-&gt;Count;
05058         <span class="keywordflow">if</span> (ioResourceList-&gt;Version == 0xffff) {
05059             ioResourceList = (PIO_RESOURCE_LIST)ioResourceDescriptorEnd;
05060             <span class="keywordflow">continue</span>;
05061         }
05062         newIoResourceList-&gt;Version = ioResourceList-&gt;Version;
05063         newIoResourceList-&gt;Revision = ioResourceList-&gt;Revision;
05064 
05065         newIoResourceDescriptor = newIoResourceList-&gt;Descriptors;
05066         <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeConfigData) {
05067             newIoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
05068             newIoResourceDescriptor-&gt;Type = CmResourceTypeConfigData;
05069             newIoResourceDescriptor-&gt;ShareDisposition = CmResourceShareShared;
05070             newIoResourceDescriptor-&gt;Flags = 0;
05071             newIoResourceDescriptor-&gt;Spare1 = 0;
05072             newIoResourceDescriptor-&gt;Spare2 = 0;
05073             newIoResourceDescriptor-&gt;u.ConfigData.Priority = LCPRI_BOOTCONFIG;
05074             configDataDescriptor = newIoResourceDescriptor;
05075             newIoResourceDescriptor++;
05076         } <span class="keywordflow">else</span> {
05077             newList-&gt;ListSize -= <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR);
05078             configDataDescriptor = newIoResourceDescriptor;
05079         }
05080 
05081         <span class="keywordflow">while</span> (ioResourceDescriptor &lt; ioResourceDescriptorEnd) {
05082             <span class="keywordflow">if</span> (ioResourceDescriptor-&gt;Type != CmResourceTypeNull) {
05083                 *newIoResourceDescriptor = *ioResourceDescriptor;
05084                 newIoResourceDescriptor++;
05085             }
05086             ioResourceDescriptor++;
05087         }
05088         newIoResourceList-&gt;Count = (ULONG)(newIoResourceDescriptor - newIoResourceList-&gt;Descriptors);
05089 
05090         <span class="comment">//if (newIoResourceList-&gt;Count == (cmDescriptorCount + 1)) {</span>
05091         configDataDescriptor-&gt;u.ConfigData.Priority =  LCPRI_BOOTCONFIG;
05092         <span class="comment">//}</span>
05093 
05094         <span class="comment">//</span>
05095         <span class="comment">// Move to next Io alternative list.</span>
05096         <span class="comment">//</span>
05097 
05098         newIoResourceList = (PIO_RESOURCE_LIST) newIoResourceDescriptor;
05099         ioResourceList = (PIO_RESOURCE_LIST) ioResourceDescriptorEnd;
05100     }
05101     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PUCHAR)newIoResourceList == ((PUCHAR)newList + newList-&gt;ListSize));
05102 
05103     *FilteredList = newList;
05104     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioList);
05105     <span class="keywordflow">return</span> STATUS_SUCCESS;
05106 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pnpsubs.c::IopFreeUnicodeStringList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeUnicodeStringList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02740">2740</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, and <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>.
<p>
<pre class="fragment"><div>02747                    :
02748 
02749     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer <span class="keywordflow">for</span> each UNICODE_STRING in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified list
02750     (there are StringCount of them), and then frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory used <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02751     string list itself.
02752 
02753 Arguments:
02754 
02755     UnicodeStringList - Supplies a pointer to an array of UNICODE_STRINGs.
02756 
02757     StringCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UnicodeStringList array.
02758 
02759 Returns:
02760 
02761     None.
02762 
02763 --*/
02764 
02765 {
02766     ULONG i;
02767 
02768     <span class="keywordflow">if</span>(UnicodeStringList) {
02769         <span class="keywordflow">for</span>(i = 0; i &lt; StringCount; i++) {
02770             <span class="keywordflow">if</span>(UnicodeStringList[i].Buffer) {
02771                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList[i].Buffer);
02772             }
02773         }
02774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(UnicodeStringList);
02775     }
02776 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpsubs.c::IopGetDeviceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">1477</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>01484                    :
01485 
01486     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.
01487 
01488 Arguments:
01489 
01490     DeviceInstance - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devnode's instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>
01491 
01492     CsConfigFlags - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's CsConfigFlags
01493 
01494 Return Value:
01495 
01496     status
01497 
01498 --*/
01499 
01500 {
01501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01502     HANDLE handle1, handle2;
01503     UNICODE_STRING tempUnicodeString;
01504     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01505 
01506     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01507 
01508     *CsConfigFlags = 0;
01509 
01510     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01511                                    NULL,
01512                                    &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01513                                    KEY_READ
01514                                    );
01515 
01516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01517 
01518         <span class="keywordflow">return</span> status;
01519     }
01520 
01521     <span class="comment">//</span>
01522     <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01523     <span class="comment">//</span>
01524     <span class="comment">//</span>
01525     <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01526     <span class="comment">//</span>
01527 
01528     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01529     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01530                                    handle1,
01531                                    &amp;tempUnicodeString,
01532                                    KEY_READ
01533                                    );
01534     ZwClose(handle1);
01535 
01536     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01537 
01538         <span class="keywordflow">return</span> status;
01539     }
01540 
01541     PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01542 
01543     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
01544                                    handle2,
01545                                    &amp;tempUnicodeString,
01546                                    KEY_READ
01547                                    );
01548 
01549     ZwClose(handle2);
01550 
01551     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01552 
01553         <span class="keywordflow">return</span> status;
01554     }
01555 
01556 
01557     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle2,
01558                                    handle1,
01559                                    DeviceInstance,
01560                                    KEY_READ
01561                                    );
01562 
01563     ZwClose(handle1);
01564 
01565     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01566 
01567         <span class="keywordflow">return</span> status;
01568     }
01569 
01570 
01571     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>( handle2,
01572                                   REGSTR_VALUE_CSCONFIG_FLAGS,
01573                                   &amp;keyValueInformation
01574                                   );
01575 
01576     ZwClose(handle2);
01577 
01578     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01579         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01580             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01581 
01582             *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01583         }
01584         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01585     }
01586 
01587     <span class="keywordflow">return</span> status;
01588 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pnpsubs.c::IopGetDeviceResourcesFromRegistry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetDeviceResourcesFromRegistry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Preference</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">4081</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03776">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04170">IopReadDeviceConfiguration()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00740">QUERY_RESOURCE_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00747">REGISTRY_BASIC_CONFIGVECTOR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00746">REGISTRY_OVERRIDE_CONFIGVECTOR</a>, and <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>.
<p>
<pre class="fragment"><div>04091                    :
04092 
04093     This routine determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources decoded by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified.
04094     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a madeup device, we will <span class="keywordflow">try</span> to read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources
04095     from registry.  Otherwise, we need to traverse <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal assigned resource
04096     list to compose <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource list.
04097 
04098 Arguments:
04099 
04100     DeviceObject - supplies a pointer to a device object whose registry
04101         values are to be cleaned up.
04102 
04103     ResourceType - 0 <span class="keywordflow">for</span> CM_RESOURCE_LIST and 1 <span class="keywordflow">for</span> IO_RESOURCE_REQUIREMENTS_LIS
04104 
04105     Flags - specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preference.
04106 
04107     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required resources.
04108 
04109     Length - Specified a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource structure.
04110 
04111 Return Value:
04112 
04113     status
04114 
04115 --*/
04116 
04117 {
04118     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
04119     HANDLE handle, handlex;
04120     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04121     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04122     PCM_RESOURCE_LIST cmResource;
04123     PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04124     ULONG length;
04125     UNICODE_STRING unicodeName;
04126     PWCHAR valueName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04127 
04128     *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04129     *Length = 0;
04130 
04131     <span class="comment">//</span>
04132     <span class="comment">// Open the LogConfig key of the device instance.</span>
04133     <span class="comment">//</span>
04134 
04135     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handlex, KEY_READ);
04136     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04137         <span class="keywordflow">return</span> status;
04138     }
04139 
04140     <span class="keywordflow">if</span> (ResourceType == <a class="code" href="../../d9/d0/pnpiop_8h.html#a60">QUERY_RESOURCE_LIST</a>) {
04141 
04142         <span class="comment">//</span>
04143         <span class="comment">// Caller is asking for CM_RESOURCE_LIST</span>
04144         <span class="comment">//</span>
04145 
04146         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04147 
04148             <span class="comment">//</span>
04149             <span class="comment">// Try alloc config first</span>
04150             <span class="comment">//</span>
04151 
04152             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
04153             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04154                                            handlex,
04155                                            &amp;unicodeName,
04156                                            KEY_READ
04157                                            );
04158             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04159                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_ALLOC_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04160                 ZwClose(handle);
04161                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04162                     ZwClose(handlex);
04163                     <span class="keywordflow">return</span> status;
04164                 }
04165             }
04166         }
04167 
04168         handle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04169         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04170 
04171             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04172             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04173                                            handlex,
04174                                            &amp;unicodeName,
04175                                            KEY_READ
04176                                            );
04177             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04178                 status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a> (handle, REGISTRY_FORCED_CONFIG, (PCM_RESOURCE_LIST *)Resource, Length);
04179                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04180                     ZwClose(handle);
04181                     ZwClose(handlex);
04182                     <span class="keywordflow">return</span> status;
04183                 }
04184             } <span class="keywordflow">else</span> {
04185                 ZwClose(handlex);
04186                 <span class="keywordflow">return</span> status;
04187             }
04188         }
04189         <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04190 
04191             <span class="comment">//</span>
04192             <span class="comment">// Try alloc config first</span>
04193             <span class="comment">//</span>
04194 
04195             <span class="keywordflow">if</span> (handle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04196                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04197                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04198                                                handlex,
04199                                                &amp;unicodeName,
04200                                                KEY_READ
04201                                                );
04202                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04203                     ZwClose(handlex);
04204                     <span class="keywordflow">return</span> status;
04205                 }
04206             }
04207             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a27">IopReadDeviceConfiguration</a>( handle,
04208                                                  REGISTRY_BOOT_CONFIG,
04209                                                  (PCM_RESOURCE_LIST *)Resource,
04210                                                  Length);
04211         }
04212         <span class="keywordflow">if</span> (handle) {
04213             ZwClose(handle);
04214         }
04215     } <span class="keywordflow">else</span> {
04216 
04217         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
04218         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
04219                                        handlex,
04220                                        &amp;unicodeName,
04221                                        KEY_READ
04222                                        );
04223         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04224 
04225             <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a65">REGISTRY_OVERRIDE_CONFIGVECTOR</a>) {
04226                 valueName = REGSTR_VALUE_OVERRIDE_CONFIG_VECTOR;
04227             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Preference &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a66">REGISTRY_BASIC_CONFIGVECTOR</a>) {
04228                 valueName = REGSTR_VALUE_BASIC_CONFIG_VECTOR;
04229             }
04230             <span class="keywordflow">if</span> (valueName) {
04231 
04232                 <span class="comment">//</span>
04233                 <span class="comment">// Try to read device's configuration vector</span>
04234                 <span class="comment">//</span>
04235 
04236                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
04237                                               valueName,
04238                                               &amp;keyValueInformation);
04239                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04240 
04241                     <span class="comment">//</span>
04242                     <span class="comment">// Try to read what caller wants.</span>
04243                     <span class="comment">//</span>
04244 
04245                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_REQUIREMENTS_LIST) &amp;&amp;
04246                         (keyValueInformation-&gt;DataLength != 0)) {
04247 
04248                         *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04249                                                    keyValueInformation-&gt;DataLength);
04250                         <span class="keywordflow">if</span> (*Resource) {
04251                             PIO_RESOURCE_REQUIREMENTS_LIST ioResource;
04252 
04253                             *Length = keyValueInformation-&gt;DataLength;
04254                             RtlMoveMemory(*Resource,
04255                                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04256                                           keyValueInformation-&gt;DataLength);
04257 
04258                             <span class="comment">//</span>
04259                             <span class="comment">// Process the io resource requirements list to change undefined</span>
04260                             <span class="comment">// interface type to our default type.</span>
04261                             <span class="comment">//</span>
04262 
04263                             ioResource = *<a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a>;
04264                             <span class="keywordflow">if</span> (ioResource-&gt;InterfaceType == InterfaceTypeUndefined) {
04265                                 ioResource-&gt;BusNumber = 0;
04266                                 ioResource-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04267                             }
04268                         } <span class="keywordflow">else</span> {
04269                             status = STATUS_INVALID_PARAMETER_2;
04270                         }
04271                     }
04272                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04273                 }
04274             }
04275             ZwClose(handle);
04276         }
04277     }
04278     ZwClose(handlex);
04279     <span class="keywordflow">return</span> status;
04280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pnpsubs.c::IopGetGroupOrderIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IopGetGroupOrderIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ServiceHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">5334</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">IopFreeUnicodeStringList()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01907">IopRegMultiSzToUnicodeStrings()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00671">NO_MORE_GROUP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>05340                    :
05341 
05342     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> value of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key, finds its position in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05343     ServiceOrderList.  If ServiceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> or unrecognized group value, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns
05344     a value with <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a> group order + 1.
05345     <span class="keywordflow">if</span> any.
05346 
05347 Parameters:
05348 
05349     ServiceHandle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key.
05350 
05351 Return Value:
05352 
05353     group order index.
05354 
05355 --*/
05356 
05357 {
05358     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05359     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
05360     UNICODE_STRING *groupTable, group;
05361     HANDLE handle;
05362     ULONG count, index;
05363 
05364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05365 
05366     <span class="comment">//</span>
05367     <span class="comment">// Open System\CurrentControlSet\Control\ServiceOrderList</span>
05368     <span class="comment">//</span>
05369 
05370     PiWstrToUnicodeString(&amp;group, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Control\\ServiceGroupOrder"</span>);
05371     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
05372                                    NULL,
05373                                    &amp;group,
05374                                    KEY_READ
05375                                    );
05376 
05377     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
05378         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05379     }
05380 
05381     <span class="comment">//</span>
05382     <span class="comment">// Read and build a unicode string array containing all the group names.</span>
05383     <span class="comment">//</span>
05384 
05385     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
05386                                   L<span class="stringliteral">"List"</span>,
05387                                   &amp;keyValueInformation);
05388     ZwClose(handle);
05389     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05390 
05391         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_MULTI_SZ) &amp;&amp;
05392             (keyValueInformation-&gt;DataLength != 0)) {
05393 
05394             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a13">IopRegMultiSzToUnicodeStrings</a>(keyValueInformation, &amp;groupTable, &amp;count);
05395         } <span class="keywordflow">else</span> {
05396             status = STATUS_UNSUCCESSFUL;
05397         }
05398         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05399     }
05400 
05401     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05402         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a54">NO_MORE_GROUP</a>;
05403     }
05404 
05405     <span class="keywordflow">if</span> (ServiceHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05406         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05407         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(count + 1);
05408     }
05409 
05410 
05411     <span class="comment">//</span>
05412     <span class="comment">// Read service key's Group value</span>
05413     <span class="comment">//</span>
05414 
05415     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (ServiceHandle,
05416                                   L<span class="stringliteral">"Group"</span>,
05417                                   &amp;keyValueInformation);
05418     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05419 
05420         <span class="comment">//</span>
05421         <span class="comment">// Try to read what caller wants.</span>
05422         <span class="comment">//</span>
05423 
05424         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_SZ) &amp;&amp;
05425             (keyValueInformation-&gt;DataLength != 0)) {
05426             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;group,
05427                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
05428                                            keyValueInformation-&gt;DataLength
05429                                            );
05430         }
05431     } <span class="keywordflow">else</span> {
05432 
05433         <span class="comment">//</span>
05434         <span class="comment">// If we failed to read the Group value, or no Group value...</span>
05435         <span class="comment">//</span>
05436 
05437         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05438         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)count;
05439     }
05440 
05441     index = 0;
05442     <span class="keywordflow">for</span> (index = 0; index &lt; count; index++) {
05443         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;group, &amp;groupTable[index], TRUE)) {
05444             <span class="keywordflow">break</span>;
05445         }
05446     }
05447     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
05448     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(groupTable, count);
05449     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)index;
05450 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pnpsubs.c::IopGetServiceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetServiceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">1591</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>.
<p>
<pre class="fragment"><div>01599                    :
01600 
01601     This routine retrieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01602     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01603 
01604 Arguments:
01605 
01606     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01607         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01608         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load.
01609 
01610     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01611 
01612     CsConfigFlags - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's CsConfigFlags
01613 
01614 Return Value:
01615 
01616     status
01617 
01618 --*/
01619 
01620 {
01621     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01622     HANDLE handle;
01623     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
01624 
01625     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01626 
01627     *CsConfigFlags = 0;
01628 
01629     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01630                                                       ServiceKeyName,
01631                                                       Instance,
01632                                                       KEY_READ,
01633                                                       FALSE
01634                                                      );
01635     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01636         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
01637                                      REGSTR_VALUE_CSCONFIG_FLAGS,
01638                                      &amp;keyValueInformation
01639                                     );
01640         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01641             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
01642                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
01643                 *CsConfigFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
01644             }
01645             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01646         }
01647         ZwClose(handle);
01648     }
01649     <span class="keywordflow">return</span> status;
01650 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pnpsubs.c::IopIsAnyDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsAnyDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyIncluded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">3181</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01591">IopGetServiceInstanceCsConfigFlags()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03189                    :
03190 
03191     This routine checks <span class="keywordflow">if</span> any of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> turned on <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
03192     service. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> Pnp Driver <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> temporary function to support
03193     SUR.
03194 
03195 Arguments:
03196 
03197     ServiceKeyName - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key unicode name
03198 
03199     ServiceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service key to be checked.
03200 
03201     LegacyIncluded - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> counted as a device instance.
03202                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, a legacy device instance key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not counted.
03203 
03204 Returns:
03205 
03206     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03207 
03208 --*/
03209 
03210 {
03211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03212     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03213     HANDLE serviceEnumHandle, handle, controlHandle;
03214     ULONG i, count, deviceFlags;
03215     UNICODE_STRING unicodeName;
03216     BOOLEAN enabled, setProblem, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03217     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
03218     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03219 
03220     <span class="comment">//</span>
03221     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03222     <span class="comment">//</span>
03223 
03224     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(ServiceHandle)) {
03225         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
03226                                         KEY_READ,
03227                                         &amp;ServiceHandle,
03228                                         &amp;serviceEnumHandle,
03229                                         FALSE
03230                                         );
03231         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03232     } <span class="keywordflow">else</span> {
03233         PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_ENUM);
03234         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceEnumHandle,
03235                                        ServiceHandle,
03236                                        &amp;unicodeName,
03237                                        KEY_READ
03238                                        );
03239     }
03240     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03241 
03242         <span class="comment">//</span>
03243         <span class="comment">// No Service Enum key? no device instance.  Return FALSE.</span>
03244         <span class="comment">//</span>
03245 
03246         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03247     }
03248 
03249     <span class="comment">//</span>
03250     <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
03251     <span class="comment">// Enum key.</span>
03252     <span class="comment">//</span>
03253 
03254     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( serviceEnumHandle,
03255                                    REGSTR_VALUE_COUNT,
03256                                    &amp;keyValueInformation
03257                                    );
03258     ZwClose(serviceEnumHandle);
03259     count = 0;
03260     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03261         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03262             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03263 
03264             count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03265         }
03266         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03267     }
03268     <span class="keywordflow">if</span> (count == 0) {
03269         <span class="keywordflow">if</span> (closeHandle) {
03270             ZwClose(ServiceHandle);
03271         }
03272         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03273     }
03274 
03275     <span class="comment">//</span>
03276     <span class="comment">// Walk through each registered device instance to check it is enabled.</span>
03277     <span class="comment">//</span>
03278 
03279     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03280     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
03281 
03282         <span class="comment">//</span>
03283         <span class="comment">// Get device instance handle.  If it fails, we will skip this device</span>
03284         <span class="comment">// instance.</span>
03285         <span class="comment">//</span>
03286 
03287         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
03288                      ServiceHandle,
03289                      NULL,
03290                      i,
03291                      NULL,
03292                      &amp;handle,
03293                      KEY_ALL_ACCESS
03294                      );
03295         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03296             <span class="keywordflow">continue</span>;
03297         }
03298 
03299         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(handle, NULL);
03300         <span class="keywordflow">if</span> (physicalDeviceObject) {
03301             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03302             <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_HARDWARE_DISABLED))) {
03303                 ZwClose(handle);
03304                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03305                 <span class="keywordflow">continue</span>;
03306             }
03307         } <span class="keywordflow">else</span> {
03308             deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03309         }
03310 
03311         <span class="comment">//</span>
03312         <span class="comment">// Check if the device instance has been disabled.</span>
03313         <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03314         <span class="comment">//</span>
03315 
03316         deviceFlags = 0;
03317         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03318                                      REGSTR_VALUE_CONFIG_FLAGS,
03319                                      &amp;keyValueInformation);
03320         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03321             <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03322                 (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03323 
03324                 deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03325             }
03326             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03327         }
03328 
03329         <span class="keywordflow">if</span> (deviceFlags &amp; CONFIGFLAG_DISABLED) {
03330 
03331             <span class="comment">//</span>
03332             <span class="comment">// Convert this flag into the hardware profile-specific version, so it'll</span>
03333             <span class="comment">// look the same as the CsConfigFlags we retrieve below.</span>
03334             <span class="comment">//</span>
03335 
03336             deviceFlags = CSCONFIGFLAG_DISABLED;
03337 
03338         } <span class="keywordflow">else</span> {
03339 
03340             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a11">IopGetServiceInstanceCsConfigFlags</a>( ServiceKeyName,
03341                                                          i,
03342                                                          &amp;deviceFlags
03343                                                          );
03344 
03345             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03346                 deviceFlags = 0;
03347             }
03348         }
03349 
03350         <span class="comment">//</span>
03351         <span class="comment">// If the device is disabled (either globally, or specifically for this</span>
03352         <span class="comment">// hardware profile), then mark the devnode as DNF_DISABLED.</span>
03353         <span class="comment">//</span>
03354 
03355         <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) || (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03356 
03357             <span class="keywordflow">if</span> (deviceNode) {
03358                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, handle);
03359             }
03360         }
03361 
03362         <span class="keywordflow">if</span> (physicalDeviceObject) {
03363             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
03364         }
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// Finally, we need to set the STATUSFLAGS of the device instance to</span>
03368         <span class="comment">// indicate if the driver is successfully started.</span>
03369         <span class="comment">//</span>
03370 
03371         <span class="keywordflow">if</span> (!(deviceFlags &amp; (CSCONFIGFLAG_DISABLED | CSCONFIGFLAG_DO_NOT_CREATE | CSCONFIGFLAG_DO_NOT_START))) {
03372 
03373             ULONG legacy;
03374 
03375             <span class="comment">//</span>
03376             <span class="comment">// Check should legacy instance key be counted as an enabled device</span>
03377             <span class="comment">//</span>
03378 
03379             <span class="keywordflow">if</span> (LegacyIncluded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03380 
03381                 <span class="comment">//</span>
03382                 <span class="comment">// The legacy variable must be initialized to zero.  Because the device</span>
03383                 <span class="comment">// instance key may be an enumerated device.  In this case, there is no</span>
03384                 <span class="comment">// legacy value name.</span>
03385                 <span class="comment">//</span>
03386 
03387                 legacy = 0;
03388                 status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
03389                                              REGSTR_VALUE_LEGACY,
03390                                              &amp;keyValueInformation
03391                                              );
03392                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03393                     <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03394                         (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03395                         legacy = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03396                     }
03397                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03398                 }
03399             } <span class="keywordflow">else</span> {
03400                 legacy = 0;
03401             }
03402 
03403             <span class="keywordflow">if</span> (legacy == 0) {
03404 
03405                 <span class="comment">//</span>
03406                 <span class="comment">// Mark that the driver has at least a device instance to work with.</span>
03407                 <span class="comment">//</span>
03408 
03409                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_KEY_CONTROL);
03410                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
03411                                                  handle,
03412                                                  &amp;unicodeName,
03413                                                  KEY_ALL_ACCESS,
03414                                                  REG_OPTION_VOLATILE,
03415                                                  NULL
03416                                                  );
03417                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03418                     PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VAL_ACTIVESERVICE);
03419                     ZwSetValueKey(
03420                                 controlHandle,
03421                                 &amp;unicodeName,
03422                                 TITLE_INDEX_VALUE,
03423                                 REG_SZ,
03424                                 ServiceKeyName-&gt;Buffer,
03425                                 ServiceKeyName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03426                                 );
03427 
03428                     ZwClose(controlHandle);
03429                 }
03430                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03431             }
03432         }
03433         ZwClose(handle);
03434     }
03435 
03436     <span class="keywordflow">if</span> (closeHandle) {
03437         ZwClose(ServiceHandle);
03438     }
03439     <span class="keywordflow">return</span> enabled;
03440 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pnpsubs.c::IopIsDeviceInstanceEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDeviceInstanceEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DisableIfEnabled</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">3443</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00828">IopIsDevNodeProblem</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>03451                    :
03452 
03453     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified devices instances <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled.
03454 
03455 Arguments:
03456 
03457     DeviceInstanceHandle - Optionally supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance
03458         key to be checked.
03459 
03460     DeviceInstance - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance key unicode name.  Caller
03461         must at least specified DeviceInstanceHandle or DeviceInstance.
03462 
03463     DisableIfEnabled - If <span class="keyword">this</span> flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device should be disabled
03464         but <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently disabled, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled.
03465 
03466 Returns:
03467 
03468     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> BOOLEAN value.
03469 
03470 --*/
03471 
03472 {
03473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03474     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
03475     HANDLE handle, handle1;
03476     ULONG deviceFlags;
03477     BOOLEAN enabled, closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03478     UNICODE_STRING unicodeString;
03479     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03480     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03481 
03482     <span class="comment">//</span>
03483     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
03484     <span class="comment">//</span>
03485 
03486     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceInstanceHandle)) {
03487         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03488                                        NULL,
03489                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
03490                                        KEY_READ
03491                                        );
03492 
03493         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03494 
03495             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;DeviceInstanceHandle,
03496                                            handle,
03497                                            DeviceInstance,
03498                                            KEY_READ
03499                                            );
03500             ZwClose(handle);
03501         }
03502 
03503         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
03504             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03505         }
03506         closeHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03507     }
03508 
03509     enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03510 
03511     <span class="comment">//</span>
03512     <span class="comment">// First check the device node</span>
03513     <span class="comment">//</span>
03514 
03515     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(DeviceInstanceHandle, NULL);
03516     <span class="keywordflow">if</span> (deviceObject) {
03517         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03518         <span class="keywordflow">if</span> (deviceNode &amp;&amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED) || <a class="code" href="../../d9/d0/pnpiop_8h.html#a78">IopIsDevNodeProblem</a>(deviceNode, CM_PROB_DISABLED))) {
03519             enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03520             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
03521         }
03522     }
03523 
03524     <span class="comment">//</span>
03525     <span class="comment">// Check if the device instance has been disabled.</span>
03526     <span class="comment">// First check global flag: CONFIGFLAG and then CSCONFIGFLAG.</span>
03527     <span class="comment">//</span>
03528 
03529     deviceFlags = 0;
03530     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceInstanceHandle,
03531                                  REGSTR_VALUE_CONFIG_FLAGS,
03532                                  &amp;keyValueInformation);
03533     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03534         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03535             (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03536             deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03537         }
03538         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03539     }
03540     <span class="keywordflow">if</span> (!(deviceFlags &amp; CONFIGFLAG_DISABLED)) {
03541         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03542 
03543         <span class="comment">//</span>
03544         <span class="comment">// See if we can open current hardware profile</span>
03545         <span class="comment">//</span>
03546         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03547                                        NULL,
03548                                        &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
03549                                        KEY_READ
03550                                        );
03551 
03552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; DeviceInstance != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03553 
03554             <span class="comment">//</span>
03555             <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
03556             <span class="comment">//</span>
03557             <span class="comment">//</span>
03558             <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
03559             <span class="comment">//</span>
03560 
03561             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_PATH_CURRENTCONTROLSET);
03562             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03563                                            handle1,
03564                                            &amp;unicodeString,
03565                                            KEY_READ
03566                                            );
03567             ZwClose(handle1);
03568             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03569                 PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_ENUM);
03570                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle1,
03571                                                handle,
03572                                                &amp;unicodeString,
03573                                                KEY_READ
03574                                                );
03575                 ZwClose(handle);
03576                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03577                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
03578                                                    handle1,
03579                                                    DeviceInstance,
03580                                                    KEY_READ
03581                                                    );
03582                     ZwClose(handle1);
03583                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03584                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(
03585                                         handle,
03586                                         REGSTR_VALUE_CSCONFIG_FLAGS,
03587                                         &amp;keyValueInformation
03588                                         );
03589                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03590                             <span class="keywordflow">if</span>((keyValueInformation-&gt;Type == REG_DWORD) &amp;&amp;
03591                                (keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG))) {
03592                                deviceFlags = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
03593                             }
03594                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
03595                         }
03596                         ZwClose(handle);
03597                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03598                             <span class="keywordflow">if</span> ((deviceFlags &amp; CSCONFIGFLAG_DISABLED) ||
03599                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_CREATE) ||
03600                                 (deviceFlags &amp; CSCONFIGFLAG_DO_NOT_START)) {
03601                                 enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03602                             }
03603                         }
03604                     }
03605                 }
03606             }
03607         }
03608     } <span class="keywordflow">else</span> {
03609         enabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03610     }
03611 
03612     <span class="comment">//</span>
03613     <span class="comment">// If the device is disabled and has device node associated with it.</span>
03614     <span class="comment">// disable the device.</span>
03615     <span class="comment">//</span>
03616 
03617     <span class="keywordflow">if</span> (enabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; deviceNode &amp;&amp; DisableIfEnabled) {
03618         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a0">IopDisableDevice</a>(deviceNode, DeviceInstanceHandle);
03619     }
03620 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
03621     <span class="keywordflow">if</span> (deviceObject) {
03622         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
03623     }
03624     <span class="keywordflow">if</span> (closeHandle) {
03625         ZwClose(DeviceInstanceHandle);
03626     }
03627     <span class="keywordflow">return</span> enabled;
03628 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="pnpsubs.c::IopIsDuplicatedDevices" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsDuplicatedDevices           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>Configuration2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo1&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/struct__HAL__BUS__INFORMATION.html">PHAL_BUS_INFORMATION</a> BusInfo2&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02554">2554</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>02563                    :
02564 
02565     This routine compares two set of configurations and bus information to
02566     determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device.  If BusInfo1 and
02567     BusInfo2 both are absent, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> means caller wants to compare <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raw
02568     resources.
02569 
02570 Arguments:
02571 
02572     Configuration1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of resource.
02573 
02574     Configuration2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of resource.
02575 
02576     BusInfo1 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first set of bus information.
02577 
02578     BusInfo2 - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second set of bus information.
02579 
02580 Return Value:
02581 
02582     returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two set of resources indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same device;
02583     otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02584 
02585 --*/
02586 
02587 {
02588     PCM_PARTIAL_RESOURCE_LIST list1, list2;
02589     PCM_PARTIAL_RESOURCE_DESCRIPTOR descriptor1, descriptor2;
02590 
02591     ULONG i, j;
02592     ULONG pass = 0;
02593 
02594     <span class="comment">//</span>
02595     <span class="comment">// The BusInfo for both resources must be both present or not present.</span>
02596     <span class="comment">//</span>
02597 
02598     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT(BusInfo1) &amp;&amp; !ARGUMENT_PRESENT(BusInfo2)) ||
02599         (!ARGUMENT_PRESENT(BusInfo1) &amp;&amp; ARGUMENT_PRESENT(BusInfo2))) {
02600 
02601         <span class="comment">//</span>
02602         <span class="comment">// Unable to determine.</span>
02603         <span class="comment">//</span>
02604 
02605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02606     }
02607 
02608     <span class="comment">//</span>
02609     <span class="comment">// Next check resources used by the two devices.</span>
02610     <span class="comment">// Currently, we *only* check the Io ports.</span>
02611     <span class="comment">//</span>
02612 
02613     <span class="keywordflow">if</span> (Configuration1-&gt;Count == 0 || Configuration2-&gt;Count == 0) {
02614 
02615         <span class="comment">//</span>
02616         <span class="comment">// If any one of the configuration data is empty, we assume</span>
02617         <span class="comment">// the devices are not duplicates.</span>
02618         <span class="comment">//</span>
02619 
02620         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02621     }
02622 
02623 RedoScan:
02624 
02625     list1 = &amp;(Configuration1-&gt;List[0].PartialResourceList);
02626     list2 = &amp;(Configuration2-&gt;List[0].PartialResourceList);
02627 
02628     <span class="keywordflow">for</span>(i = 0, descriptor1 = list1-&gt;PartialDescriptors;
02629         i &lt; list1-&gt;Count;
02630         i++, descriptor1++) {
02631 
02632         <span class="comment">//</span>
02633         <span class="comment">// If this is an i/o port or a memory range then look for a match</span>
02634         <span class="comment">// in the other list.</span>
02635         <span class="comment">//</span>
02636 
02637         <span class="keywordflow">if</span>((descriptor1-&gt;Type == CmResourceTypePort) ||
02638            (descriptor1-&gt;Type == CmResourceTypeMemory)) {
02639 
02640             <span class="keywordflow">for</span>(j = 0, descriptor2 = list2-&gt;PartialDescriptors;
02641                 j &lt; list2-&gt;Count;
02642                 j++, descriptor2++) {
02643 
02644                 <span class="comment">//</span>
02645                 <span class="comment">// If the types match then check to see if both addresses</span>
02646                 <span class="comment">// match as well.  If bus info was provided then go ahead</span>
02647                 <span class="comment">// and translate the ranges first.</span>
02648                 <span class="comment">//</span>
02649 
02650                 <span class="keywordflow">if</span>(descriptor1-&gt;Type == descriptor2-&gt;Type) {
02651 
02652                     PHYSICAL_ADDRESS range1, range1Translated;
02653                     PHYSICAL_ADDRESS range2, range2Translated;
02654                     ULONG range1IoSpace, range2IoSpace;
02655 
02656                     range1 = descriptor1-&gt;u.Generic.Start;
02657                     range2 = descriptor2-&gt;u.Generic.Start;
02658 
02659                     <span class="keywordflow">if</span>((range1.QuadPart == 0) ||
02660                        (BusInfo1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02661                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02662                             BusInfo1-&gt;BusType,
02663                             BusInfo1-&gt;BusNumber,
02664                             range1,
02665                             &amp;range1IoSpace,
02666                             &amp;range1Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02667 
02668                         range1Translated = range1;
02669                         range1IoSpace =
02670                             (descriptor1-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02671                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02672                     }
02673 
02674                     <span class="keywordflow">if</span>((range2.QuadPart == 0) ||
02675                        (BusInfo2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
02676                        (<a class="code" href="../../d2/d7/hal_8h.html#a184">HalTranslateBusAddress</a>(
02677                             BusInfo2-&gt;BusType,
02678                             BusInfo2-&gt;BusNumber,
02679                             range2,
02680                             &amp;range2IoSpace,
02681                             &amp;range2Translated) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02682 
02683                         range2Translated = range2;
02684                         range2IoSpace =
02685                             (descriptor2-&gt;Type == CmResourceTypePort) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> :
02686                                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02687                     }
02688 
02689                     <span class="comment">//</span>
02690                     <span class="comment">// If the ranges are in the same space and start at the</span>
02691                     <span class="comment">// same location then break out and go on to the next</span>
02692                     <span class="comment">// range</span>
02693                     <span class="comment">//</span>
02694 
02695                     <span class="keywordflow">if</span>((range1Translated.QuadPart == range2Translated.QuadPart) &amp;&amp;
02696                        (range1IoSpace == range2IoSpace)) {
02697 
02698                         <span class="keywordflow">break</span>;
02699                     }
02700                 }
02701             }
02702 
02703             <span class="comment">//</span>
02704             <span class="comment">// If we made it all the way through the resource list without</span>
02705             <span class="comment">// finding a match then these are not duplicates.</span>
02706             <span class="comment">//</span>
02707 
02708             <span class="keywordflow">if</span>(j == list2-&gt;Count) {
02709                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02710             }
02711         }
02712     }
02713 
02714     <span class="comment">//</span>
02715     <span class="comment">// If every resource in list 1 exists in list 2 then we also need to make</span>
02716     <span class="comment">// sure that every resource in list 2 exists in list 1.</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span>(pass == 0) {
02720 
02721         PVOID tmp ;
02722 
02723         tmp = Configuration2;
02724         Configuration2 = Configuration1;
02725         Configuration1 = tmp;
02726 
02727         tmp = BusInfo2;
02728         BusInfo2 = BusInfo1;
02729         BusInfo1 = tmp;
02730 
02731         pass = 1;
02732 
02733         <span class="keywordflow">goto</span> RedoScan;
02734     }
02735 
02736     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02737 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pnpsubs.c::IopIsLegacyDriver" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsLegacyDriver           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05290">5290</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01300">DRVO_LEGACY_DRIVER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>05296                    :
05297 
05298     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object specifies a legacy driver.
05299 
05300 Arguments:
05301 
05302     DriverObject - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object to be checked.
05303 
05304 Return Value:
05305 
05306     BOOLEAN
05307 
05308 --*/
05309 
05310 {
05311 
05312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05313 
05314     <span class="comment">//</span>
05315     <span class="comment">// If AddDevice entry is not empty it is a wdm driver</span>
05316     <span class="comment">//</span>
05317 
05318     <span class="keywordflow">if</span> (DriverObject-&gt;DriverExtension-&gt;AddDevice) {
05319         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05320     }
05321 
05322     <span class="comment">//</span>
05323     <span class="comment">// Else if LEGACY flag is set in the driver object, it's a legacy driver.</span>
05324     <span class="comment">//</span>
05325 
05326     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a144">DRVO_LEGACY_DRIVER</a>) {
05327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05328     } <span class="keywordflow">else</span> {
05329         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05330     }
05331 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="pnpsubs.c::IopMarkDuplicateDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMarkDuplicateDevice           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetInstance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SourceInstance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02467">2467</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
<pre class="fragment"><div>02476                    :
02477 
02478     This routine marks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance specified by TargetKeyName and TargetInstance
02479     as DuplicateOf <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device specified by SourceKeyName and SourceInstance.
02480 
02481 Arguments:
02482 
02483     TargetKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key which will be marked
02484         as duplicate.
02485 
02486     TargetInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device.
02487 
02488     SourceKeyName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of service key.
02489 
02490     SourceInstance - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source device.
02491 
02492 
02493 Returns:
02494 
02495     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
02496 
02497 --*/
02498 
02499 {
02500     HANDLE handle;
02501     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02502     UNICODE_STRING sourceDeviceString, unicodeValueName;
02503 
02504     <span class="comment">//</span>
02505     <span class="comment">// Open the handle of the target device instance.</span>
02506     <span class="comment">//</span>
02507 
02508     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02509                        NULL,
02510                        TargetKeyName,
02511                        TargetInstance,
02512                        NULL,
02513                        &amp;handle,
02514                        0
02515                        );
02516     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02517         <span class="keywordflow">return</span> status;
02518     }
02519 
02520     <span class="comment">//</span>
02521     <span class="comment">// Get the name of the source device instance</span>
02522     <span class="comment">//</span>
02523 
02524     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(
02525                        NULL,
02526                        SourceKeyName,
02527                        SourceInstance,
02528                        &amp;sourceDeviceString,
02529                        NULL,
02530                        0
02531                        );
02532     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02533         <span class="keywordflow">return</span> status;
02534     }
02535 
02536     <span class="comment">//</span>
02537     <span class="comment">// Write the name of the source device to the DuplicateOf value entry of</span>
02538     <span class="comment">// target device key.</span>
02539     <span class="comment">//</span>
02540 
02541     PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_DUPLICATEOF);
02542     status = ZwSetValueKey(
02543                 handle,
02544                 &amp;unicodeValueName,
02545                 TITLE_INDEX_VALUE,
02546                 REG_SZ,
02547                 &amp;sourceDeviceString,
02548                 sourceDeviceString.Length + <span class="keyword">sizeof</span>(WCHAR)
02549                 );
02550     <span class="keywordflow">return</span> status;
02551 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pnpsubs.c::IopMergeCmResourceLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeCmResourceLists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>List2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05198">5198</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
<pre class="fragment"><div>05206                    :
05207 
05208     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05209 
05210 
05211 Arguments:
05212 
05213     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first CmResourceList
05214 
05215     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second CmResourceList
05216 
05217     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05218              list.
05219 
05220 Return Value:
05221 
05222     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05223 
05224 --*/
05225 {
05226     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05227     PCM_RESOURCE_LIST cmList, newList;
05228     ULONG size, size1, size2;
05229     PUCHAR p;
05230 
05231     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05232 
05233     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05234 
05235     <span class="comment">//</span>
05236     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05237     <span class="comment">// them is empty.</span>
05238     <span class="comment">//</span>
05239 
05240     <span class="keywordflow">if</span> ((List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) &amp;&amp;
05241         (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0)) {
05242         <span class="keywordflow">return</span> status;
05243     }
05244 
05245     cmList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05246     <span class="keywordflow">if</span> (List1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List1-&gt;Count == 0) {
05247         cmList = List2;
05248     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (List2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || List2-&gt;Count == 0) {
05249         cmList = List1;
05250     }
05251     <span class="keywordflow">if</span> (cmList) {
05252         size =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(cmList);
05253         newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, size);
05254         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05255             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05256         }
05257         RtlMoveMemory(newList, cmList, size);
05258         *MergedList = newList;
05259         <span class="keywordflow">return</span> status;
05260     }
05261 
05262     <span class="comment">//</span>
05263     <span class="comment">// Do real work...</span>
05264     <span class="comment">//</span>
05265 
05266     size1 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List1);
05267     size2 =  <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(List2);
05268     size = size1 + size2;
05269     newList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05270                           PagedPool,
05271                           size
05272                           );
05273     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05274         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05275     }
05276     p = (PUCHAR)newList;
05277     RtlMoveMemory(p, List1, size1);
05278     p += size1;
05279     RtlMoveMemory(p,
05280                   &amp;List2-&gt;List[0],
05281                   size2 - FIELD_OFFSET(CM_RESOURCE_LIST, List)
05282                   );
05283     newList-&gt;Count = List1-&gt;Count + List2-&gt;Count;
05284     *MergedList = newList;
05285     <span class="keywordflow">return</span> status;
05286 
05287 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pnpsubs.c::IopMergeFilteredResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopMergeFilteredResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoList2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PIO_RESOURCE_REQUIREMENTS_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>MergedList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05109">5109</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
<pre class="fragment"><div>05117                    :
05118 
05119     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> merges two IoLists into one.
05120 
05121 
05122 Arguments:
05123 
05124     IoList1 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first IoResourceRequirementsList
05125 
05126     IoList2 - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second IoResourceRequirementsList
05127 
05128     MergedList - Supplies a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> merged resource
05129              requirements list.
05130 
05131 Return Value:
05132 
05133     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function.
05134 
05135 --*/
05136 {
05137     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05138     PIO_RESOURCE_REQUIREMENTS_LIST ioList, newList;
05139     ULONG size;
05140     PUCHAR p;
05141 
05142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05143 
05144     *MergedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05145 
05146     <span class="comment">//</span>
05147     <span class="comment">// First handle the easy cases that both IO Lists are empty or any one of</span>
05148     <span class="comment">// them is empty.</span>
05149     <span class="comment">//</span>
05150 
05151     <span class="keywordflow">if</span> ((IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) &amp;&amp;
05152         (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0)) {
05153         <span class="keywordflow">return</span> status;
05154     }
05155     ioList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05156     <span class="keywordflow">if</span> (IoList1 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList1-&gt;AlternativeLists == 0) {
05157         ioList = IoList2;
05158     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IoList2 == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || IoList2-&gt;AlternativeLists == 0) {
05159         ioList = IoList1;
05160     }
05161     <span class="keywordflow">if</span> (ioList) {
05162         newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, ioList-&gt;ListSize);
05163         <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05164             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05165         }
05166         RtlMoveMemory(newList, ioList, ioList-&gt;ListSize);
05167         *MergedList = newList;
05168         <span class="keywordflow">return</span> status;
05169     }
05170 
05171     <span class="comment">//</span>
05172     <span class="comment">// Do real work...</span>
05173     <span class="comment">//</span>
05174 
05175     size = IoList1-&gt;ListSize + IoList2-&gt;ListSize - FIELD_OFFSET(IO_RESOURCE_REQUIREMENTS_LIST, List);
05176     newList = (PIO_RESOURCE_REQUIREMENTS_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
05177                           PagedPool,
05178                           size
05179                           );
05180     <span class="keywordflow">if</span> (newList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05181         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05182     }
05183     p = (PUCHAR)newList;
05184     RtlMoveMemory(p, IoList1, IoList1-&gt;ListSize);
05185     p += IoList1-&gt;ListSize;
05186     RtlMoveMemory(p,
05187                   &amp;IoList2-&gt;List[0],
05188                   size - IoList1-&gt;ListSize
05189                   );
05190     newList-&gt;ListSize = size;
05191     newList-&gt;AlternativeLists += IoList2-&gt;AlternativeLists;
05192     *MergedList = newList;
05193     <span class="keywordflow">return</span> status;
05194 
05195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pnpsubs.c::IopOpenCurrentHwProfileDeviceInstanceKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenCurrentHwProfileDeviceInstanceKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Create</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">1712</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00179">CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent</a>, <a class="el" href="../../d1/d5/consubs_8c-source.html#l00023">Create()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>.
<p>
<pre class="fragment"><div>01722                    :
01723 
01724     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01725     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01726 
01727 Arguments:
01728 
01729     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01730         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01731         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01732         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01733 
01734     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01735 
01736     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01737         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01738 
01739     <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> - Determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be created <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not exist.
01740 
01741 Return Value:
01742 
01743     status
01744 
01745 --*/
01746 
01747 {
01748     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01749     UNICODE_STRING tempUnicodeString;
01750     HANDLE profileHandle, profileEnumHandle, tmpHandle;
01751 
01752     <span class="comment">//</span>
01753     <span class="comment">// See if we can open current hardware profile</span>
01754     <span class="comment">//</span>
01755 
01756     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01757         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileHandle,
01758                                          NULL,
01759                                          &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01760                                          KEY_READ,
01761                                          REG_OPTION_NON_VOLATILE,
01762                                          NULL
01763                                          );
01764     } <span class="keywordflow">else</span> {
01765         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileHandle,
01766                                        NULL,
01767                                        &amp;CmRegistryMachineSystemCurrentControlSetHardwareProfilesCurrent,
01768                                        KEY_READ
01769                                        );
01770     }
01771 
01772     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01773         <span class="comment">//</span>
01774         <span class="comment">// Now, we must open the System\CCS\Enum key under this.</span>
01775         <span class="comment">//</span>
01776         <span class="comment">//</span>
01777         <span class="comment">// Open system\CurrentControlSet under current hardware profile key</span>
01778         <span class="comment">//</span>
01779 
01780         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_PATH_CURRENTCONTROLSET);
01781         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;tmpHandle,
01782                                        profileHandle,
01783                                        &amp;tempUnicodeString,
01784                                        DesiredAccess
01785                                        );
01786         ZwClose(profileHandle);
01787         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01788             <span class="keywordflow">return</span> status;
01789         }
01790 
01791         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_KEY_ENUM);
01792 
01793         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01794             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;profileEnumHandle,
01795                                              tmpHandle,
01796                                              &amp;tempUnicodeString,
01797                                              KEY_READ,
01798                                              REG_OPTION_NON_VOLATILE,
01799                                              NULL
01800                                              );
01801         } <span class="keywordflow">else</span> {
01802             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;profileEnumHandle,
01803                                            tmpHandle,
01804                                            &amp;tempUnicodeString,
01805                                            KEY_READ
01806                                            );
01807         }
01808 
01809         ZwClose(tmpHandle);
01810         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01811 
01812             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a>(NULL,
01813                                                         ServiceKeyName,
01814                                                         Instance,
01815                                                         &amp;tempUnicodeString,
01816                                                         NULL,
01817                                                         0
01818                                                        );
01819             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01820                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
01821                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( Handle,
01822                                                      profileEnumHandle,
01823                                                      &amp;tempUnicodeString,
01824                                                      DesiredAccess,
01825                                                      REG_OPTION_NON_VOLATILE,
01826                                                      NULL
01827                                                      );
01828                 } <span class="keywordflow">else</span> {
01829                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( Handle,
01830                                                    profileEnumHandle,
01831                                                    &amp;tempUnicodeString,
01832                                                    DesiredAccess
01833                                                    );
01834                 }
01835                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;tempUnicodeString);
01836             }
01837             ZwClose(profileEnumHandle);
01838         }
01839     }
01840     <span class="keywordflow">return</span> status;
01841 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pnpsubs.c::IopOpenRegistryKeyEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenRegistryKeyEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE BaseHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">1104</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00373">IoGetDeviceProperty()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l00810">IoOpenDeviceRegistryKey()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02209">IopApplyFunctionToServiceInstances()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01844">IopApplyFunctionToSubKeys()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l02525">IopCallDriverAddDevice()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03960">IopCleanupDeviceRegistryValues()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05902">IopDeleteKeyRecursive()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05453">IopDeleteLegacyKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l03708">IopDeviceInterfaceKeysFromSymbolicLink()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03759">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03897">IopDeviceObjectToDeviceInstance()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02779">IopDriverLoadingFailed()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01477">IopGetDeviceInstanceCsConfigFlags()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02707">IopGetDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04081">IopGetDeviceResourcesFromRegistry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05334">IopGetGroupOrderIndex()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03146">IopInitializeSystemDrivers()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03181">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03443">IopIsDeviceInstanceEnabled()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l01572">IopIsFirmwareMapperDevicePresent()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l02286">IopIsReportedAlready()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l01891">IopMakeGloballyUniqueId()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01712">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08501">IopOpenDeviceParametersSubkey()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04741">IopOpenOrCreateDeviceInterfaceSubKeys()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l03762">IopProcessCriticalDevice()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04000">IopProcessCriticalDeviceRoutine()</a>, <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01538">IopProcessNewDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04414">IopRemoveDeviceInterfaces()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l04140">IopUnregisterDeviceInterface()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02089">PnPBiosCopyDeviceParamKey()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l01725">PnPBiosEliminateDupes()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00399">PnPBiosGetBiosInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l02289">PnPBiosWriteInfo()</a>, <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00788">PnPCheckFixedIoOverrideDecodes()</a>, and <a class="el" href="../../d3/d0/pnpmap_8c-source.html#l00759">PnPGetDevnodeExcludeList()</a>.
<p>
<pre class="fragment"><div>01113                    :
01114 
01115     Opens a registry key <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name passed in based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BaseHandle node.
01116     This name may specify a key that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01117 
01118 Arguments:
01119 
01120     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle which will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key that
01121         was opened.
01122 
01123     BaseHandle - Optional handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> from which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key must be opened.
01124         If <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> specifies a registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> that must be created, then <span class="keyword">this</span> parameter
01125         must be specified, and <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> must be a relative <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
01126 
01127     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> that must be opened/created (possibly a registry path)
01128 
01129     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs to
01130         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key.
01131 
01132 Return Value:
01133 
01134    The function value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01135 
01136 --*/
01137 
01138 {
01139     OBJECT_ATTRIBUTES objectAttributes;
01140 
01141     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01142 
01143     InitializeObjectAttributes( &amp;objectAttributes,
01144                                 KeyName,
01145                                 OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
01146                                 BaseHandle,
01147                                 (PSECURITY_DESCRIPTOR) NULL
01148                                 );
01149     <span class="comment">//</span>
01150     <span class="comment">// Simply attempt to open the path, as specified.</span>
01151     <span class="comment">//</span>
01152     <span class="keywordflow">return</span> ZwOpenKey( Handle, DesiredAccess, &amp;objectAttributes );
01153 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnpsubs.c::IopOpenServiceEnumKeys" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopOpenServiceEnumKeys           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE ServiceEnumHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateEnum</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01339">1339</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00178">CmRegistryMachineSystemCurrentControlSetServices</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>01349                    :
01350 
01351     This routine opens <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> HKEY_LOCAL_MACHINE\CurrentControlSet\Services\
01352     ServiceKeyName and its Enum subkey and returns handles <span class="keywordflow">for</span> both key.
01353     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned handles.
01354 
01355 Arguments:
01356 
01357     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01358         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01359         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01360         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01361 
01362     DesiredAccess - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> keys.
01363 
01364     ServiceHandle - Supplies a variable to receive a handle to ServiceKeyName.
01365         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceHandle indicates caller does not want need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01366         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName.
01367 
01368     ServiceEnumHandle - Supplies a variable to receive a handle to ServiceKeyName\Enum.
01369         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ServiceEnumHandle indicates caller does not need <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to
01370         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ServiceKeyName\Enum.
01371 
01372     CreateEnum - Supplies a BOOLEAN variable to indicate should <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Enum subkey be
01373         created <span class="keywordflow">if</span> not present.
01374 
01375 Return Value:
01376 
01377     status
01378 
01379 --*/
01380 
01381 {
01382     HANDLE handle, serviceHandle, enumHandle;
01383     UNICODE_STRING enumName;
01384     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Open System\CurrentControlSet\Services</span>
01388     <span class="comment">//</span>
01389 
01390     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01391                                    NULL,
01392                                    &amp;CmRegistryMachineSystemCurrentControlSetServices,
01393                                    DesiredAccess
01394                                    );
01395 
01396     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01397         <span class="keywordflow">return</span> status;
01398     }
01399 
01400     <span class="comment">//</span>
01401     <span class="comment">// Open the registry ServiceKeyName key.</span>
01402     <span class="comment">//</span>
01403 
01404     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;serviceHandle,
01405                                    handle,
01406                                    ServiceKeyName,
01407                                    DesiredAccess
01408                                    );
01409 
01410     ZwClose(handle);
01411     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01412 
01413         <span class="comment">//</span>
01414         <span class="comment">// There is no registry key for the ServiceKeyName information.</span>
01415         <span class="comment">//</span>
01416 
01417         <span class="keywordflow">return</span> status;
01418     }
01419 
01420     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle) || CreateEnum) {
01421 
01422         <span class="comment">//</span>
01423         <span class="comment">// Open registry ServiceKeyName\Enum branch if caller wants</span>
01424         <span class="comment">// the handle or wants to create it.</span>
01425         <span class="comment">//</span>
01426 
01427         PiWstrToUnicodeString(&amp;enumName, REGSTR_KEY_ENUM);
01428 
01429         <span class="keywordflow">if</span> (CreateEnum) {
01430             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;enumHandle,
01431                                              serviceHandle,
01432                                              &amp;enumName,
01433                                              DesiredAccess,
01434                                              REG_OPTION_VOLATILE,
01435                                              NULL
01436                                              );
01437         } <span class="keywordflow">else</span> {
01438             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01439                                            serviceHandle,
01440                                            &amp;enumName,
01441                                            DesiredAccess
01442                                            );
01443 
01444         }
01445 
01446         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01447 
01448             <span class="comment">//</span>
01449             <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01450             <span class="comment">//</span>
01451 
01452             ZwClose(serviceHandle);
01453             <span class="keywordflow">return</span> status;
01454         }
01455         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceEnumHandle)) {
01456             *ServiceEnumHandle = enumHandle;
01457         } <span class="keywordflow">else</span> {
01458             ZwClose(enumHandle);
01459         }
01460     }
01461 
01462     <span class="comment">//</span>
01463     <span class="comment">// if caller wants to have the ServiceKey handle, we return it.  Otherwise</span>
01464     <span class="comment">// we close it.</span>
01465     <span class="comment">//</span>
01466 
01467     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ServiceHandle)) {
01468         *ServiceHandle = serviceHandle;
01469     } <span class="keywordflow">else</span> {
01470         ZwClose(serviceHandle);
01471     }
01472 
01473     <span class="keywordflow">return</span> STATUS_SUCCESS;
01474 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnpsubs.c::IopPrepareDriverLoading" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPrepareDriverLoading           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIMAGE_NT_HEADERS&nbsp;</td>
          <td class="mdname" nowrap> <em>Header</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00753">753</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00087">IopCreateMadeupNode()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03071">IopIsAnyDeviceInstanceEnabled()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00059">KeyName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00116">PnPDetectionEnabled</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00036">PpRegistryDeviceResource</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00761                    :
00762 
00763     This routine first checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> loadable.  If its a
00764     PnP driver, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will always be loaded (we trust it to <span class="keywordflow">do</span> the right
00765     things.)  If it is a legacy driver, we need to check <span class="keywordflow">if</span> its device
00766     has been disabled.  Once we decide to load the driver, the Enum
00767     subkey of the service node will be checked <span class="keywordflow">for</span> duplicates, <span class="keywordflow">if</span> any.
00768 
00769 Parameters:
00770 
00771     KeyName - Supplies a pointer to the driver's service key unicode string
00772 
00773     KeyHandle - Supplies a handle to the driver service node in the registry
00774         that describes the driver to be loaded.
00775 
00776 Return Value:
00777 
00778     The function value is the <span class="keyword">final</span> status of the load operation.
00779 
00780 --*/
00781 
00782 {
00783     NTSTATUS status;
00784     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00785     ULONG tmp, count;
00786     HANDLE serviceEnumHandle = NULL, sysEnumXxxHandle, controlHandle;
00787     UNICODE_STRING unicodeKeyName, unicodeValueName;
00788     BOOLEAN IsPlugPlayDriver;
00789 
00790     status = STATUS_SUCCESS;
00791     IsPlugPlayDriver = (Header &amp;&amp;
00792                         (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OptionalHeader.DllCharacteristics &amp; IMAGE_DLLCHARACTERISTICS_WDM_DRIVER))? TRUE : FALSE;
00793 
00794     if (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a19">IopIsAnyDeviceInstanceEnabled</a>(KeyName, KeyHandle, (BOOLEAN)(IsPlugPlayDriver ? FALSE : TRUE))) {
00795 
00796         <span class="keywordflow">if</span> (IsPlugPlayDriver) {
00797 
00798             <span class="keywordflow">if</span> (!PnPDetectionEnabled) {
00799 
00800                 status = STATUS_PLUGPLAY_NO_DEVICE;
00801 
00802             }
00803 
00804         } <span class="keywordflow">else</span> {
00805 
00806             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00807             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;PpRegistryDeviceResource, TRUE);
00808 
00809             <span class="comment">//</span>
00810             <span class="comment">// First open registry ServiceKeyName\Enum branch</span>
00811             <span class="comment">//</span>
00812 
00813             PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00814             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;serviceEnumHandle,
00815                                              KeyHandle,
00816                                              &amp;unicodeKeyName,
00817                                              KEY_ALL_ACCESS,
00818                                              REG_OPTION_VOLATILE,
00819                                              NULL
00820                                              );
00821             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00822 
00823                 <span class="comment">//</span>
00824                 <span class="comment">// Find out how many device instances listed in the ServiceName's</span>
00825                 <span class="comment">// Enum key.</span>
00826                 <span class="comment">//</span>
00827 
00828                 count = 0;
00829                 status = IopGetRegistryValue ( serviceEnumHandle,
00830                                                REGSTR_VALUE_COUNT,
00831                                                &amp;keyValueInformation);
00832                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00833 
00834                     <span class="keywordflow">if</span> (    keyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
00835                             keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(ULONG)) {
00836 
00837                         count = *(PULONG)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00838 
00839                     }
00840 
00841                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00842 
00843                 }
00844                 <span class="keywordflow">if</span> (    <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ||
00845                         status == STATUS_OBJECT_PATH_NOT_FOUND ||
00846                         status == STATUS_OBJECT_NAME_NOT_FOUND) {
00847 
00848                     <span class="keywordflow">if</span> (count) {
00849 
00850                         status = STATUS_PLUGPLAY_NO_DEVICE;
00851 
00852                     } <span class="keywordflow">else</span> {
00853 
00854                         <span class="comment">//</span>
00855                         <span class="comment">// If there is no Enum key or instance under Enum for the</span>
00856                         <span class="comment">// legacy driver we will create a madeup node for it.</span>
00857                         <span class="comment">//</span>
00858 
00859                         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a1">IopCreateMadeupNode</a>(   KeyName,
00860                                                         &amp;sysEnumXxxHandle,
00861                                                         &amp;unicodeKeyName,
00862                                                         &amp;tmp,
00863                                                         TRUE);
00864                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00865 
00866                             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeKeyName);
00867 
00868                             <span class="comment">//</span>
00869                             <span class="comment">// Create and set Control\ActiveService value</span>
00870                             <span class="comment">//</span>
00871 
00872                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_KEY_CONTROL);
00873                             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
00874                                                              sysEnumXxxHandle,
00875                                                              &amp;unicodeValueName,
00876                                                              KEY_ALL_ACCESS,
00877                                                              REG_OPTION_VOLATILE,
00878                                                              NULL
00879                                                              );
00880                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00881 
00882                                 PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VAL_ACTIVESERVICE);
00883                                 ZwSetValueKey(  controlHandle,
00884                                                 &amp;unicodeValueName,
00885                                                 TITLE_INDEX_VALUE,
00886                                                 REG_SZ,
00887                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Buffer,
00888                                                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
00889                                 ZwClose(controlHandle);
00890 
00891                             }
00892                             count++;
00893                             <span class="comment">//</span>
00894                             <span class="comment">// Don't forget to update the "Count=" and "NextInstance=" value entries</span>
00895                             <span class="comment">//</span>
00896 
00897                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_COUNT);
00898                             ZwSetValueKey(  serviceEnumHandle,
00899                                             &amp;unicodeValueName,
00900                                             TITLE_INDEX_VALUE,
00901                                             REG_DWORD,
00902                                             &amp;count,
00903                                             <span class="keyword">sizeof</span>(count));
00904 
00905                             PiWstrToUnicodeString(&amp;unicodeValueName, REGSTR_VALUE_NEXT_INSTANCE);
00906                             ZwSetValueKey(  serviceEnumHandle,
00907                                             &amp;unicodeValueName,
00908                                             TITLE_INDEX_VALUE,
00909                                             REG_DWORD,
00910                                             &amp;count,
00911                                             <span class="keyword">sizeof</span>(count));
00912 
00913                             ZwClose(sysEnumXxxHandle);
00914                             status = STATUS_SUCCESS;
00915                         }
00916                     }
00917                 }
00918 
00919                 ZwClose(serviceEnumHandle);
00920             }
00921 
00922             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;PpRegistryDeviceResource);
00923             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00924         }
00925     }
00926 
00927     <span class="keywordflow">return</span> status;
00928 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pnpsubs.c::IopReadDeviceConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReadDeviceConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmResource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l04283">4283</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00743">REGISTRY_ALLOC_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00745">REGISTRY_BOOT_CONFIG</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00744">REGISTRY_FORCED_CONFIG</a>.
<p>
<pre class="fragment"><div>04292                    :
04293 
04294     This routine read <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d3/d5/perfutil_8h.html#a9">ALLOC</a> config or ForcedConfig or Boot config.
04295 
04296 Arguments:
04297 
04298     Hanle - supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry key to read resources.
04299 
04300 Return Value:
04301 
04302     status
04303 
04304 --*/
04305 
04306 {
04307     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04308     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04309     PWCHAR valueName;
04310 
04311     *CmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04312     *Length = 0;
04313 
04314     <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a62">REGISTRY_ALLOC_CONFIG</a>) {
04315         valueName = REGSTR_VALUE_ALLOC_CONFIG;
04316     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a63">REGISTRY_FORCED_CONFIG</a>) {
04317         valueName = REGSTR_VALUE_FORCED_CONFIG;
04318     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags == <a class="code" href="../../d9/d0/pnpiop_8h.html#a64">REGISTRY_BOOT_CONFIG</a>) {
04319         valueName = REGSTR_VALUE_BOOT_CONFIG;
04320     } <span class="keywordflow">else</span> {
04321         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
04322     }
04323 
04324     <span class="comment">//</span>
04325     <span class="comment">// Read the registry value of the desired value name</span>
04326     <span class="comment">//</span>
04327 
04328     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (Handle,
04329                                   valueName,
04330                                   &amp;keyValueInformation);
04331     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04332 
04333         <span class="comment">//</span>
04334         <span class="comment">// Try to read what caller wants.</span>
04335         <span class="comment">//</span>
04336 
04337         <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
04338             (keyValueInformation-&gt;DataLength != 0)) {
04339             *CmResource = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
04340                                          keyValueInformation-&gt;DataLength);
04341             <span class="keywordflow">if</span> (*CmResource) {
04342                 <span class="keywordflow">if</span> (*CmResource) {
04343                     *Length = keyValueInformation-&gt;DataLength;
04344                     RtlMoveMemory(*CmResource,
04345                                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
04346                                   keyValueInformation-&gt;DataLength);
04347                 } <span class="keywordflow">else</span> {
04348                     status = STATUS_INSUFFICIENT_RESOURCES;
04349                 }
04350             }
04351             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04352             <span class="keywordflow">if</span> (*CmResource) {
04353                 PCM_RESOURCE_LIST resourceList;
04354                 PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
04355                 PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
04356                 ULONG j, k, size, count;
04357 
04358                 <span class="comment">//</span>
04359                 <span class="comment">// Process the resource list read from Registry to change undefined</span>
04360                 <span class="comment">// interface type to our default interface type.</span>
04361                 <span class="comment">//</span>
04362 
04363                 resourceList = *CmResource;
04364                 cmFullDesc = &amp;resourceList-&gt;List[0];
04365                 <span class="keywordflow">for</span> (j = 0; j &lt; resourceList-&gt;Count; j++) {
04366                     <span class="keywordflow">if</span> (cmFullDesc-&gt;InterfaceType == InterfaceTypeUndefined) {
04367                         cmFullDesc-&gt;BusNumber = 0;
04368                         cmFullDesc-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
04369                     }
04370                     cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
04371                     <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc-&gt;PartialResourceList.Count; k++) {
04372                         size = 0;
04373                         <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
04374                         <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
04375                              size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
04376                              <span class="keywordflow">break</span>;
04377                         }
04378                         cmPartDesc++;
04379                         cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
04380                     }
04381                     cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
04382                 }
04383             }
04384         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (keyValueInformation-&gt;Type != REG_RESOURCE_LIST) {
04385             status = STATUS_UNSUCCESSFUL;
04386         }
04387     }
04388     <span class="keywordflow">return</span> status;
04389 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pnpsubs.c::IopReferenceDriverObjectByName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> IopReferenceDriverObjectByName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DriverName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">3686</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d4/d4/iodata_8c-source.html#l00236">IoDriverObjectType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.
<p>
<pre class="fragment"><div>03692                    :
03693 
03694     This routine references a driver object by a given driver name.
03695 
03696 Arguments:
03697 
03698     DriverName - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver whose driver object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
03699         to be referenced.
03700 
03701 Returns:
03702 
03703     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> <span class="keywordflow">if</span> succeeds.  Otherwise, a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> value.
03704 
03705 --*/
03706 
03707 {
03708     OBJECT_ATTRIBUTES objectAttributes;
03709     HANDLE driverHandle;
03710     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03711     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
03712 
03713     <span class="comment">//</span>
03714     <span class="comment">// Make sure the driver name is valid.</span>
03715     <span class="comment">//</span>
03716 
03717     <span class="keywordflow">if</span> (DriverName-&gt;Length == 0) {
03718         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03719     }
03720 
03721     InitializeObjectAttributes(&amp;objectAttributes,
03722                                DriverName,
03723                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
03724                                NULL,
03725                                NULL
03726                                );
03727     status = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(&amp;objectAttributes,
03728                                 IoDriverObjectType,
03729                                 KernelMode,
03730                                 NULL,
03731                                 FILE_READ_ATTRIBUTES,
03732                                 NULL,
03733                                 &amp;driverHandle
03734                                 );
03735     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03736 
03737         <span class="comment">//</span>
03738         <span class="comment">// Now reference the driver object.</span>
03739         <span class="comment">//</span>
03740 
03741         status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(driverHandle,
03742                                            0,
03743                                            IoDriverObjectType,
03744                                            KernelMode,
03745                                            &amp;driverObject,
03746                                            NULL
03747                                            );
03748         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(driverHandle);
03749     }
03750 
03751     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03752         <span class="keywordflow">return</span> driverObject;
03753     } <span class="keywordflow">else</span> {
03754         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03755     }
03756 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pnpsubs.c::IopRegMultiSzToUnicodeStrings" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRegMultiSzToUnicodeStrings           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKEY_VALUE_FULL_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>KeyValueInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING *&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UnicodeStringCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l02080">2080</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l02570">IopFreeUnicodeStringList()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00449">StringLength()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>02088                    :
02089 
02090     This routine takes a KEY_VALUE_FULL_INFORMATION structure containing
02091     a REG_MULTI_SZ value, and allocates an array of UNICODE_STRINGs,
02092     initializing each one to a copy of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
02093     All <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resulting UNICODE_STRINGs will be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> terminated
02094     (MaximumLength = Length + <span class="keyword">sizeof</span>(UNICODE_NULL)).
02095 
02096     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> responsibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers <span class="keywordflow">for</span> each
02097     unicode string, as well as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE_STRING
02098     array. This may be done by calling <a class="code" href="../../d9/d0/pnpiop_8h.html#a246">IopFreeUnicodeStringList</a>.
02099 
02100 Arguments:
02101 
02102     KeyValueInformation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REG_MULTI_SZ
02103         value entry data.
02104 
02105     UnicodeStringList - Receives a pointer to an array of UNICODE_STRINGs, each
02106         initialized with a copy of one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REG_MULTI_SZ.
02107 
02108     UnicodeStringCount - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of strings in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02109         UnicodeStringList.
02110 
02111 Returns:
02112 
02113     NT status code indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02114 
02115 --*/
02116 
02117 {
02118     PWCHAR p, BufferEnd, StringStart;
02119     ULONG StringCount, i, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>;
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">// First, make sure this is really a REG_MULTI_SZ value.</span>
02123     <span class="comment">//</span>
02124     <span class="keywordflow">if</span>(KeyValueInformation-&gt;Type != REG_MULTI_SZ) {
02125         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02126     }
02127 
02128     <span class="comment">//</span>
02129     <span class="comment">// Make a preliminary pass through the buffer to count the number of strings</span>
02130     <span class="comment">// There will always be at least one string returned (possibly empty).</span>
02131     <span class="comment">//</span>
02132     StringCount = 0;
02133     p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02134     BufferEnd = (PWCHAR)((PUCHAR)p + KeyValueInformation-&gt;DataLength);
02135     <span class="keywordflow">while</span>(p != BufferEnd) {
02136         <span class="keywordflow">if</span>(!*p) {
02137             StringCount++;
02138             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02139                 <span class="keywordflow">break</span>;
02140             }
02141         }
02142         p++;
02143     }
02144     <span class="keywordflow">if</span>(p == BufferEnd) {
02145         StringCount++;
02146     }
02147 
02148     *UnicodeStringList = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, <span class="keyword">sizeof</span>(UNICODE_STRING) * StringCount);
02149     <span class="keywordflow">if</span>(!(*UnicodeStringList)) {
02150         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02151     }
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// Now, make a second pass through the buffer making copies of each string.</span>
02155     <span class="comment">//</span>
02156     i = 0;
02157     StringStart = p = (PWCHAR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(KeyValueInformation);
02158     <span class="keywordflow">while</span>(p != BufferEnd) {
02159         <span class="keywordflow">if</span>(!*p) {
02160             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart) + <span class="keyword">sizeof</span>(UNICODE_NULL);
02161             (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, StringLength);
02162 
02163             <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02164                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02165                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02166             }
02167 
02168             RtlMoveMemory((*UnicodeStringList)[i].Buffer, StringStart, StringLength);
02169 
02170             (*UnicodeStringList)[i].Length =
02171                 ((*UnicodeStringList)[i].MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02172                 - <span class="keyword">sizeof</span>(UNICODE_NULL);
02173 
02174             i++;
02175 
02176             <span class="keywordflow">if</span>(((p + 1) == BufferEnd) || !*(p + 1)) {
02177                 <span class="keywordflow">break</span>;
02178             } <span class="keywordflow">else</span> {
02179                 StringStart = p + 1;
02180             }
02181         }
02182         p++;
02183     }
02184     <span class="keywordflow">if</span>(p == BufferEnd) {
02185         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a> = (ULONG)((PUCHAR)p - (PUCHAR)StringStart);
02186         (*UnicodeStringList)[i].Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool,
02187                                                         StringLength + <span class="keyword">sizeof</span>(UNICODE_NULL)
02188                                                        );
02189         <span class="keywordflow">if</span>(!((*UnicodeStringList)[i].Buffer)) {
02190             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a17">IopFreeUnicodeStringList</a>(*UnicodeStringList, i);
02191             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02192         }
02193         <span class="keywordflow">if</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>) {
02194             RtlMoveMemory((*UnicodeStringList)[i].Buffer, StringStart, StringLength);
02195         }
02196         (*UnicodeStringList)[i].Buffer[CB_TO_CWC(StringLength)] = UNICODE_NULL;
02197 
02198         (*UnicodeStringList)[i].MaximumLength =
02199                 ((*UnicodeStringList)[i].Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1158">StringLength</a>)
02200                 + <span class="keyword">sizeof</span>(UNICODE_NULL);
02201     }
02202 
02203     *UnicodeStringCount = StringCount;
02204 
02205     <span class="keywordflow">return</span> STATUS_SUCCESS;
02206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpsubs.c::IopRemoveStringFromValueKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRemoveStringFromValueKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>ValueName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00449">449</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d2/d0/rtdelval_8c-source.html#l00047">ValueName</a>.
<p>
<pre class="fragment"><div>00457                    :
00458 
00459     This routine remove a string from a value entry specified by <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>
00460     under an already opened registry handle.  Note, <span class="keyword">this</span> routine will not
00461     <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> entry even <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> becomes empty after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> removal.
00462 
00463 Parameters:
00464 
00465     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to a registry key whose value entry will
00466         be modified.
00467 
00468     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> - Supplies a unicode string to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value entry.
00469 
00470     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Supplies a unicode string to remove from value entry.
00471 
00472 Return Value:
00473 
00474     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00475 
00476 --*/
00477 
00478 {
00479     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00480     UNICODE_STRING unicodeString;
00481     PWSTR nextString, currentString;
00482     ULONG length, leftLength;
00483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00484     BOOLEAN found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485 
00486     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) == 0) {
00487         <span class="keywordflow">return</span> STATUS_SUCCESS;
00488     }
00489 
00490     <span class="comment">//</span>
00491     <span class="comment">// Read registry value entry data</span>
00492     <span class="comment">//</span>
00493 
00494     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(Handle, ValueName, &amp;keyValueInformation);
00495 
00496     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
00497         <span class="keywordflow">return</span> status;
00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((keyValueInformation-&gt;Type != REG_MULTI_SZ) ||
00499                (keyValueInformation-&gt;DataLength == 0)) {
00500 
00501         status = (keyValueInformation-&gt;Type == REG_MULTI_SZ) ? STATUS_SUCCESS
00502                                                              : STATUS_INVALID_PARAMETER;
00503         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00504         <span class="keywordflow">return</span> status;
00505     }
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Scan through the multi_sz string to find the matching string</span>
00509     <span class="comment">// and remove it.</span>
00510     <span class="comment">//</span>
00511 
00512     status = STATUS_SUCCESS;
00513     currentString = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation);
00514     leftLength = keyValueInformation-&gt;DataLength;
00515     <span class="keywordflow">while</span> (!found &amp;&amp; leftLength &gt;= <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length + <span class="keyword">sizeof</span>(WCHAR)) {
00516         unicodeString.Buffer = currentString;
00517         length = wcslen( currentString ) * <span class="keyword">sizeof</span>( WCHAR );
00518         unicodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00519         length += <span class="keyword">sizeof</span>(UNICODE_NULL);
00520         unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)length;
00521         nextString = currentString + length / <span class="keyword">sizeof</span>(WCHAR);
00522         leftLength -= length;
00523 
00524         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;unicodeString, String, TRUE)) {
00525             found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00526             RtlMoveMemory(currentString, nextString, leftLength);
00527             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, ValueName);
00528             status = ZwSetValueKey(
00529                         Handle,
00530                         &amp;unicodeString,
00531                         TITLE_INDEX_VALUE,
00532                         REG_MULTI_SZ,
00533                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00534                         keyValueInformation-&gt;DataLength - length
00535                         );
00536             <span class="keywordflow">break</span>;
00537         } <span class="keywordflow">else</span> {
00538             currentString = nextString;
00539         }
00540     }
00541     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00542     <span class="keywordflow">return</span> status;
00543 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="pnpsubs.c::IopRestartDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRestartDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l05777">5777</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00396">DNF_ENUMERATED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00522">DNF_ENUMERATION_REQUEST_QUEUED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00602">DNUF_NEED_RESTART</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00589">DNUF_WILL_BE_REMOVED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
<pre class="fragment"><div>05780 {
05781     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05782 
05783     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode) ||
05784             (DeviceNode-&gt;Flags &amp; (DNF_STARTED |
05785                                  DNF_ADDED |
05786                                  DNF_RESOURCE_ASSIGNED |
05787                                  DNF_RESOURCE_REPORTED)) ||
05788             (DeviceNode-&gt;UserFlags &amp; DNUF_WILL_BE_REMOVED)));
05789 
05790     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; DNF_ENUMERATED);
05791 
05792     <span class="keywordflow">if</span> (!(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a>)) {
05793         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05794     }
05795 
05796     DeviceNode-&gt;UserFlags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a39">DNUF_NEED_RESTART</a>;
05797 
05798 <span class="preprocessor">#if DBG_SCOPE</span>
05799 <span class="preprocessor"></span>    DeviceNode-&gt;FailureStatus = 0;
05800     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
05801         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
05802         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05803     }
05804     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
05805         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
05806         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05807     }
05808 <span class="preprocessor">#endif</span>
05809 <span class="preprocessor"></span>
05810     <span class="comment">//</span>
05811     <span class="comment">// Free any existing devnode strings so we can recreate them</span>
05812     <span class="comment">// during enumeration.</span>
05813     <span class="comment">//</span>
05814 
05815     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>) {
05816 
05817         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> |
05818                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a> |
05819                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a> |
05820                                <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>);
05821 
05822         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
05823             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
05824             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;DeviceNode-&gt;ServiceName, NULL);
05825         }
05826 
05827         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
05829             DeviceNode-&gt;ResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05830             DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
05831         }
05832     }
05833 
05834     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;ServiceName.Length == 0 &amp;&amp;
05835            DeviceNode-&gt;ServiceName.MaximumLength == 0 &amp;&amp;
05836            DeviceNode-&gt;ServiceName.Buffer == NULL);
05837 
05838     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(DeviceNode-&gt;Flags &amp;
05839            ~(DNF_MADEUP | DNF_ENUMERATED | DNF_HAS_BOOT_CONFIG |
05840              DNF_BOOT_CONFIG_RESERVED | DNF_NO_RESOURCE_REQUIRED)));
05841 
05842     <span class="keywordflow">return</span> STATUS_SUCCESS;
05843 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpsubs.c::IopServiceInstanceToDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopServiceInstanceToDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE ServiceKeyHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING ServiceKeyName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceInstanceOrdinal</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING DeviceInstanceRegistryPath&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE DeviceInstanceHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00931">931</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00176">CmRegistryMachineSystemCurrentControlSetEnumName</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00695">IopConcatenateUnicodeStrings()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01342">IopOpenServiceEnumKeys()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00862">IopRegistryDataToUnicodeString</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00813">KEY_VALUE_DATA</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00942                    :
00943 
00944     This routine reads <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> service node <span class="keyword">enum</span> entry to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired device instance
00945     under <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> System\Enum tree.  It then optionally returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> registry <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00946     specified device instance (relative to HKLM\System\Enum) and an open handle
00947     to that registry key.
00948 
00949     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to close <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle returned <span class="keywordflow">if</span>
00950     DeviceInstanceHandle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied, and also to free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> (PagedPool) memory
00951     allocated for the unicode string buffer of DeviceInstanceRegistryPath, if
00952     supplied.
00953 
00954 Parameters:
00955 
00956     ServiceKeyHandle - Optionally, supplies a handle to the driver service node in the
00957         registry that controls this device instance.  If this argument is not specified,
00958         then ServiceKeyName is used to specify the service entry.
00959 
00960     ServiceKeyName - Optionally supplies the name of the service entry that controls
00961         the device instance. This must be specified if ServiceKeyHandle isn't given.
00962 
00963     ServiceInstanceOrdinal - Supplies the instance value under the service entry's
00964         volatile Enum subkey that references the desired device instance.
00965 
00966     DeviceInstanceRegistryPath - Optionally, supplies a pointer to a unicode string
00967         that will be initialized with the registry path (relative to HKLM\System\Enum)
00968         to the device instance key.
00969 
00970     DeviceInstanceHandle - Optionally, supplies a pointer to a variable that will
00971         receive a handle to the opened device instance registry key.
00972 
00973     DesiredAccess - If DeviceInstanceHandle is specified (i.e., the device instance
00974         key is to be opened), then this variable specifies the access that is needed
00975         to this key.
00976 
00977 Return Value:
00978 
00979     NT status code indicating whether the function was successful.
00980 
00981 --*/
00982 
00983 {
00984     WCHAR unicodeBuffer[20];
00985     UNICODE_STRING unicodeKeyName;
00986     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00987     HANDLE handle;
00988     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00989 
00990     <span class="comment">//</span>
00991     <span class="comment">// Open registry ServiceKeyName\Enum branch</span>
00992     <span class="comment">//</span>
00993     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ServiceKeyHandle)) {
00994 
00995         PiWstrToUnicodeString(&amp;unicodeKeyName, REGSTR_KEY_ENUM);
00996         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00997                                        ServiceKeyHandle,
00998                                        &amp;unicodeKeyName,
00999                                        KEY_READ
01000                                        );
01001     } <span class="keywordflow">else</span> {
01002 
01003         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a8">IopOpenServiceEnumKeys</a>(ServiceKeyName,
01004                                         KEY_READ,
01005                                         NULL,
01006                                         &amp;handle,
01007                                         FALSE
01008                                        );
01009     }
01010 
01011     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01012 
01013         <span class="comment">//</span>
01014         <span class="comment">// There is no registry key for the ServiceKeyName\Enum information.</span>
01015         <span class="comment">//</span>
01016 
01017         <span class="keywordflow">return</span> status;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">// Read a path to System\Enum hardware tree branch specified by the service</span>
01022     <span class="comment">// instance ordinal</span>
01023     <span class="comment">//</span>
01024 
01025     swprintf(unicodeBuffer, REGSTR_VALUE_STANDARD_ULONG_FORMAT, ServiceInstanceOrdinal);
01026     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> ( handle,
01027                                    unicodeBuffer,
01028                                    &amp;keyValueInformation
01029                                    );
01030 
01031     ZwClose(handle);
01032     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01033         <span class="keywordflow">return</span> status;
01034     } <span class="keywordflow">else</span> {
01035         <span class="keywordflow">if</span>(keyValueInformation-&gt;Type == REG_SZ) {
01036             <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;unicodeKeyName,
01037                                            (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
01038                                            keyValueInformation-&gt;DataLength
01039                                           );
01040             <span class="keywordflow">if</span>(!unicodeKeyName.Length) {
01041                 status = STATUS_OBJECT_PATH_NOT_FOUND;
01042             }
01043         } <span class="keywordflow">else</span> {
01044             status = STATUS_INVALID_PLUGPLAY_DEVICE_PATH;
01045         }
01046 
01047         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01048             <span class="keywordflow">goto</span> PrepareForReturn;
01049         }
01050     }
01051 
01052     <span class="comment">//</span>
01053     <span class="comment">// If the DeviceInstanceHandle argument was specified, open the device instance</span>
01054     <span class="comment">// key under HKLM\System\CurrentControlSet\Enum</span>
01055     <span class="comment">//</span>
01056 
01057     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01058 
01059         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
01060                                        NULL,
01061                                        &amp;CmRegistryMachineSystemCurrentControlSetEnumName,
01062                                        KEY_READ
01063                                        );
01064 
01065         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01066 
01067             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( DeviceInstanceHandle,
01068                                            handle,
01069                                            &amp;unicodeKeyName,
01070                                            DesiredAccess
01071                                            );
01072             ZwClose(handle);
01073         }
01074 
01075         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01076             <span class="keywordflow">goto</span> PrepareForReturn;
01077         }
01078     }
01079 
01080     <span class="comment">//</span>
01081     <span class="comment">// If the DeviceInstanceRegistryPath argument was specified, then store a</span>
01082     <span class="comment">// copy of the device instance path in the supplied unicode string variable.</span>
01083     <span class="comment">//</span>
01084     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DeviceInstanceRegistryPath)) {
01085 
01086         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(DeviceInstanceRegistryPath,
01087                                           &amp;unicodeKeyName,
01088                                           NULL)) {
01089 
01090             <span class="keywordflow">if</span>(ARGUMENT_PRESENT(DeviceInstanceHandle)) {
01091                 ZwClose(*DeviceInstanceHandle);
01092             }
01093             status = STATUS_INSUFFICIENT_RESOURCES;
01094         }
01095     }
01096 
01097 PrepareForReturn:
01098 
01099     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
01100     <span class="keywordflow">return</span> status;
01101 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pnpsubs.c::IopSetServiceInstanceCsConfigFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetServiceInstanceCsConfigFlags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ServiceKeyName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Instance</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CsConfigFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01653">1653</a> of file <a class="el" href="../../d0/d1/pnpsubs_8c-source.html">pnpsubs.c</a>.
<p>
References <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l01588">IopOpenCurrentHwProfileDeviceInstanceKey()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01661                    :
01662 
01663     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> csconfig flags <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device
01664     which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance number under ServiceKeyName\Enum.
01665 
01666 Arguments:
01667 
01668     ServiceKeyName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subkey in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01669         system service list (HKEY_LOCAL_MACHINE\CurrentControlSet\Services)
01670         that caused <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver to load. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RegistryPath parameter
01671         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/fs__rec_8c.html#a3">DriverEntry</a> routine.
01672 
01673     Instance - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> instance value under ServiceKeyName\Enum key
01674 
01675     CsConfigFlags - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device instance's <span class="keyword">new</span> CsConfigFlags
01676 
01677 Return Value:
01678 
01679     status
01680 
01681 --*/
01682 
01683 {
01684     HANDLE handle;
01685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01686     UNICODE_STRING tempUnicodeString;
01687 
01688     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01689 
01690     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a11">IopOpenCurrentHwProfileDeviceInstanceKey</a>(&amp;handle,
01691                                                       ServiceKeyName,
01692                                                       Instance,
01693                                                       KEY_READ | KEY_WRITE,
01694                                                       TRUE
01695                                                      );
01696     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01697 
01698         PiWstrToUnicodeString(&amp;tempUnicodeString, REGSTR_VALUE_CSCONFIG_FLAGS);
01699         status = ZwSetValueKey(handle,
01700                                &amp;tempUnicodeString,
01701                                TITLE_INDEX_VALUE,
01702                                REG_DWORD,
01703                                &amp;CsConfigFlags,
01704                                <span class="keyword">sizeof</span>(CsConfigFlags)
01705                               );
01706         ZwClose(handle);
01707     }
01708     <span class="keywordflow">return</span> status;
01709 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
