<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cachesup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cachesup.c</h1><a href="../../d8/d2/udfs_2cachesup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1996  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    CacheSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the cache management routines for the Udfs</span>
00012 <span class="comment">    FSD and FSP, by calling the Common Cache Manager.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     12-Sep-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d8/d2/udfs_2cachesup_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_CACHESUP)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d8/d2/udfs_2cachesup_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_CACHESUP)</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCompleteMdl)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCreateInternalStream)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfDeleteInternalStream)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfMapMetadataView)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfPurgeVolume)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 
00045 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00046"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a154">00046</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a> (
00047     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00048     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00049     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00050     )
00051 
00052 <span class="comment">/*++</span>
00053 <span class="comment"></span>
00054 <span class="comment">Routine Description:</span>
00055 <span class="comment"></span>
00056 <span class="comment">    This function creates an internal stream file for interaction</span>
00057 <span class="comment">    with the cache manager.  The Fcb here will be for a directory</span>
00058 <span class="comment">    stream.</span>
00059 <span class="comment"></span>
00060 <span class="comment">Arguments:</span>
00061 <span class="comment"></span>
00062 <span class="comment">    Vcb - Vcb for this volume.</span>
00063 <span class="comment"></span>
00064 <span class="comment">    Fcb - Points to the Fcb for this file.  It is an Index Fcb.</span>
00065 <span class="comment"></span>
00066 <span class="comment">Return Value:</span>
00067 <span class="comment"></span>
00068 <span class="comment">    None.</span>
00069 <span class="comment"></span>
00070 <span class="comment">--*/</span>
00071 
00072 {
00073     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     BOOLEAN DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00075 
00076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Check inputs.</span>
00080     <span class="comment">//</span>
00081 
00082     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00083     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">//  We may only have the Fcb shared.  Lock the Fcb and do a</span>
00087     <span class="comment">//  safe test to see if we need to really create the file object.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00091 
00092     <span class="keywordflow">if</span> (Fcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00093 
00094         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00095         <span class="keywordflow">return</span>;
00096     }
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00100     <span class="comment">//</span>
00101 
00102     <span class="keywordflow">try</span> {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">//  Create the internal stream.  The Vpb should be pointing at our volume</span>
00106         <span class="comment">//  device object at this point.</span>
00107         <span class="comment">//</span>
00108 
00109         StreamFile = <a class="code" href="../../d4/d6/iosubs_8c.html#a48">IoCreateStreamFileObject</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, Vcb-&gt;Vpb-&gt;RealDevice );
00110 
00111         <span class="keywordflow">if</span> (StreamFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00112 
00113             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
00114         }
00115 
00116         <span class="comment">//</span>
00117         <span class="comment">//  Initialize the fields of the file object.</span>
00118         <span class="comment">//</span>
00119 
00120         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o12">ReadAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o13">WriteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o14">DeleteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123 
00124         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> = &amp;Fcb-&gt;FcbNonpaged-&gt;SegmentObject;
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">//  Set the file object type and increment the Vcb counts.</span>
00128         <span class="comment">//</span>
00129 
00130         <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a>( IrpContext,
00131                          StreamFile,
00132                          <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>,
00133                          Fcb,
00134                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">//  We will reference the current Fcb twice to keep it from going</span>
00138         <span class="comment">//  away in the error path.  Otherwise if we dereference it</span>
00139         <span class="comment">//  below in the finally clause a close could cause the Fcb to</span>
00140         <span class="comment">//  be deallocated.</span>
00141         <span class="comment">//</span>
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00144         
00145         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, 
00146                      <span class="stringliteral">"UdfCreateInternalStream, Fcb %08x Vcb %d/%d Fcb %d/%d\n"</span>,
00147                      Fcb,
00148                      Vcb-&gt;VcbReference,
00149                      Vcb-&gt;VcbUserReference,
00150                      Fcb-&gt;FcbReference,
00151                      Fcb-&gt;FcbUserReference ));
00152 
00153         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Fcb, 2, 0 );
00154         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00155         DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">//  Initialize the cache map for the file.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( StreamFile,
00162                               (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>)&amp;Fcb-&gt;AllocationSize,
00163                               <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00164                               &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00165                               Fcb );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Go ahead and store the stream file into the Fcb.</span>
00169         <span class="comment">//</span>
00170 
00171         Fcb-&gt;FileObject = StreamFile;
00172         StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173 
00174     } finally {
00175 
00176         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCreateInternalStream"</span> );
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">//  If we raised then we need to dereference the file object.</span>
00180         <span class="comment">//</span>
00181 
00182         <span class="keywordflow">if</span> (StreamFile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183 
00184             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( StreamFile );
00185             Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186         }
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">//  Dereference and unlock the Fcb.</span>
00190         <span class="comment">//</span>
00191 
00192         <span class="keywordflow">if</span> (DecrementReference) {
00193 
00194             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00195             <a class="code" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>( IrpContext, Fcb, 1, 0 );
00196             
00197             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, 
00198                          <span class="stringliteral">"UdfCreateInternalStream, Vcb %d/%d Fcb %d/%d\n"</span>,
00199                          Vcb-&gt;VcbReference,
00200                          Vcb-&gt;VcbUserReference,
00201                          Fcb-&gt;FcbReference,
00202                          Fcb-&gt;FcbUserReference ));
00203 
00204             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00205         }
00206 
00207         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00208     }
00209 
00210     <span class="keywordflow">return</span>;
00211 }
00212 
00213 
00214 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00215"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a155">00215</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a> (
00216     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00217     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb
00218     )
00219 
00220 <span class="comment">/*++</span>
00221 <span class="comment"></span>
00222 <span class="comment">Routine Description:</span>
00223 <span class="comment"></span>
00224 <span class="comment">    This function creates an internal stream file for interaction</span>
00225 <span class="comment">    with the cache manager.  The Fcb here can be for either a</span>
00226 <span class="comment">    directory stream or for a metadata stream.</span>
00227 <span class="comment"></span>
00228 <span class="comment">Arguments:</span>
00229 <span class="comment"></span>
00230 <span class="comment">    Fcb - Points to the Fcb for this file.  It is either an Index or</span>
00231 <span class="comment">        Metadata Fcb.</span>
00232 <span class="comment"></span>
00233 <span class="comment">Return Value:</span>
00234 <span class="comment"></span>
00235 <span class="comment">    None.</span>
00236 <span class="comment"></span>
00237 <span class="comment">--*/</span>
00238 
00239 {
00240     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00241 
00242     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00243 
00244     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00245     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">//  Lock the Fcb.</span>
00249     <span class="comment">//</span>
00250 
00251     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">//  Capture the file object.</span>
00255     <span class="comment">//</span>
00256 
00257     FileObject = Fcb-&gt;FileObject;
00258     Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">//  It is now safe to unlock the Fcb.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">//  Dereference the file object if present.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> (FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00271 
00272         <span class="keywordflow">if</span> (FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273 
00274             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00275         }
00276 
00277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00278     }
00279 
00280     <span class="keywordflow">return</span>;
00281 }
00282 
00283 
00284 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00285"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a156">00285</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a156">UdfCompleteMdl</a> (
00286     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00287     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00288     )
00289 
00290 <span class="comment">/*++</span>
00291 <span class="comment"></span>
00292 <span class="comment">Routine Description:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    This routine performs the function of completing Mdl reads.</span>
00295 <span class="comment">    It should be called only from UdfCommonRead.</span>
00296 <span class="comment"></span>
00297 <span class="comment">Arguments:</span>
00298 <span class="comment"></span>
00299 <span class="comment">    Irp - Supplies the originating Irp.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Return Value:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    NTSTATUS - Will always be STATUS_SUCCESS.</span>
00304 <span class="comment"></span>
00305 <span class="comment">--*/</span>
00306 
00307 {
00308     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00309 
00310     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Do completion processing.</span>
00314     <span class="comment">//</span>
00315 
00316     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject;
00317 
00318     <a class="code" href="../../d4/d2/cache_8h.html#a79">CcMdlReadComplete</a>( FileObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// Mdl is now deallocated.</span>
00322     <span class="comment">//</span>
00323 
00324     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Complete the request and exit right away.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00331 
00332     <span class="keywordflow">return</span> STATUS_SUCCESS;
00333 }
00334 
00335 
00336 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00337"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a157">00337</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a157">UdfMapMetadataView</a> (
00338     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00339     IN <a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html">PMAPPED_PVIEW</a> View,
00340     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00341     IN USHORT Partition,
00342     IN ULONG Lbn,
00343     IN ULONG Length
00344     )
00345 
00346 <span class="comment">/*++</span>
00347 <span class="comment"></span>
00348 <span class="comment">Routine Description:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    Perform the common work of mapping an extent of metadata into a mapped view.</span>
00351 <span class="comment"></span>
00352 <span class="comment">Arguments:</span>
00353 <span class="comment"></span>
00354 <span class="comment">    View - View structure to map the bytes into</span>
00355 <span class="comment">    </span>
00356 <span class="comment">    Vcb - Vcb of the volume the extent is on</span>
00357 <span class="comment">    </span>
00358 <span class="comment">    Partition - Partition of the extent</span>
00359 <span class="comment">    </span>
00360 <span class="comment">    Lbn - Lbn of the extent</span>
00361 <span class="comment">    </span>
00362 <span class="comment">    Length - Length of the extent</span>
00363 <span class="comment"></span>
00364 <span class="comment">Return Value:</span>
00365 <span class="comment"></span>
00366 <span class="comment">    None.</span>
00367 <span class="comment"></span>
00368 <span class="comment">--*/</span>
00369 
00370 {
00371     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00372     ULONG Vsn;
00373 
00374     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Remove any existing mapping</span>
00378     <span class="comment">//</span>
00379     
00380     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, View );
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  Update the view information.</span>
00384     <span class="comment">//</span>
00385 
00386     View-&gt;Partition = Partition;
00387     View-&gt;Lbn = Lbn;
00388     View-&gt;Length = Length;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">//  Find the mapping of this extent in the Metadata stream.</span>
00392     <span class="comment">//</span>
00393 
00394     Vsn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a>( IrpContext,
00395                                     Vcb,
00396                                     Partition,
00397                                     Lbn,
00398                                     Length,
00399                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00400 
00401     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, Vsn );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Map the extent</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Vcb-&gt;MetadataFcb-&gt;FileObject,
00408                &amp;<a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>,
00409                Length,
00410                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00411                &amp;View-&gt;Bcb,
00412                &amp;View-&gt;View );
00413 }
00414 
00415 
00416 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00417"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a158">00417</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a> (
00418     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00419     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00420     IN BOOLEAN DismountUnderway
00421     )
00422 
00423 <span class="comment">/*++</span>
00424 <span class="comment"></span>
00425 <span class="comment">Routine Description:</span>
00426 <span class="comment"></span>
00427 <span class="comment">    This routine is called to purge the volume.  The purpose is to make all the stale file</span>
00428 <span class="comment">    objects in the system go away, minimizing the reference counts, so that the volume may</span>
00429 <span class="comment">    be locked or deleted.</span>
00430 <span class="comment"></span>
00431 <span class="comment">    The Vcb is already acquired exclusively.  We will lock out all file operations by</span>
00432 <span class="comment">    acquiring the global file resource.  Then we will walk through all of the Fcb's and</span>
00433 <span class="comment">    perform the purge.</span>
00434 <span class="comment"></span>
00435 <span class="comment">Arguments:</span>
00436 <span class="comment"></span>
00437 <span class="comment">    Vcb - Vcb for the volume to purge.</span>
00438 <span class="comment"></span>
00439 <span class="comment">    DismountUnderway - Indicates that we are trying to delete all of the objects.</span>
00440 <span class="comment">        We will purge the Metadata and VolumeDasd and dereference all internal streams.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Return Value:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    NTSTATUS - The first failure of the purge operation.</span>
00445 <span class="comment"></span>
00446 <span class="comment">--*/</span>
00447 
00448 {
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00450 
00451     PVOID RestartKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00452     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ThisFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00453     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00454 
00455     BOOLEAN RemovedFcb;
00456 
00457     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">//  Force any remaining Fcb's in the delayed close queue to be closed.</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">//  Acquire the global file resource.</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d3/d8/udfprocs_8h.html#a77">UdfAcquireAllFiles</a>( IrpContext, Vcb );
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">//  Loop through each Fcb in the Fcb Table and perform the flush.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">//  Lock the Vcb to lookup the next Fcb.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00482         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a212">UdfGetNextFcb</a>( IrpContext, Vcb, &amp;RestartKey );
00483 
00484         <span class="comment">//</span>
00485         <span class="comment">//  Reference the NextFcb if present.</span>
00486         <span class="comment">//</span>
00487 
00488         <span class="keywordflow">if</span> (NextFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00489 
00490             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
00491         }
00492 
00493         <span class="comment">//</span>
00494         <span class="comment">//  If the last Fcb is present then decrement reference count and call teardown</span>
00495         <span class="comment">//  to see if it should be removed.</span>
00496         <span class="comment">//</span>
00497 
00498         <span class="keywordflow">if</span> (ThisFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499 
00500             ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
00501 
00502             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00503 
00504             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00505 
00506         } <span class="keywordflow">else</span> {
00507 
00508             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00509         }
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">//  Break out of the loop if no more Fcb's.</span>
00513         <span class="comment">//</span>
00514 
00515         <span class="keywordflow">if</span> (NextFcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00516 
00517             <span class="keywordflow">break</span>;
00518         }
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">//  Move to the next Fcb.</span>
00522         <span class="comment">//</span>
00523 
00524         ThisFcb = NextFcb;
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">//  If there is a image section then see if that can be closed.</span>
00528         <span class="comment">//</span>
00529 
00530         <span class="keywordflow">if</span> (ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00531 
00532             <a class="code" href="../../d6/d5/flushsec_8c.html#a13">MmFlushImageSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>, <a class="code" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a> );
00533         }
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">//  If there is a data section then purge this.  If there is an image</span>
00537         <span class="comment">//  section then we won't be able to.  Remember this if it is our first</span>
00538         <span class="comment">//  error.</span>
00539         <span class="comment">//</span>
00540 
00541         <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00542             !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00543                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00544                                    0,
00545                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00546             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00547 
00548             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00549         }
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">//  Dereference the internal stream if dismounting.</span>
00553         <span class="comment">//</span>
00554 
00555         <span class="keywordflow">if</span> (DismountUnderway &amp;&amp;
00556             (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( ThisFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) &amp;&amp;
00557             (ThisFcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00558 
00559             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00560         }
00561     }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">//  Now look at the Root Index, Metadata, Volume Dasd and VAT Fcbs.</span>
00565     <span class="comment">//  Note that we usually hit the Root Index in the loop above, but</span>
00566     <span class="comment">//  it is possible miss it if it didn't get into the Fcb table in the</span>
00567     <span class="comment">//  first place!</span>
00568     <span class="comment">//</span>
00569 
00570     <span class="keywordflow">if</span> (DismountUnderway) {
00571 
00572         <span class="keywordflow">if</span> (Vcb-&gt;RootIndexFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00573 
00574             ThisFcb = Vcb-&gt;RootIndexFcb;
00575             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00576 
00577             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00578                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00579                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00580                                        0,
00581                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00582                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00583 
00584                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00585             }
00586 
00587             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00588             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00589             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00590         }
00591         
00592         <span class="keywordflow">if</span> (Vcb-&gt;MetadataFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593 
00594             ThisFcb = Vcb-&gt;MetadataFcb;
00595             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00596 
00597             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00598                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00599                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00600                                        0,
00601                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00602                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00603 
00604                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00605             }
00606 
00607             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00608             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00609             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00610         }
00611 
00612         <span class="keywordflow">if</span> (Vcb-&gt;VatFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613 
00614             ThisFcb = Vcb-&gt;VatFcb;
00615             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00616 
00617             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00618                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00619                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00620                                        0,
00621                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00622                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00623 
00624                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00625             }
00626 
00627             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00628             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00629             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00630         }
00631 
00632         <span class="keywordflow">if</span> (Vcb-&gt;VolumeDasdFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00633 
00634             ThisFcb = Vcb-&gt;VolumeDasdFcb;
00635             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00636 
00637             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00638                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00639                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00640                                        0,
00641                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> ) &amp;&amp;
00642                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00643 
00644                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00645             }
00646 
00647             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00648             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00649         }
00650     }
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">//  Release all of the files.</span>
00654     <span class="comment">//</span>
00655 
00656     <a class="code" href="../../d3/d8/udfprocs_8h.html#a78">UdfReleaseAllFiles</a>( IrpContext, Vcb );
00657 
00658     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00659 }
00660 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
