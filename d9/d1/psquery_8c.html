<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psquery.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psquery.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>
<code>#include "winerror.h"</code><br>

<p>
<a href="../../d0/d1/psquery_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a0">WS_CATCH_SIZE</a>&nbsp;&nbsp;&nbsp;8192</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a1">WS_OVERHEAD</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a2">MAX_WS_CATCH_INDEX</a>&nbsp;&nbsp;&nbsp;(((WS_CATCH_SIZE-WS_OVERHEAD)/sizeof(PROCESS_WS_WATCH_INFORMATION)) - 2)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a12">PsConvertToGuiThread</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a13">PspQueryWorkingSetWatch</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, OUT PVOID ProcessInformation, IN ULONG ProcessInformationLength, OUT PULONG ReturnLength OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a14">PspQueryQuotaLimits</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, OUT PVOID ProcessInformation, IN ULONG ProcessInformationLength, OUT PULONG ReturnLength OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a15">PspQueryPooledQuotaLimits</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, OUT PVOID ProcessInformation, IN ULONG ProcessInformationLength, OUT PULONG ReturnLength OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a16">PspSetQuotaLimits</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, IN PVOID ProcessInformation, IN ULONG ProcessInformationLength, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a17">PspSetPrimaryToken</a> (IN HANDLE ProcessHandle, IN HANDLE TokenHandle OPTIONAL, IN PACCESS_TOKEN TokenPointer OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a18">NtQueryInformationProcess</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, OUT PVOID ProcessInformation, IN ULONG ProcessInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a19">NtSetInformationProcess</a> (IN HANDLE ProcessHandle, IN PROCESSINFOCLASS ProcessInformationClass, IN PVOID ProcessInformation, IN ULONG ProcessInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a20">NtQueryInformationThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN THREADINFOCLASS ThreadInformationClass, OUT PVOID ThreadInformation, IN ULONG ThreadInformationLength, OUT PULONG ReturnLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a> (IN HANDLE <a class="el" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>, IN THREADINFOCLASS ThreadInformationClass, IN PVOID ThreadInformation, IN ULONG ThreadInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a22">PsWatchWorkingSet</a> (IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, IN PVOID PcValue, IN PVOID Va)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a23">PsEstablishWin32Callouts</a> (IN <a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a> ProcessCallout, IN <a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a> ThreadCallout, IN <a class="el" href="../../d5/d8/ex_8h.html#a170">PKWIN32_GLOBALATOMTABLE_CALLOUT</a> GlobalAtomTableCallout, IN <a class="el" href="../../d1/d9/ps_8h.html#a86">PKWIN32_POWEREVENT_CALLOUT</a> PowerEventCallout, IN <a class="el" href="../../d1/d9/ps_8h.html#a87">PKWIN32_POWERSTATE_CALLOUT</a> PowerStateCallout, IN <a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a> JobCallout, IN PVOID BatchFlushRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d1/d9/ps_8h.html#a88">PSPROCESSPRIORITYMODE</a> PriorityMode)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a3">ObpInitKillMutant</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a4">ExpDefaultErrorPortProcess</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a5">PsWatchEnabled</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KPRIORITY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a6">PspPriorityTable</a> [PROCESS_PRIORITY_CLASS_ABOVE_NORMAL+1] = {8,4,8,13,24,6,10}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a7">PspW32ProcessCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a8">PspW32ThreadCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a9">PspW32JobCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a86">PKWIN32_POWEREVENT_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a10">PopEventCallout</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d9/ps_8h.html#a87">PKWIN32_POWERSTATE_CALLOUT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/psquery_8c.html#a11">PopStateCallout</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="psquery.c::MAX_WS_CATCH_INDEX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAX_WS_CATCH_INDEX&nbsp;&nbsp;&nbsp;(((WS_CATCH_SIZE-WS_OVERHEAD)/sizeof(PROCESS_WS_WATCH_INFORMATION)) - 2)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00050">50</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="psquery.c::WS_CATCH_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WS_CATCH_SIZE&nbsp;&nbsp;&nbsp;8192          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00048">48</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psquery.c::WS_OVERHEAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WS_OVERHEAD&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00049">49</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a18" doxytag="psquery.c::NtQueryInformationProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryInformationProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">531</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00026">DebugPort</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02723">_HANDLE_TABLE::HandleCount</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00178">KeReleaseMutant()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00034">ObpInitKillMutant</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00236">ObQueryDeviceMapInformation()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00025">PspQueryLdtInformation()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, and <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01601">_EndTask()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03502">CreateCtrlThread()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00549">GetNetworkDrives()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l00219">UserClientShutdown()</a>, and <a class="el" href="../../d4/d7/client_8c-source.html#l01434">WaitForInputIdle()</a>.
<p>
<pre class="fragment"><div>00539 {
00540     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00541     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00542     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00543     PROCESS_BASIC_INFORMATION BasicInfo;
00544     VM_COUNTERS VmCounters;
00545     IO_COUNTERS IoCounters;
00546     KERNEL_USER_TIMES SysUserTime;
00547     HANDLE <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
00548     ULONG HandleCount;
00549     ULONG DefaultHardErrorMode;
00550     HANDLE Wx86Info;
00551     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> Ht;
00552     ULONG DisableBoost;
00553     PPROCESS_DEVICEMAP_INFORMATION DeviceMapInfo;
00554     PROCESS_SESSION_INFORMATION SessionInfo;
00555     PROCESS_PRIORITY_CLASS PriorityClass;
00556     ULONG_PTR Wow64Info;
00557 
00558     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00559 
00560     <span class="comment">//</span>
00561     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
00562     <span class="comment">//</span>
00563 
00564     PreviousMode = KeGetPreviousMode();
00565     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00566         <span class="keywordflow">try</span> {
00567             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ProcessInformation,
00568                           ProcessInformationLength,
00569                           <span class="keyword">sizeof</span>(ULONG));
00570             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00571                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00572             }
00573         } except(EXCEPTION_EXECUTE_HANDLER) {
00574             <span class="keywordflow">return</span> GetExceptionCode();
00575         }
00576     }
00577 
00578     <span class="comment">//</span>
00579     <span class="comment">// Check argument validity.</span>
00580     <span class="comment">//</span>
00581 
00582     <span class="keywordflow">switch</span> ( ProcessInformationClass ) {
00583 
00584     <span class="keywordflow">case</span> ProcessWorkingSetWatch:
00585 
00586         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/psquery_8c.html#a13">PspQueryWorkingSetWatch</a>(
00587                     ProcessHandle,
00588                     ProcessInformationClass,
00589                     ProcessInformation,
00590                     ProcessInformationLength,
00591                     ReturnLength,
00592                     PreviousMode
00593                     );
00594 
00595     <span class="keywordflow">case</span> ProcessBasicInformation:
00596 
00597         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(PROCESS_BASIC_INFORMATION) ) {
00598             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00599         }
00600 
00601         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00602                 ProcessHandle,
00603                 PROCESS_QUERY_INFORMATION,
00604                 PsProcessType,
00605                 PreviousMode,
00606                 (PVOID *)&amp;Process,
00607                 NULL
00608                 );
00609         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00610             <span class="keywordflow">return</span> st;
00611         }
00612 
00613         BasicInfo.ExitStatus = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a>;
00614         BasicInfo.PebBaseAddress = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>;
00615         BasicInfo.AffinityMask = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o10">Affinity</a>;
00616         BasicInfo.BasePriority = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a>;
00617         BasicInfo.UniqueProcessId = (ULONG_PTR)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>;
00618         BasicInfo.InheritedFromUniqueProcessId = (ULONG_PTR)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o53">InheritedFromUniqueProcessId</a>;
00619 
00620         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00621 
00622         <span class="comment">//</span>
00623         <span class="comment">// Either of these may cause an access violation. The</span>
00624         <span class="comment">// exception handler will return access violation as</span>
00625         <span class="comment">// status code. No further cleanup needs to be done.</span>
00626         <span class="comment">//</span>
00627 
00628         <span class="keywordflow">try</span> {
00629             *(PPROCESS_BASIC_INFORMATION) ProcessInformation = BasicInfo;
00630 
00631             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00632                 *ReturnLength = <span class="keyword">sizeof</span>(PROCESS_BASIC_INFORMATION);
00633             }
00634         } except(EXCEPTION_EXECUTE_HANDLER) {
00635             <span class="keywordflow">return</span> STATUS_SUCCESS;
00636         }
00637 
00638         <span class="keywordflow">return</span> STATUS_SUCCESS;
00639 
00640     <span class="keywordflow">case</span> ProcessDefaultHardErrorMode:
00641 
00642         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
00643             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00644         }
00645 
00646         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00647                 ProcessHandle,
00648                 PROCESS_QUERY_INFORMATION,
00649                 PsProcessType,
00650                 PreviousMode,
00651                 (PVOID *)&amp;Process,
00652                 NULL
00653                 );
00654 
00655         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00656             <span class="keywordflow">return</span> st;
00657         }
00658 
00659         DefaultHardErrorMode = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o55">DefaultHardErrorProcessing</a>;
00660 
00661         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00662 
00663         <span class="keywordflow">try</span> {
00664             *(PULONG) ProcessInformation = DefaultHardErrorMode;
00665 
00666             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00667                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
00668             }
00669         } except(EXCEPTION_EXECUTE_HANDLER) {
00670             <span class="keywordflow">return</span> STATUS_SUCCESS;
00671         }
00672 
00673         <span class="keywordflow">return</span> STATUS_SUCCESS;
00674     <span class="keywordflow">case</span> ProcessQuotaLimits:
00675 
00676         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/psquery_8c.html#a14">PspQueryQuotaLimits</a>(
00677                     ProcessHandle,
00678                     ProcessInformationClass,
00679                     ProcessInformation,
00680                     ProcessInformationLength,
00681                     ReturnLength,
00682                     PreviousMode
00683                     );
00684 
00685     <span class="keywordflow">case</span> ProcessPooledUsageAndLimits:
00686 
00687         <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/psquery_8c.html#a15">PspQueryPooledQuotaLimits</a>(
00688                     ProcessHandle,
00689                     ProcessInformationClass,
00690                     ProcessInformation,
00691                     ProcessInformationLength,
00692                     ReturnLength,
00693                     PreviousMode
00694                     );
00695 
00696     <span class="keywordflow">case</span> ProcessIoCounters:
00697 
00698         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(IO_COUNTERS) ) {
00699             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00700         }
00701 
00702         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00703                 ProcessHandle,
00704                 PROCESS_QUERY_INFORMATION,
00705                 PsProcessType,
00706                 PreviousMode,
00707                 (PVOID *)&amp;Process,
00708                 NULL
00709                 );
00710         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00711             <span class="keywordflow">return</span> st;
00712         }
00713 
00714         IoCounters.ReadOperationCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o79">ReadOperationCount</a>.QuadPart;
00715         IoCounters.WriteOperationCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o80">WriteOperationCount</a>.QuadPart;
00716         IoCounters.OtherOperationCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o81">OtherOperationCount</a>.QuadPart;
00717         IoCounters.ReadTransferCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o82">ReadTransferCount</a>.QuadPart;
00718         IoCounters.WriteTransferCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o83">WriteTransferCount</a>.QuadPart;
00719         IoCounters.OtherTransferCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o84">OtherTransferCount</a>.QuadPart;
00720 
00721         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">// Either of these may cause an access violation. The</span>
00725         <span class="comment">// exception handler will return access violation as</span>
00726         <span class="comment">// status code. No further cleanup needs to be done.</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">try</span> {
00730             *(PIO_COUNTERS) ProcessInformation = IoCounters;
00731 
00732             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00733                 *ReturnLength = <span class="keyword">sizeof</span>(IO_COUNTERS);
00734             }
00735         } except(EXCEPTION_EXECUTE_HANDLER) {
00736             <span class="keywordflow">return</span> STATUS_SUCCESS;
00737         }
00738 
00739         <span class="keywordflow">return</span> STATUS_SUCCESS;
00740 
00741     <span class="keywordflow">case</span> ProcessVmCounters:
00742 
00743         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(VM_COUNTERS) ) {
00744             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00745         }
00746 
00747         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00748                 ProcessHandle,
00749                 PROCESS_QUERY_INFORMATION,
00750                 PsProcessType,
00751                 PreviousMode,
00752                 (PVOID *)&amp;Process,
00753                 NULL
00754                 );
00755         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00756             <span class="keywordflow">return</span> st;
00757         }
00758 
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// Note: At some point, we might have to grab the statistics</span>
00762         <span class="comment">// lock to reliably read this stuff</span>
00763         <span class="comment">//</span>
00764 
00765         VmCounters.PeakVirtualSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o14">PeakVirtualSize</a>;
00766         VmCounters.VirtualSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o15">VirtualSize</a>;
00767         VmCounters.PageFaultCount = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00768         VmCounters.PeakWorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o3">PeakWorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00769         VmCounters.WorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00770         VmCounters.QuotaPeakPagedPoolUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o9">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00771         VmCounters.QuotaPagedPoolUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00772         VmCounters.QuotaPeakNonPagedPoolUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o9">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00773         VmCounters.QuotaNonPagedPoolUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00774         VmCounters.PagefileUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o11">PagefileUsage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00775         VmCounters.PeakPagefileUsage = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o13">PeakPagefileUsage</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00776 
00777         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00778 
00779         <span class="comment">//</span>
00780         <span class="comment">// Either of these may cause an access violation. The</span>
00781         <span class="comment">// exception handler will return access violation as</span>
00782         <span class="comment">// status code. No further cleanup needs to be done.</span>
00783         <span class="comment">//</span>
00784 
00785         <span class="keywordflow">try</span> {
00786             *(PVM_COUNTERS) ProcessInformation = VmCounters;
00787 
00788             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00789                 *ReturnLength = <span class="keyword">sizeof</span>(VM_COUNTERS);
00790             }
00791         } except(EXCEPTION_EXECUTE_HANDLER) {
00792             <span class="keywordflow">return</span> STATUS_SUCCESS;
00793         }
00794 
00795         <span class="keywordflow">return</span> STATUS_SUCCESS;
00796 
00797     <span class="keywordflow">case</span> ProcessTimes:
00798 
00799         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(KERNEL_USER_TIMES) ) {
00800             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00801         }
00802 
00803         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00804                 ProcessHandle,
00805                 PROCESS_QUERY_INFORMATION,
00806                 PsProcessType,
00807                 PreviousMode,
00808                 (PVOID *)&amp;Process,
00809                 NULL
00810                 );
00811 
00812         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00813             <span class="keywordflow">return</span> st;
00814         }
00815 
00816         <span class="comment">//</span>
00817         <span class="comment">// Need some type of interlock on KiTimeLock</span>
00818         <span class="comment">//</span>
00819 
00820         SysUserTime.KernelTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o4">KernelTime</a>,
00821                                                         KeMaximumIncrement);
00822 
00823         SysUserTime.UserTime.QuadPart = UInt32x32To64(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o5">UserTime</a>,
00824                                                       KeMaximumIncrement);
00825 
00826         SysUserTime.CreateTime = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o4">CreateTime</a>;
00827         SysUserTime.ExitTime = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o5">ExitTime</a>;
00828 
00829         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00830 
00831         <span class="comment">//</span>
00832         <span class="comment">// Either of these may cause an access violation. The</span>
00833         <span class="comment">// exception handler will return access violation as</span>
00834         <span class="comment">// status code. No further cleanup needs to be done.</span>
00835         <span class="comment">//</span>
00836 
00837         <span class="keywordflow">try</span> {
00838             *(PKERNEL_USER_TIMES) ProcessInformation = SysUserTime;
00839 
00840             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00841                 *ReturnLength = <span class="keyword">sizeof</span>(KERNEL_USER_TIMES);
00842             }
00843         } except(EXCEPTION_EXECUTE_HANDLER) {
00844             <span class="keywordflow">return</span> STATUS_SUCCESS;
00845         }
00846 
00847         <span class="keywordflow">return</span> STATUS_SUCCESS;
00848 
00849     <span class="keywordflow">case</span> ProcessDebugPort :
00850 
00851         <span class="comment">//</span>
00852         <span class="comment">// Hack for RtlQueryProcessDebugInformation:</span>
00853         <span class="comment">// if length is sizeof(HANDLE)+1, return a handle</span>
00854         <span class="comment">// to the object so that the debugger may be temporarily</span>
00855         <span class="comment">// disabled by clearing and replacing the port.</span>
00856         <span class="comment">//</span>
00857         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(HANDLE) ) {
00858             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00859         }
00860 
00861         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00862                 ProcessHandle,
00863                 PROCESS_QUERY_INFORMATION,
00864                 PsProcessType,
00865                 PreviousMode,
00866                 (PVOID *)&amp;Process,
00867                 NULL
00868                 );
00869 
00870         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00871             <span class="keywordflow">return</span> st;
00872         }
00873 
00874         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o18">DebugPort</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00875 
00876             <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00877 
00878         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessInformationLength == (ULONG) <span class="keyword">sizeof</span>(HANDLE)) {
00879 
00880             <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> = (HANDLE)-1;
00881 
00882         }
00883 
00884         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00885 
00886         <span class="comment">//</span>
00887         <span class="comment">// Either of these may cause an access violation. The</span>
00888         <span class="comment">// exception handler will return access violation as</span>
00889         <span class="comment">// status code. No further cleanup needs to be done.</span>
00890         <span class="comment">//</span>
00891 
00892         <span class="keywordflow">try</span> {
00893             *(PHANDLE) ProcessInformation = <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
00894 
00895             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00896                 *ReturnLength = <span class="keyword">sizeof</span>(HANDLE);
00897             }
00898         } except(EXCEPTION_EXECUTE_HANDLER) {
00899             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00900         }
00901 
00902         <span class="keywordflow">return</span> STATUS_SUCCESS;
00903 
00904     <span class="keywordflow">case</span> ProcessHandleCount :
00905 
00906         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(ULONG) ) {
00907             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00908         }
00909 
00910         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00911                 ProcessHandle,
00912                 PROCESS_QUERY_INFORMATION,
00913                 PsProcessType,
00914                 PreviousMode,
00915                 (PVOID *)&amp;Process,
00916                 NULL
00917                 );
00918 
00919         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00920             <span class="keywordflow">return</span> st;
00921         }
00922 
00923         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;ObpInitKillMutant,
00924                                Executive,
00925                                KernelMode,
00926                                FALSE,
00927                                NULL
00928                              );
00929 
00930         Ht = (<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o20">ObjectTable</a>;
00931 
00932         <span class="keywordflow">if</span> ( Ht ) {
00933             HandleCount = Ht-&gt;<a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html#o1">HandleCount</a>;
00934             }
00935         <span class="keywordflow">else</span> {
00936             HandleCount = 0;
00937             }
00938 
00939         <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a>( &amp;ObpInitKillMutant, 0, FALSE, FALSE );
00940 
00941         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00942 
00943         <span class="comment">//</span>
00944         <span class="comment">// Either of these may cause an access violation. The</span>
00945         <span class="comment">// exception handler will return access violation as</span>
00946         <span class="comment">// status code. No further cleanup needs to be done.</span>
00947         <span class="comment">//</span>
00948 
00949         <span class="keywordflow">try</span> {
00950             *(PULONG) ProcessInformation = HandleCount;
00951 
00952             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00953                 *ReturnLength = <span class="keyword">sizeof</span>(HANDLE);
00954             }
00955         } except(EXCEPTION_EXECUTE_HANDLER) {
00956             <span class="keywordflow">return</span> STATUS_SUCCESS;
00957         }
00958 
00959         <span class="keywordflow">return</span> STATUS_SUCCESS;
00960 
00961     <span class="keywordflow">case</span> ProcessLdtInformation :
00962 
00963         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00964                 ProcessHandle,
00965                 PROCESS_QUERY_INFORMATION | PROCESS_VM_READ,
00966                 PsProcessType,
00967                 PreviousMode,
00968                 (PVOID *)&amp;Process,
00969                 NULL
00970                 );
00971 
00972         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00973             <span class="keywordflow">return</span> st;
00974         }
00975 
00976         <span class="keywordflow">try</span> {
00977 
00978             st = <a class="code" href="../../d8/d1/psp_8h.html#a82">PspQueryLdtInformation</a>(
00979                     Process,
00980                     ProcessInformation,
00981                     ProcessInformationLength,
00982                     ReturnLength
00983                     );
00984 
00985         } except(EXCEPTION_EXECUTE_HANDLER) {
00986             st = STATUS_SUCCESS;
00987         }
00988 
00989         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00990         <span class="keywordflow">return</span> st;
00991 
00992 
00993     <span class="keywordflow">case</span> ProcessWx86Information :
00994 
00995         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(HANDLE) ) {
00996             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00997         }
00998 
00999         Wx86Info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01000 
01001 <span class="preprocessor">#ifndef i386</span>
01002 <span class="preprocessor"></span>        st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01003                 ProcessHandle,
01004                 PROCESS_QUERY_INFORMATION,
01005                 PsProcessType,
01006                 PreviousMode,
01007                 (PVOID *)&amp;Process,
01008                 NULL
01009                 );
01010 
01011         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01012             <span class="keywordflow">return</span> st;
01013         }
01014 
01015         <span class="keywordflow">if</span> ((ULONG_PTR)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a> == <span class="keyword">sizeof</span>(WX86TIB)) {
01016             Wx86Info = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o58">VdmObjects</a>;
01017         }
01018 
01019         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01020 <span class="preprocessor">#endif</span>
01021 <span class="preprocessor"></span>
01022         <span class="keywordflow">try</span> {
01023             *(PHANDLE) ProcessInformation = Wx86Info;
01024 
01025             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01026                 *ReturnLength = <span class="keyword">sizeof</span>(HANDLE);
01027             }
01028         } except(EXCEPTION_EXECUTE_HANDLER) {
01029             <span class="keywordflow">return</span> STATUS_SUCCESS;
01030         }
01031 
01032         <span class="keywordflow">return</span> STATUS_SUCCESS;
01033 
01034     <span class="keywordflow">case</span> ProcessPriorityBoost:
01035         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
01036             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01037         }
01038 
01039         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01040                 ProcessHandle,
01041                 PROCESS_QUERY_INFORMATION,
01042                 PsProcessType,
01043                 PreviousMode,
01044                 (PVOID *)&amp;Process,
01045                 NULL
01046                 );
01047 
01048         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01049             <span class="keywordflow">return</span> st;
01050         }
01051 
01052         DisableBoost = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o17">DisableBoost</a> ? 1 : 0;
01053 
01054         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01055 
01056         <span class="keywordflow">try</span> {
01057             *(PULONG)ProcessInformation = DisableBoost;
01058 
01059             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01060                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
01061             }
01062         } except(EXCEPTION_EXECUTE_HANDLER) {
01063             <span class="keywordflow">return</span> GetExceptionCode();
01064         }
01065 
01066         <span class="keywordflow">return</span> st;
01067 
01068     <span class="keywordflow">case</span> ProcessDeviceMap:
01069         DeviceMapInfo = (PPROCESS_DEVICEMAP_INFORMATION)ProcessInformation;
01070         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(DeviceMapInfo-&gt;Query) ) {
01071             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01072         }
01073 
01074         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01075                 ProcessHandle,
01076                 PROCESS_QUERY_INFORMATION,
01077                 PsProcessType,
01078                 PreviousMode,
01079                 (PVOID *)&amp;Process,
01080                 NULL
01081                 );
01082 
01083         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01084             <span class="keywordflow">return</span> st;
01085             }
01086 
01087         st = <a class="code" href="../../d7/d0/obdevmap_8c.html#a1">ObQueryDeviceMapInformation</a>( Process, DeviceMapInfo );
01088         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01089         <span class="keywordflow">return</span> st;
01090 
01091     <span class="keywordflow">case</span> ProcessSessionInformation :
01092 
01093         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(PROCESS_SESSION_INFORMATION) ) {
01094             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01095         }
01096 
01097         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01098                 ProcessHandle,
01099                 PROCESS_QUERY_INFORMATION,
01100                 PsProcessType,
01101                 PreviousMode,
01102                 (PVOID *)&amp;Process,
01103                 NULL
01104                 );
01105         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01106             <span class="keywordflow">return</span> st;
01107         }
01108 
01109         SessionInfo.SessionId = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o60">SessionId</a>;
01110 
01111         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01112 
01113         <span class="keywordflow">try</span> {
01114             *(PPROCESS_SESSION_INFORMATION) ProcessInformation = SessionInfo;
01115 
01116             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01117                 *ReturnLength = <span class="keyword">sizeof</span>(PROCESS_SESSION_INFORMATION);
01118             }
01119         } except(EXCEPTION_EXECUTE_HANDLER) {
01120             <span class="keywordflow">return</span> STATUS_SUCCESS;
01121         }
01122 
01123         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01124 
01125 
01126 
01127     <span class="keywordflow">case</span> ProcessPriorityClass:
01128 
01129         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(PROCESS_PRIORITY_CLASS) ) {
01130             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01131         }
01132 
01133         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01134                 ProcessHandle,
01135                 PROCESS_QUERY_INFORMATION,
01136                 PsProcessType,
01137                 PreviousMode,
01138                 (PVOID *)&amp;Process,
01139                 NULL
01140                 );
01141         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01142             <span class="keywordflow">return</span> st;
01143         }
01144 
01145         PriorityClass.Foreground = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01146         PriorityClass.PriorityClass = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a>;
01147 
01148         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01149 
01150         <span class="keywordflow">try</span> {
01151             *(PPROCESS_PRIORITY_CLASS) ProcessInformation = PriorityClass;
01152 
01153             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01154                 *ReturnLength = <span class="keyword">sizeof</span>(PROCESS_PRIORITY_CLASS);
01155             }
01156         } except(EXCEPTION_EXECUTE_HANDLER) {
01157             <span class="keywordflow">return</span> STATUS_SUCCESS;
01158         }
01159 
01160         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01161 
01162 
01163     <span class="keywordflow">case</span> ProcessWow64Information:
01164 
01165         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
01166             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01167         }
01168 
01169         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01170                 ProcessHandle,
01171                 PROCESS_QUERY_INFORMATION,
01172                 PsProcessType,
01173                 PreviousMode,
01174                 (PVOID *)&amp;Process,
01175                 NULL
01176                 );
01177         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01178             <span class="keywordflow">return</span> st;
01179         }
01180 
01181         Wow64Info = 0;
01182 
01183         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01184             Wow64Info = (ULONG_PTR)(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>-&gt;<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html#o0">Wow64</a>);
01185         }
01186 
01187 
01188         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01189 
01190         <span class="keywordflow">try</span> {
01191             *(PULONG_PTR)ProcessInformation = Wow64Info;
01192 
01193             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
01194                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG_PTR);
01195             }
01196         } except(EXCEPTION_EXECUTE_HANDLER) {
01197             <span class="keywordflow">return</span> STATUS_SUCCESS;
01198         }
01199 
01200         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01201 
01202 
01203     <span class="keywordflow">default</span>:
01204 
01205         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
01206     }
01207 
01208 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="psquery.c::NtQueryInformationThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQueryInformationThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN THREADINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l02706">2706</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02774">KeMaximumIncrement</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00904">KeQueryBasePriorityThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00993">KeReadStateThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00341">PS_GET_THREAD_CREATE_TIME</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00112">PspQueryDescriptorThread()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l00834">CreateWindowsWindow()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01788">RtlCheckForOrphanedCriticalSections()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d1/d1/rtlexec_8c-source.html#l01385">RtlFreeUserThreadStack()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>, and <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>.
<p>
<pre class="fragment"><div>02716                    :
02717 
02718     This function queries <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of a thread object and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02719     requested information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified record structure.
02720 
02721 Arguments:
02722 
02723     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies a handle to a thread object.
02724 
02725     ThreadInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being
02726         requested.
02727 
02728     ThreadInformation - Supplies a pointer to a record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
02729         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
02730 
02731     ThreadInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02732         to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
02733 
02734     ReturnLength - Supplies an optional pointer to a variable that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
02735         receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual length of information that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02736 
02737 Return Value:
02738 
02739     TBS
02740 
02741 --*/
02742 
02743 {
02744 
02745     LARGE_INTEGER PerformanceCount;
02746     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02747     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02748     ULONG LastThread;
02749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
02750     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
02751     THREAD_BASIC_INFORMATION BasicInfo;
02752     KERNEL_USER_TIMES SysUserTime;
02753     PVOID Win32StartAddressValue;
02754     ULONG DisableBoost;
02755     ULONG IoPending ;
02756     KIRQL irql ;
02757 
02758     <span class="comment">//</span>
02759     <span class="comment">// Get previous processor mode and probe output argument if necessary.</span>
02760     <span class="comment">//</span>
02761 
02762     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02763 
02764     PreviousMode = KeGetPreviousMode();
02765     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02766         <span class="keywordflow">try</span> {
02767             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(ThreadInformation,
02768                           ThreadInformationLength,
02769                           <span class="keyword">sizeof</span>(ULONG));
02770             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
02771                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
02772             }
02773         } except(EXCEPTION_EXECUTE_HANDLER) {
02774             <span class="keywordflow">return</span> GetExceptionCode();
02775         }
02776     }
02777 
02778     <span class="comment">//</span>
02779     <span class="comment">// Check argument validity.</span>
02780     <span class="comment">//</span>
02781 
02782     <span class="keywordflow">switch</span> ( ThreadInformationClass ) {
02783 
02784     <span class="keywordflow">case</span> ThreadBasicInformation:
02785 
02786         <span class="keywordflow">if</span> ( ThreadInformationLength != (ULONG) <span class="keyword">sizeof</span>(THREAD_BASIC_INFORMATION) ) {
02787             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02788         }
02789 
02790         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02791                 ThreadHandle,
02792                 THREAD_QUERY_INFORMATION,
02793                 PsThreadType,
02794                 PreviousMode,
02795                 (PVOID *)&amp;Thread,
02796                 NULL
02797                 );
02798         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02799             <span class="keywordflow">return</span> st;
02800         }
02801 
02802         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/thredobj_8c.html#a13">KeReadStateThread</a>(&amp;Thread-&gt;Tcb)) {
02803             BasicInfo.ExitStatus = Thread-&gt;ExitStatus;
02804             }
02805         <span class="keywordflow">else</span> {
02806             BasicInfo.ExitStatus = STATUS_PENDING;
02807             }
02808 
02809         BasicInfo.TebBaseAddress = (PTEB) Thread-&gt;Tcb.Teb;
02810         BasicInfo.ClientId = Thread-&gt;Cid;
02811         BasicInfo.AffinityMask = Thread-&gt;Tcb.Affinity;
02812         BasicInfo.Priority = Thread-&gt;Tcb.Priority;
02813         BasicInfo.BasePriority = <a class="code" href="../../d9/d1/thredobj_8c.html#a11">KeQueryBasePriorityThread</a>(&amp;Thread-&gt;Tcb);
02814 
02815         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
02816 
02817         <span class="comment">//</span>
02818         <span class="comment">// Either of these may cause an access violation. The</span>
02819         <span class="comment">// exception handler will return access violation as</span>
02820         <span class="comment">// status code. No further cleanup needs to be done.</span>
02821         <span class="comment">//</span>
02822 
02823         <span class="keywordflow">try</span> {
02824             *(PTHREAD_BASIC_INFORMATION) ThreadInformation = BasicInfo;
02825 
02826             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
02827                 *ReturnLength = <span class="keyword">sizeof</span>(THREAD_BASIC_INFORMATION);
02828             }
02829         } except(EXCEPTION_EXECUTE_HANDLER) {
02830             <span class="keywordflow">return</span> STATUS_SUCCESS;
02831         }
02832 
02833         <span class="keywordflow">return</span> STATUS_SUCCESS;
02834 
02835     <span class="keywordflow">case</span> ThreadTimes:
02836 
02837         <span class="keywordflow">if</span> ( ThreadInformationLength != (ULONG) <span class="keyword">sizeof</span>(KERNEL_USER_TIMES) ) {
02838             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02839         }
02840 
02841         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02842                 ThreadHandle,
02843                 THREAD_QUERY_INFORMATION,
02844                 PsThreadType,
02845                 PreviousMode,
02846                 (PVOID *)&amp;Thread,
02847                 NULL
02848                 );
02849 
02850         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02851             <span class="keywordflow">return</span> st;
02852         }
02853 
02854         SysUserTime.KernelTime.QuadPart = UInt32x32To64(Thread-&gt;Tcb.KernelTime,
02855                                                         KeMaximumIncrement);
02856 
02857         SysUserTime.UserTime.QuadPart = UInt32x32To64(Thread-&gt;Tcb.UserTime,
02858                                                       KeMaximumIncrement);
02859 
02860         SysUserTime.CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a>(Thread);
02861         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/thredobj_8c.html#a13">KeReadStateThread</a>(&amp;Thread-&gt;Tcb)) {
02862             SysUserTime.ExitTime = Thread-&gt;ExitTime;
02863         } <span class="keywordflow">else</span> {
02864             SysUserTime.ExitTime.QuadPart = 0;
02865         }
02866         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
02867 
02868         <span class="comment">//</span>
02869         <span class="comment">// Either of these may cause an access violation. The</span>
02870         <span class="comment">// exception handler will return access violation as</span>
02871         <span class="comment">// status code. No further cleanup needs to be done.</span>
02872         <span class="comment">//</span>
02873 
02874         <span class="keywordflow">try</span> {
02875             *(PKERNEL_USER_TIMES) ThreadInformation = SysUserTime;
02876 
02877             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
02878                 *ReturnLength = <span class="keyword">sizeof</span>(KERNEL_USER_TIMES);
02879             }
02880         } except(EXCEPTION_EXECUTE_HANDLER) {
02881             <span class="keywordflow">return</span> STATUS_SUCCESS;
02882         }
02883 
02884         <span class="keywordflow">return</span> STATUS_SUCCESS;
02885 
02886     <span class="keywordflow">case</span> ThreadDescriptorTableEntry :
02887 
02888         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02889                 ThreadHandle,
02890                 THREAD_QUERY_INFORMATION,
02891                 PsThreadType,
02892                 PreviousMode,
02893                 (PVOID *)&amp;Thread,
02894                 NULL
02895                 );
02896 
02897         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02898             <span class="keywordflow">return</span> st;
02899         }
02900 
02901         st = <a class="code" href="../../d8/d1/psp_8h.html#a88">PspQueryDescriptorThread</a>( Thread,
02902             ThreadInformation,
02903             ThreadInformationLength,
02904             ReturnLength
02905             );
02906 
02907         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
02908 
02909         <span class="keywordflow">return</span> st;
02910 
02911     <span class="keywordflow">case</span> ThreadQuerySetWin32StartAddress:
02912         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
02913             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02914         }
02915 
02916         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02917                 ThreadHandle,
02918                 THREAD_QUERY_INFORMATION,
02919                 PsThreadType,
02920                 PreviousMode,
02921                 (PVOID *)&amp;Thread,
02922                 NULL
02923                 );
02924 
02925         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02926             <span class="keywordflow">return</span> st;
02927         }
02928 
02929         Win32StartAddressValue = Thread-&gt;Win32StartAddress;
02930         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
02931 
02932         <span class="keywordflow">try</span> {
02933             *(PVOID *) ThreadInformation = Win32StartAddressValue;
02934 
02935             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
02936                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG_PTR);
02937             }
02938         } except(EXCEPTION_EXECUTE_HANDLER) {
02939             <span class="keywordflow">return</span> GetExceptionCode();
02940         }
02941 
02942         <span class="keywordflow">return</span> st;
02943 
02944         <span class="comment">//</span>
02945         <span class="comment">// Query thread cycle counter.</span>
02946         <span class="comment">//</span>
02947 
02948     <span class="keywordflow">case</span> ThreadPerformanceCount:
02949         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(LARGE_INTEGER) ) {
02950             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02951         }
02952 
02953         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02954                 ThreadHandle,
02955                 THREAD_QUERY_INFORMATION,
02956                 PsThreadType,
02957                 PreviousMode,
02958                 (PVOID *)&amp;Thread,
02959                 NULL
02960                 );
02961 
02962         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02963             <span class="keywordflow">return</span> st;
02964         }
02965 
02966         PerformanceCount.LowPart = Thread-&gt;PerformanceCountLow;
02967         PerformanceCount.HighPart = Thread-&gt;PerformanceCountHigh;
02968         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
02969 
02970         <span class="keywordflow">try</span> {
02971             *(PLARGE_INTEGER)ThreadInformation = PerformanceCount;
02972 
02973             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
02974                 *ReturnLength = <span class="keyword">sizeof</span>(LARGE_INTEGER);
02975             }
02976         } except(EXCEPTION_EXECUTE_HANDLER) {
02977             <span class="keywordflow">return</span> GetExceptionCode();
02978         }
02979 
02980         <span class="keywordflow">return</span> st;
02981 
02982     <span class="keywordflow">case</span> ThreadAmILastThread:
02983         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
02984             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02985         }
02986 
02987         Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
02988         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
02989 
02990         <span class="keywordflow">if</span> ( (Process-&gt;ThreadListHead.Flink == Process-&gt;ThreadListHead.Blink)
02991              &amp;&amp; (Process-&gt;ThreadListHead.Flink == &amp;Thread-&gt;ThreadListEntry) ) {
02992             LastThread = 1;
02993             }
02994         <span class="keywordflow">else</span> {
02995             LastThread = 0;
02996             }
02997 
02998         <span class="keywordflow">try</span> {
02999             *(PULONG)ThreadInformation = LastThread;
03000 
03001             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
03002                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
03003             }
03004         } except(EXCEPTION_EXECUTE_HANDLER) {
03005             <span class="keywordflow">return</span> GetExceptionCode();
03006         }
03007 
03008         <span class="keywordflow">return</span> STATUS_SUCCESS;
03009 
03010     <span class="keywordflow">case</span> ThreadPriorityBoost:
03011         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
03012             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03013         }
03014 
03015         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03016                 ThreadHandle,
03017                 THREAD_QUERY_INFORMATION,
03018                 PsThreadType,
03019                 PreviousMode,
03020                 (PVOID *)&amp;Thread,
03021                 NULL
03022                 );
03023 
03024         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03025             <span class="keywordflow">return</span> st;
03026         }
03027 
03028         DisableBoost = Thread-&gt;Tcb.DisableBoost ? 1 : 0;
03029 
03030         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03031 
03032         <span class="keywordflow">try</span> {
03033             *(PULONG)ThreadInformation = DisableBoost;
03034 
03035             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
03036                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
03037             }
03038         } except(EXCEPTION_EXECUTE_HANDLER) {
03039             <span class="keywordflow">return</span> GetExceptionCode();
03040         }
03041 
03042         <span class="keywordflow">return</span> st;
03043 
03044     <span class="keywordflow">case</span> ThreadIsIoPending:
03045 
03046         <span class="comment">//</span>
03047         <span class="comment">// NB:  Darryl wanted it pointed out that this is,</span>
03048         <span class="comment">//      of course, transitory information, somewhat</span>
03049         <span class="comment">//      lame, and better handled by tracking the number</span>
03050         <span class="comment">//      of pending io's from usermode.</span>
03051         <span class="comment">//</span>
03052 
03053         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
03054             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03055         }
03056 
03057         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03058                 ThreadHandle,
03059                 THREAD_QUERY_INFORMATION,
03060                 PsThreadType,
03061                 PreviousMode,
03062                 (PVOID *)&amp;Thread,
03063                 NULL
03064                 );
03065 
03066         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03067             <span class="keywordflow">return</span> st;
03068         }
03069 
03070         <span class="comment">//</span>
03071         <span class="comment">// Raise the IRQL so that the IrpList cannot be modified by a completion</span>
03072         <span class="comment">// APC.</span>
03073         <span class="comment">//</span>
03074 
03075         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>( APC_LEVEL, &amp;irql );
03076 
03077         IoPending = !IsListEmpty( &amp;Thread-&gt;IrpList );
03078 
03079         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>( irql );
03080 
03081         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03082 
03083         <span class="keywordflow">try</span> {
03084             *(PULONG)ThreadInformation = IoPending ;
03085 
03086             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
03087                 *ReturnLength = <span class="keyword">sizeof</span>(ULONG);
03088             }
03089         } except(EXCEPTION_EXECUTE_HANDLER) {
03090             <span class="keywordflow">return</span> GetExceptionCode();
03091         }
03092 
03093         <span class="keywordflow">return</span> STATUS_SUCCESS ;
03094 
03095 
03096     <span class="keywordflow">default</span>:
03097         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
03098     }
03099 
03100 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="psquery.c::NtSetInformationProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">1510</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d1/d9/worker_8c.html#a21">C_ASSERT()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00026">DebugPort</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00063">DirectoryHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d2/d5/i386_2iopm_8c-source.html#l00457">Ke386SetIOPL()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02766">KeActiveProcessors</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00459">KeBoostPriorityThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00624">KeReadStateProcess()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01302">KeSetAffinityThread()</a>, <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00223">KeSetAutoAlignmentProcess()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01674">KeSetDisableBoostThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00738">KeSetPriorityProcess()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00050">MAX_WS_CATCH_INDEX</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00041">MEMORY_PRIORITY_BACKGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a90">PsLockReturnTimeout</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a108">PsProcessPriorityBackground</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00081">PspSetLdtInformation()</a>, <a class="el" href="../../d3/d0/alpha_2psldt_8c-source.html#l00053">PspSetLdtSize()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>, <a class="el" href="../../d3/d1/alpha_2psvdm_8c-source.html#l00025">PspSetProcessIoHandlers()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00031">PsWatchEnabled</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00504">SeCheckPrivilegedObject()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01680">SeIncreaseBasePriorityPrivilege</a>, <a class="el" href="../../d1/d3/tokenset_8c-source.html#l00851">SeSetSessionIdToken()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01675">SeTcbPrivilege</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00562">_KTHREAD::Teb</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l00048">WS_CATCH_SIZE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>.
<p>
<pre class="fragment"><div>01519                    :
01520 
01521     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of a process object.
01522 
01523 Arguments:
01524 
01525     ProcessHandle - Supplies a handle to a process object.
01526 
01527     ProcessInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being
01528         set.
01529 
01530     ProcessInformation - Supplies a pointer to a record that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01531         information to set.
01532 
01533     ProcessInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record that contains
01534         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information to set.
01535 
01536 Return Value:
01537 
01538     TBS
01539 
01540 --*/
01541 
01542 {
01543 
01544     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01545     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01546     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01547     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01548     KPRIORITY BasePriority;
01549     ULONG BoostValue;
01550     ULONG DefaultHardErrorMode;
01551     PVOID <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a>;
01552     PVOID ExceptionPort;
01553     HANDLE DebugPortHandle;
01554     BOOLEAN EnableAlignmentFaultFixup;
01555     HANDLE ExceptionPortHandle;
01556     ULONG ProbeAlignment;
01557     HANDLE PrimaryTokenHandle;
01558     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01559     BOOLEAN IsChildToken = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01560     PLIST_ENTRY Next;
01561     UCHAR MemoryPriority;
01562     PROCESS_PRIORITY_CLASS LocalPriorityClass;
01563     PROCESS_FOREGROUND_BACKGROUND LocalForeground;
01564     HANDLE Wx86Info;
01565     KAFFINITY Affinity, AffinityWithMasks;
01566     ULONG_PTR BigAffinity;
01567     ULONG DisableBoost;
01568     BOOLEAN bDisableBoost;
01569     PPROCESS_DEVICEMAP_INFORMATION DeviceMapInfo;
01570     HANDLE <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>;
01571     PROCESS_SESSION_INFORMATION SessionInfo;
01572     ULONG BytesCopied;
01573     PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
01574 
01575     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01576 
01577     <span class="comment">//</span>
01578     <span class="comment">// Get previous processor mode and probe input argument if necessary.</span>
01579     <span class="comment">//</span>
01580 
01581     PreviousMode = KeGetPreviousMode();
01582     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01583 
01584         <span class="keywordflow">if</span> (ProcessInformationClass == ProcessBasePriority) {
01585             ProbeAlignment = <span class="keyword">sizeof</span>(KPRIORITY);
01586 
01587         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessInformationClass == ProcessEnableAlignmentFaultFixup) {
01588             ProbeAlignment = <span class="keyword">sizeof</span>(BOOLEAN);
01589         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessInformationClass == ProcessForegroundInformation) {
01590             ProbeAlignment = <span class="keyword">sizeof</span>(PROCESS_FOREGROUND_BACKGROUND);
01591         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessInformationClass == ProcessPriorityClass) {
01592             ProbeAlignment = <span class="keyword">sizeof</span>(BOOLEAN);
01593         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessInformationClass == ProcessAffinityMask) {
01594             ProbeAlignment = <span class="keyword">sizeof</span> (ULONG_PTR);
01595         } <span class="keywordflow">else</span> {
01596             ProbeAlignment = <span class="keyword">sizeof</span>(ULONG);
01597         }
01598 
01599         <span class="keywordflow">try</span> {
01600             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
01601                 ProcessInformation,
01602                 ProcessInformationLength,
01603                 ProbeAlignment
01604                 );
01605         } except(EXCEPTION_EXECUTE_HANDLER) {
01606             <span class="keywordflow">return</span> GetExceptionCode();
01607         }
01608     }
01609 
01610     <span class="comment">//</span>
01611     <span class="comment">// Check argument validity.</span>
01612     <span class="comment">//</span>
01613 
01614     <span class="keywordflow">switch</span> ( ProcessInformationClass ) {
01615 
01616     <span class="keywordflow">case</span> ProcessWorkingSetWatch:
01617         {
01618         PPAGEFAULT_HISTORY WorkingSetCatcher;
01619 
01620         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01621                 ProcessHandle,
01622                 PROCESS_SET_INFORMATION,
01623                 PsProcessType,
01624                 PreviousMode,
01625                 (PVOID *)&amp;Process,
01626                 NULL
01627                 );
01628 
01629         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01630             <span class="keywordflow">return</span> st;
01631         }
01632 
01633         WorkingSetCatcher = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool,WS_CATCH_SIZE);
01634         <span class="keywordflow">if</span> ( !WorkingSetCatcher ) {
01635             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01636             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01637         }
01638 
01639         <a class="code" href="../../d4/d5/ia64_2trapc_8c.html#a0">PsWatchEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01640         WorkingSetCatcher-&gt;CurrentIndex = 0;
01641         WorkingSetCatcher-&gt;MaxIndex = <a class="code" href="../../d9/d1/psquery_8c.html#a2">MAX_WS_CATCH_INDEX</a>;
01642 
01643         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
01644 
01645         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
01646             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkingSetCatcher);
01647             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
01648             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
01649             }
01650 
01651         <span class="keywordflow">if</span> ( Process-&gt;WorkingSetWatch ) {
01652             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
01653             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(WorkingSetCatcher);
01654             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01655             <span class="keywordflow">return</span> STATUS_PORT_ALREADY_SET;
01656         }
01657 
01658         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;WorkingSetCatcher-&gt;SpinLock);
01659         Process-&gt;WorkingSetWatch = WorkingSetCatcher;
01660 
01661         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
01662 
01663         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01664 
01665         <span class="keywordflow">return</span> STATUS_SUCCESS;
01666         }
01667 
01668     <span class="keywordflow">case</span> ProcessBasePriority:
01669         {
01670 
01671 
01672         <span class="comment">//</span>
01673         <span class="comment">// THIS ITEM CODE IS OBSOLETE !</span>
01674         <span class="comment">//</span>
01675 
01676         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(KPRIORITY) ) {
01677             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01678         }
01679 
01680         <span class="keywordflow">try</span> {
01681             BasePriority = *(KPRIORITY *)ProcessInformation;
01682         } except(EXCEPTION_EXECUTE_HANDLER) {
01683             <span class="keywordflow">return</span> GetExceptionCode();
01684         }
01685 
01686         <span class="keywordflow">if</span> ( BasePriority &amp; 0x80000000 ) {
01687             MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>;
01688             BasePriority &amp;= ~0x80000000;
01689             }
01690         <span class="keywordflow">else</span> {
01691             MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a1">MEMORY_PRIORITY_BACKGROUND</a>;
01692             }
01693 
01694         <span class="keywordflow">if</span> ( BasePriority &gt; HIGH_PRIORITY ||
01695              BasePriority &lt;= LOW_PRIORITY ) {
01696 
01697             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01698         }
01699 
01700         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01701                 ProcessHandle,
01702                 PROCESS_SET_INFORMATION,
01703                 PsProcessType,
01704                 PreviousMode,
01705                 (PVOID *)&amp;Process,
01706                 NULL
01707                 );
01708 
01709         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01710             <span class="keywordflow">return</span> st;
01711         }
01712 
01713 
01714         <span class="keywordflow">if</span> ( BasePriority &gt; Process-&gt;Pcb.BasePriority ) {
01715 
01716             <span class="comment">//</span>
01717             <span class="comment">// Increasing the base priority of a process is a</span>
01718             <span class="comment">// privileged operation.  Check for the privilege</span>
01719             <span class="comment">// here.</span>
01720             <span class="comment">//</span>
01721 
01722             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
01723                                SeIncreaseBasePriorityPrivilege,
01724                                ProcessHandle,
01725                                PROCESS_SET_INFORMATION,
01726                                PreviousMode
01727                                );
01728 
01729             <span class="keywordflow">if</span> (!HasPrivilege) {
01730 
01731                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01732                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
01733             }
01734         }
01735 
01736         <a class="code" href="../../d3/d5/procobj_8c.html#a11">KeSetPriorityProcess</a>(&amp;Process-&gt;Pcb,BasePriority);
01737         <a class="code" href="../../d4/d5/procsup_8c.html#a45">MmSetMemoryPriorityProcess</a>(Process, MemoryPriority);
01738         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01739 
01740         <span class="keywordflow">return</span> STATUS_SUCCESS;
01741         }
01742 
01743     <span class="keywordflow">case</span> ProcessPriorityClass:
01744         {
01745         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(PROCESS_PRIORITY_CLASS) ) {
01746             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01747         }
01748 
01749         <span class="keywordflow">try</span> {
01750             LocalPriorityClass = *(PPROCESS_PRIORITY_CLASS)ProcessInformation;
01751         } except(EXCEPTION_EXECUTE_HANDLER) {
01752             <span class="keywordflow">return</span> GetExceptionCode();
01753         }
01754 
01755         <span class="keywordflow">if</span> ( LocalPriorityClass.PriorityClass &gt; PROCESS_PRIORITY_CLASS_ABOVE_NORMAL ) {
01756             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01757             }
01758 
01759         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01760                 ProcessHandle,
01761                 PROCESS_SET_INFORMATION,
01762                 PsProcessType,
01763                 PreviousMode,
01764                 (PVOID *)&amp;Process,
01765                 NULL
01766                 );
01767 
01768         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01769             <span class="keywordflow">return</span> st;
01770             }
01771 
01772 
01773         <span class="keywordflow">if</span> ( LocalPriorityClass.PriorityClass != Process-&gt;PriorityClass &amp;&amp;
01774              LocalPriorityClass.PriorityClass == PROCESS_PRIORITY_CLASS_REALTIME ) {
01775 
01776             <span class="comment">//</span>
01777             <span class="comment">// Increasing the base priority of a process is a</span>
01778             <span class="comment">// privileged operation.  Check for the privilege</span>
01779             <span class="comment">// here.</span>
01780             <span class="comment">//</span>
01781 
01782             HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
01783                                SeIncreaseBasePriorityPrivilege,
01784                                ProcessHandle,
01785                                PROCESS_SET_INFORMATION,
01786                                PreviousMode
01787                                );
01788 
01789             <span class="keywordflow">if</span> (!HasPrivilege) {
01790 
01791                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01792                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
01793             }
01794         }
01795 
01796         <span class="comment">//</span>
01797         <span class="comment">// If the process has a job object, override whatever the process</span>
01798         <span class="comment">// is calling with with the value from the job object</span>
01799         <span class="comment">//</span>
01800         <span class="keywordflow">if</span> ( Process-&gt;Job ) {
01801             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01802             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;Process-&gt;Job-&gt;JobLock, TRUE);
01803 
01804             <span class="keywordflow">if</span> ( Process-&gt;Job-&gt;LimitFlags &amp; JOB_OBJECT_LIMIT_PRIORITY_CLASS ) {
01805                 LocalPriorityClass.PriorityClass = Process-&gt;Job-&gt;PriorityClass;
01806                 }
01807 
01808             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Process-&gt;Job-&gt;JobLock);
01809             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01810             }
01811 
01812         Process-&gt;PriorityClass = LocalPriorityClass.PriorityClass;
01813 
01814         <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process, LocalPriorityClass.Foreground ?
01815                 PsProcessPriorityForeground : PsProcessPriorityBackground);
01816 
01817         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01818 
01819         <span class="keywordflow">return</span> STATUS_SUCCESS;
01820         }
01821 
01822     <span class="keywordflow">case</span> ProcessForegroundInformation:
01823         {
01824 
01825         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(PROCESS_FOREGROUND_BACKGROUND) ) {
01826             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01827         }
01828 
01829         <span class="keywordflow">try</span> {
01830             LocalForeground = *(PPROCESS_FOREGROUND_BACKGROUND)ProcessInformation;
01831         } except(EXCEPTION_EXECUTE_HANDLER) {
01832             <span class="keywordflow">return</span> GetExceptionCode();
01833         }
01834 
01835         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01836                 ProcessHandle,
01837                 PROCESS_SET_INFORMATION,
01838                 PsProcessType,
01839                 PreviousMode,
01840                 (PVOID *)&amp;Process,
01841                 NULL
01842                 );
01843 
01844         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01845             <span class="keywordflow">return</span> st;
01846             }
01847 
01848 
01849         <a class="code" href="../../d9/d1/psquery_8c.html#a24">PsSetProcessPriorityByClass</a>(Process, LocalForeground.Foreground ?
01850                 PsProcessPriorityForeground : PsProcessPriorityBackground);
01851 
01852         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01853 
01854         <span class="keywordflow">return</span> STATUS_SUCCESS;
01855         }
01856 
01857     <span class="keywordflow">case</span> ProcessRaisePriority:
01858         {
01859         <span class="comment">//</span>
01860         <span class="comment">// This code is used to boost the priority of all threads</span>
01861         <span class="comment">// within a process. It cannot be used to change a thread into</span>
01862         <span class="comment">// a realtime class, or to lower the priority of a thread. The</span>
01863         <span class="comment">// argument is a boost value that is added to the base priority</span>
01864         <span class="comment">// of the specified process.</span>
01865         <span class="comment">//</span>
01866 
01867 
01868         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
01869             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01870         }
01871 
01872         <span class="keywordflow">try</span> {
01873             BoostValue = *(PULONG)ProcessInformation;
01874         } except(EXCEPTION_EXECUTE_HANDLER) {
01875             <span class="keywordflow">return</span> GetExceptionCode();
01876         }
01877 
01878         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01879                 ProcessHandle,
01880                 PROCESS_SET_INFORMATION,
01881                 PsProcessType,
01882                 PreviousMode,
01883                 (PVOID *)&amp;Process,
01884                 NULL
01885                 );
01886 
01887         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01888             <span class="keywordflow">return</span> st;
01889         }
01890 
01891         <span class="comment">//</span>
01892         <span class="comment">// Get the process create/delete lock and walk through the</span>
01893         <span class="comment">// thread list boosting each thread.</span>
01894         <span class="comment">//</span>
01895 
01896 
01897         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,KernelMode,PsLockReturnTimeout);
01898 
01899         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
01900             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
01901             <span class="keywordflow">return</span>( st );
01902         }
01903 
01904         Next = Process-&gt;ThreadListHead.Flink;
01905 
01906         <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
01907             Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
01908             <a class="code" href="../../d9/d1/thredobj_8c.html#a4">KeBoostPriorityThread</a>(&amp;Thread-&gt;Tcb,(KPRIORITY)BoostValue);
01909             Next = Next-&gt;Flink;
01910         }
01911 
01912         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
01913 
01914         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01915 
01916         <span class="keywordflow">return</span> STATUS_SUCCESS;
01917         }
01918 
01919     <span class="keywordflow">case</span> ProcessDefaultHardErrorMode:
01920         {
01921         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
01922             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01923         }
01924 
01925         <span class="keywordflow">try</span> {
01926             DefaultHardErrorMode = *(PULONG)ProcessInformation;
01927         } except(EXCEPTION_EXECUTE_HANDLER) {
01928             <span class="keywordflow">return</span> GetExceptionCode();
01929         }
01930 
01931         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01932                 ProcessHandle,
01933                 PROCESS_SET_INFORMATION,
01934                 PsProcessType,
01935                 PreviousMode,
01936                 (PVOID *)&amp;Process,
01937                 NULL
01938                 );
01939 
01940         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01941             <span class="keywordflow">return</span> st;
01942         }
01943 
01944         Process-&gt;DefaultHardErrorProcessing = DefaultHardErrorMode;
01945         <span class="keywordflow">if</span> (DefaultHardErrorMode &amp; PROCESS_HARDERROR_ALIGNMENT_BIT) {
01946             <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a3">KeSetAutoAlignmentProcess</a>(&amp;Process-&gt;Pcb,TRUE);
01947             }
01948         <span class="keywordflow">else</span> {
01949             <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a3">KeSetAutoAlignmentProcess</a>(&amp;Process-&gt;Pcb,FALSE);
01950             }
01951 
01952         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01953 
01954         <span class="keywordflow">return</span> STATUS_SUCCESS;
01955         }
01956 
01957     <span class="keywordflow">case</span> ProcessQuotaLimits:
01958         {
01959          <span class="keywordflow">return</span> <a class="code" href="../../d9/d1/psquery_8c.html#a16">PspSetQuotaLimits</a>(
01960                     ProcessHandle,
01961                     ProcessInformationClass,
01962                     ProcessInformation,
01963                     ProcessInformationLength,
01964                     PreviousMode
01965                     );
01966         }
01967 
01968     <span class="keywordflow">case</span> ProcessDebugPort :
01969         {
01970         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(HANDLE) ) {
01971             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01972         }
01973 
01974         <span class="keywordflow">try</span> {
01975             DebugPortHandle = *(PHANDLE) ProcessInformation;
01976         } except(EXCEPTION_EXECUTE_HANDLER) {
01977             <span class="keywordflow">return</span> GetExceptionCode();
01978         }
01979 
01980         <span class="keywordflow">if</span> ( DebugPortHandle ) {
01981             st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01982                     DebugPortHandle,
01983                     0,
01984                     LpcPortObjectType,
01985                     PreviousMode,
01986                     (PVOID *)&amp;DebugPort,
01987                     NULL
01988                     );
01989             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01990                 <span class="keywordflow">return</span> st;
01991             }
01992         } <span class="keywordflow">else</span> {
01993             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01994         }
01995 
01996         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01997                 ProcessHandle,
01998                 PROCESS_SET_PORT,
01999                 PsProcessType,
02000                 PreviousMode,
02001                 (PVOID *)&amp;Process,
02002                 NULL
02003                 );
02004 
02005         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02006             <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> ) {
02007                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPort);
02008             }
02009             <span class="keywordflow">return</span> st;
02010         }
02011 
02012 
02013         <span class="comment">//</span>
02014         <span class="comment">// Conditional set Process-&gt;DebugPort</span>
02015         <span class="comment">//</span>
02016 
02017         <span class="keywordflow">if</span> ( InterlockedCompareExchangePointer(&amp;Process-&gt;DebugPort,DebugPort,NULL) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02018 
02019             <span class="keywordflow">if</span> ( (Process-&gt;ExitTime.QuadPart != 0 || <a class="code" href="../../d3/d5/procobj_8c.html#a9">KeReadStateProcess</a>(&amp;Process-&gt;Pcb) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ) {
02020                 <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> = InterlockedExchangePointer(&amp;Process-&gt;DebugPort,NULL);
02021                 <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d7/udbgk_8c.html#a0">DebugPort</a> ) {
02022                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPort);
02023                     }
02024                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02025                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02026                 }
02027             }
02028         <span class="keywordflow">else</span> {
02029             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02030             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DebugPort);
02031             <span class="keywordflow">return</span> STATUS_PORT_ALREADY_SET;
02032             }
02033 
02034         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
02035         <span class="keywordflow">if</span> (Process-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02036             Process-&gt;Peb-&gt;BeingDebugged = (BOOLEAN)(Process-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02037 <span class="preprocessor">#if defined(_WIN64)</span>
02038 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Process-&gt;Wow64Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02039                 PPEB32 Peb32 = (PPEB32)Process-&gt;Wow64Process-&gt;Wow64;
02040                 <span class="keywordflow">if</span> (Peb32 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02041                     Peb32-&gt;BeingDebugged = Process-&gt;Peb-&gt;BeingDebugged;
02042                 }
02043             }
02044 <span class="preprocessor">#endif</span>
02045 <span class="preprocessor"></span>            }
02046         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02047 
02048 
02049         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02050 
02051         <span class="keywordflow">return</span> STATUS_SUCCESS;
02052         }
02053 
02054     <span class="keywordflow">case</span> ProcessExceptionPort :
02055         {
02056         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(HANDLE) ) {
02057             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02058         }
02059 
02060         <span class="keywordflow">try</span> {
02061             ExceptionPortHandle = *(PHANDLE) ProcessInformation;
02062         } except(EXCEPTION_EXECUTE_HANDLER) {
02063             <span class="keywordflow">return</span> GetExceptionCode();
02064         }
02065 
02066         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
02067                 ExceptionPortHandle,
02068                 0,
02069                 LpcPortObjectType,
02070                 PreviousMode,
02071                 (PVOID *)&amp;ExceptionPort,
02072                 NULL
02073                 );
02074         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02075             <span class="keywordflow">return</span> st;
02076         }
02077 
02078         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02079                 ProcessHandle,
02080                 PROCESS_SET_PORT,
02081                 PsProcessType,
02082                 PreviousMode,
02083                 (PVOID *)&amp;Process,
02084                 NULL
02085                 );
02086 
02087         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02088             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExceptionPort);
02089             <span class="keywordflow">return</span> st;
02090         }
02091 
02092         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02093 
02094         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
02095             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExceptionPort);
02096             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02097             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02098             }
02099 
02100         <span class="keywordflow">if</span> ( Process-&gt;ExceptionPort ) {
02101             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02102             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExceptionPort);
02103             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02104             <span class="keywordflow">return</span> STATUS_PORT_ALREADY_SET;
02105         } <span class="keywordflow">else</span> {
02106             Process-&gt;ExceptionPort = ExceptionPort;
02107         }
02108         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02109 
02110         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02111 
02112         <span class="keywordflow">return</span> STATUS_SUCCESS;
02113         }
02114 
02115     <span class="keywordflow">case</span> ProcessAccessToken :
02116         {
02117 
02118         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(PROCESS_ACCESS_TOKEN) ) {
02119             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02120         }
02121 
02122         <span class="keywordflow">try</span> {
02123             PrimaryTokenHandle  = ((PROCESS_ACCESS_TOKEN *)ProcessInformation)-&gt;Token;
02124             <span class="comment">// OnlyThread field of this structure is obsolete.</span>
02125         } except(EXCEPTION_EXECUTE_HANDLER) {
02126             <span class="keywordflow">return</span> GetExceptionCode();
02127         }
02128 
02129 
02130         st = <a class="code" href="../../d9/d1/psquery_8c.html#a17">PspSetPrimaryToken</a>(
02131                     ProcessHandle,
02132                     PrimaryTokenHandle,
02133                     NULL );
02134 
02135         <span class="keywordflow">return</span> st;
02136         }
02137 
02138 
02139     <span class="keywordflow">case</span> ProcessLdtInformation:
02140 
02141         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02142                 ProcessHandle,
02143                 PROCESS_SET_INFORMATION | PROCESS_VM_WRITE,
02144                 PsProcessType,
02145                 PreviousMode,
02146                 (PVOID *)&amp;Process,
02147                 NULL
02148                 );
02149 
02150         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02151             <span class="keywordflow">return</span> st;
02152         }
02153 
02154         <span class="keywordflow">try</span> {
02155             st = <a class="code" href="../../d8/d1/psp_8h.html#a83">PspSetLdtInformation</a>(
02156                     Process,
02157                     ProcessInformation,
02158                     ProcessInformationLength
02159                     );
02160         } except (EXCEPTION_EXECUTE_HANDLER) {
02161             st = STATUS_SUCCESS;
02162         }
02163 
02164         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02165         <span class="keywordflow">return</span> st;
02166 
02167     <span class="keywordflow">case</span> ProcessLdtSize:
02168 
02169         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02170                 ProcessHandle,
02171                 PROCESS_SET_INFORMATION | PROCESS_VM_WRITE,
02172                 PsProcessType,
02173                 PreviousMode,
02174                 (PVOID *)&amp;Process,
02175                 NULL
02176                 );
02177 
02178         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02179             <span class="keywordflow">return</span> st;
02180         }
02181 
02182         <span class="keywordflow">try</span> {
02183 
02184             st = <a class="code" href="../../d8/d1/psp_8h.html#a84">PspSetLdtSize</a>(
02185                     Process,
02186                     ProcessInformation,
02187                     ProcessInformationLength
02188                     );
02189 
02190         } except(EXCEPTION_EXECUTE_HANDLER) {
02191 
02192             st = GetExceptionCode();
02193 
02194         }
02195 
02196         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02197         <span class="keywordflow">return</span> st;
02198 
02199     <span class="keywordflow">case</span> ProcessIoPortHandlers:
02200 
02201         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02202                 ProcessHandle,
02203                 PROCESS_SET_INFORMATION,
02204                 PsProcessType,
02205                 PreviousMode,
02206                 (PVOID *)&amp;Process,
02207                 NULL
02208                 );
02209 
02210         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02211             <span class="keywordflow">return</span> st;
02212         }
02213 
02214         st = <a class="code" href="../../d5/d5/vdmprint_8h.html#a15">PspSetProcessIoHandlers</a>(
02215                 Process,
02216                 ProcessInformation,
02217                 ProcessInformationLength
02218                 );
02219 
02220         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02221         <span class="keywordflow">return</span> st;
02222 
02223     <span class="keywordflow">case</span> ProcessUserModeIOPL:
02224 
02225         <span class="comment">//</span>
02226         <span class="comment">// Must make sure the caller is a trusted subsystem with the</span>
02227         <span class="comment">// appropriate privilege level before executing this call.</span>
02228         <span class="comment">// If the calls returns FALSE we must return an error code.</span>
02229         <span class="comment">//</span>
02230 
02231         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(RtlConvertLongToLuid(
02232                                     SE_TCB_PRIVILEGE),
02233                                     PreviousMode )) {
02234 
02235             <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
02236 
02237         }
02238 
02239         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02240                 ProcessHandle,
02241                 PROCESS_SET_INFORMATION,
02242                 PsProcessType,
02243                 PreviousMode,
02244                 (PVOID *)&amp;Process,
02245                 NULL
02246                 );
02247 
02248         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02249 
02250 <span class="preprocessor">#ifdef i386</span>
02251 <span class="preprocessor"></span>        <a class="code" href="../../d1/d6/i386_2iopm_8c.html#a7">Ke386SetIOPL</a>(&amp;Process-&gt;Pcb);
02252 <span class="preprocessor">#endif</span>
02253 <span class="preprocessor"></span>
02254         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02255         }
02256 
02257         <span class="keywordflow">return</span> st;
02258 
02259         <span class="comment">//</span>
02260         <span class="comment">// Enable/disable auto-alignment fixup for a process and all its threads.</span>
02261         <span class="comment">//</span>
02262 
02263     <span class="keywordflow">case</span> ProcessEnableAlignmentFaultFixup:
02264 
02265         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(BOOLEAN) ) {
02266             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02267         }
02268 
02269         <span class="keywordflow">try</span> {
02270             EnableAlignmentFaultFixup = *(PBOOLEAN)ProcessInformation;
02271 
02272         } except(EXCEPTION_EXECUTE_HANDLER) {
02273             <span class="keywordflow">return</span> GetExceptionCode();
02274         }
02275 
02276         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02277                 ProcessHandle,
02278                 PROCESS_SET_INFORMATION,
02279                 PsProcessType,
02280                 PreviousMode,
02281                 (PVOID *)&amp;Process,
02282                 NULL
02283                 );
02284 
02285         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02286             <span class="keywordflow">return</span> st;
02287         }
02288 
02289         <span class="keywordflow">if</span> ( EnableAlignmentFaultFixup ) {
02290             Process-&gt;DefaultHardErrorProcessing |= PROCESS_HARDERROR_ALIGNMENT_BIT;
02291             }
02292         <span class="keywordflow">else</span> {
02293             Process-&gt;DefaultHardErrorProcessing &amp;= ~PROCESS_HARDERROR_ALIGNMENT_BIT;
02294             }
02295 
02296         <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a3">KeSetAutoAlignmentProcess</a>( &amp;(Process-&gt;Pcb), EnableAlignmentFaultFixup );
02297         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02298         <span class="keywordflow">return</span> STATUS_SUCCESS;
02299 
02300 
02301 <span class="preprocessor">#ifndef i386</span>
02302 <span class="preprocessor"></span>    <span class="keywordflow">case</span> ProcessWx86Information :
02303         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(HANDLE) ) {
02304             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02305             }
02306 
02307         <span class="keywordflow">try</span> {
02308             Wx86Info = *(PHANDLE) ProcessInformation;
02309             }
02310         except(EXCEPTION_EXECUTE_HANDLER) {
02311             <span class="keywordflow">return</span> GetExceptionCode();
02312             }
02313 
02314         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02315                 ProcessHandle,
02316                 PROCESS_SET_INFORMATION,
02317                 PsProcessType,
02318                 PreviousMode,
02319                 (PVOID *)&amp;Process,
02320                 NULL
02321                 );
02322 
02323         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
02324             <span class="keywordflow">return</span> st;
02325             }
02326 
02327         <span class="comment">//</span>
02328         <span class="comment">// If Wx86Info == sizeof(WX86TIB) then process is becoming a wx86 process.</span>
02329         <span class="comment">// If Wx86Info == 0 then process is no longer a Wx86 process.</span>
02330         <span class="comment">//</span>
02331 
02332         <span class="keywordflow">if</span> ((ULONG_PTR)Wx86Info != <span class="keyword">sizeof</span>(WX86TIB)) {
02333             <span class="keywordflow">if</span> ((ULONG_PTR)Wx86Info != 0 || Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()) {
02334                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02335                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02336                 }
02337 
02338             Wx86Info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02339             }
02340 
02341 
02342         Process-&gt;VdmObjects = Wx86Info;
02343 
02344         <span class="comment">//</span>
02345         <span class="comment">// Clean out all of the x86 stacks, this allows dynamic wx86</span>
02346         <span class="comment">// to operate with less memory when wx86 is not loaded.</span>
02347         <span class="comment">//</span>
02348 
02349         <span class="keywordflow">if</span> (Wx86Info == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02350             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> xst;
02351             PTEB Teb;
02352             PLIST_ENTRY Next;
02353             PWX86TIB Wx86Tib;
02354             PVOID BaseAddress;
02355             SIZE_T StackSize;
02356 
02357             st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02358             <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
02359                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02360                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02361                 }
02362 
02363             Next = Process-&gt;ThreadListHead.Flink;
02364 
02365             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
02366 
02367                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
02368                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
02369                     <span class="keywordflow">if</span> ( Thread-&gt;Tcb.Teb ) {
02370                         Teb = (PTEB)Thread-&gt;Tcb.Teb;
02371                         <span class="keywordflow">try</span> {
02372                            Wx86Tib = Teb-&gt;Vdm;
02373                            Teb-&gt;Vdm = 0;
02374                            <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Wx86Tib, <span class="keyword">sizeof</span>(WX86TIB), <span class="keyword">sizeof</span>(ULONG));
02375                            <span class="keywordflow">if</span> (Wx86Tib &amp;&amp; Wx86Tib-&gt;Size == <span class="keyword">sizeof</span>(WX86TIB)) {
02376                                StackSize = 0;
02377                                BaseAddress = Wx86Tib-&gt;DeallocationStack;
02378                                ZwFreeVirtualMemory(ProcessHandle,
02379                                                    &amp;BaseAddress,
02380                                                    &amp;StackSize,
02381                                                    MEM_RELEASE
02382                                                    );
02383 
02384                                <span class="keywordflow">if</span> (Teb-&gt;Wx86Thread.DeallocationCpu) {
02385                                    BaseAddress = Teb-&gt;Wx86Thread.DeallocationCpu;
02386                                    Teb-&gt;Wx86Thread.DeallocationCpu = 0;
02387                                    StackSize = 0;
02388                                    st = ZwFreeVirtualMemory(ProcessHandle,
02389                                                             &amp;BaseAddress,
02390                                                             &amp;StackSize,
02391                                                             MEM_RELEASE
02392                                                             );
02393                                    }
02394                                }
02395                            }
02396                         except(EXCEPTION_EXECUTE_HANDLER) {
02397                            ;
02398                            }
02399                         }
02400                     }
02401                 Next = Next-&gt;Flink;
02402                 }
02403 
02404             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02405             }
02406 
02407         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02408         <span class="keywordflow">return</span> STATUS_SUCCESS;
02409 <span class="preprocessor">#endif</span>
02410 <span class="preprocessor"></span>
02411     <span class="keywordflow">case</span> ProcessAffinityMask:
02412 
02413 <span class="preprocessor">#ifdef _WIN64</span>
02414 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
02415             <span class="comment">//</span>
02416             <span class="comment">// Remove this ifdef when KAFFINITY is made 64 bits.</span>
02417             <span class="comment">//</span>
02418 
02419             <a class="code" href="../../d1/d9/worker_8c.html#a21">C_ASSERT</a>(<span class="keyword">sizeof</span>(KAFFINITY) != <span class="keyword">sizeof</span>(ULONG_PTR) );
02420             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02421             }
02422 <span class="preprocessor">#else</span>
02423 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(KAFFINITY) ) {
02424             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02425             }
02426 <span class="preprocessor">#endif</span>
02427 <span class="preprocessor"></span>
02428         <span class="keywordflow">try</span> {
02429             BigAffinity = *(PULONG_PTR)ProcessInformation;
02430             Affinity = (KAFFINITY)BigAffinity;
02431 
02432             }
02433         except(EXCEPTION_EXECUTE_HANDLER) {
02434             <span class="keywordflow">return</span> GetExceptionCode();
02435             }
02436 
02437         AffinityWithMasks = Affinity &amp; <a class="code" href="../../d4/d9/ke_8h.html#a123">KeActiveProcessors</a>;
02438 
02439         <span class="keywordflow">if</span> ( !Affinity || ( AffinityWithMasks != Affinity ) ) {
02440             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
02441             }
02442 
02443         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02444                 ProcessHandle,
02445                 PROCESS_SET_INFORMATION,
02446                 PsProcessType,
02447                 PreviousMode,
02448                 (PVOID *)&amp;Process,
02449                 NULL
02450                 );
02451 
02452         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02453             <span class="keywordflow">return</span> st;
02454             }
02455 
02456         <span class="comment">//</span>
02457         <span class="comment">// If the process has a job object, override whatever the process</span>
02458         <span class="comment">// is calling with with the value from the job object</span>
02459         <span class="comment">//</span>
02460         <span class="keywordflow">if</span> ( Process-&gt;Job ) {
02461             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02462             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;Process-&gt;Job-&gt;JobLock, TRUE);
02463 
02464             <span class="keywordflow">if</span> ( Process-&gt;Job-&gt;LimitFlags &amp; JOB_OBJECT_LIMIT_AFFINITY ) {
02465                 AffinityWithMasks = Process-&gt;Job-&gt;Affinity;
02466                 }
02467 
02468             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Process-&gt;Job-&gt;JobLock);
02469             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02470             }
02471 
02472 
02473         {
02474             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> xst;
02475             PLIST_ENTRY Next;
02476             <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OriginalThread;
02477 
02478             <span class="comment">//</span>
02479             <span class="comment">// the following allows this api to properly if</span>
02480             <span class="comment">// called while the exiting process is blocked holding the</span>
02481             <span class="comment">// createdeletelock. This can happen during debugger/server</span>
02482             <span class="comment">// lpc transactions that occur in pspexitthread</span>
02483             <span class="comment">//</span>
02484 
02485             xst = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02486 
02487             <span class="keywordflow">if</span> ( xst != STATUS_SUCCESS ) {
02488                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02489                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02490                 }
02491 
02492             Process-&gt;Pcb.Affinity = AffinityWithMasks;
02493 
02494             Next = Process-&gt;ThreadListHead.Flink;
02495 
02496             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
02497 
02498                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
02499                 <a class="code" href="../../d9/d1/thredobj_8c.html#a18">KeSetAffinityThread</a>(&amp;Thread-&gt;Tcb,AffinityWithMasks);
02500                 Next = Next-&gt;Flink;
02501                 }
02502 
02503             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02504         }
02505         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02506         <span class="keywordflow">return</span> STATUS_SUCCESS;
02507 
02508     <span class="keywordflow">case</span> ProcessPriorityBoost:
02509         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
02510             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02511         }
02512 
02513         <span class="keywordflow">try</span> {
02514             DisableBoost = *(PULONG)ProcessInformation;
02515         } except(EXCEPTION_EXECUTE_HANDLER) {
02516             <span class="keywordflow">return</span> GetExceptionCode();
02517         }
02518 
02519         bDisableBoost = (DisableBoost ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02520 
02521         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02522                 ProcessHandle,
02523                 PROCESS_SET_INFORMATION,
02524                 PsProcessType,
02525                 PreviousMode,
02526                 (PVOID *)&amp;Process,
02527                 NULL
02528                 );
02529 
02530         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02531             <span class="keywordflow">return</span> st;
02532             }
02533 
02534         {
02535             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> xst;
02536             PLIST_ENTRY Next;
02537             <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OriginalThread;
02538 
02539             <span class="comment">//</span>
02540             <span class="comment">// the following allows this api to properly if</span>
02541             <span class="comment">// called while the exiting process is blocked holding the</span>
02542             <span class="comment">// createdeletelock. This can happen during debugger/server</span>
02543             <span class="comment">// lpc transactions that occur in pspexitthread</span>
02544             <span class="comment">//</span>
02545 
02546             xst = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02547 
02548             <span class="keywordflow">if</span> ( xst != STATUS_SUCCESS ) {
02549                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02550                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02551                 }
02552 
02553             Process-&gt;Pcb.DisableBoost = bDisableBoost;
02554 
02555             Next = Process-&gt;ThreadListHead.Flink;
02556 
02557             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
02558 
02559                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
02560                 <a class="code" href="../../d9/d1/thredobj_8c.html#a21">KeSetDisableBoostThread</a>(&amp;Thread-&gt;Tcb,bDisableBoost);
02561                 Next = Next-&gt;Flink;
02562                 }
02563 
02564             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02565         }
02566         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02567         <span class="keywordflow">return</span> STATUS_SUCCESS;
02568 
02569     <span class="keywordflow">case</span> ProcessDeviceMap:
02570         DeviceMapInfo = (PPROCESS_DEVICEMAP_INFORMATION)ProcessInformation;
02571         <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(DeviceMapInfo-&gt;Set) ) {
02572             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02573         }
02574 
02575         <span class="keywordflow">try</span> {
02576             <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> = DeviceMapInfo-&gt;Set.DirectoryHandle;
02577         } except(EXCEPTION_EXECUTE_HANDLER) {
02578             <span class="keywordflow">return</span> GetExceptionCode();
02579         }
02580 
02581         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02582                 ProcessHandle,
02583                 PROCESS_SET_INFORMATION,
02584                 PsProcessType,
02585                 PreviousMode,
02586                 (PVOID *)&amp;Process,
02587                 NULL
02588                 );
02589 
02590         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02591             <span class="keywordflow">return</span> st;
02592             }
02593 
02594         <span class="comment">//</span>
02595         <span class="comment">// the following allows this api to properly if</span>
02596         <span class="comment">// called while the exiting process is blocked holding the</span>
02597         <span class="comment">// createdeletelock. This can happen during debugger/server</span>
02598         <span class="comment">// lpc transactions that occur in pspexitthread</span>
02599         <span class="comment">//</span>
02600 
02601         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02602 
02603         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
02604             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
02605             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02606             }
02607 
02608         st = <a class="code" href="../../d7/d0/obdevmap_8c.html#a0">ObSetDeviceMap</a>( Process, DirectoryHandle );
02609         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02610         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02611         <span class="keywordflow">return</span> st;
02612 
02613     <span class="keywordflow">case</span> ProcessSessionInformation :
02614 
02615         <span class="comment">//</span>
02616         <span class="comment">// Update Multi-User session specific process information</span>
02617         <span class="comment">//</span>
02618         <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(PROCESS_SESSION_INFORMATION) ) {
02619             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
02620         }
02621 
02622         <span class="keywordflow">try</span> {
02623             SessionInfo = *(PPROCESS_SESSION_INFORMATION) ProcessInformation;
02624         } except(EXCEPTION_EXECUTE_HANDLER) {
02625             <span class="keywordflow">return</span> GetExceptionCode();
02626         }
02627 
02628         <span class="comment">//</span>
02629         <span class="comment">// We only allow TCB to set SessionId's</span>
02630         <span class="comment">//</span>
02631         <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeTcbPrivilege,PreviousMode) ) {
02632             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
02633         }
02634 
02635         <span class="comment">//</span>
02636         <span class="comment">// Reference process object</span>
02637         <span class="comment">//</span>
02638         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
02639                 ProcessHandle,
02640                 PROCESS_SET_INFORMATION | PROCESS_SET_SESSIONID,
02641                 PsProcessType,
02642                 PreviousMode,
02643                 (PVOID *)&amp;Process,
02644                 NULL
02645                 );
02646         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
02647             <span class="keywordflow">return</span> st;
02648         }
02649 
02650 
02651 
02652         <span class="comment">//</span>
02653         <span class="comment">// Update SessionId in the Token</span>
02654         <span class="comment">//</span>
02655 
02656         <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( Process );
02657         <a class="code" href="../../d0/d4/tokenset_8c.html#a5">SeSetSessionIdToken</a>( Token, SessionInfo.SessionId );
02658         <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
02659 
02660 
02661 
02662         <span class="comment">//</span>
02663         <span class="comment">// Update process SessionId</span>
02664         <span class="comment">//</span>
02665         Process-&gt;SessionId = SessionInfo.SessionId;
02666 
02667 
02668         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
02669 
02670         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
02671             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02672             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
02673             }
02674 
02675         <span class="comment">//</span>
02676         <span class="comment">// Check if the Peb is NULL . System processes don't have a PEB</span>
02677         <span class="comment">//</span>
02678         <span class="keywordflow">if</span> (Process-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02679 
02680 
02681             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
02682 
02683             <span class="comment">//</span>
02684             <span class="comment">// Update SessionId in PEB</span>
02685             <span class="comment">//</span>
02686 
02687             Process-&gt;Peb-&gt;SessionId = Process-&gt;SessionId;
02688 
02689             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02690 
02691         }
02692 
02693         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
02694         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
02695 
02696         <span class="keywordflow">return</span>( st );
02697 
02698     <span class="keywordflow">default</span>:
02699         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
02700     }
02701 
02702 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="psquery.c::NtSetInformationThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetInformationThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN THREADINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">3103</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00766">_KPROCESS::Affinity</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00057">ExpDefaultErrorPortProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00639">IS_SYSTEM_THREAD</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00285">_EPROCESS::Job</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01302">KeSetAffinityThread()</a>, <a class="el" href="../../d9/d0/ppc_2thredini_8c-source.html#l00284">KeSetAutoAlignmentThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01532">KeSetBasePriorityThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01674">KeSetDisableBoostThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01735">KeSetIdealProcessorThread()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l01838">KeSetPriorityThread()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00512">_EJOB::LimitFlags</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l01420">MAXIMUM_PROCESSORS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d5/d8/ex_8h.html#a95">PEEVENT_PAIR</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00276">_EPROCESS::PriorityClass</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01326">ProbeAndReadLong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01829">ProbeAndWriteLong</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01483">PsAssignImpersonationToken()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01966">PsLockProcess()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00089">PsThreadType</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l02250">PsUnlockProcess()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00504">SeCheckPrivilegedObject()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01680">SeIncreaseBasePriorityPrivilege</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00138">ThreadHandle</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00307">_EPROCESS::ThreadListHead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00295">_EPROCESS::Wow64Process</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00299">CreateDAclToken()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l00881">NotificationThread()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">RtlImpersonateSelf()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00647">SepServerRevertToSelf()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00504">W32WinStationDoConnect()</a>, and <a class="el" href="../../d3/d7/api_8c-source.html#l00212">WinStationAPIInit()</a>.
<p>
<pre class="fragment"><div>03112                    :
03113 
03114     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of a thread object.
03115 
03116 Arguments:
03117 
03118     <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> - Supplies a handle to a thread object.
03119 
03120     ThreadInformationClass - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">class </span>of information being
03121         set.
03122 
03123     ThreadInformation - Supplies a pointer to a record that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03124         information to set.
03125 
03126     ThreadInformationLength - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> record that contains
03127         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information to set.
03128 
03129 Return Value:
03130 
03131     TBS
03132 
03133 --*/
03134 
03135 {
03136     <a class="code" href="../../d0/d2/struct__EEVENT__PAIR.html">PEEVENT_PAIR</a> EventPair;
03137     HANDLE EventPairHandle;
03138     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
03139     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
03141     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
03142     KAFFINITY Affinity, AffinityWithMasks;
03143     ULONG_PTR BigAffinity;
03144     KPRIORITY Priority;
03145     LONG BasePriority;
03146     ULONG TlsIndex;
03147     PVOID TlsArrayAddress;
03148     PVOID Win32StartAddressValue;
03149     ULONG ProbeAlignment;
03150     BOOLEAN EnableAlignmentFaultFixup;
03151     ULONG IdealProcessor;
03152     ULONG DisableBoost;
03153     PVOID *ExpansionSlots;
03154     HANDLE ImpersonationTokenHandle;
03155     BOOLEAN HasPrivilege;
03156 
03157     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03158 
03159     <span class="comment">//</span>
03160     <span class="comment">// Get previous processor mode and probe input argument if necessary.</span>
03161     <span class="comment">//</span>
03162 
03163     PreviousMode = KeGetPreviousMode();
03164     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
03165         <span class="keywordflow">try</span> {
03166 
03167             <span class="keywordflow">switch</span> (ThreadInformationClass) {
03168 
03169             <span class="keywordflow">case</span> ThreadPriority :
03170                 ProbeAlignment = <span class="keyword">sizeof</span>(KPRIORITY);
03171                 <span class="keywordflow">break</span>;
03172             <span class="keywordflow">case</span> ThreadAffinityMask :
03173             <span class="keywordflow">case</span> ThreadQuerySetWin32StartAddress :
03174                 ProbeAlignment = <span class="keyword">sizeof</span> (ULONG_PTR);
03175                 <span class="keywordflow">break</span>;
03176             <span class="keywordflow">case</span> ThreadEnableAlignmentFaultFixup :
03177                 ProbeAlignment = <span class="keyword">sizeof</span> (BOOLEAN);
03178                 <span class="keywordflow">break</span>;
03179             <span class="keywordflow">default</span> :
03180                 ProbeAlignment = <span class="keyword">sizeof</span>(ULONG);
03181             }
03182 
03183             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(
03184                 ThreadInformation,
03185                 ThreadInformationLength,
03186                 ProbeAlignment
03187                 );
03188         } except(EXCEPTION_EXECUTE_HANDLER) {
03189             <span class="keywordflow">return</span> GetExceptionCode();
03190         }
03191     }
03192 
03193     <span class="comment">//</span>
03194     <span class="comment">// Check argument validity.</span>
03195     <span class="comment">//</span>
03196 
03197     <span class="keywordflow">switch</span> ( ThreadInformationClass ) {
03198 
03199     <span class="keywordflow">case</span> ThreadPriority:
03200 
03201         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(KPRIORITY) ) {
03202             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03203         }
03204 
03205         <span class="keywordflow">try</span> {
03206             Priority = *(KPRIORITY *)ThreadInformation;
03207         } except(EXCEPTION_EXECUTE_HANDLER) {
03208             <span class="keywordflow">return</span> GetExceptionCode();
03209         }
03210 
03211         <span class="keywordflow">if</span> ( Priority &gt; HIGH_PRIORITY ||
03212              Priority &lt;= LOW_PRIORITY ) {
03213 
03214             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03215         }
03216 
03217         <span class="keywordflow">if</span> ( Priority &gt;= LOW_REALTIME_PRIORITY ) {
03218 
03219           <span class="comment">//</span>
03220           <span class="comment">// Increasing the priority of a thread beyond</span>
03221           <span class="comment">// LOW_REALTIME_PRIORITY is a privileged operation.</span>
03222           <span class="comment">//</span>
03223 
03224           HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
03225             SeIncreaseBasePriorityPrivilege,
03226             ThreadHandle,
03227             THREAD_SET_INFORMATION,
03228             PreviousMode
03229             );
03230 
03231           <span class="keywordflow">if</span> (!HasPrivilege) {
03232             <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
03233           }
03234         }
03235 
03236         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03237                 ThreadHandle,
03238                 THREAD_SET_INFORMATION,
03239                 PsThreadType,
03240                 PreviousMode,
03241                 (PVOID *)&amp;Thread,
03242                 NULL
03243                 );
03244 
03245         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03246             <span class="keywordflow">return</span> st;
03247         }
03248 
03249         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
03250 
03251         <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a>(&amp;Thread-&gt;Tcb,Priority);
03252 
03253         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03254 
03255         <span class="keywordflow">return</span> STATUS_SUCCESS;
03256 
03257     <span class="keywordflow">case</span> ThreadBasePriority:
03258 
03259         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(LONG) ) {
03260             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03261         }
03262 
03263         <span class="keywordflow">try</span> {
03264             BasePriority = *(PLONG)ThreadInformation;
03265         } except(EXCEPTION_EXECUTE_HANDLER) {
03266             <span class="keywordflow">return</span> GetExceptionCode();
03267         }
03268 
03269         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03270                 ThreadHandle,
03271                 THREAD_SET_INFORMATION,
03272                 PsThreadType,
03273                 PreviousMode,
03274                 (PVOID *)&amp;Thread,
03275                 NULL
03276                 );
03277 
03278         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03279             <span class="keywordflow">return</span> st;
03280         }
03281         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
03282 
03283 
03284         <span class="keywordflow">if</span> ( BasePriority &gt; THREAD_BASE_PRIORITY_MAX ||
03285              BasePriority &lt; THREAD_BASE_PRIORITY_MIN ) {
03286             <span class="keywordflow">if</span> ( BasePriority == THREAD_BASE_PRIORITY_LOWRT+1 ||
03287                  BasePriority == THREAD_BASE_PRIORITY_IDLE-1 ) {
03288                 ;
03289                 }
03290             <span class="keywordflow">else</span> {
03291 
03292                 <span class="comment">//</span>
03293                 <span class="comment">// Allow csrss, or realtime processes to select any</span>
03294                 <span class="comment">// priority</span>
03295                 <span class="comment">//</span>
03296 
03297                 <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() == <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a> ||
03298                      Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o68">PriorityClass</a> == PROCESS_PRIORITY_CLASS_REALTIME ){
03299                     ;
03300                     }
03301                 <span class="keywordflow">else</span> {
03302                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03303                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03304                     }
03305                 }
03306             }
03307 
03308         <span class="comment">//</span>
03309         <span class="comment">// If the thread is running within a job object, and the job</span>
03310         <span class="comment">// object has a priority class limit, do not allow</span>
03311         <span class="comment">// priority adjustments that raise the thread's priority, unless</span>
03312         <span class="comment">// the priority class is realtime</span>
03313         <span class="comment">//</span>
03314 
03315         <span class="keywordflow">if</span> ( Process-&gt;Job &amp;&amp; (Process-&gt;Job-&gt;LimitFlags &amp; JOB_OBJECT_LIMIT_PRIORITY_CLASS) ) {
03316             <span class="keywordflow">if</span> ( Process-&gt;PriorityClass != PROCESS_PRIORITY_CLASS_REALTIME ){
03317                 <span class="keywordflow">if</span> ( BasePriority &gt; 0 ) {
03318                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03319                     <span class="keywordflow">return</span> STATUS_SUCCESS;
03320                     }
03321                 }
03322             }
03323 
03324         <a class="code" href="../../d9/d1/thredobj_8c.html#a20">KeSetBasePriorityThread</a>(&amp;Thread-&gt;Tcb,BasePriority);
03325 
03326         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03327 
03328         <span class="keywordflow">return</span> STATUS_SUCCESS;
03329 
03330     <span class="keywordflow">case</span> ThreadEnableAlignmentFaultFixup:
03331 
03332         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(BOOLEAN) ) {
03333             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03334         }
03335 
03336         <span class="keywordflow">try</span> {
03337             EnableAlignmentFaultFixup = *(PBOOLEAN)ThreadInformation;
03338         } except(EXCEPTION_EXECUTE_HANDLER) {
03339             <span class="keywordflow">return</span> GetExceptionCode();
03340         }
03341 
03342         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03343                 ThreadHandle,
03344                 THREAD_SET_INFORMATION,
03345                 PsThreadType,
03346                 PreviousMode,
03347                 (PVOID *)&amp;Thread,
03348                 NULL
03349                 );
03350 
03351         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03352             <span class="keywordflow">return</span> st;
03353         }
03354 
03355         <a class="code" href="../../d8/d1/ppc_2thredini_8c.html#a4">KeSetAutoAlignmentThread</a>( &amp;(Thread-&gt;Tcb), EnableAlignmentFaultFixup );
03356 
03357         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03358 
03359         <span class="keywordflow">return</span> STATUS_SUCCESS;
03360 
03361     <span class="keywordflow">case</span> ThreadAffinityMask:
03362 
03363         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
03364             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03365         }
03366 
03367         <span class="keywordflow">try</span> {
03368             BigAffinity = *(ULONG_PTR *) ThreadInformation;
03369             Affinity = (KAFFINITY) BigAffinity;
03370         } except(EXCEPTION_EXECUTE_HANDLER) {
03371             <span class="keywordflow">return</span> GetExceptionCode();
03372         }
03373 
03374         <span class="keywordflow">if</span> ( !Affinity ) {
03375 
03376             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03377 
03378         }
03379 
03380         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03381                 ThreadHandle,
03382                 THREAD_SET_INFORMATION,
03383                 PsThreadType,
03384                 PreviousMode,
03385                 (PVOID *)&amp;Thread,
03386                 NULL
03387                 );
03388 
03389         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03390             <span class="keywordflow">return</span> st;
03391         }
03392 
03393         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
03394 
03395         <span class="comment">//</span>
03396         <span class="comment">// the following allows this api to properly if</span>
03397         <span class="comment">// called while the exiting process is blocked holding the</span>
03398         <span class="comment">// createdeletelock. This can happen during debugger/server</span>
03399         <span class="comment">// lpc transactions that occur in pspexitthread</span>
03400         <span class="comment">//</span>
03401 
03402         st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
03403 
03404         <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
03405             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03406             <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
03407             }
03408 
03409         AffinityWithMasks = Affinity &amp; Process-&gt;Pcb.Affinity;
03410 
03411         <span class="keywordflow">if</span> ( AffinityWithMasks != Affinity ) {
03412 
03413             st = STATUS_INVALID_PARAMETER;
03414 
03415         } <span class="keywordflow">else</span> {
03416 
03417             <a class="code" href="../../d9/d1/thredobj_8c.html#a18">KeSetAffinityThread</a>(
03418                 &amp;Thread-&gt;Tcb,
03419                 AffinityWithMasks
03420                 );
03421             st = STATUS_SUCCESS;
03422         }
03423 
03424         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
03425 
03426         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03427 
03428         <span class="keywordflow">return</span> st;
03429 
03430     <span class="keywordflow">case</span> ThreadImpersonationToken:
03431 
03432 
03433         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(HANDLE) ) {
03434             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03435         }
03436 
03437 
03438         <span class="keywordflow">try</span> {
03439             ImpersonationTokenHandle = *(PHANDLE) ThreadInformation;
03440         } except(EXCEPTION_EXECUTE_HANDLER) {
03441             <span class="keywordflow">return</span> GetExceptionCode();
03442         }
03443 
03444 
03445         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03446                 ThreadHandle,
03447                 THREAD_SET_THREAD_TOKEN,
03448                 PsThreadType,
03449                 PreviousMode,
03450                 (PVOID *)&amp;Thread,
03451                 NULL
03452                 );
03453 
03454         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03455             <span class="keywordflow">return</span> st;
03456         }
03457 
03458         <span class="comment">//</span>
03459         <span class="comment">// Check for proper access to (and type of) the token, and assign</span>
03460         <span class="comment">// it as the thread's impersonation token.</span>
03461         <span class="comment">//</span>
03462 
03463         st = <a class="code" href="../../d6/d5/ps_2security_8c.html#a15">PsAssignImpersonationToken</a>( Thread, ImpersonationTokenHandle );
03464 
03465 
03466         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03467 
03468         <span class="keywordflow">return</span> st;
03469 
03470     <span class="keywordflow">case</span> ThreadQuerySetWin32StartAddress:
03471         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG_PTR) ) {
03472             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03473         }
03474 
03475 
03476         <span class="keywordflow">try</span> {
03477             Win32StartAddressValue = *(PVOID *) ThreadInformation;
03478         } except(EXCEPTION_EXECUTE_HANDLER) {
03479             <span class="keywordflow">return</span> GetExceptionCode();
03480         }
03481 
03482 
03483         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03484                 ThreadHandle,
03485                 THREAD_SET_INFORMATION,
03486                 PsThreadType,
03487                 PreviousMode,
03488                 (PVOID *)&amp;Thread,
03489                 NULL
03490                 );
03491 
03492         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03493             <span class="keywordflow">return</span> st;
03494         }
03495 
03496         Thread-&gt;Win32StartAddress = (PVOID)Win32StartAddressValue;
03497         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03498 
03499         <span class="keywordflow">return</span> st;
03500 
03501 
03502     <span class="keywordflow">case</span> ThreadIdealProcessor:
03503 
03504         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
03505             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03506         }
03507 
03508 
03509         <span class="keywordflow">try</span> {
03510             IdealProcessor = *(PULONG)ThreadInformation;
03511         } except(EXCEPTION_EXECUTE_HANDLER) {
03512             <span class="keywordflow">return</span> GetExceptionCode();
03513         }
03514 
03515         <span class="keywordflow">if</span> ( IdealProcessor &gt; <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a> ) {
03516             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03517             }
03518 
03519         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03520                 ThreadHandle,
03521                 THREAD_SET_INFORMATION,
03522                 PsThreadType,
03523                 PreviousMode,
03524                 (PVOID *)&amp;Thread,
03525                 NULL
03526                 );
03527 
03528         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03529             <span class="keywordflow">return</span> st;
03530         }
03531 
03532         <span class="comment">//</span>
03533         <span class="comment">// this is sort of a slimey way of returning info from this set only</span>
03534         <span class="comment">// api</span>
03535         <span class="comment">//</span>
03536 
03537         st = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)<a class="code" href="../../d9/d1/thredobj_8c.html#a22">KeSetIdealProcessorThread</a>(&amp;Thread-&gt;Tcb,(CCHAR)IdealProcessor);
03538 
03539         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03540 
03541         <span class="keywordflow">return</span> st;
03542 
03543 
03544     <span class="keywordflow">case</span> ThreadPriorityBoost:
03545         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
03546             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03547         }
03548 
03549         <span class="keywordflow">try</span> {
03550             DisableBoost = *(PULONG)ThreadInformation;
03551         } except(EXCEPTION_EXECUTE_HANDLER) {
03552             <span class="keywordflow">return</span> GetExceptionCode();
03553         }
03554 
03555         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03556                 ThreadHandle,
03557                 THREAD_SET_INFORMATION,
03558                 PsThreadType,
03559                 PreviousMode,
03560                 (PVOID *)&amp;Thread,
03561                 NULL
03562                 );
03563 
03564         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03565             <span class="keywordflow">return</span> st;
03566         }
03567 
03568         <a class="code" href="../../d9/d1/thredobj_8c.html#a21">KeSetDisableBoostThread</a>(&amp;Thread-&gt;Tcb,DisableBoost ? TRUE : FALSE);
03569 
03570         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03571 
03572         <span class="keywordflow">return</span> st;
03573 
03574     <span class="keywordflow">case</span> ThreadZeroTlsCell:
03575         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(ULONG) ) {
03576             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03577         }
03578 
03579 
03580         <span class="keywordflow">try</span> {
03581             TlsIndex = *(PULONG) ThreadInformation;
03582         } except(EXCEPTION_EXECUTE_HANDLER) {
03583             <span class="keywordflow">return</span> GetExceptionCode();
03584         }
03585 
03586         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03587                 ThreadHandle,
03588                 THREAD_SET_INFORMATION,
03589                 PsThreadType,
03590                 PreviousMode,
03591                 (PVOID *)&amp;Thread,
03592                 NULL
03593                 );
03594 
03595         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03596             <span class="keywordflow">return</span> st;
03597         }
03598 
03599         <span class="keywordflow">if</span> ( Thread != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() ) {
03600             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Thread );
03601             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03602             }
03603         {
03604             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> xst;
03605             PTEB Teb;
03606             PLIST_ENTRY Next;
03607             <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> OriginalThread;
03608 
03609             OriginalThread = Thread;
03610 
03611             Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
03612 
03613             <span class="comment">//</span>
03614             <span class="comment">// the following allows this api to properly if</span>
03615             <span class="comment">// called while the exiting process is blocked holding the</span>
03616             <span class="comment">// createdeletelock. This can happen during debugger/server</span>
03617             <span class="comment">// lpc transactions that occur in pspexitthread</span>
03618             <span class="comment">//</span>
03619 
03620             xst = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,PreviousMode,PsLockPollOnTimeout);
03621 
03622             <span class="keywordflow">if</span> ( xst != STATUS_SUCCESS ) {
03623                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( OriginalThread );
03624                 <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
03625                 }
03626 
03627             <span class="comment">// The 32bit TEB needs to be set if this is a WOW64 process on a 64BIT system.</span>
03628             <span class="comment">// This code isn't 100% correct since threads have a conversion state where they</span>
03629             <span class="comment">// are chaning from 64 to 32 and they don't have a TEB32 yet.  Fortunatly, the slots</span>
03630             <span class="comment">// will be zero when the thread is created so no damage is done by not clearing it here.</span>
03631 
03632             <span class="comment">// Note that the test for the process type is inside the inner loop. This</span>
03633             <span class="comment">// is bad programming, but this function is hardly time constrained and</span>
03634             <span class="comment">// fixing this with complex macros would not be worth it due to the loss of clairity.</span>
03635 
03636             Next = Process-&gt;ThreadListHead.Flink;
03637 
03638             <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
03639 
03640                 Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
03641                 <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
03642                     <span class="keywordflow">if</span> ( Thread-&gt;Tcb.Teb ) {
03643                         Teb = (PTEB)Thread-&gt;Tcb.Teb;
03644 
03645                         <span class="keywordflow">if</span> ( TlsIndex &gt; TLS_MINIMUM_AVAILABLE-1 ) {
03646                             <span class="keywordflow">if</span> ( TlsIndex &lt; (TLS_MINIMUM_AVAILABLE+TLS_EXPANSION_SLOTS) - 1 ) {
03647                                 <span class="comment">//</span>
03648                                 <span class="comment">// This is an expansion slot, so see if the thread</span>
03649                                 <span class="comment">// has an expansion cell</span>
03650                                 <span class="comment">//</span>
03651                                 <span class="keywordflow">try</span> {
03652 <span class="preprocessor">                                    #if defined(_WIN64)</span>
03653 <span class="preprocessor"></span>                                    <span class="keywordflow">if</span> (Process-&gt;Wow64Process) { <span class="comment">//Wow64 process.</span>
03654                                        PTEB32 Teb32;
03655                                        PLONG ExpansionSlots32;
03656 
03657                                        Teb32 = WOW64_GET_TEB32(Teb); <span class="comment">//No probing needed on regular TEB.</span>
03658                                        <span class="keywordflow">if</span> (Teb32) {
03659                                           ExpansionSlots32 = ULongToPtr(<a class="code" href="../../d5/d8/ex_8h.html#a19">ProbeAndReadLong</a>(&amp;(Teb32-&gt;TlsExpansionSlots)));
03660                                           <span class="keywordflow">if</span> (ExpansionSlots32) {
03661                                              <a class="code" href="../../d5/d8/ex_8h.html#a50">ProbeAndWriteLong</a>(ExpansionSlots32 + TlsIndex - TLS_MINIMUM_AVAILABLE, 0);
03662                                           }
03663                                        }
03664                                     }
03665                                     <span class="keywordflow">else</span>
03666 <span class="preprocessor">                                    #endif</span>
03667 <span class="preprocessor"></span>                                    {
03668                                         ExpansionSlots = Teb-&gt;TlsExpansionSlots;
03669                                         <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExpansionSlots,TLS_EXPANSION_SLOTS*4,8);
03670                                         <span class="keywordflow">if</span> ( ExpansionSlots ) {
03671                                             ExpansionSlots[TlsIndex-TLS_MINIMUM_AVAILABLE] = 0;
03672                                         }
03673 
03674                                     }
03675                                 }
03676                                 except(EXCEPTION_EXECUTE_HANDLER) {
03677                                     ;
03678                                     }
03679                                 }
03680                             }
03681                        <span class="keywordflow">else</span> {
03682                             <span class="keywordflow">try</span> {
03683 <span class="preprocessor">                                #if defined(_WIN64)</span>
03684 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> (Process-&gt;Wow64Process) { <span class="comment">//wow64 process</span>
03685                                    PTEB32 Teb32;
03686 
03687                                    Teb32 = WOW64_GET_TEB32(Teb);  <span class="comment">//No probing needed on regular TEB.</span>
03688                                    <span class="keywordflow">if</span>(Teb32) {
03689                                       <a class="code" href="../../d5/d8/ex_8h.html#a50">ProbeAndWriteLong</a>(Teb32-&gt;TlsSlots + TlsIndex, 0);
03690                                    }
03691                                 }
03692                                 <span class="keywordflow">else</span>
03693 <span class="preprocessor">                                #endif</span>
03694 <span class="preprocessor"></span>                                {
03695                                    Teb-&gt;TlsSlots[TlsIndex] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03696                                 }
03697                             }
03698                             except(EXCEPTION_EXECUTE_HANDLER) {
03699                                 ;
03700                             }
03701                         }
03702 
03703                     }
03704                 }
03705                 Next = Next-&gt;Flink;
03706             }
03707 
03708             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
03709 
03710             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(OriginalThread);
03711 
03712         }
03713         <span class="keywordflow">return</span> st;
03714         <span class="keywordflow">break</span>;
03715 
03716     <span class="keywordflow">case</span> ThreadSetTlsArrayAddress:
03717         <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(PVOID) ) {
03718             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03719         }
03720 
03721 
03722         <span class="keywordflow">try</span> {
03723             TlsArrayAddress = *(PVOID *)ThreadInformation;
03724         } except(EXCEPTION_EXECUTE_HANDLER) {
03725             <span class="keywordflow">return</span> GetExceptionCode();
03726         }
03727 
03728         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03729                 ThreadHandle,
03730                 THREAD_SET_INFORMATION,
03731                 PsThreadType,
03732                 PreviousMode,
03733                 (PVOID *)&amp;Thread,
03734                 NULL
03735                 );
03736 
03737         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03738             <span class="keywordflow">return</span> st;
03739         }
03740 
03741         Thread-&gt;Tcb.TlsArray = TlsArrayAddress;
03742 
03743 <span class="preprocessor">#if defined(_MIPS_)</span>
03744 <span class="preprocessor"></span>
03745         <span class="keywordflow">if</span> (Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
03746             PCR-&gt;TlsArray = TlsArrayAddress;
03747         }
03748 
03749 <span class="preprocessor">#endif</span>
03750 <span class="preprocessor"></span>
03751         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03752 
03753         <span class="keywordflow">return</span> st;
03754         <span class="keywordflow">break</span>;
03755 
03756     <span class="keywordflow">case</span> ThreadHideFromDebugger:
03757         <span class="keywordflow">if</span> ( ThreadInformationLength != 0 ) {
03758             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03759         }
03760 
03761         st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
03762                 ThreadHandle,
03763                 THREAD_SET_INFORMATION,
03764                 PsThreadType,
03765                 PreviousMode,
03766                 (PVOID *)&amp;Thread,
03767                 NULL
03768                 );
03769 
03770         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
03771             <span class="keywordflow">return</span> st;
03772         }
03773 
03774         Thread-&gt;HideFromDebugger = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03775 
03776         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
03777 
03778         <span class="keywordflow">return</span> st;
03779         <span class="keywordflow">break</span>;
03780 
03781     <span class="keywordflow">default</span>:
03782         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
03783     }
03784 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="psquery.c::PsConvertToGuiThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsConvertToGuiThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">3964</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02794">KeServiceDescriptorTable</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02795">KeServiceDescriptorTableShadow</a>, <a class="el" href="../../d4/d9/ke_8h.html#a395">KeSwitchKernelStack()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00641">_KTHREAD::LargeStack</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02450">MmCreateKernelStack()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l02723">MmDeleteKernelStack()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02160">PERFINFO_CONVERT_TO_GUI_THREAD</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00534">PspW32ProcessCallout</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00535">PspW32ThreadCallout</a>, <a class="el" href="../../d1/d9/ps_8h.html#a157a96">PsW32ThreadCalloutInitialize</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00602">_KTHREAD::ServiceTable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00636">_KTHREAD::Win32Thread</a>.
<p>
<pre class="fragment"><div>03970                    :
03971 
03972     This function converts a thread to a GUI thread. This involves giving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03973     thread a larger variable sized stack, and allocating appropriate w32
03974     thread and process objects.
03975 
03976 Arguments:
03977 
03978     None.
03979 
03980 Environment:
03981 
03982     On x86 <span class="keyword">this</span> function needs to build an EBP frame.  The function
03983     <a class="code" href="../../d4/d9/ke_8h.html#a395">KeSwitchKernelStack</a> depends on <span class="keyword">this</span> fact.   The '#pragma optimize
03984     (<span class="stringliteral">"y"</span>,off)' below disables frame pointer omission <span class="keywordflow">for</span> all builds.
03985     Note that <span class="keyword">this</span> modification to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> optimizations being
03986     performed <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> from <span class="keyword">this</span> point in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> source module below.
03987 
03988 Return Value:
03989 
03990     TBD
03991 
03992 --*/
03993 
03994 <span class="preprocessor">#if defined(i386)</span>
03995 <span class="preprocessor"></span><span class="preprocessor">#pragma optimize ("y",off)</span>
03996 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03997 <span class="preprocessor"></span>
03998 {
03999     PVOID NewStack;
04000     PVOID OldStack;
04001     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
04002     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04003     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04004 
04005     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04006 
04007     <span class="keywordflow">if</span> (KeGetPreviousMode() == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
04008         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04009         }
04010 
04011     <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a> ) {
04012         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
04013         }
04014 
04015 
04016     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04017 
04018     <span class="comment">//</span>
04019     <span class="comment">// If the thread is using the shadow service table, then an attempt is</span>
04020     <span class="comment">// being made to convert a thread that has already been converted, or</span>
04021     <span class="comment">// a limit violation has occured on the Win32k system service table.</span>
04022     <span class="comment">//</span>
04023 
04024     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o36">ServiceTable</a> != (PVOID)&amp;<a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[0] ) {
04025         <span class="keywordflow">return</span> STATUS_ALREADY_WIN32;
04026         }
04027 
04028     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04029 
04030     <span class="comment">//</span>
04031     <span class="comment">// Get a larger kernel stack if we haven't already.</span>
04032     <span class="comment">//</span>
04033 
04034     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o52">LargeStack</a> ) {
04035 
04036         NewStack = <a class="code" href="../../d4/d5/procsup_8c.html#a33">MmCreateKernelStack</a>(TRUE);
04037 
04038         <span class="keywordflow">if</span> ( !NewStack ) {
04039 
04040             NtCurrentTeb()-&gt;LastErrorValue = (LONG)ERROR_NOT_ENOUGH_MEMORY;
04041 
04042             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
04043         }
04044 
04045 <span class="preprocessor">#if defined(_IA64_)</span>
04046 <span class="preprocessor"></span>        OldStack = <a class="code" href="../../d4/d9/ke_8h.html#a395">KeSwitchKernelStack</a>(NewStack,
04047                                    (UCHAR *)NewStack - KERNEL_LARGE_STACK_COMMIT,
04048                                    (UCHAR *)NewStack + KERNEL_LARGE_BSTORE_COMMIT);
04049 <span class="preprocessor">#else</span>
04050 <span class="preprocessor"></span>        OldStack = <a class="code" href="../../d4/d9/ke_8h.html#a395">KeSwitchKernelStack</a>(NewStack,
04051                                    (UCHAR *)NewStack - KERNEL_LARGE_STACK_COMMIT);
04052 <span class="preprocessor">#endif // defined(_IA64_)</span>
04053 <span class="preprocessor"></span>
04054         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(OldStack, FALSE);
04055 
04056     }
04057 
04058     <a class="code" href="../../d2/d1/mm_8h.html#a39">PERFINFO_CONVERT_TO_GUI_THREAD</a>(Thread);
04059 
04060     <span class="comment">//</span>
04061     <span class="comment">// We are all clean on the stack, now call out and then link the Win32 structures</span>
04062     <span class="comment">// to the base exec structures</span>
04063     <span class="comment">//</span>
04064 
04065     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a>)(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04066 
04067     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04068         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04069         }
04070 
04071     <span class="comment">//</span>
04072     <span class="comment">// Switch the thread to use the shadow system serive table which will</span>
04073     <span class="comment">// enable it to execute Win32k services.</span>
04074     <span class="comment">//</span>
04075 
04076     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o36">ServiceTable</a> = (PVOID)&amp;<a class="code" href="../../d4/d9/ke_8h.html#a146">KeServiceDescriptorTableShadow</a>[0];
04077 
04078     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a> == 0 );
04079 
04080 
04081     <span class="comment">//</span>
04082     <span class="comment">// Make the thread callout.</span>
04083     <span class="comment">//</span>
04084 
04085     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d8/d1/psp_8h.html#a40">PspW32ThreadCallout</a>)(Thread,<a class="code" href="../../d1/d9/ps_8h.html#a157a96">PsW32ThreadCalloutInitialize</a>);
04086     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
04087         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o36">ServiceTable</a> = (PVOID)&amp;<a class="code" href="../../d4/d9/ke_8h.html#a145">KeServiceDescriptorTable</a>[0];
04088         }
04089 
04090     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04091 
04092 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="psquery.c::PsEstablishWin32Callouts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID PsEstablishWin32Callouts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a170">PKWIN32_GLOBALATOMTABLE_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>GlobalAtomTableCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/ps_8h.html#a86">PKWIN32_POWEREVENT_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PowerEventCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/ps_8h.html#a87">PKWIN32_POWERSTATE_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PowerStateCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>JobCallout</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BatchFlushRoutine</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">3855</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d7/exatom_8c-source.html#l00439">ExGlobalAtomTableCallout</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02772">KeGdiFlushUserBatch</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02275">PGDI_BATCHFLUSH_ROUTINE</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03848">PopEventCallout</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03849">PopStateCallout</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00536">PspW32JobCallout</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00534">PspW32ProcessCallout</a>, and <a class="el" href="../../d9/d0/psp_8h-source.html#l00535">PspW32ThreadCallout</a>.
<p>
<pre class="fragment"><div>03867                    :
03868 
03869     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Win32 kernel mode component to
03870     <span class="keyword">register</span> callout <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> process/thread init/deinit <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a>
03871     and to report <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> sizes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structures.
03872 
03873 Arguments:
03874 
03875     ProcessCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to be called when
03876         a process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either created or deleted.
03877 
03878     ThreadCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to be called when
03879         a thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either created or deleted.
03880 
03881     GlobalAtomTableCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to be called
03882         to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct global atom table <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process
03883 
03884     PowerEventCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function to be called when
03885         a power event occurs.
03886 
03887     PowerStateCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function to be called when
03888         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> power state changes.
03889 
03890     JobCallout - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function to be called when
03891         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> job state changes or a process <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assigned to a job.
03892 
03893     BatchFlushRoutine - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function to be called
03894 
03895 Return Value:
03896 
03897     None.
03898 
03899 --*/
03900 
03901 {
03902     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03903 
03904     <a class="code" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a> = ProcessCallout;
03905     <a class="code" href="../../d8/d1/psp_8h.html#a40">PspW32ThreadCallout</a> = ThreadCallout;
03906     <a class="code" href="../../d6/d8/exatom_8c.html#a0">ExGlobalAtomTableCallout</a> = GlobalAtomTableCallout;
03907     <a class="code" href="../../d4/d9/ke_8h.html#a129">KeGdiFlushUserBatch</a> = (<a class="code" href="../../d4/d9/ke_8h.html#a117">PGDI_BATCHFLUSH_ROUTINE</a>)BatchFlushRoutine;
03908     <a class="code" href="../../d9/d1/psquery_8c.html#a10">PopEventCallout</a> = PowerEventCallout;
03909     <a class="code" href="../../d9/d1/psquery_8c.html#a11">PopStateCallout</a> = PowerStateCallout;
03910     <a class="code" href="../../d8/d1/psp_8h.html#a41">PspW32JobCallout</a> = JobCallout;
03911 <span class="comment">//    PoSetSystemState(ES_SYSTEM_REQUIRED);</span>
03912 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="psquery.c::PspQueryPooledQuotaLimits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryPooledQuotaLimits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">291</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00114">_EPROCESS_QUOTA_BLOCK::PagefileLimit</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00113">_EPROCESS_QUOTA_BLOCK::PagefileUsage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00112">_EPROCESS_QUOTA_BLOCK::PeakPagefileUsage</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00109">_EPROCESS_QUOTA_BLOCK::QuotaPeakPoolUsage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00111">_EPROCESS_QUOTA_BLOCK::QuotaPoolLimit</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00110">_EPROCESS_QUOTA_BLOCK::QuotaPoolUsage</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>.
<p>
<pre class="fragment"><div>00299 {
00300     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00301     KIRQL OldIrql;
00302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00303     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00304     POOLED_USAGE_AND_LIMITS UsageAndLimits;
00305 
00306     <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(POOLED_USAGE_AND_LIMITS) ) {
00307         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00308     }
00309 
00310     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00311             ProcessHandle,
00312             PROCESS_QUERY_INFORMATION,
00313             PsProcessType,
00314             PreviousMode,
00315             (PVOID *)&amp;Process,
00316             NULL
00317             );
00318     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00319         <span class="keywordflow">return</span> st;
00320     }
00321 
00322 
00323     QuotaBlock = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o49">QuotaBlock</a>;
00324 
00325     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00326 
00327     ExAcquireSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00328 
00329     UsageAndLimits.PagedPoolLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00330     UsageAndLimits.NonPagedPoolLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00331     UsageAndLimits.PagefileLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a>;
00332 
00333     UsageAndLimits.PagedPoolUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00334     UsageAndLimits.NonPagedPoolUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00335     UsageAndLimits.PagefileUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a>;
00336 
00337     UsageAndLimits.PeakPagedPoolUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o2">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00338     UsageAndLimits.PeakNonPagedPoolUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o2">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00339     UsageAndLimits.PeakPagefileUsage = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a>;
00340 
00341     ExReleaseSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00342     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00343 
00344     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00345 
00346     <span class="comment">//</span>
00347     <span class="comment">// Either of these may cause an access violation. The</span>
00348     <span class="comment">// exception handler will return access violation as</span>
00349     <span class="comment">// status code. No further cleanup needs to be done.</span>
00350     <span class="comment">//</span>
00351 
00352     <span class="keywordflow">try</span> {
00353         *(PPOOLED_USAGE_AND_LIMITS) ProcessInformation = UsageAndLimits;
00354 
00355         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00356             *ReturnLength = <span class="keyword">sizeof</span>(POOLED_USAGE_AND_LIMITS);
00357         }
00358     } except(EXCEPTION_EXECUTE_HANDLER) {
00359         <span class="keywordflow">return</span> STATUS_SUCCESS;
00360     }
00361 
00362     <span class="keywordflow">return</span> STATUS_SUCCESS;
00363 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="psquery.c::PspQueryQuotaLimits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryQuotaLimits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">209</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00114">_EPROCESS_QUOTA_BLOCK::PagefileLimit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00111">_EPROCESS_QUOTA_BLOCK::QuotaPoolLimit</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>.
<p>
<pre class="fragment"><div>00217 {
00218     QUOTA_LIMITS QuotaLimits;
00219     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00220     KIRQL OldIrql;
00221     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00222     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> QuotaBlock;
00223 
00224     <span class="keywordflow">if</span> ( ProcessInformationLength != (ULONG) <span class="keyword">sizeof</span>(QUOTA_LIMITS) ) {
00225         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00226     }
00227 
00228     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00229             ProcessHandle,
00230             PROCESS_QUERY_INFORMATION,
00231             PsProcessType,
00232             PreviousMode,
00233             (PVOID *)&amp;Process,
00234             NULL
00235             );
00236     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00237         <span class="keywordflow">return</span> st;
00238     }
00239 
00240 
00241     QuotaBlock = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o49">QuotaBlock</a>;
00242 
00243     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00244 
00245     <span class="keywordflow">if</span> ( QuotaBlock != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a> ) {
00246         ExAcquireSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,&amp;OldIrql);
00247 
00248         QuotaLimits.PagedPoolLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
00249         QuotaLimits.NonPagedPoolLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
00250         QuotaLimits.PagefileLimit = QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a>;
00251         QuotaLimits.TimeLimit.LowPart = 0xffffffff;
00252         QuotaLimits.TimeLimit.HighPart = 0xffffffff;
00253 
00254         ExReleaseSpinLock(&amp;QuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql);
00255     } <span class="keywordflow">else</span> {
00256         QuotaLimits.PagedPoolLimit = (SIZE_T)-1;
00257         QuotaLimits.NonPagedPoolLimit = (SIZE_T)-1;
00258         QuotaLimits.PagefileLimit = (SIZE_T)-1;
00259         QuotaLimits.TimeLimit.LowPart = 0xffffffff;
00260         QuotaLimits.TimeLimit.HighPart = 0xffffffff;
00261     }
00262 
00263     QuotaLimits.MinimumWorkingSetSize =
00264                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00265     QuotaLimits.MaximumWorkingSetSize =
00266                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00267 
00268     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00269 
00270     <span class="comment">//</span>
00271     <span class="comment">// Either of these may cause an access violation. The</span>
00272     <span class="comment">// exception handler will return access violation as</span>
00273     <span class="comment">// status code. No further cleanup needs to be done.</span>
00274     <span class="comment">//</span>
00275 
00276     <span class="keywordflow">try</span> {
00277         *(PQUOTA_LIMITS) ProcessInformation = QuotaLimits;
00278 
00279         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00280             *ReturnLength = <span class="keyword">sizeof</span>(QUOTA_LIMITS);
00281         }
00282     } except(EXCEPTION_EXECUTE_HANDLER) {
00283         ;
00284     }
00285 
00286     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00287     <span class="keywordflow">return</span> STATUS_SUCCESS;
00288 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="psquery.c::PspQueryWorkingSetWatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryWorkingSetWatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG ReturnLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">113</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00050">MAX_WS_CATCH_INDEX</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l00531">NtQueryInformationProcess()</a>.
<p>
<pre class="fragment"><div>00121 {
00122     PPAGEFAULT_HISTORY WorkingSetCatcher;
00123     ULONG SpaceNeeded;
00124     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00125     KIRQL OldIrql;
00126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00127 
00128     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00129             ProcessHandle,
00130             PROCESS_QUERY_INFORMATION,
00131             PsProcessType,
00132             PreviousMode,
00133             (PVOID *)&amp;Process,
00134             NULL
00135             );
00136 
00137     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00138         <span class="keywordflow">return</span> st;
00139     }
00140 
00141     <span class="keywordflow">if</span> ( !(WorkingSetCatcher = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o51">WorkingSetWatch</a>) ) {
00142         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00143         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00144     }
00145 
00146     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
00147     ExAcquireSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,&amp;OldIrql);
00148 
00149     <span class="keywordflow">if</span> ( WorkingSetCatcher-&gt;CurrentIndex ) {
00150 
00151         <span class="comment">//</span>
00152         <span class="comment">// Null Terminate the first empty entry in the buffer</span>
00153         <span class="comment">//</span>
00154 
00155         WorkingSetCatcher-&gt;WatchInfo[WorkingSetCatcher-&gt;CurrentIndex].FaultingPc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00156 
00157         <span class="comment">//Store a special Va value if the buffer was full and</span>
00158         <span class="comment">//page faults could have been lost</span>
00159 
00160         <span class="keywordflow">if</span> (WorkingSetCatcher-&gt;CurrentIndex != WorkingSetCatcher-&gt;MaxIndex)
00161             WorkingSetCatcher-&gt;WatchInfo[WorkingSetCatcher-&gt;CurrentIndex].FaultingVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00162         <span class="keywordflow">else</span>
00163             WorkingSetCatcher-&gt;WatchInfo[WorkingSetCatcher-&gt;CurrentIndex].FaultingVa = (PVOID) 1;
00164 
00165         SpaceNeeded = (WorkingSetCatcher-&gt;CurrentIndex+1) * <span class="keyword">sizeof</span>(PROCESS_WS_WATCH_INFORMATION);
00166     } <span class="keywordflow">else</span> {
00167         ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
00168         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00169         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00170         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
00171     }
00172 
00173     <span class="keywordflow">if</span> ( ProcessInformationLength &lt; SpaceNeeded ) {
00174         ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
00175         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00176         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00177         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00178     }
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// Mark the Working Set buffer as full and then drop the lock</span>
00182     <span class="comment">// and copy the bytes</span>
00183     <span class="comment">//</span>
00184 
00185     WorkingSetCatcher-&gt;CurrentIndex = <a class="code" href="../../d9/d1/psquery_8c.html#a2">MAX_WS_CATCH_INDEX</a>;
00186 
00187     ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
00188 
00189     <span class="keywordflow">try</span> {
00190         RtlMoveMemory(ProcessInformation,&amp;WorkingSetCatcher-&gt;WatchInfo[0],SpaceNeeded);
00191         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength) ) {
00192             *ReturnLength = SpaceNeeded;
00193         }
00194     } except(EXCEPTION_EXECUTE_HANDLER) {
00195         ;
00196     }
00197 
00198     ExAcquireSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,&amp;OldIrql);
00199     WorkingSetCatcher-&gt;CurrentIndex = 0;
00200     ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
00201 
00202     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
00203     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00204 
00205     <span class="keywordflow">return</span> STATUS_SUCCESS;
00206 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="psquery.c::PspSetPrimaryToken" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetPrimaryToken           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN HANDLE TokenHandle&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PACCESS_TOKEN TokenPointer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">366</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d1/d4/se_8h-source.html#l00100">_SECURITY_SUBJECT_CONTEXT::ClientToken</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00102">_SECURITY_SUBJECT_CONTEXT::PrimaryToken</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00103">_SECURITY_SUBJECT_CONTEXT::ProcessAuditId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l01256">PspAssignPrimaryToken()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01671">SeAssignPrimaryTokenPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00504">SeCheckPrivilegedObject()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l02960">SeIsChildTokenByPointer()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01213">SeTokenObjectType</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>00377 {
00378     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st ;
00379     BOOLEAN HasPrivilege ;
00380     BOOLEAN IsChildToken ;
00381     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process ;
00382     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode ;
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Check to see if the supplied token is a child of the caller's</span>
00386     <span class="comment">// token. If so, we don't need to do the privilege check.</span>
00387     <span class="comment">//</span>
00388 
00389     PreviousMode = KeGetPreviousMode();
00390 
00391     <span class="keywordflow">if</span> ( TokenHandle )
00392     {
00393         <span class="comment">//</span>
00394         <span class="comment">// Reference the specified token, and make sure it can be assigned</span>
00395         <span class="comment">// as a primary token.</span>
00396         <span class="comment">//</span>
00397 
00398        st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00399                 TokenHandle,
00400                 TOKEN_ASSIGN_PRIMARY,
00401                 <a class="code" href="../../d0/d5/se_8h.html#a17">SeTokenObjectType</a>(),
00402                 PreviousMode,
00403                 (PVOID *)&amp;TokenPointer,
00404                 NULL
00405                 );
00406 
00407         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00408             <span class="keywordflow">return</span>( st );
00409         }
00410     }
00411 
00412     st = <a class="code" href="../../d4/d3/token_8c.html#a20">SeIsChildTokenByPointer</a>(
00413             TokenPointer,
00414             &amp;IsChildToken
00415             );
00416 
00417     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st)) {
00418 
00419         <span class="keywordflow">if</span> ( TokenHandle ) {
00420             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00421         }
00422         <span class="keywordflow">return</span>( st );
00423     }
00424 
00425     <span class="keywordflow">if</span> (!IsChildToken ) {
00426 
00427 
00428         <span class="comment">//</span>
00429         <span class="comment">// SeCheckPrivilegedObject will perform auditing as appropriate</span>
00430         <span class="comment">//</span>
00431 
00432         HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a4">SeCheckPrivilegedObject</a>(
00433                            SeAssignPrimaryTokenPrivilege,
00434                            ProcessHandle,
00435                            PROCESS_SET_INFORMATION,
00436                            PreviousMode
00437                            );
00438 
00439         <span class="keywordflow">if</span> ( !HasPrivilege ) {
00440 
00441             <span class="keywordflow">if</span> ( TokenHandle ) {
00442                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00443             }
00444 
00445             <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00446         }
00447 
00448     }
00449 
00450     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00451             ProcessHandle,
00452             PROCESS_SET_INFORMATION,
00453             PsProcessType,
00454             PreviousMode,
00455             (PVOID *)&amp;Process,
00456             NULL
00457             );
00458 
00459     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">// Check for proper access to the token, and assign the primary</span>
00463         <span class="comment">// token for the process.</span>
00464         <span class="comment">//</span>
00465 
00466         st = <a class="code" href="../../d6/d5/ps_2security_8c.html#a12">PspAssignPrimaryToken</a>( Process, NULL, TokenPointer );
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">// Recompute the process's access to itself for use</span>
00470         <span class="comment">// with the CurrentProcess() pseudo handle.</span>
00471         <span class="comment">//</span>
00472 
00473         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00474 
00475             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> accesst;
00476             BOOLEAN AccessCheck;
00477             BOOLEAN MemoryAllocated;
00478             PSECURITY_DESCRIPTOR SecurityDescriptor;
00479             <a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html">SECURITY_SUBJECT_CONTEXT</a> SubjectContext;
00480 
00481             st = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>(
00482                     Process,
00483                     &amp;SecurityDescriptor,
00484                     &amp;MemoryAllocated
00485                     );
00486 
00487             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00488 
00489                 <span class="comment">//</span>
00490                 <span class="comment">// Compute the subject security context</span>
00491                 <span class="comment">//</span>
00492 
00493                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o3">ProcessAuditId</a> = Process;
00494                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>(Process);
00495                 SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o0">ClientToken</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496                 AccessCheck = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>(
00497                                 SecurityDescriptor,
00498                                 &amp;SubjectContext,
00499                                 FALSE,
00500                                 MAXIMUM_ALLOWED,
00501                                 0,
00502                                 NULL,
00503                                 &amp;<a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00504                                 PreviousMode,
00505                                 &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a>,
00506                                 &amp;accesst
00507                                 );
00508                 <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>(SubjectContext.<a class="code" href="../../d0/d1/struct__SECURITY__SUBJECT__CONTEXT.html#o2">PrimaryToken</a>);
00509                 <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>(
00510                     SecurityDescriptor,
00511                     MemoryAllocated
00512                     );
00513                 <span class="keywordflow">if</span> ( !AccessCheck ) {
00514                     Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o54">GrantedAccess</a> = 0;
00515                     }
00516             }
00517         }
00518 
00519         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00520     }
00521 
00522     <span class="keywordflow">if</span> ( TokenHandle) {
00523         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( TokenPointer );
00524     }
00525 
00526     <span class="keywordflow">return</span> st;
00527 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="psquery.c::PspSetQuotaLimits" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetQuotaLimits           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PROCESSINFOCLASS&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">1211</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l01118">MmRaisePoolQuota()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00113">_EPROCESS_QUOTA_BLOCK::PagefileUsage</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00098">PspDefaultNonPagedLimit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00097">PspDefaultPagedLimit</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00099">PspDefaultPagefileLimit</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00046">PspDefaultQuotaBlock</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00107">_EPROCESS_QUOTA_BLOCK::QuotaLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00110">_EPROCESS_QUOTA_BLOCK::QuotaPoolUsage</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01673">SeIncreaseQuotaPrivilege</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00436">SeSinglePrivilegeCheck()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>.
<p>
<pre class="fragment"><div>01218 {
01219     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01220     QUOTA_LIMITS RequestedLimits;
01221     KIRQL OldIrql;
01222     <a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html">PEPROCESS_QUOTA_BLOCK</a> NewQuotaBlock;
01223     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01224     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st, ReturnStatus;
01225     PVOID UnlockHandle;
01226     SIZE_T NewLimit;
01227 
01228     <span class="keywordflow">if</span> ( ProcessInformationLength != <span class="keyword">sizeof</span>(QUOTA_LIMITS) ) {
01229         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01230     }
01231 
01232     <span class="keywordflow">try</span> {
01233         RequestedLimits = *(PQUOTA_LIMITS) ProcessInformation;
01234     } except(EXCEPTION_EXECUTE_HANDLER) {
01235         <span class="keywordflow">return</span> GetExceptionCode();
01236     }
01237 
01238     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
01239             ProcessHandle,
01240             PROCESS_SET_QUOTA,
01241             PsProcessType,
01242             PreviousMode,
01243             (PVOID *)&amp;Process,
01244             NULL
01245             );
01246 
01247     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01248         <span class="keywordflow">return</span> st;
01249     }
01250 
01251     UnlockHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01252 
01253     <span class="comment">//</span>
01254     <span class="comment">// Now we are ready to set the quota limits for the process</span>
01255     <span class="comment">//</span>
01256     <span class="comment">// If the process already has a quota block, then all we allow</span>
01257     <span class="comment">// is working set changes.</span>
01258     <span class="comment">//</span>
01259     <span class="comment">// If the process has no quota block, all that can be done is a</span>
01260     <span class="comment">// quota set operation.  The quotas must be high enough that the</span>
01261     <span class="comment">// current usage can be charged without causing a quota overflow.</span>
01262     <span class="comment">//</span>
01263     <span class="comment">// If a quota field is zero, we pick the value.</span>
01264     <span class="comment">//</span>
01265     <span class="comment">// Setting quotas requires the SeIncreaseQuotaPrivilege (except for</span>
01266     <span class="comment">// working set size since this is only advisory).</span>
01267     <span class="comment">//</span>
01268 
01269     ReturnStatus = STATUS_SUCCESS;
01270 
01271     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o49">QuotaBlock</a> == &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a> ) {
01272         <span class="keywordflow">if</span> ( RequestedLimits.MinimumWorkingSetSize &amp;&amp;
01273              RequestedLimits.MaximumWorkingSetSize ) {
01274 
01275             <span class="keywordflow">if</span> ( RequestedLimits.MinimumWorkingSetSize != (SIZE_T)-1 &amp;&amp;
01276                  RequestedLimits.MaximumWorkingSetSize != (SIZE_T)-1 ) {
01277                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> ) {
01278                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01279                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
01280 
01281                     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
01282                         RequestedLimits.MinimumWorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
01283                         RequestedLimits.MaximumWorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
01284                         }
01285 
01286                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
01287                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01288                     }
01289                 }
01290 
01291             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01292             ReturnStatus = <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a> (
01293                             RequestedLimits.MinimumWorkingSetSize,
01294                             RequestedLimits.MaximumWorkingSetSize,
01295                             FALSE
01296                             );
01297             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01298 
01299         } <span class="keywordflow">else</span> {
01300 
01301 
01302             <span class="comment">//</span>
01303             <span class="comment">// You must have a privilege to assign quotas</span>
01304             <span class="comment">//</span>
01305 
01306             <span class="keywordflow">if</span> ( !<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(SeIncreaseQuotaPrivilege,PreviousMode) ) {
01307                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01308                 <span class="keywordflow">return</span> STATUS_PRIVILEGE_NOT_HELD;
01309                 }
01310 
01311             NewQuotaBlock = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPool,<span class="keyword">sizeof</span>(*NewQuotaBlock));
01312             <span class="keywordflow">if</span> ( !NewQuotaBlock ) {
01313                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01314                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01315             }
01316             RtlZeroMemory(NewQuotaBlock,<span class="keyword">sizeof</span>(*NewQuotaBlock));
01317 
01318             <span class="comment">//</span>
01319             <span class="comment">// Initialize the quota block</span>
01320             <span class="comment">//</span>
01321 
01322             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>);
01323             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o1">ReferenceCount</a> = 1;
01324 
01325             <span class="comment">//</span>
01326             <span class="comment">// Grab the quota lock to prevent usage changes</span>
01327             <span class="comment">//</span>
01328 
01329             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
01330             UnlockHandle = <a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>;
01331 
01332             ExAcquireSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>, &amp;OldIrql );
01333 
01334 
01335             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o2">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o9">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
01336             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o2">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o9">QuotaPeakPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
01337             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
01338             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
01339 
01340             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o11">PagefileUsage</a>;
01341             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o5">PeakPagefileUsage</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o13">PeakPagefileUsage</a>;
01342 
01343             <span class="comment">//</span>
01344             <span class="comment">// Now compute limits</span>
01345             <span class="comment">//</span>
01346 
01347             <span class="comment">//</span>
01348             <span class="comment">// lou... We need to think this out a bit</span>
01349             <span class="comment">//</span>
01350             <span class="comment">// Get the defaults that the system would pick.</span>
01351             <span class="comment">//</span>
01352 
01353             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = <a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a>;
01354             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = <a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a>;
01355             NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a> = <a class="code" href="../../d8/d0/cmdat3_8c.html#a43">PspDefaultPagefileLimit</a>;
01356 
01357             <span class="comment">//</span>
01358             <span class="comment">// Now see if current usage exceeds requested limits. If</span>
01359             <span class="comment">// so, fail the operation.</span>
01360             <span class="comment">//</span>
01361 
01362             <span class="comment">//</span>
01363             <span class="comment">// Paged</span>
01364             <span class="comment">//</span>
01365 
01366             <span class="keywordflow">if</span> ( NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] &gt; NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] ) {
01367 
01368                 <span class="keywordflow">while</span> ( (<a class="code" href="../../d8/d0/cmdat3_8c.html#a41">PspDefaultPagedLimit</a> == 0) &amp;&amp; <a class="code" href="../../d6/d1/mmquota_8c.html#a23">MmRaisePoolQuota</a>(PagedPool,NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[PagedPool],&amp;NewLimit) ) {
01369                     NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = NewLimit;
01370                     <span class="keywordflow">if</span> ( NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] &lt;= NewLimit ) {
01371                         <span class="keywordflow">goto</span> LimitRaised0;
01372                         }
01373                     }
01374 
01375                 <span class="comment">//</span>
01376                 <span class="comment">// current usage exceeds requested limit</span>
01377                 <span class="comment">//</span>
01378 
01379                 ExReleaseSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql );
01380                 <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(UnlockHandle);
01381                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewQuotaBlock);
01382                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01383                 <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01384             }
01385 
01386             <span class="comment">//</span>
01387             <span class="comment">// NonPaged</span>
01388             <span class="comment">//</span>
01389 
01390 LimitRaised0:
01391             <span class="keywordflow">if</span> ( NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] &gt; NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] ) {
01392 
01393                 <span class="keywordflow">while</span> ( (<a class="code" href="../../d8/d0/cmdat3_8c.html#a42">PspDefaultNonPagedLimit</a> == 0) &amp;&amp; <a class="code" href="../../d6/d1/mmquota_8c.html#a23">MmRaisePoolQuota</a>(NonPagedPool,NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[NonPagedPool],&amp;NewLimit) ) {
01394                     NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o4">QuotaPoolLimit</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = NewLimit;
01395                     <span class="keywordflow">if</span> ( NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] &lt;= NewLimit ) {
01396                         <span class="keywordflow">goto</span> LimitRaised1;
01397                         }
01398                     }
01399 
01400                 <span class="comment">//</span>
01401                 <span class="comment">// current usage exceeds requested limit</span>
01402                 <span class="comment">//</span>
01403 
01404                 ExReleaseSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql );
01405                 <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(UnlockHandle);
01406                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewQuotaBlock);
01407                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01408                 <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01409             }
01410 
01411             <span class="comment">//</span>
01412             <span class="comment">// Pagefile</span>
01413             <span class="comment">//</span>
01414 
01415 LimitRaised1:
01416             <span class="keywordflow">if</span> ( NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> &gt; NewQuotaBlock-&gt;<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o7">PagefileLimit</a> ) {
01417 
01418                 <span class="comment">//</span>
01419                 <span class="comment">// current usage exceeds requested limit</span>
01420                 <span class="comment">//</span>
01421 
01422                 ExReleaseSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql );
01423                 <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(UnlockHandle);
01424                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewQuotaBlock);
01425                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01426                 <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01427             }
01428 
01429             <span class="comment">// Everything is set. Now double check to quota block fieled</span>
01430             <span class="comment">// If we still have no quota block then assign and succeed.</span>
01431             <span class="comment">// Otherwise punt.</span>
01432             <span class="comment">//</span>
01433 
01434             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o49">QuotaBlock</a> != &amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a> ) {
01435                 ExReleaseSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql );
01436                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewQuotaBlock);
01437             } <span class="keywordflow">else</span> {
01438 
01439                 <span class="comment">//</span>
01440                 <span class="comment">// return the quotas used by this process, and attach process</span>
01441                 <span class="comment">// to new quota block</span>
01442                 <span class="comment">//</span>
01443 
01444                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] &lt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] ) {
01445                         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] -= Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
01446                     }
01447                 <span class="keywordflow">else</span> {
01448                     <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = 0;
01449                     }
01450 
01451                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] &lt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] ) {
01452                         <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] -= Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o10">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
01453                     }
01454                 <span class="keywordflow">else</span> {
01455                     <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o3">QuotaPoolUsage</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = 0;
01456                     }
01457 
01458                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o11">PagefileUsage</a> &lt;= <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> ) {
01459                     <a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o6">PagefileUsage</a> -= Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o11">PagefileUsage</a>;
01460                     }
01461 
01462                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o49">QuotaBlock</a> = NewQuotaBlock;
01463                 ExReleaseSpinLock(&amp;<a class="code" href="../../d6/d1/mmquota_8c.html#a11">PspDefaultQuotaBlock</a>.<a class="code" href="../../d4/d4/struct__EPROCESS__QUOTA__BLOCK.html#o0">QuotaLock</a>,OldIrql );
01464             }
01465             <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(UnlockHandle);
01466             ReturnStatus = STATUS_SUCCESS;
01467         }
01468     } <span class="keywordflow">else</span> {
01469 
01470         <span class="comment">//</span>
01471         <span class="comment">// Only allow a working set size change</span>
01472         <span class="comment">//</span>
01473 
01474         <span class="keywordflow">if</span> ( RequestedLimits.MinimumWorkingSetSize &amp;&amp;
01475              RequestedLimits.MaximumWorkingSetSize ) {
01476 
01477             <span class="keywordflow">if</span> ( RequestedLimits.MinimumWorkingSetSize != (SIZE_T)-1 &amp;&amp;
01478                  RequestedLimits.MaximumWorkingSetSize != (SIZE_T)-1 ) {
01479                 <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> ) {
01480                     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01481                     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>, TRUE);
01482 
01483                     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o14">LimitFlags</a> &amp; JOB_OBJECT_LIMIT_WORKINGSET ) {
01484                         RequestedLimits.MinimumWorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o15">MinimumWorkingSetSize</a>;
01485                         RequestedLimits.MaximumWorkingSetSize = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o16">MaximumWorkingSetSize</a>;
01486                         }
01487 
01488                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>-&gt;<a class="code" href="../../d0/d3/struct__EJOB.html#o3">JobLock</a>);
01489                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01490                     }
01491                 }
01492 
01493             <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
01494             ReturnStatus = <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a> (
01495                             RequestedLimits.MinimumWorkingSetSize,
01496                             RequestedLimits.MaximumWorkingSetSize,
01497                             FALSE
01498                             );
01499             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
01500 
01501         }
01502     }
01503     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01504 
01505     <span class="keywordflow">return</span> ReturnStatus;
01506 
01507 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="psquery.c::PsSetProcessPriorityByClass" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PsSetProcessPriorityByClass           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d9/ps_8h.html#a88">PSPROCESSPRIORITYMODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PriorityMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">3916</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d4/d4/procobj_8c-source.html#l00738">KeSetPriorityProcess()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00041">MEMORY_PRIORITY_BACKGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00133">PS_WS_TRIM_BACKGROUND_ONLY_APP</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00113">PspForegroundQuantum</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00864">PspJobSchedulingClasses</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00052">PspPriorityTable</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00573">PsPrioritySeperation</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a>, <a class="el" href="../../d1/d9/ps_8h.html#a159a110">PsProcessPrioritySpinning</a>, <a class="el" href="../../d1/d0/psinit_8c-source.html#l00862">PspUseJobSchedulingClasses</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00036">THREAD_QUANTUM</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l01510">NtSetInformationProcess()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l02262">PspApplyJobLimitsToProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l02648">SetForegroundPriorityProcess()</a>.
<p>
<pre class="fragment"><div>03920 {
03921     KPRIORITY BasePriority;
03922     UCHAR MemoryPriority;
03923     ULONG QuantumIndex;
03924 
03925     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03926 
03927 
03928     BasePriority = <a class="code" href="../../d9/d1/psquery_8c.html#a6">PspPriorityTable</a>[Process-&gt;PriorityClass];
03929 
03930 
03931     <span class="keywordflow">if</span> ( PriorityMode == <a class="code" href="../../d1/d9/ps_8h.html#a159a109">PsProcessPriorityForeground</a> ) {
03932         QuantumIndex = <a class="code" href="../../d1/d9/ps_8h.html#a47">PsPrioritySeperation</a>;
03933         MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>;
03934 <span class="preprocessor">#if defined(_X86_)</span>
03935 <span class="preprocessor"></span>        Process-&gt;MmAgressiveWsTrimMask &amp;= ~<a class="code" href="../../d1/d9/ps_8h.html#a5">PS_WS_TRIM_BACKGROUND_ONLY_APP</a>;
03936 <span class="preprocessor">#endif // _X86_</span>
03937 <span class="preprocessor"></span>        }
03938     <span class="keywordflow">else</span> {
03939         QuantumIndex = 0;
03940         MemoryPriority = <a class="code" href="../../d1/d9/ps_8h.html#a1">MEMORY_PRIORITY_BACKGROUND</a>;
03941         }
03942 
03943     <span class="keywordflow">if</span> ( Process-&gt;PriorityClass != PROCESS_PRIORITY_CLASS_IDLE ) {
03944         <span class="keywordflow">if</span> ( Process-&gt;Job &amp;&amp; <a class="code" href="../../d0/d1/psinit_8c.html#a37">PspUseJobSchedulingClasses</a> ) {
03945             Process-&gt;Pcb.ThreadQuantum = <a class="code" href="../../d0/d1/psinit_8c.html#a38">PspJobSchedulingClasses</a>[Process-&gt;Job-&gt;SchedulingClass];
03946             }
03947         <span class="keywordflow">else</span> {
03948             Process-&gt;Pcb.ThreadQuantum = <a class="code" href="../../d0/d1/psinit_8c.html#a21">PspForegroundQuantum</a>[QuantumIndex];
03949             }
03950         }
03951     <span class="keywordflow">else</span> {
03952         Process-&gt;Pcb.ThreadQuantum = <a class="code" href="../../d4/d9/ke_8h.html#a3">THREAD_QUANTUM</a>;
03953         }
03954 
03955     <a class="code" href="../../d3/d5/procobj_8c.html#a11">KeSetPriorityProcess</a>(&amp;Process-&gt;Pcb,BasePriority);
03956     <span class="keywordflow">if</span> ( PriorityMode != <a class="code" href="../../d1/d9/ps_8h.html#a159a110">PsProcessPrioritySpinning</a> ) {
03957         <a class="code" href="../../d4/d5/procsup_8c.html#a45">MmSetMemoryPriorityProcess</a>(Process, MemoryPriority);
03958         }
03959 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="psquery.c::PsWatchWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PsWatchWorkingSet           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PcValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Va</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03788">3788</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00251">_EPROCESS::WorkingSetWatch</a>.
<p>
Referenced by <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00056">KiMemoryFault()</a>.
<p>
<pre class="fragment"><div>03796                    :
03797 
03798     This function collects data about page faults.
03799     For both user and kernel space page faults, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> stores information about
03800     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page fault in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> causing process's data structure.
03801 
03802 Arguments:
03803 
03804     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of page fault
03805     PcValue - Program Counter value that caused page fault
03806     Va - Memory address that was being accessed to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page fault
03807 
03808 --*/
03809 
03810 {
03811     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03812     PPAGEFAULT_HISTORY WorkingSetCatcher;
03813     KIRQL OldIrql;
03814     BOOLEAN TransitionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03815 
03816     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ))
03817         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03818 
03819     <span class="comment">//Both transition and demand zero faults count as soft faults.  Only disk</span>
03820     <span class="comment">//reads count as hard faults.</span>
03821     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> &lt;= STATUS_PAGE_FAULT_DEMAND_ZERO ) {
03822         TransitionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03823         }
03824     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
03825     <span class="keywordflow">if</span> ( !(WorkingSetCatcher = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o51">WorkingSetWatch</a>) ) {
03826         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03827         }
03828 
03829     ExAcquireSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,&amp;OldIrql);
03830     <span class="keywordflow">if</span> ( WorkingSetCatcher-&gt;CurrentIndex &gt;= WorkingSetCatcher-&gt;MaxIndex ) {
03831         ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
03832         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03833         }
03834 
03835     <span class="comment">//Store the Pc and Va values in the buffer. Use the least sig. bit</span>
03836     <span class="comment">//of the Va to store whether it was a soft or hard fault</span>
03837     WorkingSetCatcher-&gt;WatchInfo[WorkingSetCatcher-&gt;CurrentIndex].FaultingPc = PcValue;
03838     WorkingSetCatcher-&gt;WatchInfo[WorkingSetCatcher-&gt;CurrentIndex].FaultingVa = TransitionFault ? (PVOID)((ULONG_PTR)Va | 1) : (PVOID)((ULONG_PTR)Va &amp; 0xfffffffe) ;
03839     WorkingSetCatcher-&gt;CurrentIndex++;
03840 
03841     ExReleaseSpinLock(&amp;WorkingSetCatcher-&gt;SpinLock,OldIrql);
03842     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03843 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="psquery.c::ExpDefaultErrorPortProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="el" href="../../d9/d1/psquery_8c.html#a4">ExpDefaultErrorPortProcess</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00040">40</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00349">ExpRaiseHardError()</a>, <a class="el" href="../../d6/d2/acceschk_8c-source.html#l00194">MiCheckForUserStackOverflow()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l01474">MiLoadImageSection()</a>, <a class="el" href="../../d7/d7/ex_2harderr_8c-source.html#l00886">NtSetDefaultHardErrorPort()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="psquery.c::ObpInitKillMutant" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a3">ObpInitKillMutant</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00035">35</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="psquery.c::PopEventCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a86">PKWIN32_POWEREVENT_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a10">PopEventCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03848">3848</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="psquery.c::PopStateCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a87">PKWIN32_POWERSTATE_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a11">PopStateCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03849">3849</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="psquery.c::PspPriorityTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KPRIORITY <a class="el" href="../../d9/d1/psquery_8c.html#a6">PspPriorityTable</a>[PROCESS_PRIORITY_CLASS_ABOVE_NORMAL+1] = {8,4,8,13,24,6,10}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00052">52</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03916">PsSetProcessPriorityByClass()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="psquery.c::PspW32JobCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a78">PKWIN32_JOB_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a9">PspW32JobCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03847">3847</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/psjob_8c-source.html#l00266">NtAssignProcessToJobObject()</a>, <a class="el" href="../../d2/d0/psjob_8c-source.html#l01323">NtSetInformationJobObject()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d2/d0/psjob_8c-source.html#l00636">PspJobDelete()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="psquery.c::PspW32ProcessCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a74">PKWIN32_PROCESS_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a7">PspW32ProcessCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03845">3845</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="psquery.c::PspW32ThreadCallout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d9/ps_8h.html#a80">PKWIN32_THREAD_CALLOUT</a> <a class="el" href="../../d9/d1/psquery_8c.html#a8">PspW32ThreadCallout</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l03846">3846</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/psquery_8c-source.html#l03964">PsConvertToGuiThread()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03855">PsEstablishWin32Callouts()</a>, and <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="psquery.c::PsWatchEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d9/d1/psquery_8c.html#a5">PsWatchEnabled</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/psquery_8c-source.html#l00041">41</a> of file <a class="el" href="../../d0/d1/psquery_8c-source.html">psquery.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
