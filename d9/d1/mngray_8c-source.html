<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mngray.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mngray.c</h1><a href="../../d8/d2/mngray_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mngray.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Server-side version of DrawState</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 06-Jan-1993 FritzS    Created</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d8/d2/mngray_8c.html#a0">00015</a> <span class="preprocessor">#define PATOR           0x00FA0089L</span>
<a name="l00016"></a><a class="code" href="../../d8/d2/mngray_8c.html#a1">00016</a> <span class="preprocessor"></span><span class="preprocessor">#define SRCSTENCIL      0x00B8074AL</span>
<a name="l00017"></a><a class="code" href="../../d8/d2/mngray_8c.html#a2">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define SRCINVSTENCIL   0x00E20746L</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * CreateCompatiblePublicDC</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * This is used in several callback routines to the lpk(s).  We can't</span>
00024 <span class="comment"> * pass G_TERM(pDispInfo)-&gt;hdcGray or HDCBITS() to the client since they are public DCs.</span>
00025 <span class="comment"> * We can't just change the owner since we're about to leave the</span>
00026 <span class="comment"> * critical section.  Some other thread may enter before we return</span>
00027 <span class="comment"> * and use hdcGray or HDCBITS().  Instead, we create a compatible dc with the same</span>
00028 <span class="comment"> * font and bitmap that are currently selected in hdcGray (or HDCBITS()).  Pass that</span>
00029 <span class="comment"> * to the client lpk.</span>
00030 <span class="comment"> *</span>
00031 <span class="comment"> * If the function returns successfully , then the dc and bitmap object are</span>
00032 <span class="comment"> * guaranteed to be successfully created.</span>
00033 <span class="comment"> *</span>
00034 <span class="comment"> * History:</span>
00035 <span class="comment"> *</span>
00036 <span class="comment"> * Dec-16-1997  Samer Arafeh  [samera]</span>
00037 <span class="comment"> * Jan-20-1998  Samer Arafeh  [samera] Add support for both hdcGray and HDCBITS()</span>
00038 <span class="comment"> *</span>
00039 <span class="comment">\***************************************************************************/</span>
<a name="l00040"></a><a class="code" href="../../d4/d1/userk_8h.html#a1406">00040</a> HDC <a class="code" href="../../d4/d1/userk_8h.html#a1406">CreateCompatiblePublicDC</a>(
00041     HDC      hdcPublic,
00042     HBITMAP *pbmPublicDC)
00043 {
00044     HDC     hdcCompatible = 0;
00045     HBITMAP hbmCompatible;
00046     HFONT   hFont;
00047     <span class="keywordtype">int</span>     cx,<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00048 
00049     <span class="keywordflow">if</span> ((hdcPublic != <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>) &amp;&amp; (hdcPublic != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>())) {
00050         <span class="keywordflow">return</span> hdcPublic;
00051     }
00052 
00053     <span class="keywordflow">if</span> ((hdcCompatible = GreCreateCompatibleDC(hdcPublic)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00054         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateCompatiblePublicDC: GreCreateCompatibleDC Failed %lX"</span>, hdcPublic);
00055         <span class="keywordflow">return</span> (HDC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00056     }
00057     <span class="keywordflow">if</span> (!GreSetDCOwner(hdcCompatible, OBJECT_OWNER_CURRENT)) {
00058         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateCompatiblePublicDC: SetDCOwner Failed %lX"</span>, hdcCompatible);
00059         GreDeleteDC(hdcCompatible);
00060         <span class="keywordflow">return</span> (HDC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061     }
00062 
00063     <span class="keywordflow">if</span> (hdcPublic == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>) {
00064         cx = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>;
00065         <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>;
00066     } <span class="keywordflow">else</span> {
00067         <span class="keywordflow">if</span> (hdcPublic == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a527">HDCBITS</a>()) {
00068             BITMAP bmBits;
00069 
00070             GreExtGetObjectW(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a130">ghbmBits</a>, <span class="keyword">sizeof</span>(BITMAP), &amp;bmBits);
00071             cx = bmBits.bmWidth;
00072             <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = bmBits.bmHeight;
00073         } <span class="keywordflow">else</span> {
00074 
00075           <span class="comment">//</span>
00076           <span class="comment">// We should not reach here.</span>
00077           <span class="comment">//</span>
00078           RIPMSG1(RIP_ERROR, <span class="stringliteral">"CreateCompatiblePublicDC: GreCreateCompatibleDC Failed %lX"</span>, hdcPublic);
00079         }
00080 
00081     }
00082 
00083     hbmCompatible = GreCreateCompatibleBitmap(hdcPublic,
00084                                               cx,
00085                                               <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// Check whether bitmap couldn't be created or can't</span>
00089     <span class="comment">// be set to OBJECT_OWNER_CURRENT, then fail and</span>
00090     <span class="comment">// do necessary cleanup now!</span>
00091     <span class="comment">//</span>
00092 
00093     <span class="keywordflow">if</span>( (hbmCompatible == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00094         (!GreSetBitmapOwner(hbmCompatible, OBJECT_OWNER_CURRENT)) ) {
00095 
00096         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CreateCompatiblePublicDC: GreCreateCompatibleBitmap Failed %lX"</span>, hbmCompatible);
00097         GreDeleteDC( hdcCompatible );
00098 
00099         <span class="keywordflow">if</span>( hbmCompatible ) {
00100             GreDeleteObject( hbmCompatible );
00101         }
00102 
00103         <span class="keywordflow">return</span> (HDC)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00104     }
00105 
00106     GreSelectBitmap(hdcCompatible, hbmCompatible);
00107     <span class="comment">/*</span>
00108 <span class="comment">     * Make sure we use the same font and text alignment.</span>
00109 <span class="comment">     */</span>
00110     hFont = GreSelectFont(hdcPublic, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
00111     GreSelectFont(hdcPublic, hFont);
00112     GreSelectFont(hdcCompatible, hFont);
00113     <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdcCompatible, <a class="code" href="../../d4/d1/userk_8h.html#a1136">GreGetTextAlign</a>(hdcPublic));
00114     <span class="comment">/*</span>
00115 <span class="comment">     * Copy any information already written into G_TERM(pDispInfo)-&gt;hdcGray.</span>
00116 <span class="comment">     */</span>
00117 
00118 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00119 <span class="preprocessor"></span>    <span class="comment">//</span>
00120     <span class="comment">// Mirror the created DC if the hdcGray is currently mirrored,</span>
00121     <span class="comment">// so that TextOut won't get mirrored on User Client DCs</span>
00122     <span class="comment">//</span>
00123     <span class="keywordflow">if</span> (GreGetLayout(hdcPublic) &amp; LAYOUT_RTL)
00124         GreSetLayout(hdcCompatible, cx - 1, LAYOUT_RTL);
00125 <span class="preprocessor">#endif</span>
00126 <span class="preprocessor"></span>    GreBitBlt(hdcCompatible, 0, 0, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>, hdcPublic, 0, 0, SRCCOPY, 0);
00127 
00128     *pbmPublicDC = hbmCompatible ;      <span class="comment">// for later deletion, by the server side</span>
00129 
00130     <span class="keywordflow">return</span> hdcCompatible;
00131 }
00132 
00133 
00134 
00135 <span class="comment">/***************************************************************************\</span>
00136 <span class="comment">*</span>
00137 <span class="comment">*  xxxDrawState()</span>
00138 <span class="comment">*</span>
00139 <span class="comment">*  Generic state drawing routine.  Does simple drawing into same DC if</span>
00140 <span class="comment">*  normal state;  uses offscreen bitmap otherwise.</span>
00141 <span class="comment">*</span>
00142 <span class="comment">*  We do drawing for these simple types ourselves:</span>
00143 <span class="comment">*      (1) Text</span>
00144 <span class="comment">*          lData is string pointer.</span>
00145 <span class="comment">*          wData is string length</span>
00146 <span class="comment">*      (2) Icon</span>
00147 <span class="comment">*          LOWORD(lData) is hIcon</span>
00148 <span class="comment">*      (3) Bitmap</span>
00149 <span class="comment">*          LOWORD(lData) is hBitmap</span>
00150 <span class="comment">*      (4) Glyph (internal)</span>
00151 <span class="comment">*          LOWORD(lData) is OBI_ value, one of</span>
00152 <span class="comment">*              OBI_CHECKMARK</span>
00153 <span class="comment">*              OBI_BULLET</span>
00154 <span class="comment">*              OBI_MENUARROW</span>
00155 <span class="comment">*          right now</span>
00156 <span class="comment">*</span>
00157 <span class="comment">*  Other types are required to draw via the callback function, and are</span>
00158 <span class="comment">*  allowed to stick whatever they want in lData and wData.</span>
00159 <span class="comment">*</span>
00160 <span class="comment">*  We apply the following effects onto the image:</span>
00161 <span class="comment">*      (1) Normal      (nothing)</span>
00162 <span class="comment">*      (2) Default     (drop shadow)</span>
00163 <span class="comment">*      (3) Union       (gray string dither)</span>
00164 <span class="comment">*      (4) Disabled    (embossed)</span>
00165 <span class="comment">*</span>
00166 <span class="comment">*  Note that we do NOT stretch anything.  We just clip.</span>
00167 <span class="comment">*</span>
00168 <span class="comment">\***************************************************************************/</span>
<a name="l00169"></a><a class="code" href="../../d4/d1/userk_8h.html#a1761">00169</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1761">xxxDrawState</a>(
00170     HDC           hdcDraw,
00171     HBRUSH        hbrFore,
00172     LPARAM        lData,
00173     <span class="keywordtype">int</span>           x,
00174     <span class="keywordtype">int</span>           y,
00175     <span class="keywordtype">int</span>           cx,
00176     <span class="keywordtype">int</span>           cy,
00177     UINT          uFlags)
00178 {
00179     HFONT   hFont;
00180     HFONT   hFontSave = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00181     HDC     hdcT;
00182     HBITMAP hbmpT;
00183     POINT   ptOrg;
00184     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    fResult;
00185     <span class="keywordtype">int</span>     oldAlign;
00186 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00187 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwOldLayout=0;
00188 <span class="preprocessor">#endif</span>
00189 <span class="preprocessor"></span>
00190     <span class="comment">/*</span>
00191 <span class="comment">     * These require monochrome conversion</span>
00192 <span class="comment">     *</span>
00193 <span class="comment">     * Enforce monochrome: embossed doesn't look great with 2 color displays</span>
00194 <span class="comment">     */</span>
00195     <span class="keywordflow">if</span> ((uFlags &amp; DSS_DISABLED) &amp;&amp;
00196         ((<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;BitCount == 1) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SLOWMACHINE))) {
00197 
00198         uFlags &amp;= ~DSS_DISABLED;
00199         uFlags |= DSS_UNION;
00200     }
00201 
00202     <span class="keywordflow">if</span> (uFlags &amp; (DSS_INACTIVE | DSS_DISABLED | DSS_DEFAULT | DSS_UNION))
00203         uFlags |= DSS_MONO;
00204 
00205     <span class="comment">/*</span>
00206 <span class="comment">     * Validate flags - we only support DST_COMPLEX in kernel</span>
00207 <span class="comment">     */</span>
00208     <span class="keywordflow">if</span> ((uFlags &amp; DST_TYPEMASK) != DST_COMPLEX) {
00209         RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxDrawState: invalid DST_ type %x"</span>, (uFlags &amp; DST_TYPEMASK));
00210         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00211     }
00212 
00213     <span class="comment">/*</span>
00214 <span class="comment">     * Optimize:  nothing to draw</span>
00215 <span class="comment">     */</span>
00216     <span class="keywordflow">if</span> (!cx || !<a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>) {
00217         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00218     }
00219 
00220     <span class="comment">/*</span>
00221 <span class="comment">     * Setup drawing dc</span>
00222 <span class="comment">     */</span>
00223     <span class="keywordflow">if</span> (uFlags &amp; DSS_MONO) {
00224 
00225         hdcT = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>;
00226 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00227 <span class="preprocessor"></span>        <span class="comment">/*</span>
00228 <span class="comment">         * First turn off mirroring on hdcGray if any.</span>
00229 <span class="comment">         */</span>
00230         GreSetLayout(hdcT, -1, 0);
00231         <span class="comment">/*</span>
00232 <span class="comment">         * Set the hdcGray layout to be equal to the screen hdcDraw layout.</span>
00233 <span class="comment">         */</span>
00234         dwOldLayout = GreGetLayout(hdcDraw);
00235         <span class="keywordflow">if</span> (dwOldLayout != GDI_ERROR) {
00236             GreSetLayout(hdcT, cx, dwOldLayout);
00237         }
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>
00240         <span class="comment">/*</span>
00241 <span class="comment">         * Is our scratch bitmap big enough?  We need potentially</span>
00242 <span class="comment">         * cx+1 by cy pixels for default etc.</span>
00243 <span class="comment">         */</span>
00244         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a> &lt; cx + 1) || (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a> &lt; <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>)) {
00245 
00246             <span class="keywordflow">if</span> (hbmpT = GreCreateBitmap(<a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>, cx + 1), <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a>, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>), 1, 1, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) {
00247 
00248                 HBITMAP hbmGray;
00249 
00250                 hbmGray = GreSelectBitmap(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, hbmpT);
00251                 GreDeleteObject(hbmGray);
00252 
00253                 GreSetBitmapOwner(hbmpT, OBJECT_OWNER_PUBLIC);
00254 
00255                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>, cx + 1);
00256                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a>, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00257 
00258             } <span class="keywordflow">else</span> {
00259                 cx = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a> - 1;
00260                 <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a>;
00261             }
00262         }
00263 
00264         GrePatBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00265                   0,
00266                   0,
00267                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o7">cxGray</a>,
00268                   <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o8">cyGray</a>,
00269                   WHITENESS);
00270 
00271         GreSetTextCharacterExtra(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00272                                  GreGetTextCharacterExtra(hdcDraw));
00273 
00274         oldAlign = <a class="code" href="../../d4/d1/userk_8h.html#a1136">GreGetTextAlign</a>(hdcT);
00275         <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdcT, (oldAlign &amp; ~(TA_RTLREADING |TA_CENTER |TA_RIGHT))
00276                      | (<a class="code" href="../../d4/d1/userk_8h.html#a1136">GreGetTextAlign</a>(hdcDraw) &amp; (TA_RTLREADING |TA_CENTER |TA_RIGHT)));
00277         <span class="comment">/*</span>
00278 <span class="comment">         * Setup font</span>
00279 <span class="comment">         */</span>
00280         <span class="keywordflow">if</span> (GreGetHFONT(hdcDraw) != <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>) {
00281             hFont = GreSelectFont(hdcDraw, <a class="code" href="../../d1/d8/clglobal_8c.html#a28">ghFontSys</a>);
00282             GreSelectFont(hdcDraw, hFont);
00283             hFontSave = GreSelectFont(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, hFont);
00284         }
00285     } <span class="keywordflow">else</span> {
00286         hdcT = hdcDraw;
00287         <span class="comment">/*</span>
00288 <span class="comment">         * Adjust viewport</span>
00289 <span class="comment">         */</span>
00290         GreGetViewportOrg(hdcT, &amp;ptOrg);
00291         GreSetViewportOrg(hdcT, ptOrg.x+x, ptOrg.y+y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00292 
00293     }
00294 
00295     <span class="comment">/*</span>
00296 <span class="comment">     * Now, draw original image</span>
00297 <span class="comment">     */</span>
00298     fResult = <a class="code" href="../../d4/d1/userk_8h.html#a1316">xxxRealDrawMenuItem</a>(hdcT, (<a class="code" href="../../d3/d0/structGRAYMENU.html">PGRAYMENU</a>)lData, cx, <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>);
00299 
00300     <span class="comment">/*</span>
00301 <span class="comment">     * The callbacks could have altered the attributes of hdcGray</span>
00302 <span class="comment">     */</span>
00303     <span class="keywordflow">if</span> (hdcT == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>) {
00304         GreSetBkColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, RGB(255, 255, 255));
00305         GreSetTextColor(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, RGB(0, 0, 0));
00306         GreSelectBrush(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a1135">ghbrBlack</a>);
00307         GreSetBkMode(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, OPAQUE);
00308     }
00309 
00310     <span class="comment">/*</span>
00311 <span class="comment">     * Clean up</span>
00312 <span class="comment">     */</span>
00313     <span class="keywordflow">if</span> (uFlags &amp; DSS_MONO) {
00314 
00315         <span class="comment">/*</span>
00316 <span class="comment">         * Reset font</span>
00317 <span class="comment">         */</span>
00318         <span class="keywordflow">if</span> (hFontSave)
00319             GreSelectFont(hdcT, hFontSave);
00320         <a class="code" href="../../d4/d1/userk_8h.html#a1135">GreSetTextAlign</a>(hdcT, oldAlign);
00321     } <span class="keywordflow">else</span> {
00322         <span class="comment">/*</span>
00323 <span class="comment">         * Reset DC.</span>
00324 <span class="comment">         */</span>
00325         GreSetViewportOrg(hdcT, ptOrg.x, ptOrg.y, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00326         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00327     }
00328 
00329     <span class="comment">/*</span>
00330 <span class="comment">     * UNION state</span>
00331 <span class="comment">     * Dither over image</span>
00332 <span class="comment">     * We want white pixels to stay white, in either dest or pattern.</span>
00333 <span class="comment">     */</span>
00334     <span class="keywordflow">if</span> (uFlags &amp; DSS_UNION) {
00335 
00336          POLYPATBLT PolyData;
00337 
00338          PolyData.x         = 0;
00339          PolyData.y         = 0;
00340          PolyData.cx        = cx;
00341          PolyData.cy        = <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>;
00342          PolyData.BrClr.hbr = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;hbrGray;
00343 
00344          GrePolyPatBlt(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>, <a class="code" href="../../d9/d2/mngrayc_8c.html#a0">PATOR</a>, &amp;PolyData, 1, PPB_BRUSH);
00345     }
00346 
00347     <span class="keywordflow">if</span> (uFlags &amp; DSS_INACTIVE) {
00348 
00349         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00350                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DSHADOW),
00351                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00352                  x,
00353                  y,
00354                  cx,
00355                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00356                  0,
00357                  0,
00358                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00359 
00360     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uFlags &amp; DSS_DISABLED) {
00361 
00362         <span class="comment">/*</span>
00363 <span class="comment">         * Emboss</span>
00364 <span class="comment">         * Draw over-1/down-1 in hilight color, and in same position in shadow.</span>
00365 <span class="comment">         */</span>
00366 
00367         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00368                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DHILIGHT),
00369                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00370                  x+1,
00371                  y+1,
00372                  cx,
00373                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00374                  0,
00375                  0,
00376                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00377 
00378         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00379                  <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DSHADOW),
00380                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00381                  x,
00382                  y,
00383                  cx,
00384                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00385                  0,
00386                  0,
00387                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00388 
00389     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (uFlags &amp; DSS_DEFAULT) {
00390 
00391         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00392                  hbrFore,
00393                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00394                  x,
00395                  y,
00396                  cx,
00397                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00398                  0,
00399                  0,
00400                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00401 
00402         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00403                  hbrFore,
00404                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00405                  x+1,
00406                  y,
00407                  cx,
00408                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00409                  0,
00410                  0,
00411                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00412 
00413     } <span class="keywordflow">else</span> {
00414 
00415         <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(hdcDraw,
00416                  hbrFore,
00417                  <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00418                  x,
00419                  y,
00420                  cx,
00421                  <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00422                  0,
00423                  0,
00424                  <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>);
00425     }
00426 
00427 
00428 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00429 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((uFlags &amp; DSS_MONO)){
00430         <span class="comment">/*</span>
00431 <span class="comment">         * Set the hdcGray layout to 0, it is a public DC.</span>
00432 <span class="comment">         */</span>
00433        GreSetLayout(hdcT, -1, 0);
00434     }
00435 <span class="preprocessor">#endif</span>
00436 <span class="preprocessor"></span>    <span class="keywordflow">return</span> fResult;
00437 }
00438 
00439 <span class="comment">/***************************************************************************\</span>
00440 <span class="comment">* BltColor</span>
00441 <span class="comment">*</span>
00442 <span class="comment">* &lt;brief description&gt;</span>
00443 <span class="comment">*</span>
00444 <span class="comment">* History:</span>
00445 <span class="comment">* 13-Nov-1990 JimA      Ported from Win3.</span>
00446 <span class="comment">\***************************************************************************/</span>
00447 
<a name="l00448"></a><a class="code" href="../../d4/d1/userk_8h.html#a1501">00448</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1501">BltColor</a>(
00449     HDC    hdc,
00450     HBRUSH hbr,
00451     HDC    hdcSrce,
00452     <span class="keywordtype">int</span>    xO,
00453     <span class="keywordtype">int</span>    yO,
00454     <span class="keywordtype">int</span>    cx,
00455     <span class="keywordtype">int</span>    cy,
00456     <span class="keywordtype">int</span>    xO1,
00457     <span class="keywordtype">int</span>    yO1,
00458     UINT   uBltFlags)
00459 {
00460     HBRUSH hbrSave;
00461     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  textColorSave;
00462     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  bkColorSave;
00463     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  ROP;
00464 
00465     <span class="comment">/*</span>
00466 <span class="comment">     * Set the Text and Background colors so that bltColor handles the</span>
00467 <span class="comment">     * background of buttons (and other bitmaps) properly.</span>
00468 <span class="comment">     * Save the HDC's old Text and Background colors.  This causes problems</span>
00469 <span class="comment">     * with Omega (and probably other apps) when calling GrayString which</span>
00470 <span class="comment">     * uses this routine...</span>
00471 <span class="comment">     */</span>
00472     textColorSave = GreSetTextColor(hdc, 0x00000000L);
00473     bkColorSave = GreSetBkColor(hdc, 0x00FFFFFFL);
00474 
00475     <span class="keywordflow">if</span> (hbr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00476         hbrSave = GreSelectBrush(hdc, hbr);
00477     <span class="keywordflow">if</span> (uBltFlags &amp; <a class="code" href="../../d9/d2/mngrayc_8c.html#a3">BC_INVERT</a>)
00478         ROP = 0xB8074A<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00479     <span class="keywordflow">else</span>
00480         ROP = 0xE20746<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00481 
00482     <span class="keywordflow">if</span> (uBltFlags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a3">BC_NOMIRROR</a>)
00483         ROP |= NOMIRRORBITMAP;
00484 
00485     GreBitBlt(hdc,
00486               xO,
00487               yO,
00488               cx,
00489               <a class="code" href="../../d1/d1/inctlpan_8c.html#a3">cy</a>,
00490               hdcSrce ? hdcSrce : <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o5">hdcGray</a>,
00491               xO1,
00492               yO1,
00493               ROP,
00494               0x00FFFFFF);
00495 
00496     <span class="keywordflow">if</span> (hbr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00497         GreSelectBrush(hdc, hbrSave);
00498 
00499     <span class="comment">/*</span>
00500 <span class="comment">     * Restore saved colors</span>
00501 <span class="comment">     */</span>
00502     GreSetTextColor(hdc, textColorSave);
00503     GreSetBkColor(hdc, bkColorSave);
00504 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
