<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obse.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obse.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d0/d1/obse_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a0">NtSetSecurityObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a> (IN PVOID Object, IN SECURITY_INFORMATION SecurityInformation, IN PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN SECURITY_INFORMATION SecurityInformation, OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN ULONG Length, OUT PULONG LengthNeeded)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a> (IN PVOID Object, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a4">ObpCheckObjectReference</a> (IN PVOID Object, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a5">ObpCheckTraverseAccess</a> (IN PVOID DirectoryObject, IN ACCESS_MASK TraverseAccess, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a6">ObCheckCreateObjectAccess</a> (IN PVOID DirectoryObject, IN ACCESS_MASK CreateAccess, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PUNICODE_STRING ComponentName, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a7">ObAssignObjectSecurityDescriptor</a> (IN PVOID Object, IN PSECURITY_DESCRIPTOR SecurityDescriptor OPTIONAL, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a> (IN PVOID Object, OUT PSECURITY_DESCRIPTOR *SecurityDescriptor, OUT PBOOLEAN MemoryAllocated)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a> (IN PSECURITY_DESCRIPTOR SecurityDescriptor, IN BOOLEAN MemoryAllocated)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a10">ObValidateSecurityQuota</a> (IN PVOID Object, IN ULONG NewSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a11">ObAssignSecurity</a> (IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL, IN PVOID Object, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a12">ObQuerySecurityDescriptorInfo</a> (IN PSECURITY_INFORMATION SecurityInformation, OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PULONG Length, IN PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a13">ObSetSecurityDescriptorInfo</a> (IN PVOID Object, IN PSECURITY_INFORMATION SecurityInformation, IN OUT PSECURITY_DESCRIPTOR SecurityDescriptor, IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN PGENERIC_MAPPING GenericMapping)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d1/obse_8c.html#a14">ObpValidateAccessMask</a> (<a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="obse.c::NtQuerySecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtQuerySecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LengthNeeded</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00255">255</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00138">SeQuerySecurityAccessMask()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d5/d0/rtdmpsec_8c-source.html#l00283">DumpSecurity()</a>, and <a class="el" href="../../d4/d7/client_8c-source.html#l01837">GetUserObjectSecurity()</a>.
<p>
<pre class="fragment"><div>00265                    :
00266 
00267     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <span class="keywordflow">for</span> an
00268     object.
00269 
00270 Arguments:
00271 
00272     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being investigated
00273 
00274     SecurityInformation - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information we are
00275         interested in getting. e.g., owner, group, dacl, or sacl.
00276 
00277     SecurityDescriptor - Supplies a pointer to where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00278         should be returned
00279 
00280     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer
00281 
00282     LengthNeeded - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, needed to store
00283         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output security descriptor
00284 
00285 Return Value:
00286 
00287     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00288 
00289 --*/
00290 
00291 {
00292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00293     PVOID Object;
00294     ACCESS_MASK DesiredAccess;
00295     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00296     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode;
00297     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00298     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00299 
00300     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">//  Probe output parameters</span>
00304     <span class="comment">//</span>
00305 
00306     RequestorMode = KeGetPreviousMode();
00307 
00308     <span class="keywordflow">if</span> (RequestorMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00309 
00310         <span class="keywordflow">try</span> {
00311 
00312             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( LengthNeeded );
00313 
00314             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( SecurityDescriptor, Length, <span class="keyword">sizeof</span>(ULONG) );
00315 
00316         } except(EXCEPTION_EXECUTE_HANDLER) {
00317 
00318             <span class="keywordflow">return</span> GetExceptionCode();
00319         }
00320     }
00321 
00322     <span class="comment">//</span>
00323     <span class="comment">//  Establish the accesses needed to the object based upon the</span>
00324     <span class="comment">//  security information being queried</span>
00325     <span class="comment">//</span>
00326 
00327     <a class="code" href="../../d0/d6/semethod_8c.html#a2">SeQuerySecurityAccessMask</a>( SecurityInformation, &amp;DesiredAccess );
00328 
00329     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00330                                         DesiredAccess,
00331                                         NULL,
00332                                         RequestorMode,
00333                                         &amp;Object,
00334                                         &amp;HandleInformation );
00335 
00336     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00337 
00338         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00339     }
00340 
00341     <span class="comment">//</span>
00342     <span class="comment">//  Map the object body to an object header and the corresponding</span>
00343     <span class="comment">//  object type</span>
00344     <span class="comment">//</span>
00345 
00346     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00347     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00348 
00349     <span class="comment">//</span>
00350     <span class="comment">//  Invoke the object type's security callback routine to query</span>
00351     <span class="comment">//  the object.  This routine is assumed to have a try-except around</span>
00352     <span class="comment">//  the setting of the output security descriptor</span>
00353     <span class="comment">//</span>
00354 
00355     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
00356                                                        <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
00357                                                        &amp;SecurityInformation,
00358                                                        SecurityDescriptor,
00359                                                        &amp;Length,
00360                                                        &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
00361                                                        ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00362                                                        &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">//  Indicate the length needed for the security descriptor.  This</span>
00366     <span class="comment">//  will be set even if the callback failed so the caller will know</span>
00367     <span class="comment">//  the number of bytes necessary</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">try</span> {
00371 
00372         *LengthNeeded = Length;
00373 
00374     } except(EXCEPTION_EXECUTE_HANDLER) {
00375 
00376         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00377 
00378         <span class="keywordflow">return</span>(GetExceptionCode());
00379     }
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">//  And return to our caller</span>
00383     <span class="comment">//</span>
00384 
00385     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00386 
00387     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="obse.c::NtSetSecurityObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetSecurityObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00046">46</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00174">ObSetSecurityObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00053">SeCaptureSecurityDescriptor()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l00631">SeReleaseSecurityDescriptor()</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00078">SeSetSecurityAccessMask()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00048">main()</a>, and <a class="el" href="../../d4/d7/client_8c-source.html#l01868">SetUserObjectSecurity()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to invoke an object's security routine.  It
00057     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security state.
00058 
00059 Arguments:
00060 
00061     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being modified
00062 
00063     SecurityInformation - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information we are
00064         interested in setting. e.g., owner, group, dacl, or sacl.
00065 
00066     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00067         object being modified.
00068 
00069 Return Value:
00070 
00071     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00072 
00073 --*/
00074 
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00077     PVOID Object;
00078     ACCESS_MASK DesiredAccess;
00079     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00080     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> RequestorMode;
00081     SECURITY_DESCRIPTOR_RELATIVE *CapturedDescriptor;
00082 
00083     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">//  Make sure the passed security descriptor is really there.</span>
00087     <span class="comment">//  SeCaptureSecurityDescriptor doesn't mind being passed a NULL</span>
00088     <span class="comment">//  SecurityDescriptor, and will just return NULL back.</span>
00089     <span class="comment">//</span>
00090 
00091     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( SecurityDescriptor )) {
00092 
00093         <span class="keywordflow">return</span>( STATUS_ACCESS_VIOLATION );
00094     }
00095 
00096     <span class="comment">//</span>
00097     <span class="comment">//  Establish the accesses needed to the object based upon the</span>
00098     <span class="comment">//  security information being modified.</span>
00099     <span class="comment">//</span>
00100 
00101     <a class="code" href="../../d0/d6/semethod_8c.html#a1">SeSetSecurityAccessMask</a>( SecurityInformation, &amp;DesiredAccess );
00102 
00103     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00104                                         DesiredAccess,
00105                                         NULL,
00106                                         RequestorMode = KeGetPreviousMode(),
00107                                         &amp;Object,
00108                                         &amp;HandleInformation );
00109 
00110     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00111 
00112         <span class="comment">//</span>
00113         <span class="comment">//  Probe and capture the input security descriptor, and return</span>
00114         <span class="comment">//  right away if it is ill-formed.</span>
00115         <span class="comment">//</span>
00116         <span class="comment">//  Because the security descriptor is always captured the returned</span>
00117         <span class="comment">//  security descriptor is in self-relative format.</span>
00118         <span class="comment">//</span>
00119 
00120         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>( SecurityDescriptor,
00121                                               RequestorMode,
00122                                               PagedPool,
00123                                               TRUE,
00124                                               (PSECURITY_DESCRIPTOR *)&amp;CapturedDescriptor );
00125 
00126         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">//  Now check for a valid combination of what the user wants to set</span>
00130             <span class="comment">//  and what was supplied in the input security descriptor.  If the</span>
00131             <span class="comment">//  caller wants to set the owner then the owner field of the</span>
00132             <span class="comment">//  security descriptor better not be null, likewise for the group</span>
00133             <span class="comment">//  setting.  If anything is missing we'll return and error.</span>
00134             <span class="comment">//</span>
00135 
00136             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(CapturedDescriptor-&gt;Control &amp; SE_SELF_RELATIVE);
00137 
00138             <span class="keywordflow">if</span> (((SecurityInformation &amp; OWNER_SECURITY_INFORMATION) &amp;&amp;
00139                 (CapturedDescriptor-&gt;Owner == 0))
00140 
00141                 ||
00142 
00143                 ((SecurityInformation &amp; GROUP_SECURITY_INFORMATION) &amp;&amp;
00144                 (CapturedDescriptor-&gt;Group == 0))) {
00145 
00146                 <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR)CapturedDescriptor,
00147                                              RequestorMode,
00148                                              TRUE );
00149 
00150                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00151 
00152                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00153                 <span class="keywordflow">return</span>( STATUS_INVALID_SECURITY_DESCR );
00154             }
00155 
00156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a>( Object,
00157                                                    SecurityInformation,
00158                                                    CapturedDescriptor );
00159 
00160             <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR)CapturedDescriptor,
00161                                          RequestorMode,
00162                                          TRUE );
00163         }
00164 
00165         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00166 
00167     }
00168 
00169     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00170 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obse.c::ObAssignObjectSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObAssignObjectSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR SecurityDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">1183</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/cmse_8c-source.html#l00158">CmpSecurityMethod()</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">SeDefaultObjectMethod()</a>, <a class="el" href="../../d5/d2/token_8c-source.html#l01010">SeMakeAnonymousLogonToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l00536">SeMakeSystemToken()</a>.
<p>
<pre class="fragment"><div>01191                    :
01192 
01193     Takes a pointer to an object and sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor field
01194     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's header.
01195 
01196 Arguments:
01197 
01198     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01199 
01200     SecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01201         to be assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.  This pointer may be null <span class="keywordflow">if</span> there
01202         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no security on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01203 
01204     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> memory used to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01205         security descriptor.  This field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently ignored.
01206 
01207 Return Value:
01208 
01209     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value.
01210 
01211 --*/
01212 
01213 {
01214     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01215     PSECURITY_DESCRIPTOR OutputSecurityDescriptor;
01216 
01217     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">//  If the security descriptor isn't supplied then we set the</span>
01221     <span class="comment">//  object header's security descriptor to null and return</span>
01222     <span class="comment">//  to our caller</span>
01223     <span class="comment">//</span>
01224 
01225     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(SecurityDescriptor)) {
01226 
01227         <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01228 
01229         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01230     }
01231 
01232     <span class="comment">//</span>
01233     <span class="comment">//  Log the new security descriptor into our security database and</span>
01234     <span class="comment">//  get back the real security descriptor to use</span>
01235     <span class="comment">//</span>
01236 
01237     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d1/obsdata_8c.html#a16">ObpLogSecurityDescriptor</a>( SecurityDescriptor, &amp;OutputSecurityDescriptor );
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">//  If we've been successful so far then set the object's</span>
01241     <span class="comment">//  security descriptor to the newly allocated one.</span>
01242     <span class="comment">//</span>
01243 
01244     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01245 
01246         <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor = OutputSecurityDescriptor;
01247     }
01248 
01249     <span class="comment">//</span>
01250     <span class="comment">//  And return to our caller</span>
01251     <span class="comment">//</span>
01252 
01253     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01254 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obse.c::ObAssignSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObAssignSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR ParentDescriptor&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">1574</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">ObpDirectoryObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00089">SeAssignSecurity()</a>, <a class="el" href="../../d2/d4/seassign_8c-source.html#l00373">SeDeassignSecurity()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l01343">xxxCreateDesktop2()</a>.
<p>
<pre class="fragment"><div>01583                    :
01584 
01585     This routine will assign a security descriptor to a newly created object.
01586     It assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState parameter contains a captured security
01587     descriptor.
01588 
01589 Arguments:
01590 
01591      AccessState - The AccessState containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security information
01592         <span class="keywordflow">for</span> <span class="keyword">this</span> object creation.
01593 
01594      ParentDescriptor - The security descriptor from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent object, <span class="keywordflow">if</span>
01595         available.
01596 
01597      Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being created.
01598 
01599      ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of object being created.
01600 
01601 Return Value:
01602 
01603     STATUS_SUCCESS - indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation was successful.
01604 
01605     STATUS_INVALID_OWNER - The owner SID provided as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01606         target security descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not one <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> authorized
01607         to assign as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owner of an object.
01608 
01609     STATUS_PRIVILEGE_NOT_HELD - The caller does not have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privilege
01610         necessary to explicitly assign <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified system ACL.
01611         <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a> privilege <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed to explicitly assign
01612         system ACLs to objects.
01613 
01614 --*/
01615 
01616 {
01617     PSECURITY_DESCRIPTOR NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01618     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01619     KIRQL SaveIrql;
01620 
01621     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01622 
01623     <span class="comment">//</span>
01624     <span class="comment">//  SeAssignSecurity will construct the final version</span>
01625     <span class="comment">//  of the security  descriptor</span>
01626     <span class="comment">//</span>
01627 
01628     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d5/seassign_8c.html#a1">SeAssignSecurity</a>( ParentDescriptor,
01629                                AccessState-&gt;SecurityDescriptor,
01630                                &amp;NewDescriptor,
01631                                (BOOLEAN)(ObjectType == ObpDirectoryObjectType),
01632                                &amp;AccessState-&gt;SubjectSecurityContext,
01633                                &amp;ObjectType-&gt;TypeInfo.GenericMapping,
01634                                PagedPool );
01635 
01636     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01637 
01638         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01639     }
01640 
01641     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">//  Now invoke the security method callback to finish</span>
01645     <span class="comment">//  the assignment.</span>
01646     <span class="comment">//</span>
01647 
01648     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;TypeInfo.SecurityProcedure)( Object,
01649                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a111">AssignSecurityDescriptor</a>,
01650                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01651                                                         NewDescriptor,
01652                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01653                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01654                                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01655                                                         &amp;ObjectType-&gt;TypeInfo.GenericMapping );
01656 
01657     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01658 
01659     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">// The attempt to assign the security descriptor to the object</span>
01663         <span class="comment">// failed.  Free the space used by the new security descriptor.</span>
01664         <span class="comment">//</span>
01665 
01666         <a class="code" href="../../d1/d5/seassign_8c.html#a3">SeDeassignSecurity</a>( &amp;NewDescriptor );
01667     }
01668 
01669     <span class="comment">//</span>
01670     <span class="comment">//  And return to our caller</span>
01671     <span class="comment">//</span>
01672 
01673     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01674 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obse.c::ObCheckCreateObjectAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObCheckCreateObjectAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>CreateAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ComponentName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">983</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03538">SeCreateObjectAuditAlarm()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, and <a class="el" href="../../d0/d6/desktop_8c-source.html#l01343">xxxCreateDesktop2()</a>.
<p>
<pre class="fragment"><div>00995                    :
00996 
00997     This routine checks to see <span class="keywordflow">if</span> we are allowed to create an object in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00998     given directory, and performs auditing as appropriate.
00999 
01000 Arguments:
01001 
01002     DirectoryObject - The directory object being examined.
01003 
01004     CreateAccess - The access mask corresponding to create access <span class="keywordflow">for</span>
01005         <span class="keyword">this</span> directory <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
01006 
01007     AccessState - Checks <span class="keywordflow">for</span> traverse access will typically be incidental
01008         to some other access attempt.  Information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of
01009         that access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constituent access
01010         attempts may be associated with each other in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit log.
01011 
01012     ComponentName - Pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of
01013         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being created.
01014 
01015     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
01016         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
01017         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
01018 
01019     PreviousMode - The previous processor mode.
01020 
01021     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01022         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
01023         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
01024 
01025 Return Value:
01026 
01027     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  AccessStatus
01028     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
01029     correct to simply pass back STATUS_ACCESS_DENIED, since <span class="keyword">this</span> will have
01030     to change with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> advent of mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
01031 
01032 --*/
01033 
01034 {
01035     BOOLEAN AccessAllowed;
01036     ACCESS_MASK GrantedAccess = 0;
01037     PSECURITY_DESCRIPTOR SecurityDescriptor;
01038     BOOLEAN MemoryAllocated;
01039     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01040     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01041     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01042     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01043     BOOLEAN AuditPerformed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01044 
01045     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">//  Map the object body to its object header and corresponding</span>
01049     <span class="comment">//  object type</span>
01050     <span class="comment">//</span>
01051 
01052     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryObject );
01053     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  If the caller didn't lock the object type down then</span>
01057     <span class="comment">//  we'll do it now</span>
01058     <span class="comment">//</span>
01059 
01060     <span class="keywordflow">if</span> (!TypeMutexLocked) {
01061 
01062         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01063     }
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">//  Obtain the object's security descriptor and make it was</span>
01067     <span class="comment">//  successful</span>
01068     <span class="comment">//</span>
01069 
01070     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( DirectoryObject,
01071                                   &amp;SecurityDescriptor,
01072                                   &amp;MemoryAllocated );
01073 
01074     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01075 
01076         <span class="keywordflow">if</span> (!TypeMutexLocked) {
01077 
01078             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01079         }
01080 
01081         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01082 
01083         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01084     }
01085 
01086     <span class="comment">//</span>
01087     <span class="comment">//  lock the caller's tokens until after auditing has been</span>
01088     <span class="comment">//  performed.</span>
01089     <span class="comment">//</span>
01090 
01091     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01092 
01093     <span class="comment">//</span>
01094     <span class="comment">//  if we have a security descriptor then do an access</span>
01095     <span class="comment">//  check to see if access is allowed and set in the</span>
01096     <span class="comment">//  privileges if necessary</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01100 
01101         AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
01102                                        &amp;AccessState-&gt;SubjectSecurityContext,
01103                                        TRUE,            <span class="comment">// Tokens are locked</span>
01104                                        CreateAccess,
01105                                        0,
01106                                        &amp;Privileges,
01107                                        &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
01108                                        PreviousMode,
01109                                        &amp;GrantedAccess,
01110                                        AccessStatus );
01111 
01112         <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01113 
01114             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
01115                                          Privileges );
01116 
01117             <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
01118         }
01119 
01120         <span class="comment">//</span>
01121         <span class="comment">//  This is wrong, but leave for reference.</span>
01122         <span class="comment">//</span>
01123         <span class="comment">//  if (AccessAllowed) {</span>
01124         <span class="comment">//</span>
01125         <span class="comment">//      AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;</span>
01126         <span class="comment">//      AccessState-&gt;RemainingDesiredAccess &amp;= ~GrantedAccess;</span>
01127         <span class="comment">//  }</span>
01128         <span class="comment">//</span>
01129 
01130 <span class="preprocessor">#if 0</span>
01131 <span class="preprocessor"></span>        <a class="code" href="../../d3/d5/seaudit_8c.html#a26">SeCreateObjectAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
01132                                   DirectoryObject,
01133                                   ComponentName,
01134                                   SecurityDescriptor,
01135                                   &amp;AccessState-&gt;SubjectSecurityContext,
01136                                   CreateAccess,
01137                                   AccessState-&gt;PrivilegesUsed,
01138                                   AccessAllowed,
01139                                   &amp;AuditPerformed,
01140                                   PreviousMode );
01141 
01142         <span class="keywordflow">if</span> ( AuditPerformed ) {
01143 
01144             AccessState-&gt;AuditHandleCreation = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01145         }
01146 <span class="preprocessor">#endif</span>
01147 <span class="preprocessor"></span>
01148     } <span class="keywordflow">else</span> {
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">//  At this point there is not a security descriptor</span>
01152         <span class="comment">//  so we'll assume access is allowed</span>
01153         <span class="comment">//</span>
01154 
01155         AccessAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01156     }
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">//  Free the caller's token and if the caller didn't have the</span>
01160     <span class="comment">//  object type locked we need to free it.</span>
01161     <span class="comment">//</span>
01162 
01163     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
01164 
01165     <span class="keywordflow">if</span> (!TypeMutexLocked) {
01166 
01167         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01168     }
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">//  Finally free the security descriptor</span>
01172     <span class="comment">//  and return to our caller</span>
01173     <span class="comment">//</span>
01174 
01175     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
01176                              MemoryAllocated );
01177 
01178     <span class="keywordflow">return</span>( AccessAllowed );
01179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obse.c::ObCheckObjectAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObCheckObjectAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">392</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00189">_OBJECT_TYPE::Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l02765">SeOpenObjectAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/w32_2ntuser_2kernel_2security_8c-source.html#l00555">AccessCheckObject()</a>, <a class="el" href="../../d3/d1/cmparse_8c-source.html#l00963">CmpDoOpen()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>.
<p>
<pre class="fragment"><div>00402                    :
00403 
00404     This routine performs access validation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed object.  The
00405     remaining desired access mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> extracted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState
00406     parameter and passes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate security routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00407     access check.
00408 
00409     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a> returns a mask
00410     containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted accesses.  The bits in <span class="keyword">this</span> mask are turned
00411     on in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviouslyGrantedAccess field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState, and
00412     are turned off in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RemainingDesiredAccess field.
00413 
00414 Arguments:
00415 
00416     Object - The object being examined.
00417 
00418     AccessState - The <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> structure containing accumulated
00419         information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current attempt to gain access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00420 
00421     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
00422         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
00423         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
00424 
00425     AccessMode - The previous processor mode.
00426 
00427     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00428         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00429         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00430 
00431 
00432 Return Value:
00433 
00434     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00435 
00436 --*/
00437 
00438 {
00439     ACCESS_MASK GrantedAccess = 0;
00440     BOOLEAN AccessAllowed;
00441     BOOLEAN MemoryAllocated;
00442     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00443     PSECURITY_DESCRIPTOR SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00444     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00445     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00446     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00447 
00448     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  Map the object body to an object header and the</span>
00452     <span class="comment">//  corresponding object type</span>
00453     <span class="comment">//</span>
00454 
00455     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00456     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">//  If the caller does not have the object type locked</span>
00460     <span class="comment">//  then lock it down</span>
00461     <span class="comment">//</span>
00462 
00463     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00464 
00465         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00466     }
00467 
00468     <span class="comment">//</span>
00469     <span class="comment">//  Obtain the object's security descriptor</span>
00470     <span class="comment">//</span>
00471 
00472     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( Object,
00473                                   &amp;SecurityDescriptor,
00474                                   &amp;MemoryAllocated );
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">//  If we failed in getting the security descriptor then</span>
00478     <span class="comment">//  put the object type lock back where it was and return</span>
00479     <span class="comment">//  the error back to our caller</span>
00480     <span class="comment">//</span>
00481 
00482     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00483 
00484         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00485 
00486             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00487         }
00488 
00489         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00490 
00491         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00492 
00493     } <span class="keywordflow">else</span> {
00494 
00495         <span class="comment">//</span>
00496         <span class="comment">//  Otherwise we've been successful at getting the</span>
00497         <span class="comment">//  object's security descriptor, but now make sure</span>
00498         <span class="comment">//  it is not null.</span>
00499 
00500         <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00501 
00502             <span class="keywordflow">if</span> (!TypeMutexLocked) {
00503 
00504                 <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00505             }
00506 
00507             *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00508 
00509             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00510         }
00511     }
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">//  We have a non-null security descriptor so now</span>
00515     <span class="comment">//  lock the caller's tokens until after auditing has been</span>
00516     <span class="comment">//  performed.</span>
00517     <span class="comment">//</span>
00518 
00519     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00520 
00521     <span class="comment">//</span>
00522     <span class="comment">//  Do the access check, and if we have some privileges then</span>
00523     <span class="comment">//  put those in the access state too.</span>
00524     <span class="comment">//</span>
00525 
00526     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00527                                    &amp;AccessState-&gt;SubjectSecurityContext,
00528                                    TRUE,                        <span class="comment">// Tokens are locked</span>
00529                                    AccessState-&gt;RemainingDesiredAccess,
00530                                    AccessState-&gt;PreviouslyGrantedAccess,
00531                                    &amp;Privileges,
00532                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00533                                    AccessMode,
00534                                    &amp;GrantedAccess,
00535                                    AccessStatus );
00536 
00537     <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538 
00539         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00540                                      Privileges );
00541 
00542         <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
00543     }
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">//  If we were granted access then set that fact into</span>
00547     <span class="comment">//  what we've been granted and remove it from what remains</span>
00548     <span class="comment">//  to be granted.</span>
00549     <span class="comment">//</span>
00550 
00551     <span class="keywordflow">if</span> (AccessAllowed) {
00552 
00553         AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;
00554         AccessState-&gt;RemainingDesiredAccess &amp;= ~(GrantedAccess | MAXIMUM_ALLOWED);
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">//  Audit the attempt to open the object, audit</span>
00559     <span class="comment">//  the creation of its handle later.</span>
00560     <span class="comment">//</span>
00561     <span class="comment">//  **** SecurityDescriptor cannot be null</span>
00562     <span class="comment">//</span>
00563 
00564     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00565 
00566         <a class="code" href="../../d3/d5/seaudit_8c.html#a23">SeOpenObjectAuditAlarm</a>( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>,
00567                                 Object,
00568                                 NULL,                    <span class="comment">// AbsoluteObjectName</span>
00569                                 SecurityDescriptor,
00570                                 AccessState,
00571                                 FALSE,                   <span class="comment">// ObjectCreated (FALSE, only open here)</span>
00572                                 AccessAllowed,
00573                                 AccessMode,
00574                                 &amp;AccessState-&gt;GenerateOnClose );
00575     }
00576 
00577     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">//  If the caller didn't lock the object type then we have to</span>
00581     <span class="comment">//  remove our lock on it.</span>
00582     <span class="comment">//</span>
00583 
00584     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00585 
00586         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00587     }
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">//  Free the security descriptor before returning to</span>
00591     <span class="comment">//  our caller</span>
00592     <span class="comment">//</span>
00593 
00594     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00595                              MemoryAllocated );
00596 
00597     <span class="keywordflow">return</span>( AccessAllowed );
00598 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obse.c::ObGetObjectSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObGetObjectSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryAllocated</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">1258</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00221">ObpCentralizedSecurity</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>.
<p>
<pre class="fragment"><div>01266                    :
01267 
01268     Given an object, <span class="keyword">this</span> routine will find its security descriptor.
01269     It will <span class="keywordflow">do</span> <span class="keyword">this</span> by calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security method.
01270 
01271     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible <span class="keywordflow">for</span> an object not to have a security descriptor
01272     at all.  Unnamed objects such as events that can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be referenced
01273     by a handle are an example of an object that does not have a
01274     security descriptor.
01275 
01276 Arguments:
01277 
01278     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body being queried.
01279 
01280     SecurityDescriptor - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security
01281         descriptor.
01282 
01283     MemoryAllocated - indicates whether we had to allocate <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
01284         memory to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor or not.  This should
01285         be passed back into <a class="code" href="../../d4/d0/ob_8h.html#a92">ObReleaseObjectSecurity</a>.
01286 
01287 Return Value:
01288 
01289     STATUS_SUCCESS - The operation was successful.  Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01290         operation may be successful and still <span class="keywordflow">return</span> a <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> security
01291         descriptor.
01292 
01293     STATUS_INSUFFICIENT_RESOURCES - Insufficient memory was available
01294         to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
01295 
01296 --*/
01297 
01298 {
01299     SECURITY_INFORMATION SecurityInformation;
01300     ULONG Length = 0;
01301     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01302     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01303     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01304     KIRQL SaveIrql;
01305 
01306     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01307 
01308     <span class="comment">//</span>
01309     <span class="comment">//  Map the object body to its object header and corresponding</span>
01310     <span class="comment">//  object type</span>
01311     <span class="comment">//</span>
01312 
01313     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01314     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">//  If the object is one that uses the default object method,</span>
01318     <span class="comment">//  its security descriptor is contained in ob's security</span>
01319     <span class="comment">//  descriptor cache.</span>
01320     <span class="comment">//</span>
01321     <span class="comment">//  Reference it so that it doesn't go away out from under us.</span>
01322     <span class="comment">//</span>
01323 
01324     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/obp_8h.html#a13">ObpCentralizedSecurity</a>(ObjectType))  {
01325 
01326         *SecurityDescriptor = <a class="code" href="../../d8/d1/obsdata_8c.html#a18">ObpReferenceSecurityDescriptor</a>( Object );
01327 
01328         *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01329 
01330         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01331     }
01332 
01333     <span class="comment">//</span>
01334     <span class="comment">//  Request a complete security descriptor</span>
01335     <span class="comment">//</span>
01336 
01337     SecurityInformation = OWNER_SECURITY_INFORMATION |
01338                           GROUP_SECURITY_INFORMATION |
01339                           DACL_SECURITY_INFORMATION  |
01340                           SACL_SECURITY_INFORMATION;
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">//  Call the security method with Length = 0 to find out</span>
01344     <span class="comment">//  how much memory we need to store the final result.</span>
01345     <span class="comment">//</span>
01346     <span class="comment">//  Note that the ObjectsSecurityDescriptor parameter is NULL,</span>
01347     <span class="comment">//  because we expect whoever is on the other end of this call</span>
01348     <span class="comment">//  to find the security descriptor for us.  We pass in a pool</span>
01349     <span class="comment">//  type to keep the compiler happy, it will not be used for a</span>
01350     <span class="comment">//  query operation.</span>
01351     <span class="comment">//</span>
01352 
01353 
01354     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01355 
01356     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01357                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
01358                                                         &amp;SecurityInformation,
01359                                                         *SecurityDescriptor,
01360                                                         &amp;Length,
01361                                                         &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,         <span class="comment">// not used</span>
01362                                                         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01363                                                         &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01364 
01365     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01366 
01367     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
01368 
01369         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01370     }
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">//  Now that we know how large the security descriptor is we</span>
01374     <span class="comment">//  can allocate space for it</span>
01375     <span class="comment">//</span>
01376 
01377     *SecurityDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, Length, 'qSbO' );
01378 
01379     <span class="keywordflow">if</span> (*SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01380 
01381         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
01382     }
01383 
01384     *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">//  The security method will return an absolute format</span>
01388     <span class="comment">//  security descriptor that just happens to be in a self</span>
01389     <span class="comment">//  contained buffer (not to be confused with a self-relative</span>
01390     <span class="comment">//  security descriptor).</span>
01391     <span class="comment">//</span>
01392 
01393     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01394 
01395     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01396                                                         <a class="code" href="../../d0/d5/se_8h.html#a200a109">QuerySecurityDescriptor</a>,
01397                                                         &amp;SecurityInformation,
01398                                                         *SecurityDescriptor,
01399                                                         &amp;Length,
01400                                                         &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01401                                                         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01402                                                         &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01403 
01404     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01405 
01406     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01407 
01408         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( *SecurityDescriptor );
01409 
01410         *MemoryAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01411     }
01412 
01413     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01414 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obse.c::ObpCheckObjectReference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCheckObjectReference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">602</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03660">SeObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.
<p>
<pre class="fragment"><div>00612                    :
00613 
00614     The routine performs access validation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed object.  The
00615     remaining desired access mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> extracted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState
00616     parameter and passes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate security routine to
00617     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
00618 
00619     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a> returns a mask
00620     containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted accesses.  The bits in <span class="keyword">this</span> mask are turned
00621     on in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviouslyGrantedAccess field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState, and
00622     are turned off in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RemainingDesiredAccess field.
00623 
00624     This routine differs from ObpCheckObjectAccess in that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> calls
00625     a different audit routine.
00626 
00627 Arguments:
00628 
00629     Object - The object being examined.
00630 
00631     AccessState - The <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> structure containing accumulated
00632         information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current attempt to gain access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00633 
00634     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
00635         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
00636         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
00637 
00638     AccessMode - The previous processor mode.
00639 
00640     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00641         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00642         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00643 
00644 
00645 Return Value:
00646 
00647     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00648 
00649 --*/
00650 
00651 {
00652     BOOLEAN AccessAllowed;
00653     ACCESS_MASK GrantedAccess = 0;
00654     BOOLEAN MemoryAllocated;
00655     PSECURITY_DESCRIPTOR SecurityDescriptor;
00656     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00657     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00658     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00659     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660 
00661     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00662 
00663     <span class="comment">//</span>
00664     <span class="comment">//  Map the object body to an object header and the</span>
00665     <span class="comment">//  corresponding object type</span>
00666     <span class="comment">//</span>
00667 
00668     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00669     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">//  If the caller does not have the object type locked</span>
00673     <span class="comment">//  then lock it down</span>
00674     <span class="comment">//</span>
00675 
00676     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00677 
00678         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00679     }
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">//  Obtain the object's security descriptor</span>
00683     <span class="comment">//</span>
00684 
00685     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( Object,
00686                                   &amp;SecurityDescriptor,
00687                                   &amp;MemoryAllocated );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  If we failed in getting the security descriptor then</span>
00691     <span class="comment">//  put the object type lock back where it was and return</span>
00692     <span class="comment">//  the error back to our caller</span>
00693     <span class="comment">//</span>
00694 
00695     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00696 
00697         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00698 
00699             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00700         }
00701 
00702         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00703 
00704         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00705     }
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  Lock the caller's tokens until after auditing has been</span>
00709     <span class="comment">//  performed.</span>
00710     <span class="comment">//</span>
00711 
00712     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">//  Do the access check, and if we have some privileges then</span>
00716     <span class="comment">//  put those in the access state too.</span>
00717     <span class="comment">//</span>
00718 
00719     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00720                                    &amp;AccessState-&gt;SubjectSecurityContext,
00721                                    TRUE,               <span class="comment">// Tokens are locked</span>
00722                                    AccessState-&gt;RemainingDesiredAccess,
00723                                    AccessState-&gt;PreviouslyGrantedAccess,
00724                                    &amp;Privileges,
00725                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00726                                    AccessMode,
00727                                    &amp;GrantedAccess,
00728                                    AccessStatus );
00729 
00730     <span class="keywordflow">if</span> (AccessAllowed) {
00731 
00732         AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;
00733         AccessState-&gt;RemainingDesiredAccess &amp;= ~GrantedAccess;
00734     }
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">//  If we have a security descriptor then call the security routine</span>
00738     <span class="comment">//  to audit this reference and then unlock the caller's token</span>
00739     <span class="comment">//</span>
00740 
00741     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00742 
00743         <a class="code" href="../../d3/d5/seaudit_8c.html#a27">SeObjectReferenceAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
00744                                      Object,
00745                                      SecurityDescriptor,
00746                                      &amp;AccessState-&gt;SubjectSecurityContext,
00747                                      AccessState-&gt;RemainingDesiredAccess | AccessState-&gt;PreviouslyGrantedAccess,
00748                                      ((<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)(AccessState-&gt;AuxData))-&gt;PrivilegesUsed,
00749                                      AccessAllowed,
00750                                      AccessMode );
00751     }
00752 
00753     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">//  If the caller didn't have the object type locked then remove</span>
00757     <span class="comment">//  our lock</span>
00758     <span class="comment">//</span>
00759 
00760     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00761 
00762         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Finally free the security descriptor</span>
00767     <span class="comment">//  and return to our caller</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00771                              MemoryAllocated );
00772 
00773     <span class="keywordflow">return</span>( AccessAllowed );
00774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obse.c::ObpCheckTraverseAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCheckTraverseAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>TraverseAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">778</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">SeFastTraverseCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>.
<p>
<pre class="fragment"><div>00789                    :
00790 
00791     This routine checks <span class="keywordflow">for</span> traverse access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given directory object.
00792 
00793     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState structure are not
00794     modified, since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <span class="keyword">this</span> access check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incidental
00795     to another access operation.
00796 
00797 Arguments:
00798 
00799     DirectoryObject - The object body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being examined.
00800 
00801     TraverseAccess - The desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object, most likely DIRECTORY
00802         TRAVERSE access.
00803 
00804     AccessState - Checks <span class="keywordflow">for</span> traverse access will typically be incidental
00805         to some other access attempt.  Information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of
00806         that access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constituent access
00807         attempts may be associated with each other in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit log.
00808         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an OPTIONAL parameter, in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call will
00809         success ONLY <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Object grants World traverse
00810         access rights.
00811 
00812     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
00813         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
00814         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
00815 
00816     PreviousMode - The previous processor mode.
00817 
00818     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00819         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00820         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00821 
00822 Return Value:
00823 
00824     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  AccessStatus
00825     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00826     correct to simply pass back STATUS_ACCESS_DENIED, since <span class="keyword">this</span> will have
00827     to change with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> advent of mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00828 
00829 --*/
00830 
00831 {
00832     BOOLEAN AccessAllowed;
00833     ACCESS_MASK GrantedAccess = 0;
00834     PSECURITY_DESCRIPTOR SecurityDescriptor;
00835     BOOLEAN MemoryAllocated;
00836     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00837     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00838     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00839     BOOLEAN SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00840     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841 
00842     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00843 
00844     <span class="comment">//</span>
00845     <span class="comment">//  Map the object body to an object header and corresponding</span>
00846     <span class="comment">//  object type</span>
00847     <span class="comment">//</span>
00848 
00849     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryObject );
00850     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">//  If the caller hasn't locked down the object type then</span>
00854     <span class="comment">//  lock it down now</span>
00855     <span class="comment">//</span>
00856 
00857     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00858 
00859         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00860     }
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">//  Obtain the object's security descriptor and make it was</span>
00864     <span class="comment">//  successful</span>
00865     <span class="comment">//</span>
00866 
00867     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( DirectoryObject,
00868                                   &amp;SecurityDescriptor,
00869                                   &amp;MemoryAllocated );
00870 
00871     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00872 
00873         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00874 
00875             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00876         }
00877 
00878         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00879 
00880         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00881     }
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">//  Check to see if WORLD has TRAVERSE access, by seeing if the</span>
00885     <span class="comment">//  token is restricted or the fast traverse check fails meaning</span>
00886     <span class="comment">//  that the world does not have traverse access</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (((AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0)
00890 
00891         ||
00892 
00893         (!<a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( SecurityDescriptor,
00894                                DIRECTORY_TRAVERSE,
00895                                PreviousMode ))) {
00896 
00897         <span class="comment">//</span>
00898         <span class="comment">//  SeFastTraverseCheck could be modified to tell us that</span>
00899         <span class="comment">//  no one has any access to this directory.  However,</span>
00900         <span class="comment">//  we're going to have to fail this entire call if</span>
00901         <span class="comment">//  that is the case, so we really don't need to worry</span>
00902         <span class="comment">//  all that much about making it blindingly fast.</span>
00903         <span class="comment">//</span>
00904 
00905         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AccessState )) {
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">//  The world does not have traverse access and we have</span>
00909             <span class="comment">//  the client's access state so lock down the client's</span>
00910             <span class="comment">//  token and then do the access check, appending privileges</span>
00911             <span class="comment">//  if present.  The access check will give the answer</span>
00912             <span class="comment">//  we return back to our caller</span>
00913             <span class="comment">//</span>
00914 
00915             <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00916 
00917             SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00918 
00919             AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00920                                            &amp;AccessState-&gt;SubjectSecurityContext,
00921                                            TRUE,             <span class="comment">// Tokens are locked</span>
00922                                            TraverseAccess,
00923                                            0,
00924                                            &amp;Privileges,
00925                                            &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00926                                            PreviousMode,
00927                                            &amp;GrantedAccess,
00928                                            AccessStatus );
00929 
00930             <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00931 
00932                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00933                                              Privileges );
00934 
00935                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
00936             }
00937         }
00938 
00939     } <span class="keywordflow">else</span> {
00940 
00941         <span class="comment">//</span>
00942         <span class="comment">//  At this point the world has traverse access</span>
00943         <span class="comment">//</span>
00944 
00945         AccessAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">//  If the client's token is locked then now we can unlock it</span>
00950     <span class="comment">//</span>
00951     <span class="comment">//  **** this should be able to move up into the preceding clause</span>
00952     <span class="comment">//  where it is locked</span>
00953     <span class="comment">//</span>
00954 
00955     <span class="keywordflow">if</span> ( SubjectContextLocked ) {
00956 
00957         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00958     }
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">//  If the caller did not lock the object type then we</span>
00962     <span class="comment">//  now need to unlock it</span>
00963     <span class="comment">//</span>
00964 
00965     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00966 
00967         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00968     }
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">//  Finally free the security descriptor</span>
00972     <span class="comment">//  and then return to our caller</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00976                              MemoryAllocated );
00977 
00978     <span class="keywordflow">return</span>( AccessAllowed );
00979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="obse.c::ObpValidateAccessMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpValidateAccessMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AccessState</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01886">1886</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00171">_ACCESS_STATE::PreviouslyGrantedAccess</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00170">_ACCESS_STATE::RemainingDesiredAccess</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00174">_ACCESS_STATE::SecurityDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>.
<p>
<pre class="fragment"><div>01892                    :
01893 
01894     Checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask of a passed object against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01895     passed security descriptor.
01896 
01897 Arguments:
01898 
01899     AccessState - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pending operation.
01900 
01901 Return Value:
01902 
01903     Only returns STATUS_SUCCESS
01904 
01905 --*/
01906 
01907 {
01908     SECURITY_DESCRIPTOR *SecurityDescriptor = AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o10">SecurityDescriptor</a>;
01909 
01910     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01911 
01912     <span class="comment">//</span>
01913     <span class="comment">//  First make sure the access state has a security descriptor.  If there</span>
01914     <span class="comment">//  is one and it has a system acl and the previously granted access did</span>
01915     <span class="comment">//  not include system security then add the fact that we want system</span>
01916     <span class="comment">//  security to the remaining desired access state.</span>
01917     <span class="comment">//</span>
01918 
01919     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01920 
01921         <span class="keywordflow">if</span> ( SecurityDescriptor-&gt;Control &amp; SE_SACL_PRESENT ) {
01922 
01923             <span class="keywordflow">if</span> ( !(AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> &amp; ACCESS_SYSTEM_SECURITY)) {
01924 
01925                 AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> |= ACCESS_SYSTEM_SECURITY;
01926             }
01927         }
01928     }
01929 
01930     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01931 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="obse.c::ObQuerySecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObQuerySecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">1679</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00914">ObpAcquireDescriptorCacheReadLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">SeQuerySecurityDescriptorInfo()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">SeDefaultObjectMethod()</a>.
<p>
<pre class="fragment"><div>01687                    :
01688 
01689     This routine will extract <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired information from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01690     passed security descriptor and <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information in
01691     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed buffer as a security descriptor in <span class="keyword">self</span>-relative
01692     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
01693 
01694     This routine assumes that all parameters are captured and
01695     safe to reference.
01696 
01697 Arguments:
01698 
01699     SecurityInformation - Specifies what information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being queried.
01700 
01701     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to output <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested
01702         information into.
01703 
01704         This buffer has been probed <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size indicated by
01705         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length parameter.  Since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> still points into user space,
01706         <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must always be accessed in a <span class="keywordflow">try</span> clause.
01707 
01708     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a variable containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of
01709         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor buffer.  Upon <span class="keywordflow">return</span> <span class="keyword">this</span> variable will
01710         contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length needed to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requested information.
01711 
01712     ObjectsSecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a pointer to
01713         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects security descriptor.  The passed security descriptor
01714         must be in <span class="keyword">self</span>-relative <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
01715 
01716 Return Value:
01717 
01718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> successful and an appropriate error value
01719         otherwise
01720 
01721 --*/
01722 {
01723     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01724 
01725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01726 
01727     <span class="comment">//</span>
01728     <span class="comment">// Take the read lock on the security descriptor cache so we</span>
01729     <span class="comment">// don't collide with anyone who is modifying this security</span>
01730     <span class="comment">// descriptor (bug 347986).</span>
01731     <span class="comment">//</span>
01732 
01733     <a class="code" href="../../d8/d1/obsdata_8c.html#a24">ObpAcquireDescriptorCacheReadLock</a>();
01734 
01735     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a6">SeQuerySecurityDescriptorInfo</a>( SecurityInformation,
01736                                             SecurityDescriptor,
01737                                             Length,
01738                                             ObjectsSecurityDescriptor
01739                                             );
01740     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01741 
01742     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01743 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obse.c::ObReleaseObjectSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObReleaseObjectSecurity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryAllocated</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">1418</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00262">PspCreateThread()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l00366">PspSetPrimaryToken()</a>.
<p>
<pre class="fragment"><div>01425                    :
01426 
01427     This function will free up any memory associated with a queried
01428     security descriptor.  This undoes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d4/d0/ob_8h.html#a91">ObGetObjectSecurity</a>
01429 
01430 Arguments:
01431 
01432     SecurityDescriptor - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor
01433         to be freed.
01434 
01435     MemoryAllocated - Supplies whether or not we should free <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01436         memory pointed to by SecurityDescriptor.
01437 
01438 Return Value:
01439 
01440     None.
01441 
01442 --*/
01443 
01444 {
01445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01446 
01447     <span class="comment">//</span>
01448     <span class="comment">//  Check if there is a security descriptor to actually free</span>
01449     <span class="comment">//</span>
01450 
01451     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01452 
01453         <span class="comment">//</span>
01454         <span class="comment">//  If ObGetObjectSecurity allocated memory then we</span>
01455         <span class="comment">//  need to free it. Otherwise what the earlier routine did</span>
01456         <span class="comment">//  was reference the object to keep the security descriptor</span>
01457         <span class="comment">//  to keep it from going away</span>
01458         <span class="comment">//</span>
01459 
01460         <span class="keywordflow">if</span> (MemoryAllocated) {
01461 
01462             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SecurityDescriptor );
01463 
01464         } <span class="keywordflow">else</span> {
01465 
01466             <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a>( SecurityDescriptor );
01467         }
01468     }
01469 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="obse.c::ObSetSecurityDescriptorInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObSetSecurityDescriptorInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectsSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PGENERIC_MAPPING&nbsp;</td>
          <td class="mdname" nowrap> <em>GenericMapping</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">1748</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">ObpAcquireDescriptorCacheWriteLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">ObpDirectoryObjectType</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">SeFastTraverseCheck()</a>, <a class="el" href="../../d1/d5/semethod_8c-source.html#l00365">SeSetSecurityDescriptorInfo()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/semethod_8c-source.html#l00195">SeDefaultObjectMethod()</a>, and <a class="el" href="../../d9/d7/winsta_8c-source.html#l00243">xxxCreateWindowStation()</a>.
<p>
<pre class="fragment"><div>01759                    :
01760 
01761     Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor on an already secure object.
01762 
01763 Arguments:
01764 
01765     Object - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being modified.
01766 
01767     SecurityInformation - Describes which information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SecurityDescriptor parameter
01768         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relevent.
01769 
01770     SecurityDescriptor - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> security information.
01771 
01772     ObjectsSecurityDescriptor - Provides/returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security descriptor.
01773 
01774     PoolType - The <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ObjectSecurityDescriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from.
01775 
01776     GenericMapping - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generic mapping <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01777 
01778 Return Value:
01779 
01780     An appropriate status value
01781 
01782 --*/
01783 
01784 {
01785     PSECURITY_DESCRIPTOR OldDescriptor;
01786     PSECURITY_DESCRIPTOR NewDescriptor;
01787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01788 
01789     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01790 
01791     <span class="comment">//</span>
01792     <span class="comment">//  Check the rest of our input and call the default set security</span>
01793     <span class="comment">//  method.  Also make sure no one is modifying the security descriptor</span>
01794     <span class="comment">//  while we're looking at it.</span>
01795     <span class="comment">//</span>
01796 
01797     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
01798 
01799     OldDescriptor = *ObjectsSecurityDescriptor;
01800     NewDescriptor = OldDescriptor;
01801 
01802     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/semethod_8c.html#a4">SeSetSecurityDescriptorInfo</a>( Object,
01803                                           SecurityInformation,
01804                                           SecurityDescriptor,
01805                                           &amp;NewDescriptor,
01806                                           PoolType,
01807                                           GenericMapping );
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">//  Now if the object is an object directory object that</span>
01811     <span class="comment">//  participated in snapped symbolic links.  If so and the</span>
01812     <span class="comment">//  new security on the object does NOT allow world traverse</span>
01813     <span class="comment">//  access, then return an error, as it is too late to change</span>
01814     <span class="comment">//  the security on the object directory at this point.</span>
01815     <span class="comment">//</span>
01816 
01817     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )
01818 
01819             &amp;&amp;
01820 
01821         (<a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;Type == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>)
01822 
01823             &amp;&amp;
01824 
01825         (((<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>)Object)-&gt;SymbolicLinkUsageCount != 0)
01826 
01827             &amp;&amp;
01828 
01829         !<a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( NewDescriptor, DIRECTORY_TRAVERSE, UserMode )) {
01830 
01831         KdPrint(( <span class="stringliteral">"OB: Failing attempt the remove world traverse access from object directory\n"</span> ));
01832 
01833         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDescriptor );
01834 
01835         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01836     }
01837 
01838     <span class="comment">//</span>
01839     <span class="comment">//  If we successfully set the new security descriptor then we</span>
01840     <span class="comment">//  need to log it in our database and get yet another pointer</span>
01841     <span class="comment">//  to the finaly security descriptor</span>
01842     <span class="comment">//</span>
01843 
01844     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01845 
01846         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d1/obsdata_8c.html#a16">ObpLogSecurityDescriptor</a>( NewDescriptor,
01847                                            ObjectsSecurityDescriptor );
01848 
01849         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01850 
01851         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01852 
01853             <span class="comment">//</span>
01854             <span class="comment">//  Dereference old SecurityDescriptor and insert new one</span>
01855             <span class="comment">//</span>
01856 
01857             <a class="code" href="../../d8/d1/obsdata_8c.html#a20">ObpDereferenceSecurityDescriptor</a>( OldDescriptor );
01858 
01859         } <span class="keywordflow">else</span> {
01860 
01861             <span class="comment">//</span>
01862             <span class="comment">//  We failed logging the new security descriptor.</span>
01863             <span class="comment">//  Clean up and fail the entire operation.</span>
01864             <span class="comment">//</span>
01865 
01866             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NewDescriptor );
01867         }
01868     } <span class="keywordflow">else</span> {
01869 
01870         <span class="comment">//</span>
01871         <span class="comment">//  Release the security descriptor lock</span>
01872         <span class="comment">//</span>
01873 
01874         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
01875     }
01876 
01877     <span class="comment">//</span>
01878     <span class="comment">//  And return to our caller</span>
01879     <span class="comment">//</span>
01880 
01881     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01882 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obse.c::ObSetSecurityObjectByPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObSetSecurityObjectByPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SECURITY_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00174">174</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l04759">IopChangeDeviceObjectFromRegistryProperties()</a>, <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l08959">IopSetSecurityObjectFromRegistry()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l00046">NtSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>00182                    :
00183 
00184     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to invoke an object's security routine.  It
00185     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's security state.
00186 
00187     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accessible <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel and assumes that all
00188     necessary validation of parameters has been done by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00189 
00190 Arguments:
00191 
00192     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being modified
00193 
00194     SecurityInformation - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of information we are
00195         interested in setting. e.g., owner, group, dacl, or sacl.
00196 
00197     SecurityDescriptor - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00198         object being modified.
00199 
00200 Return Value:
00201 
00202     An appropriate <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value
00203 
00204 --*/
00205 
00206 {
00207     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00208     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00209     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00210 
00211     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00212 
00213 <span class="comment">//    DbgPrint("ObSetSecurityObjectByPointer called for object %#08lx with info "</span>
00214 <span class="comment">//             "%x and descriptor %#08lx\n",</span>
00215 <span class="comment">//             Object, SecurityInformation, SecurityDescriptor);</span>
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">//  Map the object body to an object header and the corresponding</span>
00219     <span class="comment">//  object type</span>
00220     <span class="comment">//</span>
00221 
00222     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00223     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">//  Make sure the passed security descriptor is really there.</span>
00227     <span class="comment">//</span>
00228 
00229     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ARGUMENT_PRESENT( SecurityDescriptor ));
00230 
00231     <span class="comment">//</span>
00232     <span class="comment">//  Now invoke the security procedure call back to set the security</span>
00233     <span class="comment">//  descriptor for the object</span>
00234     <span class="comment">//</span>
00235 
00236     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)
00237                 ( Object,
00238                   <a class="code" href="../../d0/d5/se_8h.html#a200a108">SetSecurityDescriptor</a>,
00239                   &amp;SecurityInformation,
00240                   SecurityDescriptor,
00241                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00242                   &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
00243                   ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
00244                   &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
00245 
00246 
00247 <span class="comment">//    DbgPrint("ObSetSecurityObjectByPointer: object security routine returned "</span>
00248 <span class="comment">//             "%#08lx\n", Status);</span>
00249 
00250     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00251 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obse.c::ObValidateSecurityQuota" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObValidateSecurityQuota           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01473">1473</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00352">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00062">SE_DEFAULT_SECURITY_QUOTA</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00319">_OBJECT_HEADER_QUOTA_INFO::SecurityDescriptorCharge</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>.
<p>
<pre class="fragment"><div>01480                    :
01481 
01482     This routine will check to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> security information
01483     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> larger than <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's pre-allocated quota.
01484 
01485 Arguments:
01486 
01487     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object whose information <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
01488         modified.
01489 
01490     NewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> proposed <span class="keyword">new</span> security
01491         information.
01492 
01493 Return Value:
01494 
01495     STATUS_SUCCESS - New size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within alloted quota.
01496 
01497     STATUS_QUOTA_EXCEEDED - The desired adjustment would have exceeded
01498         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> permitted security quota <span class="keywordflow">for</span> <span class="keyword">this</span> object.
01499 
01500 --*/
01501 
01502 {
01503     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01504     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01505 
01506     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01507 
01508     <span class="comment">//</span>
01509     <span class="comment">//  Map the object body to its object header and corresponding</span>
01510     <span class="comment">//  quota information block</span>
01511     <span class="comment">//</span>
01512 
01513     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01514     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01515 
01516     <span class="comment">//</span>
01517     <span class="comment">//  If there isn't any quota info and the new size is greater</span>
01518     <span class="comment">//  then the default security quota then if the object uses</span>
01519     <span class="comment">//  the default value then we've exceeded quota otherwise</span>
01520     <span class="comment">//  let the caller get the quota</span>
01521     <span class="comment">//</span>
01522 
01523     <span class="keywordflow">if</span> ((QuotaInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NewSize &gt; <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>)) {
01524 
01525         <span class="keywordflow">if</span> (!(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>)) {
01526 
01527             <span class="comment">//</span>
01528             <span class="comment">//  Should really charge quota here.</span>
01529             <span class="comment">//</span>
01530 
01531             <span class="keywordflow">return</span>( STATUS_SUCCESS );
01532         }
01533 
01534         <span class="keywordflow">return</span>( STATUS_QUOTA_EXCEEDED );
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">//  If the quota is not null and the new size is greater than the</span>
01538     <span class="comment">//  allowed quota charge then if the charge is zero we grant the</span>
01539     <span class="comment">//  request otherwise we've exceeded quota.</span>
01540     <span class="comment">//</span>
01541     <span class="comment">//  **** this logic seems wierd</span>
01542     <span class="comment">//</span>
01543 
01544     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (NewSize &gt; QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>)) {
01545 
01546         <span class="keywordflow">if</span> (QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a> == 0) {
01547 
01548             <span class="comment">//</span>
01549             <span class="comment">//  Should really charge quota here.</span>
01550             <span class="comment">//</span>
01551 
01552             <span class="comment">//  QuotaInfo-&gt;SecurityDescriptorCharge = SeComputeSecurityQuota( NewSize );</span>
01553 
01554             <span class="keywordflow">return</span>( STATUS_SUCCESS );
01555         }
01556 
01557         <span class="keywordflow">return</span>( STATUS_QUOTA_EXCEEDED );
01558 
01559     <span class="comment">//</span>
01560     <span class="comment">//  Otherwise we have two cases.  (1) there isn't any quota info but</span>
01561     <span class="comment">//  the size is within limits or (2) there is a quota info block and</span>
01562     <span class="comment">//  the size is within the specified security descriptor charge so</span>
01563     <span class="comment">//  return success to our caller</span>
01564     <span class="comment">//</span>
01565 
01566     } <span class="keywordflow">else</span> {
01567 
01568         <span class="keywordflow">return</span>( STATUS_SUCCESS );
01569     }
01570 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
