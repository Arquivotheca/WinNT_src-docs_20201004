<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmapi.c</h1><a href="../../d8/d9/cmapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    cmapi.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains CM level entry points for the registry.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 30-Aug-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00022 
00023 
00024 
<a name="l00025"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a0">00025</a> <span class="keyword">extern</span>  BOOLEAN     <a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>;
00026 
<a name="l00027"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a1">00027</a> <span class="keyword">extern</span>  LIST_ENTRY  <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>;
00028 
<a name="l00029"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a2">00029</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a>;
<a name="l00030"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a3">00030</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a>;
00031 
<a name="l00032"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a4">00032</a> <span class="keyword">extern</span>  PUCHAR  <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
<a name="l00033"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a5">00033</a> <span class="keyword">extern</span>  ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a>;
00034 
<a name="l00035"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a6">00035</a> <span class="keyword">extern</span>  UNICODE_STRING <a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>;
00036 
<a name="l00037"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a7">00037</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
<a name="l00038"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a8">00038</a> <span class="keyword">extern</span> ULONG   <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
00039 
00040 <span class="comment">//</span>
00041 <span class="comment">// procedures private to this file</span>
00042 <span class="comment">//</span>
00043 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00044 <a class="code" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a>(
00045     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00046     IN <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> OldChild,
00047     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Value,
00048     IN ULONG Type,
00049     IN PVOID Data,
00050     IN ULONG DataSize,
00051     IN ULONG StorageType,
00052     IN ULONG TempData
00053     );
00054 
00055 
00056 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00057 <a class="code" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a>(
00058     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
00059     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent,
00060     IN PUNICODE_STRING ValueName,
00061     IN ULONG Type,
00062     IN PVOID Data,
00063     IN ULONG DataSize,
00064     IN ULONG StorageType,
00065     IN ULONG TempData
00066     );
00067 
00068 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00069 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmDeleteValueKey)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmEnumerateKey)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmEnumerateValueKey)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmFlushKey)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmQueryKey)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmQueryValueKey)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmQueryMultipleValueKey)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmSetValueKey)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSetValueKeyExisting)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpSetValueKeyNew)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmSetLastWriteTimeKey)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmLoadKey)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmUnloadKey)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoFlushAll)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmReplaceKey)</span>
00084 <span class="preprocessor"></span>
00085 <span class="preprocessor">#ifdef _WRITE_PROTECTED_REGISTRY_POOL</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpMarkAllBinsReadOnly)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
00089 <span class="preprocessor">#endif</span>
00090 <span class="preprocessor"></span>
00091 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00092"></a><a class="code" href="../../d1/d2/cmp_8h.html#a225">00092</a> <a class="code" href="../../d1/d2/cmp_8h.html#a225">CmDeleteValueKey</a>(
00093     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00094     IN UNICODE_STRING ValueName         <span class="comment">// RAW</span>
00095     )
00096 <span class="comment">/*++</span>
00097 <span class="comment"></span>
00098 <span class="comment">Routine Description:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    One of the value entries of a registry key may be removed with this call.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    The value entry with ValueName matching ValueName is removed from the key.</span>
00103 <span class="comment">    If no such entry exists, an error is returned.</span>
00104 <span class="comment"></span>
00105 <span class="comment">Arguments:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    KeyControlBlock - pointer to kcb for key to operate on</span>
00108 <span class="comment"></span>
00109 <span class="comment">    ValueName - The name of the value to be deleted.  NULL is a legal name.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Return Value:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00114 <span class="comment"></span>
00115 <span class="comment">        &lt;TBS&gt;</span>
00116 <span class="comment"></span>
00117 <span class="comment">--*/</span>
00118 {
00119     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00120     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> pcell;
00121     <a class="code" href="../../d7/d9/struct__CHILD__LIST.html">PCHILD_LIST</a> plist;
00122     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> targetaddress;
00123     ULONG  targetindex;
00124     ULONG   newcount;
00125     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> newcell;
00126     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ChildCell;
00127     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00128     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00129     ULONG realsize;
00130     LARGE_INTEGER systemtime;
00131 
00132     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmDeleteValueKey\n"</span>));
00133 
00134     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
00135 
00136     <span class="keywordflow">try</span> {
00137         <span class="comment">//</span>
00138         <span class="comment">// no edits, not even this one, on keys marked for deletion</span>
00139         <span class="comment">//</span>
00140         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00141             <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00142         }
00143 
00144         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00145         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00146         pcell = KeyControlBlock-&gt;KeyNode;
00147 
00148         <span class="comment">// Mark the hive as read only</span>
00149         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00150 
00151         status = STATUS_OBJECT_NAME_NOT_FOUND;
00152 
00153         plist = &amp;(pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>);
00154         ChildCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00155 
00156         <span class="keywordflow">if</span> (plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> != 0) {
00157 
00158             <span class="comment">//</span>
00159             <span class="comment">// The parent has at least one value, map in the list of</span>
00160             <span class="comment">// values and call CmpFindChildInList</span>
00161             <span class="comment">//</span>
00162 
00163             <span class="comment">//</span>
00164             <span class="comment">// plist -&gt; the CHILD_LIST structure</span>
00165             <span class="comment">// pchild -&gt; the child node structure being examined</span>
00166             <span class="comment">//</span>
00167 
00168             ChildCell = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00169                                           plist,
00170                                           &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00171                                           &amp;targetaddress,
00172                                           &amp;targetindex);
00173 
00174             <span class="keywordflow">if</span> (ChildCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00175 
00176                 <span class="comment">//</span>
00177                 <span class="comment">// 1. the desired target was found</span>
00178                 <span class="comment">// 2. ChildCell is it's HCELL_INDEX</span>
00179                 <span class="comment">// 3. targetaddress points to it</span>
00180                 <span class="comment">// 4. targetindex is it's index</span>
00181                 <span class="comment">//</span>
00182 
00183                 <span class="comment">//</span>
00184                 <span class="comment">// attempt to mark all relevent cells dirty</span>
00185                 <span class="comment">//</span>
00186                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>) &amp;&amp;
00187                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>) &amp;&amp;
00188                       <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ChildCell)))
00189 
00190                 {
00191                     <span class="comment">// Mark the hive as read only</span>
00192                     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00193 
00194                     <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
00195                 }
00196 
00197                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize,targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>)) {
00198 
00199                     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, targetaddress-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>)) {
00200 
00201                         <span class="comment">// Mark the hive as read only</span>
00202                         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00203 
00204                         <span class="keywordflow">return</span>(STATUS_NO_LOG_SPACE);
00205                     }
00206                 }
00207 
00208                 newcount = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> - 1;
00209 
00210                 <span class="keywordflow">if</span> (newcount &gt; 0) {
00211                     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvector;
00212 
00213                     <span class="comment">//</span>
00214                     <span class="comment">// more than one entry list, squeeze</span>
00215                     <span class="comment">//</span>
00216                     pvector = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00217                     <span class="keywordflow">for</span> ( ; targetindex &lt; newcount; targetindex++) {
00218                         pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex ] =
00219                             pvector-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[ targetindex+1 ];
00220                     }
00221 
00222                     newcell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
00223                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00224                                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>,
00225                                 newcount * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>)
00226                                 );
00227                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newcell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
00228                     plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = newcell;
00229 
00230                 } <span class="keywordflow">else</span> {
00231 
00232                     <span class="comment">//</span>
00233                     <span class="comment">// list is empty, free it</span>
00234                     <span class="comment">//</span>
00235                     <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>);
00236                 }
00237                 plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = newcount;
00238                 <a class="code" href="../../d9/d2/cmsubs2_8c.html#a3">CmpFreeValue</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ChildCell);
00239 
00240                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
00241                 pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
00242 
00243                 <span class="keywordflow">if</span> (pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> == 0) {
00244                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = 0;
00245                     pcell-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = 0;
00246                 }
00247 
00248                 <span class="comment">//</span>
00249                 <span class="comment">// We are changing the KCB cache. Since the registry is locked exclusively,</span>
00250                 <span class="comment">// we do not need a KCB lock.</span>
00251                 <span class="comment">//</span>
00252                 <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
00253 
00254                 <span class="comment">//</span>
00255                 <span class="comment">// Invalidate the cache</span>
00256                 <span class="comment">//</span>
00257                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
00258 
00259                 KeyControlBlock-&gt;ValueCache.Count = plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
00260                 KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) plist-&gt;<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
00261     
00262                 <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(
00263                         KeyControlBlock,
00264                         KeyControlBlock-&gt;KeyHive,
00265                         KeyControlBlock-&gt;KeyCell,
00266                         REG_NOTIFY_CHANGE_LAST_SET
00267                         );
00268                 status = STATUS_SUCCESS;
00269             } <span class="keywordflow">else</span> {
00270                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00271             }
00272         }
00273     } finally {
00274         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00275     }
00276 
00277     <span class="comment">// Mark the hive as read only</span>
00278     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00279 
00280     <span class="keywordflow">return</span> status;
00281 }
00282 
00283 
00284 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00285"></a><a class="code" href="../../d1/d2/cmp_8h.html#a226">00285</a> <a class="code" href="../../d1/d2/cmp_8h.html#a226">CmEnumerateKey</a>(
00286     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00287     IN ULONG Index,
00288     IN KEY_INFORMATION_CLASS KeyInformationClass,
00289     IN PVOID KeyInformation,
00290     IN ULONG Length,
00291     IN PULONG ResultLength
00292     )
00293 <span class="comment">/*++</span>
00294 <span class="comment"></span>
00295 <span class="comment">Routine Description:</span>
00296 <span class="comment"></span>
00297 <span class="comment">    Enumerate sub keys, return data on Index'th entry.</span>
00298 <span class="comment"></span>
00299 <span class="comment">    CmEnumerateKey returns the name of the Index'th sub key of the open</span>
00300 <span class="comment">    key specified.  The value STATUS_NO_MORE_ENTRIES will be</span>
00301 <span class="comment">    returned if value of Index is larger than the number of sub keys.</span>
00302 <span class="comment"></span>
00303 <span class="comment">    Note that Index is simply a way to select among child keys.  Two calls</span>
00304 <span class="comment">    to CmEnumerateKey with the same Index are NOT guaranteed to return</span>
00305 <span class="comment">    the same results.</span>
00306 <span class="comment"></span>
00307 <span class="comment">    If KeyInformation is not long enough to hold all requested data,</span>
00308 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00309 <span class="comment">    set to the number of bytes actually required.</span>
00310 <span class="comment"></span>
00311 <span class="comment">Arguments:</span>
00312 <span class="comment"></span>
00313 <span class="comment">    KeyControlBlock - pointer to the KCB that describes the key</span>
00314 <span class="comment"></span>
00315 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00316 <span class="comment"></span>
00317 <span class="comment">    KeyInformationClass - Specifies the type of information returned in</span>
00318 <span class="comment">        Buffer.  One of the following types:</span>
00319 <span class="comment"></span>
00320 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00321 <span class="comment">            (see KEY_BASIC_INFORMATION structure)</span>
00322 <span class="comment"></span>
00323 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00324 <span class="comment">            (see KEY_NODE_INFORMATION structure)</span>
00325 <span class="comment"></span>
00326 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00327 <span class="comment"></span>
00328 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00329 <span class="comment"></span>
00330 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Return Value:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00335 <span class="comment"></span>
00336 <span class="comment">        &lt;TBS&gt;</span>
00337 <span class="comment"></span>
00338 <span class="comment">--*/</span>
00339 {
00340     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00341     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00342     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00343     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00344     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00345 
00346     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmEnumerateKey\n"</span>));
00347 
00348 
00349     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00350 
00351     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00352         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00353         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00354     }
00355 
00356     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00357     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
00358 
00359     <span class="comment">// Mark the hive as read only</span>
00360     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00361 
00362     <span class="comment">//</span>
00363     <span class="comment">// fetch the child of interest</span>
00364     <span class="comment">//</span>
00365 
00366     childcell = <a class="code" href="../../d1/d2/cmp_8h.html#a304">CmpFindSubKeyByNumber</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, KeyControlBlock-&gt;KeyNode, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
00367     <span class="keywordflow">if</span> (childcell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00368         <span class="comment">//</span>
00369         <span class="comment">// no such child, clean up and return error</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00373 
00374         <span class="comment">// Mark the hive as read only</span>
00375         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00376 
00377         <span class="keywordflow">return</span> STATUS_NO_MORE_ENTRIES;
00378     }
00379 
00380     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,childcell);
00381 
00382     <span class="keywordflow">try</span> {
00383 
00384         <span class="comment">//</span>
00385         <span class="comment">// call a worker to perform data transfer</span>
00386         <span class="comment">//</span>
00387 
00388         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00389                                  Node,
00390                                  KeyInformationClass,
00391                                  KeyInformation,
00392                                  Length,
00393                                  ResultLength);
00394 
00395      } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00396         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00397         status = GetExceptionCode();
00398 
00399         <span class="comment">// Mark the hive as read only</span>
00400         <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00401 
00402         <span class="keywordflow">return</span> status;
00403     }
00404 
00405     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00406 
00407     <span class="comment">// Mark the hive as read only</span>
00408     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00409 
00410     <span class="keywordflow">return</span> status;
00411 }
00412 
00413 
00414 
00415 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00416"></a><a class="code" href="../../d1/d2/cmp_8h.html#a227">00416</a> <a class="code" href="../../d1/d2/cmp_8h.html#a227">CmEnumerateValueKey</a>(
00417     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00418     IN ULONG Index,
00419     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00420     IN PVOID KeyValueInformation,
00421     IN ULONG Length,
00422     IN PULONG ResultLength
00423     )
00424 <span class="comment">/*++</span>
00425 <span class="comment"></span>
00426 <span class="comment">Routine Description:</span>
00427 <span class="comment"></span>
00428 <span class="comment">    The value entries of an open key may be enumerated.</span>
00429 <span class="comment"></span>
00430 <span class="comment">    CmEnumerateValueKey returns the name of the Index'th value</span>
00431 <span class="comment">    entry of the open key specified by KeyHandle.  The value</span>
00432 <span class="comment">    STATUS_NO_MORE_ENTRIES will be returned if value of Index is</span>
00433 <span class="comment">    larger than the number of sub keys.</span>
00434 <span class="comment"></span>
00435 <span class="comment">    Note that Index is simply a way to select among value</span>
00436 <span class="comment">    entries.  Two calls to NtEnumerateValueKey with the same Index</span>
00437 <span class="comment">    are NOT guaranteed to return the same results.</span>
00438 <span class="comment"></span>
00439 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00440 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00441 <span class="comment">    set to the number of bytes actually required.</span>
00442 <span class="comment"></span>
00443 <span class="comment">Arguments:</span>
00444 <span class="comment"></span>
00445 <span class="comment">    KeyControlBlock - pointer to the KCB that describes the key</span>
00446 <span class="comment"></span>
00447 <span class="comment">    Index - Specifies the (0-based) number of the sub key to be returned.</span>
00448 <span class="comment"></span>
00449 <span class="comment">    KeyValueInformationClass - Specifies the type of information returned</span>
00450 <span class="comment">    in Buffer. One of the following types:</span>
00451 <span class="comment"></span>
00452 <span class="comment">        KeyValueBasicInformation - return time of last write,</span>
00453 <span class="comment">            title index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
00454 <span class="comment"></span>
00455 <span class="comment">        KeyValueFullInformation - return time of last write,</span>
00456 <span class="comment">            title index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
00457 <span class="comment"></span>
00458 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
00461 <span class="comment"></span>
00462 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
00463 <span class="comment"></span>
00464 <span class="comment">Return Value:</span>
00465 <span class="comment"></span>
00466 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00467 <span class="comment"></span>
00468 <span class="comment">        &lt;TBS&gt;</span>
00469 <span class="comment"></span>
00470 <span class="comment">--*/</span>
00471 {
00472     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00473     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00474     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00475     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> ChildList;
00476     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00477     BOOLEAN    IndexCached;
00478     BOOLEAN    ValueCached;
00479     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00480 
00481     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmEnumerateValueKey\n"</span>));
00482 
00483 
00484     <span class="comment">//</span>
00485     <span class="comment">// lock the parent cell</span>
00486     <span class="comment">//</span>
00487 
00488     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00489 
00490     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00491         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00492         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00493     }
00494     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
00495     Node = KeyControlBlock-&gt;KeyNode;
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// fetch the child of interest</span>
00499     <span class="comment">//</span>
00500     <span class="comment">//</span>
00501     <span class="comment">// Do it using the cache</span>
00502     <span class="comment">//</span>
00503     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt;= KeyControlBlock-&gt;ValueCache.Count) {
00504         <span class="comment">//</span>
00505         <span class="comment">// No such child, clean up and return error.</span>
00506         <span class="comment">//</span>
00507         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00508         <span class="keywordflow">return</span>(STATUS_NO_MORE_ENTRIES);
00509     }
00510 
00511     <span class="comment">// Mark the hive as read only</span>
00512     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00513 
00514     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00515     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00516         <span class="comment">//</span>
00517         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00518         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00519         <span class="comment">//</span>
00520         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00521         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00522 
00523         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00524         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00525     }
00526 
00527     ChildList = <a class="code" href="../../d4/d3/cmtree_8c.html#a1">CmpGetValueListFromCache</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;(KeyControlBlock-&gt;ValueCache), &amp;IndexCached);
00528     ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a2">CmpGetValueKeyFromCache</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ChildList, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, &amp;ContainingList, IndexCached, &amp;ValueCached);    
00529 
00530     <span class="keywordflow">try</span> {
00531 
00532         <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00533         <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">// call a worker to perform data transfer</span>
00537         <span class="comment">//</span>
00538         status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00539                                   ContainingList,
00540                                   ValueData,
00541                                   ValueCached,
00542                                   KeyValueInformationClass,
00543                                   KeyValueInformation,
00544                                   Length,
00545                                   ResultLength);
00546 
00547          <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00548         <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00549     } finally {
00550 
00551         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00552         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00553     }
00554 
00555     <span class="comment">// Mark the hive as read only</span>
00556     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00557 
00558     <span class="keywordflow">return</span> status;
00559 }
00560 
00561 
00562 
00563 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00564"></a><a class="code" href="../../d1/d2/cmp_8h.html#a228">00564</a> <a class="code" href="../../d1/d2/cmp_8h.html#a228">CmFlushKey</a>(
00565     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00566     IN HCELL_INDEX Cell
00567     )
00568 <span class="comment">/*++</span>
00569 <span class="comment"></span>
00570 <span class="comment">Routine Description:</span>
00571 <span class="comment"></span>
00572 <span class="comment">    Forces changes made to a key to disk.</span>
00573 <span class="comment"></span>
00574 <span class="comment">    CmFlushKey will not return to its caller until any changed data</span>
00575 <span class="comment">    associated with the key has been written out.</span>
00576 <span class="comment"></span>
00577 <span class="comment">    WARNING: CmFlushKey will flush the entire registry tree, and thus will</span>
00578 <span class="comment">    burn cycles and I/O.</span>
00579 <span class="comment"></span>
00580 <span class="comment">Arguments:</span>
00581 <span class="comment"></span>
00582 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00583 <span class="comment"></span>
00584 <span class="comment">    Cell - supplies index of node to whose sub keys are to be found</span>
00585 <span class="comment"></span>
00586 <span class="comment">Return Value:</span>
00587 <span class="comment"></span>
00588 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00589 <span class="comment"></span>
00590 <span class="comment">        &lt;TBS&gt;</span>
00591 <span class="comment"></span>
00592 <span class="comment">--*/</span>
00593 {
00594     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
00595     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00596     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
00597 
00598     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmFlushKey\n"</span>));
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
00602     <span class="comment">// clean up in a short time.  Only early system init code</span>
00603     <span class="comment">// will ever know the difference.</span>
00604     <span class="comment">//</span>
00605     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
00606         <span class="keywordflow">return</span> STATUS_SUCCESS;
00607     }
00608 
00609 
00610     <span class="comment">// Mark the hive as read only</span>
00611     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00612 
00613     CmHive = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Don't flush the master hive.  If somebody asks for a flushkey on</span>
00617     <span class="comment">// the master hive, do a CmpDoFlushAll instead.  CmpDoFlushAll flushes</span>
00618     <span class="comment">// every hive except the master hive, which is what they REALLY want.</span>
00619     <span class="comment">//</span>
00620     <span class="keywordflow">if</span> (CmHive == <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>) {
00621         <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>();
00622     } <span class="keywordflow">else</span> {
00623         <a class="code" href="../../d1/d2/cmp_8h.html#a57">DCmCheckRegistry</a>(CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
00624 
00625         <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (CmHive);
00626 
00627         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) {
00628 
00629             status = STATUS_REGISTRY_IO_FAILED;
00630 
00631             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a45">CMS_IO_ERROR</a>) {
00632                 KdPrint((<span class="stringliteral">"CmFlushKey: HvSyncHive failed\n"</span>));
00633             }
00634         }
00635 
00636         <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (CmHive);
00637     }
00638 
00639     <span class="comment">// Mark the hive as read only</span>
00640     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
00641 
00642     <span class="keywordflow">return</span>  status;
00643 }
00644 
00645 
00646 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00647"></a><a class="code" href="../../d1/d2/cmp_8h.html#a229">00647</a> <a class="code" href="../../d1/d2/cmp_8h.html#a229">CmQueryKey</a>(
00648     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00649     IN KEY_INFORMATION_CLASS KeyInformationClass,
00650     IN PVOID KeyInformation,
00651     IN ULONG Length,
00652     IN PULONG ResultLength
00653     )
00654 <span class="comment">/*++</span>
00655 <span class="comment"></span>
00656 <span class="comment">Routine Description:</span>
00657 <span class="comment"></span>
00658 <span class="comment">    Data about the class of a key, and the numbers and sizes of its</span>
00659 <span class="comment">    children and value entries may be queried with CmQueryKey.</span>
00660 <span class="comment"></span>
00661 <span class="comment">    NOTE: The returned lengths are guaranteed to be at least as</span>
00662 <span class="comment">          long as the described values, but may be longer in</span>
00663 <span class="comment">          some circumstances.</span>
00664 <span class="comment"></span>
00665 <span class="comment">Arguments:</span>
00666 <span class="comment"></span>
00667 <span class="comment">    KeyControlBlock - pointer to the KCB that describes the key</span>
00668 <span class="comment"></span>
00669 <span class="comment">    KeyInformationClass - Specifies the type of information</span>
00670 <span class="comment">        returned in Buffer.  One of the following types:</span>
00671 <span class="comment"></span>
00672 <span class="comment">        KeyBasicInformation - return last write time, title index, and name.</span>
00673 <span class="comment">            (See KEY_BASIC_INFORMATION)</span>
00674 <span class="comment"></span>
00675 <span class="comment">        KeyNodeInformation - return last write time, title index, name, class.</span>
00676 <span class="comment">            (See KEY_NODE_INFORMATION)</span>
00677 <span class="comment"></span>
00678 <span class="comment">        KeyFullInformation - return all data except for name and security.</span>
00679 <span class="comment">            (See KEY_FULL_INFORMATION)</span>
00680 <span class="comment"></span>
00681 <span class="comment">    KeyInformation -Supplies pointer to buffer to receive the data.</span>
00682 <span class="comment"></span>
00683 <span class="comment">    Length - Length of KeyInformation in bytes.</span>
00684 <span class="comment"></span>
00685 <span class="comment">    ResultLength - Number of bytes actually written into KeyInformation.</span>
00686 <span class="comment"></span>
00687 <span class="comment">Return Value:</span>
00688 <span class="comment"></span>
00689 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00690 <span class="comment"></span>
00691 <span class="comment">        &lt;TBS&gt;</span>
00692 <span class="comment"></span>
00693 <span class="comment">--*/</span>
00694 {
00695     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00696 
00697     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmQueryKey\n"</span>));
00698 
00699 
00700 
00701     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00702 
00703     <span class="comment">// Mark the hive as read only</span>
00704     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00705 
00706     <span class="keywordflow">try</span> {
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// request for the FULL path of the key</span>
00710         <span class="comment">//</span>
00711         <span class="keywordflow">if</span>( KeyInformationClass == KeyNameInformation ) {
00712             <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete ) {
00713                 <span class="comment">//</span>
00714                 <span class="comment">// special case: return key deleted status, but still fill the full name of the key.</span>
00715                 <span class="comment">//</span>
00716                 status = STATUS_KEY_DELETED;
00717             } <span class="keywordflow">else</span> {
00718                 status = STATUS_SUCCESS;
00719             }
00720             
00721             <span class="keywordflow">if</span>( KeyControlBlock-&gt;NameBlock ) {
00722 
00723                 PUNICODE_STRING <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00724                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(KeyControlBlock);
00725                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726                     status = STATUS_INSUFFICIENT_RESOURCES;
00727                 } <span class="keywordflow">else</span> {
00728                     ULONG       requiredlength;
00729                     ULONG       minimumlength;
00730                     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>      NameLength;
00731                     LONG        leftlength;
00732                     <a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a> pbuffer = (<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html">PKEY_INFORMATION</a>)KeyInformation;
00733 
00734                     NameLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00735 
00736                     requiredlength = FIELD_OFFSET(KEY_NAME_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) + NameLength;
00737                     
00738                     minimumlength = FIELD_OFFSET(KEY_NAME_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00739 
00740                     *ResultLength = requiredlength;
00741                     <span class="keywordflow">if</span> (Length &lt; minimumlength) {
00742 
00743                         status = STATUS_BUFFER_TOO_SMALL;
00744 
00745                     } <span class="keywordflow">else</span> {
00746                         <span class="comment">//</span>
00747                         <span class="comment">// Fill in the length of the name</span>
00748                         <span class="comment">//</span>
00749                         pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.NameLength = NameLength;
00750                         
00751                         <span class="comment">//</span>
00752                         <span class="comment">// Now copy the full name into the user buffer, if enough space</span>
00753                         <span class="comment">//</span>
00754                         leftlength = Length - minimumlength;
00755                         requiredlength = NameLength;
00756                         <span class="keywordflow">if</span> (leftlength &lt; (LONG)requiredlength) {
00757                             requiredlength = leftlength;
00758                             status = STATUS_BUFFER_OVERFLOW;
00759                         }
00760 
00761                         <span class="comment">//</span>
00762                         <span class="comment">// If not enough space, copy how much we can and return overflow</span>
00763                         <span class="comment">//</span>
00764                         RtlCopyMemory(
00765                             &amp;(pbuffer-&gt;<a class="code" href="../../d5/d6/union__KEY__INFORMATION.html#o3">KeyNameInformation</a>.Name[0]),
00766                             <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00767                             requiredlength
00768                             );
00769                     }
00770 
00771                     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
00772                 }
00773             }
00774         } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(KeyControlBlock-&gt;Delete ) {
00775             <span class="comment">// </span>
00776             <span class="comment">// key already deleted</span>
00777             <span class="comment">//</span>
00778             status = STATUS_KEY_DELETED;
00779         } <span class="keywordflow">else</span> {
00780             <span class="comment">//</span>
00781             <span class="comment">// call a worker to perform data transfer</span>
00782             <span class="comment">//</span>
00783 
00784             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a4">CmpQueryKeyData</a>(KeyControlBlock-&gt;KeyHive,
00785                                      KeyControlBlock-&gt;KeyNode,
00786                                      KeyInformationClass,
00787                                      KeyInformation,
00788                                      Length,
00789                                      ResultLength);
00790         }
00791 
00792     } finally {
00793         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00794     }
00795 
00796     <span class="comment">// Mark the hive as read only</span>
00797     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00798 
00799     <span class="keywordflow">return</span> status;
00800 }
00801 
00802 
00803 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00804"></a><a class="code" href="../../d1/d2/cmp_8h.html#a230">00804</a> <a class="code" href="../../d1/d2/cmp_8h.html#a230">CmQueryValueKey</a>(
00805     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>    KeyControlBlock,
00806     IN UNICODE_STRING ValueName,
00807     IN KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,
00808     IN PVOID KeyValueInformation,
00809     IN ULONG Length,
00810     IN PULONG ResultLength
00811     )
00812 <span class="comment">/*++</span>
00813 <span class="comment"></span>
00814 <span class="comment">Routine Description:</span>
00815 <span class="comment"></span>
00816 <span class="comment">    The ValueName, TitleIndex, Type, and Data for any one of a key's</span>
00817 <span class="comment">    value entries may be queried with CmQueryValueKey.</span>
00818 <span class="comment"></span>
00819 <span class="comment">    If KeyValueInformation is not long enough to hold all requested data,</span>
00820 <span class="comment">    STATUS_BUFFER_OVERFLOW will be returned, and ResultLength will be</span>
00821 <span class="comment">    set to the number of bytes actually required.</span>
00822 <span class="comment"></span>
00823 <span class="comment">Arguments:</span>
00824 <span class="comment"></span>
00825 <span class="comment">    KeyControlBlock - pointer to the KCB that describes the key</span>
00826 <span class="comment"></span>
00827 <span class="comment">    ValueName  - The name of the value entry to return data for.</span>
00828 <span class="comment"></span>
00829 <span class="comment">    KeyValueInformationClass - Specifies the type of information</span>
00830 <span class="comment">        returned in KeyValueInformation.  One of the following types:</span>
00831 <span class="comment"></span>
00832 <span class="comment">        KeyValueBasicInformation - return time of last write, title</span>
00833 <span class="comment">            index, and name.  (See KEY_VALUE_BASIC_INFORMATION)</span>
00834 <span class="comment"></span>
00835 <span class="comment">        KeyValueFullInformation - return time of last write, title</span>
00836 <span class="comment">            index, name, class.  (See KEY_VALUE_FULL_INFORMATION)</span>
00837 <span class="comment"></span>
00838 <span class="comment">    KeyValueInformation -Supplies pointer to buffer to receive the data.</span>
00839 <span class="comment"></span>
00840 <span class="comment">    Length - Length of KeyValueInformation in bytes.</span>
00841 <span class="comment"></span>
00842 <span class="comment">    ResultLength - Number of bytes actually written into KeyValueInformation.</span>
00843 <span class="comment"></span>
00844 <span class="comment">Return Value:</span>
00845 <span class="comment"></span>
00846 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
00847 <span class="comment"></span>
00848 <span class="comment">        &lt;TBS&gt;</span>
00849 <span class="comment"></span>
00850 <span class="comment">--*/</span>
00851 {
00852     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00853     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> childcell;
00854     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a>  childindex;
00855     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00856     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueData;
00857     ULONG       <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00858     BOOLEAN     ValueCached;
00859     <a class="code" href="../../d2/d3/struct__CM__CACHED__VALUE.html">PPCM_CACHED_VALUE</a> ContainingList;
00860 
00861     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00862     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmQueryValueKey\n"</span>));
00863 
00864 
00865     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00866 
00867     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00868         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00869         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
00870     }
00871 
00872     <span class="comment">// Mark the hive as read only</span>
00873     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00874 
00875     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00876 
00877     <span class="keywordflow">if</span> (KeyControlBlock-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
00878         <span class="comment">//</span>
00879         <span class="comment">// The value list is now set to the KCB for symbolic link,</span>
00880         <span class="comment">// Clean it up and set the value right before we do the query.</span>
00881         <span class="comment">//</span>
00882         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(KeyControlBlock-&gt;ValueCache.RealKcb);
00883         KeyControlBlock-&gt;ExtFlags &amp;= ~<a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
00884 
00885         KeyControlBlock-&gt;ValueCache.Count = KeyControlBlock-&gt;KeyNode-&gt;ValueList.Count;
00886         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) KeyControlBlock-&gt;KeyNode-&gt;ValueList.List;
00887     }
00888 
00889 
00890     <span class="keywordflow">try</span> {
00891         <span class="comment">//</span>
00892         <span class="comment">// Find the data</span>
00893         <span class="comment">//</span>
00894 
00895         ValueData = <a class="code" href="../../d4/d3/cmtree_8c.html#a3">CmpFindValueByNameFromCache</a>(KeyControlBlock-&gt;KeyHive,
00896                                                 &amp;(KeyControlBlock-&gt;ValueCache),
00897                                                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00898                                                 &amp;ContainingList,
00899                                                 &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00900                                                 &amp;ValueCached
00901                                                 );
00902         <span class="keywordflow">if</span> (ValueData) {
00903 
00904             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00905             <a class="code" href="../../d1/d2/cmp_8h.html#a10">CmpMakeValueCacheReadWrite</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">// call a worker to perform data transfer</span>
00909             <span class="comment">//</span>
00910 
00911             status = <a class="code" href="../../d9/d2/cmsubs2_8c.html#a5">CmpQueryKeyValueData</a>(KeyControlBlock-&gt;KeyHive,
00912                                           ContainingList,
00913                                           ValueData,
00914                                           ValueCached,
00915                                           KeyValueInformationClass,
00916                                           KeyValueInformation,
00917                                           Length,
00918                                           ResultLength);
00919 
00920             <span class="comment">// Trying to catch the BAD guy who writes over our pool.</span>
00921             <a class="code" href="../../d1/d2/cmp_8h.html#a9">CmpMakeValueCacheReadOnly</a>(ValueCached,<a class="code" href="../../d9/d0/cmdata_8h.html#a46">CMP_GET_CACHED_ADDRESS</a>(KeyControlBlock-&gt;ValueCache.ValueList));
00922 
00923         } <span class="keywordflow">else</span> {
00924             status = STATUS_OBJECT_NAME_NOT_FOUND;
00925         }
00926 
00927     } finally {
00928         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00929         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00930     }
00931 
00932     <span class="comment">// Mark the hive as read only</span>
00933     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
00934 
00935     <span class="keywordflow">return</span> status;
00936 }
00937 
00938 
00939 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00940"></a><a class="code" href="../../d1/d2/cmp_8h.html#a231">00940</a> <a class="code" href="../../d1/d2/cmp_8h.html#a231">CmQueryMultipleValueKey</a>(
00941     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
00942     IN PKEY_VALUE_ENTRY ValueEntries,
00943     IN ULONG EntryCount,
00944     IN PVOID ValueBuffer,
00945     IN OUT PULONG BufferLength,
00946     IN OPTIONAL PULONG ResultLength
00947     )
00948 <span class="comment">/*++</span>
00949 <span class="comment"></span>
00950 <span class="comment">Routine Description:</span>
00951 <span class="comment"></span>
00952 <span class="comment">    Multiple values of any key may be queried atomically with</span>
00953 <span class="comment">    this api.</span>
00954 <span class="comment"></span>
00955 <span class="comment">Arguments:</span>
00956 <span class="comment"></span>
00957 <span class="comment">    KeyControlBlock - Supplies the key to be queried.</span>
00958 <span class="comment"></span>
00959 <span class="comment">    ValueEntries - Returns an array of KEY_VALUE_ENTRY structures, one for each value.</span>
00960 <span class="comment"></span>
00961 <span class="comment">    EntryCount - Supplies the number of entries in the ValueNames and ValueEntries arrays</span>
00962 <span class="comment"></span>
00963 <span class="comment">    ValueBuffer - Returns the value data for each value.</span>
00964 <span class="comment"></span>
00965 <span class="comment">    BufferLength - Supplies the length of the ValueBuffer array in bytes.</span>
00966 <span class="comment">                   Returns the length of the ValueBuffer array that was filled in.</span>
00967 <span class="comment"></span>
00968 <span class="comment">    ResultLength - if present, Returns the length in bytes of the ValueBuffer</span>
00969 <span class="comment">                    array required to return the requested values of this key.</span>
00970 <span class="comment"></span>
00971 <span class="comment">Return Value:</span>
00972 <span class="comment"></span>
00973 <span class="comment">    NTSTATUS</span>
00974 <span class="comment"></span>
00975 <span class="comment">--*/</span>
00976 
00977 {
00978     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00979     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00980     ULONG i;
00981     UNICODE_STRING CurrentName;
00982     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
00983     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> ValueNode;
00984     ULONG RequiredLength = 0;
00985     ULONG UsedLength = 0;
00986     ULONG DataLength;
00987     BOOLEAN BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00988     BOOLEAN Small;
00989     PUCHAR Data;
00990     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00991 
00992     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00993     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmQueryMultipleValueKey\n"</span>));
00994 
00995 
00996     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
00997     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete) {
00998         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
00999         <span class="keywordflow">return</span> STATUS_KEY_DELETED;
01000     }
01001     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01002     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01003 
01004     <span class="comment">// Mark the hive as read only</span>
01005     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01006 
01007     PreviousMode = KeGetPreviousMode();
01008     <span class="keywordflow">try</span> {
01009         <span class="keywordflow">for</span> (i=0; i &lt; EntryCount; i++) {
01010             <span class="comment">//</span>
01011             <span class="comment">// find the data</span>
01012             <span class="comment">//</span>
01013             <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
01014                 CurrentName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ValueEntries[i].<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
01015                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(CurrentName.Buffer,CurrentName.Length,<span class="keyword">sizeof</span>(WCHAR));
01016             } <span class="keywordflow">else</span> {
01017                 CurrentName = *(ValueEntries[i].ValueName);
01018             }
01019             ValueCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01020                                            KeyControlBlock-&gt;KeyNode,
01021                                            &amp;CurrentName);
01022             <span class="keywordflow">if</span> (ValueCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01023 
01024                 ValueNode = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01025                 Small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(DataLength, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
01026 
01027                 <span class="comment">//</span>
01028                 <span class="comment">// Round up UsedLength and RequiredLength to a ULONG boundary</span>
01029                 <span class="comment">//</span>
01030                 UsedLength = (UsedLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01031                 RequiredLength = (RequiredLength + <span class="keyword">sizeof</span>(ULONG)-1) &amp; ~(<span class="keyword">sizeof</span>(ULONG)-1);
01032 
01033                 <span class="comment">//</span>
01034                 <span class="comment">// If there is enough room for this data value in the buffer,</span>
01035                 <span class="comment">// fill it in now. Otherwise, mark the buffer as full. We must</span>
01036                 <span class="comment">// keep iterating through the values in order to determine the</span>
01037                 <span class="comment">// RequiredLength.</span>
01038                 <span class="comment">//</span>
01039                 <span class="keywordflow">if</span> ((UsedLength + DataLength &lt;= *BufferLength) &amp;&amp;
01040                     (!BufferFull)) {
01041                     <span class="keywordflow">if</span> (DataLength &gt; 0) {
01042                         <span class="keywordflow">if</span> (Small) {
01043                             Data = (PUCHAR)&amp;ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01044                         } <span class="keywordflow">else</span> {
01045                             Data = (PUCHAR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01046                         }
01047                         RtlCopyMemory((PUCHAR)<a class="code" href="../../d1/d1/hivedmp_8c.html#a0">ValueBuffer</a> + UsedLength,
01048                                       Data,
01049                                       DataLength);
01050                     }
01051                     ValueEntries[i].Type = ValueNode-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>;
01052                     ValueEntries[i].DataLength = DataLength;
01053                     ValueEntries[i].DataOffset = UsedLength;
01054                     UsedLength += DataLength;
01055                 } <span class="keywordflow">else</span> {
01056                     BufferFull = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01057                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_OVERFLOW;
01058                 }
01059                 RequiredLength += DataLength;
01060 
01061             } <span class="keywordflow">else</span> {
01062                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01063                 <span class="keywordflow">break</span>;
01064             }
01065         }
01066 
01067         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ||
01068             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW)) {
01069             *BufferLength = UsedLength;
01070             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ResultLength)) {
01071                 *ResultLength = RequiredLength;
01072             }
01073         }
01074 
01075     } finally {
01076         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01077     }
01078 
01079     <span class="comment">// Mark the hive as read only</span>
01080     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
01081 
01082     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01083 }
01084 
01085 
01086 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01087"></a><a class="code" href="../../d1/d2/cmp_8h.html#a237">01087</a> <a class="code" href="../../d1/d2/cmp_8h.html#a237">CmSetValueKey</a>(
01088     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
01089     IN PUNICODE_STRING ValueName,
01090     IN ULONG Type,
01091     IN PVOID Data,
01092     IN ULONG DataSize
01093     )
01094 <span class="comment">/*++</span>
01095 <span class="comment"></span>
01096 <span class="comment">Routine Description:</span>
01097 <span class="comment"></span>
01098 <span class="comment">    A value entry may be created or replaced with CmSetValueKey.</span>
01099 <span class="comment"></span>
01100 <span class="comment">    If a value entry with a Value ID (i.e. name) matching the</span>
01101 <span class="comment">    one specified by ValueName exists, it is deleted and replaced</span>
01102 <span class="comment">    with the one specified.  If no such value entry exists, a new</span>
01103 <span class="comment">    one is created.  NULL is a legal Value ID.  While Value IDs must</span>
01104 <span class="comment">    be unique within any given key, the same Value ID may appear</span>
01105 <span class="comment">    in many different keys.</span>
01106 <span class="comment"></span>
01107 <span class="comment">Arguments:</span>
01108 <span class="comment"></span>
01109 <span class="comment">    KeyControlBlock - pointer to kcb for the key to operate on</span>
01110 <span class="comment"></span>
01111 <span class="comment">    ValueName - The unique (relative to the containing key) name</span>
01112 <span class="comment">        of the value entry.  May be NULL.</span>
01113 <span class="comment"></span>
01114 <span class="comment">    Type - The integer type number of the value entry.</span>
01115 <span class="comment"></span>
01116 <span class="comment">    Data - Pointer to buffer with actual data for the value entry.</span>
01117 <span class="comment"></span>
01118 <span class="comment">    DataSize - Size of Data buffer.</span>
01119 <span class="comment"></span>
01120 <span class="comment"></span>
01121 <span class="comment">Return Value:</span>
01122 <span class="comment"></span>
01123 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01124 <span class="comment"></span>
01125 <span class="comment">        &lt;TBS&gt;</span>
01126 <span class="comment"></span>
01127 <span class="comment">--*/</span>
01128 {
01129     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
01130     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01131     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> oldchild;
01132     ULONG       count;
01133     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01134     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01135     ULONG       StorageType;
01136     ULONG       TempData;
01137     BOOLEAN     found;
01138     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>  pdata;
01139     LARGE_INTEGER systemtime;
01140     ULONG compareSize,mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01141 
01142     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmSetValueKey\n"</span>));
01143 
01144     <a class="code" href="../../d6/d3/cmwraper_8c.html#a14">CmpLockRegistry</a>();
01145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<span class="keyword">sizeof</span>(ULONG) == <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>);
01146 
01147     <span class="comment">// Mark the hive as read only</span>
01148     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01149 
01150     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01151         <span class="comment">//</span>
01152         <span class="comment">// Check that we are not being asked to add a value to a key</span>
01153         <span class="comment">// that has been deleted</span>
01154         <span class="comment">//</span>
01155         <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01156             status = STATUS_KEY_DELETED;
01157             <span class="keywordflow">goto</span> Exit;
01158         }
01159 
01160         <span class="comment">//</span>
01161         <span class="comment">// Check to see if this is a symbolic link node.  If so caller</span>
01162         <span class="comment">// is only allowed to create/change the SymbolicLinkValue</span>
01163         <span class="comment">// value name</span>
01164         <span class="comment">//</span>
01165 
01166         <span class="keywordflow">if</span> (KeyControlBlock-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp;
01167             (Type != REG_LINK ||
01168              <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01169              !<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)))
01170         {
01171             <span class="comment">//</span>
01172             <span class="comment">// Disallow attempts to manipulate any value names under a symbolic link</span>
01173             <span class="comment">// except for the "SymbolicLinkValue" value name or type other than REG_LINK</span>
01174             <span class="comment">//</span>
01175 
01176             <span class="comment">// Mark the hive as read only</span>
01177             <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01178 
01179             status = STATUS_ACCESS_DENIED;
01180             <span class="keywordflow">goto</span> Exit;
01181         }
01182 
01183         <span class="comment">//</span>
01184         <span class="comment">// get reference to parent key,</span>
01185         <span class="comment">//</span>
01186         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01187         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01188         parent = KeyControlBlock-&gt;KeyNode;
01189 
01190         <span class="comment">//</span>
01191         <span class="comment">// try to find an existing value entry by the same name</span>
01192         <span class="comment">//</span>
01193         count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01194         found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01195 
01196         <span class="keywordflow">if</span> (count &gt; 0) {
01197             oldchild = <a class="code" href="../../d4/d3/cmtree_8c.html#a0">CmpFindNameInList</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01198                                          &amp;parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>,
01199                                          <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01200                                          &amp;pdata,
01201                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01202 
01203             <span class="keywordflow">if</span> (oldchild != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01204                 found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01205             }
01206         }
01207         <span class="comment">//</span>
01208         <span class="comment">// Performance Hack:</span>
01209         <span class="comment">// If a Set is asking us to set a key to the current value (IE does this a lot)</span>
01210         <span class="comment">// drop it (and, therefore, the last modified time) on the floor, but return success</span>
01211         <span class="comment">// this stops the page from being dirtied, and us having to flush the registry.</span>
01212         <span class="comment">//</span>
01213         <span class="comment">//</span>
01214         <span class="keywordflow">if</span> (mustChange == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01215             <span class="keywordflow">break</span>; <span class="comment">//while</span>
01216         }
01217         <span class="keywordflow">if</span> ((found) &amp;&amp;
01218             (Type == pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>)) {
01219 
01220             <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pcmpdata;
01221 
01222             <span class="keywordflow">if</span> (DataSize == (pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> &amp; ~<a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>)) {
01223 
01224                 <span class="keywordflow">if</span> (DataSize &gt; 0) {
01225                     <span class="comment">//</span>
01226                     <span class="comment">//check for small values</span>
01227                     <span class="comment">//</span>
01228                     <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a> ) {
01229                         pcmpdata = (<a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a>)&amp;pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>;
01230                     } <span class="keywordflow">else</span> {
01231                         pcmpdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01232                     }
01233 
01234                     <span class="keywordflow">try</span> {
01235                         compareSize = (ULONG)RtlCompareMemory ((PVOID)pcmpdata,Data,(DataSize &amp; ~<a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>));
01236                     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01237                         
01238                         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01239                             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01240                         }
01241                         status = GetExceptionCode();
01242                         <span class="keywordflow">goto</span> Exit;
01243                     }
01244                 }<span class="keywordflow">else</span> {
01245                     compareSize = 0;
01246                 }
01247 
01248                 <span class="keywordflow">if</span> (compareSize == DataSize) {
01249                     status = STATUS_SUCCESS;
01250                     <span class="keywordflow">goto</span> Exit;
01251                 }
01252             }
01253 
01254         }
01255 
01256         <span class="comment">//</span>
01257         <span class="comment">// To Get here, we must either be changing a value, or setting a new one</span>
01258         <span class="comment">//</span>
01259         mustChange=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01260         <span class="comment">//</span>
01261         <span class="comment">// We're going through these gyrations so that if someone does come in and try and delete the</span>
01262         <span class="comment">// key we're setting we're safe. Once we know we have to change the key, take the</span>
01263         <span class="comment">// Exclusive (write) lock then restart</span>
01264         <span class="comment">//</span>
01265         <span class="comment">//</span>
01266         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01267         <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01268 
01269     }<span class="comment">// while</span>
01270 
01271     <span class="comment">// It's a different or new value, mark it dirty, since we'll</span>
01272     <span class="comment">// at least set its time stamp</span>
01273 
01274     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
01275         status = STATUS_NO_LOG_SPACE;
01276         <span class="keywordflow">goto</span> Exit;
01277     }
01278 
01279     StorageType = <a class="code" href="../../d0/d1/hivedata_8h.html#a19">HvGetCellType</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01280 
01281     <span class="comment">//</span>
01282     <span class="comment">// stash small data if relevent</span>
01283     <span class="comment">//</span>
01284     TempData = 0;
01285     <span class="keywordflow">if</span> ((DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) &amp;&amp;
01286         (DataSize &gt; 0))
01287     {
01288         <span class="keywordflow">try</span> {
01289             RtlMoveMemory(          <span class="comment">// yes, move memory, could be 1 byte</span>
01290                 &amp;TempData,          <span class="comment">// at the end of a page.</span>
01291                 Data,
01292                 DataSize
01293                 );
01294          } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01295             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01296                 KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01297             }
01298             status = GetExceptionCode();
01299             <span class="keywordflow">goto</span> Exit;
01300         }
01301     }
01302 
01303     <span class="keywordflow">if</span> (found) {
01304 
01305         <span class="comment">//</span>
01306         <span class="comment">// ----- Existing Value Entry Path -----</span>
01307         <span class="comment">//</span>
01308 
01309         <span class="comment">//</span>
01310         <span class="comment">// An existing value entry of the specified name exists,</span>
01311         <span class="comment">// set our data into it.</span>
01312         <span class="comment">//</span>
01313         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01314                                         oldchild,
01315                                         pdata,
01316                                         Type,
01317                                         Data,
01318                                         DataSize,
01319                                         StorageType,
01320                                         TempData);
01321 
01322     } <span class="keywordflow">else</span> {
01323 
01324         <span class="comment">//</span>
01325         <span class="comment">// ----- New Value Entry Path -----</span>
01326         <span class="comment">//</span>
01327 
01328         <span class="comment">//</span>
01329         <span class="comment">// Either there are no existing value entries, or the one</span>
01330         <span class="comment">// specified is not in the list.  In either case, create and</span>
01331         <span class="comment">// fill a new one, and add it to the list</span>
01332         <span class="comment">//</span>
01333         status = <a class="code" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01334                                    parent,
01335                                    <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
01336                                    Type,
01337                                    Data,
01338                                    DataSize,
01339                                    StorageType,
01340                                    TempData);
01341     }
01342 
01343     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01344 
01345         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> &lt; <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length) {
01346             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o13">MaxValueNameLen</a> = <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length;
01347         }
01348 
01349         <span class="keywordflow">if</span> (parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> &lt; DataSize) {
01350             parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o14">MaxValueDataLen</a> = DataSize;
01351         }
01352 
01353         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01354         parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01355 
01356         <span class="comment">//</span>
01357         <span class="comment">// Update the cache, no need for KCB lock as the registry is locked exclusively.</span>
01358         <span class="comment">//</span>
01359         <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01360 
01361         <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(KeyControlBlock);
01362 
01363         KeyControlBlock-&gt;ValueCache.Count = parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a>;
01364         KeyControlBlock-&gt;ValueCache.ValueList = (ULONG_PTR) parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a>;
01365 
01366         <a class="code" href="../../d6/d3/cmwraper_8c.html#a13">CmpReportNotify</a>(KeyControlBlock,
01367                         KeyControlBlock-&gt;KeyHive,
01368                         KeyControlBlock-&gt;KeyCell,
01369                         REG_NOTIFY_CHANGE_LAST_SET);
01370     }
01371 
01372 Exit:
01373     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01374   
01375     <span class="comment">// Mark the hive as read only</span>
01376     <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(KeyControlBlock-&gt;KeyHive);
01377 
01378     <span class="keywordflow">return</span> status;
01379 }
01380 
01381 
01382 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01383"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a9">01383</a> <a class="code" href="../../d8/d9/cmapi_8c.html#a9">CmpSetValueKeyExisting</a>(
01384     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
01385     IN HCELL_INDEX OldChild,
01386     IN <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvalue,
01387     IN ULONG Type,
01388     IN PVOID Data,
01389     IN ULONG DataSize,
01390     IN ULONG StorageType,
01391     IN ULONG TempData
01392     )
01393 <span class="comment">/*++</span>
01394 <span class="comment"></span>
01395 <span class="comment">Routine Description:</span>
01396 <span class="comment"></span>
01397 <span class="comment">    Helper for CmSetValueKey, implements the case where the value entry</span>
01398 <span class="comment">    being set already exists.</span>
01399 <span class="comment"></span>
01400 <span class="comment">Arguments:</span>
01401 <span class="comment"></span>
01402 <span class="comment">    Hive - hive of interest</span>
01403 <span class="comment"></span>
01404 <span class="comment">    OldChild - hcell_index of the value entry body to which we are to</span>
01405 <span class="comment">                    set new data</span>
01406 <span class="comment"></span>
01407 <span class="comment">    Type - The integer type number of the value entry.</span>
01408 <span class="comment"></span>
01409 <span class="comment">    Data - Pointer to buffer with actual data for the value entry.</span>
01410 <span class="comment"></span>
01411 <span class="comment">    DataSize - Size of Data buffer.</span>
01412 <span class="comment"></span>
01413 <span class="comment">    StorageType - stable or volatile</span>
01414 <span class="comment"></span>
01415 <span class="comment">    TempData - small values are passed here</span>
01416 <span class="comment"></span>
01417 <span class="comment">Return Value:</span>
01418 <span class="comment"></span>
01419 <span class="comment">    STATUS_SUCCESS if it worked, appropriate status code if it did not</span>
01420 <span class="comment"></span>
01421 <span class="comment">--*/</span>
01422 {
01423     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DataCell;
01424     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
01425     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
01426     ULONG realsize;
01427     BOOLEAN small;
01428     PUCHAR      StashBuffer;
01429     ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01430 
01431     <a class="code" href="../../d1/d2/cmp_8h.html#a61">ASSERT_CM_LOCK_OWNED</a>();
01432 
01433 
01434     <span class="comment">//</span>
01435     <span class="comment">// value entry by the specified name already exists</span>
01436     <span class="comment">// oldchild is hcell_index of its value entry body</span>
01437     <span class="comment">//  which we will always edit, so mark it dirty</span>
01438     <span class="comment">//</span>
01439     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, OldChild)) {
01440         <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01441     }
01442 
01443     small = <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(realsize, pvalue-&gt;u.KeyValue.DataLength);
01444 
01445     <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {               <span class="comment">// small</span>
01446 
01447         <span class="comment">//</span>
01448         <span class="comment">// We are storing a small datum, TempData has data.</span>
01449         <span class="comment">//</span>
01450         <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0))
01451         {
01452             <span class="comment">//</span>
01453             <span class="comment">// value entry has existing external data to free</span>
01454             <span class="comment">//</span>
01455             <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pvalue-&gt;u.KeyValue.Data)) {
01456                 <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01457             }
01458             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pvalue-&gt;u.KeyValue.Data);
01459         }
01460 
01461         <span class="comment">//</span>
01462         <span class="comment">// write our new small data into value entry body</span>
01463         <span class="comment">//</span>
01464         pvalue-&gt;u.KeyValue.DataLength = DataSize + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01465         pvalue-&gt;u.KeyValue.Data = TempData;
01466         pvalue-&gt;u.KeyValue.Type = Type;
01467 
01468         <span class="keywordflow">return</span> STATUS_SUCCESS;
01469 
01470     } <span class="keywordflow">else</span> {                                            <span class="comment">// large</span>
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">// We are storing a "large" datum</span>
01474         <span class="comment">//</span>
01475 
01476         <span class="comment">//</span>
01477         <span class="comment">// See if we can write data on top of existing cell</span>
01478         <span class="comment">//</span>
01479         <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0)) {
01480 
01481             DataCell = pvalue-&gt;u.KeyValue.Data;
01482             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01483             pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell);
01484 
01485             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pdata) &gt; 0);
01486 
01487             <span class="keywordflow">if</span> (DataSize &lt;= (ULONG)(<a class="code" href="../../d8/d0/hivecell_8c.html#a15">HvGetCellSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pdata))) {
01488 
01489                 <span class="comment">//</span>
01490                 <span class="comment">// The existing data cell is big enough to hold the</span>
01491                 <span class="comment">// new data.  Attempt to copy to stash buffer. if</span>
01492                 <span class="comment">// we succeed we can copy directly onto the old cell.</span>
01493                 <span class="comment">// if we fail, we must allocate and fill a new cell,</span>
01494                 <span class="comment">// and replace the old one with it.</span>
01495                 <span class="comment">//</span>
01496                 <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell)) {
01497                     <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01498                 }
01499 
01500                 StashBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01501                 <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a>) {
01502 
01503                     StashBuffer = <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>;
01504 
01505                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (DataSize &lt;= <a class="code" href="../../d1/d2/cmp_8h.html#a70">CM_MAX_STASH</a>) {
01506 
01507                     <span class="comment">//</span>
01508                     <span class="comment">// Try to allocate a bigger stash buffer.  If it works, keep it and</span>
01509                     <span class="comment">// free the old one.  This prevents pool from becoming too fragmented</span>
01510                     <span class="comment">// if somebody (like SAM) is repeatedly setting very large values</span>
01511                     <span class="comment">//</span>
01512                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a> = ((DataSize + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1));
01513 
01514                     StashBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>, 'bSmC');
01515                     <span class="keywordflow">if</span> (StashBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a>);
01517                         <a class="code" href="../../d8/d9/cmapi_8c.html#a4">CmpStashBuffer</a> = StashBuffer;
01518                         <a class="code" href="../../d8/d9/cmapi_8c.html#a5">CmpStashBufferSize</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a5">BufferSize</a>;
01519                     }
01520                 }
01521 
01522                 <span class="keywordflow">if</span> (StashBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01523                     <span class="comment">//</span>
01524                     <span class="comment">// We have a stash buffer</span>
01525                     <span class="comment">//</span>
01526                     <span class="keywordflow">try</span> {
01527 
01528                         RtlCopyMemory(
01529                             StashBuffer,
01530                             Data,
01531                             DataSize
01532                             );
01533 
01534                     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01535                         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01536                             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01537                         }
01538                         <span class="keywordflow">return</span> GetExceptionCode();
01539                     }
01540 
01541 
01542                     <span class="comment">//</span>
01543                     <span class="comment">// We have filled the stash buffer, copy data and finish</span>
01544                     <span class="comment">//</span>
01545                     RtlCopyMemory(
01546                         pdata,
01547                         StashBuffer,
01548                         DataSize
01549                         );
01550 
01551                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StashBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01552 
01553                     pvalue-&gt;u.KeyValue.DataLength = DataSize;
01554                     pvalue-&gt;u.KeyValue.Type = Type;
01555 
01556                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01557 
01558                  } <span class="comment">// else stashbuffer == null</span>
01559             } <span class="comment">// else existing cell is too small</span>
01560         } <span class="comment">// else there is no existing cell</span>
01561     } <span class="comment">// new cell needed (always large)</span>
01562 
01563     <span class="comment">//</span>
01564     <span class="comment">// Either the existing cell is not large enough, or does</span>
01565     <span class="comment">// not exist, or we couldn't stash successfully.</span>
01566     <span class="comment">//</span>
01567     <span class="comment">// Allocate and fill a new cell.  Free the old one.  Store</span>
01568     <span class="comment">// the new's index into the value entry body.</span>
01569     <span class="comment">//</span>
01570     NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataSize, StorageType);
01571 
01572     <span class="keywordflow">if</span> (NewCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01573         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01574     }
01575 
01576     <span class="comment">//</span>
01577     <span class="comment">// fill the new data cell</span>
01578     <span class="comment">//</span>
01579     pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
01580     <span class="keywordflow">try</span> {
01581 
01582         RtlMoveMemory(
01583             pdata,
01584             Data,
01585             DataSize
01586             );
01587 
01588     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01589         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01590             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01591         }
01592         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
01593         <span class="keywordflow">return</span> GetExceptionCode();
01594     }
01595 
01596     <span class="comment">//</span>
01597     <span class="comment">// free the old data cell</span>
01598     <span class="comment">//</span>
01599     <span class="keywordflow">if</span> ((! small) &amp;&amp; (realsize &gt; 0)) {
01600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(pvalue-&gt;u.KeyValue.Data != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01601         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pvalue-&gt;u.KeyValue.Data)) {
01602             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
01603             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01604         }
01605         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, pvalue-&gt;u.KeyValue.Data);
01606     }
01607 
01608     <span class="comment">//</span>
01609     <span class="comment">// set body</span>
01610     <span class="comment">//</span>
01611     pvalue-&gt;u.KeyValue.DataLength = DataSize;
01612     pvalue-&gt;u.KeyValue.Data = NewCell;
01613     pvalue-&gt;u.KeyValue.Type = Type;
01614 
01615     <span class="keywordflow">return</span> STATUS_SUCCESS;
01616 }
01617 
01618 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01619"></a><a class="code" href="../../d8/d9/cmapi_8c.html#a10">01619</a> <a class="code" href="../../d8/d9/cmapi_8c.html#a10">CmpSetValueKeyNew</a>(
01620     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>  Hive,
01621     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Parent,
01622     IN PUNICODE_STRING ValueName,
01623     IN ULONG Type,
01624     IN PVOID Data,
01625     IN ULONG DataSize,
01626     IN ULONG StorageType,
01627     IN ULONG TempData
01628     )
01629 <span class="comment">/*++</span>
01630 <span class="comment"></span>
01631 <span class="comment">Routine Description:</span>
01632 <span class="comment"></span>
01633 <span class="comment">    Helper for CmSetValueKey, implements the case where the value entry</span>
01634 <span class="comment">    being set does not exist.  Will create new value entry and data,</span>
01635 <span class="comment">    place in list (which may be created)</span>
01636 <span class="comment"></span>
01637 <span class="comment">Arguments:</span>
01638 <span class="comment"></span>
01639 <span class="comment">    Hive - hive of interest</span>
01640 <span class="comment"></span>
01641 <span class="comment">    Parent - pointer to key node value entry is for</span>
01642 <span class="comment"></span>
01643 <span class="comment">    ValueName - The unique (relative to the containing key) name</span>
01644 <span class="comment">        of the value entry.  May be NULL.</span>
01645 <span class="comment"></span>
01646 <span class="comment">    TitleIndex - Supplies the title index for ValueName.  The title</span>
01647 <span class="comment">        index specifies the index of the localized alias for the ValueName.</span>
01648 <span class="comment"></span>
01649 <span class="comment">    Type - The integer type number of the value entry.</span>
01650 <span class="comment"></span>
01651 <span class="comment">    Data - Pointer to buffer with actual data for the value entry.</span>
01652 <span class="comment"></span>
01653 <span class="comment">    DataSize - Size of Data buffer.</span>
01654 <span class="comment"></span>
01655 <span class="comment">    StorageType - stable or volatile</span>
01656 <span class="comment"></span>
01657 <span class="comment">    TempData - small data values passed here</span>
01658 <span class="comment"></span>
01659 <span class="comment"></span>
01660 <span class="comment">Return Value:</span>
01661 <span class="comment"></span>
01662 <span class="comment">    STATUS_SUCCESS if it worked, appropriate status code if it did not</span>
01663 <span class="comment"></span>
01664 <span class="comment">--*/</span>
01665 {
01666     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pvalue;
01667     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ValueCell;
01668     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> DataCell;
01669     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> pdata;
01670     ULONG   count;
01671     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NewCell;
01672     ULONG AllocateSize;
01673 
01674     <span class="comment">//</span>
01675     <span class="comment">// Either Count == 0 (no list) or our entry is simply not in</span>
01676     <span class="comment">// the list.  Create a new value entry body, and data.  Add to list.</span>
01677     <span class="comment">// (May create the list.)</span>
01678     <span class="comment">//</span>
01679     <span class="keywordflow">if</span> (Parent-&gt;ValueList.Count != 0) {
01680         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Parent-&gt;ValueList.List != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>);
01681         <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Parent-&gt;ValueList.List)) {
01682             <span class="keywordflow">return</span> STATUS_NO_LOG_SPACE;
01683         }
01684     }
01685 
01686     <span class="comment">//</span>
01687     <span class="comment">// allocate the body of the value entry, and the data</span>
01688     <span class="comment">//</span>
01689     ValueCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(
01690                     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01691                     <a class="code" href="../../d1/d2/cmp_8h.html#a100">CmpHKeyValueSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>),
01692                     StorageType
01693                     );
01694 
01695     <span class="keywordflow">if</span> (ValueCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01696         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01697     }
01698 
01699     DataCell = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01700     <span class="keywordflow">if</span> (DataSize &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
01701         DataCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataSize, StorageType);
01702         <span class="keywordflow">if</span> (DataCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01703             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01704             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01705         }
01706     }
01707 
01708     <span class="comment">//</span>
01709     <span class="comment">// map in the body, and fill in its fixed portion</span>
01710     <span class="comment">//</span>
01711     pvalue = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01712     pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a34">CM_KEY_VALUE_SIGNATURE</a>;
01713 
01714     <span class="comment">//</span>
01715     <span class="comment">// fill in the variable portions of the new value entry,  name and</span>
01716     <span class="comment">// and data are copied from caller space, could fault.</span>
01717     <span class="comment">//</span>
01718     <span class="keywordflow">try</span> {
01719 
01720         <span class="comment">//</span>
01721         <span class="comment">// fill in the name</span>
01722         <span class="comment">//</span>
01723         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01724                                                     pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o7">Name</a>,
01725                                                     <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
01726     } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01727         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01728             KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01729         }
01730 
01731         <span class="comment">//</span>
01732         <span class="comment">// We have bombed out loading user data, clean up and exit.</span>
01733         <span class="comment">//</span>
01734         <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01735             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell);
01736         }
01737         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01738         <span class="keywordflow">return</span> GetExceptionCode();
01739     }
01740 
01741     <span class="keywordflow">if</span> (pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o1">NameLength</a> &lt; <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Length) {
01742         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a37">VALUE_COMP_NAME</a>;
01743     } <span class="keywordflow">else</span> {
01744         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o5">Flags</a> = 0;
01745     }
01746 
01747     <span class="comment">//</span>
01748     <span class="comment">// fill in the data</span>
01749     <span class="comment">//</span>
01750     <span class="keywordflow">if</span> (DataSize &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a36">CM_KEY_VALUE_SMALL</a>) {
01751         pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell);
01752 
01753         <span class="keywordflow">try</span> {
01754 
01755             RtlMoveMemory(pdata, Data, DataSize);
01756 
01757         } except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01758             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a19">CML_API</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a38">CMS_EXCEPTION</a>) {
01759                 KdPrint((<span class="stringliteral">"!!CmSetValueKey: code:%08lx\n"</span>, GetExceptionCode()));
01760             }
01761 
01762             <span class="comment">//</span>
01763             <span class="comment">// We have bombed out loading user data, clean up and exit.</span>
01764             <span class="comment">//</span>
01765             <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01766                 <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell);
01767             }
01768             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01769             <span class="keywordflow">return</span> GetExceptionCode();
01770         }
01771 
01772         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = DataSize;
01773         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = DataCell;
01774 
01775     } <span class="keywordflow">else</span> {
01776         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a> = DataSize + <a class="code" href="../../d9/d0/cmdata_8h.html#a35">CM_KEY_VALUE_SPECIAL_SIZE</a>;
01777         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a> = TempData;
01778     }
01779 
01780     <span class="comment">//</span>
01781     <span class="comment">// either add ourselves to list, or make new one with us in it.</span>
01782     <span class="comment">//</span>
01783     count = Parent-&gt;ValueList.Count;
01784     count++;
01785     <span class="keywordflow">if</span> (count &gt; 1) {
01786 
01787         <span class="keywordflow">if</span> (count &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a71">CM_MAX_REASONABLE_VALUES</a>) {
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">// A reasonable number of values, allocate just enough</span>
01791             <span class="comment">// space.</span>
01792             <span class="comment">//</span>
01793 
01794             AllocateSize = count * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01795         } <span class="keywordflow">else</span> {
01796 
01797             <span class="comment">//</span>
01798             <span class="comment">// An excessive number of values, pad the allocation out</span>
01799             <span class="comment">// to avoid fragmentation. (if there's this many values,</span>
01800             <span class="comment">// there'll probably be more pretty soon)</span>
01801             <span class="comment">//</span>
01802             AllocateSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(count, <a class="code" href="../../d1/d2/cmp_8h.html#a71">CM_MAX_REASONABLE_VALUES</a>) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>);
01803             <span class="keywordflow">if</span> (AllocateSize &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>) {
01804                 AllocateSize = <a class="code" href="../../d6/d0/hive_8h.html#a2">ROUND_UP</a>(AllocateSize, <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>);
01805             }
01806         }
01807         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a20">HvReallocateCell</a>(
01808                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01809                         Parent-&gt;ValueList.List,
01810                         AllocateSize
01811                         );
01812     } <span class="keywordflow">else</span> {
01813         NewCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>), StorageType);
01814     }
01815 
01816     <span class="comment">//</span>
01817     <span class="comment">// put ourselves on the list</span>
01818     <span class="comment">//</span>
01819     <span class="keywordflow">if</span> (NewCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01820         Parent-&gt;ValueList.List = NewCell;
01821         pdata = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, NewCell);
01822 
01823         pdata-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o4">KeyList</a>[count-1] = ValueCell;
01824         Parent-&gt;ValueList.Count = count;
01825         pvalue-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o1">KeyValue</a>.<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> = Type;
01826 
01827         <span class="keywordflow">return</span> STATUS_SUCCESS;
01828 
01829     } <span class="keywordflow">else</span> {
01830         <span class="comment">// out of space, free all allocated stuff</span>
01831         <span class="keywordflow">if</span> (DataCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01832             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, DataCell);
01833         }
01834         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, ValueCell);
01835         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01836     }
01837 }
01838 
01839 
01840 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01841"></a><a class="code" href="../../d1/d2/cmp_8h.html#a238">01841</a> <a class="code" href="../../d1/d2/cmp_8h.html#a238">CmSetLastWriteTimeKey</a>(
01842     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> KeyControlBlock,
01843     IN PLARGE_INTEGER LastWriteTime
01844     )
01845 <span class="comment">/*++</span>
01846 <span class="comment"></span>
01847 <span class="comment">Routine Description:</span>
01848 <span class="comment"></span>
01849 <span class="comment">    The LastWriteTime associated with a key node can be set with</span>
01850 <span class="comment">    CmSetLastWriteTimeKey</span>
01851 <span class="comment"></span>
01852 <span class="comment">Arguments:</span>
01853 <span class="comment"></span>
01854 <span class="comment">    KeyControlBlock - pointer to kcb for the key to operate on</span>
01855 <span class="comment"></span>
01856 <span class="comment">    LastWriteTime - new time for key</span>
01857 <span class="comment"></span>
01858 <span class="comment">Return Value:</span>
01859 <span class="comment"></span>
01860 <span class="comment">    NTSTATUS - Result code from call, among the following:</span>
01861 <span class="comment"></span>
01862 <span class="comment">        &lt;TBS&gt;</span>
01863 <span class="comment"></span>
01864 <span class="comment">--*/</span>
01865 {
01866     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> parent;
01867     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
01868     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01869     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
01870 
01871     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmSetLastWriteTimeKey\n"</span>));
01872 
01873     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
01874 
01875     <span class="comment">//</span>
01876     <span class="comment">// Check that we are not being asked to modify a key</span>
01877     <span class="comment">// that has been deleted</span>
01878     <span class="comment">//</span>
01879     <span class="keywordflow">if</span> (KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01880         status = STATUS_KEY_DELETED;
01881         <span class="keywordflow">goto</span> Exit;
01882     }
01883 
01884     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = KeyControlBlock-&gt;KeyHive;
01885     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = KeyControlBlock-&gt;KeyCell;
01886     parent = KeyControlBlock-&gt;KeyNode;
01887     <span class="keywordflow">if</span> (! <a class="code" href="../../d0/d2/hivesync_8c.html#a7">HvMarkCellDirty</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>)) {
01888         status = STATUS_NO_LOG_SPACE;
01889         <span class="keywordflow">goto</span> Exit;
01890     }
01891 
01892     parent-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = *LastWriteTime;
01893 
01894 Exit:
01895     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
01896     <span class="keywordflow">return</span> status;
01897 }
01898 
01899 
01900 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01901"></a><a class="code" href="../../d1/d2/cmp_8h.html#a240">01901</a> <a class="code" href="../../d1/d2/cmp_8h.html#a240">CmLoadKey</a>(
01902     IN POBJECT_ATTRIBUTES TargetKey,
01903     IN POBJECT_ATTRIBUTES SourceFile,
01904     IN ULONG Flags
01905     )
01906 
01907 <span class="comment">/*++</span>
01908 <span class="comment"></span>
01909 <span class="comment">Routine Description:</span>
01910 <span class="comment"></span>
01911 <span class="comment">    A hive (file in the format created by NtSaveKey) may be linked</span>
01912 <span class="comment">    into the active registry with this call.  UNLIKE NtRestoreKey,</span>
01913 <span class="comment">    the file specified to NtLoadKey will become the actual backing</span>
01914 <span class="comment">    store of part of the registry (that is, it will NOT be copied.)</span>
01915 <span class="comment"></span>
01916 <span class="comment">    The file may have an associated .log file.</span>
01917 <span class="comment"></span>
01918 <span class="comment">    If the hive file is marked as needing a .log file, and one is</span>
01919 <span class="comment">    not present, the call will fail.</span>
01920 <span class="comment"></span>
01921 <span class="comment">    The name specified by SourceFile must be such that ".log" can</span>
01922 <span class="comment">    be appended to it to generate the name of the log file.  Thus,</span>
01923 <span class="comment">    on FAT file systems, the hive file may not have an extension.</span>
01924 <span class="comment"></span>
01925 <span class="comment">    This call is used by logon to make the user's profile available</span>
01926 <span class="comment">    in the registry.  It is not intended for use doing backup,</span>
01927 <span class="comment">    restore, etc.  Use NtRestoreKey for that.</span>
01928 <span class="comment"></span>
01929 <span class="comment">    N.B.  This routine assumes that the object attributes for the file</span>
01930 <span class="comment">          to be opened have been captured into kernel space so that</span>
01931 <span class="comment">          they can safely be passed to the worker thread to open the file</span>
01932 <span class="comment">          and do the actual I/O.</span>
01933 <span class="comment"></span>
01934 <span class="comment">Arguments:</span>
01935 <span class="comment"></span>
01936 <span class="comment">    TargetKey - specifies the path to a key to link the hive to.</span>
01937 <span class="comment">                path must be of the form "\registry\user&lt;username&gt;"</span>
01938 <span class="comment"></span>
01939 <span class="comment">    SourceFile - specifies a file.  while file could be remote,</span>
01940 <span class="comment">                that is strongly discouraged.</span>
01941 <span class="comment"></span>
01942 <span class="comment">    Flags - specifies any flags that should be used for the load operation.</span>
01943 <span class="comment">            The only valid flag is REG_NO_LAZY_FLUSH.</span>
01944 <span class="comment"></span>
01945 <span class="comment">Return Value:</span>
01946 <span class="comment"></span>
01947 <span class="comment">    NTSTATUS - values TBS.</span>
01948 <span class="comment"></span>
01949 <span class="comment">--*/</span>
01950 {
01951     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
01952     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01953     BOOLEAN Allocate;
01954     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
01955     SECURITY_QUALITY_OF_SERVICE ServiceQos;
01956     <a class="code" href="../../d8/d0/struct__SECURITY__CLIENT__CONTEXT.html">SECURITY_CLIENT_CONTEXT</a> ClientSecurityContext;
01957 
01958 
01959     <span class="comment">//</span>
01960     <span class="comment">// Obtain the security context here so we can use it</span>
01961     <span class="comment">// later to impersonate the user, which we will do</span>
01962     <span class="comment">// if we cannot access the file as SYSTEM.  This</span>
01963     <span class="comment">// usually occurs if the file is on a remote machine.</span>
01964     <span class="comment">//</span>
01965     ServiceQos.Length = <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
01966     ServiceQos.ImpersonationLevel = SecurityImpersonation;
01967     ServiceQos.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
01968     ServiceQos.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01969     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a>(CONTAINING_RECORD(<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>(),<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,Tcb),
01970                                     &amp;ServiceQos,
01971                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01972                                     &amp;ClientSecurityContext);
01973     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01974         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01975     }
01976 
01977     <span class="comment">//</span>
01978     <span class="comment">// Do not lock the registry; Instead set the RegistryLockAquired member </span>
01979     <span class="comment">// of REGISTRY_COMMAND so CmpWorker can lock it after opening the hive files</span>
01980     <span class="comment">//</span>
01981     <span class="comment">//CmpLockRegistryExclusive();</span>
01982     <span class="comment">//</span>
01983 
01984     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01985     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>;
01986     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01987     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o6">FileAttributes</a> = SourceFile;
01988     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a> = &amp;ClientSecurityContext;
01989 
01990     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
01991     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
01992 
01993     <a class="code" href="../../d0/d5/se_8h.html#a12">SeDeleteClientSecurity</a>( &amp;ClientSecurityContext );
01994 
01995     NewHive = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>;
01996     Allocate = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a>;
01997 
01998     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01999         <span class="keywordflow">if</span>( Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> ) {
02000             <span class="comment">// if CmpWorker has locked the registry, unlock it now.</span>
02001             <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02002         }
02003         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02004     } <span class="keywordflow">else</span> {
02005         <span class="comment">//</span>
02006         <span class="comment">// if we got here, CmpWorker should have locked the registry exclusive.</span>
02007         <span class="comment">//</span>
02008         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> );
02009     }
02010 
02011     <span class="comment">//</span>
02012     <span class="comment">// if this is a NO_LAZY_FLUSH hive, set the appropriate bit.</span>
02013     <span class="comment">//</span>
02014     <span class="keywordflow">if</span> (Flags &amp; REG_NO_LAZY_FLUSH) {
02015         NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> |= <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>;
02016     }
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// We now have a succesfully loaded and initialized CmHive, so we</span>
02020     <span class="comment">// just need to link that into the appropriate spot in the master hive.</span>
02021     <span class="comment">//</span>
02022     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d3/cmwraper_8c.html#a28">CmpLinkHiveToMaster</a>(TargetKey-&gt;ObjectName,
02023                                  TargetKey-&gt;RootDirectory,
02024                                  NewHive,
02025                                  Allocate,
02026                                  TargetKey-&gt;SecurityDescriptor);
02027 
02028     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02029     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02030         <span class="comment">//</span>
02031         <span class="comment">// add new hive to hivelist</span>
02032         <span class="comment">//</span>
02033         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a108">REG_CMD_ADD_HIVE_LIST</a>;
02034 
02035     } <span class="keywordflow">else</span> {
02036         <span class="comment">//</span>
02037         <span class="comment">// Close the files we've opened.</span>
02038         <span class="comment">//</span>
02039         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02040     }
02041     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02042 
02043     <span class="comment">//</span>
02044     <span class="comment">// We've given user chance to log on, so turn on quota</span>
02045     <span class="comment">//</span>
02046     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
02047         (<a class="code" href="../../d8/d9/cmapi_8c.html#a3">CmpWasSetupBoot</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02048         <a class="code" href="../../d8/d9/cmapi_8c.html#a2">CmpProfileLoaded</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02049         <a class="code" href="../../d1/d2/cmp_8h.html#a249">CmpSetGlobalQuotaAllowed</a>();
02050     }
02051 
02052     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02053     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02054 }
02055 
02056 <span class="preprocessor">#if DBG</span>
02057 <span class="preprocessor"></span>ULONG
02058 CmpUnloadKeyWorker(
02059     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Current,
02060     PVOID                 Context1,
02061     PVOID                 Context2
02062     )
02063 {
02064     PUNICODE_STRING ConstructedName;
02065     <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a> == <a class="code" href="../../d3/d1/threads_8h.html#a107">Context1</a>) {
02066         ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(Current);
02067 
02068         <span class="keywordflow">if</span> (ConstructedName) {
02069             KdPrint((<span class="stringliteral">"%wZ\n"</span>, ConstructedName));
02070             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | PROTECTED_POOL);
02071         }
02072     }
02073     <span class="keywordflow">return</span> <a class="code" href="../../d1/d2/cmp_8h.html#a114">KCB_WORKER_CONTINUE</a>;   <span class="comment">// always keep searching</span>
02074 }
02075 <span class="preprocessor">#endif</span>
02076 <span class="preprocessor"></span>
02077 
02078 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02079"></a><a class="code" href="../../d1/d2/cmp_8h.html#a241">02079</a> <a class="code" href="../../d1/d2/cmp_8h.html#a241">CmUnloadKey</a>(
02080     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
02081     IN HCELL_INDEX Cell,
02082     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> Kcb
02083     )
02084 
02085 <span class="comment">/*++</span>
02086 <span class="comment"></span>
02087 <span class="comment">Routine Description:</span>
02088 <span class="comment"></span>
02089 <span class="comment">    Unlinks a hive from its location in the registry, closes its file</span>
02090 <span class="comment">    handles, and deallocates all its memory.</span>
02091 <span class="comment"></span>
02092 <span class="comment">    There must be no key control blocks currently referencing the hive</span>
02093 <span class="comment">    to be unloaded.</span>
02094 <span class="comment"></span>
02095 <span class="comment">Arguments:</span>
02096 <span class="comment"></span>
02097 <span class="comment">    Hive - Supplies a pointer to the hive control structure for the</span>
02098 <span class="comment">           hive to be unloaded</span>
02099 <span class="comment"></span>
02100 <span class="comment">    Cell - supplies the HCELL_INDEX for the root cell of the hive.</span>
02101 <span class="comment"></span>
02102 <span class="comment">    Kcb - Supplies the key control block</span>
02103 <span class="comment"></span>
02104 <span class="comment">Return Value:</span>
02105 <span class="comment"></span>
02106 <span class="comment">    NTSTATUS</span>
02107 <span class="comment"></span>
02108 <span class="comment">--*/</span>
02109 
02110 {
02111     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> CmHive;
02112     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02113     BOOLEAN Success;
02114 
02115     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a21">CML_WORKER</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a33">CMS_CM</a>) KdPrint((<span class="stringliteral">"CmUnloadKey\n"</span>));
02116 
02117     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02118 
02119     <span class="comment">//</span>
02120     <span class="comment">// Make sure the cell passed in is the root cell of the hive.</span>
02121     <span class="comment">//</span>
02122     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> != <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a>) {
02123         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02124         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
02125     }
02126 
02127     <span class="comment">//</span>
02128     <span class="comment">// Make sure there are no open references to key control blocks</span>
02129     <span class="comment">// for this hive.  If there are none, then we can unload the hive.</span>
02130     <span class="comment">//</span>
02131 
02132     CmHive = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
02133     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d2/cmsubs_8c.html#a12">CmpSearchForOpenSubKeys</a>(Kcb,<a class="code" href="../../d9/d0/cmdata_8h.html#a105a100">SearchIfExist</a>) != 0) || (Kcb-&gt;RefCount != 1)) {
02134 <span class="preprocessor">#if DBG</span>
02135 <span class="preprocessor"></span>        KdPrint((<span class="stringliteral">"List of keys open against hive unload was attempted on:\n"</span>));
02136         <a class="code" href="../../d8/d2/cmsubs_8c.html#a21">CmpSearchKeyControlBlockTree</a>(
02137             CmpUnloadKeyWorker,
02138             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
02139             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02140             );
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>        <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02143         <span class="keywordflow">return</span>(STATUS_CANNOT_DELETE);
02144     }
02145 
02146     <span class="comment">//</span>
02147     <span class="comment">// Flush any dirty data to disk. If this fails, too bad.</span>
02148     <span class="comment">//</span>
02149     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a102">REG_CMD_FLUSH_KEY</a>;
02150     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o1">Hive</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02151     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o2">Cell</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
02152     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02153 
02154     <span class="comment">//</span>
02155     <span class="comment">// Remove the hive from the HiveFileList</span>
02156     <span class="comment">//</span>
02157     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a109">REG_CMD_REMOVE_HIVE_LIST</a>;
02158     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = (<a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
02159     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">// Unlink from master hive, remove from list</span>
02163     <span class="comment">//</span>
02164     Success = <a class="code" href="../../d1/d2/cmp_8h.html#a276">CmpDestroyHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
02165 
02166     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02167 
02168     <span class="keywordflow">if</span> (Success) {
02169         <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
02170 
02171         <span class="comment">//</span>
02172         <span class="comment">// Close the hive files</span>
02173         <span class="comment">//</span>
02174         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02175         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CmHive;
02176         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02177 
02178         <span class="comment">//</span>
02179         <span class="comment">// free the cm level structure</span>
02180         <span class="comment">//</span>
02181         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a> );
02182         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(CmHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o4">HiveLock</a>);
02183         <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(CmHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02184 
02185         <span class="keywordflow">return</span>(STATUS_SUCCESS);
02186     } <span class="keywordflow">else</span> {
02187         <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
02188     }
02189 
02190 }
02191 
02192 
02193 
02194 BOOLEAN
<a name="l02195"></a><a class="code" href="../../d1/d2/cmp_8h.html#a243">02195</a> <a class="code" href="../../d1/d2/cmp_8h.html#a243">CmpDoFlushAll</a>(
02196     VOID
02197     )
02198 <span class="comment">/*++</span>
02199 <span class="comment"></span>
02200 <span class="comment">Routine Description:</span>
02201 <span class="comment"></span>
02202 <span class="comment">    Flush all hives.</span>
02203 <span class="comment"></span>
02204 <span class="comment">    Runs in the context of the CmpWorkerThread.</span>
02205 <span class="comment"></span>
02206 <span class="comment">    Runs down list of Hives and applies HvSyncHive to them.</span>
02207 <span class="comment"></span>
02208 <span class="comment">    NOTE: Hives which are marked as HV_NOLAZYFLUSH are *NOT* flushed</span>
02209 <span class="comment">          by this call.  You must call HvSyncHive explicitly to flush</span>
02210 <span class="comment">          a hive marked as HV_NOLAZYFLUSH.</span>
02211 <span class="comment"></span>
02212 <span class="comment">Arguments:</span>
02213 <span class="comment"></span>
02214 <span class="comment">Return Value:</span>
02215 <span class="comment"></span>
02216 <span class="comment">    NONE</span>
02217 <span class="comment"></span>
02218 <span class="comment">--*/</span>
02219 {
02220     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02221     PLIST_ENTRY p;
02222     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a>     h;
02223     BOOLEAN     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    
02224 <span class="comment">/*</span>
02225 <span class="comment">    ULONG rc;</span>
02226 <span class="comment">*/</span>
02227     <span class="keyword">extern</span> <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">// If writes are not working, lie and say we succeeded, will</span>
02231     <span class="comment">// clean up in a short time.  Only early system init code</span>
02232     <span class="comment">// will ever know the difference.</span>
02233     <span class="comment">//</span>
02234     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/cmapi_8c.html#a0">CmpNoWrite</a>) {
02235         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02236     }
02237 
02238     <span class="comment">//</span>
02239     <span class="comment">// traverse list of hives, sync each one</span>
02240     <span class="comment">//</span>
02241     p = <a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>.Flink;
02242     <span class="keywordflow">while</span> (p != &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a1">CmpHiveListHead</a>) {
02243 
02244         h = CONTAINING_RECORD(p, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d4/d6/regext_8c.html#a0">HiveList</a>);
02245 
02246 <span class="comment">/*</span>
02247 <span class="comment">#if DBG</span>
02248 <span class="comment">        if (h!=CmpMasterHive) {</span>
02249 <span class="comment">            rc = CmCheckRegistry(h, FALSE);</span>
02250 <span class="comment"></span>
02251 <span class="comment">            if (rc!=0) {</span>
02252 <span class="comment">                KdPrint(("CmpDoFlushAll: corrupt hive, rc = %08lx\n",rc));</span>
02253 <span class="comment">                DbgBreakPoint();</span>
02254 <span class="comment">            }</span>
02255 <span class="comment">        }</span>
02256 <span class="comment">#endif</span>
02257 <span class="comment">*/</span>
02258         <span class="keywordflow">if</span> (!(h-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>.<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a10">HIVE_NOLAZYFLUSH</a>)) {
02259 
02260             <span class="comment">//</span>
02261             <span class="comment">//Lock the hive before we flush it.</span>
02262             <span class="comment">//-- since we now allow multiple readers</span>
02263             <span class="comment">// during a flush (a flush is considered a read)</span>
02264             <span class="comment">// we have to force a serialization on the vector table</span>
02265             <span class="comment">//</span>
02266             <a class="code" href="../../d1/d2/cmp_8h.html#a94">CmLockHive</a> (h);
02267             
02268             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/hivesync_8c.html#a13">HvSyncHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)h);
02269 
02270             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
02271                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02272             }
02273             <a class="code" href="../../d1/d2/cmp_8h.html#a95">CmUnlockHive</a> (h);
02274             <span class="comment">//</span>
02275             <span class="comment">// WARNNOTE - the above means that a lazy flush or</span>
02276             <span class="comment">//            or shutdown flush did not work.  we don't</span>
02277             <span class="comment">//            know why.  there is noone to report an error</span>
02278             <span class="comment">//            to, so continue on and hope for the best.</span>
02279             <span class="comment">//            (in theory, worst that can happen is user changes</span>
02280             <span class="comment">//             are lost.)</span>
02281             <span class="comment">//</span>
02282         }
02283 
02284 
02285         p = p-&gt;Flink;
02286     }
02287     
02288     <span class="keywordflow">return</span> Result;
02289 }
02290 
02291 
02292 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02293"></a><a class="code" href="../../d1/d2/cmp_8h.html#a233">02293</a> <a class="code" href="../../d1/d2/cmp_8h.html#a233">CmReplaceKey</a>(
02294     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
02295     IN HCELL_INDEX Cell,
02296     IN PUNICODE_STRING NewHiveName,
02297     IN PUNICODE_STRING OldFileName
02298     )
02299 
02300 <span class="comment">/*++</span>
02301 <span class="comment"></span>
02302 <span class="comment">Routine Description:</span>
02303 <span class="comment"></span>
02304 <span class="comment">    Renames the hive file for a running system and replaces it with a new</span>
02305 <span class="comment">    file.  The new file is not actually used until the next boot.</span>
02306 <span class="comment"></span>
02307 <span class="comment">Arguments:</span>
02308 <span class="comment"></span>
02309 <span class="comment">    Hive - Supplies a hive control structure for the hive to be replaced.</span>
02310 <span class="comment"></span>
02311 <span class="comment">    Cell - Supplies the HCELL_INDEX of the root cell of the hive to be</span>
02312 <span class="comment">           replaced.</span>
02313 <span class="comment"></span>
02314 <span class="comment">    NewHiveName - Supplies the name of the file which is to be installed</span>
02315 <span class="comment">            as the new hive.</span>
02316 <span class="comment"></span>
02317 <span class="comment">    OldFileName - Supplies the name of the file which the existing hive</span>
02318 <span class="comment">            file is to be renamed to.</span>
02319 <span class="comment"></span>
02320 <span class="comment">Return Value:</span>
02321 <span class="comment"></span>
02322 <span class="comment">    NTSTATUS</span>
02323 <span class="comment"></span>
02324 <span class="comment">--*/</span>
02325 
02326 {
02327     <a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html">REGISTRY_COMMAND</a> Command;
02328     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ObjectInfoBuffer[512];
02329     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02330     OBJECT_ATTRIBUTES Attributes;
02331     <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> NewHive;
02332     POBJECT_NAME_INFORMATION NameInfo;
02333     ULONG OldQuotaAllowed;
02334     ULONG OldQuotaWarning;
02335 
02336     <a class="code" href="../../d0/d3/cmsubs3_8c.html#a4">CmpLockRegistryExclusive</a>();
02337 
02338     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>) {
02339         <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02340         <span class="keywordflow">return</span> STATUS_FILE_RENAMED;
02341     }
02342 
02343     <span class="comment">//</span>
02344     <span class="comment">// temporarily disable registry quota as we will be giving this memory back immediately!</span>
02345     <span class="comment">//</span>
02346     OldQuotaAllowed = <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a>;
02347     OldQuotaWarning = <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a>;
02348     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02349     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a69">CM_WRAP_LIMIT</a>;
02350 
02351     <span class="comment">//</span>
02352     <span class="comment">// First open the new hive file and check to make sure it is valid.</span>
02353     <span class="comment">//</span>
02354     InitializeObjectAttributes(&amp;Attributes,
02355                                NewHiveName,
02356                                OBJ_CASE_INSENSITIVE,
02357                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02358                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02359 
02360     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o12">RegistryLockAquired</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02361     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a104">REG_CMD_HIVE_OPEN</a>;
02362     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o6">FileAttributes</a> = &amp;Attributes;
02363     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02364     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o16">ImpersonationContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02365     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02366     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02367     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02368         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02369     }
02370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o10">Allocate</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02371 
02372     NewHive = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a>;
02373 
02374     <span class="comment">//</span>
02375     <span class="comment">// The new hive exists, and is consistent, and we have it open.</span>
02376     <span class="comment">// Now rename the current hive file.</span>
02377     <span class="comment">//</span>
02378     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02379     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = OldFileName;
02380     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02381     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = <span class="keyword">sizeof</span>(ObjectInfoBuffer);
02382     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
02383     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02384     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02385     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02386             <span class="comment">//</span>
02387         <span class="comment">// rename failed, close the files associated with the new hive</span>
02388         <span class="comment">//</span>
02389         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02390         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02391         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02392         <span class="keywordflow">goto</span> <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>;
02393     }
02394 
02395     <span class="comment">//</span>
02396     <span class="comment">// The existing hive was successfully renamed, so try to rename the</span>
02397     <span class="comment">// new file to what the old hive file was named.  (which was returned</span>
02398     <span class="comment">// into ObjectInfoBuffer by the worker thread)</span>
02399     <span class="comment">//</span>
02400     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> |= <a class="code" href="../../d6/d0/hive_8h.html#a11">HIVE_HAS_BEEN_REPLACED</a>;
02401     NameInfo = (POBJECT_NAME_INFORMATION)ObjectInfoBuffer;
02402     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02403     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02404     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02405     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02406     Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02407     <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02408     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>;
02409     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
02410 
02411         <span class="comment">//</span>
02412         <span class="comment">// Close the handles to the new hive</span>
02413         <span class="comment">//</span>
02414         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a105">REG_CMD_HIVE_CLOSE</a>;
02415         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = NewHive;
02416         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02417 
02418         <span class="comment">//</span>
02419         <span class="comment">// We are in trouble now.  We have renamed the existing hive file,</span>
02420         <span class="comment">// but we couldn't rename the new hive file!  Try to rename the</span>
02421         <span class="comment">// existing hive file back to where it was.</span>
02422         <span class="comment">//</span>
02423         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o0">Command</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a107">REG_CMD_RENAME_HIVE</a>;
02424         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o13">NewName</a> = &amp;NameInfo-&gt;Name;
02425         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o14">OldName</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02426         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o15">NameInfoLength</a> = 0;
02427         Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o7">CmHive</a> = CONTAINING_RECORD(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>);
02428         <a class="code" href="../../d5/d3/cmworker_8c.html#a20">CmpWorker</a>(&amp;Command);
02429         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>)) {
02430             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a18">CML_BUGCHECK</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a32">CMS_SAVRES</a>) {
02431                 KdPrint((<span class="stringliteral">"CmReplaceKey: renamed existing hive file, but couldn't\n"</span>));
02432                 KdPrint((<span class="stringliteral">"              rename new hive file (%08lx) "</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
02433                 KdPrint((<span class="stringliteral">" or replace old hive file (%08lx)!\n"</span>,Command.<a class="code" href="../../d4/d3/struct__REGISTRY__COMMAND.html#o5">Status</a>));
02434             }
02435 
02436             <span class="comment">//</span>
02437             <span class="comment">// WARNNOTE:</span>
02438             <span class="comment">//      To get into this state, the user must have relevent</span>
02439             <span class="comment">//      privileges, deliberately screw with system in an attempt</span>
02440             <span class="comment">//      to defeat it, AND get it done in a narrow timing window.</span>
02441             <span class="comment">//</span>
02442             <span class="comment">//      Further, if it's a user profile, the system will</span>
02443             <span class="comment">//      still come up.</span>
02444             <span class="comment">//</span>
02445             <span class="comment">//      Therefore, return an error code and go on.</span>
02446             <span class="comment">//</span>
02447 
02448             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REGISTRY_CORRUPT;
02449 
02450         }
02451     }
02452 
02453     <span class="comment">//</span>
02454     <span class="comment">// All of the renaming is done.  However, we are holding an in-memory</span>
02455     <span class="comment">// image of the new hive.  Release it, since it will not actually</span>
02456     <span class="comment">// be used until next boot.</span>
02457     <span class="comment">//</span>
02458     <span class="comment">// Do not close the open file handles to the new hive, we need to</span>
02459     <span class="comment">// keep it locked exclusively until the system is rebooted to prevent</span>
02460     <span class="comment">// people from mucking with it.</span>
02461     <span class="comment">//</span>
02462     RemoveEntryList(&amp;(NewHive-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o3">HiveList</a>));
02463 
02464     <a class="code" href="../../d2/d1/hivefree_8c.html#a0">HvFreeHive</a>((<a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>)NewHive);
02465 
02466     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewHive-&gt;HiveLock );
02467     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(NewHive-&gt;HiveLock);
02468     <a class="code" href="../../d7/d3/cmwrapr_8c.html#a12">CmpFree</a>(NewHive, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CMHIVE.html">CMHIVE</a>));
02469 
02470 <a class="code" href="../../d1/d0/tdisp_8c.html#a1">ErrorExit</a>:
02471     <span class="comment">//</span>
02472     <span class="comment">// Set global quota back to what it was.</span>
02473     <span class="comment">//</span>
02474     <a class="code" href="../../d8/d9/cmapi_8c.html#a7">CmpGlobalQuotaAllowed</a> = OldQuotaAllowed;
02475     <a class="code" href="../../d8/d9/cmapi_8c.html#a8">CmpGlobalQuotaWarning</a> = OldQuotaWarning;
02476 
02477     <a class="code" href="../../d1/d2/cmp_8h.html#a258">CmpUnlockRegistry</a>();
02478     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02479 }
02480 
02481 <span class="preprocessor">#ifdef _WRITE_PROTECTED_REGISTRY_POOL</span>
02482 <span class="preprocessor"></span>
02483 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02484 <a class="code" href="../../d1/d2/cmp_8h.html#a13">CmpMarkAllBinsReadOnly</a>(
02485     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      Hive
02486     )
02487 <span class="comment">/*++</span>
02488 <span class="comment"></span>
02489 <span class="comment">Routine Description:</span>
02490 <span class="comment"></span>
02491 <span class="comment">    Marks the memory allocated for all the stable bins in this hive as read only.</span>
02492 <span class="comment"></span>
02493 <span class="comment">Arguments:</span>
02494 <span class="comment"></span>
02495 <span class="comment">    Hive - supplies a pointer to the hive control structure for the</span>
02496 <span class="comment">            hive of interest</span>
02497 <span class="comment"></span>
02498 <span class="comment">Return Value:</span>
02499 <span class="comment"></span>
02500 <span class="comment">    NONE (It should work!)</span>
02501 <span class="comment"></span>
02502 <span class="comment">--*/</span>
02503 {
02504     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a> <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>;
02505     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>       <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
02506     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> p;
02507     ULONG       Length;
02508 
02509     <span class="comment">//</span>
02510     <span class="comment">// we are only interested in the stable storage</span>
02511     <span class="comment">//</span>
02512     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
02513 
02514     p = 0;
02515 
02516     <span class="comment">//</span>
02517     <span class="comment">// for each bin in the space</span>
02518     <span class="comment">//</span>
02519     <span class="keywordflow">while</span> (p &lt; Length) {
02520         <a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> = <a class="code" href="../../d8/d0/hivecell_8c.html#a14">HvpGetCellMap</a>(Hive, p);
02521         <a class="code" href="../../d1/d2/cmp_8h.html#a65">VALIDATE_CELL_MAP</a>(__LINE__,t,Hive,p);
02522 
02523         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)((<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress) &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
02524 
02525         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>-&gt;BinAddress &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a>) {
02526 
02527             <span class="comment">//</span>
02528             <span class="comment">// Mark it as read Only</span>
02529             <span class="comment">//</span>
02530             <a class="code" href="../../d1/d2/cmp_8h.html#a11">HvpChangeBinAllocation</a>(Bin,TRUE);
02531         }
02532 
02533         <span class="comment">// next one, please</span>
02534         p = (ULONG)p + <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o2">Size</a>;
02535 
02536     }
02537 
02538 }
02539 
02540 <span class="preprocessor">#endif</span>
02541 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
