<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dllinit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dllinit.c</h1><a href="../../d8/d9/dllinit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    dllinit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements console dll initialization</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 11-Nov-1990</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d4/d3/w32_2ntcon_2client_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#include &lt;cpl.h&gt;</span>
00027 
<a name="l00028"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a0">00028</a> <span class="preprocessor">#define DEFAULT_WINDOW_TITLE (L"Command Prompt")</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a3">00030</a> <span class="keyword">extern</span> HANDLE <a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a>;
<a name="l00031"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a4">00031</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a5">ExeNameBuffer</a>[];
<a name="l00032"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a5">00032</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>;
<a name="l00033"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a6">00033</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a7">StartDirBuffer</a>[];
<a name="l00034"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a7">00034</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d2/d1/client_2cmdline_8c.html#a8">StartDirLength</a>;
00035 
00036 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00037 <a class="code" href="../../d8/d9/dllinit_8c.html#a8">CtrlRoutine</a>(
00038     IN LPVOID lpThreadParameter
00039     );
00040 
00041 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00042 <a class="code" href="../../d8/d9/dllinit_8c.html#a9">PropRoutine</a>(
00043     IN LPVOID lpThreadParameter
00044     );
00045 
00046 <span class="preprocessor">#if defined(FE_SB)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00048 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
00049 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a>(
00050     IN LPVOID lpThreadParameter
00051     );
00052 <span class="preprocessor">#endif // FE_IME</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00054 <span class="preprocessor"></span>
00055 
<a name="l00056"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a1">00056</a> <span class="preprocessor">#define MAX_SESSION_PATH   256</span>
<a name="l00057"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a2">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define SESSION_ROOT       L"\\Sessions"</span>
00058 <span class="preprocessor"></span>
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 <a class="code" href="../../d8/d9/dllinit_8c.html#a10">InitExeName</a>( VOID );
00061 
00062 BOOLEAN
<a name="l00063"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a11">00063</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a11">ConsoleApp</a>( VOID )
00064 
00065 <span class="comment">/*++</span>
00066 <span class="comment"></span>
00067 <span class="comment">    This routine determines whether the current process is a console or</span>
00068 <span class="comment">    windows app.</span>
00069 <span class="comment"></span>
00070 <span class="comment">Parameters:</span>
00071 <span class="comment"></span>
00072 <span class="comment">    none.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Return Value:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    TRUE if console app.</span>
00077 <span class="comment"></span>
00078 <span class="comment">--*/</span>
00079 
00080 {
00081     PIMAGE_NT_HEADERS NtHeaders;
00082 
00083     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(GetModuleHandle(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00084     <span class="keywordflow">return</span> (NtHeaders-&gt;OptionalHeader.Subsystem == IMAGE_SUBSYSTEM_WINDOWS_CUI) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00085 }
00086 
00087 
00088 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00089"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a12">00089</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a12">SetUpAppName</a>(
00090     IN OUT LPDWORD CurDirLength,
00091     OUT LPWSTR CurDir,
00092     IN OUT LPDWORD AppNameLength,
00093     OUT LPWSTR AppName
00094     )
00095 {
00096     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> Length;
00097 
00098     *CurDirLength -= <span class="keyword">sizeof</span>(WCHAR);
00099     Length = (<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a8">StartDirLength</a>*<span class="keyword">sizeof</span>(WCHAR)) &gt; *CurDirLength ? *CurDirLength : (<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a8">StartDirLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00100     RtlCopyMemory(CurDir,<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a7">StartDirBuffer</a>,Length+<span class="keyword">sizeof</span>(WCHAR));
00101     *CurDirLength = Length + <span class="keyword">sizeof</span>(WCHAR);   <span class="comment">// add terminating NULL</span>
00102 
00103     *AppNameLength -= <span class="keyword">sizeof</span>(WCHAR);
00104     Length = (<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>*<span class="keyword">sizeof</span>(WCHAR)) &gt; *AppNameLength ? *AppNameLength : (<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a6">ExeNameLength</a>*<span class="keyword">sizeof</span>(WCHAR));
00105     RtlCopyMemory(AppName,<a class="code" href="../../d2/d1/client_2cmdline_8c.html#a5">ExeNameBuffer</a>,Length+<span class="keyword">sizeof</span>(WCHAR));
00106     *AppNameLength = Length + <span class="keyword">sizeof</span>(WCHAR);   <span class="comment">// add terminating NULL</span>
00107 }
00108 
00109 
00110 ULONG
<a name="l00111"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a13">00111</a> <a class="code" href="../../d6/d3/queue_8c.html#a43">ParseReserved</a>(
00112     WCHAR *pchReserved,
00113     WCHAR *pchFind
00114     )
00115 {
00116     ULONG dw;
00117     WCHAR *pch, *pchT, ch;
00118     UNICODE_STRING uString;
00119 
00120     dw = 0;
00121     <span class="keywordflow">if</span> ((pch = wcsstr(pchReserved, pchFind)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00122         pch += lstrlenW(pchFind);
00123 
00124         pchT = pch;
00125         <span class="keywordflow">while</span> (*pchT &gt;= <span class="charliteral">'0'</span> &amp;&amp; *pchT &lt;= <span class="charliteral">'9'</span>)
00126             pchT++;
00127 
00128         ch = *pchT;
00129         *pchT = 0;
00130         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;uString, pch);
00131         *pchT = ch;
00132 
00133         <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;uString, 0, &amp;dw);
00134     }
00135 
00136     <span class="keywordflow">return</span> dw;
00137 }
00138 
00139 
00140 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00141"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a14">00141</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a14">SetUpConsoleInfo</a>(
00142     IN BOOL DllInit,
00143     OUT LPDWORD TitleLength,
00144     OUT LPWSTR Title OPTIONAL,
00145     OUT LPDWORD DesktopLength,
00146     OUT LPWSTR *Desktop OPTIONAL,
00147     OUT <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo
00148     )
00149 
00150 <span class="comment">/*++</span>
00151 <span class="comment"></span>
00152 <span class="comment">    This routine fills in the ConsoleInfo structure with the values</span>
00153 <span class="comment">    specified by the user.</span>
00154 <span class="comment"></span>
00155 <span class="comment">Parameters:</span>
00156 <span class="comment"></span>
00157 <span class="comment">    ConsoleInfo - pointer to structure to fill in.</span>
00158 <span class="comment"></span>
00159 <span class="comment">Return Value:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    none.</span>
00162 <span class="comment"></span>
00163 <span class="comment">--*/</span>
00164 
00165 {
00166     STARTUPINFOW StartupInfo;
00167     HANDLE h;
00168     <span class="keywordtype">int</span> <span class="keywordtype">id</span>;
00169     HANDLE <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a>;
00170     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success;
00171 
00172 
00173     GetStartupInfoW(&amp;StartupInfo);
00174     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a4">ghInstance</a> = (HANDLE)((PVOID)NtCurrentPeb()-&gt;ImageBaseAddress );
00175 
00176     <span class="comment">// these will eventually be filled in using menu input</span>
00177 
00178     ConsoleInfo-&gt;nFont = 0;
00179     ConsoleInfo-&gt;nInputBufferSize = 0;
00180     ConsoleInfo-&gt;hIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00181     ConsoleInfo-&gt;hSmIcon = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00182     ConsoleInfo-&gt;iIconId = 0;
00183     ConsoleInfo-&gt;dwStartupFlags = StartupInfo.dwFlags;
00184 <span class="preprocessor">#if defined(FE_SB)</span>
00185 <span class="preprocessor"></span>    ConsoleInfo-&gt;uCodePage = GetOEMCP();
00186 <span class="preprocessor">#endif</span>
00187 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (StartupInfo.lpTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00188         StartupInfo.lpTitle = <a class="code" href="../../d8/d9/dllinit_8c.html#a0">DEFAULT_WINDOW_TITLE</a>;
00189     }
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">// if the desktop name was specified, set up the pointers.</span>
00193     <span class="comment">//</span>
00194 
00195     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/kdexts_8c.html#a14">DllInit</a> &amp;&amp; Desktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00196             StartupInfo.lpDesktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; *StartupInfo.lpDesktop != 0) {
00197         *DesktopLength = (lstrlenW(StartupInfo.lpDesktop) + 1) * <span class="keyword">sizeof</span>(WCHAR);
00198         *Desktop = StartupInfo.lpDesktop;
00199     } <span class="keywordflow">else</span> {
00200         *DesktopLength = 0;
00201         <span class="keywordflow">if</span> (Desktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00202             *Desktop = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00203     }
00204 
00205     <span class="comment">// Nope, do normal initialization (TitleLength is in BYTES, not CHARS!)</span>
00206     *TitleLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((lstrlenW(StartupInfo.lpTitle)+1)*<span class="keyword">sizeof</span>(WCHAR));
00207     *TitleLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(*TitleLength,<a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>));
00208     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/kdexts_8c.html#a14">DllInit</a>) {
00209         RtlCopyMemory(Title,StartupInfo.lpTitle,*TitleLength);
00210         <span class="comment">// ensure the title is NULL terminated</span>
00211         <span class="keywordflow">if</span> (*TitleLength == <a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>)
00212             Title[ (<a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>/<span class="keyword">sizeof</span>(WCHAR)) - 1 ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00213     }
00214 
00215     <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USESHOWWINDOW) {
00216         ConsoleInfo-&gt;wShowWindow = StartupInfo.wShowWindow;
00217     }
00218     <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USEFILLATTRIBUTE) {
00219         ConsoleInfo-&gt;wFillAttribute = (WORD)StartupInfo.dwFillAttribute;
00220     }
00221     <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USECOUNTCHARS) {
00222         ConsoleInfo-&gt;dwScreenBufferSize.X = (WORD)(StartupInfo.dwXCountChars);
00223         ConsoleInfo-&gt;dwScreenBufferSize.Y = (WORD)(StartupInfo.dwYCountChars);
00224     }
00225     <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USESIZE) {
00226         ConsoleInfo-&gt;dwWindowSize.X = (WORD)(StartupInfo.dwXSize);
00227         ConsoleInfo-&gt;dwWindowSize.Y = (WORD)(StartupInfo.dwYSize);
00228     }
00229     <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USEPOSITION) {
00230         ConsoleInfo-&gt;dwWindowOrigin.X = (WORD)(StartupInfo.dwX);
00231         ConsoleInfo-&gt;dwWindowOrigin.Y = (WORD)(StartupInfo.dwY);
00232     }
00233 
00234     <span class="comment">//</span>
00235     <span class="comment">// Grab information passed on lpReserved line...</span>
00236     <span class="comment">//</span>
00237 
00238     <span class="keywordflow">if</span> (StartupInfo.lpReserved != 0) {
00239 
00240         <span class="comment">//</span>
00241         <span class="comment">// the program manager has an icon for the exe.  store the</span>
00242         <span class="comment">// index in the iIconId field.</span>
00243         <span class="comment">//</span>
00244 
00245         ConsoleInfo-&gt;iIconId = <a class="code" href="../../d6/d3/queue_8c.html#a43">ParseReserved</a>(StartupInfo.lpReserved, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"dde."</span>);
00246 
00247         <span class="comment">//</span>
00248         <span class="comment">// The new "Chicago" way of doing things is to pass the hotkey in the</span>
00249         <span class="comment">// hStdInput field and set the STARTF_USEHOTKEY flag.  So, if this is</span>
00250         <span class="comment">// specified, we get the hotkey from there instead</span>
00251         <span class="comment">//</span>
00252 
00253         <span class="keywordflow">if</span> (StartupInfo.dwFlags &amp; STARTF_USEHOTKEY) {
00254             ConsoleInfo-&gt;dwHotKey = HandleToUlong(StartupInfo.hStdInput);
00255         } <span class="keywordflow">else</span> {
00256             ConsoleInfo-&gt;dwHotKey = <a class="code" href="../../d6/d3/queue_8c.html#a43">ParseReserved</a>(StartupInfo.lpReserved, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"hotkey."</span>);
00257         }
00258     }
00259 
00260 }
00261 
00262 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00263"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a15">00263</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a15">SetUpHandles</a>(
00264     IN <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> ConsoleInfo
00265     )
00266 
00267 <span class="comment">/*++</span>
00268 <span class="comment"></span>
00269 <span class="comment">    This routine sets up the console and std* handles for the process.</span>
00270 <span class="comment"></span>
00271 <span class="comment">Parameters:</span>
00272 <span class="comment"></span>
00273 <span class="comment">    ConsoleInfo - pointer to structure containing handles.</span>
00274 <span class="comment"></span>
00275 <span class="comment">Return Value:</span>
00276 <span class="comment"></span>
00277 <span class="comment">    none.</span>
00278 <span class="comment"></span>
00279 <span class="comment">--*/</span>
00280 
00281 {
00282     <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(ConsoleInfo-&gt;ConsoleHandle);
00283     <span class="keywordflow">if</span> (!(ConsoleInfo-&gt;dwStartupFlags &amp; STARTF_USESTDHANDLES)) {
00284         SetStdHandle(<a class="code" href="../../d5/d5/rdwr_8c.html#a9">STD_INPUT_HANDLE</a>,ConsoleInfo-&gt;StdIn);
00285         SetStdHandle(<a class="code" href="../../d5/d5/rdwr_8c.html#a10">STD_OUTPUT_HANDLE</a>,ConsoleInfo-&gt;StdOut);
00286         SetStdHandle(<a class="code" href="../../d5/d5/rdwr_8c.html#a11">STD_ERROR_HANDLE</a>,ConsoleInfo-&gt;StdErr);
00287     }
00288 }
00289 
00290 <span class="preprocessor">#endif </span>
00291 <span class="preprocessor"></span>
00292 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00293 <span class="preprocessor"></span>
00294 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00295 WINAPI
<a name="l00296"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a16">00296</a> <a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(
00297     OUT LANGID *lpLangId
00298     )
00299 
00300 <span class="comment">/*++</span>
00301 <span class="comment"></span>
00302 <span class="comment">Parameters:</span>
00303 <span class="comment"></span>
00304 <span class="comment">    lpLangId - Supplies a pointer to a LANGID in which to store the Language ID.</span>
00305 <span class="comment"></span>
00306 <span class="comment">Return Value:</span>
00307 <span class="comment"></span>
00308 <span class="comment">    TRUE - The operation was successful.</span>
00309 <span class="comment"></span>
00310 <span class="comment">    FALSE/NULL - The operation failed. Extended error status is available</span>
00311 <span class="comment">        using GetLastError.</span>
00312 <span class="comment"></span>
00313 <span class="comment"></span>
00314 <span class="comment">--*/</span>
00315 
00316 {
00317     <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00318     <a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html">PCONSOLE_LANGID_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.GetConsoleLangId;
00319 
00320     a-&gt;<a class="code" href="../../d4/d3/struct__CONSOLE__LANGID__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00321     <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00322                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00323                          CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00324                                               <a class="code" href="../../d5/d5/conmsg_8h.html#a236a234">ConsolepGetLangId</a>
00325                                             ),
00326                          <span class="keyword">sizeof</span>( *a )
00327                        );
00328     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00329         <span class="keywordflow">try</span> {
00330             *lpLangId = a-&gt;LangId;
00331         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00332             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333         }
00334         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00335     } <span class="keywordflow">else</span> {
00336         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00337     }
00338 
00339 }
00340 
00341 <span class="preprocessor">#endif </span>
00342 <span class="preprocessor"></span>
00343 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00344 <span class="preprocessor"></span>
00345 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00346"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a17">00346</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a17">SetTEBLangID</a>(
00347     VOID
00348     )
00349 
00350 <span class="comment">/*++</span>
00351 <span class="comment"></span>
00352 <span class="comment">    Sets the Language Id in the TEB to Far East if code page CP are</span>
00353 <span class="comment">    Japanese/Korean/Chinese.  This is done in order for FormatMessage</span>
00354 <span class="comment">    to display any Far East character when cmd is running in its code page.</span>
00355 <span class="comment">    All messages displayed in non-FE code page will be displayed in English.</span>
00356 <span class="comment"></span>
00357 <span class="comment">--*/</span>
00358 
00359 {
00360     LANGID LangId;
00361 
00362     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/srvinit_8c.html#a45">GetConsoleLangId</a>(&amp;LangId)) {
00363         SetThreadLocale( MAKELCID(LangId, SORT_DEFAULT) );
00364     }
00365 }
00366 
00367 <span class="preprocessor">#endif </span>
00368 <span class="preprocessor"></span>
00369 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00370 <span class="preprocessor"></span>
00371 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00372 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00373"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a18">00373</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a18">ConnectConsoleInternal</a>(IN PWSTR pObjectDirectory,
00374                        IN OUT <a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">PCONSOLE_API_CONNECTINFO</a> pConnectInfo,
00375                        OUT PBOOLEAN pServerProcess
00376                       )
00377 <span class="comment">/*++</span>
00378 <span class="comment"></span>
00379 <span class="comment">Routine Description:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    Helper function for establishing a connection with the console server.</span>
00382 <span class="comment">    Waits for the server to signal completion.</span>
00383 <span class="comment"></span>
00384 <span class="comment">Arguments:</span>
00385 <span class="comment"></span>
00386 <span class="comment">    pObjectDirectory -  Supplies a null terminated string that is the same</span>
00387 <span class="comment">        as the value of the ObjectDirectory= argument passed to the CSRSS</span>
00388 <span class="comment">        program.</span>
00389 <span class="comment"></span>
00390 <span class="comment">    pConnectInfo - Supplies and recieves the connection information.</span>
00391 <span class="comment"></span>
00392 <span class="comment">    pServerProcess - Recieves TRUE if this is a server process.</span>
00393 <span class="comment"></span>
00394 <span class="comment">Return Value:</span>
00395 <span class="comment"></span>
00396 <span class="comment">    TRUE - Success</span>
00397 <span class="comment"></span>
00398 <span class="comment">    FALSE - An error occured.</span>
00399 <span class="comment"></span>
00400 <span class="comment">--*/</span>
00401 {
00402 
00403    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00404    ULONG ConnectionInformationLength;
00405 
00406    ConnectionInformationLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">CONSOLE_API_CONNECTINFO</a>);
00407 
00408    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d9/wow64csr_8c.html#a0">CsrClientConnectToServer</a>( pObjectDirectory,
00409                                       CONSRV_SERVERDLL_INDEX,
00410                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00411                                       pConnectInfo,
00412                                       &amp;ConnectionInformationLength,
00413                                       pServerProcess
00414                                     );
00415 
00416    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00417        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00418    }
00419 
00420    <span class="comment">//</span>
00421    <span class="comment">// we return success although no console api can be called because</span>
00422    <span class="comment">// loading shouldn't fail.  we'll fail the api calls later.</span>
00423    <span class="comment">//</span>
00424 
00425    <span class="keywordflow">if</span> (*pServerProcess) {
00426        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00427    }
00428 
00429 
00430    <span class="comment">//</span>
00431    <span class="comment">// if this is not a console app, return success - nothing else to do.</span>
00432    <span class="comment">//</span>
00433 
00434    <span class="keywordflow">if</span> (!pConnectInfo-&gt;ConsoleApp) {
00435        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00436    }
00437 
00438    <span class="comment">//</span>
00439    <span class="comment">// wait for initialization to complete.  we have to use the NT</span>
00440    <span class="comment">// wait because the heap hasn't been initialized yet.</span>
00441    <span class="comment">//</span>
00442 
00443    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a>(<a class="code" href="../../d5/d5/conmsg_8h.html#a6">NUMBER_OF_INITIALIZATION_EVENTS</a>,
00444                                         pConnectInfo-&gt;ConsoleInfo.InitEvents,
00445                                         WaitAny,
00446                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00447                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00448                                         );
00449 
00450    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00451        <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00452        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00453    }
00454 
00455    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(pConnectInfo-&gt;ConsoleInfo.InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]);
00456    <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(pConnectInfo-&gt;ConsoleInfo.InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]);
00457    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != <a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>) {
00458        <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00459        <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00460    }
00461 
00462    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00463 }
00464 
00465 <span class="preprocessor">#endif </span>
00466 <span class="preprocessor"></span>
00467 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00468 <span class="preprocessor"></span>
00469 BOOLEAN
<a name="l00470"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a19">00470</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a19">ConDllInitialize</a>(
00471     IN PVOID DllHandle,
00472     IN ULONG Reason,
00473     IN PCONTEXT Context OPTIONAL
00474     )
00475 
00476 <span class="comment">/*++</span>
00477 <span class="comment"></span>
00478 <span class="comment">Routine Description:</span>
00479 <span class="comment"></span>
00480 <span class="comment">    This function implements console dll initialization.</span>
00481 <span class="comment"></span>
00482 <span class="comment">Arguments:</span>
00483 <span class="comment"></span>
00484 <span class="comment">    DllHandle - Not Used</span>
00485 <span class="comment"></span>
00486 <span class="comment">    Context - Not Used</span>
00487 <span class="comment"></span>
00488 <span class="comment">Return Value:</span>
00489 <span class="comment"></span>
00490 <span class="comment">    STATUS_SUCCESS</span>
00491 <span class="comment"></span>
00492 <span class="comment">--*/</span>
00493 
00494 {
00495     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00496     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bStatus;
00497     <a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html">CONSOLE_API_CONNECTINFO</a> ConnectionInformation;
00498     BOOLEAN ServerProcess;
00499 
00500     ULONG SessionId = NtCurrentPeb()-&gt;SessionId;
00501     WCHAR szSessionDir[<a class="code" href="../../d8/d9/dllinit_8c.html#a1">MAX_SESSION_PATH</a>];
00502 
00503     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00504 
00505     <span class="comment">//</span>
00506     <span class="comment">// if we're attaching the DLL, we need to connect to the server.</span>
00507     <span class="comment">// if no console exists, we also need to create it and set up stdin,</span>
00508     <span class="comment">// stdout, and stderr.</span>
00509     <span class="comment">//</span>
00510 
00511     <span class="keywordflow">if</span> ( Reason == DLL_PROCESS_ATTACH ) {
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// Remember in the connect information if this app is a console</span>
00515         <span class="comment">// app. need to actually connect to the console server for windowed</span>
00516         <span class="comment">// apps so that we know NOT to do any special work during</span>
00517         <span class="comment">// ConsoleClientDisconnectRoutine(). Store ConsoleApp info in the</span>
00518         <span class="comment">// CSR managed per-process data.</span>
00519         <span class="comment">//</span>
00520 
00521         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d8/dll_2resource_8c.html#a24">RtlInitializeCriticalSection</a>(&amp;<a class="code" href="../../d6/d4/condll_8h.html#a11">DllLock</a>);
00522         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00523             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00524         }
00525 
00526         ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o3">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
00527         ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o4">PropRoutine</a> = <a class="code" href="../../d8/d9/dllinit_8c.html#a9">PropRoutine</a>;
00528 <span class="preprocessor">#if defined(FE_SB)</span>
00529 <span class="preprocessor"></span><span class="preprocessor">#if defined(FE_IME)</span>
00530 <span class="preprocessor"></span>        ConnectionInformation.ConsoleIMERoutine = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a11">ConsoleIMERoutine</a>;
00531 <span class="preprocessor">#endif // FE_IME</span>
00532 <span class="preprocessor"></span><span class="preprocessor">#endif // FE_SB</span>
00533 <span class="preprocessor"></span>
00534         ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o2">WindowVisible</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00535         ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a> = <a class="code" href="../../d8/d9/dllinit_8c.html#a11">ConsoleApp</a>();
00536         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == (HANDLE)CONSOLE_DETACHED_PROCESS) {
00537             <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00538             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00539         }
00540         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == (HANDLE)CONSOLE_NEW_CONSOLE) {
00541             <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00542         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == (HANDLE)CONSOLE_CREATE_NO_WINDOW) {
00543             <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00544             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o2">WindowVisible</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00545         }
00546         <span class="keywordflow">if</span> (!ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>) {
00547             <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00548         }
00549         ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">// if no console exists, pass parameters for console creation</span>
00553         <span class="comment">//</span>
00554 
00555         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>) {
00556             <a class="code" href="../../d8/d9/dllinit_8c.html#a14">SetUpConsoleInfo</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00557                              &amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a>,
00558                              ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o6">Title</a>,
00559                              &amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a>,
00560                              &amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o8">Desktop</a>,
00561                              &amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>);
00562         } <span class="keywordflow">else</span> {
00563             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o5">TitleLength</a> = 0;
00564             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o7">DesktopLength</a> = 0;
00565         }
00566 
00567         <span class="keywordflow">if</span> (ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>) {
00568             <a class="code" href="../../d8/d9/dllinit_8c.html#a10">InitExeName</a>();
00569             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o11">CurDirLength</a> = <span class="keyword">sizeof</span>(ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>);
00570             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a> = <span class="keyword">sizeof</span>(ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>);
00571             <a class="code" href="../../d8/d9/dllinit_8c.html#a12">SetUpAppName</a>(&amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o11">CurDirLength</a>,
00572                          ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o12">CurDir</a>,
00573                          &amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a>,
00574                          ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o10">AppName</a>);
00575         } <span class="keywordflow">else</span> {
00576             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o9">AppNameLength</a> = 0;
00577             ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o11">CurDirLength</a> = 0;
00578         }
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">// initialize ctrl handling. This should work for all apps, so</span>
00582         <span class="comment">// initialize it before we check for ConsoleApp (which means the</span>
00583         <span class="comment">// console bit was set in the module header).</span>
00584         <span class="comment">//</span>
00585 
00586         <a class="code" href="../../d9/d0/ctrlc_8c.html#a11">InitializeCtrlHandling</a>();
00587 
00588         <span class="comment">//</span>
00589         <span class="comment">// Connect to the server process</span>
00590         <span class="comment">//</span>
00591 
00592         <span class="keywordflow">if</span> ( SessionId == 0 ) {
00593            <span class="comment">//</span>
00594            <span class="comment">// Console Session</span>
00595            <span class="comment">//</span>
00596            wcscpy(szSessionDir, WINSS_OBJECT_DIRECTORY_NAME);
00597         } <span class="keywordflow">else</span> {
00598            swprintf(szSessionDir,<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%ld%ws"</span>,<a class="code" href="../../d8/d9/dllinit_8c.html#a2">SESSION_ROOT</a>,SessionId,WINSS_OBJECT_DIRECTORY_NAME);
00599         }
00600 
00601         bStatus = <a class="code" href="../../d8/d9/dllinit_8c.html#a18">ConnectConsoleInternal</a>(szSessionDir,
00602                                          &amp;ConnectionInformation,
00603                                          &amp;ServerProcess
00604                                          );
00605 
00606         <span class="keywordflow">if</span> (!bStatus) {
00607            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00608         }
00609 
00610         <span class="comment">//</span>
00611         <span class="comment">// we return success although no console api can be called because</span>
00612         <span class="comment">// loading shouldn't fail.  we'll fail the api calls later.</span>
00613         <span class="comment">//</span>
00614         <span class="keywordflow">if</span> (ServerProcess) {
00615            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00616         }
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">// if this is not a console app, return success - nothing else to do.</span>
00620         <span class="comment">//</span>
00621 
00622         <span class="keywordflow">if</span> (!ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o1">ConsoleApp</a>) {
00623            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00624         }
00625 
00626         <span class="comment">//</span>
00627         <span class="comment">// if console was just created, fill in peb values</span>
00628         <span class="comment">//</span>
00629 
00630         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00631             <a class="code" href="../../d8/d9/dllinit_8c.html#a15">SetUpHandles</a>(&amp;ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>
00632                         );
00633         }
00634 
00635         <a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a> = ConnectionInformation.<a class="code" href="../../d4/d9/struct__CONSOLE__API__CONNECTINFO.html#o0">ConsoleInfo</a>.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o1">InputWaitHandle</a>;
00636 
00637         <a class="code" href="../../d8/d9/dllinit_8c.html#a17">SetTEBLangID</a>();
00638 
00639     }
00640     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Reason == DLL_THREAD_ATTACH ) {
00641         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/dllinit_8c.html#a11">ConsoleApp</a>()) {
00642             <a class="code" href="../../d8/d9/dllinit_8c.html#a17">SetTEBLangID</a>();
00643         }
00644     }
00645     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00646     UNREFERENCED_PARAMETER(DllHandle);
00647     UNREFERENCED_PARAMETER(Context);
00648 }
00649 
00650 <span class="preprocessor">#endif </span>
00651 <span class="preprocessor"></span>
00652 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00653 <span class="preprocessor"></span>
00654 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00655 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00656"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a20">00656</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a20">AllocConsoleInternal</a>(IN LPWSTR lpTitle,
00657                      IN DWORD dwTitleLength,
00658                      IN LPWSTR lpDesktop,
00659                      IN DWORD dwDesktopLength,
00660                      IN LPWSTR lpCurDir,
00661                      IN DWORD dwCurDirLength,
00662                      IN LPWSTR lpAppName,
00663                      IN DWORD dwAppNameLength,
00664                      IN LPTHREAD_START_ROUTINE CtrlRoutine,
00665                      IN LPTHREAD_START_ROUTINE PropRoutine,
00666                      IN OUT <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">PCONSOLE_INFO</a> pConsoleInfo
00667                      )
00668 <span class="comment">/*++</span>
00669 <span class="comment"></span>
00670 <span class="comment">Routine Description:</span>
00671 <span class="comment"></span>
00672 <span class="comment">   Marshels the parameters for the ConsolepAlloc command.</span>
00673 <span class="comment"></span>
00674 <span class="comment">Arguments:</span>
00675 <span class="comment"></span>
00676 <span class="comment">   See the CONSOLE_ALLOC_MSG structure and AllocConsole.</span>
00677 <span class="comment"></span>
00678 <span class="comment">Return Value:</span>
00679 <span class="comment"></span>
00680 <span class="comment">    TRUE - Success</span>
00681 <span class="comment"></span>
00682 <span class="comment">    FALSE - An error occured.</span>
00683 <span class="comment"></span>
00684 <span class="comment">--*/</span>
00685 {
00686    <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00687    <a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html">PCONSOLE_ALLOC_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.AllocConsole;
00688    PCSR_CAPTURE_HEADER CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00689    <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00690    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> St;
00691 
00692    <span class="keywordflow">try</span> {
00693 
00694         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o9">CtrlRoutine</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>;
00695         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o10">PropRoutine</a> = <a class="code" href="../../d8/d9/dllinit_8c.html#a9">PropRoutine</a>;
00696 
00697         <span class="comment">// Allocate 4 extra pointer sizes to compensate for any alignment done</span>
00698         <span class="comment">// by CsrCaptureMessageBuffer.</span>
00699 
00700         CaptureBuffer = <a class="code" href="../../d8/d9/wow64csr_8c.html#a5">CsrAllocateCaptureBuffer</a>( 5,
00701                                                   dwTitleLength + dwDesktopLength + dwCurDirLength +
00702                                                   dwAppNameLength + <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">CONSOLE_INFO</a> ) + (4 * <span class="keyword">sizeof</span>(PVOID))
00703                                                  );
00704         <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00705             <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_NOT_ENOUGH_MEMORY);
00706             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00707             leave;
00708         }
00709 
00710         <span class="comment">// Allocate the CONSOLE_INFO first so that it is aligned on a pointer</span>
00711         <span class="comment">// boundry.  This is necessary since NtWaitForMultipleObject expects</span>
00712         <span class="comment">// its arguments aligned on a handle boundry.</span>
00713 
00714         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00715                                  pConsoleInfo,
00716                                  <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/conmsg_8h.html#a13">CONSOLE_INFO</a> ),
00717                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o0">ConsoleInfo</a>
00718                                );
00719 
00720         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o1">TitleLength</a> = dwTitleLength;
00721         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00722                                  lpTitle,
00723                                  dwTitleLength,
00724                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o2">Title</a>
00725                                );
00726 
00727         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o3">DesktopLength</a> = dwDesktopLength;
00728         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00729                                  lpDesktop,
00730                                  dwDesktopLength,
00731                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o4">Desktop</a>
00732                                );
00733 
00734         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o7">CurDirLength</a> = dwCurDirLength;
00735         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00736                                  lpCurDir,
00737                                  dwCurDirLength,
00738                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o8">CurDir</a>
00739                                );
00740 
00741         a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o5">AppNameLength</a> = dwAppNameLength;
00742         <a class="code" href="../../d8/d9/wow64csr_8c.html#a8">CsrCaptureMessageBuffer</a>( CaptureBuffer,
00743                                  lpAppName,
00744                                  dwAppNameLength,
00745                                  (PVOID *) &amp;a-&gt;<a class="code" href="../../d3/d9/struct__CONSOLE__ALLOC__MSG.html#o6">AppName</a>
00746                                );
00747 
00748         <span class="comment">//</span>
00749         <span class="comment">// Connect to the server process</span>
00750         <span class="comment">//</span>
00751 
00752         <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00753                              CaptureBuffer,
00754                              CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00755                                                   <a class="code" href="../../d5/d5/conmsg_8h.html#a236a199">ConsolepAlloc</a>
00756                                                 ),
00757                              <span class="keyword">sizeof</span>( *a )
00758                            );
00759         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00760             <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00761             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00762             leave;
00763         }
00764 
00765         St = <a class="code" href="../../d1/d2/obwait_8c.html#a5">NtWaitForMultipleObjects</a>(<a class="code" href="../../d5/d5/conmsg_8h.html#a6">NUMBER_OF_INITIALIZATION_EVENTS</a>,
00766                                       a-&gt;ConsoleInfo-&gt;InitEvents,
00767                                       WaitAny,
00768                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00769                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00770                                       );
00771         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(St)) {
00772            <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a>(St);
00773            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00774            leave;
00775         }
00776 
00777         <span class="comment">//The handles to be closed are events, so NtClose works fine.</span>
00778         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(a-&gt;ConsoleInfo-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>]);
00779         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(a-&gt;ConsoleInfo-&gt;InitEvents[<a class="code" href="../../d5/d5/conmsg_8h.html#a5">INITIALIZATION_FAILED</a>]);
00780         <span class="keywordflow">if</span> (St != <a class="code" href="../../d5/d5/conmsg_8h.html#a4">INITIALIZATION_SUCCEEDED</a>) {
00781             <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00782             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00783             leave;
00784         }
00785         RtlCopyMemory(pConsoleInfo, a-&gt;ConsoleInfo, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/conmsg_8h.html#a13">CONSOLE_INFO</a>));
00786         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00787    }
00788    finally {
00789       <span class="keywordflow">if</span> (CaptureBuffer) {
00790          <a class="code" href="../../d8/d9/wow64csr_8c.html#a6">CsrFreeCaptureBuffer</a>( CaptureBuffer );
00791       }
00792    }
00793 
00794    <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00795 }
00796 
00797 <span class="preprocessor">#endif </span>
00798 <span class="preprocessor"></span>
00799 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00800 <span class="preprocessor"></span>
00801 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00802 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00803"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a21">00803</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a21">AllocConsole</a>( VOID )
00804 
00805 <span class="comment">/*++</span>
00806 <span class="comment"></span>
00807 <span class="comment">Routine Description:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    This API creates a console for the calling process.</span>
00810 <span class="comment"></span>
00811 <span class="comment">Arguments:</span>
00812 <span class="comment"></span>
00813 <span class="comment">    none.</span>
00814 <span class="comment"></span>
00815 <span class="comment">Return Value:</span>
00816 <span class="comment"></span>
00817 <span class="comment">    TRUE - function was successful.</span>
00818 <span class="comment"></span>
00819 <span class="comment">--*/</span>
00820 
00821 {
00822     <a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html">CONSOLE_INFO</a> ConsoleInfo;
00823     STARTUPINFOW StartupInfo;
00824     WCHAR CurDir[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1];
00825     WCHAR AppName[<a class="code" href="../../d5/d5/conmsg_8h.html#a3">MAX_APP_NAME_LENGTH</a>/2];
00826     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00827 
00828     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTitleLength;
00829     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwDesktopLength;
00830     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCurDirLength;
00831     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwAppNameLength;
00832 
00833     <a class="code" href="../../d6/d4/condll_8h.html#a9">LockDll</a>();
00834     <span class="keywordflow">try</span> {
00835         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00836             SetLastError(ERROR_ACCESS_DENIED);
00837             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00838             leave;
00839         }
00840 
00841         <span class="comment">//</span>
00842         <span class="comment">// set up initialization parameters</span>
00843         <span class="comment">//</span>
00844 
00845         <a class="code" href="../../d8/d9/dllinit_8c.html#a14">SetUpConsoleInfo</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00846                          &amp;dwTitleLength,
00847                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00848                          &amp;dwDesktopLength,
00849                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00850                          &amp;ConsoleInfo);
00851 
00852         <a class="code" href="../../d8/d9/dllinit_8c.html#a10">InitExeName</a>();
00853         dwCurDirLength = <span class="keyword">sizeof</span>(CurDir);
00854         dwAppNameLength = <span class="keyword">sizeof</span>(AppName);
00855         <a class="code" href="../../d8/d9/dllinit_8c.html#a12">SetUpAppName</a>(&amp;dwCurDirLength,
00856                      CurDir,
00857                      &amp;dwAppNameLength,
00858                      AppName);
00859 
00860         GetStartupInfoW(&amp;StartupInfo);
00861 
00862         <span class="keywordflow">if</span> (StartupInfo.lpTitle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00863             StartupInfo.lpTitle = <a class="code" href="../../d8/d9/dllinit_8c.html#a0">DEFAULT_WINDOW_TITLE</a>;
00864         }
00865         dwTitleLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((lstrlenW(StartupInfo.lpTitle)+1)*<span class="keyword">sizeof</span>(WCHAR));
00866         dwTitleLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwTitleLength,<a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>));
00867         <span class="keywordflow">if</span> (StartupInfo.lpDesktop != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; *StartupInfo.lpDesktop != 0) {
00868             dwDesktopLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((lstrlenW(StartupInfo.lpDesktop)+1)*<span class="keyword">sizeof</span>(WCHAR));
00869             dwDesktopLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(dwDesktopLength,<a class="code" href="../../d5/d5/conmsg_8h.html#a2">MAX_TITLE_LENGTH</a>));
00870         } <span class="keywordflow">else</span> {
00871             dwDesktopLength = 0;
00872         }
00873 
00874         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d9/dllinit_8c.html#a20">AllocConsoleInternal</a>(StartupInfo.lpTitle,
00875                                       dwTitleLength,
00876                                       StartupInfo.lpDesktop,
00877                                       dwDesktopLength,
00878                                       CurDir,
00879                                       dwCurDirLength,
00880                                       AppName,
00881                                       dwAppNameLength,
00882                                       <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a10">CtrlRoutine</a>,
00883                                       <a class="code" href="../../d8/d9/dllinit_8c.html#a9">PropRoutine</a>,
00884                                       &amp;ConsoleInfo
00885                                       );
00886 
00887         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
00888            leave;
00889         }
00890 
00891         <span class="comment">//</span>
00892         <span class="comment">// fill in peb values</span>
00893         <span class="comment">//</span>
00894 
00895         <a class="code" href="../../d8/d9/dllinit_8c.html#a15">SetUpHandles</a>(&amp;ConsoleInfo);
00896 
00897         <span class="comment">//</span>
00898         <span class="comment">// create ctrl-c thread</span>
00899         <span class="comment">//</span>
00900 
00901         <a class="code" href="../../d9/d0/ctrlc_8c.html#a11">InitializeCtrlHandling</a>();
00902 
00903         <a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a> = ConsoleInfo.<a class="code" href="../../d0/d3/struct__CONSOLE__INFO.html#o1">InputWaitHandle</a>;
00904 
00905         <a class="code" href="../../d8/d9/dllinit_8c.html#a17">SetTEBLangID</a>();
00906 
00907         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00908 
00909     } finally {
00910         <a class="code" href="../../d6/d4/condll_8h.html#a10">UnlockDll</a>();
00911     }
00912 
00913     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00914 }
00915 
00916 <span class="preprocessor">#endif </span>
00917 <span class="preprocessor"></span>
00918 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW6432)</span>
00919 <span class="preprocessor"></span>
00920 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00921 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00922"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a22">00922</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a22">FreeConsoleInternal</a>(
00923      VOID
00924      )
00925 <span class="comment">/*++</span>
00926 <span class="comment"></span>
00927 <span class="comment">Routine Description:</span>
00928 <span class="comment"></span>
00929 <span class="comment">   Marshels the parameters for the ConsolepFree command.</span>
00930 <span class="comment"></span>
00931 <span class="comment">Arguments:</span>
00932 <span class="comment"></span>
00933 <span class="comment">   See the CONSOLE_FREE_MSG structure and FreeConsole.</span>
00934 <span class="comment"></span>
00935 <span class="comment">Return Value:</span>
00936 <span class="comment"></span>
00937 <span class="comment">    TRUE - Success</span>
00938 <span class="comment"></span>
00939 <span class="comment">    FALSE - An error occured.</span>
00940 <span class="comment"></span>
00941 <span class="comment">--*/</span>
00942 {
00943 
00944    <a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html">CONSOLE_API_MSG</a> m;
00945    <a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html">PCONSOLE_FREE_MSG</a> a = &amp;m.<a class="code" href="../../d5/d9/struct__CONSOLE__API__MSG.html#o77">u</a>.FreeConsole;
00946 
00947    a-&gt;<a class="code" href="../../d4/d0/struct__CONSOLE__FREE__MSG.html#o0">ConsoleHandle</a> = <a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a>;
00948 
00949    <span class="comment">//</span>
00950    <span class="comment">// Connect to the server process</span>
00951    <span class="comment">//</span>
00952 
00953    <a class="code" href="../../d8/d9/wow64csr_8c.html#a4">CsrClientCallServer</a>( (PCSR_API_MSG)&amp;m,
00954                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00955                         CSR_MAKE_API_NUMBER( CONSRV_SERVERDLL_INDEX,
00956                                              <a class="code" href="../../d5/d5/conmsg_8h.html#a236a200">ConsolepFree</a>
00957                                            ),
00958                         <span class="keyword">sizeof</span>( *a )
00959                       );
00960 
00961    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( m.ReturnValue )) {
00962       <a class="code" href="../../d6/d4/condll_8h.html#a3">SET_LAST_NT_ERROR</a> (m.ReturnValue);
00963       <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00964 
00965    } <span class="keywordflow">else</span> {
00966 
00967       <a class="code" href="../../d6/d4/condll_8h.html#a0">SET_CONSOLE_HANDLE</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00968       <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00969    }
00970 
00971 }
00972 
00973 <span class="preprocessor">#endif </span>
00974 <span class="preprocessor"></span>
00975 <span class="preprocessor"></span><span class="preprocessor">#if !defined(BUILD_WOW64)</span>
00976 <span class="preprocessor"></span>
00977 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00978 <a class="code" href="../../d1/d1/bench_8c.html#a0">APIENTRY</a>
<a name="l00979"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a23">00979</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a23">FreeConsole</a>( VOID )
00980 
00981 <span class="comment">/*++</span>
00982 <span class="comment"></span>
00983 <span class="comment">Routine Description:</span>
00984 <span class="comment"></span>
00985 <span class="comment">    This API frees the calling process's console.</span>
00986 <span class="comment"></span>
00987 <span class="comment">Arguments:</span>
00988 <span class="comment"></span>
00989 <span class="comment">    none.</span>
00990 <span class="comment"></span>
00991 <span class="comment">Return Value:</span>
00992 <span class="comment"></span>
00993 <span class="comment">    TRUE - function was successful.</span>
00994 <span class="comment"></span>
00995 <span class="comment">--*/</span>
00996 
00997 {
00998     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> Success=<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00999 
01000     <a class="code" href="../../d6/d4/condll_8h.html#a9">LockDll</a>();
01001     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d4/condll_8h.html#a1">GET_CONSOLE_HANDLE</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01002         <a class="code" href="../../d6/d4/condll_8h.html#a2">SET_LAST_ERROR</a>(ERROR_INVALID_PARAMETER);
01003         Success = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01004     } <span class="keywordflow">else</span> {
01005 
01006         Success = <a class="code" href="../../d8/d9/dllinit_8c.html#a22">FreeConsoleInternal</a>();
01007 
01008         <span class="keywordflow">if</span> (Success) {
01009            CloseHandle(<a class="code" href="../../d8/d9/dllinit_8c.html#a3">InputWaitHandle</a>);
01010         }
01011 
01012     }
01013     <a class="code" href="../../d6/d4/condll_8h.html#a10">UnlockDll</a>();
01014     <span class="keywordflow">return</span> Success;
01015 }
01016 
01017 
01018 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>
<a name="l01019"></a><a class="code" href="../../d8/d9/dllinit_8c.html#a9">01019</a> <a class="code" href="../../d8/d9/dllinit_8c.html#a9">PropRoutine</a>(
01020     IN LPVOID lpThreadParameter
01021     )
01022 
01023 <span class="comment">/*++</span>
01024 <span class="comment"></span>
01025 <span class="comment">Routine Description:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    This thread is created when the user tries to change console</span>
01028 <span class="comment">    properties from the system menu. It invokes the control panel</span>
01029 <span class="comment">    applet.</span>
01030 <span class="comment"></span>
01031 <span class="comment">Arguments:</span>
01032 <span class="comment"></span>
01033 <span class="comment">    lpThreadParameter - not used.</span>
01034 <span class="comment"></span>
01035 <span class="comment">Return Value:</span>
01036 <span class="comment"></span>
01037 <span class="comment">    STATUS_SUCCESS - function was successful</span>
01038 <span class="comment"></span>
01039 <span class="comment">--*/</span>
01040 
01041 {
01042     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01043     HANDLE hLibrary;
01044     APPLET_PROC pfnCplApplet;
01045     <span class="keyword">static</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInPropRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01046 
01047     <span class="comment">//</span>
01048     <span class="comment">// Prevent the user from launching multiple applets attached</span>
01049     <span class="comment">// to a single console</span>
01050     <span class="comment">//</span>
01051 
01052     <span class="keywordflow">if</span> (fInPropRoutine) {
01053         <span class="keywordflow">if</span> (lpThreadParameter) {
01054             CloseHandle((HANDLE)lpThreadParameter);
01055         }
01056         <span class="keywordflow">return</span> (ULONG)STATUS_UNSUCCESSFUL;
01057     }
01058 
01059     fInPropRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01060     hLibrary = LoadLibraryW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CONSOLE.DLL"</span>);
01061     <span class="keywordflow">if</span> (hLibrary != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062         pfnCplApplet = (APPLET_PROC)GetProcAddress(hLibrary, <span class="stringliteral">"CPlApplet"</span>);
01063         <span class="keywordflow">if</span> (pfnCplApplet != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01064             (*pfnCplApplet)((HWND)lpThreadParameter, CPL_INIT, 0, 0);
01065             (*pfnCplApplet)((HWND)lpThreadParameter, CPL_DBLCLK, 0, 0);
01066             (*pfnCplApplet)((HWND)lpThreadParameter, CPL_EXIT, 0, 0);
01067             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01068         } <span class="keywordflow">else</span> {
01069             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01070         }
01071         FreeLibrary(hLibrary);
01072     } <span class="keywordflow">else</span> {
01073         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01074     }
01075     fInPropRoutine = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01076 
01077     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01078 }
01079 
01080 <span class="preprocessor">#endif </span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
