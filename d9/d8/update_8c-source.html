<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: update.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>update.c</h1><a href="../../d8/d9/update_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: update.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the APIs used to invalidate, validate, and force</span>
00007 <span class="comment">* updating of windows.</span>
00008 <span class="comment">*</span>
00009 <span class="comment">* History:</span>
00010 <span class="comment">* 27-Oct-1990 DarrinM   Created.</span>
00011 <span class="comment">* 25-Jan-1991 IanJa     Revalidation added</span>
00012 <span class="comment">* 16-Jul-1991 DarrinM   Recreated from Win 3.1 sources.</span>
00013 <span class="comment">\***************************************************************************/</span>
00014 
00015 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00016 <span class="preprocessor">#pragma hdrstop</span>
00017 <span class="preprocessor"></span>
00018 <span class="comment">/*</span>
00019 <span class="comment"> * Local Constants.</span>
00020 <span class="comment"> */</span>
<a name="l00021"></a><a class="code" href="../../d8/d9/update_8c.html#a0">00021</a> <span class="preprocessor">#define UW_ENUMCHILDREN 0x0001</span>
<a name="l00022"></a><a class="code" href="../../d8/d9/update_8c.html#a1">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define UW_RECURSED     0x0004</span>
00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../d8/d9/update_8c.html#a2">00024</a> <span class="preprocessor">#define RIR_OUTSIDE     0</span>
<a name="l00025"></a><a class="code" href="../../d8/d9/update_8c.html#a3">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define RIR_INTERSECT   1</span>
<a name="l00026"></a><a class="code" href="../../d8/d9/update_8c.html#a4">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define RIR_INSIDE      2</span>
00027 <span class="preprocessor"></span>
<a name="l00028"></a><a class="code" href="../../d8/d9/update_8c.html#a5">00028</a> <span class="preprocessor">#define RDW_IGNOREUPDATEDIRTY 0x8000</span>
00029 <span class="preprocessor"></span>
00030 
00031 <span class="comment">/***************************************************************************\</span>
00032 <span class="comment">* xxxInvalidateRect (API)</span>
00033 <span class="comment">*</span>
00034 <span class="comment">*</span>
00035 <span class="comment">* History:</span>
00036 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00037 <span class="comment">\***************************************************************************/</span>
00038 
<a name="l00039"></a><a class="code" href="../../d4/d1/userk_8h.html#a1669">00039</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1669">xxxInvalidateRect</a>(
00040     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00041     LPRECT lprcInvalid,
00042     BOOL   fErase)
00043 {
00044     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00045 
00046     <span class="comment">/*</span>
00047 <span class="comment">     * BACKWARD COMPATIBILITY HACK</span>
00048 <span class="comment">     *</span>
00049 <span class="comment">     * In Windows 3.0 and less, ValidateRect/InvalidateRect() call with</span>
00050 <span class="comment">     * hwnd == NULL always INVALIDATED and ERASED the entire desktop, and</span>
00051 <span class="comment">     * synchronously sent WM_ERASEBKGND and WM_NCPAINT messages before</span>
00052 <span class="comment">     * returning.  The Rgn() calls did not have this behavior.</span>
00053 <span class="comment">     */</span>
00054     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00055         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
00056                 pwnd,
00057                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00058                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00059                 RDW_INVALIDATE | RDW_ALLCHILDREN | RDW_ERASE | RDW_ERASENOW);
00060     } <span class="keywordflow">else</span> {
00061         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
00062                 pwnd,
00063                 lprcInvalid,
00064                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00065                 fErase ? RDW_INVALIDATE | RDW_ERASE : RDW_INVALIDATE);
00066     }
00067 }
00068 
00069 <span class="comment">/***************************************************************************\</span>
00070 <span class="comment">* xxxValidateRect (API)</span>
00071 <span class="comment">*</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* History:</span>
00074 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00075 <span class="comment">\***************************************************************************/</span>
00076 
<a name="l00077"></a><a class="code" href="../../d4/d1/userk_8h.html#a1670">00077</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1670">xxxValidateRect</a>(
00078     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00079     LPRECT lprcValid)
00080 {
00081     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00082 
00083     <span class="comment">/*</span>
00084 <span class="comment">     * BACKWARD COMPATIBILITY HACK</span>
00085 <span class="comment">     *</span>
00086 <span class="comment">     * In Windows 3.0 and less, ValidateRect/InvalidateRect() call with</span>
00087 <span class="comment">     * hwnd == NULL always INVALIDATED and ERASED the entire desktop, and</span>
00088 <span class="comment">     * synchronously sent WM_ERASEBKGND and WM_NCPAINT messages before</span>
00089 <span class="comment">     * returning.  The Rgn() calls did not have this behavior.</span>
00090 <span class="comment">     */</span>
00091     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00092         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
00093                 pwnd,
00094                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00095                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00096                 RDW_INVALIDATE | RDW_ALLCHILDREN | RDW_ERASE | RDW_ERASENOW);
00097     } <span class="keywordflow">else</span> {
00098         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(pwnd, lprcValid, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, RDW_VALIDATE);
00099     }
00100 }
00101 
00102 <span class="comment">/***************************************************************************\</span>
00103 <span class="comment">* xxxInvalidateRgn (API)</span>
00104 <span class="comment">*</span>
00105 <span class="comment">*</span>
00106 <span class="comment">* History:</span>
00107 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00108 <span class="comment">\***************************************************************************/</span>
00109 
<a name="l00110"></a><a class="code" href="../../d4/d1/userk_8h.html#a1671">00110</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1671">xxxInvalidateRgn</a>(
00111     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00112     HRGN hrgnInvalid,
00113     BOOL fErase)
00114 {
00115     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00116 
00117     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
00118             pwnd,
00119             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00120             hrgnInvalid,
00121             fErase ? RDW_INVALIDATE | RDW_ERASE : RDW_INVALIDATE);
00122 }
00123 
00124 <span class="comment">/***************************************************************************\</span>
00125 <span class="comment">* xxxValidateRgn (API)</span>
00126 <span class="comment">*</span>
00127 <span class="comment">*</span>
00128 <span class="comment">* History:</span>
00129 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00130 <span class="comment">\***************************************************************************/</span>
00131 
<a name="l00132"></a><a class="code" href="../../d4/d1/userk_8h.html#a1672">00132</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1672">xxxValidateRgn</a>(
00133     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00134     HRGN hrgnValid)
00135 {
00136     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00137 
00138     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hrgnValid, RDW_VALIDATE);
00139 }
00140 
00141 <span class="comment">/***************************************************************************\</span>
00142 <span class="comment">* SmartRectInRegion</span>
00143 <span class="comment">*</span>
00144 <span class="comment">* This routine is similar to RectInRegion, except that it also determines</span>
00145 <span class="comment">* whether or not *lprc is completely within hrgn or not.</span>
00146 <span class="comment">*</span>
00147 <span class="comment">* RIR_OUTSIDE   - no intersection</span>
00148 <span class="comment">* RIR_INTERSECT - *lprc intersects hrgn, but not completely inside</span>
00149 <span class="comment">* RIR_INSIDE    - *lprc is completely within hrgn.</span>
00150 <span class="comment">*</span>
00151 <span class="comment">* LATER:</span>
00152 <span class="comment">* It would be MUCH faster to put this functionality into GDI's RectInRegion</span>
00153 <span class="comment">* call (a la PM's RectInRegion)</span>
00154 <span class="comment">*</span>
00155 <span class="comment">* History:</span>
00156 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00157 <span class="comment">\***************************************************************************/</span>
00158 
<a name="l00159"></a><a class="code" href="../../d8/d9/update_8c.html#a11">00159</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d8/d9/update_8c.html#a11">SmartRectInRegion</a>(
00160     HRGN   hrgn,
00161     LPRECT lprc)
00162 {
00163     RECT rc;
00164 
00165     <span class="keywordflow">if</span> (!GreRectInRegion(hrgn, lprc))
00166         <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a2">RIR_OUTSIDE</a>;
00167 
00168     <span class="comment">/*</span>
00169 <span class="comment">     * Algorithm: if the intersection of hrgn and *lprc is the</span>
00170 <span class="comment">     * same as *lprc, then *lprc is completely within hrgn.</span>
00171 <span class="comment">     *</span>
00172 <span class="comment">     * If the region is a rectangular one, then do it the easy way.</span>
00173 <span class="comment">     */</span>
00174     <span class="keywordflow">if</span> (GreGetRgnBox(hrgn, &amp;rc) == SIMPLEREGION) {
00175 
00176         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, lprc))
00177             <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a2">RIR_OUTSIDE</a>;
00178 
00179         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(lprc, &amp;rc))
00180             <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a4">RIR_INSIDE</a>;
00181 
00182     } <span class="keywordflow">else</span> {
00183 
00184         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, lprc);
00185 
00186         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, hrgn)) {
00187 
00188         <span class="keywordflow">case</span> SIMPLEREGION:
00189             GreGetRgnBox(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;rc);
00190             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a34">EqualRect</a>(lprc, &amp;rc))
00191                 <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a4">RIR_INSIDE</a>;
00192             <span class="keywordflow">break</span>;
00193 
00194 <span class="preprocessor">#define RECTINREGION_BUG</span>
00195 <span class="preprocessor"></span><span class="preprocessor">#ifdef RECTINREGION_BUG</span>
00196 <span class="preprocessor"></span>
00197         <span class="comment">/*</span>
00198 <span class="comment">         * NOTE: RectInRegion has a BUG, where it sometimes returns TRUE</span>
00199 <span class="comment">         * even if the rectangles of a region touch only on the edges</span>
00200 <span class="comment">         * with no overlap.  This will result in an empty region after</span>
00201 <span class="comment">         * the combination above.</span>
00202 <span class="comment">         */</span>
00203         <span class="keywordflow">case</span> NULLREGION:
00204             <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a2">RIR_OUTSIDE</a>;
00205             <span class="keywordflow">break</span>;
00206 <span class="preprocessor">#endif</span>
00207 <span class="preprocessor"></span>
00208         <span class="keywordflow">default</span>:
00209             <span class="keywordflow">break</span>;
00210         }
00211     }
00212 
00213     <span class="keywordflow">return</span> <a class="code" href="../../d8/d9/update_8c.html#a3">RIR_INTERSECT</a>;
00214 }
00215 
00216 <span class="comment">/***************************************************************************\</span>
00217 <span class="comment">* PixieHack</span>
00218 <span class="comment">*</span>
00219 <span class="comment">* BACKWARD COMPATIBILITY HACK</span>
00220 <span class="comment">*</span>
00221 <span class="comment">* In 3.0, WM_NCPAINT messages would be sent to any child window that was</span>
00222 <span class="comment">* inside the bounding rectangle of a window management operation involving</span>
00223 <span class="comment">* any other child, even if the intersection of that region with the child</span>
00224 <span class="comment">* is empty.</span>
00225 <span class="comment">*</span>
00226 <span class="comment">* Some apps such as Pixie 2.3 and CA Cricket Presents rely on this to ensure</span>
00227 <span class="comment">* that their tool windows stay on top of other child windows.  When the tool</span>
00228 <span class="comment">* window gets a WM_NCPAINT, it brings itself to the top of the pile.</span>
00229 <span class="comment">*</span>
00230 <span class="comment">* Borland ObjectVision depends on getting the WM_NCPAINT after an</span>
00231 <span class="comment">* invalidation of its parent window in an area that include the non-client</span>
00232 <span class="comment">* area of the child.  When it recieves the WM_NCPAINT, it must get a</span>
00233 <span class="comment">* clip region of HRGN_FULL, or nothing gets drawn.</span>
00234 <span class="comment">*</span>
00235 <span class="comment">* History:</span>
00236 <span class="comment">* 02-Mar-1992 MikeKe    Ported from Win 3.1 sources.</span>
00237 <span class="comment">\***************************************************************************/</span>
00238 
<a name="l00239"></a><a class="code" href="../../d8/d9/update_8c.html#a12">00239</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d9/update_8c.html#a12">PixieHack</a>(
00240     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00241     LPRECT prcBounds)
00242 {
00243     <span class="comment">/*</span>
00244 <span class="comment">     * If a child intersects the update region, and it isn't already</span>
00245 <span class="comment">     * getting an NCPAINT, then make sure it gets one later.</span>
00246 <span class="comment">     *</span>
00247 <span class="comment">     * Don't apply this hack to top level windows.</span>
00248 <span class="comment">     */</span>
00249     <span class="keywordflow">if</span> ((pwnd != <a class="code" href="../../d3/d9/client_2wow_8c.html#a3">_GetDesktopWindow</a>()) &amp;&amp;
00250         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)  &amp;&amp;
00251         !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)) {
00252 
00253         RECT rc;
00254 
00255         <span class="keywordflow">for</span> (pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwnd; pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00256 
00257             <span class="comment">/*</span>
00258 <span class="comment">             * If the window isn't already getting an NCPAINT message,</span>
00259 <span class="comment">             * and it has a caption, and it's inside the bounding rect,</span>
00260 <span class="comment">             * make sure it gets a WM_NCPAINT with wParam == HRGN_FULL.</span>
00261 <span class="comment">             */</span>
00262             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>)                      &amp;&amp;
00263                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a645">WFBORDERMASK</a>) == <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a646">WFCAPTION</a>)) &amp;&amp;
00264                 <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, prcBounds, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
00265 
00266                 <span class="comment">/*</span>
00267 <span class="comment">                 * Sync paint count is incremented when</span>
00268 <span class="comment">                 * (senderasebkgnd | sendncpaint) goes from 0 to != 0.</span>
00269 <span class="comment">                 * (should make a routine out of this!)</span>
00270 <span class="comment">                 */</span>
00271                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00272 
00273                 <span class="comment">/*</span>
00274 <span class="comment">                 * Force HRGN_FULL clip rgn.</span>
00275 <span class="comment">                 */</span>
00276                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a608">WFPIXIEHACK</a>);
00277             }
00278         }
00279     }
00280 }
00281 
00282 <span class="comment">/***************************************************************************\</span>
00283 <span class="comment">* xxxRedrawWindow (API)</span>
00284 <span class="comment">*</span>
00285 <span class="comment">* Forward to xxxInvalidateWindow if the window is visible.</span>
00286 <span class="comment">*</span>
00287 <span class="comment">* BACKWARD COMPATIBILITY HACK</span>
00288 <span class="comment">*</span>
00289 <span class="comment">* In Windows 3.0 and less, ValidateRect/InvalidateRect() call with pwnd == NULL</span>
00290 <span class="comment">* always INVALIDATED and ERASED all windows, and synchronously sent</span>
00291 <span class="comment">* WM_ERASEBKGND and WM_NCPAINT messages before returning.  The Rgn() calls</span>
00292 <span class="comment">* did not have this behavior. This case is handled in</span>
00293 <span class="comment">* InvalidateRect/ValidateRect.</span>
00294 <span class="comment">*</span>
00295 <span class="comment">* History:</span>
00296 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00297 <span class="comment">\***************************************************************************/</span>
00298 
<a name="l00299"></a><a class="code" href="../../d4/d1/userk_8h.html#a1679">00299</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1679">xxxRedrawWindow</a>(
00300     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00301     LPRECT lprcUpdate,
00302     HRGN   hrgnUpdate,
00303     DWORD  flags)
00304 {
00305     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00306 
00307     <span class="comment">/*</span>
00308 <span class="comment">     * Always map NULL to the desktop.</span>
00309 <span class="comment">     */</span>
00310     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00311         pwnd = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;rpdesk-&gt;pDeskInfo-&gt;spwnd;
00312     }
00313 
00314     UserAssert(pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00315 
00316     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a6">IsVisible</a>(pwnd)) {
00317 
00318         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>   tlpwnd;
00319         HRGN hrgn = hrgnUpdate;
00320 
00321         <span class="keywordflow">if</span> (flags &amp; (RDW_VALIDATE | RDW_INVALIDATE)) {
00322 
00323             <span class="comment">/*</span>
00324 <span class="comment">             * Create a (in)validate region in client window coordinates.</span>
00325 <span class="comment">             */</span>
00326             <span class="keywordflow">if</span> (hrgn == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00327                 <span class="keywordflow">if</span> (!lprcUpdate) {
00328                     hrgn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00329                 } <span class="keywordflow">else</span> {
00330                     hrgn = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a189">ghrgnInv0</a>;
00331 
00332 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00333 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00334                         MirrorRect(pwnd, lprcUpdate);
00335                     }
00336 <span class="preprocessor">#endif</span>
00337 <span class="preprocessor"></span>
00338                     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00339                         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgn, lprcUpdate);
00340                     } <span class="keywordflow">else</span> {
00341                         GreSetRectRgn(
00342                                 hrgn,
00343                                 lprcUpdate-&gt;left + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
00344                                 lprcUpdate-&gt;top + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top,
00345                                 lprcUpdate-&gt;right + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left,
00346                                 lprcUpdate-&gt;bottom + pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00347                     }
00348                 }
00349             } <span class="keywordflow">else</span> {
00350                 <span class="comment">/*</span>
00351 <span class="comment">                 * If necessary, make a copy of the passed-in region, because</span>
00352 <span class="comment">                 * we'll be trashing it...</span>
00353 <span class="comment">                 */</span>
00354                 <span class="keywordflow">if</span> (hrgn != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00355                     <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a189">ghrgnInv0</a>, hrgn);
00356 
00357 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00358 <span class="preprocessor"></span>                    MirrorRegion(pwnd, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a189">ghrgnInv0</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00359 <span class="preprocessor">#endif</span>
00360 <span class="preprocessor"></span>
00361                     hrgn = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a189">ghrgnInv0</a>;
00362                 }
00363 
00364                 <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00365                     GreOffsetRgn(hrgn, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
00366                 }
00367             }
00368         }
00369 
00370         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd);
00371         <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwnd, hrgn, flags | RDW_REDRAWWINDOW);
00372         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00373     }
00374 
00375     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00376 }
00377 
00378 <span class="comment">/***************************************************************************\</span>
00379 <span class="comment">* InternalInvalidate2</span>
00380 <span class="comment">*</span>
00381 <span class="comment">* (In)validates hrgn in pwnd and in child windows of pwnd. Child windows</span>
00382 <span class="comment">* also subtract their visible region from hrgnSubtract.</span>
00383 <span class="comment">*</span>
00384 <span class="comment">* pwnd         - The window to (in)validate.</span>
00385 <span class="comment">* hrng         - The region to (in)validate.</span>
00386 <span class="comment">* hrgnSubtract - The region to subtract the visible region of</span>
00387 <span class="comment">*                 child windows from.</span>
00388 <span class="comment">* prcParents   - Contains the intersection of pwnd's client or window rect</span>
00389 <span class="comment">*                 with the client rectangles of its parents. May just be</span>
00390 <span class="comment">*                 the window's client or window rect.</span>
00391 <span class="comment">*</span>
00392 <span class="comment">* flags        - RDW_ flags.</span>
00393 <span class="comment">*</span>
00394 <span class="comment">* Returns FALSE if hrgnSubtract becomes a NULLREGION, TRUE otherwise.</span>
00395 <span class="comment">*</span>
00396 <span class="comment">* History:</span>
00397 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00398 <span class="comment">\***************************************************************************/</span>
00399 
<a name="l00400"></a><a class="code" href="../../d8/d9/update_8c.html#a14">00400</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/update_8c.html#a14">InternalInvalidate2</a>(
00401     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
00402     HRGN   hrgn,
00403     HRGN   hrgnSubtract,
00404     LPRECT prcParents,
00405     DWORD  flags)
00406 {
00407     <span class="comment">/*</span>
00408 <span class="comment">     * NOTE: Uses ghrgnInv2</span>
00409 <span class="comment">     */</span>
00410     RECT  rcOurShare;
00411     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> flagsChildren;
00412     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndT;
00413 
00414     <span class="comment">/*</span>
00415 <span class="comment">     * This routine is called recursively down the parent/child chain.</span>
00416 <span class="comment">     * Remember if on the way one of the windows has a clipping region.</span>
00417 <span class="comment">     * This info is used later on to optimize out a loop in the common</span>
00418 <span class="comment">     * case.</span>
00419 <span class="comment">     */</span>
00420     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00421         flags |= <a class="code" href="../../d4/d1/userk_8h.html#a572">RDW_HASWINDOWRGN</a>;
00422     }
00423 
00424     <span class="comment">/*</span>
00425 <span class="comment">     * If we recurse, make sure our children subtract themselves off.</span>
00426 <span class="comment">     */</span>
00427     flagsChildren = flags | RDW_SUBTRACTSELF;
00428     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rcOurShare, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00429 
00430     <span class="comment">/*</span>
00431 <span class="comment">     * If we're invalidating, we only want to deal with the part of</span>
00432 <span class="comment">     * our window rectangle that intersects our parents.</span>
00433 <span class="comment">     * This way, we don't end up validating or invalidating more than our</span>
00434 <span class="comment">     * fair share. If we're completely obscured by our parents, then there is</span>
00435 <span class="comment">     * nothing to do.</span>
00436 <span class="comment">     *</span>
00437 <span class="comment">     * We don't perform this intersection if we're validating, because there</span>
00438 <span class="comment">     * are cases where a child and its update region may exist but be obscured</span>
00439 <span class="comment">     * by parents, and we want to make sure validation will work in these</span>
00440 <span class="comment">     * cases.  ScrollWindow() can cause this when children are offset, as can</span>
00441 <span class="comment">     * various 3.0 compatibility hacks.</span>
00442 <span class="comment">     */</span>
00443 
00444     <span class="keywordflow">if</span> (flags &amp; RDW_INVALIDATE) {
00445         <span class="comment">/*</span>
00446 <span class="comment">         * Don't subtract out any sprite windows from the invalid region.</span>
00447 <span class="comment">         * Behave as if it's not there.  However, always allow layered window</span>
00448 <span class="comment">         * invalidation when RDW_INVALIDATELAYERS is passed in.</span>
00449 <span class="comment">         */</span>
00450         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd) &amp;&amp; !(flags &amp; RDW_INVALIDATELAYERS))
00451             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452 
00453         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcOurShare, &amp;rcOurShare, prcParents)) {
00454 
00455             <span class="comment">/*</span>
00456 <span class="comment">             * BACKWARD COMPATIBILITY HACK: If hrgn is (HRGN)1, we need to</span>
00457 <span class="comment">             * invalidate ALL child windows, even if they're not visible.  This</span>
00458 <span class="comment">             * is a bummer, because it'll result in all sorts of repaints that</span>
00459 <span class="comment">             * aren't necessary.</span>
00460 <span class="comment">             *</span>
00461 <span class="comment">             * Various apps, including WordStar for Windows and WaveEdit,</span>
00462 <span class="comment">             * depend on this behavior.  Here's how WaveEdit relies on this: it</span>
00463 <span class="comment">             * has a CS_HDREDRAW | CS_VREDRAW window, that moves its children</span>
00464 <span class="comment">             * around with MoveWindow( ..., fRedraw = FALSE).  The windows</span>
00465 <span class="comment">             * not part of the new client area didn't get invalidated.</span>
00466 <span class="comment">             */</span>
00467             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp; (hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)) {
00468 
00469                 <span class="comment">/*</span>
00470 <span class="comment">                 * For purposes of hit-testing, our share is our window</span>
00471 <span class="comment">                 * rectangle.  However, we don't want to diddle the region</span>
00472 <span class="comment">                 * passed to us, because by rights we're really clipped out!</span>
00473 <span class="comment">                 */</span>
00474                 flags &amp;= ~RDW_SUBTRACTSELF;
00475                 flagsChildren &amp;= ~RDW_SUBTRACTSELF;
00476 
00477             } <span class="keywordflow">else</span> {
00478                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00479             }
00480         }
00481 
00482         <span class="comment">/*</span>
00483 <span class="comment">         * If our window rect doesn't intersect the valid/invalid region,</span>
00484 <span class="comment">         * nothing further to do.</span>
00485 <span class="comment">         */</span>
00486         <span class="keywordflow">if</span> (hrgn &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00487 
00488             <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d9/update_8c.html#a11">SmartRectInRegion</a>(hrgn, &amp;rcOurShare)) {
00489             <span class="keywordflow">case</span> <a class="code" href="../../d8/d9/update_8c.html#a2">RIR_OUTSIDE</a>:
00490                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00491 
00492             <span class="keywordflow">case</span> <a class="code" href="../../d8/d9/update_8c.html#a3">RIR_INTERSECT</a>:
00493 
00494                 <span class="comment">/*</span>
00495 <span class="comment">                 * The update region can be within the window rect but not</span>
00496 <span class="comment">                 * touch the window region; in this case we don't want this</span>
00497 <span class="comment">                 * update region to be distributed to this window. If this</span>
00498 <span class="comment">                 * is the case, return TRUE as if RIR_OUTSIDE.</span>
00499 <span class="comment">                 *</span>
00500 <span class="comment">                 * If RDW_HASWINDOWRGN is set, either this window or</span>
00501 <span class="comment">                 * one of its parents has a window clipping region. This</span>
00502 <span class="comment">                 * flag is just an optimization so that this loop isn't</span>
00503 <span class="comment">                 * executed all the time.</span>
00504 <span class="comment">                 *</span>
00505 <span class="comment">                 * A future optimization may be to calculate this parent</span>
00506 <span class="comment">                 * clipped region as part of recursion like prcParents is</span>
00507 <span class="comment">                 * calculated. It is not super important though because this</span>
00508 <span class="comment">                 * case rarely happens (a window with a region), and even</span>
00509 <span class="comment">                 * more rare, a regional window that is a child of a regional</span>
00510 <span class="comment">                 * window parent.</span>
00511 <span class="comment">                 */</span>
00512                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a572">RDW_HASWINDOWRGN</a>) {
00513 
00514                     <span class="comment">/*</span>
00515 <span class="comment">                     * Clip to the window's clipping region and parents!</span>
00516 <span class="comment">                     * If we don't clip to parents, we may get a case where</span>
00517 <span class="comment">                     * a child clips out some update region that was meant to</span>
00518 <span class="comment">                     * go to a sibling of the parent.</span>
00519 <span class="comment">                     */</span>
00520                     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;rcOurShare);
00521                     <span class="keywordflow">for</span> (pwndT = pwnd; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00522 
00523                         <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524 
00525                             <span class="comment">/*</span>
00526 <span class="comment">                             * An error at this stage would possibly result</span>
00527 <span class="comment">                             * in more being subtracted out of the clipping</span>
00528 <span class="comment">                             * region that we'd like.</span>
00529 <span class="comment">                             */</span>
00530                             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
00531                         }
00532                     }
00533 
00534                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, hrgn) == NULLREGION)
00535                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00536                 }
00537                 <span class="keywordflow">break</span>;
00538 
00539             <span class="keywordflow">case</span> <a class="code" href="../../d8/d9/update_8c.html#a4">RIR_INSIDE</a>:
00540                 <span class="comment">/*</span>
00541 <span class="comment">                 * If the rectangle is completely within hrgn, then we can use</span>
00542 <span class="comment">                 * HRGN_FULL, which is much faster and easier to deal with.</span>
00543 <span class="comment">                 *</span>
00544 <span class="comment">                 * COMPAT HACK:  There are some apps (PP, MSDRAW) that depend</span>
00545 <span class="comment">                 * on some weirdities of the 3.0 GetUpdateRect in order to</span>
00546 <span class="comment">                 * paint properly.  Since this stuff hinges on whether the</span>
00547 <span class="comment">                 * update region is 1 or a real region, we need to simulate</span>
00548 <span class="comment">                 * when 3.0 would generate a HRGN(1) update region.  The</span>
00549 <span class="comment">                 * following optimization was not made in 3.0, so we yank it</span>
00550 <span class="comment">                 * in 3.1 for these apps.  (win31 bugs 8235,10380)</span>
00551 <span class="comment">                 */</span>
00552                 <span class="keywordflow">if</span> (!(<a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) &amp; GACF_NOHRGN1))
00553                     hrgn = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00554                 <span class="keywordflow">break</span>;
00555             }
00556         }
00557     }
00558 
00559     <span class="comment">/*</span>
00560 <span class="comment">     * If not CLIPCHILDREN, go diddle the update region BEFORE our clipped</span>
00561 <span class="comment">     * children have done their thing to hrgnSubtract. Otherwise,</span>
00562 <span class="comment">     * we'll diddle after we recurse.</span>
00563 <span class="comment">     */</span>
00564     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>)) {
00565         <a class="code" href="../../d4/d1/userk_8h.html#a1992">InternalInvalidate3</a>(pwnd, hrgn, flags);
00566     }
00567 
00568     <span class="comment">/*</span>
00569 <span class="comment">     * If this is a GACF_ALWAYSSENDNCPAINT app, take care of it...</span>
00570 <span class="comment">     */</span>
00571     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a607">WFALWAYSSENDNCPAINT</a>))
00572         <a class="code" href="../../d8/d9/update_8c.html#a12">PixieHack</a>(pwnd, &amp;rcOurShare);
00573 
00574     <span class="comment">/*</span>
00575 <span class="comment">     * Recurse on our children if necessary.</span>
00576 <span class="comment">     *</span>
00577 <span class="comment">     * By default, our children are enumerated if we are not CLIPCHILDREN.</span>
00578 <span class="comment">     * Don't bother with children if we're minimized.</span>
00579 <span class="comment">     */</span>
00580     <span class="keywordflow">if</span> ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00581         !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>) &amp;&amp;
00582         !(flags &amp; RDW_NOCHILDREN)  &amp;&amp;
00583         ((flags &amp; RDW_ALLCHILDREN) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))) {
00584 
00585         RECT rcChildrenShare;
00586         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndChild;
00587 
00588         <span class="comment">/*</span>
00589 <span class="comment">         * If we're invalidating, make sure our children</span>
00590 <span class="comment">         * erase and frame themselves. Also, tell children to subtract</span>
00591 <span class="comment">         * themselves from hrgnSubtract.</span>
00592 <span class="comment">         */</span>
00593         <span class="keywordflow">if</span> (flags &amp; RDW_INVALIDATE) {
00594             flagsChildren |= RDW_ERASE | RDW_FRAME;
00595         }
00596 
00597         <span class="comment">/*</span>
00598 <span class="comment">         * Our children are clipped to our client rect, so reflect</span>
00599 <span class="comment">         * that in the rectangle we give them.</span>
00600 <span class="comment">         */</span>
00601         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcChildrenShare, &amp;rcOurShare, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>) ||
00602             (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) &amp;&amp; (hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>))) {
00603 
00604             <span class="keywordflow">for</span> (pwndChild = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndChild != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00605                     pwndChild = pwndChild-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00606 
00607                 <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndChild, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>))
00608                     <span class="keywordflow">continue</span>;
00609 
00610                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/update_8c.html#a14">InternalInvalidate2</a>(pwndChild,
00611                                          hrgn,
00612                                          hrgnSubtract,
00613                                          &amp;rcChildrenShare,
00614                                          flagsChildren)) {
00615 
00616                     <span class="comment">/*</span>
00617 <span class="comment">                     * The children swallowed the region:</span>
00618 <span class="comment">                     * If there are no update region related things</span>
00619 <span class="comment">                     * to do then we can just return with FALSE</span>
00620 <span class="comment">                     */</span>
00621                     <span class="keywordflow">if</span> (!(flags &amp; (RDW_INTERNALPAINT | RDW_NOINTERNALPAINT)))
00622                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00623 
00624                     <span class="comment">/*</span>
00625 <span class="comment">                     * We have to enumerate the rest of the children because</span>
00626 <span class="comment">                     * one of the RDW_NO/INTERNALPAINT bits is set.  Since</span>
00627 <span class="comment">                     * there's no longer any update region to worry about,</span>
00628 <span class="comment">                     * strip out the update region bits from the parent</span>
00629 <span class="comment">                     * and child fiags.  Also, tell the children not to</span>
00630 <span class="comment">                     * bother subtracting themselves from the region.</span>
00631 <span class="comment">                     */</span>
00632                     flags &amp;= ~(RDW_INVALIDATE |
00633                                RDW_ERASE      |
00634                                RDW_FRAME      |
00635                                RDW_VALIDATE   |
00636                                RDW_NOERASE    |
00637                                RDW_NOFRAME);
00638 
00639                     flagsChildren &amp;= ~(RDW_INVALIDATE |
00640                                        RDW_ERASE      |
00641                                        RDW_FRAME      |
00642                                        RDW_VALIDATE   |
00643                                        RDW_NOERASE    |
00644                                        RDW_NOFRAME    |
00645                                        RDW_SUBTRACTSELF);
00646                 }
00647             }
00648         }
00649     }
00650 
00651     <span class="comment">/*</span>
00652 <span class="comment">     * Go diddle the update region  (AFTER our clipped children may have</span>
00653 <span class="comment">     * done their thing to hrgnSubtract)</span>
00654 <span class="comment">     */</span>
00655     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
00656         <a class="code" href="../../d4/d1/userk_8h.html#a1992">InternalInvalidate3</a>(pwnd, hrgn, flags);
00657 
00658     <span class="comment">/*</span>
00659 <span class="comment">     * If we're invalidating and we're supposed to,</span>
00660 <span class="comment">     * try to subtract off our window area from the region.</span>
00661 <span class="comment">     *</span>
00662 <span class="comment">     * This way our parent and our siblings below us will not</span>
00663 <span class="comment">     * get any update region for areas that don't need one.</span>
00664 <span class="comment">     */</span>
00665     <span class="keywordflow">if</span> (flags &amp; RDW_SUBTRACTSELF) {
00666 
00667         <span class="comment">/*</span>
00668 <span class="comment">         * Subtract our visible region from the update rgn only if:</span>
00669 <span class="comment">         * a) we're not a transparent window</span>
00670 <span class="comment">         * b) we are clipsiblings</span>
00671 <span class="comment">         * c) we're validating OR our parent is clipchildren.</span>
00672 <span class="comment">         *</span>
00673 <span class="comment">         * The check for validation is a backward-compatibility hack: this</span>
00674 <span class="comment">         * is what 3.0 did, so this is what we do here.</span>
00675 <span class="comment">         *</span>
00676 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
00677 <span class="comment">         *</span>
00678 <span class="comment">         * In 3.0, we subtracted this window from the update rgn if it</span>
00679 <span class="comment">         * was clipsiblings, even if the parent was not clipchildren.</span>
00680 <span class="comment">         * This causes a compatibility problem for Lotus Notes 3.1: it</span>
00681 <span class="comment">         * has a combobox dropdown in a dialog that is a WS_CLIPSIBLING</span>
00682 <span class="comment">         * sibling of the other dialog controls, which are not WS_CLIPSIBLINGs.</span>
00683 <span class="comment">         * The dialog is not WS_CLIPCHILDREN.  What happens is that a listbox</span>
00684 <span class="comment">         * underneath the dropdown also gets a paint msg (since we didn't</span>
00685 <span class="comment">         * do this subtraction), and, since it's not CLIPSIBLINGS, it</span>
00686 <span class="comment">         * obliterates the dropdown.</span>
00687 <span class="comment">         *</span>
00688 <span class="comment">         * This is a very obscure difference, and it's too late in the</span>
00689 <span class="comment">         * project to make this change now, so we're leaving the code as is</span>
00690 <span class="comment">         * and using a compatibility hack to enable the 3.0-compatible</span>
00691 <span class="comment">         * behavior.  It's quite likely that this code works the way it does</span>
00692 <span class="comment">         * for other compatibility reasons.  Sigh (neilk).</span>
00693 <span class="comment">         */</span>
00694         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>) &amp;&amp;
00695             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a650">WFCLIPSIBLINGS</a>)  &amp;&amp;
00696             ((flags &amp; RDW_VALIDATE) ||
00697                  ((pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00698                  (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>) ||
00699                  (<a class="code" href="../../d6/d3/queue_8c.html#a34">GetAppCompatFlags</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) &amp; GACF_SUBTRACTCLIPSIBS))))) {
00700 
00701             <span class="comment">/*</span>
00702 <span class="comment">             * Intersect with our visible area.</span>
00703 <span class="comment">             *</span>
00704 <span class="comment">             * Don't worry about errors: an error will result in more, not less</span>
00705 <span class="comment">             * area being invalidated, which is okay.</span>
00706 <span class="comment">             */</span>
00707             <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;rcOurShare);
00708 
00709             <span class="comment">/*</span>
00710 <span class="comment">             * If RDW_HASWINDOWRGN is set, either this window or</span>
00711 <span class="comment">             * one of its parents has a window clipping region. This</span>
00712 <span class="comment">             * flag is just an optimization so that this loop isn't</span>
00713 <span class="comment">             * executed all the time.</span>
00714 <span class="comment">             */</span>
00715             <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a572">RDW_HASWINDOWRGN</a>) {
00716 
00717                 <span class="comment">/*</span>
00718 <span class="comment">                 * Clip to the window's clipping region and parents!</span>
00719 <span class="comment">                 * If we don't clip to parents, we may get a case where</span>
00720 <span class="comment">                 * a child clips out some update region that was meant to</span>
00721 <span class="comment">                 * go to a sibling of the parent.</span>
00722 <span class="comment">                 */</span>
00723                 <span class="keywordflow">for</span> (pwndT = pwnd; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) {
00724 
00725                     <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00726 
00727                         <span class="comment">/*</span>
00728 <span class="comment">                         * An error at this stage would possibly result in more</span>
00729 <span class="comment">                         * being subtracted out of the clipping region that</span>
00730 <span class="comment">                         * we'd like.</span>
00731 <span class="comment">                         */</span>
00732                         <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o19">hrgnClip</a>);
00733                     }
00734                 }
00735             }
00736 
00737 
00738 <span class="preprocessor">#if 1</span>
00739 <span class="preprocessor"></span>            <span class="comment">/*</span>
00740 <span class="comment">             * TEMP HACK!!! RE-ENABLE this code when regions work again</span>
00741 <span class="comment">             */</span>
00742             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnSubtract, hrgnSubtract, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>) == NULLREGION)
00743                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00744 <span class="preprocessor">#else</span>
00745 <span class="preprocessor"></span>            {
00746             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> iRet;
00747 
00748             iRet = <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(hrgnSubtract, hrgnSubtract, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>);
00749 
00750             <span class="keywordflow">if</span> (iRet == NULLREGION)
00751                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00752 
00753             <span class="keywordflow">if</span> (iRet == SIMPLEREGION) {
00754                 RECT rcSub;
00755                 GreGetRgnBox(hrgnSubtract, &amp;rcSub);
00756                 <span class="keywordflow">if</span> (rcSub.left &gt; rcSub.right)
00757                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00758             }
00759             }
00760 <span class="preprocessor">#endif</span>
00761 <span class="preprocessor"></span>
00762 
00763 
00764         }
00765     }
00766 
00767     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768 }
00769 
00770 <span class="comment">/***************************************************************************\</span>
00771 <span class="comment">* InternalInvalidate3</span>
00772 <span class="comment">*</span>
00773 <span class="comment">* Adds or subtracts hrgn to the windows update region and sets appropriate</span>
00774 <span class="comment">* painting state flags.</span>
00775 <span class="comment">*</span>
00776 <span class="comment">* pwnd  - The window.</span>
00777 <span class="comment">* hrng  - The region to add to the update region.</span>
00778 <span class="comment">* flags - RDW_ flags.</span>
00779 <span class="comment">*</span>
00780 <span class="comment">* History:</span>
00781 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
00782 <span class="comment">\***************************************************************************/</span>
00783 
<a name="l00784"></a><a class="code" href="../../d4/d1/userk_8h.html#a1992">00784</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1992">InternalInvalidate3</a>(
00785     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00786     HRGN  hrgn,
00787     DWORD flags)
00788 {
00789     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNeededPaint;
00790 
00791     fNeededPaint = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd);
00792 
00793     <span class="keywordflow">if</span> (flags &amp; (RDW_INVALIDATE | RDW_INTERNALPAINT | RDW_ERASE | RDW_FRAME)) {
00794 
00795         <span class="keywordflow">if</span> (flags &amp; RDW_INTERNALPAINT)
00796             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
00797 
00798         <span class="keywordflow">if</span> (flags &amp; RDW_INVALIDATE) {
00799 
00800             <span class="comment">/*</span>
00801 <span class="comment">             * Make sure that the NONCPAINT bit is cleared</span>
00802 <span class="comment">             * to ensure that the caption will redraw when we update.</span>
00803 <span class="comment">             */</span>
00804             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a559">WFNONCPAINT</a>);
00805 
00806             <span class="comment">/*</span>
00807 <span class="comment">             * If another app is invalidating this window, then set the</span>
00808 <span class="comment">             * UPDATEDIRTY flag.</span>
00809 <span class="comment">             *</span>
00810 <span class="comment">             * Solves critical section where thread A draws, then validates,</span>
00811 <span class="comment">             * but thread B goes and invalidates before A validates.</span>
00812 <span class="comment">             * See comments later in RDW_VALIDATE code.</span>
00813 <span class="comment">             */</span>
00814             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()) {
00815 
00816                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
00817 
00818                 <span class="comment">/*</span>
00819 <span class="comment">                 * Paint order problem, see paint.c</span>
00820 <span class="comment">                 */</span>
00821                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a584">WFWMPAINTSENT</a>)) {
00822                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a585">WFDONTVALIDATE</a>);
00823                 }
00824             }
00825 
00826             <span class="comment">/*</span>
00827 <span class="comment">             * BACKWARD COMPATIBILITY HACK</span>
00828 <span class="comment">             *</span>
00829 <span class="comment">             * In 3.0, InvalidateRect(pwnd, NULL, FALSE) would always</span>
00830 <span class="comment">             * clear the WFSENDERASEBKGND flag, even if it was previously</span>
00831 <span class="comment">             * set from an InvalidateRect(pwnd, NULL, TRUE).  This is bogus,</span>
00832 <span class="comment">             * because it can cause you to "lose" WM_ERASEBKGND messages, but</span>
00833 <span class="comment">             * AttachMate Extra (and maybe other apps) depend on this behavior.</span>
00834 <span class="comment">             */</span>
00835             <span class="keywordflow">if</span> ((hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>))
00836                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00837 
00838             <span class="keywordflow">if</span> (flags &amp; RDW_ERASE)
00839                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00840 
00841             <span class="keywordflow">if</span> ((flags &amp; (RDW_FRAME | RDW_ERASE)) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>))
00842                 <a class="code" href="../../d4/d1/userk_8h.html#a1125">SetHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00843 
00844             <span class="keywordflow">if</span> (flags &amp; RDW_FRAME)
00845                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00846 
00847             <span class="comment">/*</span>
00848 <span class="comment">             * If window is already completely invalidated,</span>
00849 <span class="comment">             * no need to do any further invalidation.</span>
00850 <span class="comment">             */</span>
00851             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00852 
00853                 <span class="keywordflow">if</span> (hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00854 InvalidateAll:
00855                     <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
00856                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00857 
00858                 } <span class="keywordflow">else</span> {
00859                     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00860 
00861                         <span class="keywordflow">if</span> (!(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>()))
00862                             <span class="keywordflow">goto</span> InvalidateAll;
00863 
00864                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>, hrgn) == ERROR)
00865                             <span class="keywordflow">goto</span> InvalidateAll;
00866 
00867                     } <span class="keywordflow">else</span> {   <span class="comment">// pwnd-&gt;hrgnUpdate is a region</span>
00868 
00869                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a230">UnionRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00870                                      pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00871                                      hrgn) == ERROR) {
00872 
00873                             <span class="keywordflow">goto</span> InvalidateAll;
00874                         }
00875                     }
00876                 }
00877             }
00878         }
00879 
00880         <span class="keywordflow">if</span> (!fNeededPaint &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd))
00881             <a class="code" href="../../d4/d1/userk_8h.html#a1469">IncPaintCount</a>(pwnd);
00882 
00883     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; (RDW_VALIDATE | RDW_NOINTERNALPAINT | RDW_NOERASE | RDW_NOFRAME)) {
00884 
00885         <span class="comment">/*</span>
00886 <span class="comment">         * Validation:</span>
00887 <span class="comment">         *</span>
00888 <span class="comment">         * Do not allow validation if this window has been invalidated from</span>
00889 <span class="comment">         * another process - because this window may be validating just</span>
00890 <span class="comment">         * after another process invalidated, thereby validating invalid</span>
00891 <span class="comment">         * bits.</span>
00892 <span class="comment">         *</span>
00893 <span class="comment">         * Sometimes applications draw stuff, then validate what they drew.</span>
00894 <span class="comment">         * If another app invalidated some area during the drawing operation,</span>
00895 <span class="comment">         * then it will need another paint message.</span>
00896 <span class="comment">         *</span>
00897 <span class="comment">         * This wouldn't be necessary if people validated BEFORE they drew.</span>
00898 <span class="comment">         */</span>
00899         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>) &amp;&amp; !(flags &amp; <a class="code" href="../../d8/d9/update_8c.html#a5">RDW_IGNOREUPDATEDIRTY</a>))
00900             <span class="keywordflow">return</span>;
00901 
00902         <span class="keywordflow">if</span> (flags &amp; RDW_NOINTERNALPAINT)
00903             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
00904 
00905         <span class="keywordflow">if</span> (flags &amp; RDW_VALIDATE) {
00906 
00907             <span class="keywordflow">if</span> (flags &amp; RDW_NOERASE)
00908                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00909 
00910             <span class="keywordflow">if</span> (flags &amp; RDW_NOFRAME) {
00911                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>);
00912                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a608">WFPIXIEHACK</a>);
00913             }
00914 
00915             <span class="keywordflow">if</span> (flags &amp; (RDW_NOERASE | RDW_NOFRAME))
00916                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00917 
00918             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00919 
00920                 <span class="comment">/*</span>
00921 <span class="comment">                 * If WFSENDNCPAINT is set, then all or part of the</span>
00922 <span class="comment">                 * window border still needs to be drawn.  This means</span>
00923 <span class="comment">                 * that we must subtract off the client rectangle only.</span>
00924 <span class="comment">                 * Convert HRGN_FULL to the client region.</span>
00925 <span class="comment">                 */</span>
00926                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>) &amp;&amp; (hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)) {
00927                     hrgn = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>;
00928                     <a class="code" href="../../d3/d6/visrgn_8c.html#a18">CalcWindowRgn</a>(pwnd, hrgn, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00929                 }
00930 
00931                 <span class="keywordflow">if</span> (hrgn == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00932 ValidateAll:
00933 
00934                     <span class="comment">/*</span>
00935 <span class="comment">                     * We're validating the entire window.  Just</span>
00936 <span class="comment">                     * blow away the update region.</span>
00937 <span class="comment">                     */</span>
00938                     <a class="code" href="../../d4/d1/userk_8h.html#a1003">DeleteMaybeSpecialRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
00939                     pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = (HRGN)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00940 
00941                     <span class="comment">/*</span>
00942 <span class="comment">                     * No need to erase the background...</span>
00943 <span class="comment">                     */</span>
00944                     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a560">WFSENDERASEBKGND</a>);
00945                     <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a578">WFREDRAWIFHUNG</a>);
00946 
00947                 } <span class="keywordflow">else</span> {
00948 
00949                     <span class="comment">/*</span>
00950 <span class="comment">                     * Subtracting some region from pwnd-&gt;hrgnUpdate.</span>
00951 <span class="comment">                     * Be sure pwnd-&gt;hrgnUpdate is a real region.</span>
00952 <span class="comment">                     */</span>
00953                     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00954 
00955                         <span class="comment">/*</span>
00956 <span class="comment">                         * If the WFSENDNCPAINT bit is set,</span>
00957 <span class="comment">                         * the update region must include the entire window</span>
00958 <span class="comment">                         * area.  Otherwise it includes only the client.</span>
00959 <span class="comment">                         */</span>
00960                         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1163">CreateEmptyRgnPublic</a>();
00961 
00962                         <span class="comment">/*</span>
00963 <span class="comment">                         * If the creation failed, punt by</span>
00964 <span class="comment">                         * invalidating the entire window.</span>
00965 <span class="comment">                         */</span>
00966                         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00967                             <span class="keywordflow">goto</span> InvalidateAll;
00968 
00969                         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/visrgn_8c.html#a18">CalcWindowRgn</a>(pwnd,
00970                                           pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00971                                           !(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a562">WFSENDNCPAINT</a>))) == ERROR) {
00972 
00973                             <span class="keywordflow">goto</span> InvalidateAll;
00974                         }
00975                     }
00976 
00977                     <span class="comment">/*</span>
00978 <span class="comment">                     * Subtract off the region.  If we get an error,</span>
00979 <span class="comment">                     * punt by invalidating everything.  If the</span>
00980 <span class="comment">                     * region becomes empty, then validate everything.</span>
00981 <span class="comment">                     */</span>
00982                     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00983                                         pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>,
00984                                         hrgn)) {
00985                     <span class="keywordflow">case</span> ERROR:
00986                         <span class="keywordflow">goto</span> InvalidateAll;
00987 
00988                     <span class="keywordflow">case</span> NULLREGION:
00989                         <span class="keywordflow">goto</span> ValidateAll;
00990                     }
00991                 }
00992             }
00993         }
00994 
00995         <span class="keywordflow">if</span> (fNeededPaint &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd))
00996             <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
00997     }
00998 }
00999 
01000 <span class="comment">/***************************************************************************\</span>
01001 <span class="comment">* ValidateParents</span>
01002 <span class="comment">*</span>
01003 <span class="comment">* This routine validates hrgn from the update regions of the parent windows</span>
01004 <span class="comment">* between pwnd and its first clip children parent.</span>
01005 <span class="comment">* If hrgn is NULL, then the window rect (intersected with all parents)</span>
01006 <span class="comment">* is validated.</span>
01007 <span class="comment">*</span>
01008 <span class="comment">* This routine is called when a window is being drawn in</span>
01009 <span class="comment">* UpdateWindow() so that non-CLIPCHILDREN parents</span>
01010 <span class="comment">* of windows being redrawn won't draw on their valid children.</span>
01011 <span class="comment">*</span>
01012 <span class="comment">* Returns FALSE if fRecurse is TRUE and a non-CLIPCHILDREN parent</span>
01013 <span class="comment">* has an update region; otherwise, returns TRUE.</span>
01014 <span class="comment">*</span>
01015 <span class="comment">* History:</span>
01016 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01017 <span class="comment">\***************************************************************************/</span>
01018 
<a name="l01019"></a><a class="code" href="../../d8/d9/update_8c.html#a16">01019</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/update_8c.html#a16">ValidateParents</a>(
01020     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01021     BOOL fRecurse)
01022 {
01023     RECT rcParents;
01024     RECT rc;
01025     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent = pwnd;
01026     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01027 
01028     <span class="comment">/*</span>
01029 <span class="comment">     * This is checking whether we are in an in-between state, just before</span>
01030 <span class="comment">     * a WM_SYNCPAINT is about to arrive.  If not, then ValidateParents()</span>
01031 <span class="comment">     * needs to work like it did in Win 3.1.</span>
01032 <span class="comment">     */</span>
01033     <span class="keywordflow">while</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a654">WFCHILD</a>))
01034         pwndParent = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>;
01035 
01036     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a574">WFSYNCPAINTPENDING</a>))
01037         fRecurse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01038 
01039     pwndParent = pwnd;
01040 
01041     <span class="keywordflow">while</span> ((pwndParent = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01042 
01043         <span class="comment">/*</span>
01044 <span class="comment">         * Stop when we find a clipchildren parent</span>
01045 <span class="comment">         */</span>
01046         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndParent, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a649">WFCLIPCHILDREN</a>))
01047             <span class="keywordflow">break</span>;
01048 
01049         <span class="comment">/*</span>
01050 <span class="comment">         * Subtract the region from this parent's update region,</span>
01051 <span class="comment">         * if it has one.</span>
01052 <span class="comment">         */</span>
01053         <span class="keywordflow">if</span> (pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01054             <span class="keywordflow">if</span> (fRecurse) {
01055                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01056             }
01057             <span class="keywordflow">if</span> (!fInit) {
01058                 fInit = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01059 
01060                 <span class="comment">/*</span>
01061 <span class="comment">                 * Do initial setup.  If our window rectangle is</span>
01062 <span class="comment">                 * completely obscured, get out.</span>
01063 <span class="comment">                 */</span>
01064                 rc = pwnd-&gt;rcWindow;
01065                 <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwnd, &amp;rc))
01066                     <span class="keywordflow">break</span>;
01067 
01068                 <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, &amp;rc);
01069 
01070                 <span class="comment">/*</span>
01071 <span class="comment">                 * If this window has a region, make sure the piece being validated</span>
01072 <span class="comment">                 * is within this region.</span>
01073 <span class="comment">                 */</span>
01074                 <span class="keywordflow">if</span> (pwnd-&gt;hrgnClip != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01075 
01076                     <span class="comment">/*</span>
01077 <span class="comment">                     * If we get NULLREGION back, there is nothing to validate</span>
01078 <span class="comment">                     * against parents, so break out. If ERROR gets returned,</span>
01079 <span class="comment">                     * there is not much we can do: the best "wrong" thing</span>
01080 <span class="comment">                     * to do is just continue and validate a little more</span>
01081 <span class="comment">                     * from the parent.</span>
01082 <span class="comment">                     */</span>
01083                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, pwnd-&gt;hrgnClip))
01084                         <span class="keywordflow">break</span>;
01085                 }
01086             }
01087 
01088             <span class="comment">/*</span>
01089 <span class="comment">             * Calculate the rcParents parameter to</span>
01090 <span class="comment">             * pass up to InternalInvalidate2.</span>
01091 <span class="comment">             */</span>
01092             rcParents = pwndParent-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
01093 
01094             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwndParent, &amp;rcParents))
01095                 <span class="keywordflow">break</span>;
01096 
01097             <a class="code" href="../../d8/d9/update_8c.html#a14">InternalInvalidate2</a>(
01098                     pwndParent,
01099                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>,
01100                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>,
01101                     &amp;rcParents,
01102                     RDW_VALIDATE | RDW_NOCHILDREN | <a class="code" href="../../d8/d9/update_8c.html#a5">RDW_IGNOREUPDATEDIRTY</a>);
01103         }
01104     }
01105 
01106     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01107 }
01108 
01109 <span class="comment">/***************************************************************************\</span>
01110 <span class="comment">* xxxUpdateWindow2</span>
01111 <span class="comment">*</span>
01112 <span class="comment">* Sends a WM_PAINT message to the window if it needs painting,</span>
01113 <span class="comment">* then sends the message to its children.</span>
01114 <span class="comment">*</span>
01115 <span class="comment">* Always returns TRUE.</span>
01116 <span class="comment">*</span>
01117 <span class="comment">* History:</span>
01118 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01119 <span class="comment">\***************************************************************************/</span>
01120 
<a name="l01121"></a><a class="code" href="../../d8/d9/update_8c.html#a17">01121</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d9/update_8c.html#a17">xxxUpdateWindow2</a>(
01122     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01123     DWORD flags)
01124 {
01125     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
01126 
01127     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01128 
01129     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd)) {
01130 
01131         <span class="comment">/*</span>
01132 <span class="comment">         * Punch a hole in our parent's update region, if we have one.</span>
01133 <span class="comment">         */</span>
01134         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>) {
01135             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/update_8c.html#a16">ValidateParents</a>(pwnd, flags &amp; <a class="code" href="../../d8/d9/update_8c.html#a1">UW_RECURSED</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01136                 <span class="keywordflow">return</span>;
01137             }
01138         }
01139 
01140         <span class="comment">/*</span>
01141 <span class="comment">         * Now that we're sending the message, clear the</span>
01142 <span class="comment">         * internal paint bit if it was previously set.</span>
01143 <span class="comment">         */</span>
01144         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>)) {
01145 
01146             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a563">WFINTERNALPAINT</a>);
01147 
01148             <span class="comment">/*</span>
01149 <span class="comment">             * If there is no update region, then no further paint messages</span>
01150 <span class="comment">             * are pending, so we must dec the paint count.</span>
01151 <span class="comment">             */</span>
01152             <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01153                 <a class="code" href="../../d4/d1/userk_8h.html#a1470">DecPaintCount</a>(pwnd);
01154         }
01155 
01156         <span class="comment">/*</span>
01157 <span class="comment">         * Set a flag indicating that a paint message was not processed</span>
01158 <span class="comment">         * (but should be).</span>
01159 <span class="comment">         */</span>
01160         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>);
01161 
01162         <span class="comment">/*</span>
01163 <span class="comment">         * Clear this bit, for apps (like MicroLink) that don't call</span>
01164 <span class="comment">         * BeginPaint or GetUpdateRect/Rgn (but DO call ValidateRect)</span>
01165 <span class="comment">         * when handling their WM_PAINT message.</span>
01166 <span class="comment">         */</span>
01167         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
01168 
01169         <span class="comment">/*</span>
01170 <span class="comment">         * BACKWARD COMPATIBILITY HACK</span>
01171 <span class="comment">         *</span>
01172 <span class="comment">         * Win 3.0 always sent WM_PAINTICON with wParam == TRUE for no good</span>
01173 <span class="comment">         * reason, and Lotus Notes has come to depend on this.</span>
01174 <span class="comment">         */</span>
01175         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>) &amp;&amp;
01176             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>)    &amp;&amp;
01177             (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;spicn != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01178 
01179             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_PAINTICON, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01180 
01181         } <span class="keywordflow">else</span> {
01182 
01183             <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwnd, WM_PAINT, 0, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01184         }
01185 
01186         <span class="comment">/*</span>
01187 <span class="comment">         * If the guy didn't call BeginPaint/EndPaint(), or GetUpdateRect/Rgn</span>
01188 <span class="comment">         * with fErase == TRUE, then we have to clean up for him here.</span>
01189 <span class="comment">         */</span>
01190         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a573">WFPAINTNOTPROCESSED</a>)) {
01191 
01192             RIPMSG0(RIP_VERBOSE,
01193                 <span class="stringliteral">"App didn't call BeginPaint() or GetUpdateRect/Rgn(fErase == TRUE) in WM_PAINT"</span>);
01194 
01195             <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(pwnd);
01196         }
01197     }
01198 
01199     <span class="comment">/*</span>
01200 <span class="comment">     * For desktop window, do not force the top level window repaint at this</span>
01201 <span class="comment">     * this point.  We are calling UpdateWindow() for the desktop before</span>
01202 <span class="comment">     * size/move is sent for the top level windows.</span>
01203 <span class="comment">     *</span>
01204 <span class="comment">     * BUG: The comment above seems a bit random.  Is there really a problem?</span>
01205 <span class="comment">     *      If nothing else this has to remain this way because it is</span>
01206 <span class="comment">     *      how Win 3.0 worked (neilk)</span>
01207 <span class="comment">     */</span>
01208     <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d8/d9/update_8c.html#a0">UW_ENUMCHILDREN</a>) &amp;&amp; (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd))) {
01209 
01210         <span class="comment">/*</span>
01211 <span class="comment">         * Update any children...</span>
01212 <span class="comment">         */</span>
01213         <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwnd);
01214         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
01215         <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01216 
01217             <span class="comment">/*</span>
01218 <span class="comment">             * If there is a transparent window that needs painting,</span>
01219 <span class="comment">             * skip it if another window below it needs to paint.</span>
01220 <span class="comment">             */</span>
01221             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwnd)) {
01222 
01223                 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT = pwnd;
01224 
01225                 <span class="keywordflow">while</span> ((pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01226                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwndT))
01227                         <span class="keywordflow">break</span>;
01228                 }
01229 
01230                 <span class="keywordflow">if</span> (pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01231                     pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01232                     <span class="keywordflow">continue</span>;
01233                 }
01234             }
01235 
01236             <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwnd, &amp;tlpwnd);
01237             <a class="code" href="../../d8/d9/update_8c.html#a17">xxxUpdateWindow2</a>(pwnd, flags | <a class="code" href="../../d8/d9/update_8c.html#a1">UW_RECURSED</a>);
01238             pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
01239         }
01240 
01241         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
01242     }
01243 
01244     <span class="keywordflow">return</span>;
01245 }
01246 
01247 <span class="comment">/***************************************************************************\</span>
01248 <span class="comment">* xxxInternalUpdateWindow</span>
01249 <span class="comment">*</span>
01250 <span class="comment">* Sends a WM_PAINT message to the window if it needs painting,</span>
01251 <span class="comment">* then sends the message to its children. Won't send WM_PAINT</span>
01252 <span class="comment">* if the window is transparent and has siblings that need</span>
01253 <span class="comment">* painting.</span>
01254 <span class="comment">*</span>
01255 <span class="comment">* History:</span>
01256 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01257 <span class="comment">\***************************************************************************/</span>
01258 
<a name="l01259"></a><a class="code" href="../../d8/d9/update_8c.html#a18">01259</a> <span class="keywordtype">void</span> <a class="code" href="../../d8/d9/update_8c.html#a18">xxxInternalUpdateWindow</a>(
01260     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01261     DWORD flags)
01262 {
01263     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01264 
01265     <span class="comment">/*</span>
01266 <span class="comment">     * If the passed-in window is transparent and a sibling below</span>
01267 <span class="comment">     * needs repainting, don't do anything.</span>
01268 <span class="comment">     */</span>
01269     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a617">WEFTRANSPARENT</a>)) {
01270 
01271         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwndT = pwnd;
01272         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
01273 
01274         <span class="keywordflow">while</span> ((pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01275 
01276             <span class="comment">/*</span>
01277 <span class="comment">             * Make sure sibling window belongs to same app.</span>
01278 <span class="comment">             */</span>
01279             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT) != ptiCurrent)
01280                 <span class="keywordflow">continue</span>;
01281 
01282             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a501">NEEDSPAINT</a>(pwndT))
01283                 <span class="keywordflow">return</span>;
01284         }
01285     }
01286 
01287     <span class="comment">/*</span>
01288 <span class="comment">     * Enumerate pwnd and all its children, sending WM_PAINTs as needed.</span>
01289 <span class="comment">     */</span>
01290     <a class="code" href="../../d8/d9/update_8c.html#a17">xxxUpdateWindow2</a>(pwnd, flags);
01291 }
01292 
01293 <span class="comment">/***************************************************************************\</span>
01294 <span class="comment">* xxxInternalInvalidate</span>
01295 <span class="comment">*</span>
01296 <span class="comment">* (In)validates hrgnUpdate and updates the window.</span>
01297 <span class="comment">*</span>
01298 <span class="comment">* History:</span>
01299 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01300 <span class="comment">\***************************************************************************/</span>
01301 
<a name="l01302"></a><a class="code" href="../../d4/d1/userk_8h.html#a1681">01302</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(
01303     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
01304     HRGN  hrgnUpdate,
01305     DWORD flags)
01306 {
01307     RECT rcParents;
01308     HRGN hrgnSubtract;
01309 
01310 <span class="preprocessor">#if DBG</span>
01311 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (flags &amp; (RDW_ERASENOW | RDW_UPDATENOW)) {
01312         <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01313     }
01314 <span class="preprocessor">#endif</span>
01315 <span class="preprocessor"></span>
01316     <span class="comment">/*</span>
01317 <span class="comment">     * Allow invalidation of a layered window when someone specifically</span>
01318 <span class="comment">     * invalidates it.  This will also prevent invalidation of layered</span>
01319 <span class="comment">     * windows during recursive desktop invalidations.</span>
01320 <span class="comment">     */</span>
01321     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd)) {
01322         flags |= RDW_INVALIDATELAYERS;
01323     }
01324 
01325     <span class="comment">/*</span>
01326 <span class="comment">     * Ensure that hrgnSubtract is a valid region: if it's NULLREGION,</span>
01327 <span class="comment">     * use the client region.</span>
01328 <span class="comment">     */</span>
01329     rcParents = (flags &amp; RDW_FRAME ? pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a> : pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>);
01330 
01331     <span class="keywordflow">if</span> (flags &amp; (RDW_VALIDATE | RDW_INVALIDATE)) {
01332 
01333         hrgnSubtract = hrgnUpdate;
01334 
01335         <span class="keywordflow">if</span> (hrgnSubtract == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01336 
01337             hrgnSubtract = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>;
01338             <a class="code" href="../../d3/d6/visrgn_8c.html#a18">CalcWindowRgn</a>(pwnd,
01339                           hrgnSubtract,
01340                           (flags &amp; RDW_FRAME) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01341         }
01342 
01343         <span class="comment">/*</span>
01344 <span class="comment">         * Calculate the bounding rectangle of our screen real estate,</span>
01345 <span class="comment">         * by intersecting with our parent rectangles.  While we're at</span>
01346 <span class="comment">         * it, check the visibility of ourself and our parents.</span>
01347 <span class="comment">         *</span>
01348 <span class="comment">         * If we're validating we want to skip this, since there</span>
01349 <span class="comment">         * are a number of cases where obscured windows may have</span>
01350 <span class="comment">         * update regions to be validated -- in particular, after</span>
01351 <span class="comment">         * a ScrollWindow() call where a child window was offset</span>
01352 <span class="comment">         * by OffsetChildren() to a new, obscured position.  Some of</span>
01353 <span class="comment">         * the 3.0 compatibility hacks also can lead to this situation.</span>
01354 <span class="comment">         */</span>
01355         <span class="keywordflow">if</span> ((flags &amp; RDW_INVALIDATE) &amp;&amp; !<a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwnd, &amp;rcParents))
01356             <span class="keywordflow">return</span>;
01357 
01358     } <span class="keywordflow">else</span> {
01359         <span class="comment">/*</span>
01360 <span class="comment">         * hrgnsubtract needs to be a real region even if</span>
01361 <span class="comment">         * we are not invalidating or validating.  It really doesn't</span>
01362 <span class="comment">         * matter what the region is, but we set it to null so the code</span>
01363 <span class="comment">         * has less degrees of freedom.</span>
01364 <span class="comment">         */</span>
01365         hrgnSubtract = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>;
01366         <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgnSubtract);
01367     }
01368 
01369     <span class="comment">/*</span>
01370 <span class="comment">     * If we're invalidating, and we're being called by the app,</span>
01371 <span class="comment">     * we need to invalidate any SPBs that might be affected by</span>
01372 <span class="comment">     * drawing in the client area of this window.</span>
01373 <span class="comment">     * We have to do this because there is no guarantee that the</span>
01374 <span class="comment">     * application will draw in an area that is invalidated</span>
01375 <span class="comment">     * (e.g., if the window is completely obscured by another).</span>
01376 <span class="comment">     */</span>
01377     <span class="keywordflow">if</span> (    (flags &amp; (RDW_INVALIDATE | RDW_REDRAWWINDOW)) == (RDW_INVALIDATE | RDW_REDRAWWINDOW) &amp;&amp;
01378             <a class="code" href="../../d4/d1/userk_8h.html#a417">AnySpbs</a>()) {
01379 
01380         RECT rcInvalid;
01381 
01382         <span class="comment">/*</span>
01383 <span class="comment">         * Intersect the parent's rect with the region bounds...</span>
01384 <span class="comment">         */</span>
01385         GreGetRgnBox(hrgnSubtract, &amp;rcInvalid);
01386         <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcInvalid, &amp;rcInvalid, &amp;rcParents);
01387         <a class="code" href="../../d4/d1/userk_8h.html#a1763">SpbCheckRect</a>(pwnd, &amp;rcInvalid, 0);
01388     }
01389 
01390     <span class="comment">/*</span>
01391 <span class="comment">     * Now go do the recursive update region calculations...</span>
01392 <span class="comment">     */</span>
01393     <a class="code" href="../../d8/d9/update_8c.html#a14">InternalInvalidate2</a>(pwnd, hrgnUpdate, hrgnSubtract, &amp;rcParents, flags);
01394 
01395     <span class="comment">/*</span>
01396 <span class="comment">     * Finally handle any needed drawing.</span>
01397 <span class="comment">     *</span>
01398 <span class="comment">     * (NOTE: RDW_UPDATENOW implies RDW_ERASENOW)</span>
01399 <span class="comment">     */</span>
01400     <span class="keywordflow">if</span> (flags &amp; RDW_UPDATENOW) {
01401 
01402         <a class="code" href="../../d8/d9/update_8c.html#a18">xxxInternalUpdateWindow</a>(pwnd,
01403                                 flags &amp; RDW_NOCHILDREN ? 0 : <a class="code" href="../../d8/d9/update_8c.html#a0">UW_ENUMCHILDREN</a>);
01404 
01405     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; RDW_ERASENOW) {
01406 
01407         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> flagsDSP;
01408 
01409         <span class="keywordflow">if</span> (flags &amp; RDW_NOCHILDREN) {
01410             flagsDSP = 0;
01411         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; RDW_ALLCHILDREN) {
01412             flagsDSP = <a class="code" href="../../d4/d1/userk_8h.html#a498">DSP_ALLCHILDREN</a>;
01413         } <span class="keywordflow">else</span> {
01414             flagsDSP = <a class="code" href="../../d4/d1/userk_8h.html#a495">DSP_ENUMCLIPPEDCHILDREN</a>;
01415         }
01416 
01417         <a class="code" href="../../d4/d1/userk_8h.html#a1041">xxxDoSyncPaint</a>(pwnd, flagsDSP);
01418     }
01419 }
01420 
01421 <span class="comment">/***************************************************************************\</span>
01422 <span class="comment">* UpdateWindow (API)</span>
01423 <span class="comment">*</span>
01424 <span class="comment">* Updates the window and all its children.</span>
01425 <span class="comment">*</span>
01426 <span class="comment">* History:</span>
01427 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01428 <span class="comment">\***************************************************************************/</span>
01429 
<a name="l01430"></a><a class="code" href="../../d4/d1/userk_8h.html#a1673">01430</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1673">xxxUpdateWindow</a>(
01431     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01432 {
01433     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01434 
01435     <a class="code" href="../../d8/d9/update_8c.html#a18">xxxInternalUpdateWindow</a>(pwnd, <a class="code" href="../../d8/d9/update_8c.html#a0">UW_ENUMCHILDREN</a>);
01436 
01437     <span class="comment">/*</span>
01438 <span class="comment">     * This function needs to return a value, since it is</span>
01439 <span class="comment">     * called through NtUserCallHwndLock.</span>
01440 <span class="comment">     */</span>
01441     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01442 }
01443 
01444 <span class="comment">/***************************************************************************\</span>
01445 <span class="comment">* ExcludeUpdateRgn (API)</span>
01446 <span class="comment">*</span>
01447 <span class="comment">* ENTRY:    hdc - DC to exclude from</span>
01448 <span class="comment">*           pwnd - window handle</span>
01449 <span class="comment">*</span>
01450 <span class="comment">* EXIT:     GDI region type</span>
01451 <span class="comment">*</span>
01452 <span class="comment">* WARNINGS: The DC is assumed to correspond to the client area of the window.</span>
01453 <span class="comment">*</span>
01454 <span class="comment">*           The map mode of hdc MUST be text mode (0, 0 is top left corner,</span>
01455 <span class="comment">*           one pixel per unit, ascending down and to right) or things won't</span>
01456 <span class="comment">*           work.</span>
01457 <span class="comment">*</span>
01458 <span class="comment">* History:</span>
01459 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01460 <span class="comment">\***************************************************************************/</span>
01461 
<a name="l01462"></a><a class="code" href="../../d4/d1/userk_8h.html#a1676">01462</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1676">_ExcludeUpdateRgn</a>(
01463     HDC  hdc,
01464     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
01465 {
01466     POINT pt;
01467 
01468     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01469 
01470         RECT rc;
01471 
01472         <span class="comment">/*</span>
01473 <span class="comment">         * Pass FALSE for fXForm since &amp;rc isn't used.</span>
01474 <span class="comment">         */</span>
01475         <span class="keywordflow">return</span> GreGetClipBox(hdc, &amp;rc, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01476 
01477     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01478 
01479         <span class="keywordflow">return</span> GreIntersectClipRect(hdc, 0, 0, 0, 0);
01480 
01481     } <span class="keywordflow">else</span> {
01482 
01483         <span class="comment">/*</span>
01484 <span class="comment">         * If no clip rgn exists, then subtract from a device-sized clip rgn.</span>
01485 <span class="comment">         * (GetClipRgn returns clip rgn in screen coordinates).</span>
01486 <span class="comment">         */</span>
01487         GreGetDCOrg(hdc, &amp;pt);
01488         <span class="keywordflow">if</span> (GreGetRandomRgn(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, 1) != 1) {
01489             <a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o15">hrgnScreen</a>);
01490         } <span class="keywordflow">else</span> {
01491 
01492             <span class="comment">/*</span>
01493 <span class="comment">             * Gets returned in dc coords - translate to screen.</span>
01494 <span class="comment">             */</span>
01495             GreOffsetRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, pt.x, pt.y);
01496         }
01497 
01498         <a class="code" href="../../d4/d1/userk_8h.html#a229">SubtractRgn</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
01499 
01500         <span class="comment">/*</span>
01501 <span class="comment">         * Map to dc coords before select</span>
01502 <span class="comment">         */</span>
01503         GreOffsetRgn(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, -pt.x, -pt.y);
01504 
01505         <span class="keywordflow">return</span> GreExtSelectClipRgn(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a190">ghrgnInv1</a>, RGN_COPY);
01506     }
01507 }
01508 
01509 <span class="comment">/***************************************************************************\</span>
01510 <span class="comment">* GetUpdateRect (API)</span>
01511 <span class="comment">*</span>
01512 <span class="comment">* Returns the bounding rectangle of the update region, or an empty rectangle</span>
01513 <span class="comment">* if there is no update region.  Rectangle is in client-relative coordinates.</span>
01514 <span class="comment">*</span>
01515 <span class="comment">* Returns TRUE if the update region is non-empty, FALSE if there is no</span>
01516 <span class="comment">* update region.</span>
01517 <span class="comment">*</span>
01518 <span class="comment">* lprc may be NULL to query whether or not an update region exists at all</span>
01519 <span class="comment">* or not.</span>
01520 <span class="comment">*</span>
01521 <span class="comment">* History:</span>
01522 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01523 <span class="comment">\***************************************************************************/</span>
01524 
<a name="l01525"></a><a class="code" href="../../d4/d1/userk_8h.html#a1674">01525</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1674">xxxGetUpdateRect</a>(
01526     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
01527     LPRECT lprc,
01528     BOOL   fErase)
01529 {
01530     RECT rc;
01531 
01532     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01533 
01534     <span class="keywordflow">if</span> (fErase)
01535         <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(pwnd);
01536 
01537     <span class="comment">/*</span>
01538 <span class="comment">     * The app is looking at the update region: okay to allow window</span>
01539 <span class="comment">     * validation.</span>
01540 <span class="comment">     */</span>
01541     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
01542 
01543     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01544 
01545         <span class="keywordflow">if</span> (lprc) {
01546             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(lprc);
01547         }
01548 
01549         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01550 
01551     } <span class="keywordflow">else</span> {
01552 
01553         <span class="comment">/*</span>
01554 <span class="comment">         * We must handle the case where a window has an update region,</span>
01555 <span class="comment">         * but it is completely obscured by its parents.  In this case, we</span>
01556 <span class="comment">         * must validate the window and all its children, and return FALSE.</span>
01557 <span class="comment">         *</span>
01558 <span class="comment">         * An OffsetChildren() call resulting from SetWindowPos() or</span>
01559 <span class="comment">         * ScrollWindowEx() will cause this to happen.  Update regions are</span>
01560 <span class="comment">         * just offset without checking their new positions to see if they</span>
01561 <span class="comment">         * are obscured by the parent(s).  This is too painful to check in</span>
01562 <span class="comment">         * those cases, so we instead handle it here.</span>
01563 <span class="comment">         *</span>
01564 <span class="comment">         * BeginPaint() handles this case correctly by returning an empty</span>
01565 <span class="comment">         * rectangle, so nothing special need be done there.</span>
01566 <span class="comment">         */</span>
01567         <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01568 
01569             rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
01570 
01571         } <span class="keywordflow">else</span> {
01572 
01573             <span class="keywordflow">switch</span> (GreGetRgnBox(pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>, &amp;rc)) {
01574             <span class="keywordflow">case</span> ERROR:
01575             <span class="keywordflow">case</span> NULLREGION:
01576                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rc);
01577                 <span class="keywordflow">break</span>;
01578 
01579             <span class="keywordflow">case</span> SIMPLEREGION:
01580             <span class="keywordflow">case</span> COMPLEXREGION:
01581                 <span class="keywordflow">break</span>;
01582             }
01583 
01584             <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rc, &amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>);
01585         }
01586 
01587         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwnd, &amp;rc)) {
01588 
01589             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01590                 <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
01591             }
01592 
01593             <span class="comment">/*</span>
01594 <span class="comment">             * If the window is CS_OWNDC, then we must map the returned</span>
01595 <span class="comment">             * rectangle with DPtoLP, to ensure that the rectangle is</span>
01596 <span class="comment">             * in the same coordinate system as the rectangle returned</span>
01597 <span class="comment">             * by BeginPaint().</span>
01598 <span class="comment">             *</span>
01599 <span class="comment">             * BUT ONLY IF hwnd-&gt;hrgnUpdate != HRGN_FULL! For true</span>
01600 <span class="comment">             * compatibility with 3.0.</span>
01601 <span class="comment">             */</span>
01602             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a474">CFOWNDC</a>) &amp;&amp;
01603                 (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a592">WFWIN31COMPAT</a>) || pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>)) {
01604 
01605                 <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
01606 
01607                 <span class="comment">/*</span>
01608 <span class="comment">                 * Look up this window's DC in the cache, and use it to</span>
01609 <span class="comment">                 * map the returned rectangle.</span>
01610 <span class="comment">                 */</span>
01611                 <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
01612 
01613                     <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o2">pwndOrg</a> == pwnd &amp;&amp; !(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_CACHE)) {
01614                         GreDPtoLP(pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o1">hdc</a>, (LPPOINT)&amp;rc, 2);
01615                         <span class="keywordflow">break</span>;
01616                     }
01617                 }
01618             }
01619 
01620         } <span class="keywordflow">else</span> {
01621            <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(&amp;rc);
01622         }
01623     }
01624 
01625     <span class="keywordflow">if</span> (lprc) {
01626 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01627 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
01628             MirrorRect(pwnd, &amp;rc);
01629         }
01630 <span class="preprocessor">#endif</span>
01631 <span class="preprocessor"></span>        *lprc = rc;
01632     }
01633 
01634     <span class="comment">/*</span>
01635 <span class="comment">     * If we're in the process a dragging a full window, mark the start</span>
01636 <span class="comment">     * of the application painting. This is to make sure that if the</span>
01637 <span class="comment">     * application calls DefWindowProc on the WM_PAINT after painting, we</span>
01638 <span class="comment">     * won't erase the newly painted areas. Visual Slick calls GetUpdateRect</span>
01639 <span class="comment">     * and then DefWindowProc.</span>
01640 <span class="comment">     * See other comments for xxxBeginPaint and xxxDWP_Paint.</span>
01641 <span class="comment">     * 8/3/94 johannec</span>
01642 <span class="comment">     *</span>
01643 <span class="comment">     * NOTE: This causes other problems in vslick where some controls</span>
01644 <span class="comment">     *       won't paint.  Since the app doesn't call BeginPaint/EndPaint</span>
01645 <span class="comment">     *       to truly set/clear the STARTPAINT flag, we do not clear this</span>
01646 <span class="comment">     *       bit. (6-27-1996 : ChrisWil).</span>
01647 <span class="comment">     *</span>
01648 <span class="comment">     *</span>
01649 <span class="comment">     *  if (TEST_PUDF(PUDF_DRAGGINGFULLWINDOW)) {</span>
01650 <span class="comment">     *      SetWF(pwnd, WFSTARTPAINT);</span>
01651 <span class="comment">     *  }</span>
01652 <span class="comment">     */</span>
01653 
01654     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01655 }
01656 
01657 <span class="comment">/***************************************************************************\</span>
01658 <span class="comment">* GetUpdateRgn (API)</span>
01659 <span class="comment">*</span>
01660 <span class="comment">*</span>
01661 <span class="comment">* History:</span>
01662 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01663 <span class="comment">\***************************************************************************/</span>
01664 
<a name="l01665"></a><a class="code" href="../../d4/d1/userk_8h.html#a1675">01665</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1675">xxxGetUpdateRgn</a>(
01666     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
01667     HRGN hrgn,
01668     BOOL fErase)
01669 {
01670     RECT rc;
01671     <span class="keywordtype">int</span>  code;
01672     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fNotEmpty;
01673 
01674 
01675     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
01676 
01677     <span class="keywordflow">if</span> (fErase)
01678         <a class="code" href="../../d4/d1/userk_8h.html#a1040">xxxSimpleDoSyncPaint</a>(pwnd);
01679 
01680     <span class="comment">/*</span>
01681 <span class="comment">     * The application is looking at the update region: okay to</span>
01682 <span class="comment">     * allow validation</span>
01683 <span class="comment">     */</span>
01684     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a564">WFUPDATEDIRTY</a>);
01685 
01686     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01687         <span class="keywordflow">goto</span> ReturnEmpty;
01688 
01689     rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>;
01690     fNotEmpty = <a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(pwnd, &amp;rc);
01691 
01692     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
01693 
01694         <span class="comment">/*</span>
01695 <span class="comment">         * Since the update region may be larger than the window</span>
01696 <span class="comment">         * rectangle, intersect it with the window rectangle.</span>
01697 <span class="comment">         */</span>
01698         <span class="keywordflow">if</span> (!fNotEmpty)
01699             <span class="keywordflow">goto</span> ReturnEmpty;
01700 
01701         code = SIMPLEREGION;
01702 
01703         <span class="comment">/*</span>
01704 <span class="comment">         * Normalize the rectangle\region relative to the unclipped window</span>
01705 <span class="comment">         */</span>
01706         <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01707             <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
01708         }
01709 
01710         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(hrgn, &amp;rc);
01711 
01712     } <span class="keywordflow">else</span> {
01713 
01714         <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, &amp;rc);
01715         code = <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgn, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a191">ghrgnInv2</a>, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>);
01716 
01717         <span class="keywordflow">switch</span> (code) {
01718         <span class="keywordflow">case</span> NULLREGION:
01719         <span class="keywordflow">case</span> ERROR:
01720             <span class="keywordflow">goto</span> ReturnEmpty;
01721 
01722         <span class="keywordflow">default</span>:
01723             <span class="keywordflow">if</span> (pwnd != <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
01724                 GreOffsetRgn(hrgn, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top);
01725             }
01726             <span class="keywordflow">break</span>;
01727         }
01728     }
01729     
01730 <span class="preprocessor">#ifdef USE_MIRRORING</span>
01731 <span class="preprocessor"></span>    MirrorRegion(pwnd, hrgn, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01732 <span class="preprocessor">#endif</span>
01733 <span class="preprocessor"></span>    <span class="comment">/*</span>
01734 <span class="comment">     * If we're in the process a dragging a full window, mark the start</span>
01735 <span class="comment">     * of the application painting. This is to make sure that if the</span>
01736 <span class="comment">     * application calls DefWindowProc on the WM_PAINT after painting, we</span>
01737 <span class="comment">     * won't erase the newly painted areas.</span>
01738 <span class="comment">     * See other comments for xxxBeginPaint and xxxDWP_Paint.</span>
01739 <span class="comment">     * 8/3/94 johannec</span>
01740 <span class="comment">     *</span>
01741 <span class="comment">     * NOTE: This causes other problems in vslick where some controls</span>
01742 <span class="comment">     *       won't paint.  Since the app doesn't call BeginPaint/EndPaint</span>
01743 <span class="comment">     *       to truly set/clear the STARTPAINT flag, we do not clear this</span>
01744 <span class="comment">     *       bit. (6-27-1996 : ChrisWil).</span>
01745 <span class="comment">     *</span>
01746 <span class="comment">     *  if (TEST(PUDF(PUDF_DRAGGINGFULLWINDOW)) {</span>
01747 <span class="comment">     *      SetWF(pwnd, WFSTARTPAINT);</span>
01748 <span class="comment">     *  }</span>
01749 <span class="comment">     */</span>
01750 
01751     <span class="keywordflow">return</span> code;
01752 
01753 ReturnEmpty:
01754     <a class="code" href="../../d3/d6/visrgn_8c.html#a12">SetEmptyRgn</a>(hrgn);
01755     <span class="keywordflow">return</span> NULLREGION;
01756 }
01757 
01758 <span class="comment">/***************************************************************************\</span>
01759 <span class="comment">* IntersectWithParents</span>
01760 <span class="comment">*</span>
01761 <span class="comment">* This routine calculates the intersection of a rectangle with the client</span>
01762 <span class="comment">* rectangles of all of pwnd's parents.  Returns FALSE if the intersection</span>
01763 <span class="comment">* is empty, a window is invisible, or a parent is minimized.</span>
01764 <span class="comment">*</span>
01765 <span class="comment">* Stop the intesesection if the window itself or any of its parents are</span>
01766 <span class="comment">* layered windows, so we always have a complete bitmap of them.</span>
01767 <span class="comment">*</span>
01768 <span class="comment">* History:</span>
01769 <span class="comment">* 16-Jul-1991 DarrinM   Ported from Win 3.1 sources.</span>
01770 <span class="comment">\***************************************************************************/</span>
01771 
<a name="l01772"></a><a class="code" href="../../d4/d1/userk_8h.html#a1680">01772</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1680">IntersectWithParents</a>(
01773     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>   pwnd,
01774     LPRECT lprc)
01775 {
01776     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd))
01777         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01778 
01779     <span class="keywordflow">while</span> ((pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01780 
01781         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a652">WFVISIBLE</a>) || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a653">WFMINIMIZED</a>))
01782             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01783 
01784         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(lprc, lprc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>))
01785             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01786 
01787         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1991">FLayeredOrRedirected</a>(pwnd))
01788             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01789     }
01790 
01791     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01792 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
