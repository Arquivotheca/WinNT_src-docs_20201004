<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hashirp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hashirp.h File Reference</h1>
<p>
<a href="../../d0/d8/hashirp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a0">IRP_TRACKING_HASH_SIZE</a>&nbsp;&nbsp;&nbsp;256</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a1">IRP_TRACKING_HASH_PRIME</a>&nbsp;&nbsp;&nbsp;131</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d8/hashirp_8h.html#a21">_IOV_REFERENCE_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a21">_IOV_REFERENCE_TYPE</a> { <a class="el" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a> =  0, 
<a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a6">IovpTrackingDataInit</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a9">IovpTrackingDataFree</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a10">IovpTrackingDataFindPointer</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, OUT PLIST_ENTRY *HashHead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IrpTrackingData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovPacket, IN <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a> IovRefType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovPacket, IN <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a> IovRefType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a15">IovpWatermarkIrp</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovPacket)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a> OPTIONAL, IN BOOLEAN Permanent)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a18">IovpProtectedIrpMakeTouchable</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN PVOID *RestoreHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a> OPTIONAL, IN PVOID *RestoreHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a20">IovpProtectedIrpAllocate</a> (IN CCHAR StackSize, IN BOOLEAN ChargeQuota, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> QuotaThread OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d8/hashirp_8h.html#a2">IovpIrpTrackingSpewLevel</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="hashirp.h::IRP_TRACKING_HASH_PRIME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IRP_TRACKING_HASH_PRIME&nbsp;&nbsp;&nbsp;131          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00025">25</a> of file <a class="el" href="../../d0/d8/hashirp_8h-source.html">hashirp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">IovpTrackingDataFindPointer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="hashirp.h::IRP_TRACKING_HASH_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IRP_TRACKING_HASH_SIZE&nbsp;&nbsp;&nbsp;256          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00024">24</a> of file <a class="el" href="../../d0/d8/hashirp_8h-source.html">hashirp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">IovpTrackingDataFindPointer()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00089">IovpTrackingDataInit()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a3" doxytag="hashirp.h::IOV_REFERENCE_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d8/hashirp_8h.html#a21">_IOV_REFERENCE_TYPE</a>  <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a21" doxytag="hashirp.h::_IOV_REFERENCE_TYPE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d8/hashirp_8h.html#a21">_IOV_REFERENCE_TYPE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a21a4" doxytag="IOVREFTYPE_PACKET" ></a>IOVREFTYPE_PACKET</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a21a5" doxytag="IOVREFTYPE_POINTER" ></a>IOVREFTYPE_POINTER</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00031">31</a> of file <a class="el" href="../../d0/d8/hashirp_8h-source.html">hashirp.h</a>.
<p>
<pre class="fragment"><div>00031                                  {
00032 
00033     <a class="code" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a> = 0,
00034     <a class="code" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>
00035 
00036 } <a class="code" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a20" doxytag="hashirp.h::IovpProtectedIrpAllocate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> FASTCALL IovpProtectedIrpAllocate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN CCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>StackSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ChargeQuota</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> QuotaThread&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00686">686</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d1/ex_2pool_8c-source.html#l00993">ExAllocatePoolWithTagPriority()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a330a195">HighPoolPrioritySpecialPoolOverrun</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04269">IoSizeOfIrp</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00026">POOL_TAG_PROTECTED_IRP</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>, and <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>.
<p>
<pre class="fragment"><div>00693              :
00694 
00695     This routine allocates an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00696     <span class="stringliteral">"replacement IRP"</span> tag.
00697 
00698   Arguments:
00699 
00700      StackSize   - Number of stack locations to give <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
00701 
00702      ChargeQuota - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff quota should be charged against QuotaThread
00703 
00704      QuotaThread - See above
00705 
00706   Return Value:
00707 
00708      Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory allocated.
00709 
00710 --*/
00711 {
00712     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> pSurrogateIrp;
00713     ULONG_PTR irpPtr;
00714     SIZE_T sizeOfAllocation;
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">// We are allocating an IRP from the special pool. Since IRPs may come from</span>
00718     <span class="comment">// lookaside lists they may be ULONG aligned. The memory manager on the</span>
00719     <span class="comment">// other hand gaurentees quad-aligned allocations. So to catch all special</span>
00720     <span class="comment">// pool overrun bugs we "skew" the IRP right up to the edge.</span>
00721     <span class="comment">//</span>
00722     sizeOfAllocation = <a class="code" href="../../d0/d5/io_8h.html#a245">IoSizeOfIrp</a>(StackSize);
00723 
00724     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((sizeOfAllocation % (<span class="keyword">sizeof</span>(ULONG))) == 0);
00725 
00726     <span class="comment">//</span>
00727     <span class="comment">// ADRIAO BUGBUG 08/16/98 - Use a quota'd alloc function if one is available</span>
00728     <span class="comment">// later...</span>
00729     <span class="comment">//</span>
00730     irpPtr = (ULONG_PTR) <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a>(
00731         NonPagedPool,
00732         sizeOfAllocation,
00733         POOL_TAG_PROTECTED_IRP,
00734         HighPoolPrioritySpecialPoolOverrun
00735         );
00736 
00737     pSurrogateIrp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) (irpPtr);
00738 
00739     <span class="keywordflow">return</span> pSurrogateIrp;
00740 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="hashirp.h::IovpProtectedIrpFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpProtectedIrpFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestoreHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00838">838</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>, and <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>.
<p>
<pre class="fragment"><div>00844              :
00845 
00846     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call stack has entirely unwound
00847     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> has completed. At <span class="keyword">this</span> point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no longer really
00848     useful to hold <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> around. As we are <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00849     special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> currently, <span class="keyword">this</span> routine needs to <span class="keywordflow">do</span> nothing.
00850 
00851   Arguments:
00852 
00853     IrpTrackingData        - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> tracking data.
00854 
00855   Return Value:
00856 
00857      None.
00858 --*/
00859 {
00860     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((*RestoreHandle) == NULL);
00861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="hashirp.h::IovpProtectedIrpMakeTouchable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpProtectedIrpMakeTouchable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestoreHandle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00807">807</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05228">MmProtectSpecialPool()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02872">IovpCancelIrp()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>.
<p>
<pre class="fragment"><div>00813              :
00814 
00815     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> touchable <span class="keywordflow">if</span> previously untouchable.
00816 
00817   Arguments:
00818 
00819     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>           - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to make untouchable
00820     RestoreHandle - Pointer to handle returned by <a class="code" href="../../d8/d8/hashirp_8c.html#a16">IovpProtectedIrpMakeUntouchable</a>
00821 
00822 
00823   Return Value:
00824 
00825      None.
00826 --*/
00827 {
00828     <span class="keywordflow">if</span> (*RestoreHandle) {
00829 
00830         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*RestoreHandle == Irp);
00831         <a class="code" href="../../d1/d6/allocpag_8c.html#a67">MmProtectSpecialPool</a>(Irp, PAGE_READWRITE) ;
00832         *RestoreHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00833     }
00834 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="hashirp.h::IovpProtectedIrpMakeUntouchable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID FASTCALL IovpProtectedIrpMakeUntouchable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Permanent</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">744</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l05228">MmProtectSpecialPool()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>, and <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>.
<p>
<pre class="fragment"><div>00750              :
00751 
00752     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> untouchable. Currently, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00753     done by freeing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00754 
00755   Arguments:
00756 
00757     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>        - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to make untouchable
00758     Permanent  - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> iff <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> should not be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> touchable again
00759 
00760 
00761   Return Value:
00762 
00763      RestoreHandle to be passed to make <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> touchable again, or to free <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00764 
00765 --*/
00766 {
00767     ULONG howModified;
00768 
00769     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
00770         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00771     }
00772 
00773     <span class="keywordflow">if</span> (Permanent) {
00774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Irp) ;
00775         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00776     }
00777 
00778     howModified = (ULONG) <a class="code" href="../../d1/d6/allocpag_8c.html#a67">MmProtectSpecialPool</a>(Irp, PAGE_NOACCESS);
00779 
00780     <span class="keywordflow">switch</span>(howModified) {
00781 
00782         <span class="keywordflow">case</span> (ULONG) -1:
00783 
00784             <span class="comment">//</span>
00785             <span class="comment">// Didn't come from special pool.</span>
00786             <span class="comment">//</span>
00787             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00788 
00789         <span class="keywordflow">case</span> 0:
00790 
00791             <span class="comment">//</span>
00792             <span class="comment">// Can't comply with request, ref counts, etc hold down page.</span>
00793             <span class="comment">//</span>
00794             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795 
00796         <span class="keywordflow">default</span>:
00797 
00798             <span class="comment">//</span>
00799             <span class="comment">// Allocation has been successfully marked as untouchable.</span>
00800             <span class="comment">//</span>
00801             <span class="keywordflow">return</span> (PVOID) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00802     }
00803 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="hashirp.h::IovpTrackingDataAcquireLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataAcquireLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpTrackingData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01813">IovpCompleteRequest4()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01901">IovpCompleteRequest5()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="hashirp.h::IovpTrackingDataCreateAndLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL IovpTrackingDataCreateAndLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">122</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00194">_IOV_REQUEST_PACKET::CallerIrql</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00198">_IOV_REQUEST_PACKET::HashLink</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a98">IOV_REQUEST_PACKET</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a96">IOV_STACK_LOCATION</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">IovpTrackingDataFindPointer()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00217">_IOV_REQUEST_PACKET::LastLocation</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00196">_IOV_REQUEST_PACKET::PointerCount</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00025">POOL_TAG_TRACKING_DATA</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00216">_IOV_REQUEST_PACKET::PriorityBoost</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00206">_IOV_REQUEST_PACKET::RealIrpCompletionRoutine</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00208">_IOV_REQUEST_PACKET::RealIrpContext</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00207">_IOV_REQUEST_PACKET::RealIrpControl</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00195">_IOV_REQUEST_PACKET::ReferenceCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00218">_IOV_REQUEST_PACKET::RefTrackingCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00219">_IOV_REQUEST_PACKET::RestoreHandle</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00200">_IOV_REQUEST_PACKET::SessionHead</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00202">_IOV_REQUEST_PACKET::StackCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00199">_IOV_REQUEST_PACKET::SurrogateLink</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00214">_IOV_REQUEST_PACKET::TopStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">IovpAllocateIrp2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, and <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>.
<p>
<pre class="fragment"><div>00127              :
00128 
00129     This routine creates a tracking packet <span class="keywordflow">for</span> a <span class="keyword">new</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>. The <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> does not get
00130     an initial reference count however. <a class="code" href="../../d8/d8/hashirp_8c.html#a11">IovpTrackingDataReleaseLock</a> must be
00131     called to drop <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock.
00132 
00133   Arguments:
00134 
00135     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to begin tracking.
00136 
00137   Return Value:
00138 
00139     iovPacket block, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no memory.
00140 
00141 --*/
00142 {
00143     KIRQL oldIrql;
00144     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
00145     PLIST_ENTRY hashHead;
00146     ULONG trackingDataSize;
00147     LONG newCount;
00148 
00149     ExAcquireSpinLock( &amp;IovpIrpHashLock, &amp;oldIrql );
00150 
00151     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a10">IovpTrackingDataFindPointer</a>(Irp, &amp;hashHead) ;
00152 
00153     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!iovPacket) ;
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// One extra stack location is allocated as the "zero'th" is used to</span>
00157     <span class="comment">// simplify some logic...</span>
00158     <span class="comment">//</span>
00159     trackingDataSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>)+<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>) ;
00160 
00161     iovPacket = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00162         NonPagedPool,
00163         trackingDataSize,
00164         POOL_TAG_TRACKING_DATA
00165         );
00166 
00167     <span class="keywordflow">if</span> (!iovPacket) {
00168 
00169         ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00170         <span class="keywordflow">return</span> iovPacket;
00171     }
00172 
00173     <span class="comment">//RtlZeroMemory(iovPacket, trackingDataSize) ;</span>
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">// From top to bottom, initialize the fields. Note that there is not a</span>
00177     <span class="comment">// "surrogateHead". If any code needs to find out the first entry in the</span>
00178     <span class="comment">// circularly linked list of IRPs (the first is the only non-surrogate IRP),</span>
00179     <span class="comment">// then HeadPacket should be used. Note that the link to the session is</span>
00180     <span class="comment">// stored by the headPacket, more on this later.</span>
00181     <span class="comment">//</span>
00182     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00183     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a> );
00184     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> = 1;
00185     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a> = 0;
00186     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> = 0;
00187     InitializeListHead(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o6">HashLink</a>);
00188     InitializeListHead(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>);
00189     InitializeListHead(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o8">SessionHead</a>);
00190     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a> = iovPacket;
00191     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o10">StackCount</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>;
00192     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a> = <a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>;
00193     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o12">RealIrpCompletionRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00194     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o13">RealIrpControl</a> = 0;
00195     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o14">RealIrpContext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00196     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> = 0;
00197     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o17">PriorityBoost</a> = 0;
00198     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> = 0;
00199     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o19">RefTrackingCount</a> =0;
00200     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o20">RestoreHandle</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00201     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Place into hash table under lock (with the initial reference count)</span>
00205     <span class="comment">//</span>
00206     InsertHeadList(hashHead, &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o6">HashLink</a>);
00207 
00208     ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00209 
00210     ExAcquireSpinLock( &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>, &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> );
00211 
00212     newCount = InterlockedDecrement(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a>);
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// If this assert gets hit it means somebody got hold of tracking data</span>
00216     <span class="comment">// at a very odd (and probably buggy) time. Actually, this might happen</span>
00217     <span class="comment">// if an IRP was cancelled right as it entered IoCallDriver...</span>
00218     <span class="comment">//</span>
00219     <span class="comment">//ASSERT(newCount == 0);</span>
00220 
00221     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00222         <span class="stringliteral">"  VRP CREATE(%x)-&gt;%x\n"</span>,
00223         Irp,
00224         iovPacket
00225         ), 3) ;
00226 
00227     <span class="keywordflow">return</span> iovPacket ;
00228 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="hashirp.h::IovpTrackingDataDereference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataDereference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovRefType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">612</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">IovpSessionDataDereference()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00616 {
00617     KIRQL oldIrql;
00618 
00619     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;IovPacket-&gt;IrpLock);
00620     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;ReferenceCount &gt; 0);
00621 
00622     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00623         <span class="stringliteral">"  VRP DEREF(%x) %x--\n"</span>,
00624         IovPacket,
00625         IovPacket-&gt;ReferenceCount
00626         ), 3) ;
00627 
00628     <span class="keywordflow">if</span> (IovRefType == <a class="code" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>) {
00629 
00630         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;PointerCount &gt; 0);
00631 
00632         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00633             <span class="stringliteral">"  VRP DEREF2(%x) %x--\n"</span>,
00634             IovPacket,
00635             IovPacket-&gt;PointerCount
00636             ), 3) ;
00637 
00638         IovPacket-&gt;PointerCount--;
00639 
00640         <span class="keywordflow">if</span> (IovPacket-&gt;PointerCount == 0) {
00641 
00642             ExAcquireSpinLock( &amp;IovpIrpHashLock, &amp;oldIrql );
00643 
00644             IovPacket-&gt;TrackedIrp-&gt;Flags &amp;=~ IRPFLAG_EXAMINE_MASK;
00645             IovPacket-&gt;TrackedIrp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00646 
00647             ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00648         }
00649     }
00650     InterlockedDecrement(&amp;IovPacket-&gt;ReferenceCount);
00651 
00652     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;ReferenceCount &gt;= IovPacket-&gt;PointerCount);
00653 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="hashirp.h::IovpTrackingDataFindAndLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL IovpTrackingDataFindAndLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Irp</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">276</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00194">_IOV_REQUEST_PACKET::CallerIrql</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">IovpTrackingDataFindPointer()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00195">_IOV_REQUEST_PACKET::ReferenceCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02872">IovpCancelIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01965">IovpCompleteRequestApc()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03268">IovpInitializeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00865">IovpWatermarkIrp()</a>.
<p>
<pre class="fragment"><div>00281              :
00282 
00283     This routine will <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking data <span class="keywordflow">for</span> an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00284     being tracked without a surrogate or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking data <span class="keywordflow">for</span> with
00285     a surrogate <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> what was passed in.
00286 
00287   Arguments:
00288 
00289     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to find.
00290 
00291   Return Value:
00292 
00293     IovPacket block, iff above conditions are satified.
00294 
00295 --*/
00296 {
00297     KIRQL oldIrql ;
00298     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket ;
00299     PLIST_ENTRY listHead;
00300 
00301     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Irp) ;
00302     ExAcquireSpinLock( &amp;IovpIrpHashLock, &amp;oldIrql );
00303 
00304     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a10">IovpTrackingDataFindPointer</a>(Irp, &amp;listHead) ;
00305 
00306     <span class="keywordflow">if</span> (!iovPacket) {
00307 
00308         ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00309         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00310     }
00311 
00312     InterlockedIncrement(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a>);
00313 
00314     ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00315 
00316     <a class="code" href="../../d9/d8/hashirp_8h.html#a11">IovpTrackingDataAcquireLock</a>(iovPacket) ;
00317     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> = oldIrql;
00318 
00319     InterlockedDecrement(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a>);
00320 
00321     <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00322 
00323         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00324         <span class="comment">//</span>
00325         <span class="comment">// Someone IRP is being mishandled, we got in a race condition where</span>
00326         <span class="comment">// we got the packet but the pointer count decayed to zero. Therefore</span>
00327         <span class="comment">// we do not want this packet so we will return NULL after dropping</span>
00328         <span class="comment">// it's lock. This sort of thing really shouldn't happen ya know.</span>
00329         <span class="comment">//</span>
00330         <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
00331         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00332     }
00333 
00334     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00335         <span class="stringliteral">"  VRP FIND(%x)-&gt;%x\n"</span>,
00336         Irp,
00337         iovPacket
00338         ), 3) ;
00339 
00340     <span class="keywordflow">return</span> iovPacket;
00341 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="hashirp.h::IovpTrackingDataFindPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> FASTCALL IovpTrackingDataFindPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLIST_ENTRY *&nbsp;</td>
          <td class="mdname" nowrap> <em>HashHead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00345">345</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00037">IovpIrpTrackingTable</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00025">IRP_TRACKING_HASH_PRIME</a>, <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00024">IRP_TRACKING_HASH_SIZE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>.
<p>
<pre class="fragment"><div>00351              :
00352 
00353     This routine returns a pointer to a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> tracking data.
00354     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> meant to be called by other <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> in <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00355 
00356     N.B. The tracking lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00357 
00358   Arguments:
00359 
00360     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                        - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to locate in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking table.
00361 
00362     HashHead                   - If <span class="keywordflow">return</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-null, points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00363                                  list head that should be used to insert
00364                                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>.
00365 
00366   Return Value:
00367 
00368      IrpTrackingData iff found, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> otherwise.
00369 
00370 --*/
00371 {
00372     KIRQL oldIrql ;
00373     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket ;
00374     PLIST_ENTRY listEntry, listHead;
00375     UINT_PTR hash ;
00376 
00377     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;IovpIrpHashLock) ;
00378 
00379     hash = (((UINT_PTR) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)*<a class="code" href="../../d9/d8/hashirp_8h.html#a1">IRP_TRACKING_HASH_PRIME</a> ;
00380     hash %= <a class="code" href="../../d9/d8/hashirp_8h.html#a0">IRP_TRACKING_HASH_SIZE</a> ;
00381 
00382     *HashHead = listHead = <a class="code" href="../../d8/d8/hashirp_8c.html#a3">IovpIrpTrackingTable</a> + hash ;
00383 
00384     <span class="keywordflow">for</span>(listEntry = listHead;
00385         listEntry-&gt;Flink != listHead;
00386         listEntry = listEntry-&gt;Flink) {
00387 
00388         iovPacket = CONTAINING_RECORD(listEntry-&gt;Flink, <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>, HashLink);
00389 
00390         <span class="keywordflow">if</span> (iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> == <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>) {
00391 
00392             <span class="keywordflow">return</span> iovPacket;
00393         }
00394     }
00395 
00396     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
00397 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="hashirp.h::IovpTrackingDataFree" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataFree           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpTrackingData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00232">232</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00086">TRACKFLAG_REMOVED_FROM_TABLE</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>.
<p>
<pre class="fragment"><div>00237              :
00238 
00239     This routine free's <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking data. The tracking data should already
00240     have been removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table by a call to <a class="code" href="../../d8/d8/hashirp_8c.html#a11">IovpTrackingDataReleaseLock</a>
00241     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReferenceCount at 0.
00242 
00243   Arguments:
00244 
00245     IovPacket        - Tracking data to free.
00246 
00247   Return Value:
00248 
00249     Nope.
00250 
00251 --*/
00252 {
00253     <span class="comment">//</span>
00254     <span class="comment">// The list entry is inited to point back to itself when removed. The</span>
00255     <span class="comment">// pointer count should of course still be zero.</span>
00256     <span class="comment">//</span>
00257     IovPacket-&gt;Flags|=<a class="code" href="../../d9/d4/trackirp_8h.html#a40">TRACKFLAG_REMOVED_FROM_TABLE</a> ;
00258     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;IovPacket-&gt;HashLink)) ;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// with no reference counts...</span>
00262     <span class="comment">//</span>
00263     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IovPacket-&gt;ReferenceCount) ;
00264     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!IovPacket-&gt;PointerCount) ;
00265 
00266     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00267         <span class="stringliteral">"  VRP FREE(%x)x\n"</span>,
00268         IovPacket
00269         ), 3) ;
00270 
00271     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IovPacket) ;
00272 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="hashirp.h::IovpTrackingDataGetCurrentSessionData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> FASTCALL IovpTrackingDataGetCurrentSessionData           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IovPacket</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">657</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00070">TRACKFLAG_ACTIVE</a>.
<p>
Referenced by <a class="el" href="../../d8/d3/flunkirp_8c-source.html#l00433">IovpAssertIrpStackDownward()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">IovpSessionDataFinalizeSurrogate()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00660 {
00661     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;IovPacket-&gt;IrpLock);
00662     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;IovPacket-&gt;HeadPacket-&gt;IrpLock);
00663     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IovPacket-&gt;HeadPacket-&gt;pIovSessionData == NULL)||
00664            (IovPacket-&gt;Flags&amp;TRACKFLAG_ACTIVE)) ;
00665 
00666     <span class="keywordflow">return</span> IovPacket-&gt;HeadPacket-&gt;pIovSessionData;
00667 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hashirp.h::IovpTrackingDataInit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataInit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00089">89</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00037">IovpIrpTrackingTable</a>, <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00024">IRP_TRACKING_HASH_SIZE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00257">IovpInitIrpTracking()</a>.
<p>
<pre class="fragment"><div>00094              :
00095 
00096     This routine initializes all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> important structures we use to track
00097     IRPs through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hash tables.
00098 
00099   Arguments:
00100 
00101     None
00102 
00103   Return Value:
00104 
00105     None
00106 
00107 --*/
00108 {
00109     ULONG i;
00110 
00111     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00112 
00113     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;IovpIrpHashLock );
00114     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="../../d9/d8/hashirp_8h.html#a0">IRP_TRACKING_HASH_SIZE</a>; i++) {
00115 
00116         InitializeListHead(IovpIrpTrackingTable+i);
00117     }
00118 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="hashirp.h::IovpTrackingDataReference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataReference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovRefType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">584</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a3">IOV_REFERENCE_TYPE</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">IovpAllocateIrp2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>, and <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00190">IovpSessionDataReference()</a>.
<p>
<pre class="fragment"><div>00588 {
00589     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;IovPacket-&gt;IrpLock);
00590 
00591     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00592         <span class="stringliteral">"  VRP REF(%x) %x++\n"</span>,
00593         IovPacket,
00594         IovPacket-&gt;ReferenceCount
00595         ), 3) ;
00596 
00597     InterlockedIncrement(&amp;IovPacket-&gt;ReferenceCount);
00598     <span class="keywordflow">if</span> (IovRefType == <a class="code" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>) {
00599 
00600         <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00601             <span class="stringliteral">"  VRP REF2(%x) %x++\n"</span>,
00602             IovPacket,
00603             IovPacket-&gt;PointerCount
00604             ), 3) ;
00605 
00606         IovPacket-&gt;PointerCount++;
00607     }
00608 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="hashirp.h::IovpTrackingDataReleaseLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpTrackingDataReleaseLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpTrackingData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">454</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00194">_IOV_REQUEST_PACKET::CallerIrql</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00198">_IOV_REQUEST_PACKET::HashLink</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00038">IovpIrpHashLock</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00232">IovpTrackingDataFree()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00196">_IOV_REQUEST_PACKET::PointerCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00195">_IOV_REQUEST_PACKET::ReferenceCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00199">_IOV_REQUEST_PACKET::SurrogateLink</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03132">IovpAllocateIrp1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03216">IovpAllocateIrp2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02872">IovpCancelIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01267">IovpCompleteRequest1()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01693">IovpCompleteRequest3()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01813">IovpCompleteRequest4()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01901">IovpCompleteRequest5()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01965">IovpCompleteRequestApc()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02990">IovpFreeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03268">IovpInitializeIrp()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02499">IovpInternalCompleteAfterWait()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02555">IovpInternalDeferredCompletion()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, and <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00865">IovpWatermarkIrp()</a>.
<p>
<pre class="fragment"><div>00459              :
00460 
00461     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IRPs tracking data lock and adjusts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ref count
00462     as appropriate. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count drops to zero, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00463     freed.
00464 
00465   Arguments:
00466 
00467     IovPacket              - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> tracking data.
00468 
00469   Return Value:
00470 
00471      None.
00472 
00473 --*/
00474 {
00475     BOOLEAN freeTrackingData;
00476     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovCurPacket, iovHeadPacket, iovNextPacket;
00477     KIRQL oldIrql;
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">// Pass one, delink anyone from the tree who's leaving, and assert that</span>
00481     <span class="comment">// no surrogates are left after a freed one.</span>
00482     <span class="comment">//</span>
00483     iovCurPacket = iovHeadPacket = IovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00484     <span class="keywordflow">while</span>(1) {
00485 
00486         <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00487 
00488         iovNextPacket = CONTAINING_RECORD(
00489             iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Flink,
00490             <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00491             SurrogateLink
00492             );
00493 
00494         <span class="comment">//</span>
00495         <span class="comment">// PointerCount is always referenced under the IRP lock.</span>
00496         <span class="comment">//</span>
00497         <span class="keywordflow">if</span> (iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a> == 0) {
00498 
00499             ExAcquireSpinLock( &amp;IovpIrpHashLock, &amp;oldIrql );
00500 
00501             <span class="comment">//</span>
00502             <span class="comment">// This field may be examined only under the hash lock.</span>
00503             <span class="comment">//</span>
00504             <span class="keywordflow">if</span> (iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>) {
00505 
00506                 iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp;=~ IRPFLAG_EXAMINE_MASK;
00507                 iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00508             }
00509 
00510             ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00511         }
00512 
00513         <span class="comment">//</span>
00514         <span class="comment">// We now remove any entries that will be leaving from the hash table.</span>
00515         <span class="comment">// Note that the ReferenceCount may be incremented outside the IRP lock</span>
00516         <span class="comment">// (but under the hash lock) but ReferenceCount can never be dropped</span>
00517         <span class="comment">// outside of the IRP lock. Therefore for performance we check once</span>
00518         <span class="comment">// and then take the lock to prevent anyone finding it and incrementing</span>
00519         <span class="comment">// it.</span>
00520         <span class="comment">//</span>
00521 
00522         <span class="keywordflow">if</span> (iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> == 0) {
00523 
00524             ExAcquireSpinLock( &amp;IovpIrpHashLock, &amp;oldIrql );
00525 
00526             <span class="keywordflow">if</span> (iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> ==0) {
00527 
00528                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a> == 0);
00529                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> == NULL) ||
00530                        (iovCurPacket != iovHeadPacket));
00531                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((iovNextPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> == 0) ||
00532                        (iovNextPacket == iovHeadPacket));
00533 
00534                 RemoveEntryList(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o6">HashLink</a>);
00535 
00536                 InitializeListHead(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o6">HashLink</a>);
00537             }
00538             ExReleaseSpinLock( &amp;IovpIrpHashLock, oldIrql );
00539         }
00540 
00541         <span class="keywordflow">if</span> (iovCurPacket == IovPacket) {
00542 
00543             <span class="keywordflow">break</span>;
00544         }
00545 
00546         iovCurPacket = iovNextPacket;
00547     }
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Pass two, drop locks and free neccessary data.</span>
00551     <span class="comment">//</span>
00552     iovCurPacket = iovHeadPacket;
00553     <span class="keywordflow">while</span>(1) {
00554 
00555         freeTrackingData = IsListEmpty(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o6">HashLink</a>);
00556 
00557         iovNextPacket = CONTAINING_RECORD(
00558             iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Flink,
00559             <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00560             SurrogateLink
00561             );
00562 
00563         ExReleaseSpinLock(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>, iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a>) ;
00564 
00565         <span class="keywordflow">if</span> (freeTrackingData) {
00566 
00567             RemoveEntryList(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>);
00568             InitializeListHead(&amp;iovCurPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>);
00569 
00570             <a class="code" href="../../d9/d8/hashirp_8h.html#a9">IovpTrackingDataFree</a>(iovCurPacket) ;
00571         }
00572 
00573         <span class="keywordflow">if</span> (iovCurPacket == IovPacket) {
00574 
00575             <span class="keywordflow">break</span>;
00576         }
00577 
00578         iovCurPacket = iovNextPacket;
00579     }
00580 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="hashirp.h::IovpWatermarkIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpWatermarkIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00865">865</a> of file <a class="el" href="../../d9/d7/hashirp_8c-source.html">hashirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00276">IovpTrackingDataFindAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00454">IovpTrackingDataReleaseLock()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00111">IRP_BOGUS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00110">IRP_SYSTEM_RESTRICTED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00076">TRACKFLAG_BOGUS</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00080">TRACKFLAG_WATERMARKED</a>.
<p>
<pre class="fragment"><div>00869 {
00870     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket;
00871 
00872     iovPacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a7">IovpTrackingDataFindAndLock</a>(Irp);
00873 
00874     <span class="keywordflow">if</span> (iovPacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00875 
00876         <span class="keywordflow">return</span>;
00877     }
00878 
00879     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a58">IRP_SYSTEM_RESTRICTED</a>) {
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">// Note that calling this function is not in itself enough to get the</span>
00883         <span class="comment">// system to prevent drivers from sending restricted IRPs. Those IRPs to</span>
00884         <span class="comment">// be protected must also be added to IovpIsSystemRestrictedIrp in</span>
00885         <span class="comment">// flunkirp.c</span>
00886         <span class="comment">//</span>
00887         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a34">TRACKFLAG_WATERMARKED</a>;
00888     }
00889 
00890     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d9/d4/trackirp_8h.html#a59">IRP_BOGUS</a>) {
00891 
00892         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a30">TRACKFLAG_BOGUS</a>;
00893     }
00894 
00895     <a class="code" href="../../d9/d8/hashirp_8h.html#a12">IovpTrackingDataReleaseLock</a>(iovPacket);
00896 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a2" doxytag="hashirp.h::IovpIrpTrackingSpewLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d9/d8/hashirp_8h.html#a2">IovpIrpTrackingSpewLevel</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d8/hashirp_8h-source.html#l00029">29</a> of file <a class="el" href="../../d0/d8/hashirp_8h-source.html">hashirp.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:02 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
