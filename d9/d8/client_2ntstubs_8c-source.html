<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ntstubs.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ntstubs.c</h1><a href="../../d8/d9/client_2ntstubs_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: ntstubs.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* client side API stubs</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-19-95 JimA             Created.</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d7/d3/w32_2ntuser_2client_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a0">00015</a> <span class="preprocessor">#define CLIENTSIDE 1</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include &lt;dbt.h&gt;</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="../../d7/d9/ntsend_8h.html">ntsend.h</a>"</span>
00020 <span class="preprocessor">#include "cfgmgr32.h"</span>
00021 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/csrhlpr_8h.html">csrhlpr.h</a>"</span>
00022 
00023 <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a1">GetRemoteKeyboardLayout</a>(PWCHAR);
00024 
00025 WINUSERAPI
00026 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
00027 WINAPI
<a name="l00028"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a2">00028</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a2">SetSysColors</a>(
00029     <span class="keywordtype">int</span> cElements,
00030     CONST INT * lpaElements,
00031     CONST COLORREF * lpaRgbValues)
00032 {
00033 
00034     <span class="keywordflow">return</span> <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a229">NtUserSetSysColors</a>(cElements,
00035                               lpaElements,
00036                               lpaRgbValues,
00037                               <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a410">SSCF_NOTIFY</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a411">SSCF_FORCESOLIDCOLOR</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a412">SSCF_SETMAGICCOLORS</a>);
00038 }
00039 
00040 
<a name="l00041"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a3">00041</a> HWND <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a3">WOWFindWindow</a>(
00042     LPCSTR pClassName,
00043     LPCSTR pWindowName)
00044 {
00045     <span class="keywordflow">return</span> <a class="code" href="../../d6/d0/usercli_8h.html#a556">InternalFindWindowExA</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pClassName, pWindowName, <a class="code" href="../../d1/d0/inc_2user_8h.html#a188">FW_16BIT</a>);
00046 }
00047 
00048 
<a name="l00049"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a4">00049</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a4">UpdatePerUserSystemParameters</a>(
00050     HANDLE  hToken,
00051     BOOL    bUserLoggedOn)
00052 {
00053     WCHAR pwszKLID[KL_NAMELENGTH];
00054 
00055     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00056 
00057         <span class="comment">/*</span>
00058 <span class="comment">         * Initialize IME hotkeys before loading keyboard</span>
00059 <span class="comment">         * layouts.</span>
00060 <span class="comment">         */</span>
00061         <a class="code" href="../../d6/d0/usercli_8h.html#a788">CliImmInitializeHotKeys</a>(<a class="code" href="../../d8/d0/immstruc_8h.html#a30">ISHK_INITIALIZE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00062         <span class="comment">/*</span>
00063 <span class="comment">         * Load initial keyboard layout.</span>
00064 <span class="comment">         */</span>
00065         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a1">GetRemoteKeyboardLayout</a>(pwszKLID)) {
00066             <a class="code" href="../../d6/d0/usercli_8h.html#a603">GetActiveKeyboardName</a>(pwszKLID);
00067         }
00068 
00069         <a class="code" href="../../d6/d0/usercli_8h.html#a608">LoadKeyboardLayoutWorker</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwszKLID, KLF_ACTIVATE | KLF_RESET | KLF_SUBSTITUTE_OK, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00070 
00071         <span class="comment">/*</span>
00072 <span class="comment">         * Now load the remaining preload keyboard layouts.</span>
00073 <span class="comment">         */</span>
00074         <a class="code" href="../../d3/d8/client_8c.html#a147">LoadPreloadKeyboardLayouts</a>();
00075         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a119">NtUserUpdatePerUserSystemParameters</a>(hToken, bUserLoggedOn);
00076 
00077         <span class="comment">/*</span>
00078 <span class="comment">         * Cause the wallpaper to be changed.</span>
00079 <span class="comment">         */</span>
00080         <a class="code" href="../../d5/d9/cltxt_8h.html#a26">SystemParametersInfo</a>(SPI_SETDESKWALLPAPER, 0, 0, 0);
00081 
00082     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00083     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00084 }
00085 
<a name="l00086"></a><a class="code" href="../../d6/d0/usercli_8h.html#a410">00086</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d6/d0/usercli_8h.html#a410">Event</a>(
00087     <a class="code" href="../../d7/d4/structtagEVENT__PACKET.html">PEVENT_PACKET</a> pep)
00088 {
00089     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00090 
00091         <a class="code" href="../../d0/d4/ddemlcli_8h.html#a9">CheckDDECritOut</a>;
00092 
00093         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a122">NtUserEvent</a>(
00094                 <a class="code" href="../../d1/d8/w32_2ntuser_2kernel_2event_8c.html#a2">pep</a>);
00095 
00096     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00097     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
00098 }
00099 
<a name="l00100"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a6">00100</a> LONG <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a6">GetClassWOWWords</a>(
00101     HINSTANCE hInstance,
00102     LPCTSTR pString)
00103 {
00104     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strClassName;
00105     <a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a> pcls;
00106 
00107     <span class="comment">/*</span>
00108 <span class="comment">     * Make sure cleanup will work successfully</span>
00109 <span class="comment">     */</span>
00110     strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00111 
00112     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00113 
00114         <a class="code" href="../../d7/d9/ntsend_8h.html#a22">FIRSTCOPYLPSTRW</a>(&amp;strClassName, pString);
00115 
00116         pcls = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a124">NtUserGetWOWClass</a>(hInstance, strClassName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>);
00117 
00118         <span class="keywordflow">if</span> (pcls == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00119             <a class="code" href="../../d5/d8/crecv_8c.html#a8">MSGERRORCODE</a>(ERROR_CLASS_DOES_NOT_EXIST);
00120         }
00121 
00122         pcls = (<a class="code" href="../../d7/d0/structtagCLS.html">PCLS</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pcls - <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;ulClientDelta);
00123         retval = <a class="code" href="../../d6/d0/usercli_8h.html#a631">_GetClassData</a>(pcls, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, GCLP_WOWWORDS, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00124 
00125     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00126     <a class="code" href="../../d7/d9/ntsend_8h.html#a29">CLEANUPLPSTRW</a>(strClassName);
00127     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(LONG);
00128 }
00129 
00130 <span class="comment">/***************************************************************************\</span>
00131 <span class="comment">* InitTask</span>
00132 <span class="comment">*</span>
00133 <span class="comment">* Initialize a WOW task.  This is the first call a WOW thread makes to user.</span>
00134 <span class="comment">* NtUserInitTask returns NTSTATUS because if the thread fails to convert</span>
00135 <span class="comment">* to a GUI thread, STATUS_INVALID_SYSTEM_SERVICE is returned.</span>
00136 <span class="comment">*</span>
00137 <span class="comment">* 11-03-95 JimA         Modified to use NTSTATUS.</span>
00138 <span class="comment">\***************************************************************************/</span>
00139 
<a name="l00140"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a7">00140</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a7">InitTask</a>(
00141     UINT wVersion,
00142     DWORD dwAppCompatFlags,
00143     LPCSTR pszModName,
00144     LPCSTR pszBaseFileName,
00145     DWORD hTaskWow,
00146     DWORD dwHotkey,
00147     DWORD idTask,
00148     DWORD dwX,
00149     DWORD dwY,
00150     DWORD dwXSize,
00151     DWORD dwYSize)
00152 {
00153     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strModName;
00154     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strBaseFileName;
00155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00156 
00157     <span class="comment">/*</span>
00158 <span class="comment">     * Make sure cleanup will work successfully</span>
00159 <span class="comment">     */</span>
00160     strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00161     strBaseFileName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00162 
00163     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00164 
00165         <a class="code" href="../../d7/d9/ntsend_8h.html#a22">FIRSTCOPYLPSTRW</a>(&amp;strModName, pszModName);
00166         <a class="code" href="../../d7/d9/ntsend_8h.html#a15">COPYLPSTRW</a>(&amp;strBaseFileName, pszBaseFileName);
00167 
00168         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a126">NtUserInitTask</a>(
00169                 wVersion,
00170                 dwAppCompatFlags,
00171                 strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00172                 strBaseFileName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00173                 hTaskWow,
00174                 dwHotkey,
00175                 idTask,
00176                 dwX,
00177                 dwY,
00178                 dwXSize,
00179                 dwYSize);
00180         retval = (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS);
00181 
00182         <a class="code" href="../../d7/d9/ntsend_8h.html#a29">CLEANUPLPSTRW</a>(strModName);
00183         <a class="code" href="../../d7/d9/ntsend_8h.html#a29">CLEANUPLPSTRW</a>(strBaseFileName);
00184 
00185     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00186     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00187 }
00188 
<a name="l00189"></a><a class="code" href="../../d6/d0/usercli_8h.html#a629">00189</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a629">ConvertMemHandle</a>(
00190     HANDLE hData,
00191     UINT cbNULL)
00192 {
00193     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbData;
00194     LPBYTE lpData;
00195 
00196     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00197 
00198         <span class="keywordflow">if</span> (GlobalFlags(hData) == GMEM_INVALID_HANDLE) {
00199             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ConvertMemHandle hMem is not valid\n"</span>);
00200             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00201             }
00202 
00203         <span class="keywordflow">if</span> (!(cbData = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)GlobalSize(hData)))
00204             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00205 
00206         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>(hData, lpData);
00207         <span class="keywordflow">if</span> (lpData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00208             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00209         }
00210 
00211         <span class="comment">/*</span>
00212 <span class="comment">         * Make sure text formats are NULL terminated.</span>
00213 <span class="comment">         */</span>
00214         <span class="keywordflow">switch</span> (cbNULL) {
00215         <span class="keywordflow">case</span> 2:
00216             lpData[cbData - 2] = 0;
00217             <span class="comment">// FALL THROUGH</span>
00218         <span class="keywordflow">case</span> 1:
00219             lpData[cbData - 1] = 0;
00220         }
00221 
00222         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a132">NtUserConvertMemHandle</a>(lpData, cbData);
00223 
00224         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>(hData);
00225 
00226     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00227     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HANDLE);
00228 }
00229 
<a name="l00230"></a><a class="code" href="../../d6/d0/usercli_8h.html#a628">00230</a> HANDLE <a class="code" href="../../d6/d0/usercli_8h.html#a628">CreateLocalMemHandle</a>(
00231     HANDLE hMem)
00232 {
00233     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> cbData;
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00235 
00236     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00237 
00238         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a133">NtUserCreateLocalMemHandle</a>(hMem, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;cbData);
00239         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
00240             RIPMSG0(RIP_WARNING, <span class="stringliteral">"__CreateLocalMemHandle server returned failure\n"</span>);
00241             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00242         }
00243 
00244         <span class="keywordflow">if</span> (!(retval = (ULONG_PTR)GlobalAlloc(GMEM_FIXED, cbData)))
00245             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00246 
00247         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a133">NtUserCreateLocalMemHandle</a>(hMem, (LPBYTE)retval, cbData, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00248         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00249             RIPMSG0(RIP_WARNING, <span class="stringliteral">"__CreateLocalMemHandle server returned failure\n"</span>);
00250             <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>((HANDLE)retval);
00251             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00252         }
00253 
00254     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00255     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HANDLE);
00256 }
00257 
<a name="l00258"></a><a class="code" href="../../d6/d0/usercli_8h.html#a630">00258</a> HHOOK <a class="code" href="../../d6/d0/usercli_8h.html#a630">_SetWindowsHookEx</a>(
00259     HANDLE hmod,
00260     LPTSTR pszLib,
00261     DWORD idThread,
00262     <span class="keywordtype">int</span> nFilterType,
00263     PROC pfnFilterProc,
00264     DWORD dwFlags)
00265 {
00266     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strLib;
00267 
00268     <span class="comment">/*</span>
00269 <span class="comment">     * Make sure cleanup will work successfully</span>
00270 <span class="comment">     */</span>
00271     strLib.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00272 
00273     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00274 
00275         <a class="code" href="../../d7/d9/ntsend_8h.html#a40">FIRSTCOPYLPWSTROPT</a>(&amp;strLib, pszLib);
00276 
00277         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a134">NtUserSetWindowsHookEx</a>(
00278                 hmod,
00279                 strLib.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
00280                 idThread,
00281                 nFilterType,
00282                 pfnFilterProc,
00283                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00284 
00285     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00286     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strLib);
00287     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HHOOK);
00288 }
00289 
00290 <span class="comment">/***************************************************************************\</span>
00291 <span class="comment">* SetWinEventHook</span>
00292 <span class="comment">*</span>
00293 <span class="comment">* History:</span>
00294 <span class="comment">* 1996-09-23 IanJa Created</span>
00295 <span class="comment">\***************************************************************************/</span>
00296 WINUSERAPI
00297 HWINEVENTHOOK
00298 WINAPI
<a name="l00299"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a11">00299</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a11">SetWinEventHook</a>(
00300     DWORD        eventMin,
00301     DWORD        eventMax,
00302     HMODULE      hmodWinEventProc,   <span class="comment">// Must pass this if global!</span>
00303     WINEVENTPROC lpfnWinEventProc,
00304     DWORD        idProcess,          <span class="comment">// Can be zero; all processes</span>
00305     DWORD        idThread,           <span class="comment">// Can be zero; all threads</span>
00306     DWORD        dwFlags)
00307 {
00308     UNICODE_STRING str;
00309     PUNICODE_STRING pstr;
00310     WCHAR awchLib[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00311 
00312     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00313 
00314         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WINEVENT_INCONTEXT) &amp;&amp; (hmodWinEventProc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00315             <span class="comment">/*</span>
00316 <span class="comment">             * If we're passing an hmod, we need to grab the file name of the</span>
00317 <span class="comment">             * module while we're still on the client since module handles</span>
00318 <span class="comment">             * are NOT global.</span>
00319 <span class="comment">             */</span>
00320             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> cb;
00321             cb = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(WCHAR) * GetModuleFileNameW(hmodWinEventProc, awchLib, <span class="keyword">sizeof</span>(awchLib)/<span class="keyword">sizeof</span>(WCHAR)));
00322             <span class="keywordflow">if</span> (cb == 0) {
00323                 <span class="comment">/*</span>
00324 <span class="comment">                 * hmod is bogus - return NULL.</span>
00325 <span class="comment">                 */</span>
00326                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00327             }
00328             str.Buffer = awchLib;
00329             str.Length = cb - <span class="keyword">sizeof</span>(UNICODE_NULL);
00330             str.MaximumLength = cb;
00331             pstr = &amp;str;
00332         } <span class="keywordflow">else</span> {
00333             pstr = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00334         }
00335 
00336         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a135">NtUserSetWinEventHook</a>(
00337                 eventMin,
00338                 eventMax,
00339                 hmodWinEventProc,
00340                 pstr,
00341                 lpfnWinEventProc,
00342                 idProcess,
00343                 idThread,
00344                 <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
00345 
00346     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00347     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HWINEVENTHOOK);
00348 };
00349 
00350 
00351 WINUSERAPI
00352 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00353 WINAPI
<a name="l00354"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">00354</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a12">NotifyWinEvent</a>(
00355     DWORD dwEvent,
00356     HWND  hwnd,
00357     LONG  idObject,
00358     LONG  idChild)
00359 {
00360     <a class="code" href="../../d7/d9/ntsend_8h.html#a2">BEGINCALLVOID</a>()
00361 
00362     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>()) {
00363         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a137">NtUserNotifyWinEvent</a>(dwEvent, hwnd, idObject, idChild);
00364     }
00365 
00366     <a class="code" href="../../d7/d9/ntsend_8h.html#a4">ERRORTRAPVOID</a>();
00367     <a class="code" href="../../d7/d9/ntsend_8h.html#a6">ENDCALLVOID</a>();
00368 }
00369 
00370 
00371 <span class="comment">/***************************************************************************\</span>
00372 <span class="comment">* ThunkedMenuItemInfo</span>
00373 <span class="comment">*</span>
00374 <span class="comment">* History:</span>
00375 <span class="comment">*  07-22-96 GerardoB - Added header and Fixed up for 5.0</span>
00376 <span class="comment">\***************************************************************************/</span>
<a name="l00377"></a><a class="code" href="../../d6/d0/usercli_8h.html#a771">00377</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a771">ThunkedMenuItemInfo</a>(
00378     HMENU hMenu,
00379     UINT nPosition,
00380     BOOL fByPosition,
00381     BOOL fInsert,
00382     LPMENUITEMINFOW lpmii,
00383     BOOL fAnsi)
00384 {
00385     MENUITEMINFOW mii;
00386     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strItem;
00387 
00388     <span class="comment">/*</span>
00389 <span class="comment">     * Make sure cleanup will work successfully</span>
00390 <span class="comment">     */</span>
00391     strItem.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00392 
00393     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00394 
00395         <span class="comment">/*</span>
00396 <span class="comment">         *  Make a local copy so we can make changes</span>
00397 <span class="comment">         */</span>
00398         mii = *(LPMENUITEMINFO)(lpmii);
00399 
00400         strItem.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00401         <span class="keywordflow">if</span> (mii.fMask &amp; MIIM_BITMAP) {
00402             <span class="keywordflow">if</span> (((HBITMAP)LOWORD(HandleToUlong(mii.hbmpItem)) &lt; HBMMENU_MAX) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(mii.hbmpItem)) {
00403                 <span class="comment">/*</span>
00404 <span class="comment">                 *  Looks like the user was trying to insert one of the</span>
00405 <span class="comment">                 *  HBMMENU_* bitmaps, but stuffed some data in the HIWORD.</span>
00406 <span class="comment">                 *  We know the HIWORD data is invalid because the LOWORD</span>
00407 <span class="comment">                  *  handle is below the GDI minimum.</span>
00408 <span class="comment">                 */</span>
00409                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid HIWORD data (0x%04X) for HBMMENU_* bitmap."</span>, HIWORD(HandleToUlong(mii.hbmpItem)));
00410                 mii.hbmpItem = (HBITMAP)LOWORD(HandleToUlong(mii.hbmpItem));
00411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(mii.hbmpItem) &amp;&amp; (mii.hbmpItem &gt;= HBMMENU_MAX)) {
00412             <span class="comment">/*</span>
00413 <span class="comment">             * The app is passing a 16-bit GDI handle.  GDI handles this on the</span>
00414 <span class="comment">             * client-side, but not on the kernel side.  So convert it to 32-bits.</span>
00415 <span class="comment">             * This fixes bug 201493 in Macromedia Director.</span>
00416 <span class="comment">             */</span>
00417                 HBITMAP hbmNew = GdiFixUpHandle(mii.hbmpItem);
00418                 <span class="keywordflow">if</span> (hbmNew) {
00419                     RIPMSG2(RIP_WARNING, <span class="stringliteral">"Menu bitmap change, fix 16-bit bitmap handle %lx to %lx\n"</span>, mii.hbmpItem, hbmNew);
00420                     mii.hbmpItem = hbmNew;
00421                 }
00422             }
00423         }
00424 
00425         <span class="keywordflow">if</span> (mii.fMask &amp; MIIM_STRING){
00426             <span class="keywordflow">if</span> (fAnsi) {
00427                 <a class="code" href="../../d7/d9/ntsend_8h.html#a25">FIRSTCOPYLPSTROPTW</a>(&amp;strItem, mii.dwTypeData);
00428             } <span class="keywordflow">else</span> {
00429                 <a class="code" href="../../d7/d9/ntsend_8h.html#a40">FIRSTCOPYLPWSTROPT</a>(&amp;strItem, mii.dwTypeData);
00430             }
00431         }
00432 
00433         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a181">NtUserThunkedMenuItemInfo</a>(
00434                 hMenu,
00435                 nPosition,
00436                 fByPosition,
00437                 fInsert,
00438                 &amp;mii,
00439                 strItem.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>);
00440 
00441     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00442     <a class="code" href="../../d7/d9/ntsend_8h.html#a29">CLEANUPLPSTRW</a>(strItem);
00443     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00444 }
00445 
<a name="l00446"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a14">00446</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a14">DrawCaption</a>(
00447     HWND hwnd,
00448     HDC hdc,
00449     CONST RECT *lprc,
00450     UINT flags)
00451 {
00452     HDC hdcr;
00453     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00454 
00455         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/usercli_8h.html#a547">IsMetaFile</a>(hdc))
00456             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00457 
00458         hdcr = GdiConvertAndCheckDC(hdc);
00459         <span class="keywordflow">if</span> (hdcr == (HDC)0)
00460             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00461 
00462         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a187">NtUserDrawCaption</a>(hwnd, hdcr, lprc, flags);
00463 
00464     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00465     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00466 }
00467 
<a name="l00468"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a15">00468</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a15">GetAsyncKeyState</a>(
00469     <span class="keywordtype">int</span> vKey)
00470 {
00471     <a class="code" href="../../d7/d9/ntsend_8h.html#a0">BEGINCALLCONNECT</a>()
00472 
00473         <span class="comment">/*</span>
00474 <span class="comment">         * Asynchronous key state reports the PHYSICAL mouse button,</span>
00475 <span class="comment">         * regardless of whether the buttons have been swapped or not.</span>
00476 <span class="comment">         */</span>
00477         <span class="keywordflow">if</span> (((vKey == VK_RBUTTON) || (vKey == VK_LBUTTON)) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(SWAPBUTTON)) {
00478             vKey ^= (VK_RBUTTON ^ VK_LBUTTON);
00479         }
00480 
00481         <span class="comment">/*</span>
00482 <span class="comment">         * If this is one of the common keys, see if we can pull it out</span>
00483 <span class="comment">         * of the cache.</span>
00484 <span class="comment">         */</span>
00485         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)vKey &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a110">CVKASYNCKEYCACHE</a>) {
00486             <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00487             <span class="keywordflow">if</span> ((pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o17">dwAsyncKeyCache</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwAsyncKeyCache) &amp;&amp;
00488                 !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a834">TestKeyRecentDownBit</a>(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o19">afAsyncKeyStateRecentDown</a>, vKey)) {
00489 
00490                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a827">TestKeyDownBit</a>(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o18">afAsyncKeyState</a>, vKey))
00491                     retval = 0x8000;
00492                 <span class="keywordflow">else</span>
00493                     retval = 0;
00494 
00495                 <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)retval;
00496             }
00497         }
00498 
00499         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a189">NtUserGetAsyncKeyState</a>(
00500                 vKey);
00501 
00502     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00503     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>);
00504 }
00505 
<a name="l00506"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">00506</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a16">GetKeyState</a>(
00507     <span class="keywordtype">int</span> vKey)
00508 {
00509     <a class="code" href="../../d7/d9/ntsend_8h.html#a0">BEGINCALLCONNECT</a>()
00510 
00511         <span class="comment">/*</span>
00512 <span class="comment">         * If this is one of the common keys, see if we can pull it out</span>
00513 <span class="comment">         * of the cache.</span>
00514 <span class="comment">         */</span>
00515         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)vKey &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a108">CVKKEYCACHE</a>) {
00516             <a class="code" href="../../d2/d2/struct__CLIENTINFO.html">PCLIENTINFO</a> pci = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>();
00517             <span class="keywordflow">if</span> (pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o15">dwKeyCache</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;dwKeyCache) {
00518                 retval = 0;
00519                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a830">TestKeyToggleBit</a>(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o16">afKeyState</a>, vKey))
00520                     retval |= 0x0001;
00521                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a827">TestKeyDownBit</a>(pci-&gt;<a class="code" href="../../d2/d2/struct__CLIENTINFO.html#o16">afKeyState</a>, vKey)) {
00522                   <span class="comment">/*</span>
00523 <span class="comment">                   * Used to be retval |= 0x8000.Fix for bug 28820; Ctrl-Enter</span>
00524 <span class="comment">                   * accelerator doesn't work on Nestscape Navigator Mail 2.0</span>
00525 <span class="comment">                   */</span>
00526                     retval |= 0xff80;  <span class="comment">// This is what 3.1 returned!!!!</span>
00527                 }
00528 
00529                 <span class="keywordflow">return</span> (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)retval;
00530             }
00531         }
00532 
00533         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a327">NtUserGetKeyState</a>(
00534                 vKey);
00535 
00536     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00537     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>);
00538 }
00539 
<a name="l00540"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a17">00540</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a17">OpenClipboard</a>(
00541     HWND hwnd)
00542 {
00543     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fEmptyClient;
00544 
00545     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00546 
00547         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a212">NtUserOpenClipboard</a>(hwnd, &amp;fEmptyClient);
00548 
00549         <span class="keywordflow">if</span> (fEmptyClient)
00550             <a class="code" href="../../d3/d8/client_8c.html#a41">ClientEmptyClipboard</a>();
00551 
00552     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00553     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00554 }
00555 
<a name="l00556"></a><a class="code" href="../../d6/d0/usercli_8h.html#a621">00556</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a621">_PeekMessage</a>(
00557     LPMSG pmsg,
00558     HWND hwnd,
00559     UINT wMsgFilterMin,
00560     UINT wMsgFilterMax,
00561     UINT wRemoveMsg,
00562     BOOL bAnsi)
00563 {
00564     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00565 
00566         <span class="keywordflow">if</span> (bAnsi) {
00567             <span class="comment">//</span>
00568             <span class="comment">// If we have pushed message for DBCS messaging, we should pass this one</span>
00569             <span class="comment">// to Apps at first...</span>
00570             <span class="comment">//</span>
00571             <a class="code" href="../../d6/d0/usercli_8h.html#a293">GET_DBCS_MESSAGE_IF_EXIST</a>(
00572                 <a class="code" href="../../d5/d9/cltxt_8h.html#a14">PeekMessage</a>,pmsg,wMsgFilterMin,wMsgFilterMax,((wRemoveMsg &amp; PM_REMOVE) ? TRUE:FALSE));
00573         }
00574 
00575         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a213">NtUserPeekMessage</a>(
00576                 pmsg,
00577                 hwnd,
00578                 wMsgFilterMin,
00579                 wMsgFilterMax,
00580                 wRemoveMsg);
00581 
00582         <span class="keywordflow">if</span> (retval) {
00583             <span class="comment">// May have a bit more work to do if this MSG is for an ANSI app</span>
00584 
00585             <span class="keywordflow">if</span> (bAnsi) {
00586                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a>(pmsg-&gt;message, &amp;(pmsg-&gt;wParam))) {
00587                     WPARAM dwAnsi = pmsg-&gt;wParam;
00588                     <span class="comment">//</span>
00589                     <span class="comment">// Build DBCS-ware wParam. (for EM_SETPASSWORDCHAR...)</span>
00590                     <span class="comment">//</span>
00591                     <a class="code" href="../../d6/d0/usercli_8h.html#a296">BUILD_DBCS_MESSAGE_TO_CLIENTA_FROM_SERVER</a>(
00592                         pmsg,dwAnsi,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,((wRemoveMsg &amp; PM_REMOVE) ? TRUE:FALSE));
00593                 } <span class="keywordflow">else</span> {
00594                     retval = 0;
00595                 }
00596             } <span class="keywordflow">else</span> {
00597                <span class="comment">//</span>
00598                <span class="comment">// Only LOWORD of WPARAM is valid for WM_CHAR....</span>
00599                <span class="comment">// (Mask off DBCS messaging information.)</span>
00600                <span class="comment">//</span>
00601                <a class="code" href="../../d6/d0/usercli_8h.html#a297">BUILD_DBCS_MESSAGE_TO_CLIENTW_FROM_SERVER</a>(pmsg-&gt;message,pmsg-&gt;wParam);
00602             }
00603         }
00604 
00605 ExitPeekMessage:
00606 
00607     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00608     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00609 }
00610 
00611 
<a name="l00612"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a19">00612</a> LONG_PTR <a class="code" href="../../d6/d0/usercli_8h.html#a209">_SetWindowLongPtr</a>(
00613     HWND hwnd,
00614     <span class="keywordtype">int</span> nIndex,
00615     LONG_PTR dwNewLong,
00616     BOOL bAnsi)
00617 {
00618     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00619     LONG_PTR dwOldLong;
00620     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCPDType = 0;
00621 
00622     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00623 
00624     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00625         <span class="keywordflow">return</span> 0;
00626 
00627     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a567">WFDIALOGWINDOW</a>)) {
00628         <span class="keywordflow">switch</span> (nIndex) {
00629         <span class="keywordflow">case</span> DWLP_DLGPROC:    <span class="comment">// See similar case GWL_WNDPROC</span>
00630 
00631             <span class="comment">/*</span>
00632 <span class="comment">             * Hide the window proc from other processes</span>
00633 <span class="comment">             */</span>
00634             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd)) {
00635                 RIPERR1(ERROR_ACCESS_DENIED,
00636                         RIP_WARNING,
00637                         <span class="stringliteral">"Access denied to hwnd (%#lx) in _SetWindowLong"</span>,
00638                         hwnd);
00639 
00640                 <span class="keywordflow">return</span> 0;
00641             }
00642 
00643             <span class="comment">/*</span>
00644 <span class="comment">             * Get the old window proc address</span>
00645 <span class="comment">             */</span>
00646             dwOldLong = (LONG_PTR)<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;lpfnDlg;
00647 
00648             <span class="comment">/*</span>
00649 <span class="comment">             * We always store the actual address in the wndproc; We only</span>
00650 <span class="comment">             * give the CallProc handles to the application</span>
00651 <span class="comment">             */</span>
00652             UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwOldLong));
00653 
00654             <span class="comment">/*</span>
00655 <span class="comment">             * May need to return a CallProc handle if there is an</span>
00656 <span class="comment">             * Ansi/Unicode tranistion</span>
00657 <span class="comment">             */</span>
00658 
00659             <span class="keywordflow">if</span> (bAnsi != ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;flags &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a794">DLGF_ANSI</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00660                 dwCPDType |= bAnsi ? <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a459">CPD_ANSI_TO_UNICODE</a> : <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
00661             }
00662 
00663             <span class="comment">/*</span>
00664 <span class="comment">             * If we detected a transition create a CallProc handle for</span>
00665 <span class="comment">             * this type of transition and this wndproc (dwOldLong)</span>
00666 <span class="comment">             */</span>
00667             <span class="keywordflow">if</span> (dwCPDType) {
00668                 ULONG_PTR cpd;
00669 
00670                 cpd = <a class="code" href="../../d0/d5/ntuser_2kernel_2getset_8c.html#a7">GetCPD</a>(pwnd, dwCPDType | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a464">CPD_DIALOG</a>, dwOldLong);
00671 
00672                 <span class="keywordflow">if</span> (cpd) {
00673                     dwOldLong = cpd;
00674                 } <span class="keywordflow">else</span> {
00675                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetWindowLong (DWL_DLGPROC) unable to alloc CPD returning handle\n"</span>);
00676                 }
00677             }
00678 
00679             <span class="comment">/*</span>
00680 <span class="comment">             * Convert a possible CallProc Handle into a real address.</span>
00681 <span class="comment">             * The app may have kept the CallProc Handle from some</span>
00682 <span class="comment">             * previous mixed GetClassinfo or SetWindowLong.</span>
00683 <span class="comment">             *</span>
00684 <span class="comment">             * WARNING bAnsi is modified here to represent real type of</span>
00685 <span class="comment">             * proc rather than if SetWindowLongA or W was called</span>
00686 <span class="comment">             */</span>
00687             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a468">ISCPDTAG</a>(dwNewLong)) {
00688                 <a class="code" href="../../d3/d7/struct__CALLPROCDATA.html">PCALLPROCDATA</a> pCPD;
00689                 <span class="keywordflow">if</span> (pCPD = <a class="code" href="../../d6/d9/rtl_2wow_8c.html#a8">HMValidateHandleNoRip</a>((HANDLE)dwNewLong, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a243">TYPE_CALLPROC</a>)) {
00690                     dwNewLong = KERNEL_ULONG_PTR_TO_ULONG_PTR(pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o2">pfnClientPrevious</a>);
00691                     bAnsi = pCPD-&gt;<a class="code" href="../../d3/d7/struct__CALLPROCDATA.html#o3">wType</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a460">CPD_UNICODE_TO_ANSI</a>;
00692                 }
00693             }
00694 
00695             <span class="comment">/*</span>
00696 <span class="comment">             * If an app 'unsubclasses' a server-side window proc we need to</span>
00697 <span class="comment">             * restore everything so SendMessage and friends know that it's</span>
00698 <span class="comment">             * a server-side proc again.  Need to check against client side</span>
00699 <span class="comment">             * stub addresses.</span>
00700 <span class="comment">             */</span>
00701             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;lpfnDlg = (DLGPROC)dwNewLong;
00702             <span class="keywordflow">if</span> (bAnsi) {
00703                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;flags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a794">DLGF_ANSI</a>;
00704             } <span class="keywordflow">else</span> {
00705                 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a793">PDLG</a>(pwnd)-&gt;flags &amp;= ~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a794">DLGF_ANSI</a>;
00706             }
00707 
00708             <span class="keywordflow">return</span> dwOldLong;
00709 
00710         <span class="keywordflow">case</span> DWLP_USER:
00711 <span class="preprocessor">#ifdef BUILD_WOW6432</span>
00712 <span class="preprocessor"></span>            <span class="comment">// kernel has special handling of DWLP_USER</span>
00713             nIndex = <span class="keyword">sizeof</span>(KERNEL_LRESULT) + <span class="keyword">sizeof</span>(KERNEL_PVOID);
00714 <span class="preprocessor">#endif</span>
00715 <span class="preprocessor"></span>        <span class="keywordflow">case</span> DWLP_MSGRESULT:
00716             <span class="keywordflow">break</span>;
00717 
00718         <span class="keywordflow">default</span>:
00719             <span class="keywordflow">if</span> (nIndex &gt;= 0 &amp;&amp; nIndex &lt; DLGWINDOWEXTRA) {
00720                 RIPERR0(ERROR_PRIVATE_DIALOG_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00721                 <span class="keywordflow">return</span> 0;
00722             }
00723         }
00724     }
00725 
00726     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00727 
00728     <span class="comment">/*</span>
00729 <span class="comment">     * If this is a listbox window and the listbox structure has</span>
00730 <span class="comment">     * already been initialized, don't allow the app to override the</span>
00731 <span class="comment">     * owner draw styles. We need to do this since Windows only</span>
00732 <span class="comment">     * used the styles in creating the structure, but we also use</span>
00733 <span class="comment">     * them to determine if strings need to be thunked.</span>
00734 <span class="comment">     *</span>
00735 <span class="comment">     */</span>
00736 
00737     <span class="keywordflow">if</span> (nIndex == GWL_STYLE &amp;&amp;
00738         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a205">FNID_LISTBOX</a> &amp;&amp;
00739         ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwnd)-&gt;pLBIV != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00740         (!<a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a16">TestWindowProcess</a>(pwnd) || ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwnd)-&gt;pLBIV-&gt;fInitialized)) {
00741 
00742 <span class="preprocessor">#if DBG</span>
00743 <span class="preprocessor"></span>        LONG_PTR dwDebugLong = dwNewLong;
00744 <span class="preprocessor">#endif</span>
00745 <span class="preprocessor"></span>
00746         dwNewLong &amp;= ~(LBS_OWNERDRAWFIXED |
00747                        LBS_OWNERDRAWVARIABLE |
00748                        LBS_HASSTRINGS);
00749 
00750         dwNewLong |= pwnd-&gt;style &amp; (LBS_OWNERDRAWFIXED |
00751                                     LBS_OWNERDRAWVARIABLE |
00752                                     LBS_HASSTRINGS);
00753 
00754 <span class="preprocessor">#if DBG</span>
00755 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwDebugLong != dwNewLong) {
00756            RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetWindowLong can't change LBS_OWNERDRAW* or LBS_HASSTRINGS."</span>);
00757         }
00758 <span class="preprocessor">#endif</span>
00759 <span class="preprocessor"></span>    }
00760 
00761 
00762         retval = (ULONG_PTR)<a class="code" href="../../d0/d0/ntuser_8h.html#a3">NtUserSetWindowLongPtr</a>(
00763                 hwnd,
00764                 nIndex,
00765                 dwNewLong,
00766                 bAnsi);
00767 
00768     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00769     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(LONG_PTR);
00770 }
00771 
00772 <span class="preprocessor">#ifdef _WIN64</span>
00773 <span class="preprocessor"></span>LONG <a class="code" href="../../d6/d0/usercli_8h.html#a620">_SetWindowLong</a>(
00774     HWND hwnd,
00775     <span class="keywordtype">int</span> nIndex,
00776     LONG dwNewLong,
00777     BOOL bAnsi)
00778 {
00779     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00780 
00781     pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
00782 
00783     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00784         <span class="keywordflow">return</span> 0;
00785 
00786     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDIALOGWINDOW)) {
00787         <span class="keywordflow">switch</span> (nIndex) {
00788         <span class="keywordflow">case</span> DWLP_DLGPROC:    <span class="comment">// See similar case GWLP_WNDPROC</span>
00789             RIPERR1(ERROR_INVALID_INDEX, RIP_WARNING, <span class="stringliteral">"SetWindowLong: invalid index %d"</span>, nIndex);
00790             <span class="keywordflow">return</span> 0;
00791 
00792         <span class="keywordflow">case</span> DWLP_MSGRESULT:
00793         <span class="keywordflow">case</span> DWLP_USER:
00794             <span class="keywordflow">break</span>;
00795 
00796         <span class="keywordflow">default</span>:
00797             <span class="keywordflow">if</span> (nIndex &gt;= 0 &amp;&amp; nIndex &lt; DLGWINDOWEXTRA) {
00798                 RIPERR0(ERROR_PRIVATE_DIALOG_INDEX, RIP_VERBOSE, <span class="stringliteral">""</span>);
00799                 <span class="keywordflow">return</span> 0;
00800             }
00801         }
00802     }
00803 
00804     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00805 
00806     <span class="comment">/*</span>
00807 <span class="comment">     * If this is a listbox window and the listbox structure has</span>
00808 <span class="comment">     * already been initialized, don't allow the app to override the</span>
00809 <span class="comment">     * owner draw styles. We need to do this since Windows only</span>
00810 <span class="comment">     * used the styles in creating the structure, but we also use</span>
00811 <span class="comment">     * them to determine if strings need to be thunked.</span>
00812 <span class="comment">     *</span>
00813 <span class="comment">     */</span>
00814 
00815     if (nIndex == GWL_STYLE &amp;&amp;
00816         GETFNID(pwnd) == FNID_LISTBOX &amp;&amp;
00817         ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwnd)-&gt;pLBIV != NULL &amp;&amp;
00818         (!TestWindowProcess(pwnd) || ((<a class="code" href="../../d9/d9/structtagLBWND.html">PLBWND</a>)pwnd)-&gt;pLBIV-&gt;fInitialized)) {
00819 
00820 <span class="preprocessor">#if DBG</span>
00821 <span class="preprocessor"></span>        LONG dwDebugLong = dwNewLong;
00822 <span class="preprocessor">#endif</span>
00823 <span class="preprocessor"></span>
00824         dwNewLong &amp;= ~(LBS_OWNERDRAWFIXED |
00825                        LBS_OWNERDRAWVARIABLE |
00826                        LBS_HASSTRINGS);
00827 
00828         dwNewLong |= pwnd-&gt;style &amp; (LBS_OWNERDRAWFIXED |
00829                                     LBS_OWNERDRAWVARIABLE |
00830                                     LBS_HASSTRINGS);
00831 
00832 <span class="preprocessor">#if DBG</span>
00833 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dwDebugLong != dwNewLong) {
00834            RIPMSG0(RIP_WARNING, <span class="stringliteral">"SetWindowLong can't change LBS_OWNERDRAW* or LBS_HASSTRINGS."</span>);
00835         }
00836 <span class="preprocessor">#endif</span>
00837 <span class="preprocessor"></span>    }
00838 
00839 
00840         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d0/d0/ntuser_8h.html#a135">NtUserSetWindowLong</a>(
00841                 hwnd,
00842                 nIndex,
00843                 dwNewLong,
00844                 bAnsi);
00845 
00846     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00847     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(LONG);
00848 }
00849 <span class="preprocessor">#endif</span>
00850 <span class="preprocessor"></span>
<a name="l00851"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a20">00851</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a20">TranslateMessageEx</a>(
00852     CONST MSG *pmsg,
00853     UINT flags)
00854 {
00855     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00856 
00857         <span class="comment">/*</span>
00858 <span class="comment">         * Don't bother going over to the kernel if this isn't</span>
00859 <span class="comment">         * key message.</span>
00860 <span class="comment">         */</span>
00861         <span class="keywordflow">switch</span> (pmsg-&gt;message) {
00862         <span class="keywordflow">case</span> WM_KEYDOWN:
00863         <span class="keywordflow">case</span> WM_KEYUP:
00864         <span class="keywordflow">case</span> WM_SYSKEYDOWN:
00865         <span class="keywordflow">case</span> WM_SYSKEYUP:
00866             <span class="keywordflow">break</span>;
00867         <span class="keywordflow">default</span>:
00868             <span class="keywordflow">if</span> (pmsg-&gt;message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
00869                 RIPERR1(ERROR_INVALID_PARAMETER,
00870                         RIP_WARNING,
00871                         <span class="stringliteral">"Invalid parameter \"pmsg-&gt;message\" (%ld) to TranslateMessageEx"</span>,
00872                         pmsg-&gt;message);
00873             }
00874             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
00875         }
00876 
00877         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a240">NtUserTranslateMessage</a>(
00878                 pmsg,
00879                 flags);
00880 
00881     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00882     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00883 }
00884 
<a name="l00885"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a21">00885</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a21">TranslateMessage</a>(
00886     CONST MSG *pmsg)
00887 {
00888     <span class="comment">//</span>
00889     <span class="comment">// IME special key handling</span>
00890     <span class="comment">//</span>
00891     <span class="keywordflow">if</span> ( LOWORD(pmsg-&gt;wParam) == VK_PROCESSKEY ) {
00892         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fResult;
00893         <span class="comment">//</span>
00894         <span class="comment">// This vkey should be processed by IME</span>
00895         <span class="comment">//</span>
00896         fResult = <a class="code" href="../../d6/d0/usercli_8h.html#a338">fpImmTranslateMessage</a>( pmsg-&gt;hwnd,
00897                                        pmsg-&gt;message,
00898                                        pmsg-&gt;wParam,
00899                                        pmsg-&gt;lParam );
00900         <span class="keywordflow">if</span> ( fResult )
00901             <span class="keywordflow">return</span> fResult;
00902     }
00903     <span class="keywordflow">return</span>(<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a20">TranslateMessageEx</a>(pmsg, 0));
00904 }
00905 
<a name="l00906"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">00906</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a22">SetWindowRgn</a>(
00907     HWND hwnd,
00908     HRGN hrgn,
00909     BOOL bRedraw)
00910 {
00911     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00912 
00913         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a256">NtUserSetWindowRgn</a>(
00914                 hwnd,
00915                 hrgn,
00916                 bRedraw);
00917 
00918         <span class="keywordflow">if</span> (retval) {
00919             DeleteObject(hrgn);
00920         }
00921 
00922     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00923     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00924 }
00925 
<a name="l00926"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a23">00926</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a23">InternalGetWindowText</a>(
00927     HWND hwnd,
00928     LPWSTR pString,
00929     <span class="keywordtype">int</span> cchMaxCount)
00930 {
00931     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00932 
00933         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a258">NtUserInternalGetWindowText</a>(
00934                 hwnd,
00935                 pString,
00936                 cchMaxCount);
00937 
00938         <span class="keywordflow">if</span> (!retval) {
00939             *pString = (WCHAR)0;
00940         }
00941 
00942     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00943     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
00944 }
00945 
<a name="l00946"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a24">00946</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a24">ToUnicode</a>(
00947     UINT wVirtKey,
00948     UINT wScanCode,
00949     CONST BYTE *pKeyState,
00950     LPWSTR pwszBuff,
00951     <span class="keywordtype">int</span> cchBuff,
00952     UINT wFlags)
00953 {
00954     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00955 
00956         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a260">NtUserToUnicodeEx</a>(
00957                 wVirtKey,
00958                 wScanCode,
00959                 pKeyState,
00960                 pwszBuff,
00961                 cchBuff,
00962                 wFlags,
00963                 (HKL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00964 
00965         <span class="keywordflow">if</span> (!retval) {
00966             *pwszBuff = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00967         }
00968 
00969     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00970     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<span class="keywordtype">int</span>);
00971 }
00972 
<a name="l00973"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a25">00973</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a25">ToUnicodeEx</a>(
00974     UINT wVirtKey,
00975     UINT wScanCode,
00976     CONST BYTE *pKeyState,
00977     LPWSTR pwszBuff,
00978     <span class="keywordtype">int</span> cchBuff,
00979     UINT wFlags,
00980     HKL hkl)
00981 {
00982     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
00983 
00984     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a260">NtUserToUnicodeEx</a>(
00985             wVirtKey,
00986             wScanCode,
00987             pKeyState,
00988             pwszBuff,
00989             cchBuff,
00990             wFlags,
00991             hkl);
00992 
00993     <span class="keywordflow">if</span> (!retval) {
00994         *pwszBuff = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00995     }
00996 
00997     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
00998     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<span class="keywordtype">int</span>);
00999 }
01000 
01001 <span class="preprocessor">#if DBG</span>
01002 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> DbgWin32HeapFail(
01003     DWORD dwFlags,
01004     BOOL  bFail)
01005 {
01006     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> | WHF_VALID) != WHF_VALID) {
01007         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid flags for DbgWin32HeapFail %x"</span>, dwFlags);
01008         <span class="keywordflow">return</span>;
01009     }
01010 
01011     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WHF_CSRSS) {
01012         <span class="comment">// Tell csr about it</span>
01013         <a class="code" href="../../d0/d0/csrhlpr_8h.html#a3">CsrWin32HeapFail</a>(dwFlags, bFail);
01014     }
01015 
01016     NtUserDbgWin32HeapFail(dwFlags, bFail);
01017 }
01018 
01019 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> DbgWin32HeapStat(
01020     PDBGHEAPSTAT    phs,
01021     DWORD   dwLen,
01022     DWORD   dwFlags)
01023 {
01024     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> | WHF_VALID) != WHF_VALID) {
01025         RIPMSG1(RIP_WARNING, <span class="stringliteral">"Invalid flags for DbgWin32HeapFail %x"</span>, dwFlags);
01026         <span class="keywordflow">return</span> 0;
01027     }
01028 
01029     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WHF_CSRSS) {
01030         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/csrhlpr_8h.html#a4">CsrWin32HeapStat</a>(phs, dwLen);
01031     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WHF_DESKTOP) {
01032         <span class="keywordflow">return</span> NtUserDbgWin32HeapStat(phs, dwLen);
01033     }
01034     <span class="keywordflow">return</span> 0;
01035 }
01036 
01037 <span class="preprocessor">#endif // DBG</span>
01038 <span class="preprocessor"></span>
<a name="l01039"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a26">01039</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a26">SetWindowStationUser</a>(
01040     HWINSTA hwinsta,
01041     PLUID   pluidUser,
01042     PSID    psidUser,
01043     DWORD   cbsidUser)
01044 {
01045     LUID luidNone = { 0, 0 };
01046 
01047 
01048     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01049 
01050         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a265">NtUserSetWindowStationUser</a>(hwinsta,
01051                                                    pluidUser,
01052                                                    psidUser,
01053                                                    cbsidUser);
01054 
01055         <span class="comment">/*</span>
01056 <span class="comment">         * Load global atoms if the logon succeeded</span>
01057 <span class="comment">         */</span>
01058         <span class="keywordflow">if</span> (retval) {
01059 
01060             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(pluidUser,&amp;luidNone)) {
01061                 <span class="comment">/*</span>
01062 <span class="comment">                 * Reset console and load Nls data.</span>
01063 <span class="comment">                 */</span>
01064                 <a class="code" href="../../d0/d0/csrhlpr_8h.html#a2">Logon</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01065             } <span class="keywordflow">else</span> {
01066                 <span class="comment">/*</span>
01067 <span class="comment">                 * Flush NLS cache.</span>
01068 <span class="comment">                 */</span>
01069                 <a class="code" href="../../d0/d0/csrhlpr_8h.html#a2">Logon</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01070             }
01071 
01072             retval = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01073         }
01074     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01075     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01076 }
01077 
<a name="l01078"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a27">01078</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a27">SetSystemCursor</a>(
01079     HCURSOR hcur,
01080     DWORD   <span class="keywordtype">id</span>)
01081 {
01082     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01083 
01084         <span class="keywordflow">if</span> (hcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085             hcur = (HANDLE)<a class="code" href="../../d6/d0/usercli_8h.html#a655">LoadIcoCur</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01086                                       MAKEINTRESOURCE(<span class="keywordtype">id</span>),
01087                                       RT_CURSOR,
01088                                       0,
01089                                       0,
01090                                       LR_DEFAULTSIZE);
01091 
01092             <span class="keywordflow">if</span> (hcur == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01093                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01094         }
01095 
01096         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a267">NtUserSetSystemCursor</a>(hcur, <span class="keywordtype">id</span>);
01097 
01098     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01099     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01100 }
01101 
<a name="l01102"></a><a class="code" href="../../d6/d0/usercli_8h.html#a627">01102</a> HCURSOR <a class="code" href="../../d6/d0/usercli_8h.html#a627">FindExistingCursorIcon</a>(
01103     LPWSTR      pszModName,
01104     LPCWSTR     pszResName,
01105     <a class="code" href="../../d9/d1/structtagCURSORFIND.html">PCURSORFIND</a> pcfSearch)
01106 {
01107     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strModName;
01108     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strResName;
01109 
01110     <span class="comment">/*</span>
01111 <span class="comment">     * Make sure cleanup will work successfully</span>
01112 <span class="comment">     */</span>
01113     strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01114     strResName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01115 
01116     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01117 
01118         <span class="keywordflow">if</span> (pszModName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01119             pszModName = <a class="code" href="../../d1/d8/clglobal_8c.html#a12">szUSER32</a>;
01120 
01121         <a class="code" href="../../d7/d9/ntsend_8h.html#a30">COPYLPWSTR</a>(&amp;strModName, pszModName);
01122         <a class="code" href="../../d7/d9/ntsend_8h.html#a31">COPYLPWSTRID</a>(&amp;strResName, pszResName);
01123 
01124         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a270">NtUserFindExistingCursorIcon</a>(strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01125                                                      strResName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01126                                                      pcfSearch);
01127 
01128     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01129 
01130     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strModName);
01131     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strResName);
01132 
01133     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HCURSOR);
01134 }
01135 
01136 
01137 
<a name="l01138"></a><a class="code" href="../../d6/d0/usercli_8h.html#a626">01138</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1114">_SetCursorIconData</a>(
01139     HCURSOR     hCursor,
01140     <a class="code" href="../../d8/d1/structtagCURSORDATA.html">PCURSORDATA</a> pcur)
01141 {
01142     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a>  strModName;
01143     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a>  strResName;
01144 
01145     <span class="comment">/*</span>
01146 <span class="comment">     * Make sure cleanup will work successfully</span>
01147 <span class="comment">     */</span>
01148     strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01149     strResName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01150 
01151     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01152 
01153         <a class="code" href="../../d7/d9/ntsend_8h.html#a33">COPYLPWSTROPT</a>(&amp;strModName, pcur-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o2">lpModName</a>);
01154         <a class="code" href="../../d7/d9/ntsend_8h.html#a32">COPYLPWSTRIDOPT</a>(&amp;strResName, pcur-&gt;<a class="code" href="../../d8/d1/structtagCURSORDATA.html#o1">lpName</a>);
01155 
01156         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a271">NtUserSetCursorIconData</a>(hCursor,
01157                                                 strModName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01158                                                 strResName.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01159                                                 pcur);
01160 
01161     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01162 
01163     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strModName);
01164     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strResName);
01165 
01166     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01167 }
01168 
01169 
01170 
<a name="l01171"></a><a class="code" href="../../d6/d0/usercli_8h.html#a622">01171</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d6/d0/usercli_8h.html#a622">_DefSetText</a>(
01172     HWND hwnd,
01173     LPCWSTR lpszText,
01174     BOOL bAnsi)
01175 {
01176     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> str;
01177 
01178     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01179 
01180         <span class="keywordflow">if</span> (lpszText) {
01181             <span class="keywordflow">if</span> (bAnsi)
01182                 <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;str,
01183                         (LPSTR)lpszText, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
01184             <span class="keywordflow">else</span>
01185                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;str,
01186                         lpszText, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
01187         }
01188 
01189         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a275">NtUserDefSetText</a>(
01190                 hwnd,
01191                 lpszText ? &amp;str : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01192 
01193     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01194     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>);
01195 }
01196 
<a name="l01197"></a><a class="code" href="../../d6/d0/usercli_8h.html#a624">01197</a> HWND <a class="code" href="../../d6/d0/usercli_8h.html#a624">_CreateWindowEx</a>(
01198     DWORD dwExStyle,
01199     LPCTSTR pClassName,
01200     LPCTSTR pWindowName,
01201     DWORD dwStyle,
01202     <span class="keywordtype">int</span> x,
01203     <span class="keywordtype">int</span> y,
01204     <span class="keywordtype">int</span> nWidth,
01205     <span class="keywordtype">int</span> nHeight,
01206     HWND hwndParent,
01207     HMENU hmenu,
01208     HANDLE hModule,
01209     LPVOID pParam,
01210     DWORD dwFlags)
01211 {
01212     <a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html">LARGE_IN_STRING</a> strClassName;
01213     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">LARGE_STRING</a> strWindowName;
01214     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstrClassName;
01215     <a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a> pstrWindowName;
01216     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwExpWinVerAndFlags;
01217 
01218     <span class="comment">/*</span>
01219 <span class="comment">     * Make sure cleanup will work successfully</span>
01220 <span class="comment">     */</span>
01221     strClassName.<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01222 
01223     <span class="comment">/*</span>
01224 <span class="comment">     * To be compatible with Chicago, we test the validity of</span>
01225 <span class="comment">     * the ExStyle bits and fail if any invalid bits are found.</span>
01226 <span class="comment">     * And for backward compatibilty with NT apps, we only fail for</span>
01227 <span class="comment">     * new apps (post NT 3.1).</span>
01228 <span class="comment">     */</span>
01229 
01230 <span class="comment">// BOGUS</span>
01231 
01232     <span class="keywordflow">if</span> (dwExStyle &amp; 0x00000800<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) {
01233         dwExStyle |= WS_EX_TOOLWINDOW;
01234         dwExStyle &amp;= 0xfffff7ff<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01235     }
01236 
01237     dwExpWinVerAndFlags = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(WORD)<a class="code" href="../../d6/d0/usercli_8h.html#a134">GETEXPWINVER</a>(hModule);
01238     <span class="keywordflow">if</span> ((dwExStyle &amp; ~WS_EX_VALID50) &amp;&amp; (dwExpWinVerAndFlags &gt;= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) ) {
01239         RIPMSG0(RIP_ERROR, <span class="stringliteral">"Invalid 5.0 ExStyle\n"</span>);
01240         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01241     }
01242     {
01243 
01244     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fMDIchild = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01245     MDICREATESTRUCT mdics;
01246     HMENU hSysMenu;
01247 
01248     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01249 
01250         <span class="keywordflow">if</span> ((fMDIchild = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)(dwExStyle &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a187">WS_EX_MDICHILD</a>))) {
01251             <a class="code" href="../../d5/d6/structtagSHORTCREATE.html">SHORTCREATE</a> sc;
01252             <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndParent;
01253 
01254             pwndParent = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwndParent);
01255 
01256             <span class="keywordflow">if</span> ((pwndParent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwndParent) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a206">FNID_MDICLIENT</a>)) {
01257                 RIPMSG0(RIP_ERROR, <span class="stringliteral">"Invalid parent for MDI child window\n"</span>);
01258                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01259             }
01260 
01261             mdics.lParam  = (LPARAM)pParam;
01262             pParam = &amp;mdics;
01263             mdics.x = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o3">x</a> = x;
01264             mdics.y = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o2">y</a> = y;
01265             mdics.cx = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o1">cx</a> = nWidth;
01266             mdics.cy = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o0">cy</a> = nHeight;
01267             mdics.style = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o4">style</a> = dwStyle;
01268             mdics.hOwner = hModule;
01269             mdics.szClass = pClassName;
01270             mdics.szTitle = pWindowName;
01271 
01272             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d0/usercli_8h.html#a773">CreateMDIChild</a>(&amp;sc, &amp;mdics, dwExpWinVerAndFlags, &amp;hSysMenu, pwndParent))
01273                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01274 
01275             x = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o3">x</a>;
01276             y = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o2">y</a>;
01277             nWidth = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o1">cx</a>;
01278             nHeight = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o0">cy</a>;
01279             dwStyle = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o4">style</a>;
01280             hmenu = sc.<a class="code" href="../../d5/d6/structtagSHORTCREATE.html#o5">hMenu</a>;
01281         }
01282 
01283         <span class="comment">/*</span>
01284 <span class="comment">         * Set up class and window name.  If the window name is an</span>
01285 <span class="comment">         * ordinal, make it look like a string so the callback thunk</span>
01286 <span class="comment">         * will be able to ensure it is in the correct format.</span>
01287 <span class="comment">         */</span>
01288         pstrWindowName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01289         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; CW_FLAGS_ANSI) {
01290             dwExStyle = dwExStyle | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a188">WS_EX_ANSICREATOR</a>;
01291             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pClassName)) {
01292                 <a class="code" href="../../d6/d0/usercli_8h.html#a430">RtlCaptureLargeAnsiString</a>(&amp;strClassName,
01293                         (PCHAR)pClassName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01294                 pstrClassName = (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)strClassName.<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o1">pstr</a>;
01295             } <span class="keywordflow">else</span>
01296                 pstrClassName = (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)pClassName;
01297 
01298             <span class="keywordflow">if</span> (pWindowName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01299                 <span class="keywordflow">if</span> (*(<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pWindowName == 0xff) {
01300                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01301                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (PVOID)pWindowName;
01302                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 3;
01303                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = 3;
01304                 } <span class="keywordflow">else</span>
01305                     <a class="code" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a>((<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>)&amp;strWindowName,
01306                             (LPSTR)pWindowName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
01307                 pstrWindowName = &amp;strWindowName;
01308             }
01309         } <span class="keywordflow">else</span> {
01310             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a98">IS_PTR</a>(pClassName)) {
01311                 <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>(
01312                         (<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;strClassName.<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>,
01313                         pClassName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
01314                 pstrClassName = (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)&amp;strClassName.<a class="code" href="../../d8/d8/struct__LARGE__IN__STRING.html#o0">strCapture</a>;
01315             } <span class="keywordflow">else</span>
01316                 pstrClassName = (<a class="code" href="../../d1/d9/struct__LARGE__STRING.html">PLARGE_STRING</a>)pClassName;
01317 
01318             <span class="keywordflow">if</span> (pWindowName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01319                 <span class="keywordflow">if</span> (pWindowName != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01320                      *(PWORD)pWindowName == 0xffff) {
01321                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o2">bAnsi</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01322                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o3">Buffer</a> = (PVOID)pWindowName;
01323                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o0">Length</a> = 4;
01324                     strWindowName.<a class="code" href="../../d1/d9/struct__LARGE__STRING.html#o1">MaximumLength</a> = 4;
01325                 } <span class="keywordflow">else</span>
01326                     <a class="code" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a>((<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>)&amp;strWindowName,
01327                             pWindowName, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)-1);
01328                 pstrWindowName = &amp;strWindowName;
01329             }
01330         }
01331         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a771">CW_FLAGS_DIFFHMOD</a>) {
01332             dwExpWinVerAndFlags |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a771">CW_FLAGS_DIFFHMOD</a>;
01333         }
01334 
01335         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a290">NtUserCreateWindowEx</a>(
01336                 dwExStyle,
01337                 pstrClassName,
01338                 pstrWindowName,
01339                 dwStyle,
01340                 x,
01341                 y,
01342                 nWidth,
01343                 nHeight,
01344                 hwndParent,
01345                 hmenu,
01346                 hModule,
01347                 pParam,
01348                 dwExpWinVerAndFlags);
01349 
01350     <span class="comment">// If this is an MDI child, we need to do some more to complete the</span>
01351     <span class="comment">// process of creating an MDI child.</span>
01352     <span class="keywordflow">if</span> (retval &amp;&amp; fMDIchild) {
01353         <a class="code" href="../../d6/d0/usercli_8h.html#a774">MDICompleteChildCreation</a>((HWND)retval, hSysMenu, ((dwStyle &amp; WS_VISIBLE) != 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>), (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>)((dwStyle &amp; WS_DISABLED)!= 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
01354     }
01355 
01356 
01357     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01358     <a class="code" href="../../d7/d9/ntsend_8h.html#a29">CLEANUPLPSTRW</a>(strClassName);
01359     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HWND);
01360     }
01361 }
01362 
<a name="l01363"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a32">01363</a> HKL <a class="code" href="../../d6/d0/usercli_8h.html#a625">_LoadKeyboardLayoutEx</a>(
01364     HANDLE hFile,
01365     UINT offTable,
01366     HKL hkl,
01367     LPCTSTR pwszKL,
01368     UINT KbdInputLocale,
01369     UINT Flags)
01370 {
01371     <a class="code" href="../../d8/d1/struct__IN__STRING.html">IN_STRING</a> strKL;
01372 
01373     <span class="comment">/*</span>
01374 <span class="comment">     * Make sure cleanup will work successfully</span>
01375 <span class="comment">     */</span>
01376     strKL.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o2">fAllocated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01377 
01378     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01379 
01380         <a class="code" href="../../d7/d9/ntsend_8h.html#a37">FIRSTCOPYLPWSTR</a>(&amp;strKL, pwszKL);
01381 
01382         retval = (ULONG_PTR)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a295">NtUserLoadKeyboardLayoutEx</a>(
01383                 hFile,
01384                 offTable,
01385                 hkl,
01386                 strKL.<a class="code" href="../../d8/d1/struct__IN__STRING.html#o1">pstr</a>,
01387                 KbdInputLocale,
01388                 Flags);
01389 
01390     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01391     <a class="code" href="../../d7/d9/ntsend_8h.html#a44">CLEANUPLPWSTR</a>(strKL);
01392     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(HKL);
01393 }
01394 
<a name="l01395"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a33">01395</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a33">mouse_event</a>(
01396     DWORD dwFlags,
01397     DWORD dx,
01398     DWORD dy,
01399     DWORD dwData,
01400     ULONG_PTR dwExtraInfo)
01401 {
01402     INPUT ms;
01403 
01404     <a class="code" href="../../d7/d9/ntsend_8h.html#a2">BEGINCALLVOID</a>()
01405 
01406         ms.type           = INPUT_MOUSE;
01407         ms.mi.dwFlags     = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
01408         ms.mi.dx          = dx;
01409         ms.mi.dy          = dy;
01410         ms.mi.mouseData   = dwData;
01411         ms.mi.time        = 0;
01412         ms.mi.dwExtraInfo = dwExtraInfo;
01413 
01414         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a301">NtUserSendInput</a>(1, &amp;ms, <span class="keyword">sizeof</span>(INPUT));
01415 
01416     <a class="code" href="../../d7/d9/ntsend_8h.html#a6">ENDCALLVOID</a>()
01417 }
01418 
<a name="l01419"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a34">01419</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a34">keybd_event</a>(
01420     BYTE  bVk,
01421     BYTE  bScan,
01422     DWORD dwFlags,
01423     ULONG_PTR dwExtraInfo)
01424 {
01425     INPUT kbd;
01426 
01427     <a class="code" href="../../d7/d9/ntsend_8h.html#a2">BEGINCALLVOID</a>()
01428 
01429         kbd.type           = INPUT_KEYBOARD;
01430         kbd.ki.dwFlags     = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
01431         kbd.ki.wVk         = bVk;
01432         kbd.ki.wScan       = bScan;
01433         kbd.ki.time        = 0;
01434         kbd.ki.dwExtraInfo = dwExtraInfo;
01435 
01436         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a301">NtUserSendInput</a>(1, &amp;kbd, <span class="keyword">sizeof</span>(INPUT));
01437 
01438     <a class="code" href="../../d7/d9/ntsend_8h.html#a6">ENDCALLVOID</a>()
01439 }
01440 
01441 <span class="comment">/*</span>
01442 <span class="comment"> * Message thunks</span>
01443 <span class="comment"> */</span>
<a name="l01444"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a35">01444</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnINWPARAMDBCSCHAR)
01445 {
01446     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01447 
01448         <span class="comment">/*</span>
01449 <span class="comment">         * The server always expects the characters to be unicode so</span>
01450 <span class="comment">         * if this was generated from an ANSI routine convert it to Unicode</span>
01451 <span class="comment">         */</span>
01452         <span class="keywordflow">if</span> (bAnsi) {
01453 
01454             <span class="comment">/*</span>
01455 <span class="comment">             * Setup for DBCS Messaging..</span>
01456 <span class="comment">             */</span>
01457             <a class="code" href="../../d6/d0/usercli_8h.html#a294">BUILD_DBCS_MESSAGE_TO_SERVER_FROM_CLIENTA</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,wParam,<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01458 
01459             <span class="comment">/*</span>
01460 <span class="comment">             * Convert DBCS/SBCS to Unicode...</span>
01461 <span class="comment">             */</span>
01462             <a class="code" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>, &amp;wParam);
01463         }
01464 
01465         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01466                 hwnd,
01467                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01468                 wParam,
01469                 lParam,
01470                 xParam,
01471                 xpfnProc,
01472                 bAnsi);
01473 
01474     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01475     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01476 }
01477 
<a name="l01478"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a36">01478</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnCOPYGLOBALDATA)
01479 {
01480     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> pData;
01481     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01482 
01483         <span class="keywordflow">if</span> (wParam == 0) {
01484             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01485         }
01486 
01487         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>((HGLOBAL)lParam, pData);
01488         <span class="keywordflow">if</span> (pData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01489             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01490         }
01491         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01492                 hwnd,
01493                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01494                 wParam,
01495                 (LPARAM)pData,
01496                 xParam,
01497                 xpfnProc,
01498                 bAnsi);
01499         <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>((HGLOBAL)lParam);
01500         <a class="code" href="../../d6/d0/usercli_8h.html#a2">UserGlobalFree</a>((HGLOBAL)lParam);
01501     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01502     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01503 }
01504 
<a name="l01505"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a37">01505</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnINPAINTCLIPBRD)
01506 {
01507     LPPAINTSTRUCT lpps;
01508 
01509     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01510 
01511         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>((HGLOBAL)lParam, lpps);
01512         <span class="keywordflow">if</span> (lpps) {
01513             retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01514                     hwnd,
01515                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01516                     wParam,
01517                     (LPARAM)lpps,
01518                     xParam,
01519                     xpfnProc,
01520                     bAnsi);
01521             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>((HGLOBAL)lParam);
01522         } <span class="keywordflow">else</span> {
01523             RIPMSG1(RIP_WARNING, <span class="stringliteral">"MESSAGECALL(fnINPAINTCLIPBRD): USERGLOBALLOCK failed on %p!"</span>, lParam);
01524         }
01525 
01526     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01527     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01528 }
01529 
<a name="l01530"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a38">01530</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnINSIZECLIPBRD)
01531 {
01532     LPRECT lprc;
01533     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01534 
01535         <a class="code" href="../../d6/d0/usercli_8h.html#a4">USERGLOBALLOCK</a>((HGLOBAL)lParam, lprc);
01536         <span class="keywordflow">if</span> (lprc) {
01537             retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01538                     hwnd,
01539                     <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01540                     wParam,
01541                     (LPARAM)lprc,
01542                     xParam,
01543                     xpfnProc,
01544                 bAnsi);
01545             <a class="code" href="../../d6/d0/usercli_8h.html#a1">USERGLOBALUNLOCK</a>((HGLOBAL)lParam);
01546         } <span class="keywordflow">else</span> {
01547             RIPMSG1(RIP_WARNING, <span class="stringliteral">"MESSAGECALL(fnINSIZECLIPBRD): USERGLOBALLOCK failed on %p!"</span>, lParam);
01548         }
01549 
01550     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01551     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01552 }
01553 
<a name="l01554"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a39">01554</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnINDEVICECHANGE)
01555 {
01556     <span class="keyword">struct </span>_DEV_BROADCAST_HEADER *pHdr;
01557     PDEV_BROADCAST_PORT_W pPortW = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01558     PDEV_BROADCAST_PORT_A pPortA;
01559     PDEV_BROADCAST_DEVICEINTERFACE_W pInterfaceW = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01560     PDEV_BROADCAST_DEVICEINTERFACE_A pInterfaceA;
01561     PDEV_BROADCAST_HANDLE pHandleW = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01562     PDEV_BROADCAST_HANDLE pHandleA;
01563 
01564     LPWSTR lpStr;
01565     <span class="keywordtype">int</span> iStr, iSize;
01566 
01567     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01568 
01569         <span class="keywordflow">if</span> (!(wParam &amp;0x8000) || !lParam || !bAnsi)
01570             <span class="keywordflow">goto</span> shipit;
01571 
01572         pHdr = (<span class="keyword">struct </span>_DEV_BROADCAST_HEADER *)lParam;
01573         <span class="keywordflow">switch</span> (pHdr-&gt;dbcd_devicetype) {
01574         <span class="keywordflow">case</span> DBT_DEVTYP_PORT:
01575             pPortA = (PDEV_BROADCAST_PORT_A)lParam;
01576             iStr = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(pPortA-&gt;dbcp_name);
01577             iSize = FIELD_OFFSET(DEV_BROADCAST_PORT_W, dbcp_name) + <span class="keyword">sizeof</span>(WCHAR)*(iStr+1);
01578             pPortW = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, iSize);
01579             <span class="keywordflow">if</span> (pPortW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01580                 <span class="keywordflow">return</span> 0;
01581             RtlCopyMemory(pPortW, pPortA, <span class="keyword">sizeof</span>(DEV_BROADCAST_PORT_A));
01582             lpStr = pPortW-&gt;dbcp_name;
01583             <span class="keywordflow">if</span> (iStr) {
01584                 MBToWCS(pPortA-&gt;dbcp_name, -1, &amp;lpStr, iStr, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01585                 lpStr[iStr] = 0;
01586             } <span class="keywordflow">else</span> {
01587                 lpStr[0] = 0;
01588             }
01589             pPortW-&gt;dbcp_size = iSize;
01590             lParam = (LPARAM)pPortW;
01591             bAnsi = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01592             <span class="keywordflow">break</span>;
01593 
01594         <span class="keywordflow">case</span> DBT_DEVTYP_DEVICEINTERFACE:
01595             pInterfaceA = (PDEV_BROADCAST_DEVICEINTERFACE_A)lParam;
01596             iStr = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(pInterfaceA-&gt;dbcc_name);
01597             iSize = FIELD_OFFSET(DEV_BROADCAST_DEVICEINTERFACE_W, dbcc_name) + <span class="keyword">sizeof</span>(WCHAR)*(iStr+1);
01598             pInterfaceW = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, iSize);
01599             <span class="keywordflow">if</span> (pInterfaceW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01600                 <span class="keywordflow">return</span> 0;
01601             RtlCopyMemory(pInterfaceW, pInterfaceA, <span class="keyword">sizeof</span>(DEV_BROADCAST_DEVICEINTERFACE_A));
01602             lpStr = pInterfaceW-&gt;dbcc_name;
01603             <span class="keywordflow">if</span> (iStr) {
01604                 MBToWCS(pInterfaceA-&gt;dbcc_name, -1, &amp;lpStr, iStr, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01605                 lpStr[iStr] = 0;
01606             } <span class="keywordflow">else</span> {
01607                 lpStr[0] = 0;
01608             }
01609             pInterfaceW-&gt;dbcc_size = iSize;
01610             lParam = (LPARAM)pInterfaceW;
01611             bAnsi = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01612             <span class="keywordflow">break</span>;
01613 
01614         <span class="keywordflow">case</span> DBT_DEVTYP_HANDLE:
01615             pHandleA = (PDEV_BROADCAST_HANDLE)lParam;
01616             bAnsi = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01617             <span class="keywordflow">if</span> ((wParam != DBT_CUSTOMEVENT) || (pHandleA-&gt;dbch_nameoffset &lt; 0)) <span class="keywordflow">break</span>;
01618             iStr = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(pHandleA-&gt;dbch_data+pHandleA-&gt;dbch_nameoffset);
01619         <span class="comment">/*</span>
01620 <span class="comment">         * Calculate size of new structure with UNICODE string instead of Ansi string</span>
01621 <span class="comment">         */</span>
01622 
01623             iSize = FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_data)+ pHandleA-&gt;dbch_nameoffset + <span class="keyword">sizeof</span>(WCHAR)*(iStr+1);
01624             <span class="comment">/*</span>
01625 <span class="comment">             * Just in case there were an odd number of bytes in the non-text data</span>
01626 <span class="comment">             */</span>
01627             <span class="keywordflow">if</span> (iSize &amp; 1) iSize++;
01628             pHandleW = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, iSize);
01629             <span class="keywordflow">if</span> (pHandleW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01630                 <span class="keywordflow">return</span> 0;
01631             RtlCopyMemory(pHandleW, pHandleA, FIELD_OFFSET(DEV_BROADCAST_HANDLE, dbch_data)+ pHandleA-&gt;dbch_nameoffset);
01632 
01633             <span class="comment">/*</span>
01634 <span class="comment">             * Make sure this is even for the UNICODE string.</span>
01635 <span class="comment">             */</span>
01636 
01637             <span class="keywordflow">if</span> (pHandleW-&gt;dbch_nameoffset &amp; 1) pHandleW-&gt;dbch_nameoffset++;
01638 
01639             lpStr = (LPWSTR)(pHandleW-&gt;dbch_data+pHandleW-&gt;dbch_nameoffset);
01640             <span class="keywordflow">if</span> (iStr) {
01641                 MBToWCS(pHandleA-&gt;dbch_data+pHandleA-&gt;dbch_nameoffset, -1,
01642                         &amp;lpStr, iStr, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01643             }
01644                 lpStr[iStr] = 0;
01645             pHandleW-&gt;dbch_size = iSize;
01646             lParam = (LPARAM)pHandleW;
01647 
01648             <span class="keywordflow">break</span>;
01649         }
01650 
01651 shipit:
01652         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01653                 hwnd,
01654                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01655                 wParam,
01656                 lParam,
01657                 xParam,
01658                 xpfnProc,
01659                 bAnsi);
01660 
01661     <span class="keywordflow">if</span> (pPortW) <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pPortW);
01662     <span class="keywordflow">if</span> (pInterfaceW) <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pInterfaceW);
01663     <span class="keywordflow">if</span> (pHandleW) <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pHandleW);
01664 
01665     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01666     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01667 }
01668 
<a name="l01669"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a40">01669</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnIMECONTROL)
01670 {
01671     PVOID pvData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01672     LPARAM lData = lParam;
01673 
01674     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01675 
01676         <span class="comment">/*</span>
01677 <span class="comment">         * The server always expects the characters to be unicode so</span>
01678 <span class="comment">         * if this was generated from an ANSI routine convert it to Unicode</span>
01679 <span class="comment">         */</span>
01680         <span class="keywordflow">if</span> (bAnsi) {
01681             <span class="keywordflow">switch</span> (wParam) {
01682                 <span class="keywordflow">case</span> IMC_GETCOMPOSITIONFONT:
01683                 <span class="keywordflow">case</span> IMC_GETSOFTKBDFONT:
01684                 <span class="keywordflow">case</span> IMC_SETCOMPOSITIONFONT:
01685                     pvData = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(LOGFONTW));
01686                     <span class="keywordflow">if</span> (pvData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01687                         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01688 
01689                     <span class="keywordflow">if</span> (wParam == IMC_SETCOMPOSITIONFONT) {
01690                         <span class="comment">// Later, we do A/W conversion based on thread hkl/CP.</span>
01691                         <a class="code" href="../../d6/d0/usercli_8h.html#a637">CopyLogFontAtoW</a>((PLOGFONTW)pvData, (PLOGFONTA)lParam);
01692                     }
01693 
01694                     lData = (LPARAM)pvData;
01695                     <span class="keywordflow">break</span>;
01696 
01697                 <span class="keywordflow">case</span> IMC_SETSOFTKBDDATA:
01698                     {
01699                         PSOFTKBDDATA pSoftKbdData;
01700                         PWORD pCodeA;
01701                         PWSTR pCodeW;
01702                         <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  ch[3];
01703                         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> cbSize;
01704                         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>  uCount, i;
01705 
01706                         uCount = ((PSOFTKBDDATA)lParam)-&gt;uCount;
01707 
01708                         cbSize = FIELD_OFFSET(SOFTKBDDATA, wCode[0])
01709                                + uCount * <span class="keyword">sizeof</span>(WORD) * 256;
01710 
01711                         pvData = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, cbSize);
01712                         <span class="keywordflow">if</span> (pvData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01713                             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01714 
01715                         pSoftKbdData = (PSOFTKBDDATA)pvData;
01716 
01717                         pSoftKbdData-&gt;uCount = uCount;
01718 
01719                         ch[2] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<span class="charliteral">'\0'</span>;
01720 
01721                         pCodeA = &amp;((PSOFTKBDDATA)lParam)-&gt;wCode[0][0];
01722                         pCodeW = &amp;pSoftKbdData-&gt;wCode[0][0];
01723 
01724                         i = uCount * 256;
01725 
01726                         <span class="keywordflow">while</span> (i--) {
01727                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(*pCodeA)) {
01728                                 ch[0] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(*pCodeA);
01729                                 ch[1] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(*pCodeA);
01730                             } <span class="keywordflow">else</span> {
01731                                 ch[0] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(*pCodeA);
01732                                 ch[1] = (<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)<span class="charliteral">'\0'</span>;
01733                             }
01734                             <a class="code" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>(), (LPSTR)&amp;ch, -1, &amp;pCodeW, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01735                             pCodeA++; pCodeW++;
01736                         }
01737 
01738                         lData = (LPARAM)pvData;
01739                     }
01740                     <span class="keywordflow">break</span>;
01741 
01742                 <span class="keywordflow">default</span>:
01743                     <span class="keywordflow">break</span>;
01744             }
01745         }
01746 
01747         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
01748                 hwnd,
01749                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
01750                 wParam,
01751                 lData,
01752                 xParam,
01753                 xpfnProc,
01754                 bAnsi);
01755 
01756         <span class="keywordflow">if</span> (bAnsi) {
01757             <span class="keywordflow">switch</span> (wParam) {
01758                 <span class="keywordflow">case</span> IMC_GETCOMPOSITIONFONT:
01759                 <span class="keywordflow">case</span> IMC_GETSOFTKBDFONT:
01760                     <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>((PLOGFONTA)lParam, (PLOGFONTW)pvData);
01761                     <span class="keywordflow">break</span>;
01762 
01763                 <span class="keywordflow">default</span>:
01764                     <span class="keywordflow">break</span>;
01765             }
01766         }
01767 
01768         <span class="keywordflow">if</span> (pvData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01769             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvData);
01770 
01771     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
01772     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
01773 }
01774 
01775 <span class="preprocessor">#ifdef LATER</span>
01776 <span class="preprocessor"></span><a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(
01777     DWORD dwCharPosA,
01778     LPSTR lpszCharStr,
01779     DWORD dwCodePage)
01780 {
01781     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCharPosW = 0;
01782 
01783     <span class="keywordflow">while</span> (dwCharPosA != 0) {
01784         <span class="keywordflow">if</span> (IsDBCSLeadByteEx(dwCodePage, *lpszCharStr)) {
01785             <span class="keywordflow">if</span> (dwCharPosA &gt;= 2) {
01786                 dwCharPosA -= 2;
01787             }
01788             <span class="keywordflow">else</span> {
01789                 dwCharPosA--;
01790             }
01791             lpszCharStr += 2;
01792         }
01793         <span class="keywordflow">else</span> {
01794             dwCharPosA--;
01795             lpszCharStr++;
01796         }
01797         dwCharPosW++;
01798     }
01799 
01800     <span class="keywordflow">return</span> dwCharPosW;
01801 }
01802 
01803 <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(DWORD dwCodePage, LPCWSTR pwstr)
01804 {
01805     <span class="keywordtype">char</span> <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>[2], *lpszDummy = <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
01806     <span class="keywordflow">return</span> WCSToMBEx((WORD)dwCodePage, pwstr, 1, &amp;lpszDummy, <span class="keyword">sizeof</span>(WCHAR), FALSE);
01807 }
01808 
01809 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(
01810     DWORD dwCharPosW,
01811     LPWSTR lpwszCharStr,
01812     DWORD  dwCodePage)
01813 {
01814     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCharPosA = 0;
01815     ULONG MultiByteSize;
01816 
01817     <span class="keywordflow">while</span> (dwCharPosW != 0) {
01818         MultiByteSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(dwCodePage, lpwszCharStr);
01819         <span class="keywordflow">if</span> (MultiByteSize == 2) {
01820             dwCharPosA += 2;
01821         }
01822         <span class="keywordflow">else</span> {
01823             dwCharPosA++;
01824         }
01825         dwCharPosW--;
01826         lpwszCharStr++;
01827     }
01828 
01829     <span class="keywordflow">return</span> dwCharPosA;
01830 }
01831 
01832 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>(DWORD dwSize, REQ_CALLER eCaller, BOOL bAnsiTarget)
01833 {
01834     <span class="keywordflow">if</span> (dwSize &lt; <span class="keyword">sizeof</span>(RECONVERTSTRING)) {
01835         <span class="keywordflow">return</span> 0;
01836     }
01837     <span class="keywordflow">if</span> (bAnsiTarget) {
01838         dwSize -= <span class="keyword">sizeof</span>(RECONVERTSTRING);
01839         <span class="keywordflow">if</span> (eCaller == <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a4">FROM_IME</a>) {
01840             dwSize /= 2;
01841         } <span class="keywordflow">else</span> {
01842             dwSize *= 2;
01843         }
01844         dwSize += <span class="keyword">sizeof</span>(RECONVERTSTRING);
01845     }
01846     <span class="keywordflow">return</span> dwSize;
01847 }
01848 
01849 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(
01850         LPRECONVERTSTRING lpRecTo,
01851         LPRECONVERTSTRING lpRecFrom,
01852         BOOL bToAnsi,
01853         DWORD dwCodePage)
01854 {
01855     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
01856     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = 0;
01857 
01858     UserAssert(lpRecTo);
01859     UserAssert(lpRecFrom);
01860 
01861     <span class="keywordflow">if</span> (lpRecFrom-&gt;dwVersion != 0 || lpRecTo-&gt;dwVersion != 0) {
01862         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmReconversionWorker: dwVersion in lpRecTo or lpRecFrom is incorrect."</span>);
01863         <span class="keywordflow">return</span> 0;
01864     }
01865     <span class="comment">// Note:</span>
01866     <span class="comment">// In any IME related structures, use the following principal.</span>
01867     <span class="comment">// 1) xxxStrOffset is an actual offset, i.e. byte count.</span>
01868     <span class="comment">// 2) xxxStrLen is a number of characters, i.e. TCHAR count.</span>
01869     <span class="comment">//</span>
01870     <span class="comment">// CalcCharacterPositionXtoY() takes TCHAR count so that we</span>
01871     <span class="comment">// need to adjust xxxStrOffset if it's being converted. But you</span>
01872     <span class="comment">// should be careful, because the actual position of the string</span>
01873     <span class="comment">// is always at something like (LPBYTE)lpStruc + lpStruc-&gt;dwStrOffset.</span>
01874     <span class="comment">//</span>
01875     <span class="keywordflow">if</span> (bToAnsi) {
01876         <span class="comment">// Convert W to A</span>
01877         lpRecTo-&gt;dwStrOffset = <span class="keyword">sizeof</span> *lpRecTo;
01878         i = WideCharToMultiByte(dwCodePage,
01879                                 (DWORD)0,
01880                                 (LPWSTR)((LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset), <span class="comment">// src</span>
01881                                 (INT)lpRecFrom-&gt;dwStrLen,
01882                                 (LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset,  <span class="comment">// dest</span>
01883                                 (INT)lpRecFrom-&gt;dwStrLen * DBCS_CHARSIZE,
01884                                 (LPSTR)NULL,
01885                                 (LPBOOL)NULL);
01886         lpRecTo-&gt;dwCompStrOffset =
01887             <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwCompStrOffset / <span class="keyword">sizeof</span>(WCHAR),
01888                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
01889                                       dwCodePage)
01890                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
01891 
01892         lpRecTo-&gt;dwCompStrLen =
01893             (<a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwCompStrOffset / <span class="keyword">sizeof</span>(WCHAR) +
01894                                       lpRecFrom-&gt;dwCompStrLen,
01895                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
01896                                       dwCodePage)
01897                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>))
01898             - lpRecTo-&gt;dwCompStrOffset;
01899 
01900         lpRecTo-&gt;dwTargetStrOffset =
01901             <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwTargetStrOffset / <span class="keyword">sizeof</span>(WCHAR),
01902                                       (LPWSTR)((LPBYTE)lpRecFrom +
01903                                                 lpRecFrom-&gt;dwStrOffset),
01904                                       dwCodePage)
01905                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
01906 
01907         lpRecTo-&gt;dwTargetStrLen =
01908             (<a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwTargetStrOffset / <span class="keyword">sizeof</span>(WCHAR) +
01909                                       lpRecFrom-&gt;dwTargetStrLen,
01910                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
01911                                        dwCodePage)
01912                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>))
01913             - lpRecTo-&gt;dwTargetStrOffset;
01914 
01915         ((LPSTR)lpRecTo)[lpRecTo-&gt;dwStrOffset + i] = <span class="charliteral">'\0'</span>;
01916         lpRecTo-&gt;dwStrLen = i * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
01917 
01918         dwSize = <span class="keyword">sizeof</span>(RECONVERTSTRING) + ((i + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
01919 
01920     } <span class="keywordflow">else</span> {
01921 
01922         <span class="comment">// AtoW</span>
01923         lpRecTo-&gt;dwStrOffset = <span class="keyword">sizeof</span> *lpRecTo;
01924         i = MultiByteToWideChar(dwCodePage,
01925                                 (DWORD)MB_PRECOMPOSED,
01926                                 (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,  <span class="comment">// src</span>
01927                                 (INT)lpRecFrom-&gt;dwStrLen,
01928                                 (LPWSTR)((LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset), <span class="comment">// dest</span>
01929                                 (INT)lpRecFrom-&gt;dwStrLen);
01930 
01931         lpRecTo-&gt;dwCompStrOffset =
01932             <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwCompStrOffset,
01933                                       (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
01934                                       dwCodePage) * <span class="keyword">sizeof</span>(WCHAR);
01935 
01936         lpRecTo-&gt;dwCompStrLen =
01937             ((<a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwCompStrOffset +
01938                                        lpRecFrom-&gt;dwCompStrLen,
01939                                        (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
01940                                         dwCodePage)  * <span class="keyword">sizeof</span>(WCHAR))
01941             - lpRecTo-&gt;dwCompStrOffset) / <span class="keyword">sizeof</span>(WCHAR);
01942 
01943         lpRecTo-&gt;dwTargetStrOffset =
01944             <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwTargetStrOffset,
01945                                       (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
01946                                       dwCodePage) * <span class="keyword">sizeof</span>(WCHAR);
01947 
01948         lpRecTo-&gt;dwTargetStrLen =
01949             ((<a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwTargetStrOffset +
01950                                        lpRecFrom-&gt;dwTargetStrLen,
01951                                        (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
01952                                        dwCodePage)  * <span class="keyword">sizeof</span>(WCHAR))
01953             - lpRecTo-&gt;dwTargetStrOffset) / <span class="keyword">sizeof</span>(WCHAR);
01954 
01955         lpRecTo-&gt;dwStrLen = i;  <span class="comment">// Length is TCHAR count.</span>
01956         <span class="keywordflow">if</span> (lpRecTo-&gt;dwSize &gt;= (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpRecTo-&gt;dwStrOffset + (i + 1)* <span class="keyword">sizeof</span>(WCHAR))) {
01957             LPWSTR lpW = (LPWSTR)((LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset);
01958             lpW[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
01959         }
01960         dwSize = <span class="keyword">sizeof</span>(RECONVERTSTRING) + ((i + 1) * <span class="keyword">sizeof</span>(WCHAR));
01961     }
01962     <span class="keywordflow">return</span> dwSize;
01963 }
01964 
01965 <span class="preprocessor">#define GETCOMPOSITIONSTRING(hImc, index, buf, buflen) \</span>
01966 <span class="preprocessor">            (bAnsi ? fpImmGetCompositionStringA : fpImmGetCompositionStringW)((hImc), (index), (buf), (buflen))</span>
01967 <span class="preprocessor"></span>
01968 <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnIMEREQUEST)
01969 {
01970     PVOID pvData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01971     LPARAM lData = lParam;
01972 
01973     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
01974 
01975         if (!IS_IME_ENABLED()) {
01976             <span class="comment">// If IME is not enabled, save time.</span>
01977             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
01978         }
01979 
01980         <span class="comment">/*</span>
01981 <span class="comment">         * The server always expects the characters to be unicode so</span>
01982 <span class="comment">         * if this was generated from an ANSI routine convert it to Unicode</span>
01983 <span class="comment">         */</span>
01984         <span class="keywordflow">if</span> (wParam == IMR_QUERYCHARPOSITION) {
01985             <span class="comment">//</span>
01986             <span class="comment">// Store the UNICODE character count in PrivateIMECHARPOSITION.</span>
01987             <span class="comment">//</span>
01988             <span class="comment">// No need to save the original dwCharPos, since dwCharPositionA/W are not</span>
01989             <span class="comment">// overwritten in the kernel.</span>
01990             <span class="comment">//</span>
01991             <span class="keywordflow">if</span> (bAnsi) {
01992                 ((LPIMECHARPOSITION)lParam)-&gt;dwCharPos = ((LPPrivateIMECHARPOSITION)lParam)-&gt;dwCharPositionW;
01993             }
01994         }
01995         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bAnsi) {
01996             <span class="keywordflow">switch</span> (wParam) {
01997             <span class="keywordflow">case</span> IMR_COMPOSITIONFONT:
01998                 pvData = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, <span class="keyword">sizeof</span>(LOGFONTW));
01999                 <span class="keywordflow">if</span> (pvData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02000                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02001                 lData = (LPARAM)pvData;
02002                 <span class="keywordflow">break</span>;
02003 
02004             <span class="keywordflow">case</span> IMR_CONFIRMRECONVERTSTRING:
02005             <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
02006             <span class="keywordflow">case</span> IMR_DOCUMENTFEED:
02007                 <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02008                     <span class="comment">// IME wants not only the buffer size but the real reconversion information</span>
02009                     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>(((LPRECONVERTSTRING)lParam)-&gt;dwSize, FROM_IME, FALSE);
02010                     LPRECONVERTSTRING lpReconv;
02011 
02012                     pvData = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0, dwSize + <span class="keyword">sizeof</span>(WCHAR));
02013                     <span class="keywordflow">if</span> (pvData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02014                         RIPMSG0(RIP_WARNING, <span class="stringliteral">"fnIMEREQUEST: failed to allocate a buffer for reconversion."</span>);
02015                         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02016                     }
02017                     lpReconv = (LPRECONVERTSTRING)pvData;
02018                     <span class="comment">// setup the information in the allocated structure</span>
02019                     lpReconv-&gt;dwVersion = 0;
02020                     lpReconv-&gt;dwSize = dwSize;
02021 
02022                     <span class="comment">//</span>
02023                     <span class="comment">// if it's confirmation message, we need to translate the contents</span>
02024                     <span class="comment">//</span>
02025                     <span class="keywordflow">if</span> (wParam == IMR_CONFIRMRECONVERTSTRING) {
02026                         <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(lpReconv, (LPRECONVERTSTRING)lParam, FALSE, CP_ACP);
02027                     }
02028                 }
02029                 <span class="keywordflow">break</span>;
02030 
02031             <span class="keywordflow">default</span>:
02032                 <span class="keywordflow">break</span>;
02033             }
02034         }
02035 
02036         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02037                 hwnd,
02038                 msg,
02039                 wParam,
02040                 lData,
02041                 xParam,
02042                 xpfnProc,
02043                 bAnsi);
02044 
02045         <span class="keywordflow">if</span> (bAnsi) {
02046             <span class="keywordflow">switch</span> (wParam) {
02047             <span class="keywordflow">case</span> IMR_COMPOSITIONFONT:
02048                 <span class="keywordflow">if</span> (retval) {
02049                     <a class="code" href="../../d6/d0/usercli_8h.html#a638">CopyLogFontWtoA</a>((PLOGFONTA)lParam, (PLOGFONTW)pvData);
02050                 }
02051                 <span class="keywordflow">break</span>;
02052 
02053             <span class="keywordflow">case</span> IMR_QUERYCHARPOSITION:
02054                 ((LPIMECHARPOSITION)lParam)-&gt;dwCharPos = ((LPPrivateIMECHARPOSITION)lParam)-&gt;dwCharPositionA;
02055                 <span class="keywordflow">break</span>;
02056 
02057             <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
02058             <span class="keywordflow">case</span> IMR_DOCUMENTFEED:
02059                 <span class="comment">//</span>
02060                 <span class="comment">// Note: by definition, we don't need back-conversion for IMR_CONFIRMRECONVERTSTRING</span>
02061                 <span class="comment">//</span>
02062                 <span class="keywordflow">if</span> (retval) {
02063                     <span class="comment">// IME wants the buffer size</span>
02064                     retval = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>((DWORD)retval, FROM_APP, FALSE);
02065                     <span class="keywordflow">if</span> (retval &lt; <span class="keyword">sizeof</span>(RECONVERTSTRING)) {
02066                         RIPMSG2(RIP_WARNING, <span class="stringliteral">"WM_IME_REQUEST(%x): return value from application %d is invalid."</span>, wParam, retval);
02067                         retval = 0;
02068                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lParam) {
02069                         <span class="comment">// We need to perform the A/W conversion of the contents</span>
02070                         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>((LPRECONVERTSTRING)lParam, (LPRECONVERTSTRING)pvData, TRUE, CP_ACP)) {
02071                             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02072                         }
02073                     }
02074                 }
02075                 <span class="keywordflow">break</span>;
02076             }
02077         }
02078 
02079 
02080     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
02081 
02082     <span class="keywordflow">if</span> (pvData != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02083         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvData);
02084 
02085     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(DWORD);
02086 }
02087 <span class="preprocessor">#endif</span>
02088 <span class="preprocessor"></span>
<a name="l02089"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a41">02089</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnEMGETSEL)
02090 {
02091     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
02092 
02093     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02094         <span class="keywordflow">return</span> 0;
02095 
02096     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
02097 
02098         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02099                 hwnd,
02100                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
02101                 wParam,
02102                 lParam,
02103                 xParam,
02104                 xpfnProc,
02105                 bAnsi);
02106 
02107         <span class="comment">//</span>
02108         <span class="comment">// temp for our beta...</span>
02109         <span class="comment">//</span>
02110         <span class="comment">// !!! THIS CODE SHOULD BE IN KERNEL MODE !!!</span>
02111         <span class="comment">//</span>
02112         <span class="comment">// to reduce user &lt;-&gt; kernel mode transition...</span>
02113         <span class="comment">//</span>
02114         <span class="keywordflow">if</span> (bAnsi != ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02115             ULONG  cchTextLength;
02116             LONG   lOriginalLengthW;
02117             LONG   lOriginalLengthL;
02118             LONG   wParamLocal;
02119             LONG   lParamLocal;
02120 
02121             <span class="keywordflow">if</span> (wParam) {
02122                 lOriginalLengthW = *(LONG *)wParam;
02123             } <span class="keywordflow">else</span> {
02124                 lOriginalLengthW = (LONG)(LOWORD(retval));
02125             }
02126 
02127             <span class="keywordflow">if</span> (lParam) {
02128                 lOriginalLengthL = *(LONG *)lParam;
02129             } <span class="keywordflow">else</span> {
02130                 lOriginalLengthL = (LONG)(HIWORD(retval));
02131             }
02132 
02133             cchTextLength = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02134                            hwnd,
02135                            WM_GETTEXTLENGTH,
02136                            (WPARAM)0,
02137                            (LPARAM)0,
02138                            xParam,
02139                            xpfnProc,
02140                            bAnsi);
02141 
02142             <span class="keywordflow">if</span> (cchTextLength) {
02143                 PVOID pvString;
02144                 ULONG cbTextLength;
02145 
02146                 cchTextLength++;
02147                 <span class="keywordflow">if</span> (!bAnsi) {
02148                     cbTextLength = cchTextLength * <span class="keyword">sizeof</span>(WCHAR);
02149                 } <span class="keywordflow">else</span> {
02150                     cbTextLength = cchTextLength;
02151                 }
02152 
02153                 pvString = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,cbTextLength);
02154 
02155                 <span class="keywordflow">if</span> (pvString) {
02156 
02157                     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02158                             hwnd,
02159                             WM_GETTEXT,
02160                             cchTextLength,
02161                             (LPARAM)pvString,
02162                             xParam,
02163                             xpfnProc,
02164                             bAnsi);
02165 
02166                     <span class="keywordflow">if</span> (retval) {
02167                         <span class="keywordflow">if</span> (bAnsi) {
02168                             <span class="comment">/*</span>
02169 <span class="comment">                             * ansiString/unicodeLenght -&gt; ansiLength</span>
02170 <span class="comment">                             */</span>
02171                             <a class="code" href="../../d6/d0/usercli_8h.html#a301">CalcAnsiStringLengthA</a>(pvString, lOriginalLengthW, &amp;wParamLocal)
02172                             <a class="code" href="../../d6/d0/usercli_8h.html#a301">CalcAnsiStringLengthA</a>(pvString, lOriginalLengthL, &amp;lParamLocal);
02173                         } <span class="keywordflow">else</span> {
02174                             <span class="comment">/*</span>
02175 <span class="comment">                             * unicodeString/ansiLenght -&gt; unicodeLength</span>
02176 <span class="comment">                             */</span>
02177                             <a class="code" href="../../d6/d0/usercli_8h.html#a303">CalcUnicodeStringLengthW</a>(pvString, lOriginalLengthW, &amp;wParamLocal);
02178                             <a class="code" href="../../d6/d0/usercli_8h.html#a303">CalcUnicodeStringLengthW</a>(pvString, lOriginalLengthL, &amp;lParamLocal);
02179                         }
02180 
02181                         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(((lParamLocal) &lt;&lt; 16) | ((wParamLocal) &amp; 0x0000FFFF));
02182 
02183                         <span class="keywordflow">if</span> (wParam) {
02184                             *(LONG *)wParam = wParamLocal;
02185                         }
02186 
02187                         <span class="keywordflow">if</span> (lParam) {
02188                             *(LONG *)lParam = lParamLocal;
02189                         }
02190 
02191                     } <span class="keywordflow">else</span> {
02192                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02193                         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02194                     }
02195 
02196                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02197 
02198                 } <span class="keywordflow">else</span>
02199                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02200             } <span class="keywordflow">else</span>
02201                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02202         }
02203 
02204     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
02205     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02206 }
02207 
<a name="l02208"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a42">02208</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnEMSETSEL)
02209 {
02210     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
02211 
02212     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02213         <span class="keywordflow">return</span> 0;
02214 
02215     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
02216 
02217         <span class="comment">//</span>
02218         <span class="comment">// temp for our beta...</span>
02219         <span class="comment">//</span>
02220         <span class="comment">// !!! THIS CODE SHOULD BE IN KERNEL MODE !!!</span>
02221         <span class="comment">//</span>
02222         <span class="comment">// to reduce user &lt;-&gt; kernel mode transition...</span>
02223         <span class="comment">//</span>
02224         <span class="keywordflow">if</span> (bAnsi != ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02225             <span class="keywordflow">if</span> (((LONG)wParam &lt;= 0) &amp;&amp; ((LONG)lParam &lt;=0)) {
02226                 <span class="comment">//</span>
02227                 <span class="comment">// if (wParam == 0 or wParam == -1)</span>
02228                 <span class="comment">//               and</span>
02229                 <span class="comment">//    (lParam == 0 or lParam == -1)</span>
02230                 <span class="comment">//</span>
02231                 <span class="comment">// In this case, we don't need to convert the value...</span>
02232                 <span class="comment">//</span>
02233             } <span class="keywordflow">else</span> {
02234                 ULONG  cchTextLength;
02235                 LONG   lOriginalLengthW = (LONG)wParam;
02236                 LONG   lOriginalLengthL = (LONG)lParam;
02237 
02238                 cchTextLength = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02239                                hwnd,
02240                                WM_GETTEXTLENGTH,
02241                                (WPARAM)0,
02242                                (LPARAM)0,
02243                                xParam,
02244                                xpfnProc,
02245                                bAnsi);
02246 
02247                 <span class="keywordflow">if</span> (cchTextLength) {
02248                     PVOID pvString;
02249                     ULONG cbTextLength;
02250 
02251                     cchTextLength++;
02252                     <span class="keywordflow">if</span> (!bAnsi) {
02253                         cbTextLength = cchTextLength * <span class="keyword">sizeof</span>(WCHAR);
02254                     } <span class="keywordflow">else</span> {
02255                         cbTextLength = cchTextLength;
02256                     }
02257 
02258                     pvString = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,cbTextLength);
02259 
02260                     <span class="keywordflow">if</span> (pvString) {
02261 
02262                         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02263                                 hwnd,
02264                                 WM_GETTEXT,
02265                                 cchTextLength,
02266                                 (LPARAM)pvString,
02267                                 xParam,
02268                                 xpfnProc,
02269                                 bAnsi);
02270 
02271                         <span class="keywordflow">if</span> (retval) {
02272                             <span class="keywordflow">if</span> ((LONG)retval &lt; lOriginalLengthW) {
02273                                 lOriginalLengthW = (LONG)retval;
02274                             }
02275                             <span class="keywordflow">if</span> ((LONG)retval &lt; lOriginalLengthL) {
02276                                 lOriginalLengthL = (LONG)retval;
02277                             }
02278                             <span class="keywordflow">if</span> (bAnsi) {
02279                                 <span class="keywordflow">if</span> (lOriginalLengthW &gt; 0) {
02280                                     <a class="code" href="../../d6/d0/usercli_8h.html#a302">CalcUnicodeStringLengthA</a>(pvString, lOriginalLengthW, &amp;wParam);
02281                                 }
02282                                 <span class="keywordflow">if</span>(lOriginalLengthL &gt; 0) {
02283                                     <a class="code" href="../../d6/d0/usercli_8h.html#a302">CalcUnicodeStringLengthA</a>(pvString, lOriginalLengthL, &amp;lParam);
02284                                 }
02285                             } <span class="keywordflow">else</span> {
02286                                 <span class="keywordflow">if</span> (lOriginalLengthW &gt; 0) {
02287                                     <a class="code" href="../../d6/d0/usercli_8h.html#a300">CalcAnsiStringLengthW</a>(pvString, lOriginalLengthW, &amp;wParam);
02288                                 }
02289                                 <span class="keywordflow">if</span>(lOriginalLengthL &gt; 0) {
02290                                     <a class="code" href="../../d6/d0/usercli_8h.html#a300">CalcAnsiStringLengthW</a>(pvString, lOriginalLengthL, &amp;lParam);
02291                                 }
02292                             }
02293                         } <span class="keywordflow">else</span> {
02294                             <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02295                             <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02296                         }
02297 
02298                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02299 
02300                     } <span class="keywordflow">else</span>
02301                         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02302                 } <span class="keywordflow">else</span>
02303                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02304             }
02305         }
02306 
02307         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02308                 hwnd,
02309                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
02310                 wParam,
02311                 lParam,
02312                 xParam,
02313                 xpfnProc,
02314                 bAnsi);
02315 
02316     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
02317     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02318 }
02319 
<a name="l02320"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a43">02320</a> <a class="code" href="../../d7/d9/ntsend_8h.html#a10">MESSAGECALL</a>(fnCBGETEDITSEL)
02321 {
02322     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(hwnd);
02323 
02324     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02325         <span class="keywordflow">return</span> 0;
02326 
02327     <a class="code" href="../../d7/d9/ntsend_8h.html#a1">BEGINCALL</a>()
02328 
02329         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02330                 hwnd,
02331                 <a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>,
02332                 wParam,
02333                 lParam,
02334                 xParam,
02335                 xpfnProc,
02336                 bAnsi);
02337 
02338         <span class="comment">//</span>
02339         <span class="comment">// temp for our beta...</span>
02340         <span class="comment">//</span>
02341         <span class="comment">// !!! THIS CODE SHOULD BE IN KERNEL MODE !!!</span>
02342         <span class="comment">//</span>
02343         <span class="comment">// to reduce user &lt;-&gt; kernel mode transition...</span>
02344         <span class="comment">//</span>
02345         <span class="keywordflow">if</span> (bAnsi != ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>)) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02346             ULONG  cchTextLength;
02347             LONG   lOriginalLengthW = *(LONG *)wParam;
02348             LONG   lOriginalLengthL = *(LONG *)lParam;
02349             LONG   wParamLocal;
02350             LONG   lParamLocal;
02351 
02352             <span class="keywordflow">if</span> (wParam) {
02353                 lOriginalLengthW = *(LONG *)wParam;
02354             } <span class="keywordflow">else</span> {
02355                 lOriginalLengthW = (LONG)(LOWORD(retval));
02356             }
02357 
02358             <span class="keywordflow">if</span> (lParam) {
02359                 lOriginalLengthL = *(LONG *)lParam;
02360             } <span class="keywordflow">else</span> {
02361                 lOriginalLengthL = (LONG)(HIWORD(retval));
02362             }
02363 
02364             cchTextLength = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02365                            hwnd,
02366                            WM_GETTEXTLENGTH,
02367                            (WPARAM)0,
02368                            (LPARAM)0,
02369                            xParam,
02370                            xpfnProc,
02371                            bAnsi);
02372 
02373             <span class="keywordflow">if</span> (cchTextLength) {
02374                 PVOID pvString;
02375                 ULONG cbTextLength;
02376 
02377                 cchTextLength++;
02378                 <span class="keywordflow">if</span> (!bAnsi) {
02379                     cbTextLength = cchTextLength * <span class="keyword">sizeof</span>(WCHAR);
02380                 } <span class="keywordflow">else</span> {
02381                     cbTextLength = cchTextLength;
02382                 }
02383 
02384                 pvString = <a class="code" href="../../d6/d0/usercli_8h.html#a136">UserLocalAlloc</a>(0,cbTextLength);
02385 
02386                 <span class="keywordflow">if</span> (pvString) {
02387 
02388                     retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)<a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a332">NtUserMessageCall</a>(
02389                             hwnd,
02390                             WM_GETTEXT,
02391                             cchTextLength,
02392                             (LPARAM)pvString,
02393                             xParam,
02394                             xpfnProc,
02395                             bAnsi);
02396 
02397                     <span class="keywordflow">if</span> (retval) {
02398                         <span class="keywordflow">if</span> (bAnsi) {
02399                             <span class="comment">/*</span>
02400 <span class="comment">                             * ansiString/unicodeLenght -&gt; ansiLength</span>
02401 <span class="comment">                             */</span>
02402                             <a class="code" href="../../d6/d0/usercli_8h.html#a301">CalcAnsiStringLengthA</a>(pvString, lOriginalLengthW, &amp;wParamLocal);
02403                             <a class="code" href="../../d6/d0/usercli_8h.html#a301">CalcAnsiStringLengthA</a>(pvString, lOriginalLengthL, &amp;lParamLocal);
02404                         } <span class="keywordflow">else</span> {
02405                             <span class="comment">/*</span>
02406 <span class="comment">                             * unicodeString/ansiLenght -&gt; unicodeLength</span>
02407 <span class="comment">                             */</span>
02408                             <a class="code" href="../../d6/d0/usercli_8h.html#a303">CalcUnicodeStringLengthW</a>(pvString, lOriginalLengthW, &amp;wParamLocal);
02409                             <a class="code" href="../../d6/d0/usercli_8h.html#a303">CalcUnicodeStringLengthW</a>(pvString, lOriginalLengthL, &amp;lParamLocal);
02410                         }
02411 
02412                         retval = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(((lParamLocal) &lt;&lt; 16) | ((wParamLocal) &amp; 0x0000FFFF));
02413 
02414                         <span class="keywordflow">if</span> (wParam) {
02415                             *(LONG *)wParam = wParamLocal;
02416                         }
02417 
02418                         <span class="keywordflow">if</span> (lParam) {
02419                             *(LONG *)lParam = lParamLocal;
02420                         }
02421 
02422                     } <span class="keywordflow">else</span> {
02423                         <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02424                         <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02425                     }
02426 
02427                     <a class="code" href="../../d6/d0/usercli_8h.html#a138">UserLocalFree</a>(pvString);
02428 
02429                 } <span class="keywordflow">else</span>
02430                     <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02431             } <span class="keywordflow">else</span>
02432                 <a class="code" href="../../d5/d8/crecv_8c.html#a7">MSGERROR</a>();
02433         }
02434 
02435     <a class="code" href="../../d7/d9/ntsend_8h.html#a3">ERRORTRAP</a>(0);
02436     <a class="code" href="../../d7/d9/ntsend_8h.html#a5">ENDCALL</a>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02437 }
02438 
<a name="l02439"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a44">02439</a> LONG <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a44">BroadcastSystemMessageWorker</a>(
02440     DWORD dwFlags,
02441     LPDWORD lpdwRecipients,
02442     UINT message,
02443     WPARAM wParam,
02444     LPARAM lParam,
02445     BOOL fAnsi)
02446 {
02447     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwRecipients;
02448 
02449     <span class="comment">/*</span>
02450 <span class="comment">     * Prevent apps from setting hi 16 bits so we can use them internally.</span>
02451 <span class="comment">     */</span>
02452     <span class="keywordflow">if</span> (message &amp; <a class="code" href="../../d6/d0/usercli_8h.html#a8">RESERVED_MSG_BITS</a>) {
02453         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid message (%x) for BroadcastSystemMessage\n"</span>, message);
02454         <span class="keywordflow">return</span>(0);
02455     }
02456 
02457     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; ~BSF_VALID) {
02458         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid dwFlags (%x) for BroadcastSystemMessage\n"</span>, <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>);
02459         <span class="keywordflow">return</span>(0);
02460     }
02461 
02462     <span class="comment">//</span>
02463     <span class="comment">// Check if the message number is in the private message range.</span>
02464     <span class="comment">// If so, do not send it to Win4.0 windows.</span>
02465     <span class="comment">// (This is required because apps like SimCity broadcast a message</span>
02466     <span class="comment">// that has the value 0x500 and that confuses MsgSrvr's</span>
02467     <span class="comment">// MSGSRVR_NOTIFY handler.</span>
02468     <span class="comment">//</span>
02469     <span class="keywordflow">if</span> ((message &gt;= WM_USER) &amp;&amp; (message &lt; 0xC000))
02470     {
02471         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid message (%x) for BroadcastSystemMessage\n"</span>, message);
02472         <span class="keywordflow">return</span>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02473     }
02474 
02475     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; BSF_FORCEIFHUNG)
02476         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= BSF_NOHANG;
02477 
02478     <span class="comment">//</span>
02479     <span class="comment">// If BSF_QUERY or message has a pointer, it can not be posted.</span>
02480     <span class="comment">//</span>
02481     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; BSF_QUERY)
02482     {
02483 <span class="preprocessor">#if DBG</span>
02484 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; BSF_ASYNC)
02485         {
02486             RIPMSG0(RIP_ERROR, <span class="stringliteral">"BroadcastSystemMessage: Can't post queries\n"</span>);
02487         }
02488 <span class="preprocessor">#endif</span>
02489 <span class="preprocessor"></span>
02490         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= ~BSF_ASYNC;          <span class="comment">// Strip the BSF_ASYNC flags.</span>
02491     }
02492 
02493     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; BSF_ASYNC) {
02494         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a918">TESTSYNCONLYMESSAGE</a>(message, wParam)) {
02495             RIPERR0(ERROR_MESSAGE_SYNC_ONLY, RIP_WARNING, <span class="stringliteral">"BroadcastSystemMessage: Can't post messages with pointers\n"</span>);
02496             <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp;= ~BSF_ASYNC;          <span class="comment">// Strip the BSF_ASYNC flags.</span>
02497         }
02498     }
02499 
02500 
02501     <span class="comment">// Let us find out who the intended recipients are.</span>
02502     <span class="keywordflow">if</span> (lpdwRecipients != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02503         dwRecipients = *lpdwRecipients;
02504     <span class="keywordflow">else</span>
02505         dwRecipients = BSM_ALLCOMPONENTS;
02506 
02507     <span class="comment">// if they want all components, add the corresponding bits</span>
02508     <span class="keywordflow">if</span> ((dwRecipients &amp; BSM_COMPONENTS) == BSM_ALLCOMPONENTS)
02509         dwRecipients |= (BSM_VXDS | BSM_NETDRIVER | BSM_INSTALLABLEDRIVERS |
02510                              BSM_APPLICATIONS);
02511 
02512 
02513     <span class="keywordflow">if</span> (dwRecipients &amp; ~BSM_VALID) {
02514         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"invalid dwRecipients (%x) for BroadcastSystemMessage\n"</span>, dwRecipients);
02515         <span class="keywordflow">return</span>(0);
02516     }
02517 
02518     <span class="comment">//</span>
02519     <span class="comment">// Check if this is a WM_USERCHANGED message; If so, we want to reload</span>
02520     <span class="comment">// the per-user settings before anyone else sees this message.</span>
02521     <span class="comment">//</span>
02522     <span class="comment">// LATER -- FritzS</span>
02523 <span class="comment">//    if (uiMessage == WM_USERCHANGED)</span>
02524 <span class="comment">//        ReloadPerUserSettings();</span>
02525 
02526 
02527     <span class="comment">// Does this need to be sent to all apps?</span>
02528     <span class="keywordflow">if</span> (dwRecipients &amp; BSM_APPLICATIONS)
02529     {
02530         <a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html">BROADCASTSYSTEMMSGPARAMS</a> bsmParams;
02531 
02532         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o1">dwFlags</a> = <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
02533         bsmParams.<a class="code" href="../../d3/d1/structBROADCASTSYSTEMMSGPARAMS.html#o0">dwRecipients</a> = dwRecipients;
02534 
02535         <span class="keywordflow">return</span> (LONG)<a class="code" href="../../d6/d0/usercli_8h.html#a11">CsSendMessage</a>(<a class="code" href="../../d3/d9/client_2wow_8c.html#a4">GetDesktopWindow</a>(), message, wParam, lParam,
02536             (ULONG_PTR)&amp;bsmParams, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a220">FNID_SENDMESSAGEBSM</a>, fAnsi);
02537     }
02538 
02539     <span class="keywordflow">return</span> -1;
02540 }
02541 
02542 HDEVNOTIFY
<a name="l02543"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a45">02543</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a45">RegisterDeviceNotificationWorker</a>(
02544     IN HANDLE hRecipient,
02545     IN LPVOID NotificationFilter,
02546     IN DWORD Flags,
02547     IN BOOL IsAnsi
02548     )
02549 {
02550     HINSTANCE   hLib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02551     FARPROC     fpRegisterNotification = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02552     PVOID       Context = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02553     HDEVNOTIFY  notifyHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02554     CONFIGRET   <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = CR_SUCCESS;
02555 
02556     <span class="keyword">extern</span>
02557     CONFIGRET
02558     CMP_RegisterNotification(IN  HANDLE   hRecipient,
02559                              IN  LPBYTE   NotificationFilter,
02560                              IN  <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    Flags,
02561                              OUT PVOID   *Context
02562                              );
02563 
02564     UNREFERENCED_PARAMETER(IsAnsi);
02565 
02566     <span class="keywordflow">try</span> {
02567         <span class="comment">//</span>
02568         <span class="comment">// load the config manager client dll and retrieve entry pts</span>
02569         <span class="comment">//</span>
02570         hLib = LoadLibrary(TEXT(<span class="stringliteral">"SETUPAPI.DLL"</span>));
02571         <span class="keywordflow">if</span> (hLib == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02572             <span class="keywordflow">goto</span> Clean0;  <span class="comment">// use last error set by LoadLibrary</span>
02573         }
02574 
02575         fpRegisterNotification = GetProcAddress(hLib, <span class="stringliteral">"CMP_RegisterNotification"</span>);
02576         <span class="keywordflow">if</span> (fpRegisterNotification == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02577             <span class="keywordflow">goto</span> Clean0;    <span class="comment">// use last error set by GetProcAddress</span>
02578         }
02579 
02580         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (CONFIGRET)(fpRegisterNotification)(hRecipient,
02581                                         NotificationFilter,
02582                                         Flags,
02583                                         &amp;Context);
02584 
02585         Clean0:
02586             ;
02587 
02588     } except(W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02589     }
02590 
02591     <span class="keywordflow">if</span> (hLib != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02592         FreeLibrary(hLib);
02593     }
02594 
02595     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != CR_SUCCESS) {
02596 
02597         <span class="comment">//</span>
02598         <span class="comment">//Something went wrong, map the CR errors to a</span>
02599         <span class="comment">//W32 style error code</span>
02600         <span class="comment">//</span>
02601         <span class="keywordflow">switch</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
02602             <span class="keywordflow">case</span> CR_INVALID_POINTER:
02603                 SetLastError (ERROR_INVALID_PARAMETER);
02604                 <span class="keywordflow">break</span>;
02605             <span class="keywordflow">case</span> CR_INVALID_DATA:
02606                 SetLastError (ERROR_INVALID_DATA);
02607                 <span class="keywordflow">break</span>;
02608             <span class="keywordflow">case</span> CR_OUT_OF_MEMORY:
02609                 SetLastError (ERROR_NOT_ENOUGH_MEMORY);
02610                 <span class="keywordflow">break</span>;
02611             <span class="keywordflow">case</span> CR_FAILURE:
02612             <span class="keywordflow">default</span>:
02613                 SetLastError (ERROR_SERVICE_SPECIFIC_ERROR);
02614                 <span class="keywordflow">break</span>;
02615 
02616         }
02617     }
02618 
02619     <span class="keywordflow">if</span> ((Context != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; ((ULONG_PTR)Context != -1)) {
02620         notifyHandle = (HDEVNOTIFY)Context;
02621     }
02622 
02623     <span class="keywordflow">return</span> notifyHandle;
02624 }
02625 
02626 
02627 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l02628"></a><a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a46">02628</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a46">UnregisterDeviceNotification</a>(
02629     IN HDEVNOTIFY Handle
02630     )
02631 {
02632     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>        status = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02633     HINSTANCE   hLib = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02634     FARPROC     fpUnregisterNotification = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02635     CONFIGRET   crStatus = CR_SUCCESS;
02636 
02637     <span class="keyword">extern</span>
02638     CONFIGRET
02639     CMP_UnregisterNotification(IN ULONG Context);
02640 
02641     <span class="keywordflow">try</span> {
02642         <span class="comment">//</span>
02643         <span class="comment">// load the config manager client dll and retrieve entry pts</span>
02644         <span class="comment">//</span>
02645         hLib = LoadLibrary(TEXT(<span class="stringliteral">"SETUPAPI.DLL"</span>));
02646         <span class="keywordflow">if</span> (hLib == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02647             status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02648             <span class="keywordflow">goto</span> Clean0;  <span class="comment">// use last error set by LoadLibrary</span>
02649         }
02650 
02651         fpUnregisterNotification = GetProcAddress(hLib, <span class="stringliteral">"CMP_UnregisterNotification"</span>);
02652         <span class="keywordflow">if</span> (fpUnregisterNotification == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02653             status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02654             <span class="keywordflow">goto</span> Clean0;    <span class="comment">// use last error set by GetProcAddress</span>
02655         }
02656 
02657         crStatus = (CONFIGRET)(fpUnregisterNotification)((ULONG_PTR)<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
02658 
02659         <span class="keywordflow">if</span> (crStatus != CR_SUCCESS) {
02660             status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02661             <span class="comment">//</span>
02662             <span class="comment">//Something went wrong, map the CR errors to a</span>
02663             <span class="comment">//W32 style error code</span>
02664             <span class="comment">//</span>
02665             <span class="keywordflow">switch</span> (crStatus) {
02666                 <span class="keywordflow">case</span> CR_INVALID_POINTER:
02667                     SetLastError (ERROR_INVALID_PARAMETER);
02668                     <span class="keywordflow">break</span>;
02669                 <span class="keywordflow">case</span> CR_INVALID_DATA:
02670                     SetLastError (ERROR_INVALID_DATA);
02671                     <span class="keywordflow">break</span>;
02672                 <span class="keywordflow">case</span> CR_FAILURE:
02673                 <span class="keywordflow">default</span>:
02674                     SetLastError (ERROR_SERVICE_SPECIFIC_ERROR);
02675                     <span class="keywordflow">break</span>;
02676             }
02677         }
02678 
02679         Clean0:
02680             ;
02681 
02682     } except(W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, RIP_WARNING)) {
02683         status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02684     }
02685 
02686     <span class="keywordflow">if</span> (hLib != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02687         FreeLibrary(hLib);
02688     }
02689 
02690     <span class="keywordflow">return</span> status;
02691 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
