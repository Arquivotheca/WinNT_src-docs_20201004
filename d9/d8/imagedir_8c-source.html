<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: imagedir.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>imagedir.c</h1><a href="../../d8/d9/imagedir_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    imagedir.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The module contains the code to translate an image directory type to</span>
00012 <span class="comment">    the address of the data for that entry.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Steve Wood (stevewo) 18-Aug-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    User Mode or Kernel Mode</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00027 
00028 PIMAGE_NT_HEADERS
<a name="l00029"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a0">00029</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a> (
00030     IN PVOID Base
00031     )
00032 
00033 <span class="comment">/*++</span>
00034 <span class="comment"></span>
00035 <span class="comment">Routine Description:</span>
00036 <span class="comment"></span>
00037 <span class="comment">    This function returns the address of the NT Header.</span>
00038 <span class="comment"></span>
00039 <span class="comment">Arguments:</span>
00040 <span class="comment"></span>
00041 <span class="comment">    Base - Supplies the base of the image.</span>
00042 <span class="comment"></span>
00043 <span class="comment">Return Value:</span>
00044 <span class="comment"></span>
00045 <span class="comment">    Returns the address of the NT Header.</span>
00046 <span class="comment"></span>
00047 <span class="comment">--*/</span>
00048 
00049 {
00050 <span class="preprocessor">#if defined (BLDR_KERNEL_RUNTIME) || defined(NTOS_KERNEL_RUNTIME)</span>
00051 <span class="preprocessor"></span>    PIMAGE_NT_HEADERS NtHeaders = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00052 
00053     <span class="keywordflow">if</span> (Base != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Base != (PVOID)-1) {
00054         <span class="keywordflow">if</span> (((PIMAGE_DOS_HEADER)Base)-&gt;e_magic == IMAGE_DOS_SIGNATURE) {
00055             NtHeaders = (PIMAGE_NT_HEADERS)((PCHAR)Base + ((PIMAGE_DOS_HEADER)Base)-&gt;e_lfanew);
00056 
00057 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00058 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Base &lt; MM_HIGHEST_USER_ADDRESS) {
00059                 <span class="keywordflow">if</span> ((PVOID)NtHeaders &gt;= MM_HIGHEST_USER_ADDRESS) {
00060                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00061                 }
00062                 <span class="keywordflow">if</span> ((PVOID)((PCHAR)NtHeaders + <span class="keyword">sizeof</span> (IMAGE_NT_HEADERS)) &gt;= MM_HIGHEST_USER_ADDRESS) {
00063                     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00064                 }
00065             }
00066 <span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
00068             <span class="keywordflow">if</span> (NtHeaders-&gt;Signature != IMAGE_NT_SIGNATURE) {
00069                 NtHeaders = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00070             }
00071         }
00072     }
00073 
00074     <span class="keywordflow">return</span> NtHeaders;
00075 <span class="preprocessor">#else</span>
00076 <span class="preprocessor"></span>    <span class="keywordflow">return</span> RtlpImageNtHeader( Base );
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span>}
00079 
00080 
00081 PIMAGE_SECTION_HEADER
<a name="l00082"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a1">00082</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a> (
00083     IN PIMAGE_NT_HEADERS NtHeaders,
00084     IN PVOID Base,
00085     IN ULONG Address
00086     )
00087 
00088 <span class="comment">/*++</span>
00089 <span class="comment"></span>
00090 <span class="comment">Routine Description:</span>
00091 <span class="comment"></span>
00092 <span class="comment">    This function locates a VirtualAddress within the image header</span>
00093 <span class="comment">    of a file that is mapped as a file and returns a pointer to the</span>
00094 <span class="comment">    section table entry for that virtual address</span>
00095 <span class="comment"></span>
00096 <span class="comment">Arguments:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    NtHeaders - Supplies the pointer to the image or data file.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Base - Supplies the base of the image or data file.</span>
00101 <span class="comment"></span>
00102 <span class="comment">    Address - Supplies the virtual address to locate.</span>
00103 <span class="comment"></span>
00104 <span class="comment">Return Value:</span>
00105 <span class="comment"></span>
00106 <span class="comment">    NULL - The file does not contain data for the specified directory entry.</span>
00107 <span class="comment"></span>
00108 <span class="comment">    NON-NULL - Returns the pointer of the section entry containing the data.</span>
00109 <span class="comment"></span>
00110 <span class="comment">--*/</span>
00111 
00112 {
00113     ULONG i;
00114     PIMAGE_SECTION_HEADER NtSection;
00115 
00116     NtSection = IMAGE_FIRST_SECTION( NtHeaders );
00117     <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
00118         <span class="keywordflow">if</span> ((ULONG)Address &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
00119             (ULONG)Address &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData
00120            ) {
00121             <span class="keywordflow">return</span> NtSection;
00122             }
00123         ++NtSection;
00124         }
00125 
00126     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00127 }
00128 
00129 
00130 PVOID
<a name="l00131"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a2">00131</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a2">RtlAddressInSectionTable</a> (
00132     IN PIMAGE_NT_HEADERS NtHeaders,
00133     IN PVOID Base,
00134     IN ULONG Address
00135     )
00136 
00137 <span class="comment">/*++</span>
00138 <span class="comment"></span>
00139 <span class="comment">Routine Description:</span>
00140 <span class="comment"></span>
00141 <span class="comment">    This function locates a VirtualAddress within the image header</span>
00142 <span class="comment">    of a file that is mapped as a file and returns the seek address</span>
00143 <span class="comment">    of the data the Directory describes.</span>
00144 <span class="comment"></span>
00145 <span class="comment">Arguments:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    NtHeaders - Supplies the pointer to the image or data file.</span>
00148 <span class="comment"></span>
00149 <span class="comment">    Base - Supplies the base of the image or data file.</span>
00150 <span class="comment"></span>
00151 <span class="comment">    Address - Supplies the virtual address to locate.</span>
00152 <span class="comment"></span>
00153 <span class="comment">Return Value:</span>
00154 <span class="comment"></span>
00155 <span class="comment">    NULL - The file does not contain data for the specified directory entry.</span>
00156 <span class="comment"></span>
00157 <span class="comment">    NON-NULL - Returns the address of the raw data the directory describes.</span>
00158 <span class="comment"></span>
00159 <span class="comment">--*/</span>
00160 
00161 {
00162     PIMAGE_SECTION_HEADER NtSection;
00163 
00164     NtSection = <a class="code" href="../../d8/d9/imagedir_8c.html#a1">RtlSectionTableFromVirtualAddress</a>( NtHeaders,
00165                                                    Base,
00166                                                    Address
00167                                                  );
00168     <span class="keywordflow">if</span> (NtSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00169         <span class="keywordflow">return</span>( ((PCHAR)Base + ((ULONG_PTR)Address - NtSection-&gt;VirtualAddress) + NtSection-&gt;PointerToRawData) );
00170         }
00171     <span class="keywordflow">else</span> {
00172         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00173         }
00174 }
00175 
00176 
00177 PVOID
<a name="l00178"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a3">00178</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a3">RtlpImageDirectoryEntryToData32</a> (
00179     IN PVOID Base,
00180     IN BOOLEAN MappedAsImage,
00181     IN USHORT DirectoryEntry,
00182     OUT PULONG Size,
00183     PIMAGE_NT_HEADERS32 NtHeaders
00184     )
00185 {
00186     ULONG DirectoryAddress;
00187 
00188     <span class="keywordflow">if</span> (DirectoryEntry &gt;= NtHeaders-&gt;OptionalHeader.NumberOfRvaAndSizes) {
00189         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00190     }
00191 
00192     <span class="keywordflow">if</span> (!(DirectoryAddress = NtHeaders-&gt;OptionalHeader.DataDirectory[ DirectoryEntry ].VirtualAddress)) {
00193         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00194     }
00195 
00196 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00197 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Base &lt; MM_HIGHEST_USER_ADDRESS) {
00198         <span class="keywordflow">if</span> ((PVOID)((PCHAR)Base + DirectoryAddress) &gt;= MM_HIGHEST_USER_ADDRESS) {
00199             <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00200         }
00201     }
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>
00204     *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = NtHeaders-&gt;OptionalHeader.DataDirectory[ DirectoryEntry ].Size;
00205     <span class="keywordflow">if</span> (MappedAsImage || DirectoryAddress &lt; NtHeaders-&gt;OptionalHeader.SizeOfHeaders) {
00206         <span class="keywordflow">return</span>( (PVOID)((PCHAR)Base + DirectoryAddress) );
00207     }
00208 
00209     <span class="keywordflow">return</span>( <a class="code" href="../../d8/d9/imagedir_8c.html#a2">RtlAddressInSectionTable</a>((PIMAGE_NT_HEADERS)NtHeaders, Base, DirectoryAddress ));
00210 }
00211 
00212 
00213 PVOID
<a name="l00214"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a4">00214</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a4">RtlpImageDirectoryEntryToData64</a> (
00215     IN PVOID Base,
00216     IN BOOLEAN MappedAsImage,
00217     IN USHORT DirectoryEntry,
00218     OUT PULONG Size,
00219     PIMAGE_NT_HEADERS64 NtHeaders
00220     )
00221 {
00222     ULONG DirectoryAddress;
00223 
00224     <span class="keywordflow">if</span> (DirectoryEntry &gt;= NtHeaders-&gt;OptionalHeader.NumberOfRvaAndSizes) {
00225         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00226     }
00227 
00228     <span class="keywordflow">if</span> (!(DirectoryAddress = NtHeaders-&gt;OptionalHeader.DataDirectory[ DirectoryEntry ].VirtualAddress)) {
00229         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00230     }
00231 
00232 <span class="preprocessor">#if defined(NTOS_KERNEL_RUNTIME)</span>
00233 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Base &lt; MM_HIGHEST_USER_ADDRESS) {
00234         <span class="keywordflow">if</span> ((PVOID)((PCHAR)Base + DirectoryAddress) &gt;= MM_HIGHEST_USER_ADDRESS) {
00235             <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00236         }
00237     }
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>
00240     *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = NtHeaders-&gt;OptionalHeader.DataDirectory[ DirectoryEntry ].Size;
00241     <span class="keywordflow">if</span> (MappedAsImage || DirectoryAddress &lt; NtHeaders-&gt;OptionalHeader.SizeOfHeaders) {
00242         <span class="keywordflow">return</span>( (PVOID)((PCHAR)Base + DirectoryAddress) );
00243     }
00244 
00245     <span class="keywordflow">return</span>( <a class="code" href="../../d8/d9/imagedir_8c.html#a2">RtlAddressInSectionTable</a>((PIMAGE_NT_HEADERS)NtHeaders, Base, DirectoryAddress ));
00246 }
00247 
00248 
00249 PVOID
<a name="l00250"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a5">00250</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a> (
00251     IN PVOID Base,
00252     IN BOOLEAN MappedAsImage,
00253     IN USHORT DirectoryEntry,
00254     OUT PULONG Size
00255     )
00256 
00257 <span class="comment">/*++</span>
00258 <span class="comment"></span>
00259 <span class="comment">Routine Description:</span>
00260 <span class="comment"></span>
00261 <span class="comment">    This function locates a Directory Entry within the image header</span>
00262 <span class="comment">    and returns either the virtual address or seek address of the</span>
00263 <span class="comment">    data the Directory describes.</span>
00264 <span class="comment"></span>
00265 <span class="comment">Arguments:</span>
00266 <span class="comment"></span>
00267 <span class="comment">    Base - Supplies the base of the image or data file.</span>
00268 <span class="comment"></span>
00269 <span class="comment">    MappedAsImage - FALSE if the file is mapped as a data file.</span>
00270 <span class="comment">                  - TRUE if the file is mapped as an image.</span>
00271 <span class="comment"></span>
00272 <span class="comment">    DirectoryEntry - Supplies the directory entry to locate.</span>
00273 <span class="comment"></span>
00274 <span class="comment">    Size - Return the size of the directory.</span>
00275 <span class="comment"></span>
00276 <span class="comment">Return Value:</span>
00277 <span class="comment"></span>
00278 <span class="comment">    NULL - The file does not contain data for the specified directory entry.</span>
00279 <span class="comment"></span>
00280 <span class="comment">    NON-NULL - Returns the address of the raw data the directory describes.</span>
00281 <span class="comment"></span>
00282 <span class="comment">--*/</span>
00283 
00284 {
00285     PIMAGE_NT_HEADERS NtHeaders;
00286 
00287     <span class="keywordflow">if</span> ((ULONG_PTR)Base &amp; 0x00000001) {
00288         Base = (PVOID)((ULONG_PTR)Base &amp; ~0x00000001);
00289         MappedAsImage = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00290         }
00291 
00292     NtHeaders = <a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(Base);
00293 
00294     <span class="keywordflow">if</span> (!NtHeaders)
00295         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00296 
00297     <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR32_MAGIC) {
00298         <span class="keywordflow">return</span> (<a class="code" href="../../d8/d9/imagedir_8c.html#a3">RtlpImageDirectoryEntryToData32</a>(Base,
00299                                                 MappedAsImage,
00300                                                 DirectoryEntry,
00301                                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00302                                                 (PIMAGE_NT_HEADERS32)NtHeaders));
00303     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NtHeaders-&gt;OptionalHeader.Magic == IMAGE_NT_OPTIONAL_HDR64_MAGIC) {
00304         <span class="keywordflow">return</span> (<a class="code" href="../../d8/d9/imagedir_8c.html#a4">RtlpImageDirectoryEntryToData64</a>(Base,
00305                                                 MappedAsImage,
00306                                                 DirectoryEntry,
00307                                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00308                                                 (PIMAGE_NT_HEADERS64)NtHeaders));
00309     } <span class="keywordflow">else</span> {
00310         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00311     }
00312 }
00313 
00314 
00315 <span class="preprocessor">#if !defined(NTOS_KERNEL_RUNTIME) &amp;&amp; !defined(BLDR_KERNEL_RUNTIME)</span>
00316 <span class="preprocessor"></span>
00317 PIMAGE_SECTION_HEADER
<a name="l00318"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a6">00318</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a6">RtlImageRvaToSection</a>(
00319     IN PIMAGE_NT_HEADERS NtHeaders,
00320     IN PVOID Base,
00321     IN ULONG Rva
00322     )
00323 
00324 <span class="comment">/*++</span>
00325 <span class="comment"></span>
00326 <span class="comment">Routine Description:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    This function locates an RVA within the image header of a file</span>
00329 <span class="comment">    that is mapped as a file and returns a pointer to the section</span>
00330 <span class="comment">    table entry for that virtual address</span>
00331 <span class="comment"></span>
00332 <span class="comment">Arguments:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    NtHeaders - Supplies the pointer to the image or data file.</span>
00335 <span class="comment"></span>
00336 <span class="comment">    Base - Supplies the base of the image or data file.  The image</span>
00337 <span class="comment">        was mapped as a data file.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    Rva - Supplies the relative virtual address (RVA) to locate.</span>
00340 <span class="comment"></span>
00341 <span class="comment">Return Value:</span>
00342 <span class="comment"></span>
00343 <span class="comment">    NULL - The RVA was not found within any of the sections of the image.</span>
00344 <span class="comment"></span>
00345 <span class="comment">    NON-NULL - Returns the pointer to the image section that contains</span>
00346 <span class="comment">               the RVA</span>
00347 <span class="comment"></span>
00348 <span class="comment">--*/</span>
00349 
00350 {
00351     ULONG i;
00352     PIMAGE_SECTION_HEADER NtSection;
00353 
00354     NtSection = IMAGE_FIRST_SECTION( NtHeaders );
00355     <span class="keywordflow">for</span> (i=0; i&lt;NtHeaders-&gt;FileHeader.NumberOfSections; i++) {
00356         <span class="keywordflow">if</span> (Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
00357             Rva &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData
00358            ) {
00359             <span class="keywordflow">return</span> NtSection;
00360             }
00361         ++NtSection;
00362         }
00363 
00364     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00365 }
00366 
00367 
00368 
00369 PVOID
<a name="l00370"></a><a class="code" href="../../d8/d9/imagedir_8c.html#a7">00370</a> <a class="code" href="../../d8/d9/imagedir_8c.html#a7">RtlImageRvaToVa</a>(
00371     IN PIMAGE_NT_HEADERS NtHeaders,
00372     IN PVOID Base,
00373     IN ULONG Rva,
00374     IN OUT PIMAGE_SECTION_HEADER *LastRvaSection OPTIONAL
00375     )
00376 
00377 <span class="comment">/*++</span>
00378 <span class="comment"></span>
00379 <span class="comment">Routine Description:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    This function locates an RVA within the image header of a file that</span>
00382 <span class="comment">    is mapped as a file and returns the virtual addrees of the</span>
00383 <span class="comment">    corresponding byte in the file.</span>
00384 <span class="comment"></span>
00385 <span class="comment"></span>
00386 <span class="comment">Arguments:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    NtHeaders - Supplies the pointer to the image or data file.</span>
00389 <span class="comment"></span>
00390 <span class="comment">    Base - Supplies the base of the image or data file.  The image</span>
00391 <span class="comment">        was mapped as a data file.</span>
00392 <span class="comment"></span>
00393 <span class="comment">    Rva - Supplies the relative virtual address (RVA) to locate.</span>
00394 <span class="comment"></span>
00395 <span class="comment">    LastRvaSection - Optional parameter that if specified, points</span>
00396 <span class="comment">        to a variable that contains the last section value used for</span>
00397 <span class="comment">        the specified image to translate and RVA to a VA.</span>
00398 <span class="comment"></span>
00399 <span class="comment">Return Value:</span>
00400 <span class="comment"></span>
00401 <span class="comment">    NULL - The file does not contain the specified RVA</span>
00402 <span class="comment"></span>
00403 <span class="comment">    NON-NULL - Returns the virtual addrees in the mapped file.</span>
00404 <span class="comment"></span>
00405 <span class="comment">--*/</span>
00406 
00407 {
00408     PIMAGE_SECTION_HEADER NtSection;
00409 
00410     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( LastRvaSection ) ||
00411         (NtSection = *LastRvaSection) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00412         Rva &lt; NtSection-&gt;VirtualAddress ||
00413         Rva &gt;= NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData
00414        ) {
00415         NtSection = <a class="code" href="../../d8/d9/imagedir_8c.html#a6">RtlImageRvaToSection</a>( NtHeaders,
00416                                           Base,
00417                                           Rva
00418                                         );
00419         }
00420 
00421     <span class="keywordflow">if</span> (NtSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00422         <span class="keywordflow">if</span> (LastRvaSection != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423             *LastRvaSection = NtSection;
00424             }
00425 
00426         <span class="keywordflow">return</span> (PVOID)((PCHAR)Base +
00427                        (Rva - NtSection-&gt;VirtualAddress) +
00428                        NtSection-&gt;PointerToRawData
00429                       );
00430         }
00431     <span class="keywordflow">else</span> {
00432         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00433         }
00434 }
00435 
00436 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
