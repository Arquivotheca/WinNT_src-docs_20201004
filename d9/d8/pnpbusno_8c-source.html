<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpbusno.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpbusno.c</h1><a href="../../d8/d9/pnpbusno_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    pnpbusno.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    Root Bus Number arbiter</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Andy Thornton (andrewth) 04/17/97</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00023 <span class="preprocessor">#pragma hdrstop</span>
00024 <span class="preprocessor"></span>
00025 <span class="comment">//</span>
00026 <span class="comment">// Constants</span>
00027 <span class="comment">//</span>
00028 
00029 
<a name="l00030"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a0">00030</a> <span class="preprocessor">#define MAX_ULONGLONG           ((ULONGLONG) -1)</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// Prototypes</span>
00034 <span class="comment">//</span>
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00037 <a class="code" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize</a>(
00038     VOID
00039     );
00040 
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00042 <a class="code" href="../../d8/d9/pnpbusno_8c.html#a2">IopBusNumberUnpackRequirement</a>(
00043     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00044     OUT PULONGLONG Minimum,
00045     OUT PULONGLONG Maximum,
00046     OUT PULONG Length,
00047     OUT PULONG Alignment
00048     );
00049 
00050 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00051 <a class="code" href="../../d8/d9/pnpbusno_8c.html#a3">IopBusNumberPackResource</a>(
00052     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00053     IN ULONGLONG Start,
00054     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00055     );
00056 
00057 LONG
00058 <a class="code" href="../../d8/d9/pnpbusno_8c.html#a4">IopBusNumberScoreRequirement</a>(
00059     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00060     );
00061 
00062 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00063 <a class="code" href="../../d8/d9/pnpbusno_8c.html#a5">IopBusNumberUnpackResource</a>(
00064     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00065     OUT PULONGLONG Start,
00066     OUT PULONG Length
00067     );
00068 
00069 
00070 <span class="comment">//</span>
00071 <span class="comment">// Make everything pageable</span>
00072 <span class="comment">//</span>
00073 
00074 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00075 <span class="preprocessor"></span>
00076 <span class="preprocessor">#pragma alloc_text(PAGE, IopBusNumberInitialize)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBusNumberUnpackRequirement)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBusNumberPackResource)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBusNumberScoreRequirement)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBusNumberUnpackResource)</span>
00081 <span class="preprocessor"></span>
00082 <span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00083 <span class="preprocessor"></span>
00084 <span class="comment">//</span>
00085 <span class="comment">// Implementation</span>
00086 <span class="comment">//</span>
00087 
00088 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00089"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a1">00089</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a369">IopBusNumberInitialize</a>(
00090     VOID
00091     )
00092 
00093 <span class="comment">/*++</span>
00094 <span class="comment"></span>
00095 <span class="comment">Routine Description:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    This routine initializes the arbiter</span>
00098 <span class="comment"></span>
00099 <span class="comment">Parameters:</span>
00100 <span class="comment"></span>
00101 <span class="comment">    None</span>
00102 <span class="comment"></span>
00103 <span class="comment">Return Value:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    None</span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 
00109 {
00110     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00111 
00112     <a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a> = <a class="code" href="../../d8/d9/pnpbusno_8c.html#a2">IopBusNumberUnpackRequirement</a>;
00113     <a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a> = <a class="code" href="../../d8/d9/pnpbusno_8c.html#a3">IopBusNumberPackResource</a>;
00114     <a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a> = <a class="code" href="../../d8/d9/pnpbusno_8c.html#a5">IopBusNumberUnpackResource</a>;
00115     <a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a> = <a class="code" href="../../d8/d9/pnpbusno_8c.html#a4">IopBusNumberScoreRequirement</a>;
00116 
00117     status = <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>,
00118                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,  <span class="comment">// Indicates a root arbiter</span>
00119                                           CmResourceTypeBusNumber,
00120                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RootBusNumber"</span>,
00121                                           <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Root"</span>,
00122                                           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>    <span class="comment">// no translation of BusNumber</span>
00123                                           );
00124     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Add the invalid range 100 - ffffffff ffffffff</span>
00128         <span class="comment">//</span>
00129         <a class="code" href="../../d2/d5/range_8c.html#a16">RtlAddRange</a>( <a class="code" href="../../d1/d0/pnpdata_8c.html#a34">IopRootBusNumberArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o4">Allocation</a>,
00130                      (ULONGLONG) 0x100,
00131                      (ULONGLONG) -1,
00132                      0, <span class="comment">// UserFlags</span>
00133                      0, <span class="comment">// Flag</span>
00134                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00135                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00136                    );
00137 
00138     }
00139 
00140     <span class="keywordflow">return</span> status;
00141 }
00142 
00143 <span class="comment">//</span>
00144 <span class="comment">// Arbiter callbacks</span>
00145 <span class="comment">//</span>
00146 
00147 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00148"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a2">00148</a> <a class="code" href="../../d8/d9/pnpbusno_8c.html#a2">IopBusNumberUnpackRequirement</a>(
00149     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00150     OUT PULONGLONG Minimum,
00151     OUT PULONGLONG Maximum,
00152     OUT PULONG Length,
00153     OUT PULONG Alignment
00154     )
00155 
00156 <span class="comment">/*++</span>
00157 <span class="comment"></span>
00158 <span class="comment">Routine Description:</span>
00159 <span class="comment"></span>
00160 <span class="comment">    This routine unpacks an resource requirement descriptor.</span>
00161 <span class="comment"></span>
00162 <span class="comment">Arguments:</span>
00163 <span class="comment"></span>
00164 <span class="comment">    Descriptor - The descriptor describing the requirement to unpack.</span>
00165 <span class="comment"></span>
00166 <span class="comment">    Minimum - Pointer to where the minimum acceptable start value should be</span>
00167 <span class="comment">        unpacked to.</span>
00168 <span class="comment"></span>
00169 <span class="comment">    Maximum - Pointer to where the maximum acceptable end value should be</span>
00170 <span class="comment">        unpacked to.</span>
00171 <span class="comment"></span>
00172 <span class="comment">    Length - Pointer to where the required length should be unpacked to.</span>
00173 <span class="comment"></span>
00174 <span class="comment">    Minimum - Pointer to where the required alignment should be unpacked to.</span>
00175 <span class="comment"></span>
00176 <span class="comment">Return Value:</span>
00177 <span class="comment"></span>
00178 <span class="comment">    Returns the status of this operation.</span>
00179 <span class="comment"></span>
00180 <span class="comment">--*/</span>
00181 
00182 {
00183     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00184     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypeBusNumber);
00185 
00186     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00187                 (<span class="stringliteral">"Unpacking BusNumber requirement %p =&gt; 0x%I64x-0x%I64x\n"</span>,
00188                 Descriptor,
00189                 (ULONGLONG) Descriptor-&gt;u.BusNumber.MinBusNumber,
00190                 (ULONGLONG) Descriptor-&gt;u.BusNumber.MaxBusNumber
00191                 ));
00192 
00193     *Minimum = (ULONGLONG) Descriptor-&gt;u.BusNumber.MinBusNumber;
00194     *Maximum = (ULONGLONG) Descriptor-&gt;u.BusNumber.MaxBusNumber;
00195     *Length = Descriptor-&gt;u.BusNumber.Length;
00196     *Alignment = 1;
00197 
00198     <span class="keywordflow">return</span> STATUS_SUCCESS;
00199 
00200 }
00201 
00202 LONG
<a name="l00203"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a4">00203</a> <a class="code" href="../../d8/d9/pnpbusno_8c.html#a4">IopBusNumberScoreRequirement</a>(
00204     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00205     )
00206 
00207 <span class="comment">/*++</span>
00208 <span class="comment"></span>
00209 <span class="comment">Routine Description:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    This routine scores a requirement based on how flexible it is.  The least</span>
00212 <span class="comment">    flexible devices are scored the least and so when the arbitration list is</span>
00213 <span class="comment">    sorted we try to allocate their resources first.</span>
00214 <span class="comment"></span>
00215 <span class="comment">Arguments:</span>
00216 <span class="comment"></span>
00217 <span class="comment">    Descriptor - The descriptor describing the requirement to score.</span>
00218 <span class="comment"></span>
00219 <span class="comment"></span>
00220 <span class="comment">Return Value:</span>
00221 <span class="comment"></span>
00222 <span class="comment">    The score.</span>
00223 <span class="comment"></span>
00224 <span class="comment">--*/</span>
00225 
00226 {
00227     LONG score;
00228 
00229     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00230     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypeBusNumber);
00231 
00232     score = (Descriptor-&gt;u.BusNumber.MaxBusNumber -
00233                 Descriptor-&gt;u.BusNumber.MinBusNumber) /
00234                 Descriptor-&gt;u.BusNumber.Length;
00235 
00236     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00237                 (<span class="stringliteral">"Scoring BusNumber resource %p =&gt; %i\n"</span>,
00238                 Descriptor,
00239                 score
00240                 ));
00241 
00242     <span class="keywordflow">return</span> score;
00243 }
00244 
00245 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00246"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a3">00246</a> <a class="code" href="../../d8/d9/pnpbusno_8c.html#a3">IopBusNumberPackResource</a>(
00247     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00248     IN ULONGLONG Start,
00249     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00250     )
00251 
00252 <span class="comment">/*++</span>
00253 <span class="comment"></span>
00254 <span class="comment">Routine Description:</span>
00255 <span class="comment"></span>
00256 <span class="comment">    This routine packs an resource descriptor.</span>
00257 <span class="comment"></span>
00258 <span class="comment">Arguments:</span>
00259 <span class="comment"></span>
00260 <span class="comment">    Requirement - The requirement from which this resource was chosen.</span>
00261 <span class="comment"></span>
00262 <span class="comment">    Start - The start value of the resource.</span>
00263 <span class="comment"></span>
00264 <span class="comment">    Descriptor - Pointer to the descriptor to pack into.</span>
00265 <span class="comment"></span>
00266 <span class="comment">Return Value:</span>
00267 <span class="comment"></span>
00268 <span class="comment">    Returns the status of this operation.</span>
00269 <span class="comment"></span>
00270 <span class="comment">--*/</span>
00271 
00272 {
00273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00274     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; ((ULONG)-1));
00275     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement);
00276     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement-&gt;Type == CmResourceTypeBusNumber);
00277 
00278     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00279                 (<span class="stringliteral">"Packing BusNumber resource %p =&gt; 0x%I64x\n"</span>,
00280                 Descriptor,
00281                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
00282                 ));
00283 
00284     Descriptor-&gt;Type = CmResourceTypeBusNumber;
00285     Descriptor-&gt;ShareDisposition = Requirement-&gt;ShareDisposition;
00286     Descriptor-&gt;Flags = Requirement-&gt;Flags;
00287     Descriptor-&gt;u.BusNumber.Start = (ULONG) <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00288     Descriptor-&gt;u.BusNumber.Length = Requirement-&gt;u.BusNumber.Length;
00289 
00290     <span class="keywordflow">return</span> STATUS_SUCCESS;
00291 }
00292 
00293 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00294"></a><a class="code" href="../../d8/d9/pnpbusno_8c.html#a5">00294</a> <a class="code" href="../../d8/d9/pnpbusno_8c.html#a5">IopBusNumberUnpackResource</a>(
00295     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00296     OUT PULONGLONG Start,
00297     OUT PULONG Length
00298     )
00299 
00300 <span class="comment">/*++</span>
00301 <span class="comment"></span>
00302 <span class="comment">Routine Description:</span>
00303 <span class="comment"></span>
00304 <span class="comment">    This routine unpacks an resource descriptor.</span>
00305 <span class="comment"></span>
00306 <span class="comment">Arguments:</span>
00307 <span class="comment"></span>
00308 <span class="comment">    Descriptor - The descriptor describing the resource to unpack.</span>
00309 <span class="comment"></span>
00310 <span class="comment">    Start - Pointer to where the start value should be unpacked to.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    End - Pointer to where the end value should be unpacked to.</span>
00313 <span class="comment"></span>
00314 <span class="comment">Return Value:</span>
00315 <span class="comment"></span>
00316 <span class="comment">    Returns the status of this operation.</span>
00317 <span class="comment"></span>
00318 <span class="comment">--*/</span>
00319 
00320 {
00321     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);
00323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Length);
00324     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypeBusNumber);
00325 
00326     *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = (ULONGLONG) Descriptor-&gt;u.BusNumber.Start;
00327     *Length = Descriptor-&gt;u.BusNumber.Length;
00328 
00329     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00330                 (<span class="stringliteral">"Unpacking BusNumber resource %p =&gt; 0x%I64x\n"</span>,
00331                 Descriptor,
00332                 *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
00333                 ));
00334 
00335     <span class="keywordflow">return</span> STATUS_SUCCESS;
00336 
00337 }
00338 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
