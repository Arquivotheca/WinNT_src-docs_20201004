<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heappagi.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heappagi.h</h1><a href="../../d8/d9/heappagi_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1994-2000  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    heappagi.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The following definitions are internal to the debug heap manager,</span>
00012 <span class="comment">    but are placed in this include file so that debugger extensions</span>
00013 <span class="comment">    can reference the same structure definitions.  The following</span>
00014 <span class="comment">    definitions are not intended to be referenced externally except</span>
00015 <span class="comment">    by debugger extensions.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Tom McGuire (TomMcg) 06-Jan-1995</span>
00020 <span class="comment">    Silviu Calinoiu (SilviuC) 22-Feb-2000</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#ifndef _HEAP_PAGE_I_</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#define _HEAP_PAGE_I_</span>
00028 <span class="preprocessor"></span>
00029 <span class="preprocessor">#ifdef DEBUG_PAGE_HEAP</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#include "<a class="code" href="../../d3/d9/heap_8h.html">heap.h</a>"</span>
00032 
00033 <span class="preprocessor">#define DPH_INTERNAL_DEBUG      0   // change to 0 or #undef for production code</span>
00034 <span class="preprocessor"></span>
00035 <span class="comment">//</span>
00036 <span class="comment">// Stack trace size. </span>
00037 <span class="comment">//</span>
00038                                 
00039 <span class="preprocessor">#define DPH_MAX_STACK_LENGTH   16</span>
00040 <span class="preprocessor"></span>
00041 <span class="comment">//</span>
00042 <span class="comment">// Capture stacktraces in any context (x86/alpha, fre/chk). On alpha</span>
00043 <span class="comment">// the stack acquisition function will fail and no stack trace will be</span>
00044 <span class="comment">// acquired but in case we will find a better algorithm the page heap</span>
00045 <span class="comment">// code will automatically take advantage of that.</span>
00046 <span class="comment">//</span>
00047 
00048 <span class="preprocessor">#define DPH_CAPTURE_STACK_TRACE 1</span>
00049 <span class="preprocessor"></span>
00050 <span class="comment">//</span>
00051 <span class="comment">// DPH_HEAP_BLOCK</span>
00052 <span class="comment">//</span>
00053 
00054 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DPH_HEAP_BLOCK DPH_HEAP_BLOCK, *PDPH_HEAP_BLOCK;
00055 
00056 <span class="keyword">struct </span>_DPH_HEAP_BLOCK {
00057 
00058     <span class="comment">//</span>
00059     <span class="comment">//  Singly linked list of allocations (pNextAlloc must be</span>
00060     <span class="comment">//  first member in structure).</span>
00061     <span class="comment">//</span>
00062 
00063     PDPH_HEAP_BLOCK pNextAlloc;
00064 
00065     <span class="comment">//</span>
00066     <span class="comment">//   | PAGE_READWRITE          | PAGE_NOACCESS           |</span>
00067     <span class="comment">//   |____________________|___||_________________________|</span>
00068     <span class="comment">//</span>
00069     <span class="comment">//   ^pVirtualBlock       ^pUserAllocation</span>
00070     <span class="comment">//</span>
00071     <span class="comment">//   |---------------- nVirtualBlockSize ----------------|</span>
00072     <span class="comment">//</span>
00073     <span class="comment">//   |---nVirtualAccessSize----|</span>
00074     <span class="comment">//</span>
00075     <span class="comment">//                        |---|  nUserRequestedSize</span>
00076     <span class="comment">//</span>
00077     <span class="comment">//                        |----|  nUserActualSize</span>
00078     <span class="comment">//</span>
00079 
00080     PUCHAR pVirtualBlock;
00081     SIZE_T  nVirtualBlockSize;
00082 
00083     SIZE_T  nVirtualAccessSize;
00084     PUCHAR pUserAllocation;
00085     SIZE_T  nUserRequestedSize;
00086     SIZE_T  nUserActualSize;
00087     PVOID  UserValue;
00088     ULONG  UserFlags;
00089 
00090     PRTL_TRACE_BLOCK StackTrace;
00091 };
00092 
00093 
00094 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DPH_HEAP_ROOT DPH_HEAP_ROOT, *PDPH_HEAP_ROOT;
00095 
00096 <span class="keyword">struct </span>_DPH_HEAP_ROOT {
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">//  Maintain a signature (DPH_HEAP_SIGNATURE) as the</span>
00100     <span class="comment">//  first value in the heap root structure.</span>
00101     <span class="comment">//</span>
00102 
00103     ULONG                 Signature;
00104     ULONG                 HeapFlags;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  Access to this heap is synchronized with a critical section.</span>
00108     <span class="comment">//</span>
00109 
00110     PRTL_CRITICAL_SECTION HeapCritSect;
00111     ULONG                 nRemoteLockAcquired;
00112 
00113     <span class="comment">//</span>
00114     <span class="comment">//  The "VirtualStorage" list only uses the pVirtualBlock,</span>
00115     <span class="comment">//  nVirtualBlockSize, and nVirtualAccessSize fields of the</span>
00116     <span class="comment">//  HEAP_ALLOCATION structure.  This is the list of virtual</span>
00117     <span class="comment">//  allocation entries that all the heap allocations are</span>
00118     <span class="comment">//  taken from.</span>
00119     <span class="comment">//</span>
00120 
00121     PDPH_HEAP_BLOCK  pVirtualStorageListHead;
00122     PDPH_HEAP_BLOCK  pVirtualStorageListTail;
00123     ULONG                 nVirtualStorageRanges;
00124     SIZE_T                 nVirtualStorageBytes;
00125 
00126     <span class="comment">//</span>
00127     <span class="comment">//  The "Busy" list is the list of active heap allocations.</span>
00128     <span class="comment">//  It is stored in LIFO order to improve temporal locality</span>
00129     <span class="comment">//  for linear searches since most initial heap allocations</span>
00130     <span class="comment">//  tend to remain permanent throughout a process's lifetime.</span>
00131     <span class="comment">//</span>
00132 
00133     PDPH_HEAP_BLOCK  pBusyAllocationListHead;
00134     PDPH_HEAP_BLOCK  pBusyAllocationListTail;
00135     ULONG                 nBusyAllocations;
00136     SIZE_T                 nBusyAllocationBytesCommitted;
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">//  The "Free" list is the list of freed heap allocations, stored</span>
00140     <span class="comment">//  in FIFO order to increase the length of time a freed block</span>
00141     <span class="comment">//  remains on the freed list without being used to satisfy an</span>
00142     <span class="comment">//  allocation request.  This increases the odds of catching</span>
00143     <span class="comment">//  a reference-after-freed bug in an app.</span>
00144     <span class="comment">//</span>
00145 
00146     PDPH_HEAP_BLOCK  pFreeAllocationListHead;
00147     PDPH_HEAP_BLOCK  pFreeAllocationListTail;
00148     ULONG                 nFreeAllocations;
00149     SIZE_T                 nFreeAllocationBytesCommitted;
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">//  The "Available" list is stored in address-sorted order to facilitate</span>
00153     <span class="comment">//  coalescing.  When an allocation request cannot be satisfied from the</span>
00154     <span class="comment">//  "Available" list, it is attempted from the free list.  If it cannot</span>
00155     <span class="comment">//  be satisfied from the free list, the free list is coalesced into the</span>
00156     <span class="comment">//  available list.  If the request still cannot be satisfied from the</span>
00157     <span class="comment">//  coalesced available list, new VM is added to the available list.</span>
00158     <span class="comment">//</span>
00159 
00160     PDPH_HEAP_BLOCK  pAvailableAllocationListHead;
00161     PDPH_HEAP_BLOCK  pAvailableAllocationListTail;
00162     ULONG                 nAvailableAllocations;
00163     SIZE_T                 nAvailableAllocationBytesCommitted;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">//  The "UnusedNode" list is simply a list of available node</span>
00167     <span class="comment">//  entries to place "Busy", "Free", or "Virtual" entries.</span>
00168     <span class="comment">//  When freed nodes get coalesced into a single free node,</span>
00169     <span class="comment">//  the other "unused" node goes on this list.  When a new</span>
00170     <span class="comment">//  node is needed (like an allocation not satisfied from the</span>
00171     <span class="comment">//  free list), the node comes from this list if it's not empty.</span>
00172     <span class="comment">//</span>
00173 
00174     PDPH_HEAP_BLOCK  pUnusedNodeListHead;
00175     PDPH_HEAP_BLOCK  pUnusedNodeListTail;
00176     ULONG                 nUnusedNodes;
00177 
00178     SIZE_T                 nBusyAllocationBytesAccessible;
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">//  Node pools need to be tracked so they can be protected</span>
00182     <span class="comment">//  from app scribbling on them.</span>
00183     <span class="comment">//</span>
00184 
00185     PDPH_HEAP_BLOCK  pNodePoolListHead;
00186     PDPH_HEAP_BLOCK  pNodePoolListTail;
00187     ULONG                 nNodePools;
00188     SIZE_T                 nNodePoolBytes;
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">//  Doubly linked list of DPH heaps in process is tracked through this.</span>
00192     <span class="comment">//</span>
00193 
00194     PDPH_HEAP_ROOT        pNextHeapRoot;
00195     PDPH_HEAP_ROOT        pPrevHeapRoot;
00196 
00197     ULONG                 nUnProtectionReferenceCount;
00198     ULONG                 InsideAllocateNode;           <span class="comment">// only for debugging</span>
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">// These are extra flags used to control page heap behavior.</span>
00202     <span class="comment">// During heap creation the current value of the global page heap</span>
00203     <span class="comment">// flags (process wise) is written into this field.</span>
00204     <span class="comment">//</span>
00205 
00206     ULONG                 ExtraFlags;
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Seed for the random generator used to decide from where</span>
00210     <span class="comment">// should we make an allocation (normal or verified heap).</span>
00211     <span class="comment">// The field is protected by the critical section associated</span>
00212     <span class="comment">// with each page heap.</span>
00213     <span class="comment">//</span>
00214 
00215     ULONG                  <a class="code" href="../../d4/d4/tprefix_8c.html#a2">Seed</a>;
00216     ULONG                  Counter[16];
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// `NormalHeap' is used in case we want to combine verified allocations</span>
00220     <span class="comment">// with normal ones. This is useful to minimize memory impact. Without</span>
00221     <span class="comment">// this feature certain processes that are very heap intensive cannot</span>
00222     <span class="comment">// be verified at all.</span>
00223     <span class="comment">//</span>
00224 
00225     PVOID                 NormalHeap;
00226 
00227     <span class="comment">//</span>
00228     <span class="comment">// Heap creation stack trace.</span>
00229     <span class="comment">//</span>
00230 
00231     PRTL_TRACE_BLOCK      CreateStackTrace;
00232 };
00233 
00234 
00235 <span class="comment">//</span>
00236 <span class="comment">// Page heap and global counters</span>
00237 <span class="comment">//</span>
00238 
00239 <span class="preprocessor">#define DPH_COUNTER_SIZE_BELOW_1K            0</span>
00240 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_SIZE_BELOW_4K            1</span>
00241 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_SIZE_ABOVE_4K            2</span>
00242 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_BLOCK_INFORMATION     3</span>
00243 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_ALLOCS             4</span>
00244 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_REALLOCS           5</span>
00245 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_FREES              6</span>
00246 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_NORMAL_ALLOCS      7</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_NORMAL_REALLOCS    8</span>
00248 <span class="preprocessor"></span><span class="preprocessor">#define DPH_COUNTER_NO_OF_NORMAL_FREES       9</span>
00249 <span class="preprocessor"></span>
00250 <span class="comment">//</span>
00251 <span class="comment">// DPH_BLOCK_INFORMATION</span>
00252 <span class="comment">//</span>
00253 <span class="comment">// This structure is stored in every page heap allocated block</span>
00254 <span class="comment">// if allocation size permits to stuff the info. It is completely</span>
00255 <span class="comment">// redundant information. Its purpose is to ease debugging.</span>
00256 <span class="comment">//</span>
00257 <span class="comment">// If there is not enough empty space in the allocation (e.g. size</span>
00258 <span class="comment">// of the allocation is close to PAGE_SIZE) then we will not force</span>
00259 <span class="comment">// this information because this will modify the required size of</span>
00260 <span class="comment">// the block and the memory usage pattern.</span>
00261 <span class="comment">//</span>
00262 <span class="comment">// This information is not saved if the catch backward overruns</span>
00263 <span class="comment">// flag is set.</span>
00264 <span class="comment">//</span>
00265 
00266 <span class="preprocessor">#define DPH_NORMAL_BLOCK_START_STAMP_ALLOCATED   0xABCDAAAA</span>
00267 <span class="preprocessor"></span><span class="preprocessor">#define DPH_NORMAL_BLOCK_END_STAMP_ALLOCATED     0xDCBAAAAA</span>
00268 <span class="preprocessor"></span><span class="preprocessor">#define DPH_NORMAL_BLOCK_START_STAMP_FREE        (0xABCDAAAA - 1)</span>
00269 <span class="preprocessor"></span><span class="preprocessor">#define DPH_NORMAL_BLOCK_END_STAMP_FREE          (0xDCBAAAAA - 1)</span>
00270 <span class="preprocessor"></span>
00271 <span class="preprocessor">#define DPH_PAGE_BLOCK_START_STAMP_ALLOCATED     0xABCDBBBB</span>
00272 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_END_STAMP_ALLOCATED       0xDCBABBBB</span>
00273 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_START_STAMP_FREE          (0xABCDBBBB - 1)</span>
00274 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_END_STAMP_FREE            (0xDCBABBBB - 1)</span>
00275 <span class="preprocessor"></span>
00276 <span class="comment">//silviuc:obsolete</span>
00277 <span class="preprocessor">#define DPH_BLOCK_INFORMATION_TRACE_SIZE 9</span>
00278 <span class="preprocessor"></span>
00279 <span class="preprocessor">#define DPH_NORMAL_BLOCK_SUFFIX         0xA0</span>
00280 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_PREFIX       0xB0</span>
00281 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_INFIX        0xC0</span>
00282 <span class="preprocessor"></span><span class="preprocessor">#define DPH_PAGE_BLOCK_SUFFIX       0xD0</span>
00283 <span class="preprocessor"></span><span class="preprocessor">#define DPH_NORMAL_BLOCK_INFIX      0xE0</span>
00284 <span class="preprocessor"></span><span class="preprocessor">#define DPH_FREE_BLOCK_INFIX        0xF0</span>
00285 <span class="preprocessor"></span>
00286 <span class="keyword">typedef</span> <span class="keyword">struct </span>_DPH_BLOCK_INFORMATION {
00287 
00288     ULONG StartStamp;
00289 
00290     PVOID Heap;
00291     SIZE_T RequestedSize;
00292     SIZE_T ActualSize;
00293     LIST_ENTRY <a class="code" href="../../d6/d3/queue_8c.html#a46">FreeQueue</a>;
00294     PVOID StackTrace;
00295     
00296     ULONG EndStamp;
00297 
00298     <span class="comment">//</span>
00299     <span class="comment">// (SilviuC): This structure needs to be 8-byte aligned.</span>
00300     <span class="comment">// If it is not, applications expecting aligned blocks will get</span>
00301     <span class="comment">// unaligned ones because this structure will prefix their</span>
00302     <span class="comment">// allocations. Internet Explorer is one such application</span>
00303     <span class="comment">// that stops working in these conditions.</span>
00304     <span class="comment">//</span>
00305 
00306 } DPH_BLOCK_INFORMATION, * PDPH_BLOCK_INFORMATION;
00307 
00308 <span class="comment">//</span>
00309 <span class="comment">// Error reasons used in debug messages</span>
00310 <span class="comment">//</span>
00311 
00312 <span class="preprocessor">#define DPH_SUCCESS                           0x0000</span>
00313 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_START_STAMP       0x0001</span>
00314 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_END_STAMP         0x0002</span>
00315 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_HEAP_POINTER      0x0004</span>
00316 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_PREFIX_PATTERN    0x0008</span>
00317 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_SUFFIX_PATTERN    0x0010</span>
00318 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_RAISED_EXCEPTION            0x0020</span>
00319 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_NO_NORMAL_HEAP              0x0040</span>
00320 <span class="preprocessor"></span><span class="preprocessor">#define DPH_ERROR_CORRUPTED_INFIX_PATTERN     0x0080</span>
00321 <span class="preprocessor"></span>
00322 
00323 <span class="preprocessor">#endif // DEBUG_PAGE_HEAP</span>
00324 <span class="preprocessor"></span>
00325 <span class="preprocessor">#endif // _HEAP_PAGE_I_</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
