<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obdir.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obdir.c</h1><a href="../../d8/d0/obdir_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    obdir.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Directory Object routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 31-Mar-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateDirectoryObject)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenDirectoryObject)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQueryDirectoryObject)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpLookupDirectoryEntry)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 
00031 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00032"></a><a class="code" href="../../d8/d0/obdir_8c.html#a0">00032</a> <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a> (
00033     OUT PHANDLE DirectoryHandle,
00034     IN ACCESS_MASK DesiredAccess,
00035     IN POBJECT_ATTRIBUTES ObjectAttributes
00036     )
00037 
00038 <span class="comment">/*++</span>
00039 <span class="comment"></span>
00040 <span class="comment">Routine Description:</span>
00041 <span class="comment"></span>
00042 <span class="comment">    This routine creates a new directory object according to user</span>
00043 <span class="comment">    specified object attributes</span>
00044 <span class="comment"></span>
00045 <span class="comment">Arguments:</span>
00046 <span class="comment"></span>
00047 <span class="comment">    DirectoryHandle - Receives the handle for the newly created</span>
00048 <span class="comment">        directory object</span>
00049 <span class="comment"></span>
00050 <span class="comment">    DesiredAccess - Supplies the access being requested for this</span>
00051 <span class="comment">        new directory object</span>
00052 <span class="comment"></span>
00053 <span class="comment">    ObjectAttributes - Supplies caller specified attributes for new</span>
00054 <span class="comment">        directory object</span>
00055 <span class="comment"></span>
00056 <span class="comment">Return Value:</span>
00057 <span class="comment"></span>
00058 <span class="comment">    An appropriate status value.</span>
00059 <span class="comment"></span>
00060 <span class="comment">--*/</span>
00061 
00062 {
00063     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
00064     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00065     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00067 
00068     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00069 
00070     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"NtCreateDirectoryObject"</span> );
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00074     <span class="comment">//</span>
00075 
00076     PreviousMode = KeGetPreviousMode();
00077 
00078     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00079 
00080         <span class="keywordflow">try</span> {
00081 
00082             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> );
00083 
00084         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00085 
00086             <span class="keywordflow">return</span>( GetExceptionCode() );
00087         }
00088     }
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  Allocate and initialize a new Directory Object.  We don't need</span>
00092     <span class="comment">//  to specify a parse context or charge any quota.  The size of</span>
00093     <span class="comment">//  the object body is simply a directory object.  This call gets</span>
00094     <span class="comment">//  us a new referenced object.</span>
00095     <span class="comment">//</span>
00096 
00097     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00098                              <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00099                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00100                              PreviousMode,
00101                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00102                              <span class="keyword">sizeof</span>( *<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> ),
00103                              0,
00104                              0,
00105                              (PVOID *)&amp;<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> );
00106 
00107     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00108 
00109         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00110     }
00111 
00112     RtlZeroMemory( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>, <span class="keyword">sizeof</span>( *<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> ) );
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">//  Insert directory object in the current processes handle table,</span>
00116     <span class="comment">//  set directory handle value and return status.</span>
00117     <span class="comment">//</span>
00118     <span class="comment">//  **** If the insert fails should we backout the create?</span>
00119     <span class="comment">//</span>
00120 
00121     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>,
00122                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00123                              DesiredAccess,
00124                              0,
00125                              (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00126                              &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00127 
00128     <span class="keywordflow">try</span> {
00129 
00130         *<a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00131 
00132     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00133 
00134         <span class="comment">//</span>
00135         <span class="comment">//  Fall through, since we do not want to undo what we have done.</span>
00136         <span class="comment">//</span>
00137     }
00138 
00139     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00140 }
00141 
00142 
00143 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00144"></a><a class="code" href="../../d8/d0/obdir_8c.html#a1">00144</a> <a class="code" href="../../d8/d0/obdir_8c.html#a1">NtOpenDirectoryObject</a> (
00145     OUT PHANDLE DirectoryHandle,
00146     IN ACCESS_MASK DesiredAccess,
00147     IN POBJECT_ATTRIBUTES ObjectAttributes
00148     )
00149 
00150 <span class="comment">/*++</span>
00151 <span class="comment"></span>
00152 <span class="comment">Routine Description:</span>
00153 <span class="comment"></span>
00154 <span class="comment">    This routine opens an existing directory object.</span>
00155 <span class="comment"></span>
00156 <span class="comment">Arguments:</span>
00157 <span class="comment"></span>
00158 <span class="comment">    DirectoryHandle - Receives the handle for the newly opened directory</span>
00159 <span class="comment">        object</span>
00160 <span class="comment"></span>
00161 <span class="comment">    DesiredAccess - Supplies the access being requested for this</span>
00162 <span class="comment">        directory object</span>
00163 <span class="comment"></span>
00164 <span class="comment">    ObjectAttributes - Supplies caller specified attributes for the</span>
00165 <span class="comment">        directory object</span>
00166 <span class="comment"></span>
00167 <span class="comment">Return Value:</span>
00168 <span class="comment"></span>
00169 <span class="comment">    An appropriate status value.</span>
00170 <span class="comment"></span>
00171 <span class="comment">--*/</span>
00172 
00173 {
00174     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00175     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00176     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00177 
00178     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00179 
00180     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"NtOpenDirectoryObject"</span> );
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00184     <span class="comment">//</span>
00185 
00186     PreviousMode = KeGetPreviousMode();
00187 
00188     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00189 
00190         <span class="keywordflow">try</span> {
00191 
00192             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> );
00193 
00194         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00195 
00196             <span class="keywordflow">return</span>( GetExceptionCode() );
00197         }
00198     }
00199 
00200     <span class="comment">//</span>
00201     <span class="comment">//  Open handle to the directory object with the specified desired access,</span>
00202     <span class="comment">//  set directory handle value, and return service completion status.</span>
00203     <span class="comment">//</span>
00204 
00205     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00206                                  <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00207                                  PreviousMode,
00208                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00209                                  DesiredAccess,
00210                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00211                                  &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00212 
00213     <span class="keywordflow">try</span> {
00214 
00215         *<a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00216 
00217     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00218 
00219         <span class="comment">//</span>
00220         <span class="comment">//  Fall through, since we do not want to undo what we have done.</span>
00221         <span class="comment">//</span>
00222     }
00223 
00224     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00225 }
00226 
00227 
00228 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00229"></a><a class="code" href="../../d8/d0/obdir_8c.html#a2">00229</a> <a class="code" href="../../d8/d0/obdir_8c.html#a2">NtQueryDirectoryObject</a> (
00230     IN HANDLE DirectoryHandle,
00231     OUT PVOID Buffer,
00232     IN ULONG Length,
00233     IN BOOLEAN ReturnSingleEntry,
00234     IN BOOLEAN RestartScan,
00235     IN OUT PULONG Context,
00236     OUT PULONG ReturnLength OPTIONAL
00237     )
00238 
00239 <span class="comment">/*++</span>
00240 <span class="comment"></span>
00241 <span class="comment">Routine Description:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    This function returns information regarding a specified object</span>
00244 <span class="comment">    directory.</span>
00245 <span class="comment"></span>
00246 <span class="comment">Arguments:</span>
00247 <span class="comment"></span>
00248 <span class="comment">    DirectoryHandle - Supplies a handle to the directory being queried</span>
00249 <span class="comment"></span>
00250 <span class="comment">    Buffer - Supplies the output buffer to receive the directory</span>
00251 <span class="comment">        information.  On return this contains one or more OBJECT DIRECTORY</span>
00252 <span class="comment">        INFORMATION structures, the last one being null.  And then this is</span>
00253 <span class="comment">        followed by the string names for the directory entries.</span>
00254 <span class="comment"></span>
00255 <span class="comment">    Length - Supplies the length, in bytes, of the user supplied output</span>
00256 <span class="comment">        buffer</span>
00257 <span class="comment"></span>
00258 <span class="comment">    ReturnSingleEntry - Indicates if this routine should just return</span>
00259 <span class="comment">        one entry in the directory</span>
00260 <span class="comment"></span>
00261 <span class="comment">    RestartScan - Indicates if we are to restart the scan or continue</span>
00262 <span class="comment">        relative to the enumeration context passed in as the next</span>
00263 <span class="comment">        parameter</span>
00264 <span class="comment"></span>
00265 <span class="comment">    Context - Supplies an enumeration context that must be resupplied</span>
00266 <span class="comment">        to this routine on subsequent calls to keep the enumeration</span>
00267 <span class="comment">        in sync</span>
00268 <span class="comment"></span>
00269 <span class="comment">    ReturnLength - Optionally receives the length, in bytes, that this</span>
00270 <span class="comment">        routine has stuffed into the output buffer</span>
00271 <span class="comment"></span>
00272 <span class="comment">Return Value:</span>
00273 <span class="comment"></span>
00274 <span class="comment">    An appropriate status value.</span>
00275 <span class="comment"></span>
00276 <span class="comment">--*/</span>
00277 
00278 {
00279     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
00280     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> DirectoryEntry;
00281     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00282     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00283     UNICODE_STRING ObjectName;
00284     POBJECT_DIRECTORY_INFORMATION DirInfo;
00285     PWCH NameBuffer;
00286     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288     ULONG Bucket, EntryNumber, CapturedContext;
00289     ULONG TotalLengthNeeded, LengthNeeded, EntriesFound;
00290     PCHAR TempBuffer;
00291 
00292     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00293 
00294     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"NtQueryDirectoryObject"</span> );
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00298     <span class="comment">//</span>
00299 
00300     PreviousMode = KeGetPreviousMode();
00301 
00302     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00303 
00304         <span class="keywordflow">try</span> {
00305 
00306             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, Length, <span class="keyword">sizeof</span>( WCHAR ) );
00307             <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( Context );
00308 
00309             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00310 
00311                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ReturnLength );
00312             }
00313 
00314             <span class="keywordflow">if</span> (RestartScan) {
00315 
00316                 CapturedContext = 0;
00317 
00318             } <span class="keywordflow">else</span> {
00319 
00320                 CapturedContext = *Context;
00321             }
00322 
00323         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00324 
00325             <span class="keywordflow">return</span>( GetExceptionCode() );
00326         }
00327 
00328     } <span class="keywordflow">else</span> {
00329 
00330         <span class="keywordflow">if</span> (RestartScan) {
00331 
00332             CapturedContext = 0;
00333 
00334         } <span class="keywordflow">else</span> {
00335 
00336             CapturedContext = *Context;
00337         }
00338     }
00339 
00340     <span class="comment">//</span>
00341     <span class="comment">//  Allocate space for a temporary work buffer, make sure we got it,</span>
00342     <span class="comment">//  and then zero it out.  Make sure the buffer is large enough to</span>
00343     <span class="comment">//  hold at least one dir info record.  This will make the logic work</span>
00344     <span class="comment">//  better when the a bad length is passed in.</span>
00345     <span class="comment">//</span>
00346 
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">//  Test for 64 bit if Length + sizeof( OBJECT_DIRECTORY_INFORMATION ) is less than Length</span>
00350     <span class="comment">//  Return STATUS_INVALID_PARAMETER if there is an overflow</span>
00351     <span class="comment">//</span>
00352 
00353     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/obp_8h.html#a28">ObpIsOverflow</a>( Length, <span class="keyword">sizeof</span>( OBJECT_DIRECTORY_INFORMATION ))) {
00354 
00355         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00356     }
00357 
00358     TempBuffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00359                                         Length + <span class="keyword">sizeof</span>( OBJECT_DIRECTORY_INFORMATION ),
00360                                         'mNbO' );
00361 
00362     <span class="keywordflow">if</span> (TempBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00363 
00364         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00365     }
00366 
00367     RtlZeroMemory( TempBuffer, Length );
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">//  Reference the directory object</span>
00371     <span class="comment">//</span>
00372 
00373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( <a class="code" href="../../d3/d3/tob_8c.html#a23">DirectoryHandle</a>,
00374                                         DIRECTORY_QUERY,
00375                                         <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>,
00376                                         PreviousMode,
00377                                         (PVOID *)&amp;<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>,
00378                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00379 
00380     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00381 
00382         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TempBuffer );
00383 
00384         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00385     }
00386 
00387     <span class="comment">//</span>
00388     <span class="comment">//  Lock down the directory structures for the life of this</span>
00389     <span class="comment">//  procedure</span>
00390     <span class="comment">//</span>
00391 
00392     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00393 
00394     <span class="comment">//</span>
00395     <span class="comment">//  DirInfo is used to march through the output buffer filling</span>
00396     <span class="comment">//  in directory information.  We'll start off by making sure</span>
00397     <span class="comment">//  there is room for a NULL entry at end.</span>
00398     <span class="comment">//</span>
00399 
00400     DirInfo = (POBJECT_DIRECTORY_INFORMATION)TempBuffer;
00401 
00402     TotalLengthNeeded = <span class="keyword">sizeof</span>( *DirInfo );
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">//  Keep track of the number of entries found and actual</span>
00406     <span class="comment">//  entry that we are processing</span>
00407     <span class="comment">//</span>
00408 
00409     EntryNumber = 0;
00410     EntriesFound = 0;
00411 
00412     <span class="comment">//</span>
00413     <span class="comment">//  By default we'll say there are no more entries until the</span>
00414     <span class="comment">//  following loop put in some data</span>
00415     <span class="comment">//</span>
00416 
00417     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MORE_ENTRIES;
00418 
00419     <span class="comment">//</span>
00420     <span class="comment">//  Our outer loop processes each hash bucket in the directory object</span>
00421     <span class="comment">//</span>
00422 
00423     <span class="keywordflow">for</span> (Bucket=0; Bucket&lt;<a class="code" href="../../d4/d0/ob_8h.html#a0">NUMBER_HASH_BUCKETS</a>; Bucket++) {
00424 
00425         DirectoryEntry = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;HashBuckets[ Bucket ];
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">//  For this hash bucket we'll zip through its list of entries.</span>
00429         <span class="comment">//  This is a singly linked list so when the next pointer is null</span>
00430         <span class="comment">//  (i.e., false) we at the end of the hash list</span>
00431         <span class="comment">//</span>
00432 
00433         <span class="keywordflow">while</span> (DirectoryEntry) {
00434 
00435             <span class="comment">//</span>
00436             <span class="comment">//  The captured context is simply the entry count unless the</span>
00437             <span class="comment">//  user specified otherwise we start at zero, which means</span>
00438             <span class="comment">//  the first entry is always returned in the enumeration.</span>
00439             <span class="comment">//  If we have an match based on the entry index then we</span>
00440             <span class="comment">//  process this entry.  We bump the captured context further</span>
00441             <span class="comment">//  done in the code.</span>
00442             <span class="comment">//</span>
00443 
00444             <span class="keywordflow">if</span> (CapturedContext == EntryNumber++) {
00445 
00446                 <span class="comment">//</span>
00447                 <span class="comment">//  For this directory entry we'll get a pointer to the</span>
00448                 <span class="comment">//  object body and see if it has an object name.  If it</span>
00449                 <span class="comment">//  doesn't have a name then we'll give it an empty name.</span>
00450                 <span class="comment">//</span>
00451 
00452                 ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> );
00453                 NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00454 
00455                 <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00456 
00457                     ObjectName = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>;
00458 
00459                 } <span class="keywordflow">else</span> {
00460 
00461                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;ObjectName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00462                 }
00463 
00464                 <span class="comment">//</span>
00465                 <span class="comment">//  Now compute the length needed for this entry.  This would</span>
00466                 <span class="comment">//  be the size of the object directory information record,</span>
00467                 <span class="comment">//  plus the size of the object name and object type name both</span>
00468                 <span class="comment">//  null terminated.</span>
00469                 <span class="comment">//</span>
00470 
00471                 LengthNeeded = <span class="keyword">sizeof</span>( *DirInfo ) +
00472                                ObjectName.Length + <span class="keyword">sizeof</span>( UNICODE_NULL ) +
00473                                ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00474 
00475                 <span class="comment">//</span>
00476                 <span class="comment">//  If there isn't enough room then take the following error</span>
00477                 <span class="comment">//  path.   If the user wanted a single entry then tell the</span>
00478                 <span class="comment">//  caller what length is really needed and say the buffer was</span>
00479                 <span class="comment">//  too small.  Otherwise the user wanted multiple entries,</span>
00480                 <span class="comment">//  so we'll just say there are more entries in the directory.</span>
00481                 <span class="comment">//  In both cases we drop down the entry number because we</span>
00482                 <span class="comment">//  weren't able to fit it in on this call</span>
00483                 <span class="comment">//</span>
00484 
00485                 <span class="keywordflow">if</span> ((TotalLengthNeeded + LengthNeeded) &gt; Length) {
00486 
00487                     <span class="keywordflow">if</span> (ReturnSingleEntry) {
00488 
00489                         TotalLengthNeeded += LengthNeeded;
00490 
00491                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00492 
00493                     } <span class="keywordflow">else</span> {
00494 
00495                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MORE_ENTRIES;
00496                     }
00497 
00498                     EntryNumber -= 1;
00499                     <span class="keywordflow">goto</span> querydone;
00500                 }
00501 
00502                 <span class="comment">//</span>
00503                 <span class="comment">//  The information will fit in the buffer.  So now fill</span>
00504                 <span class="comment">//  in the output buffer.  We temporarily put in pointers</span>
00505                 <span class="comment">//  to the name buffer as stored in the object and object</span>
00506                 <span class="comment">//  type.  We copy the data buffer to the user buffer</span>
00507                 <span class="comment">//  right before we return to the caller</span>
00508                 <span class="comment">//</span>
00509 
00510                 <span class="keywordflow">try</span> {
00511 
00512                     DirInfo-&gt;Name.Length            = ObjectName.Length;
00513                     DirInfo-&gt;Name.MaximumLength     = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ObjectName.Length+<span class="keyword">sizeof</span>( UNICODE_NULL ));
00514                     DirInfo-&gt;Name.Buffer            = ObjectName.Buffer;
00515 
00516                     DirInfo-&gt;TypeName.Length        = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>.Length;
00517                     DirInfo-&gt;TypeName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>.Length+<span class="keyword">sizeof</span>( UNICODE_NULL ));
00518                     DirInfo-&gt;TypeName.Buffer        = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a>.Buffer;
00519 
00520                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00521 
00522                 } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00523 
00524                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00525                 }
00526 
00527                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00528 
00529                     <span class="keywordflow">goto</span> querydone;
00530                 }
00531 
00532                 <span class="comment">//</span>
00533                 <span class="comment">//  Update the total number of bytes needed in this query.</span>
00534                 <span class="comment">//  Push the dir info pointer to the next output location,</span>
00535                 <span class="comment">//  and indicate how many entries we've processed</span>
00536                 <span class="comment">//</span>
00537                 <span class="comment">//</span>
00538 
00539                 TotalLengthNeeded += LengthNeeded;
00540 
00541                 DirInfo++;
00542                 EntriesFound++;
00543 
00544                 <span class="comment">//</span>
00545                 <span class="comment">//  If we are to return only one entry then move on to the</span>
00546                 <span class="comment">//  post processing phase, otherwise indicate that we're</span>
00547                 <span class="comment">//  processing the next entry and go back to the top of</span>
00548                 <span class="comment">//  the inner loop</span>
00549                 <span class="comment">//</span>
00550 
00551                 <span class="keywordflow">if</span> (ReturnSingleEntry) {
00552 
00553                     <span class="keywordflow">goto</span> querydone;
00554 
00555                 } <span class="keywordflow">else</span> {
00556 
00557                     <span class="comment">//</span>
00558                     <span class="comment">//  Bump the captured context by one entry.</span>
00559                     <span class="comment">//</span>
00560 
00561                     CapturedContext++;
00562                 }
00563             }
00564 
00565             <span class="comment">//</span>
00566             <span class="comment">//  Get the next directory entry from the singly linked hash</span>
00567             <span class="comment">//  bucket chain</span>
00568             <span class="comment">//</span>
00569 
00570             DirectoryEntry = DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
00571         }
00572     }
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">//  At this point we've processed the directory entries and the first</span>
00576     <span class="comment">//  part of the output buffer now contains a bunch of object directory</span>
00577     <span class="comment">//  information records,  but the pointers in them refer to the wrong</span>
00578     <span class="comment">//  copies.  So now we have some fixup to do.</span>
00579     <span class="comment">//</span>
00580 
00581 querydone:
00582 
00583     <span class="keywordflow">try</span> {
00584 
00585         <span class="comment">//</span>
00586         <span class="comment">//  We'll only do this post processing if we've been successful</span>
00587         <span class="comment">//  so far.  Note that this means we could be returning in the</span>
00588         <span class="comment">//  user's output buffer system address that are meaningless, but</span>
00589         <span class="comment">//  then getting back an error status should tell the caller to</span>
00590         <span class="comment">//  forget about everything in the output buffer.  Given back</span>
00591         <span class="comment">//  a system address also isn't harmful because there is nothing</span>
00592         <span class="comment">//  that the user can really do with it.</span>
00593         <span class="comment">//</span>
00594 
00595         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00596 
00597             <span class="comment">//</span>
00598             <span class="comment">//  Null terminate the string of object directory information</span>
00599             <span class="comment">//  records and point to where the actual names will go</span>
00600             <span class="comment">//</span>
00601 
00602             RtlZeroMemory( DirInfo, <span class="keyword">sizeof</span>( *DirInfo ));
00603 
00604             DirInfo++;
00605 
00606             NameBuffer = (PWCH)DirInfo;
00607 
00608             <span class="comment">//</span>
00609             <span class="comment">//  Now for every entry that we've put in the output buffer</span>
00610             <span class="comment">//  DirInfo will point to the entry and EntriesFound kept the</span>
00611             <span class="comment">//  count.  Note that we are guaranteed space because of</span>
00612             <span class="comment">//  the math we did earlier in computing TotalLengthNeeded.</span>
00613             <span class="comment">//</span>
00614 
00615             DirInfo = (POBJECT_DIRECTORY_INFORMATION)TempBuffer;
00616 
00617             <span class="keywordflow">while</span> (EntriesFound--) {
00618 
00619                 <span class="comment">//</span>
00620                 <span class="comment">//  Copy over the object name, set the dir info pointer into</span>
00621                 <span class="comment">//  the user's buffer, then null terminate the string.  Note</span>
00622                 <span class="comment">//  that we are really copying the data into our temp buffer</span>
00623                 <span class="comment">//  but the pointer fix up is for the user's buffer which</span>
00624                 <span class="comment">//  we'll copy into right after this loop.</span>
00625                 <span class="comment">//</span>
00626 
00627                 RtlMoveMemory( NameBuffer,
00628                                DirInfo-&gt;Name.Buffer,
00629                                DirInfo-&gt;Name.Length );
00630 
00631                 DirInfo-&gt;Name.Buffer = (PVOID)((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((ULONG_PTR)NameBuffer - (ULONG_PTR)TempBuffer));
00632                 NameBuffer           = (PWCH)((ULONG_PTR)NameBuffer + DirInfo-&gt;Name.Length);
00633                 *NameBuffer++        = UNICODE_NULL;
00634 
00635                 <span class="comment">//</span>
00636                 <span class="comment">//  Do the same copy with the object type name</span>
00637                 <span class="comment">//</span>
00638 
00639                 RtlMoveMemory( NameBuffer,
00640                                DirInfo-&gt;TypeName.Buffer,
00641                                DirInfo-&gt;TypeName.Length );
00642 
00643                 DirInfo-&gt;TypeName.Buffer = (PVOID)((ULONG_PTR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + ((ULONG_PTR)NameBuffer - (ULONG_PTR)TempBuffer));
00644                 NameBuffer               = (PWCH)((ULONG_PTR)NameBuffer + DirInfo-&gt;TypeName.Length);
00645                 *NameBuffer++            = UNICODE_NULL;
00646 
00647                 <span class="comment">//</span>
00648                 <span class="comment">//  Move on to the next dir info record</span>
00649                 <span class="comment">//</span>
00650 
00651                 DirInfo++;
00652             }
00653 
00654             <span class="comment">//</span>
00655             <span class="comment">//  Set the enumeration context to the entry number of the next</span>
00656             <span class="comment">//  entry to return.</span>
00657             <span class="comment">//</span>
00658 
00659             *Context = EntryNumber;
00660         }
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">//  Copy over the results from our temp buffer to the users buffer.</span>
00664         <span class="comment">//  But adjust the amount copied just in case the total length needed</span>
00665         <span class="comment">//  exceeds the length we allocated.</span>
00666         <span class="comment">//</span>
00667 
00668         RtlMoveMemory( <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
00669                        TempBuffer,
00670                        (TotalLengthNeeded &lt;= Length ? TotalLengthNeeded : Length) );
00671 
00672         <span class="comment">//</span>
00673         <span class="comment">//  In all cases we'll tell the caller how much space if really needed</span>
00674         <span class="comment">//  provided the user asked for this information</span>
00675         <span class="comment">//</span>
00676 
00677         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnLength )) {
00678 
00679             *ReturnLength = TotalLengthNeeded;
00680         }
00681 
00682     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00683 
00684         <span class="comment">//</span>
00685         <span class="comment">//  Fall through, since we do not want to undo what we have done.</span>
00686         <span class="comment">//</span>
00687     }
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  Unlock the directroy structures, dereference the directory object,</span>
00691     <span class="comment">//  free up our temp buffer, and return to our caller</span>
00692     <span class="comment">//</span>
00693 
00694     <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00695 
00696     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> );
00697 
00698     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TempBuffer );
00699 
00700     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00701 }
00702 
00703 
00704 PVOID
<a name="l00705"></a><a class="code" href="../../d5/d1/obp_8h.html#a68">00705</a> <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a> (
00706     IN <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory,
00707     IN PUNICODE_STRING Name,
00708     IN ULONG Attributes
00709     )
00710 
00711 <span class="comment">/*++</span>
00712 <span class="comment"></span>
00713 <span class="comment">Routine Description:</span>
00714 <span class="comment"></span>
00715 <span class="comment">    This routine will lookup a single directory entry in a given directory.</span>
00716 <span class="comment"></span>
00717 <span class="comment">    I believe this routine assumes that it is called with the root directory</span>
00718 <span class="comment">    locked.</span>
00719 <span class="comment"></span>
00720 <span class="comment">    Also note that this routine does not reference the returned object</span>
00721 <span class="comment"></span>
00722 <span class="comment">Arguments:</span>
00723 <span class="comment"></span>
00724 <span class="comment">    Directory - Supplies the directory being searched</span>
00725 <span class="comment"></span>
00726 <span class="comment">    Name - Supplies the name of entry we're looking for</span>
00727 <span class="comment"></span>
00728 <span class="comment">    Attributes - Indicates if the lookup should be case insensitive</span>
00729 <span class="comment">        or not</span>
00730 <span class="comment"></span>
00731 <span class="comment">Return Value:</span>
00732 <span class="comment"></span>
00733 <span class="comment">    Returns a pointer to the corresponding object body if found and NULL</span>
00734 <span class="comment">    otherwise.</span>
00735 <span class="comment"></span>
00736 <span class="comment">--*/</span>
00737 
00738 {
00739     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
00740     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> DirectoryEntry;
00741     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00742     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00743     PWCH <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00744     WCHAR Wchar;
00745     ULONG HashIndex;
00746     ULONG WcharLength;
00747     BOOLEAN CaseInSensitive;
00748 
00749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">//  The caller needs to specify both a directory and a name otherwise</span>
00753     <span class="comment">//  we can't process the request</span>
00754     <span class="comment">//</span>
00755 
00756     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || !<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) {
00757 
00758         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// BUG BUG</span>
00759     }
00760 
00761     <span class="comment">//</span>
00762     <span class="comment">//  Set a local variable to tell us if the search is case sensitive</span>
00763     <span class="comment">//</span>
00764 
00765     <span class="keywordflow">if</span> (Attributes &amp; OBJ_CASE_INSENSITIVE) {
00766 
00767         CaseInSensitive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768 
00769     } <span class="keywordflow">else</span> {
00770 
00771         CaseInSensitive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00772     }
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">//  Establish our local pointer to the input name buffer and get the</span>
00776     <span class="comment">//  number of unicode characters in the input name.  Also make sure</span>
00777     <span class="comment">//  the caller gave us a non null name</span>
00778     <span class="comment">//</span>
00779 
00780     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00781     WcharLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>( *Buffer );
00782 
00783     <span class="keywordflow">if</span> (!WcharLength || !<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00784 
00785         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// BUG BUG</span>
00786     }
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">//  Compute the address of the head of the bucket chain for this name.</span>
00790     <span class="comment">//</span>
00791 
00792     HashIndex = 0;
00793     <span class="keywordflow">while</span> (WcharLength--) {
00794 
00795         Wchar = *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00796         HashIndex += (HashIndex &lt;&lt; 1) + (HashIndex &gt;&gt; 1);
00797 
00798         <span class="keywordflow">if</span> (Wchar &lt; <span class="charliteral">'a'</span>) {
00799 
00800             HashIndex += Wchar;
00801 
00802         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wchar &gt; <span class="charliteral">'z'</span>) {
00803 
00804             HashIndex += <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>( Wchar );
00805 
00806         } <span class="keywordflow">else</span> {
00807 
00808             HashIndex += (Wchar - (<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>));
00809         }
00810     }
00811 
00812     HashIndex %= <a class="code" href="../../d4/d0/ob_8h.html#a0">NUMBER_HASH_BUCKETS</a>;
00813 
00814     HeadDirectoryEntry = (<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *)&amp;<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;HashBuckets[ HashIndex ];
00815 
00816     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket = HeadDirectoryEntry;
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">//  Walk the chain of directory entries for this hash bucket, looking</span>
00820     <span class="comment">//  for either a match, or the insertion point if no match in the chain.</span>
00821     <span class="comment">//</span>
00822 
00823     <span class="keywordflow">while</span> ((DirectoryEntry = *HeadDirectoryEntry) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00824 
00825         <span class="comment">//</span>
00826         <span class="comment">//  Get the object header and name from the object body</span>
00827         <span class="comment">//</span>
00828         <span class="comment">//  This function assumes the name must exist, otherwise it</span>
00829         <span class="comment">//  wouldn't be in a directory</span>
00830         <span class="comment">//</span>
00831 
00832         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> );
00833         NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">//  Compare strings using appropriate function.</span>
00837         <span class="comment">//</span>
00838 
00839         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length) &amp;&amp;
00840             <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00841                                    &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
00842                                    CaseInSensitive )) {
00843 
00844             <span class="comment">//</span>
00845             <span class="comment">//  If name matches, then exit loop with DirectoryEntry</span>
00846             <span class="comment">//  pointing to matching entry.</span>
00847             <span class="comment">//</span>
00848 
00849             <span class="keywordflow">break</span>;
00850         }
00851 
00852         HeadDirectoryEntry = &amp;DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
00853     }
00854 
00855     <span class="comment">//</span>
00856     <span class="comment">//  At this point, there are two possiblilities:</span>
00857     <span class="comment">//</span>
00858     <span class="comment">//   - we found an entry that matched and DirectoryEntry points to that</span>
00859     <span class="comment">//     entry.  Update the bucket chain so that the entry found is at the</span>
00860     <span class="comment">//     head of the bucket chain.  This is so the ObpDeleteDirectoryEntry</span>
00861     <span class="comment">//     and ObpInsertDirectoryEntry functions will work.  Also repeated</span>
00862     <span class="comment">//     lookups of the same name will succeed quickly.</span>
00863     <span class="comment">//</span>
00864     <span class="comment">//   - we did not find an entry that matched and DirectoryEntry is NULL.</span>
00865     <span class="comment">//</span>
00866 
00867     <span class="keywordflow">if</span> (DirectoryEntry) {
00868 
00869         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00870 
00871         <span class="comment">//</span>
00872         <span class="comment">//  The following convoluted piece of code moves a directory entry</span>
00873         <span class="comment">//  we've found to the front of the hash list.</span>
00874         <span class="comment">//</span>
00875 
00876         <span class="keywordflow">if</span> (HeadDirectoryEntry != <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket) {
00877 
00878             *HeadDirectoryEntry = DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
00879             DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = *(<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket);
00880             *(<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket) = DirectoryEntry;
00881         }
00882 
00883         <span class="comment">//</span>
00884         <span class="comment">//  Now return the object to our caller</span>
00885         <span class="comment">//</span>
00886 
00887         <span class="keywordflow">return</span>( DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> );
00888 
00889     } <span class="keywordflow">else</span> {
00890 
00891         <span class="comment">//</span>
00892         <span class="comment">//  Otherwise we didn't find anything so return null</span>
00893         <span class="comment">//</span>
00894 
00895         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00896 
00897         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00898     }
00899 }
00900 
00901 
00902 BOOLEAN
<a name="l00903"></a><a class="code" href="../../d5/d1/obp_8h.html#a69">00903</a> <a class="code" href="../../d5/d1/obp_8h.html#a69">ObpInsertDirectoryEntry</a> (
00904     IN <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory,
00905     IN PVOID Object
00906     )
00907 
00908 <span class="comment">/*++</span>
00909 <span class="comment"></span>
00910 <span class="comment">Routine Description:</span>
00911 <span class="comment"></span>
00912 <span class="comment">    This routine will insert a new directory entry into a directory</span>
00913 <span class="comment">    object.  The directory must have already have been searched using</span>
00914 <span class="comment">    ObpLookupDirectoryEntry because that routine sets the LookupBucket</span>
00915 <span class="comment"></span>
00916 <span class="comment">Arguments:</span>
00917 <span class="comment"></span>
00918 <span class="comment">    Directory - Supplies the directory object being modified.  This</span>
00919 <span class="comment">        function assumes that we earlier did a lookup on the name</span>
00920 <span class="comment">        that was successful or we just did an insertion</span>
00921 <span class="comment"></span>
00922 <span class="comment">    Object - Supplies the object to insert into the directory</span>
00923 <span class="comment"></span>
00924 <span class="comment">Return Value:</span>
00925 <span class="comment"></span>
00926 <span class="comment">    TRUE if the object is inserted successfully and FALSE otherwise</span>
00927 <span class="comment"></span>
00928 <span class="comment">--*/</span>
00929 
00930 {
00931     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
00932     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> NewDirectoryEntry;
00933     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00934 
00935     <span class="comment">//</span>
00936     <span class="comment">//  Make sure we have a directory and that the last search was</span>
00937     <span class="comment">//  successful, meaning there is a lookupbuket</span>
00938     <span class="comment">//</span>
00939 
00940     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound) {
00941 
00942         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00943     }
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">//  Also verify that we have a good lookupbucket</span>
00947     <span class="comment">//</span>
00948 
00949     HeadDirectoryEntry = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket;
00950 
00951     <span class="keywordflow">if</span> (!HeadDirectoryEntry) {
00952 
00953         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00954     }
00955 
00956     <span class="comment">//</span>
00957     <span class="comment">//  Translate the object into a name info record, and make sure</span>
00958     <span class="comment">//  that the object has a name</span>
00959     <span class="comment">//</span>
00960 
00961     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object ) );
00962 
00963     <span class="keywordflow">if</span> (NameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00964 
00965         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00966     }
00967 
00968     <span class="comment">//</span>
00969     <span class="comment">//  Allocate memory for a new entry, and fail if not enough memory.</span>
00970     <span class="comment">//</span>
00971 
00972     NewDirectoryEntry = (<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00973                                                                         <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">OBJECT_DIRECTORY_ENTRY</a> ),
00974                                                                         'iDbO' );
00975 
00976     <span class="keywordflow">if</span> (NewDirectoryEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977 
00978         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00979     }
00980 
00981     <span class="comment">//</span>
00982     <span class="comment">//  Link the new entry into the chain at the insertion point.</span>
00983     <span class="comment">//  This puts the new object right at the head of the current</span>
00984     <span class="comment">//  hash bucket chain</span>
00985     <span class="comment">//</span>
00986 
00987     NewDirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = *HeadDirectoryEntry;
00988     *HeadDirectoryEntry = NewDirectoryEntry;
00989     NewDirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> = Object;
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">//  Point the object header back to the directory we just inserted</span>
00993     <span class="comment">//  it into.</span>
00994     <span class="comment">//</span>
00995 
00996     NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">//  Return success.</span>
01000     <span class="comment">//</span>
01001 
01002     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01003 
01004     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01005 }
01006 
01007 
01008 BOOLEAN
<a name="l01009"></a><a class="code" href="../../d5/d1/obp_8h.html#a70">01009</a> <a class="code" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a> (
01010     IN <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory
01011     )
01012 
01013 <span class="comment">/*++</span>
01014 <span class="comment"></span>
01015 <span class="comment">Routine Description:</span>
01016 <span class="comment"></span>
01017 <span class="comment">    This routine deletes the most recently found directory entry from</span>
01018 <span class="comment">    the specified directory object.  It will only succeed after a</span>
01019 <span class="comment">    successful ObpLookupDirectoryEntry call.</span>
01020 <span class="comment"></span>
01021 <span class="comment">Arguments:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    Directory - Supplies the directory being modified</span>
01024 <span class="comment"></span>
01025 <span class="comment">Return Value:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    TRUE if the deletion succeeded and FALSE otherwise</span>
01028 <span class="comment"></span>
01029 <span class="comment">--*/</span>
01030 
01031 {
01032     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
01033     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> DirectoryEntry;
01034 
01035     <span class="comment">//</span>
01036     <span class="comment">//  Make sure we have a directory and that it has a found entry</span>
01037     <span class="comment">//</span>
01038 
01039     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || !<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound) {
01040 
01041         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01042     }
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">//  Also make sure that the lookup bucket is valid</span>
01046     <span class="comment">//</span>
01047 
01048     HeadDirectoryEntry = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket;
01049 
01050     <span class="keywordflow">if</span> (!HeadDirectoryEntry) {
01051 
01052         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01053     }
01054 
01055     DirectoryEntry = *HeadDirectoryEntry;
01056 
01057     <span class="keywordflow">if</span> (!DirectoryEntry) {
01058 
01059         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01060     }
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  Unlink the entry from the head of the bucket chain and free the</span>
01064     <span class="comment">//  memory for the entry.</span>
01065     <span class="comment">//</span>
01066 
01067     *HeadDirectoryEntry = DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
01068     DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01069 
01070     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DirectoryEntry );
01071 
01072     <span class="comment">//</span>
01073     <span class="comment">//  Return success</span>
01074     <span class="comment">//</span>
01075 
01076     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01077 }
01078 
01079 
01080 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01081"></a><a class="code" href="../../d5/d1/obp_8h.html#a71">01081</a> <a class="code" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a> (
01082     IN HANDLE RootDirectoryHandle OPTIONAL,
01083     IN PUNICODE_STRING ObjectName,
01084     IN ULONG Attributes,
01085     IN <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType,
01086     IN KPROCESSOR_MODE AccessMode,
01087     IN PVOID ParseContext OPTIONAL,
01088     IN PSECURITY_QUALITY_OF_SERVICE SecurityQos OPTIONAL,
01089     IN PVOID InsertObject OPTIONAL,
01090     IN OUT <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
01091     OUT PBOOLEAN DirectoryLocked,
01092     OUT PVOID *FoundObject
01093     )
01094 
01095 <span class="comment">/*++</span>
01096 <span class="comment"></span>
01097 <span class="comment">Routine Description:</span>
01098 <span class="comment"></span>
01099 <span class="comment">    This function will search a given directoroy for a specified</span>
01100 <span class="comment">    object name.  It will also create a new object specified by</span>
01101 <span class="comment">    InsertObject.</span>
01102 <span class="comment"></span>
01103 <span class="comment">Arguments:</span>
01104 <span class="comment"></span>
01105 <span class="comment">    RootDirectoryHandle - Optionally supplies the directory being</span>
01106 <span class="comment">        searched.  If not supplied then this routine searches</span>
01107 <span class="comment">        the root directory</span>
01108 <span class="comment"></span>
01109 <span class="comment">    ObjectName - Supplies the name of object to lookup</span>
01110 <span class="comment"></span>
01111 <span class="comment">    Attributes - Specifies the attributes for the lookup (e.g., case</span>
01112 <span class="comment">        insensitive)</span>
01113 <span class="comment"></span>
01114 <span class="comment">    ObjectType - Specifies the type of the object to lookup</span>
01115 <span class="comment"></span>
01116 <span class="comment">    AccessMode - Specifies the callers processor mode</span>
01117 <span class="comment"></span>
01118 <span class="comment">    ParseContext - Optionally supplies a parse context that is blindly</span>
01119 <span class="comment">        passed to the parse callback routines</span>
01120 <span class="comment"></span>
01121 <span class="comment">    SecurityQos - Optionally supplies a pointer to the passed Security</span>
01122 <span class="comment">        Quality of Service parameter that is blindly passed to the parse</span>
01123 <span class="comment">        callback routines</span>
01124 <span class="comment"></span>
01125 <span class="comment">    InsertObject - Optionally supplies the object we think will be found.</span>
01126 <span class="comment">        This is used if the caller did not give a root directory handle</span>
01127 <span class="comment">        and the object name is "\" and the root object directory hasn't</span>
01128 <span class="comment">        been created yet.  In other cases where we wind up creating</span>
01129 <span class="comment">        a new directory entry this is the object inserted.</span>
01130 <span class="comment"></span>
01131 <span class="comment">    AccessState - Current access state, describing already granted access</span>
01132 <span class="comment">        types, the privileges used to get them, and any access types yet to</span>
01133 <span class="comment">        be granted.  The access masks may not contain any generic access</span>
01134 <span class="comment">        types.</span>
01135 <span class="comment"></span>
01136 <span class="comment">    DirectoryLocked - Receives an indication if this routine has returned</span>
01137 <span class="comment">        with the input directory locked</span>
01138 <span class="comment"></span>
01139 <span class="comment">    FoundObject - Receives a pointer to the object body if found</span>
01140 <span class="comment"></span>
01141 <span class="comment">Return Value:</span>
01142 <span class="comment"></span>
01143 <span class="comment">    An appropriate status value</span>
01144 <span class="comment"></span>
01145 <span class="comment">--*/</span>
01146 
01147 {
01148     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> RootDirectory;
01149     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
01150     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> ParentDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01151     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01152     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01153     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01154     PVOID Object;
01155     UNICODE_STRING RemainingName;
01156     UNICODE_STRING ComponentName;
01157     PWCH <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
01158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01159     BOOLEAN Reparse;
01160     ULONG MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;
01161     <a class="code" href="../../d4/d0/ob_8h.html#a26">OB_PARSE_METHOD</a> ParseProcedure;
01162     <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>;
01163 
01164     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpLookupObjectName"</span> );
01165 
01166     <span class="comment">//</span>
01167     <span class="comment">//  Initialize our output variables to say we haven't lock or found</span>
01168     <span class="comment">//  anything but we were successful at it</span>
01169     <span class="comment">//</span>
01170 
01171     *DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01172     *FoundObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01173     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01174 
01175     Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01176 
01177     <span class="comment">//</span>
01178     <span class="comment">//  Check if the caller has given us a directory to search.  Otherwise</span>
01179     <span class="comment">//  we'll search the root object directory</span>
01180     <span class="comment">//</span>
01181 
01182     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RootDirectoryHandle )) {
01183 
01184         <span class="comment">//</span>
01185         <span class="comment">//  Otherwise reference the directory object and make sure</span>
01186         <span class="comment">//  that we successfully got the object</span>
01187         <span class="comment">//</span>
01188 
01189         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( RootDirectoryHandle,
01190                                             0,
01191                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01192                                             AccessMode,
01193                                             (PVOID *)&amp;RootDirectory,
01194                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01195 
01196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01197 
01198             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01199         }
01200 
01201         <span class="comment">//</span>
01202         <span class="comment">//  Translate the directory object to its object header</span>
01203         <span class="comment">//</span>
01204 
01205         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( RootDirectory );
01206 
01207         <span class="comment">//</span>
01208         <span class="comment">//  Now if the name we're looking up starts with a "\" and it</span>
01209         <span class="comment">//  does not have a parse procedure then the syntax is bad</span>
01210         <span class="comment">//</span>
01211 
01212         <span class="keywordflow">if</span> ((ObjectName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01213             (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) &amp;&amp;
01214             (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != <a class="code" href="../../d5/d8/fssup_8c.html#a3">IoFileObjectType</a>)) {
01215 
01216             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01217 
01218             <span class="keywordflow">return</span>( STATUS_OBJECT_PATH_SYNTAX_BAD );
01219         }
01220 
01221         <span class="comment">//</span>
01222         <span class="comment">//  Now make sure that we do not have the directory of the</span>
01223         <span class="comment">//  object types</span>
01224         <span class="comment">//</span>
01225 
01226         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> != <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>) {
01227 
01228             <span class="comment">//</span>
01229             <span class="comment">//  We have an object directory that is not the object type</span>
01230             <span class="comment">//  directory.  So now if it doesn't have a parse routine</span>
01231             <span class="comment">//  then there is nothing we can</span>
01232             <span class="comment">//</span>
01233 
01234             <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01235 
01236                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01237 
01238                 <span class="keywordflow">return</span>( STATUS_INVALID_HANDLE );
01239 
01240             } <span class="keywordflow">else</span> {
01241 
01242                 MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;
01243 
01244                 <span class="comment">//</span>
01245                 <span class="comment">//  The following loop cycles cycles through the various</span>
01246                 <span class="comment">//  parse routine to we could encounter trying to resolve</span>
01247                 <span class="comment">//  this name through symbolic links.</span>
01248                 <span class="comment">//</span>
01249 
01250                 <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01251 
01252                     KIRQL SaveIrql;
01253 
01254                     RemainingName = *ObjectName;
01255 
01256                     <span class="comment">//</span>
01257                     <span class="comment">//  Invoke the callback routine to parse the remaining</span>
01258                     <span class="comment">//  object name</span>
01259                     <span class="comment">//</span>
01260 
01261                     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01262 
01263                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a>)( RootDirectory,
01264                                                                              ObjectType,
01265                                                                              AccessState,
01266                                                                              AccessMode,
01267                                                                              Attributes,
01268                                                                              ObjectName,
01269                                                                              &amp;RemainingName,
01270                                                                              ParseContext,
01271                                                                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>,
01272                                                                              &amp;Object );
01273 
01274                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Parse"</span>, ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>, Object );
01275 
01276                     <span class="comment">//</span>
01277                     <span class="comment">//  If the status was not to do a reparse and the lookup</span>
01278                     <span class="comment">//  was not successful then we found nothing so we</span>
01279                     <span class="comment">//  dereference the directory and return the status to</span>
01280                     <span class="comment">//  our caller.  If the object we got back was null then</span>
01281                     <span class="comment">//  we'll tell our caller that we couldn't find the name.</span>
01282                     <span class="comment">//  Lastly if we did not get a reparse and we were</span>
01283                     <span class="comment">//  successful and the object is not null then everything</span>
01284                     <span class="comment">//  gets nicely returned to our caller</span>
01285                     <span class="comment">//</span>
01286 
01287                     <span class="keywordflow">if</span> ( ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_REPARSE ) &amp;&amp; 
01288                          ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_REPARSE_OBJECT )) {
01289 
01290                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01291 
01292                             Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01293 
01294                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Object == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01295 
01296                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01297                         }
01298     
01299                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01300 
01301                         *FoundObject = Object;
01302                         
01303                         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01304 
01305                     <span class="comment">//</span>
01306                     <span class="comment">//  We got a status reparse, which means the object</span>
01307                     <span class="comment">//  name has been modified to have use start all over</span>
01308                     <span class="comment">//  again.  If the reparse target is now empty or it</span>
01309                     <span class="comment">//  is a path separator then we start the parse at the</span>
01310                     <span class="comment">//  root directory</span>
01311                     <span class="comment">//</span>
01312 
01313                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectName-&gt;Length == 0) ||
01314                                (ObjectName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01315                                (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
01316 
01317                         <span class="comment">//</span>
01318                         <span class="comment">//  Restart the parse relative to the root directory.</span>
01319                         <span class="comment">//</span>
01320 
01321                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01322 
01323                         RootDirectory = <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>;
01324                         RootDirectoryHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01325 
01326                         <span class="keywordflow">break</span>;
01327 
01328                     <span class="comment">//</span>
01329                     <span class="comment">//  We got a reparse and we actually have a new name to</span>
01330                     <span class="comment">//  go to we if we haven't exhausted our reparse attempts</span>
01331                     <span class="comment">//  yet then just continue to the top of this loop.</span>
01332                     <span class="comment">//</span>
01333 
01334                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (--MaxReparse) {
01335 
01336                         <span class="keywordflow">continue</span>;
01337 
01338                     <span class="comment">//</span>
01339                     <span class="comment">//  We got a reparse and we've exhausted our times through</span>
01340                     <span class="comment">//  the loop so we'll return what we found.</span>
01341                     <span class="comment">//</span>
01342                     <span class="comment">//  **** this doesn't seem right.  It probably should be</span>
01343                     <span class="comment">//  an error</span>
01344                     <span class="comment">//</span>
01345 
01346                     } <span class="keywordflow">else</span> {
01347 
01348                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01349 
01350                         *FoundObject = Object;
01351 
01352                         <span class="comment">//</span>
01353                         <span class="comment">//  At this point we were failing in stress by</span>
01354                         <span class="comment">//  returning to the caller with a success status but</span>
01355                         <span class="comment">//  a null object pointer.</span>
01356                         <span class="comment">//</span>
01357 
01358                         <span class="keywordflow">if</span> (Object == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01359 
01360                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01361                         }
01362 
01363                         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01364                     }
01365                 }
01366             }
01367 
01368         <span class="comment">//</span>
01369         <span class="comment">//  At this point the caller has given us the directory of object</span>
01370         <span class="comment">//  types.  If the caller didn't specify a name then we'll return</span>
01371         <span class="comment">//  a pointer to the root object directory.</span>
01372         <span class="comment">//</span>
01373 
01374         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectName-&gt;Length == 0) ||
01375                    (ObjectName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01376 
01377             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( RootDirectory,
01378                                                  0,
01379                                                  ObjectType,
01380                                                  AccessMode );
01381 
01382             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01383 
01384                 Object = RootDirectory;
01385             }
01386 
01387             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01388 
01389             *FoundObject = Object;
01390 
01391             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01392         }
01393 
01394     <span class="comment">//</span>
01395     <span class="comment">//  Otherwise the caller did not specify a directory to search so</span>
01396     <span class="comment">//  we'll default to the object root directory</span>
01397     <span class="comment">//</span>
01398 
01399     } <span class="keywordflow">else</span> {
01400 
01401         RootDirectory = <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>;
01402 
01403         <span class="comment">//</span>
01404         <span class="comment">//  If the name we're looking for is empty then it is illformed.</span>
01405         <span class="comment">//  Also it has to start with a "\" or it is illformed.</span>
01406         <span class="comment">//</span>
01407 
01408         <span class="keywordflow">if</span> ((ObjectName-&gt;Length == 0) ||
01409             (ObjectName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01410             (*(ObjectName-&gt;Buffer) != OBJ_NAME_PATH_SEPARATOR)) {
01411 
01412             <span class="keywordflow">return</span>( STATUS_OBJECT_PATH_SYNTAX_BAD );
01413         }
01414 
01415         <span class="comment">//</span>
01416         <span class="comment">//  Check if the name is has only one character (that is the "\")</span>
01417         <span class="comment">//  Which means that the caller really just wants to lookup the</span>
01418         <span class="comment">//  root directory.</span>
01419         <span class="comment">//</span>
01420 
01421         <span class="keywordflow">if</span> (ObjectName-&gt;Length == <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR )) {
01422 
01423             <span class="comment">//</span>
01424             <span class="comment">//  If there is not a root directory yet.  Then we really</span>
01425             <span class="comment">//  can't return it, however if the caller specified</span>
01426             <span class="comment">//  an insert object that is the one we'll reference and</span>
01427             <span class="comment">//  return to our caller</span>
01428             <span class="comment">//</span>
01429 
01430             <span class="keywordflow">if</span> (!RootDirectory) {
01431 
01432                 <span class="keywordflow">if</span> (InsertObject) {
01433 
01434                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( InsertObject,
01435                                                          0,
01436                                                          ObjectType,
01437                                                          AccessMode );
01438 
01439                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01440 
01441                         *FoundObject = InsertObject;
01442                     }
01443 
01444                     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01445 
01446                 } <span class="keywordflow">else</span> {
01447 
01448                     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
01449                 }
01450 
01451             <span class="comment">//</span>
01452             <span class="comment">//  At this point the caller did not specify a root directory,</span>
01453             <span class="comment">//  the name is "\" and the root object directory exists so</span>
01454             <span class="comment">//  we'll simply return the real root directory object</span>
01455             <span class="comment">//</span>
01456 
01457             } <span class="keywordflow">else</span> {
01458 
01459                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( RootDirectory,
01460                                                      0,
01461                                                      ObjectType,
01462                                                      AccessMode );
01463 
01464                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01465 
01466                     *FoundObject = RootDirectory;
01467                 }
01468 
01469                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01470             }
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">//  At this pointer the caller did not specify a root directory,</span>
01474         <span class="comment">//  and the name is more than just a "\"</span>
01475         <span class="comment">//</span>
01476         <span class="comment">//  Now if the lookup is case insensitive, and the name buffer is a</span>
01477         <span class="comment">//  legitimate pointer (meaning that is it quadword aligned), and</span>
01478         <span class="comment">//  there is a dos device map for the process.  Then we'll handle</span>
01479         <span class="comment">//  the situation here. First get the device map and make sure it</span>
01480         <span class="comment">//  doesn't go away while we're using it.</span>
01481         <span class="comment">//</span>
01482 
01483         } <span class="keywordflow">else</span> {
01484 
01485             KIRQL OldIrql;
01486 
01487             ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
01488 
01489             <span class="keywordflow">if</span> ((DeviceMap = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DeviceMap) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01490 
01491                 DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>++;
01492                 ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
01493 
01494                 <span class="keywordflow">if</span> (!((ULONG_PTR)(ObjectName-&gt;Buffer) &amp; (<span class="keyword">sizeof</span>(ULONGLONG)-1))
01495 
01496                             &amp;&amp;
01497 
01498                     (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )) {
01499 
01500                     <span class="comment">//</span>
01501                     <span class="comment">//  Check if the object name is actually equal to the</span>
01502                     <span class="comment">//  global dos devices short name prefix "\??\"</span>
01503                     <span class="comment">//</span>
01504 
01505                     <span class="keywordflow">if</span> ((ObjectName-&gt;Length &gt;= <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length)
01506 
01507                             &amp;&amp;
01508 
01509                         (*(PULONGLONG)(ObjectName-&gt;Buffer) == <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart)) {
01510 
01511                         <span class="comment">//</span>
01512                         <span class="comment">//  The user gave us the dos short name prefix so we'll</span>
01513                         <span class="comment">//  look down the directory, and start the search at the</span>
01514                         <span class="comment">//  dos device directory</span>
01515                         <span class="comment">//</span>
01516 
01517                         *DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01518 
01519                         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01520 
01521                         ParentDirectory = RootDirectory;
01522 
01523                         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>;
01524 
01525                         RemainingName = *ObjectName;
01526                         RemainingName.Buffer += (<a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length / <span class="keyword">sizeof</span>( WCHAR ));
01527                         RemainingName.Length -= <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length;
01528 
01529                         <span class="keywordflow">goto</span> quickStart;
01530 
01531                     <span class="comment">//</span>
01532                     <span class="comment">//  The name is not equal to "\??\" but check if it is</span>
01533                     <span class="comment">//  equal to "\??"</span>
01534                     <span class="comment">//</span>
01535 
01536                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectName-&gt;Length == <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length - <span class="keyword">sizeof</span>( WCHAR ))
01537 
01538                                     &amp;&amp;
01539 
01540                                (*(PULONG)(ObjectName-&gt;Buffer) == <a class="code" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a>.LowPart)
01541 
01542                                     &amp;&amp;
01543 
01544                                (*((PWCHAR)(ObjectName-&gt;Buffer)+2) == (WCHAR)(<a class="code" href="../../d0/d1/obinit_8c.html#a10">ObpDosDevicesShortNameRoot</a>.HighPart))) {
01545 
01546                         <span class="comment">//</span>
01547                         <span class="comment">//  The user specified "\??" so we return to dos devices</span>
01548                         <span class="comment">//  directory to our caller</span>
01549                         <span class="comment">//</span>
01550 
01551                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>,
01552                                                              0,
01553                                                              ObjectType,
01554                                                              AccessMode );
01555 
01556                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01557 
01558                             *FoundObject = DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>;
01559                         }
01560 
01561                         <span class="comment">//</span>
01562                         <span class="comment">//  Dereference the Device Map</span>
01563                         <span class="comment">//</span>
01564 
01565                         {
01566                             KIRQL OldIrql;
01567 
01568                             ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
01569 
01570                             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>--;
01571 
01572                             <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> == 0) {
01573 
01574                                 ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
01575 
01576                                 DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01577                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> );
01578 
01579                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceMap );
01580 
01581                             } <span class="keywordflow">else</span> {
01582 
01583                                 ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
01584                             }
01585                         }
01586 
01587                         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01588                     }
01589                 }
01590 
01591             } <span class="keywordflow">else</span> {
01592 
01593                 ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
01594             }
01595         }
01596     }
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">//  At this point either</span>
01600     <span class="comment">//</span>
01601     <span class="comment">//  the user specified a directory that is not the object</span>
01602     <span class="comment">//  type directory and got repase back to the root directory</span>
01603     <span class="comment">//</span>
01604     <span class="comment">//  the user specified the object type directory and gave us</span>
01605     <span class="comment">//  a name to actually look up</span>
01606     <span class="comment">//</span>
01607     <span class="comment">//  the user did not specify a search directory (default</span>
01608     <span class="comment">//  to root object directory) and if the name did start off</span>
01609     <span class="comment">//  with the dos device prefix we've munged outselves back to</span>
01610     <span class="comment">//  it to the dos device directory for the process</span>
01611     <span class="comment">//</span>
01612 
01613     Reparse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01614     MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;
01615 
01616     <span class="keywordflow">while</span> (Reparse) {
01617 
01618         RemainingName = *ObjectName;
01619 
01620 quickStart:
01621 
01622         Reparse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01623 
01624         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01625 
01626             Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01627 
01628             <span class="comment">//if (RemainingName.Length == 0) {</span>
01629             <span class="comment">//    Status = STATUS_OBJECT_NAME_INVALID;</span>
01630             <span class="comment">//    break;</span>
01631             <span class="comment">//    }</span>
01632 
01633             <span class="comment">//</span>
01634             <span class="comment">//  If the remaining name for the object starts with a</span>
01635             <span class="comment">//  "\" then just gobble up the "\"</span>
01636             <span class="comment">//</span>
01637 
01638             <span class="keywordflow">if</span> ( (RemainingName.Length != 0) &amp;&amp;
01639                  (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) ) {
01640 
01641                 RemainingName.Buffer++;
01642                 RemainingName.Length -= <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01643             }
01644 
01645             <span class="comment">//</span>
01646             <span class="comment">//  The following piece of code will calculate the first</span>
01647             <span class="comment">//  component of the remaining name.  If there is not</span>
01648             <span class="comment">//  a remaining component then the object name is illformed</span>
01649             <span class="comment">//</span>
01650 
01651             ComponentName = RemainingName;
01652 
01653             <span class="keywordflow">while</span> (RemainingName.Length != 0) {
01654 
01655                 <span class="keywordflow">if</span> (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
01656 
01657                     <span class="keywordflow">break</span>;
01658                 }
01659 
01660                 RemainingName.Buffer++;
01661                 RemainingName.Length -= <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01662             }
01663 
01664             ComponentName.Length -= RemainingName.Length;
01665 
01666             <span class="keywordflow">if</span> (ComponentName.Length == 0) {
01667 
01668                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
01669                 <span class="keywordflow">break</span>;
01670             }
01671 
01672             <span class="comment">//</span>
01673             <span class="comment">//  Now we have the first component name to lookup so we'll</span>
01674             <span class="comment">//  look the directory is necessary</span>
01675             <span class="comment">//</span>
01676 
01677             <span class="keywordflow">if</span> (!*DirectoryLocked) {
01678 
01679                 *DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01680                 <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01681                 <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = RootDirectory;
01682             }
01683 
01684             <span class="comment">//</span>
01685             <span class="comment">//  Now if the caller does not have traverse privilege and</span>
01686             <span class="comment">//  there is a parent directory then we must check if the</span>
01687             <span class="comment">//  user has traverse access to the directory.  Our local</span>
01688             <span class="comment">//  Reparse variable should be false at this point so we'll</span>
01689             <span class="comment">//  drop out of both loops</span>
01690             <span class="comment">//</span>
01691 
01692             <span class="keywordflow">if</span> ( !(AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>) &amp;&amp; (ParentDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ) {
01693 
01694                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a5">ObpCheckTraverseAccess</a>( ParentDirectory,
01695                                              DIRECTORY_TRAVERSE,
01696                                              AccessState,
01697                                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01698                                              AccessMode,
01699                                              &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01700 
01701                     <span class="keywordflow">break</span>;
01702                 }
01703             }
01704 
01705             <span class="comment">//</span>
01706             <span class="comment">//  If the object already exists in this directory, find it,</span>
01707             <span class="comment">//  else return NULL.</span>
01708             <span class="comment">//</span>
01709 
01710             Object = <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>, &amp;ComponentName, Attributes );
01711 
01712             <span class="keywordflow">if</span> (!Object) {
01713 
01714                 <span class="comment">//</span>
01715                 <span class="comment">//  We didn't find the object.  If there is some remaining</span>
01716                 <span class="comment">//  name left (meaning the component name is a directory in</span>
01717                 <span class="comment">//  path we trying to break) or the caller didn't specify an</span>
01718                 <span class="comment">//  insert object then we then we'll break out here with an</span>
01719                 <span class="comment">//  error status</span>
01720                 <span class="comment">//</span>
01721 
01722                 <span class="keywordflow">if</span> (RemainingName.Length != 0) {
01723 
01724                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_PATH_NOT_FOUND;
01725                     <span class="keywordflow">break</span>;
01726                 }
01727 
01728                 <span class="keywordflow">if</span> (!InsertObject) {
01729 
01730                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01731                     <span class="keywordflow">break</span>;
01732                 }
01733 
01734                 <span class="comment">//</span>
01735                 <span class="comment">//  Check that the caller has the access to the directory</span>
01736                 <span class="comment">//  to either create a subdirectory (in the object type</span>
01737                 <span class="comment">//  directory) or to create an object of the given component</span>
01738                 <span class="comment">//  name.  If the call fails then we'll break out of here</span>
01739                 <span class="comment">//  with the status value set</span>
01740                 <span class="comment">//</span>
01741 
01742                 <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a6">ObCheckCreateObjectAccess</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>,
01743                                                 ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a> ?
01744                                                         DIRECTORY_CREATE_SUBDIRECTORY :
01745                                                         DIRECTORY_CREATE_OBJECT,
01746                                                 AccessState,
01747                                                 &amp;ComponentName,
01748                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01749                                                 AccessMode,
01750                                                 &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01751 
01752                     <span class="keywordflow">break</span>;
01753                 }
01754 
01755                 <span class="comment">//</span>
01756                 <span class="comment">//  The object does not exist in the directory and</span>
01757                 <span class="comment">//  we are allowed to create one.  So allocate space</span>
01758                 <span class="comment">//  for the name and insert the name into the directory</span>
01759                 <span class="comment">//</span>
01760 
01761                 <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, ComponentName.Length, 'mNbO' );
01762 
01763                 <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01764                     !<a class="code" href="../../d5/d1/obp_8h.html#a69">ObpInsertDirectoryEntry</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>, InsertObject )) {
01765 
01766                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01767 
01768                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> );
01769                     }
01770 
01771                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
01772                     <span class="keywordflow">break</span>;
01773                 }
01774 
01775                 <span class="comment">//</span>
01776                 <span class="comment">//  We have an insert object so now get its name info,</span>
01777                 <span class="comment">//  because we are going to change its name and insert it</span>
01778                 <span class="comment">//  into the directory</span>
01779                 <span class="comment">//</span>
01780 
01781                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( InsertObject );
01782 
01783                 ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( InsertObject );
01784 
01785                 NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01786 
01787                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> );
01788 
01789                 RtlMoveMemory( <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>,
01790                                ComponentName.Buffer,
01791                                ComponentName.Length );
01792 
01793                 <span class="keywordflow">if</span> (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer) {
01794 
01795                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01796                 }
01797 
01798                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
01799                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = ComponentName.Length;
01800                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = ComponentName.Length;
01801 
01802                 Object = InsertObject;
01803 
01804                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01805 
01806                 <span class="keywordflow">break</span>;
01807             }
01808 
01809             <span class="comment">//</span>
01810             <span class="comment">//  At this point we've found the component name within</span>
01811             <span class="comment">//  the directory.  So we'll now grab the components object</span>
01812             <span class="comment">//  header, and get its parse routine</span>
01813             <span class="comment">//</span>
01814 
01815 ReparseObject:
01816 
01817             ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01818             ParseProcedure = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o16">ParseProcedure</a>;
01819 
01820             <span class="comment">//</span>
01821             <span class="comment">//  Now if there is a parse routine for the type and we are not</span>
01822             <span class="comment">//  inserting a new object or the parse routine is for symbolic</span>
01823             <span class="comment">//  links then we'll actually call the parse routine</span>
01824             <span class="comment">//</span>
01825 
01826             <span class="keywordflow">if</span> (ParseProcedure &amp;&amp; (!InsertObject || (ParseProcedure == <a class="code" href="../../d4/d1/oblink_8c.html#a8">ObpParseSymbolicLink</a>))) {
01827 
01828                 KIRQL SaveIrql;
01829 
01830                 <span class="comment">//</span>
01831                 <span class="comment">//  Reference the object and then free the directory lock</span>
01832                 <span class="comment">//  This will keep the object from going away with the</span>
01833                 <span class="comment">//  directory unlocked</span>
01834                 <span class="comment">//</span>
01835 
01836                 <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
01837 
01838                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*DirectoryLocked);
01839 
01840                 <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01841 
01842                 *DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01843 
01844                 <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01845 
01846                 <span class="comment">//</span>
01847                 <span class="comment">//  Call the objects parse routine</span>
01848                 <span class="comment">//</span>
01849 
01850                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (*ParseProcedure)( Object,
01851                                             (PVOID)ObjectType,
01852                                             AccessState,
01853                                             AccessMode,
01854                                             Attributes,
01855                                             ObjectName,
01856                                             &amp;RemainingName,
01857                                             ParseContext,
01858                                             <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>,
01859                                             &amp;Object );
01860 
01861                 <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Parse"</span>, ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>, Object );
01862 
01863                 <span class="comment">//</span>
01864                 <span class="comment">//  We can now decrement the object reference count</span>
01865                 <span class="comment">//</span>
01866 
01867                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
01868 
01869                 <span class="comment">//</span>
01870                 <span class="comment">//  Check if we have some reparsing to do</span>
01871                 <span class="comment">//</span>
01872 
01873                 <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REPARSE) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REPARSE_OBJECT)) {
01874 
01875                     <span class="comment">//</span>
01876                     <span class="comment">//  See if we've reparsed too many times already and if</span>
01877                     <span class="comment">//  so we'll fail the request</span>
01878                     <span class="comment">//</span>
01879 
01880                     <span class="keywordflow">if</span> (--MaxReparse) {
01881 
01882                         <span class="comment">//</span>
01883                         <span class="comment">//  Tell the outer loop to continue looping</span>
01884                         <span class="comment">//</span>
01885 
01886                         Reparse = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01887 
01888                         <span class="comment">//</span>
01889                         <span class="comment">//  Check if we have a reparse object or the name</span>
01890                         <span class="comment">//  starts with a "\"</span>
01891                         <span class="comment">//</span>
01892 
01893                         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REPARSE_OBJECT) ||
01894                             (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
01895 
01896                             <span class="comment">//</span>
01897                             <span class="comment">//  If the user specified a start directory then</span>
01898                             <span class="comment">//  remove this information because we're taking</span>
01899                             <span class="comment">//  a reparse point to someplace else</span>
01900                              <span class="comment">//</span>
01901 
01902                             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RootDirectoryHandle )) {
01903 
01904                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
01905                                 RootDirectoryHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01906                             }
01907 
01908                             <span class="comment">//</span>
01909                             <span class="comment">//  And where we start is the root directory</span>
01910                             <span class="comment">//  object</span>
01911                             <span class="comment">//</span>
01912 
01913                             ParentDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01914                             RootDirectory = <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>;
01915 
01916                             <span class="comment">//</span>
01917                             <span class="comment">//  Now if this is a reparse object (means we have</span>
01918                             <span class="comment">//  encountered a symbolic link that has already been</span>
01919                             <span class="comment">//  snapped so we have an object and remaining</span>
01920                             <span class="comment">//  name that need to be examined) and we didn't</span>
01921                             <span class="comment">//  find an object from the parse routine object</span>
01922                             <span class="comment">//  break out of both loops.</span>
01923                             <span class="comment">//</span>
01924 
01925                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REPARSE_OBJECT) {
01926 
01927                                 Reparse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01928 
01929                                 <span class="keywordflow">if</span> (Object == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01930 
01931                                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01932 
01933                                 } <span class="keywordflow">else</span> {
01934 
01935                                     <span class="comment">//</span>
01936                                     <span class="comment">//  At this point we have a reparse object</span>
01937                                     <span class="comment">//  so we'll look the directory down and</span>
01938                                     <span class="comment">//  parse the new object</span>
01939                                     <span class="comment">//</span>
01940 
01941                                     *DirectoryLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01942                                     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01943 
01944                                     <span class="keywordflow">goto</span> ReparseObject;
01945                                 }
01946                             }
01947 
01948                         <span class="comment">//</span>
01949                         <span class="comment">//  We did not have a reparse object and the name</span>
01950                         <span class="comment">//  does not start with a "\".  Meaning we got back</span>
01951                         <span class="comment">//  STATUS_REPASE, so now check if the directory</span>
01952                         <span class="comment">//  is the root object directory and if so then</span>
01953                         <span class="comment">//  we didn't the name otherwise we'll drop out of</span>
01954                         <span class="comment">//  the inner loop and reparse true to get back to</span>
01955                         <span class="comment">//  outer loop</span>
01956                         <span class="comment">//</span>
01957 
01958                         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RootDirectory == <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>) {
01959 
01960                             Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961                             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01962 
01963                             Reparse = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01964                         }
01965 
01966                     } <span class="keywordflow">else</span> {
01967 
01968                         <span class="comment">//</span>
01969                         <span class="comment">//  **** this should probably be a differnt error</span>
01970                         <span class="comment">//  status related to too many reparse points</span>
01971                         <span class="comment">//</span>
01972 
01973                         Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01974                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01975                     }
01976 
01977                 <span class="comment">//</span>
01978                 <span class="comment">//  We are not reparsing and if we did not get success then</span>
01979                 <span class="comment">//  the object is null and we'll break out of our loops</span>
01980                 <span class="comment">//</span>
01981 
01982                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01983 
01984                     Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01985 
01986                 <span class="comment">//</span>
01987                 <span class="comment">//  We are not reparsing and we got back success but check</span>
01988                 <span class="comment">//  if the object is null because that means we really didn't</span>
01989                 <span class="comment">//  find the object, and then break out of our loops</span>
01990                 <span class="comment">//</span>
01991                 <span class="comment">//  If the object is not null then we've been successful and</span>
01992                 <span class="comment">//  prosperous so break out with the object set.</span>
01993                 <span class="comment">//</span>
01994 
01995                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Object == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01996 
01997                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01998                 }
01999 
02000                 <span class="keywordflow">break</span>;
02001 
02002             } <span class="keywordflow">else</span> {
02003 
02004                 <span class="comment">//</span>
02005                 <span class="comment">//  At this point we do not have a parse routine or if there</span>
02006                 <span class="comment">//  is a parse routine it is not for symbolic links or there</span>
02007                 <span class="comment">//  may not be a specified insert object</span>
02008                 <span class="comment">//</span>
02009                 <span class="comment">//  Check to see if we have exhausted the remaining name</span>
02010                 <span class="comment">//</span>
02011 
02012                 <span class="keywordflow">if</span> (RemainingName.Length == 0) {
02013 
02014                     <span class="comment">//</span>
02015                     <span class="comment">//  Check if the caller specified an object to insert.</span>
02016                     <span class="comment">//  If specified then we'll break out of our loops with</span>
02017                     <span class="comment">//  the object that we've found</span>
02018                     <span class="comment">//</span>
02019 
02020                     <span class="keywordflow">if</span> (!InsertObject) {
02021 
02022                         <span class="comment">//</span>
02023                         <span class="comment">//  The user did not specify an insert object</span>
02024                         <span class="comment">//  so we're opening an existing object.  Make sure</span>
02025                         <span class="comment">//  we have traverse access to the container</span>
02026                         <span class="comment">//  directory.</span>
02027                         <span class="comment">//</span>
02028 
02029                         <span class="keywordflow">if</span> ( !(AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a1">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>) ) {
02030 
02031                             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a5">ObpCheckTraverseAccess</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>,
02032                                                          DIRECTORY_TRAVERSE,
02033                                                          AccessState,
02034                                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
02035                                                          AccessMode,
02036                                                          &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02037 
02038                                 Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02039                                 <span class="keywordflow">break</span>;
02040                             }
02041                         }
02042 
02043                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( Object,
02044                                                              0,
02045                                                              ObjectType,
02046                                                              AccessMode );
02047 
02048                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02049 
02050                             Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02051                         }
02052                     }
02053 
02054                     <span class="keywordflow">break</span>;
02055 
02056                 } <span class="keywordflow">else</span> {
02057 
02058                     <span class="comment">//</span>
02059                     <span class="comment">//  There is some name remaining names to process</span>
02060                     <span class="comment">//  if the directory we're looking at is the</span>
02061                     <span class="comment">//  directory of object types and set ourselves</span>
02062                     <span class="comment">//  up to parse it all over again.</span>
02063                     <span class="comment">//</span>
02064 
02065                     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>) {
02066 
02067                         ParentDirectory = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
02068                         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = (<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>)Object;
02069 
02070                     } <span class="keywordflow">else</span> {
02071 
02072                         <span class="comment">//</span>
02073                         <span class="comment">//  Otherwise there has been a mismatch so we'll</span>
02074                         <span class="comment">//  set our error status and break out of the</span>
02075                         <span class="comment">//  loops</span>
02076                         <span class="comment">//</span>
02077 
02078                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
02079                         Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02080 
02081                         <span class="keywordflow">break</span>;
02082                     }
02083                 }
02084             }
02085         }
02086     }
02087 
02088     <span class="comment">//</span>
02089     <span class="comment">//  If the device map has been referenced then dereference it</span>
02090     <span class="comment">//</span>
02091 
02092     <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02093 
02094         KIRQL OldIrql;
02095 
02096         ExAcquireSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, &amp;OldIrql );
02097 
02098         DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a>--;
02099 
02100         <span class="keywordflow">if</span> (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o0">ReferenceCount</a> == 0) {
02101 
02102             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
02103 
02104             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02105             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> );
02106 
02107             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeviceMap );
02108 
02109         } <span class="keywordflow">else</span> {
02110 
02111             ExReleaseSpinLock( &amp;<a class="code" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>, OldIrql );
02112         }
02113     }
02114 
02115     <span class="comment">//</span>
02116     <span class="comment">//  At this point we've parsed the object name as much as possible</span>
02117     <span class="comment">//  going through symbolic links as necessary.  So now set the</span>
02118     <span class="comment">//  output object pointer, and if we really did not find an object</span>
02119     <span class="comment">//  then we might need to modify the error status.  If the</span>
02120     <span class="comment">//  status was repase or some success status then translate it</span>
02121     <span class="comment">//  to name not found.</span>
02122     <span class="comment">//</span>
02123 
02124     <span class="keywordflow">if</span> (!(*FoundObject = Object)) {
02125 
02126         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REPARSE) {
02127 
02128             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
02129 
02130         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02131 
02132             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
02133         }
02134     }
02135 
02136     <span class="comment">//</span>
02137     <span class="comment">//  If the caller gave us a root directory to search (and we didn't</span>
02138     <span class="comment">//  zero out this value) then free up our reference</span>
02139     <span class="comment">//</span>
02140 
02141     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RootDirectoryHandle )) {
02142 
02143         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( RootDirectory );
02144         RootDirectoryHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02145     }
02146 
02147     <span class="comment">//</span>
02148     <span class="comment">//  And return to our caller</span>
02149     <span class="comment">//</span>
02150 
02151     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02152 }
02153 
02154 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
