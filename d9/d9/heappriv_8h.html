<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heappriv.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heappriv.h File Reference</h1><code>#include "<a class="el" href="../../d8/d8/heappage_8h-source.html">heappage.h</a>"</code><br>

<p>
<a href="../../d0/d9/heappriv_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">_HEAP_LOOKASIDE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(exp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a1">PREALLOCATE_EVENT_MASK</a>&nbsp;&nbsp;&nbsp;0x80000000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a2">RtlInitializeLockRoutine</a>(L)&nbsp;&nbsp;&nbsp;RtlInitializeCriticalSectionAndSpinCount((PRTL_CRITICAL_SECTION)(L),(PREALLOCATE_EVENT_MASK | 4000))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>(L)&nbsp;&nbsp;&nbsp;RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)(L))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>(L)&nbsp;&nbsp;&nbsp;RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)(L))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a5">RtlDeleteLockRoutine</a>(L)&nbsp;&nbsp;&nbsp;RtlDeleteCriticalSection((PRTL_CRITICAL_SECTION)(L))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a6">RtlOkayToLockRoutine</a>(L)&nbsp;&nbsp;&nbsp;NtdllOkayToLockRoutine((PVOID)(L))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a7">HEAP_DEBUG_FLAGS</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a8">DEBUG_HEAP</a>(F)&nbsp;&nbsp;&nbsp;((F &amp; HEAP_DEBUG_FLAGS) &amp;&amp; !(F &amp; HEAP_SKIP_VALIDATION_CHECKS))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>(S)&nbsp;&nbsp;&nbsp;{NtCurrentTeb()-&gt;LastErrorValue = RtlNtStatusToDosError( NtCurrentTeb()-&gt;LastStatusValue = (ULONG)(S) );}</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(_x_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>(_x_)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a12">SET_FREELIST_BIT</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a13">CLEAR_FREELIST_BIT</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>(H, FB, SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a15">RtlpFastInsertFreeBlockDirect</a>(H, FB, SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a16">RtlpFastInsertDedicatedFreeBlockDirect</a>(H, FB, SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a17">RtlpFastInsertNonDedicatedFreeBlockDirect</a>(H, FB, SIZE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a19">RtlpFastRemoveFreeBlock</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a20">RtlpFastRemoveDedicatedFreeBlock</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a21">RtlpFastRemoveNonDedicatedFreeBlock</a>(H, FB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()&nbsp;&nbsp;&nbsp;(RtlGetNtGlobalFlags() &amp; FLG_HEAP_ENABLE_TAGGING)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d9/d9/heappriv_8h.html#a60">_HEAP_TAG_ACTION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">_HEAP_LOOKASIDE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a25">HEAP_LOOKASIDE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">_HEAP_LOOKASIDE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a26">PHEAP_LOOKASIDE</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a60">_HEAP_TAG_ACTION</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d9/d9/heappriv_8h.html#a60a27">AllocationAction</a>, 
<a class="el" href="../../d9/d9/heappriv_8h.html#a60a28">VirtualAllocationAction</a>, 
<a class="el" href="../../d9/d9/heappriv_8h.html#a60a29">FreeAction</a>, 
<a class="el" href="../../d9/d9/heappriv_8h.html#a60a30">VirtualFreeAction</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d9/d9/heappriv_8h.html#a60a31">ReAllocationAction</a>, 
<a class="el" href="../../d9/d9/heappriv_8h.html#a60a32">VirtualReAllocationAction</a>
<br>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a33">RtlpInitializeHeapSegment</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment, IN UCHAR SegmentIndex, IN ULONG Flags, IN PVOID BaseAddress, IN PVOID UnCommittedAddress, IN PVOID CommitLimitAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a34">RtlpCoalesceFreeBlocks</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock, IN OUT PSIZE_T FreeSize, IN BOOLEAN RemoveFromFreeList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a35">RtlpDeCommitFreeBlock</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock, IN SIZE_T FreeSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock, IN SIZE_T FreeSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a37">RtlpFindAndCommitPages</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment, IN OUT PSIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN PVOID AddressWanted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a38">RtlAllocateHeapSlowly</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN SIZE_T <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a39">RtlFreeHeapSlowly</a> (IN PVOID <a class="el" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, IN ULONG Flags, IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a40">RtlpGetSizeOfBigBlock</a> (IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a> (<a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a> (IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a43">RtlpAddHeapToProcessList</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a44">RtlpRemoveHeapFromProcessList</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a45">RtlpCoalesceHeap</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a46">RtlpCheckHeapSignature</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN PCHAR Caller)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a47">RtlpValidateHeapEntry</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock, IN PCHAR Reason)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a48">RtlpValidateHeap</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN BOOLEAN AlwaysValidate)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a49">RtlpUpdateHeapListIndex</a> (<a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> OldIndex, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> NewIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a> (IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, IN BOOLEAN Recompute)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PWSTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a51">RtlpGetTagName</a> (<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> TagIndex)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a> (<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap, <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> TagIndex, SIZE_T OldSize, SIZE_T NewSize, <a class="el" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a> <a class="el" href="../../d9/d3/rules_8c.html#a7">Action</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a53">RtlpResetTags</a> (<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a54">RtlpDestroyTags</a> (<a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a55">RtlpInitializeHeapLookaside</a> (IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a> Lookaside, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Depth)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a56">RtlpDeleteHeapLookaside</a> (IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a> Lookaside)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a57">RtlpAdjustHeapLookasideDepth</a> (IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a> Lookaside)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a58">RtlpAllocateFromHeapLookaside</a> (IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a> Lookaside)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a59">RtlpFreeToHeapLookaside</a> (IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a> Lookaside, IN PVOID Entry)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>UCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/heappriv_8h.html#a23">CheckHeapFillPattern</a> [CHECK_HEAP_TAIL_SIZE]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a13" doxytag="heappriv.h::CLEAR_FREELIST_BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CLEAR_FREELIST_BIT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                              \
    ULONG _Index_;                                             \
    ULONG _Bit_;                                               \
                                                               \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>((FB)-&gt;Size &lt; HEAP_MAXIMUM_FREELISTS);           \
                                                               \
    _Index_ = (FB)-&gt;Size &gt;&gt; 3;                                 \
    _Bit_ = (1 &lt;&lt; ((FB)-&gt;Size &amp; 7));                           \
                                                               \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>((H)-&gt;u.FreeListsInUseBytes[ _Index_ ] &amp; _Bit_); \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(IsListEmpty(&amp;(H)-&gt;FreeLists[ (FB)-&gt;Size ]));    \
                                                               \
    (H)-&gt;u.FreeListsInUseBytes[ _Index_ ] ^= _Bit_;            \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00300">300</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="heappriv.h::DEBUG_HEAP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DEBUG_HEAP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((F &amp; HEAP_DEBUG_FLAGS) &amp;&amp; !(F &amp; HEAP_SKIP_VALIDATION_CHECKS))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00103">103</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02401">RtlCompactHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01192">RtlGetUserInfoHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01919">RtlQueryTagHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01480">RtlSetUserFlagsHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01356">RtlSetUserValueHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03655">RtlSizeHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03762">RtlZeroHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="heappriv.h::HEAP_DEBUG_FLAGS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAP_DEBUG_FLAGS          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(<a class="code" href="../../d3/d9/heap_8h.html#a21">HEAP_VALIDATE_PARAMETERS_ENABLED</a> | \
                            <a class="code" href="../../d3/d9/heap_8h.html#a22">HEAP_VALIDATE_ALL_ENABLED</a>        | \
                            <a class="code" href="../../d3/d9/heap_8h.html#a24">HEAP_CAPTURE_STACK_BACKTRACES</a>    | \
                            HEAP_CREATE_ENABLE_TRACING       | \
                            <a class="code" href="../../d7/d9/heappage_8h.html#a1">HEAP_FLAG_PAGE_ALLOCS</a>)
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00098">98</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="heappriv.h::HEAPASSERT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HEAPASSERT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">exp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00039">39</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05312">RtlpCoalesceFreeBlocks()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="heappriv.h::HeapDebugBreak" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HeapDebugBreak          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_x_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                \
    <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d9/heapdbg_8c.html#a29">RtlpBreakPointHeap</a>( PVOID BadAddress ); \
                                                 \
    <a class="code" href="../../d4/d9/heapdbg_8c.html#a29">RtlpBreakPointHeap</a>( (_x_) );                 \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">134</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00204">RtlDebugCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">RtlpCheckBusyBlockTail()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04250">RtlpCheckHeapSignature()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04422">RtlpFindAndCommitPages()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01696">RtlpValidateHeapEntry()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="heappriv.h::HeapDebugPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HeapDebugPrint          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_x_&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                               \
    PLIST_ENTRY _Module;                                        \
    PLDR_DATA_TABLE_ENTRY _Entry;                               \
                                                                \
    _Module = NtCurrentPeb()-&gt;Ldr-&gt;InLoadOrderModuleList.Flink; \
    _Entry = CONTAINING_RECORD( _Module,                        \
                                LDR_DATA_TABLE_ENTRY,           \
                                InLoadOrderLinks);              \
    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"HEAP[%wZ]: "</span>, &amp;_Entry-&gt;BaseDllName);              \
    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> _x_;                                               \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">121</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00204">RtlDebugCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00388">RtlDebugDestroyHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">RtlpCheckBusyBlockTail()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04250">RtlpCheckHeapSignature()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04422">RtlpFindAndCommitPages()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04227">RtlpInsertUnCommittedPages()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00258">RtlProtectHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01696">RtlpValidateHeapEntry()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">RtlpValidateHeapHeaders()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01790">RtlpValidateHeapSegment()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="heappriv.h::IS_HEAP_TAGGING_ENABLED" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_HEAP_TAGGING_ENABLED          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(RtlGetNtGlobalFlags() &amp; FLG_HEAP_ENABLE_TAGGING)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00563">563</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01919">RtlQueryTagHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="heappriv.h::PREALLOCATE_EVENT_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PREALLOCATE_EVENT_MASK&nbsp;&nbsp;&nbsp;0x80000000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00073">73</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="heappriv.h::RtlAcquireLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d1/theap_8c.html#a5">RtlAcquireLockRoutine</a>          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;RtlEnterCriticalSection((PRTL_CRITICAL_SECTION)(L))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00078">78</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02401">RtlCompactHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01498">RtlDebugQueryTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02896">RtlEnumProcessHeaps()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02803">RtlGetProcessHeaps()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01192">RtlGetUserInfoHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00390">RtlLockHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04457">RtlpAddHeapToProcessList()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04571">RtlpRemoveHeapFromProcessList()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01919">RtlQueryTagHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01480">RtlSetUserFlagsHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01356">RtlSetUserValueHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03762">RtlZeroHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="heappriv.h::RtlDeleteLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d1/theap_8c.html#a7">RtlDeleteLockRoutine</a>          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;RtlDeleteCriticalSection((PRTL_CRITICAL_SECTION)(L))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00080">80</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="heappriv.h::RtlInitializeLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d1/theap_8c.html#a4">RtlInitializeLockRoutine</a>          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;RtlInitializeCriticalSectionAndSpinCount((PRTL_CRITICAL_SECTION)(L),(PREALLOCATE_EVENT_MASK | 4000))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00077">77</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00179">RtlInitializeHeapManager()</a>, and <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="heappriv.h::RtlOkayToLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d1/theap_8c.html#a8">RtlOkayToLockRoutine</a>          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;NtdllOkayToLockRoutine((PVOID)(L))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00081">81</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="heappriv.h::RtlpFastInsertDedicatedFreeBlockDirect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastInsertDedicatedFreeBlockDirect          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                         \
    PLIST_ENTRY <a class="code" href="../../d4/d5/struct__HEAD.html">_HEAD</a>;                                                    \
                                                                          \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>((FB)-&gt;Size == (SIZE));                                     \
                                                                          \
    <span class="keywordflow">if</span> (!((FB)-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {                         \
                                                                          \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)(FB) + (SIZE))-&gt;PreviousSize == (SIZE)); \
    }                                                                     \
                                                                          \
    (FB)-&gt;Flags &amp;= <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;                                 \
                                                                          \
    _HEAD = &amp;(H)-&gt;FreeLists[ (SIZE) ];                                    \
                                                                          \
    <span class="keywordflow">if</span> (IsListEmpty(_HEAD)) {                                             \
                                                                          \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a12">SET_FREELIST_BIT</a>( H, FB );                                        \
    }                                                                     \
                                                                          \
    InsertTailList( _HEAD, &amp;(FB)-&gt;FreeList );                             \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00397">397</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="heappriv.h::RtlpFastInsertFreeBlockDirect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastInsertFreeBlockDirect          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                 \
    <span class="keywordflow">if</span> ((SIZE) &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>) {                        \
                                                                  \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a16">RtlpFastInsertDedicatedFreeBlockDirect</a>( H, FB, SIZE );    \
                                                                  \
    } <span class="keywordflow">else</span> {                                                      \
                                                                  \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a17">RtlpFastInsertNonDedicatedFreeBlockDirect</a>( H, FB, SIZE ); \
    }                                                             \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00380">380</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="heappriv.h::RtlpFastInsertNonDedicatedFreeBlockDirect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastInsertNonDedicatedFreeBlockDirect          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00425">425</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="heappriv.h::RtlpFastRemoveDedicatedFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastRemoveDedicatedFreeBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                 \
    PLIST_ENTRY _EX_Blink;                        \
    PLIST_ENTRY _EX_Flink;                        \
                                                  \
    _EX_Flink = (FB)-&gt;FreeList.Flink;             \
    _EX_Blink = (FB)-&gt;FreeList.Blink;             \
                                                  \
    _EX_Blink-&gt;Flink = _EX_Flink;                 \
    _EX_Flink-&gt;Blink = _EX_Blink;                 \
                                                  \
    <span class="keywordflow">if</span> (_EX_Flink == _EX_Blink) {                 \
                                                  \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a13">CLEAR_FREELIST_BIT</a>( H, FB );              \
    }                                             \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00525">525</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="heappriv.h::RtlpFastRemoveFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastRemoveFreeBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                \
    PLIST_ENTRY _EX_Blink;                       \
    PLIST_ENTRY _EX_Flink;                       \
                                                 \
    _EX_Flink = (FB)-&gt;FreeList.Flink;            \
    _EX_Blink = (FB)-&gt;FreeList.Blink;            \
                                                 \
    _EX_Blink-&gt;Flink = _EX_Flink;                \
    _EX_Flink-&gt;Blink = _EX_Blink;                \
                                                 \
    <span class="keywordflow">if</span> ((_EX_Flink == _EX_Blink) &amp;&amp;              \
        ((FB)-&gt;Size &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>)) { \
                                                 \
        <a class="code" href="../../d9/d9/heappriv_8h.html#a13">CLEAR_FREELIST_BIT</a>( H, FB );             \
    }                                            \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00502">502</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="heappriv.h::RtlpFastRemoveNonDedicatedFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpFastRemoveNonDedicatedFreeBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                    \
    RemoveEntryList(&amp;(FB)-&gt;FreeList)                 \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00547">547</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="heappriv.h::RtlpInsertFreeBlockDirect" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpInsertFreeBlockDirect          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00322">322</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="heappriv.h::RtlpRemoveFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RtlpRemoveFreeBlock          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00465">465</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05312">RtlpCoalesceFreeBlocks()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="heappriv.h::RtlReleaseLockRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define <a class="el" href="../../d1/d1/theap_8c.html#a6">RtlReleaseLockRoutine</a>          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;RtlLeaveCriticalSection((PRTL_CRITICAL_SECTION)(L))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00079">79</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02401">RtlCompactHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01603">RtlCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01498">RtlDebugQueryTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02896">RtlEnumProcessHeaps()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02803">RtlGetProcessHeaps()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01192">RtlGetUserInfoHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04457">RtlpAddHeapToProcessList()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04571">RtlpRemoveHeapFromProcessList()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01919">RtlQueryTagHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01480">RtlSetUserFlagsHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01356">RtlSetUserValueHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00454">RtlUnlockHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03762">RtlZeroHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="heappriv.h::SET_FREELIST_BIT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SET_FREELIST_BIT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>FB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                     \
    ULONG _Index_;                                                    \
    ULONG _Bit_;                                                      \
                                                                      \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>((FB)-&gt;Size &lt; HEAP_MAXIMUM_FREELISTS);                  \
                                                                      \
    _Index_ = (FB)-&gt;Size &gt;&gt; 3;                                        \
    _Bit_ = (1 &lt;&lt; ((FB)-&gt;Size &amp; 7));                                  \
                                                                      \
    <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(((H)-&gt;u.FreeListsInUseBytes[ _Index_ ] &amp; _Bit_) == 0); \
                                                                      \
    (H)-&gt;u.FreeListsInUseBytes[ _Index_ ] |= _Bit_;                   \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00280">280</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="heappriv.h::SET_LAST_STATUS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SET_LAST_STATUS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">S&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{NtCurrentTeb()-&gt;LastErrorValue = RtlNtStatusToDosError( NtCurrentTeb()-&gt;LastStatusValue = (ULONG)(S) );}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00104">104</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02401">RtlCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01498">RtlDebugQueryTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01654">RtlDebugWalkHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01192">RtlGetUserInfoHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01480">RtlSetUserFlagsHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01356">RtlSetUserValueHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03655">RtlSizeHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a25" doxytag="heappriv.h::HEAP_LOOKASIDE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">_HEAP_LOOKASIDE</a>  <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">HEAP_LOOKASIDE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="heappriv.h::HEAP_TAG_ACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d9/d9/heappriv_8h.html#a60">_HEAP_TAG_ACTION</a>  <a class="el" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05554">RtlpUpdateTagEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="heappriv.h::PHEAP_LOOKASIDE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">_HEAP_LOOKASIDE</a> * <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a60" doxytag="heappriv.h::_HEAP_TAG_ACTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d9/d9/heappriv_8h.html#a60">_HEAP_TAG_ACTION</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a60a27" doxytag="AllocationAction" ></a>AllocationAction</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a28" doxytag="VirtualAllocationAction" ></a>VirtualAllocationAction</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a29" doxytag="FreeAction" ></a>FreeAction</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a30" doxytag="VirtualFreeAction" ></a>VirtualFreeAction</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a31" doxytag="ReAllocationAction" ></a>ReAllocationAction</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a60a32" doxytag="VirtualReAllocationAction" ></a>VirtualReAllocationAction</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00571">571</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.
<p>
<pre class="fragment"><div>00571                               {
00572 
00573     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a27">AllocationAction</a>,
00574     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a28">VirtualAllocationAction</a>,
00575     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a29">FreeAction</a>,
00576     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a30">VirtualFreeAction</a>,
00577     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a31">ReAllocationAction</a>,
00578     <a class="code" href="../../d9/d9/heappriv_8h.html#a60a32">VirtualReAllocationAction</a>
00579 
00580 } <a class="code" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a38" doxytag="heappriv.h::RtlAllocateHeapSlowly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID RtlAllocateHeapSlowly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">2075</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00351">_HEAP::AlignMask</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00350">_HEAP::AlignRound</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00397">ALLOC_HEAP_FILL</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a27">AllocationAction</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00395">CHECK_HEAP_TAIL_FILL</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00394">CHECK_HEAP_TAIL_SIZE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00103">DEBUG_HEAP</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00322">_HEAP::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00200">_HEAP_FREE_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00367">_HEAP::FreeLists</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d3/d9/heap_8h.html#a35">HEAP_ENTRY_EXTRA</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00237">HEAP_ENTRY_EXTRA_PRESENT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00238">HEAP_ENTRY_FILL_PATTERN</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00239">HEAP_ENTRY_VIRTUAL_ALLOC</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00231">HEAP_MAXIMUM_BLOCK_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00233">HEAP_MAXIMUM_FREELISTS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00401">HEAP_NEED_EXTRA_FLAGS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00400">HEAP_SMALL_TAG_MASK</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00563">IS_HEAP_TAGGING_ENABLED</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00277">_HEAP_SEGMENT::LastEntryInSegment</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00369">_HEAP::LockVariable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d9/heap_8h.html#a36">PHEAP_ENTRY_EXTRA</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00182">_HEAP_FREE_ENTRY::PreviousSize</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00365">_HEAP::PseudoTagEntries</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00078">RtlAcquireLockRoutine</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00068">RtlFindFirstSetRightMember</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06008">RtlpGetExtraStuffPointer()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00322">RtlpInsertFreeBlockDirect</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00465">RtlpRemoveFreeBlock</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05554">RtlpUpdateTagEntry()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00466">RtlRaiseException()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00079">RtlReleaseLockRoutine</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00060">_HEAP_ENTRY::SegmentIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00189">_HEAP_FREE_ENTRY::SegmentIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00355">_HEAP::Segments</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00104">SET_LAST_STATUS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00045">_HEAP_ENTRY::Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00174">_HEAP_FREE_ENTRY::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00331">_HEAP::TotalFreeSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d5/struct__HEAP.html#o25">_HEAP::u</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00085">_HEAP_ENTRY::UnusedBytes</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a28">VirtualAllocationAction</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00353">_HEAP::VirtualAllocdBlocks</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00324">_HEAP::VirtualMemoryThreshold</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, and <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>.
<p>
<pre class="fragment"><div>02083                    :
02084 
02085     This routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> equivalent of Rtl Allocate Heap but <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will
02086     additional heap consistency checking logic and tagging.
02087 
02088 Arguments:
02089 
02090     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> - Supplies a pointer to an initialized heap structure
02091 
02092     Flags - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of flags to use to <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation
02093 
02094     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation
02095 
02096 Return Value:
02097 
02098     PVOID - returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly allocated block
02099 
02100 --*/
02101 
02102 {
02103     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
02104     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02105     PVOID ReturnValue = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02106     PULONG FreeListsInUse;
02107     ULONG FreeListsInUseUlong;
02108     SIZE_T AllocationSize;
02109     SIZE_T FreeSize, AllocationIndex;
02110     UCHAR EntryFlags, FreeFlags;
02111     PLIST_ENTRY FreeListHead, Next;
02112     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
02113     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock, SplitBlock, SplitBlock2;
02114     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
02115     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02116     EXCEPTION_RECORD ExceptionRecord;
02117     SIZE_T ZeroSize = 0;
02118 
02119     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02120 
02121     <span class="comment">//</span>
02122     <span class="comment">//  Note that Flags has already been OR'd with Heap-&gt;ForceFlags.</span>
02123     <span class="comment">//</span>
02124 
02125 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
02126 <span class="preprocessor"></span>
02127     <span class="comment">//</span>
02128     <span class="comment">//  In the non kernel case check if we should be using the debug version</span>
02129     <span class="comment">//  of heap allocation</span>
02130     <span class="comment">//</span>
02131 
02132     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a8">DEBUG_HEAP</a>( Flags )) {
02133 
02134         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/heapdbg_8c.html#a13">RtlDebugAllocateHeap</a>( HeapHandle, Flags, Size );
02135     }
02136 
02137 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
02138 <span class="preprocessor"></span>
02139     <span class="comment">//</span>
02140     <span class="comment">//  If the size is greater than maxlong then say we can't allocate that</span>
02141     <span class="comment">//  much and return the error to our caller</span>
02142     <span class="comment">//</span>
02143 
02144     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; 0x7fffffff) {
02145 
02146         <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( STATUS_NO_MEMORY );
02147 
02148         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02149     }
02150 
02151     <span class="comment">//</span>
02152     <span class="comment">//  Round up the requested size to the allocation granularity.  Note</span>
02153     <span class="comment">//  that if the request is for zero bytes we will still allocate memory,</span>
02154     <span class="comment">//</span>
02155     <span class="comment">//      Allocation size will be either 16, 24, 32, ...</span>
02156     <span class="comment">//      Allocation index will be 2, 3, 4, ...</span>
02157     <span class="comment">//</span>
02158 
02159     AllocationSize = ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> ? <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> : 1) + Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o19">AlignRound</a>) &amp; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o20">AlignMask</a>;
02160 
02161     <span class="comment">//</span>
02162     <span class="comment">//  Generate the flags needed for this heap entry.  Mark it busy and add</span>
02163     <span class="comment">//  any user settable bits.  Also if the input flag indicates any entry</span>
02164     <span class="comment">//  extra fields and we have a tag to use then make room for the extra</span>
02165     <span class="comment">//  fields in the heap entry</span>
02166     <span class="comment">//</span>
02167 
02168     EntryFlags = (UCHAR)(<a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a> | ((Flags &amp; HEAP_SETTABLE_USER_FLAGS) &gt;&gt; 4));
02169 
02170     <span class="keywordflow">if</span> ((Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a31">HEAP_NEED_EXTRA_FLAGS</a>) || (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02171 
02172         EntryFlags |= <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>;
02173         AllocationSize += <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">HEAP_ENTRY_EXTRA</a> );
02174     }
02175 
02176     AllocationIndex = AllocationSize &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
02177 
02178     <span class="keywordflow">try</span> {
02179 
02180         <span class="comment">//</span>
02181         <span class="comment">//  Lock the free list.</span>
02182         <span class="comment">//</span>
02183 
02184         <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
02185 
02186             <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
02187 
02188             LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02189         }
02190 
02191         <span class="comment">//</span>
02192         <span class="comment">//  Do all the actual heap work under the protection of a try-except clause</span>
02193         <span class="comment">//  to protect us from corruption</span>
02194         <span class="comment">//</span>
02195 
02196         <span class="keywordflow">try</span> {
02197 
02198             <span class="comment">//</span>
02199             <span class="comment">//  If the allocation index is less than the maximum free list size</span>
02200             <span class="comment">//  then we can use the index to check the free list otherwise we have</span>
02201             <span class="comment">//  to either pull the entry off of the [0] index list or allocate</span>
02202             <span class="comment">//  memory directly for this request.</span>
02203             <span class="comment">//</span>
02204 
02205             <span class="keywordflow">if</span> (AllocationIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>) {
02206 
02207                 <span class="comment">//</span>
02208                 <span class="comment">//  With a size that matches a free list size grab the head</span>
02209                 <span class="comment">//  of the list and check if there is an available entry</span>
02210                 <span class="comment">//</span>
02211 
02212                 FreeListHead = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o30">FreeLists</a>[ AllocationIndex ];
02213 
02214                 <span class="keywordflow">if</span> ( !IsListEmpty( FreeListHead ))  {
02215 
02216                     <span class="comment">//</span>
02217                     <span class="comment">//  We're in luck the list has an entry so now get the free</span>
02218                     <span class="comment">//  entry,  copy its flags, remove it from the free list</span>
02219                     <span class="comment">//</span>
02220 
02221                     FreeBlock = CONTAINING_RECORD( FreeListHead-&gt;Flink,
02222                                                    <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>,
02223                                                    FreeList );
02224 
02225                     FreeFlags = FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a>;
02226 
02227                     <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, FreeBlock );
02228 
02229                     <span class="comment">//</span>
02230                     <span class="comment">//  Adjust the total number of bytes free in the heap</span>
02231                     <span class="comment">//</span>
02232 
02233                     Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> -= AllocationIndex;
02234 
02235                     <span class="comment">//</span>
02236                     <span class="comment">//  Mark the block as busy and and set the number of bytes</span>
02237                     <span class="comment">//  unused and tag index.  Also if it is the last entry</span>
02238                     <span class="comment">//  then keep that flag.</span>
02239                     <span class="comment">//</span>
02240 
02241                     BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock;
02242                     BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = EntryFlags | (FreeFlags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>);
02243                     BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o4">UnusedBytes</a> = (UCHAR)(AllocationSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02244 
02245                 } <span class="keywordflow">else</span> {
02246 
02247                     <span class="comment">//</span>
02248                     <span class="comment">//  The free list that matches our request is empty.  We know</span>
02249                     <span class="comment">//  that there are 128 free lists managed by a 4 ulong bitmap.</span>
02250                     <span class="comment">//  The next big if-else-if statement will decide which ulong</span>
02251                     <span class="comment">//  we tackle</span>
02252                     <span class="comment">//</span>
02253                     <span class="comment">//  Check if the requested allocation index within the first</span>
02254                     <span class="comment">//  quarter of the free lists.</span>
02255                     <span class="comment">//</span>
02256 
02257                     <span class="keywordflow">if</span> (AllocationIndex &lt; (<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 1) / 4) {
02258 
02259                         <span class="comment">//</span>
02260                         <span class="comment">//  Grab a pointer to the corresponding bitmap ulong, and</span>
02261                         <span class="comment">//  then get the bit we're actually interested in to be the</span>
02262                         <span class="comment">//  first bit of the ulong.</span>
02263                         <span class="comment">//</span>
02264 
02265                         FreeListsInUse = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o25">u</a>.FreeListsInUseUlong[ 0 ];
02266                         FreeListsInUseUlong = *FreeListsInUse++ &gt;&gt; ((ULONG) AllocationIndex &amp; 0x1F);
02267 
02268                         <span class="comment">//</span>
02269                         <span class="comment">//  If the remaining bitmap has any bits set then we know</span>
02270                         <span class="comment">//  there is a non empty list that is larger than our</span>
02271                         <span class="comment">//  requested index so find that bit and compute the list</span>
02272                         <span class="comment">//  head of the next non empty list</span>
02273                         <span class="comment">//</span>
02274 
02275                         <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02276 
02277                             FreeListHead += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02278 
02279                         } <span class="keywordflow">else</span> {
02280 
02281                             <span class="comment">//</span>
02282                             <span class="comment">//  The rest of the first ulong is all zeros so we need</span>
02283                             <span class="comment">//  to move to the second ulong</span>
02284                             <span class="comment">//</span>
02285 
02286                             FreeListsInUseUlong = *FreeListsInUse++;
02287 
02288                             <span class="comment">//</span>
02289                             <span class="comment">//  Check if the second ulong has any bits set and if</span>
02290                             <span class="comment">//  so then compute the list head of the next non empty</span>
02291                             <span class="comment">//  list</span>
02292                             <span class="comment">//</span>
02293 
02294                             <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02295 
02296                                 FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 1) / 4) -
02297                                     (AllocationIndex &amp; 0x1F)  +
02298                                     <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02299 
02300                             } <span class="keywordflow">else</span> {
02301 
02302                                 <span class="comment">//</span>
02303                                 <span class="comment">//  Do the same test for the third ulong</span>
02304                                 <span class="comment">//</span>
02305 
02306                                 FreeListsInUseUlong = *FreeListsInUse++;
02307 
02308                                 <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02309 
02310                                     FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 2) / 4) -
02311                                         (AllocationIndex &amp; 0x1F) +
02312                                         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02313 
02314                                 } <span class="keywordflow">else</span> {
02315 
02316                                     <span class="comment">//</span>
02317                                     <span class="comment">//  Repeat the test for the forth ulong, and if</span>
02318                                     <span class="comment">//  that one is also empty then we need to grab</span>
02319                                     <span class="comment">//  the allocation off of the [0] index list</span>
02320                                     <span class="comment">//</span>
02321 
02322                                     FreeListsInUseUlong = *FreeListsInUse++;
02323 
02324                                     <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02325 
02326                                         FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 3) / 4) -
02327                                             (AllocationIndex &amp; 0x1F)  +
02328                                             <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02329 
02330                                     } <span class="keywordflow">else</span> {
02331 
02332                                         <span class="keywordflow">goto</span> LookInNonDedicatedList;
02333                                     }
02334                                 }
02335                             }
02336                         }
02337 
02338                     <span class="comment">//</span>
02339                     <span class="comment">//  Otherwise check if the requested allocation index lies</span>
02340                     <span class="comment">//  within the second quarter of the free lists.  We repeat the</span>
02341                     <span class="comment">//  test just like we did above on the second, third, and forth</span>
02342                     <span class="comment">//  bitmap ulongs.</span>
02343                     <span class="comment">//</span>
02344 
02345                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AllocationIndex &lt; (<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 2) / 4) {
02346 
02347                         FreeListsInUse = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o25">u</a>.FreeListsInUseUlong[ 1 ];
02348                         FreeListsInUseUlong = *FreeListsInUse++ &gt;&gt; ((ULONG) AllocationIndex &amp; 0x1F);
02349 
02350                         <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02351 
02352                             FreeListHead += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02353 
02354                         } <span class="keywordflow">else</span> {
02355 
02356                             FreeListsInUseUlong = *FreeListsInUse++;
02357 
02358                             <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02359 
02360                                 FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 1) / 4) -
02361                                     (AllocationIndex &amp; 0x1F)  +
02362                                     <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02363 
02364                             } <span class="keywordflow">else</span> {
02365 
02366                                 FreeListsInUseUlong = *FreeListsInUse++;
02367 
02368                                 <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02369 
02370                                     FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 2) / 4) -
02371                                         (AllocationIndex &amp; 0x1F)  +
02372                                         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02373 
02374                                 } <span class="keywordflow">else</span> {
02375 
02376                                     <span class="keywordflow">goto</span> LookInNonDedicatedList;
02377                                 }
02378                             }
02379                         }
02380 
02381                     <span class="comment">//</span>
02382                     <span class="comment">//  Otherwise check if the requested allocation index lies</span>
02383                     <span class="comment">//  within the third quarter of the free lists. We repeat the</span>
02384                     <span class="comment">//  test just like we did above on the third and forth bitmap</span>
02385                     <span class="comment">//  ulongs</span>
02386                     <span class="comment">//</span>
02387 
02388                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AllocationIndex &lt; (<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 3) / 4) {
02389 
02390                         FreeListsInUse = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o25">u</a>.FreeListsInUseUlong[ 2 ];
02391                         FreeListsInUseUlong = *FreeListsInUse++ &gt;&gt; ((ULONG) AllocationIndex &amp; 0x1F);
02392 
02393                         <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02394 
02395                             FreeListHead += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02396 
02397                         } <span class="keywordflow">else</span> {
02398 
02399                             FreeListsInUseUlong = *FreeListsInUse++;
02400 
02401                             <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02402 
02403                                 FreeListHead += ((<a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> * 1) / 4) -
02404                                     (AllocationIndex &amp; 0x1F)  +
02405                                     <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02406 
02407                             } <span class="keywordflow">else</span> {
02408 
02409                                 <span class="keywordflow">goto</span> LookInNonDedicatedList;
02410                             }
02411                         }
02412 
02413                     <span class="comment">//</span>
02414                     <span class="comment">//  Lastly the requested allocation index must lie within the</span>
02415                     <span class="comment">//  last quarter of the free lists.  We repeat the test just</span>
02416                     <span class="comment">//  like we did above on the forth ulong</span>
02417                     <span class="comment">//</span>
02418 
02419                     } <span class="keywordflow">else</span> {
02420 
02421                         FreeListsInUse = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o25">u</a>.FreeListsInUseUlong[ 3 ];
02422                         FreeListsInUseUlong = *FreeListsInUse++ &gt;&gt; ((ULONG) AllocationIndex &amp; 0x1F);
02423 
02424                         <span class="keywordflow">if</span> (FreeListsInUseUlong) {
02425 
02426                             FreeListHead += <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a1">RtlFindFirstSetRightMember</a>( FreeListsInUseUlong );
02427 
02428                         } <span class="keywordflow">else</span> {
02429 
02430                             <span class="keywordflow">goto</span> LookInNonDedicatedList;
02431                         }
02432                     }
02433 
02434                     <span class="comment">//</span>
02435                     <span class="comment">//  At this point the free list head points to a non empty free</span>
02436                     <span class="comment">//  list that is of greater size than we need.</span>
02437                     <span class="comment">//</span>
02438 
02439                     FreeBlock = CONTAINING_RECORD( FreeListHead-&gt;Flink,
02440                                                    <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>,
02441                                                    FreeList );
02442 
02443     SplitFreeBlock:
02444 
02445                     <span class="comment">//</span>
02446                     <span class="comment">//  Remember the flags that go with this block and remove it</span>
02447                     <span class="comment">//  from its list</span>
02448                     <span class="comment">//</span>
02449 
02450                     FreeFlags = FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a>;
02451 
02452                     <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, FreeBlock );
02453 
02454                     <span class="comment">//</span>
02455                     <span class="comment">//  Adjust the amount free in the heap</span>
02456                     <span class="comment">//</span>
02457 
02458                     Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> -= FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
02459 
02460                     <span class="comment">//</span>
02461                     <span class="comment">//  Mark the block busy</span>
02462                     <span class="comment">//</span>
02463 
02464                     BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock;
02465                     BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = EntryFlags;
02466 
02467                     <span class="comment">//</span>
02468                     <span class="comment">//  Compute the size (i.e., index) of the amount from this</span>
02469                     <span class="comment">//  block that we don't need and can return to the free list</span>
02470                     <span class="comment">//</span>
02471 
02472                     FreeSize = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> - AllocationIndex;
02473 
02474                     <span class="comment">//</span>
02475                     <span class="comment">//  Finish setting up the rest of the new busy block</span>
02476                     <span class="comment">//</span>
02477 
02478                     BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AllocationIndex;
02479                     BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o4">UnusedBytes</a> = (UCHAR)(AllocationSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02480 
02481                     <span class="comment">//</span>
02482                     <span class="comment">//  Now if the size that we are going to free up is not zero</span>
02483                     <span class="comment">//  then lets get to work and to the split.</span>
02484                     <span class="comment">//</span>
02485 
02486                     <span class="keywordflow">if</span> (FreeSize != 0) {
02487 
02488                         <span class="comment">//</span>
02489                         <span class="comment">//  But first we won't ever bother doing a split that only</span>
02490                         <span class="comment">//  gives us 8 bytes back.  So if free size is one then</span>
02491                         <span class="comment">//  just bump up the size of the new busy block</span>
02492                         <span class="comment">//</span>
02493 
02494                         <span class="keywordflow">if</span> (FreeSize == 1) {
02495 
02496                             BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> += 1;
02497                             BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o4">UnusedBytes</a> += <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">HEAP_ENTRY</a> );
02498 
02499                         } <span class="keywordflow">else</span> {
02500 
02501                             <span class="comment">//</span>
02502                             <span class="comment">//  Get a pointer to where the new free block will be.</span>
02503                             <span class="comment">//  When we split a block the first part goes to the</span>
02504                             <span class="comment">//  new busy block and the second part goes back to the</span>
02505                             <span class="comment">//  free list</span>
02506                             <span class="comment">//</span>
02507 
02508                             SplitBlock = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)(BusyBlock + AllocationIndex);
02509 
02510                             <span class="comment">//</span>
02511                             <span class="comment">//  Reset the flags that we copied from the original</span>
02512                             <span class="comment">//  free list header, and set it other size fields.</span>
02513                             <span class="comment">//</span>
02514 
02515                             SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> = FreeFlags;
02516                             SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)AllocationIndex;
02517                             SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o2">SegmentIndex</a> = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a>;
02518                             SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeSize;
02519 
02520                             <span class="comment">//</span>
02521                             <span class="comment">//  If nothing else follows this entry then we will</span>
02522                             <span class="comment">//  insert this into the corresponding free list</span>
02523                             <span class="comment">//</span>
02524 
02525                             <span class="keywordflow">if</span> (FreeFlags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) {
02526 
02527                                 <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, SplitBlock, (USHORT)FreeSize );
02528 
02529                                 Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> += FreeSize;
02530 
02531                             } <span class="keywordflow">else</span> {
02532 
02533                                 <span class="comment">//</span>
02534                                 <span class="comment">//  Otherwise we need to check the following block</span>
02535                                 <span class="comment">//  and if it is busy then update its previous size</span>
02536                                 <span class="comment">//  before inserting our new free block into the</span>
02537                                 <span class="comment">//  free list</span>
02538                                 <span class="comment">//</span>
02539 
02540                                 SplitBlock2 = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)SplitBlock + FreeSize);
02541 
02542                                 <span class="keywordflow">if</span> (SplitBlock2-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) {
02543 
02544                                     SplitBlock2-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeSize;
02545 
02546                                     <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, SplitBlock, (USHORT)FreeSize );
02547 
02548                                     Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> += FreeSize;
02549 
02550                                 } <span class="keywordflow">else</span> {
02551 
02552                                     <span class="comment">//</span>
02553                                     <span class="comment">//  The following block is free so we'll merge</span>
02554                                     <span class="comment">//  these to blocks. by first merging the flags</span>
02555                                     <span class="comment">//</span>
02556 
02557                                     SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> = SplitBlock2-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a>;
02558 
02559                                     <span class="comment">//</span>
02560                                     <span class="comment">//  Removing the second block from its free</span>
02561                                     <span class="comment">//  list</span>
02562                                     <span class="comment">//</span>
02563 
02564                                     <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, SplitBlock2 );
02565 
02566                                     <span class="comment">//</span>
02567                                     <span class="comment">//  Updating the free total number of free</span>
02568                                     <span class="comment">//  bytes in the heap and updating the size of</span>
02569                                     <span class="comment">//  the new free block</span>
02570                                     <span class="comment">//</span>
02571 
02572                                     Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> -= SplitBlock2-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
02573                                     FreeSize += SplitBlock2-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
02574 
02575                                     <span class="comment">//</span>
02576                                     <span class="comment">//  If the new free block is still less than</span>
02577                                     <span class="comment">//  the maximum heap block size then we'll</span>
02578                                     <span class="comment">//  simply insert it back in the free list</span>
02579                                     <span class="comment">//</span>
02580 
02581                                     <span class="keywordflow">if</span> (FreeSize &lt;= <a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>) {
02582 
02583                                         SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeSize;
02584 
02585                                         <span class="comment">//</span>
02586                                         <span class="comment">//  Again check if the new following block</span>
02587                                         <span class="comment">//  exists and if so then updsate is</span>
02588                                         <span class="comment">//  previous size</span>
02589                                         <span class="comment">//</span>
02590 
02591                                         <span class="keywordflow">if</span> (!(SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
02592 
02593                                             ((<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)SplitBlock + FreeSize))-&gt;PreviousSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeSize;
02594                                         }
02595 
02596                                         <span class="comment">//</span>
02597                                         <span class="comment">//  Insert the new free block into the free</span>
02598                                         <span class="comment">//  list and update the free heap size</span>
02599                                         <span class="comment">//</span>
02600 
02601                                         <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, SplitBlock, (USHORT)FreeSize );
02602 
02603                                         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> += FreeSize;
02604 
02605                                     } <span class="keywordflow">else</span> {
02606 
02607                                         <span class="comment">//</span>
02608                                         <span class="comment">//  The new free block is pretty large so</span>
02609                                         <span class="comment">//  we need to call a private routine to do</span>
02610                                         <span class="comment">//  the insert</span>
02611                                         <span class="comment">//</span>
02612 
02613                                         <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, SplitBlock, FreeSize );
02614                                     }
02615                                 }
02616                             }
02617 
02618                             <span class="comment">//</span>
02619                             <span class="comment">//  Now that free flags made it back into a free block</span>
02620                             <span class="comment">//  we can zero out what we saved.</span>
02621                             <span class="comment">//</span>
02622 
02623                             FreeFlags = 0;
02624 
02625                             <span class="comment">//</span>
02626                             <span class="comment">//  If splitblock now last, update LastEntryInSegment</span>
02627                             <span class="comment">//</span>
02628 
02629                             <span class="keywordflow">if</span> (SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) {
02630 
02631                                 <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
02632 
02633                                 Segment = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o22">Segments</a>[SplitBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o2">SegmentIndex</a>];
02634                                 Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)SplitBlock;
02635                             }
02636 
02637                         }
02638                     }
02639 
02640                     <span class="comment">//</span>
02641                     <span class="comment">//  If there are no following entries then mark the new block</span>
02642                     <span class="comment">//  as such</span>
02643                     <span class="comment">//</span>
02644 
02645                     <span class="keywordflow">if</span> (FreeFlags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) {
02646 
02647                         BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> |= <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
02648                     }
02649                 }
02650 
02651                 <span class="comment">//</span>
02652                 <span class="comment">//  Return the address of the user portion of the allocated block.</span>
02653                 <span class="comment">//  This is the byte following the header.</span>
02654                 <span class="comment">//</span>
02655 
02656                 ReturnValue = BusyBlock + 1;
02657 
02658                 <span class="comment">//</span>
02659                 <span class="comment">//  If the flags indicate that we should zero memory then</span>
02660                 <span class="comment">//  remember how much to zero.  We'll do the zeroing later</span>
02661                 <span class="comment">//</span>
02662 
02663                 <span class="keywordflow">if</span> (Flags &amp; HEAP_ZERO_MEMORY) {
02664 
02665                     ZeroSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02666 
02667                 <span class="comment">//</span>
02668                 <span class="comment">//  Otherwise if the flags indicate that we should fill heap then</span>
02669                 <span class="comment">//  it it now.</span>
02670                 <span class="comment">//</span>
02671 
02672                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_FREE_CHECKING_ENABLED) {
02673 
02674                     RtlFillMemoryUlong( (PCHAR)(BusyBlock + 1), Size &amp; ~0x3, ALLOC_HEAP_FILL );
02675                 }
02676 
02677                 <span class="comment">//</span>
02678                 <span class="comment">//  If the flags indicate that we should do tail checking then copy</span>
02679                 <span class="comment">//  the fill pattern right after the heap block.</span>
02680                 <span class="comment">//</span>
02681 
02682                 <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_TAIL_CHECKING_ENABLED) {
02683 
02684                     RtlFillMemory( (PCHAR)ReturnValue + Size,
02685                                    CHECK_HEAP_TAIL_SIZE,
02686                                    CHECK_HEAP_TAIL_FILL );
02687 
02688                     BusyBlock-&gt;Flags |= <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>;
02689                 }
02690 
02691                 BusyBlock-&gt;SmallTagIndex = 0;
02692 
02693                 <span class="comment">//</span>
02694                 <span class="comment">//  If the flags indicate that there is an extra block persent then</span>
02695                 <span class="comment">//  we'll fill it in</span>
02696                 <span class="comment">//</span>
02697 
02698                 <span class="keywordflow">if</span> (BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
02699 
02700                     ExtraStuff = <a class="code" href="../../d9/d9/heappriv_8h.html#a41">RtlpGetExtraStuffPointer</a>( BusyBlock );
02701 
02702                     RtlZeroMemory( ExtraStuff, <span class="keyword">sizeof</span>( *ExtraStuff ));
02703 
02704 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
02705 <span class="preprocessor"></span>
02706                 <span class="comment">//</span>
02707                 <span class="comment">//  In the non kernel case the tagging goes in either the extra</span>
02708                 <span class="comment">//  stuff of the busy block small tag index</span>
02709                 <span class="comment">//</span>
02710 
02711                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) {
02712 
02713                         ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a> = <a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
02714                                                                    (USHORT)((Flags &amp; HEAP_TAG_MASK) &gt;&gt; HEAP_TAG_SHIFT),
02715                                                                    0,
02716                                                                    BusyBlock-&gt;Size,
02717                                                                    AllocationAction );
02718                     }
02719 
02720                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) {
02721 
02722                     BusyBlock-&gt;SmallTagIndex = (UCHAR)<a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
02723                                                                           (USHORT)((Flags &amp; HEAP_SMALL_TAG_MASK) &gt;&gt; HEAP_TAG_SHIFT),
02724                                                                           0,
02725                                                                           BusyBlock-&gt;Size,
02726                                                                           AllocationAction );
02727 
02728 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
02729 <span class="preprocessor"></span>
02730                 }
02731 
02732                 <span class="comment">//</span>
02733                 <span class="comment">//  Return the address of the user portion of the allocated block.</span>
02734                 <span class="comment">//  This is the byte following the header.</span>
02735                 <span class="comment">//</span>
02736 
02737                 leave;
02738 
02739             <span class="comment">//</span>
02740             <span class="comment">//  Otherwise the allocation request is bigger than the last dedicated</span>
02741             <span class="comment">//  free list size.  Now check if the size is within our threshold.</span>
02742             <span class="comment">//  Meaning that it could be in the [0] free list</span>
02743             <span class="comment">//</span>
02744 
02745             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AllocationIndex &lt;= Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o4">VirtualMemoryThreshold</a>) {
02746 
02747     LookInNonDedicatedList:
02748 
02749                 <span class="comment">//</span>
02750                 <span class="comment">//  The following code cycles through the [0] free list until</span>
02751                 <span class="comment">//  it finds a block that satisfies the request.  The list</span>
02752                 <span class="comment">//  is sorted so the search is can be terminated early on success</span>
02753                 <span class="comment">//</span>
02754 
02755                 FreeListHead = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o30">FreeLists</a>[ 0 ];
02756                 Next = FreeListHead-&gt;Flink;
02757 
02758                 <span class="keywordflow">while</span> (FreeListHead != Next) {
02759 
02760                     FreeBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>, FreeList );
02761 
02762                     <span class="keywordflow">if</span> (FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> &gt;= AllocationIndex) {
02763 
02764                         <span class="comment">//</span>
02765                         <span class="comment">//  We've found something that we can use so now go to</span>
02766                         <span class="comment">//  where we treat spliting a free block.  Note that</span>
02767                         <span class="comment">//  the block we found here might actually be the exact</span>
02768                         <span class="comment">//  size we need and that is why in the split free block</span>
02769                         <span class="comment">//  case we have to consider having nothing free after the</span>
02770                         <span class="comment">//  split</span>
02771                         <span class="comment">//</span>
02772 
02773                         <span class="keywordflow">goto</span> SplitFreeBlock;
02774 
02775                     } <span class="keywordflow">else</span> {
02776 
02777                         Next = Next-&gt;Flink;
02778                     }
02779                 }
02780 
02781                 <span class="comment">//</span>
02782                 <span class="comment">//  The [0] list is either empty or everything is too small</span>
02783                 <span class="comment">//  so now extend the heap which should get us something less</span>
02784                 <span class="comment">//  than or equal to the virtual memory threshold</span>
02785                 <span class="comment">//</span>
02786 
02787                 FreeBlock = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a14">RtlpExtendHeap</a>( Heap, AllocationSize );
02788 
02789                 <span class="comment">//</span>
02790                 <span class="comment">//  And provided we got something we'll treat it just like the</span>
02791                 <span class="comment">//  previous split free block cases</span>
02792                 <span class="comment">//</span>
02793 
02794                 <span class="keywordflow">if</span> (FreeBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02795 
02796                     <span class="keywordflow">goto</span> SplitFreeBlock;
02797                 }
02798 
02799                 <span class="comment">//</span>
02800                 <span class="comment">//  We weren't able to extend the heap so we must be out of memory</span>
02801                 <span class="comment">//</span>
02802 
02803                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02804 
02805             <span class="comment">//</span>
02806             <span class="comment">//  At this point the allocation is way too big for any of the free</span>
02807             <span class="comment">//  lists and we can only satisfy this request if the heap is growable</span>
02808             <span class="comment">//</span>
02809 
02810             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_GROWABLE) {
02811 
02812                 <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
02813 
02814                 VirtualAllocBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02815 
02816                 <span class="comment">//</span>
02817                 <span class="comment">//  Compute how much memory we will need for this allocation which</span>
02818                 <span class="comment">//  will include the allocation size plus a header, and then go</span>
02819                 <span class="comment">//  get the committed memory</span>
02820                 <span class="comment">//</span>
02821 
02822                 AllocationSize += FIELD_OFFSET( <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock );
02823 
02824                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
02825                                                   (PVOID *)&amp;VirtualAllocBlock,
02826                                                   0,
02827                                                   &amp;AllocationSize,
02828                                                   MEM_COMMIT,
02829                                                   PAGE_READWRITE );
02830 
02831                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02832 
02833                     <span class="comment">//</span>
02834                     <span class="comment">//  Just committed, already zero.  Fill in the new block</span>
02835                     <span class="comment">//  and insert it in the list of big allocation</span>
02836                     <span class="comment">//</span>
02837 
02838                     VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a>.<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(AllocationSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
02839                     VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a>.<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = EntryFlags | <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a> | <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>;
02840                     VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> = AllocationSize;
02841                     VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o3">ReserveSize</a> = AllocationSize;
02842 
02843 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
02844 <span class="preprocessor"></span>
02845                     <span class="comment">//</span>
02846                     <span class="comment">//  In the non kernel case see if we need to add heap tagging</span>
02847                     <span class="comment">//</span>
02848 
02849                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) {
02850 
02851                         VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a> =
02852                             <a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
02853                                                 (USHORT)((Flags &amp; HEAP_SMALL_TAG_MASK) &gt;&gt; HEAP_TAG_SHIFT),
02854                                                 0,
02855                                                 VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; HEAP_GRANULARITY_SHIFT,
02856                                                 VirtualAllocationAction );
02857                     }
02858 
02859 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
02860 <span class="preprocessor"></span>
02861                     InsertTailList( &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o21">VirtualAllocdBlocks</a>, (PLIST_ENTRY)VirtualAllocBlock );
02862 
02863                     <span class="comment">//</span>
02864                     <span class="comment">//  Return the address of the user portion of the allocated</span>
02865                     <span class="comment">//  block.  This is the byte following the header.</span>
02866                     <span class="comment">//</span>
02867 
02868                     ReturnValue = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)(VirtualAllocBlock + 1);
02869 
02870                     leave;
02871                 }
02872 
02873             <span class="comment">//</span>
02874             <span class="comment">//  Otherwise we have an error condition</span>
02875             <span class="comment">//</span>
02876 
02877             } <span class="keywordflow">else</span> {
02878 
02879                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
02880             }
02881 
02882             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( Status );
02883 
02884             <span class="keywordflow">if</span> (Flags &amp; HEAP_GENERATE_EXCEPTIONS) {
02885 
02886                 <span class="comment">//</span>
02887                 <span class="comment">//  Construct an exception record.</span>
02888                 <span class="comment">//</span>
02889 
02890                 ExceptionRecord.ExceptionCode = STATUS_NO_MEMORY;
02891                 ExceptionRecord.ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02892                 ExceptionRecord.NumberParameters = 1;
02893                 ExceptionRecord.ExceptionFlags = 0;
02894                 ExceptionRecord.ExceptionInformation[ 0 ] = AllocationSize;
02895 
02896                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a>( &amp;ExceptionRecord );
02897             }
02898 
02899         } except( GetExceptionCode() == STATUS_NO_MEMORY ? EXCEPTION_CONTINUE_SEARCH :
02900                                                            EXCEPTION_EXECUTE_HANDLER ) {
02901 
02902             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
02903         }
02904 
02905         <span class="comment">//</span>
02906         <span class="comment">//  Check if there is anything to zero out</span>
02907         <span class="comment">//</span>
02908 
02909         <span class="keywordflow">if</span> ( ZeroSize ) {
02910 
02911             RtlZeroMemory( ReturnValue, ZeroSize );
02912         }
02913 
02914     } finally {
02915 
02916         <span class="keywordflow">if</span> (LockAcquired) {
02917 
02918             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
02919         }
02920     }
02921 
02922     <span class="comment">//</span>
02923     <span class="comment">//  And return to our caller</span>
02924     <span class="comment">//</span>
02925 
02926     <span class="keywordflow">return</span> ReturnValue;
02927 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="heappriv.h::RtlFreeHeapSlowly" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlFreeHeapSlowly           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>HeapHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">3273</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00162">_HEAP_VIRTUAL_ALLOC_ENTRY::CommitSize</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00103">DEBUG_HEAP</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00328">_HEAP::DeCommitFreeBlockThreshold</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00329">_HEAP::DeCommitTotalFreeThreshold</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00160">_HEAP_VIRTUAL_ALLOC_ENTRY::Entry</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00161">_HEAP_VIRTUAL_ALLOC_ENTRY::ExtraStuff</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00200">_HEAP_FREE_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00322">_HEAP::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a29">FreeAction</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00150">_HEAP_FREE_ENTRY_EXTRA::FreeBackTraceIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00392">HEAP_CAPTURE_STACK_BACKTRACES</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00237">HEAP_ENTRY_EXTRA_PRESENT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00239">HEAP_ENTRY_VIRTUAL_ALLOC</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00231">HEAP_MAXIMUM_BLOCK_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00234">HEAP_MAXIMUM_SEGMENTS</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00039">HEAPASSERT</a>, <a class="el" href="../../d5/d5/memory_8c-source.html#l00115">HeapHandle</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00563">IS_HEAP_TAGGING_ENABLED</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00369">_HEAP::LockVariable</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d3/d9/heap_8h.html#a38">PHEAP_FREE_ENTRY_EXTRA</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00078">RtlAcquireLockRoutine</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05312">RtlpCoalesceFreeBlocks()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00322">RtlpInsertFreeBlockDirect</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05554">RtlpUpdateTagEntry()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00079">RtlReleaseLockRoutine</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00060">_HEAP_ENTRY::SegmentIndex</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00104">SET_LAST_STATUS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00045">_HEAP_ENTRY::Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00091">_HEAP_ENTRY::SmallTagIndex</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00149">_HEAP_FREE_ENTRY_EXTRA::TagIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00121">_HEAP_ENTRY_EXTRA::TagIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00331">_HEAP::TotalFreeSize</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d9/d9/heappriv_8h.html#a60a30">VirtualFreeAction</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>.
<p>
<pre class="fragment"><div>03281                    :
03282 
03283     This routine returns a previously allocated block back to its heap.
03284     It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> slower version of Rtl Free Heap and does more checking and
03285     tagging <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
03286 
03287 Arguments:
03288 
03289     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owning heap structure
03290 
03291     Flags - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of flags to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deallocation
03292 
03293     BaseAddress - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block being freed
03294 
03295 Return Value:
03296 
03297     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block was properly freed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
03298 
03299 --*/
03300 
03301 {
03302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03303     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> Heap = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a>)<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>;
03304     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> BusyBlock;
03305     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> ExtraStuff;
03306     SIZE_T FreeSize;
03307     BOOLEAN Result;
03308     BOOLEAN LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03309 
03310 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
03311 <span class="preprocessor"></span>
03312     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
03313 
03314 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
03315 <span class="preprocessor"></span>
03316     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
03317 
03318     <span class="comment">//</span>
03319     <span class="comment">//  Note that Flags has already been OR'd with Heap-&gt;ForceFlags.</span>
03320     <span class="comment">//</span>
03321 
03322 <span class="preprocessor">#ifndef NTOS_KERNEL_RUNTIME</span>
03323 <span class="preprocessor"></span>
03324     <span class="comment">//</span>
03325     <span class="comment">//  In the non kernel case see if we should be calling the debug version to</span>
03326     <span class="comment">//  free the heap</span>
03327     <span class="comment">//</span>
03328 
03329     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a8">DEBUG_HEAP</a>( Flags )) {
03330 
03331         <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/heapdbg_8c.html#a15">RtlDebugFreeHeap</a>( HeapHandle, Flags, BaseAddress );
03332     }
03333 
03334 <span class="preprocessor">#endif // NTOS_KERNEL_RUNTIME</span>
03335 <span class="preprocessor"></span>
03336     <span class="comment">//</span>
03337     <span class="comment">//  Until we figure out otherwise we'll assume that this call will fail</span>
03338     <span class="comment">//</span>
03339 
03340     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03341 
03342     <span class="keywordflow">try</span> {
03343 
03344         <span class="comment">//</span>
03345         <span class="comment">//  Lock the heap</span>
03346         <span class="comment">//</span>
03347 
03348         <span class="keywordflow">if</span> (!(Flags &amp; HEAP_NO_SERIALIZE)) {
03349 
03350             <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
03351 
03352             LockAcquired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03353         }
03354 
03355         <span class="keywordflow">try</span> {
03356 
03357             <span class="comment">//</span>
03358             <span class="comment">//  Backup to get a pointer to the start of the block</span>
03359             <span class="comment">//</span>
03360 
03361             BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)BaseAddress - 1;
03362 
03363             <span class="comment">//</span>
03364             <span class="comment">//  Protect ourselves from idiots by refusing to free blocks</span>
03365             <span class="comment">//  that do not have the busy bit set.</span>
03366             <span class="comment">//</span>
03367             <span class="comment">//  Also refuse to free blocks that are not eight-byte aligned.</span>
03368             <span class="comment">//  The specific idiot in this case is Office95, which likes</span>
03369             <span class="comment">//  to free a random pointer when you start Word95 from a desktop</span>
03370             <span class="comment">//  shortcut.</span>
03371             <span class="comment">//</span>
03372             <span class="comment">//  As further insurance against idiots, check the segment index</span>
03373             <span class="comment">//  to make sure it is less than HEAP_MAXIMUM_SEGMENTS (16). This</span>
03374             <span class="comment">//  should fix all the dorks who have ASCII or Unicode where the</span>
03375             <span class="comment">//  heap header is supposed to be.</span>
03376             <span class="comment">//</span>
03377             <span class="comment">//  Note that this test is just opposite from the test used in</span>
03378             <span class="comment">//  Rtl Free Heap</span>
03379             <span class="comment">//</span>
03380 
03381             <span class="keywordflow">if</span> ((BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) &amp;&amp;
03382                 (((ULONG_PTR)BaseAddress &amp; 0x7) == 0) &amp;&amp;
03383                 (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a> &lt; <a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>)) {
03384 
03385                 <span class="comment">//</span>
03386                 <span class="comment">//  Check if this is a virtual block allocation</span>
03387                 <span class="comment">//</span>
03388 
03389                 <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) {
03390 
03391                     <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
03392 
03393                     <span class="comment">//</span>
03394                     <span class="comment">//  This is a big virtual block allocation.  To free it</span>
03395                     <span class="comment">//  we only have to remove it from the heaps list of</span>
03396                     <span class="comment">//  virtual allocated blocks, unlock the heap, and return</span>
03397                     <span class="comment">//  the block to vm</span>
03398                     <span class="comment">//</span>
03399 
03400                     VirtualAllocBlock = CONTAINING_RECORD( BusyBlock, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock );
03401 
03402                     RemoveEntryList( &amp;VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o0">Entry</a> );
03403 
03404 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
03405 <span class="preprocessor"></span>
03406                     <span class="comment">//</span>
03407                     <span class="comment">//  In the non kernel case see if we need to free the tag</span>
03408                     <span class="comment">//</span>
03409 
03410                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) {
03411 
03412                         <a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
03413                                             VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>,
03414                                             VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; HEAP_GRANULARITY_SHIFT,
03415                                             0,
03416                                             VirtualFreeAction );
03417                     }
03418 
03419 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
03420 <span class="preprocessor"></span>
03421                     FreeSize = 0;
03422 
03423                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
03424                                                   (PVOID *)&amp;VirtualAllocBlock,
03425                                                   &amp;FreeSize,
03426                                                   MEM_RELEASE );
03427 
03428                     <span class="comment">//</span>
03429                     <span class="comment">//  Check if everything worked okay, if we had trouble freeing</span>
03430                     <span class="comment">//  the block back to vm return an error if necessary,</span>
03431                     <span class="comment">//</span>
03432 
03433                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
03434 
03435                         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03436 
03437                     } <span class="keywordflow">else</span> {
03438 
03439                         <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( Status );
03440                     }
03441 
03442                 } <span class="keywordflow">else</span> {
03443 
03444                     <span class="comment">//</span>
03445                     <span class="comment">//  This block is not a big allocation so we need to</span>
03446                     <span class="comment">//  to get its size, and coalesce the blocks note that</span>
03447                     <span class="comment">//  the user mode heap does this conditionally on a heap</span>
03448                     <span class="comment">//  flag.  The coalesce function returns the newly formed</span>
03449                     <span class="comment">//  free block and the new size.</span>
03450                     <span class="comment">//</span>
03451 
03452 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
03453 <span class="preprocessor"></span>
03454                     <span class="comment">//</span>
03455                     <span class="comment">//  First in the non kernel case remove any tagging we might</span>
03456                     <span class="comment">//  have been using.  Note that the will either be in</span>
03457                     <span class="comment">//  the heap header, or in the extra block if present</span>
03458                     <span class="comment">//</span>
03459 
03460                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/heappriv_8h.html#a22">IS_HEAP_TAGGING_ENABLED</a>()) {
03461 
03462                         <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>) {
03463 
03464                             ExtraStuff = (<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a>)(BusyBlock + BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> - 1);
03465 
03466                             TagIndex = <a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
03467                                                            ExtraStuff-&gt;<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>,
03468                                                            BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>,
03469                                                            0,
03470                                                            FreeAction );
03471 
03472                         } <span class="keywordflow">else</span> {
03473 
03474                             TagIndex = <a class="code" href="../../d9/d9/heappriv_8h.html#a52">RtlpUpdateTagEntry</a>( Heap,
03475                                                            BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o5">SmallTagIndex</a>,
03476                                                            BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>,
03477                                                            0,
03478                                                            FreeAction );
03479                         }
03480 
03481                     } <span class="keywordflow">else</span> {
03482 
03483                         TagIndex = 0;
03484                     }
03485 
03486 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
03487 <span class="preprocessor"></span>
03488                     <span class="comment">//</span>
03489                     <span class="comment">//  This is the size of the block we are freeing</span>
03490                     <span class="comment">//</span>
03491 
03492                     FreeSize = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
03493 
03494 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
03495 <span class="preprocessor"></span>
03496                     <span class="comment">//</span>
03497                     <span class="comment">//  In the non kernel case see if we should coalesce on free</span>
03498                     <span class="comment">//</span>
03499 
03500                     <span class="keywordflow">if</span> (!(Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; HEAP_DISABLE_COALESCE_ON_FREE)) {
03501 
03502 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
03503 <span class="preprocessor"></span>
03504                         <span class="comment">//</span>
03505                         <span class="comment">//  In kernel case and in the tested user mode case we</span>
03506                         <span class="comment">//  now coalesce free blocks</span>
03507                         <span class="comment">//</span>
03508 
03509                         BusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)<a class="code" href="../../d9/d9/heappriv_8h.html#a34">RtlpCoalesceFreeBlocks</a>( Heap, (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)BusyBlock, &amp;FreeSize, FALSE );
03510 
03511 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
03512 <span class="preprocessor"></span>
03513                     }
03514 
03515 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
03516 <span class="preprocessor"></span>
03517                     <span class="comment">//</span>
03518                     <span class="comment">//  If the block should not be decommit then try and put it</span>
03519                     <span class="comment">//  on a free list</span>
03520                     <span class="comment">//</span>
03521 
03522                     <span class="keywordflow">if</span> ((FreeSize &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o7">DeCommitFreeBlockThreshold</a>) ||
03523                         ((Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> + FreeSize) &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o8">DeCommitTotalFreeThreshold</a>)) {
03524 
03525                         <span class="comment">//</span>
03526                         <span class="comment">//  Check if the block can fit on one of the dedicated free</span>
03527                         <span class="comment">//  lists</span>
03528                         <span class="comment">//</span>
03529 
03530                         <span class="keywordflow">if</span> (FreeSize &lt;= (ULONG)<a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>) {
03531 
03532                             <span class="comment">//</span>
03533                             <span class="comment">//  It can fit on a dedicated free list so insert it on</span>
03534                             <span class="comment">//</span>
03535 
03536                             <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)BusyBlock, (USHORT)FreeSize );
03537 
03538                             <span class="comment">//</span>
03539                             <span class="comment">//  If there is a following entry then make sure the</span>
03540                             <span class="comment">//  sizes agree</span>
03541                             <span class="comment">//</span>
03542 
03543                             <span class="keywordflow">if</span> (!(BusyBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
03544 
03545                                 <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>((BusyBlock + FreeSize)-&gt;PreviousSize == (USHORT)FreeSize);
03546                             }
03547 
03548                             <span class="comment">//</span>
03549                             <span class="comment">//  Update the heap with the amount of free space</span>
03550                             <span class="comment">//  available</span>
03551                             <span class="comment">//</span>
03552 
03553                             Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o9">TotalFreeSize</a> += FreeSize;
03554 
03555                         } <span class="keywordflow">else</span> {
03556 
03557                             <span class="comment">//</span>
03558                             <span class="comment">//  The block goes on the non dedicated free list</span>
03559                             <span class="comment">//</span>
03560 
03561                             <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)BusyBlock, FreeSize );
03562                         }
03563 
03564 <span class="preprocessor">    #ifndef NTOS_KERNEL_RUNTIME</span>
03565 <span class="preprocessor"></span>
03566                         <span class="comment">//</span>
03567                         <span class="comment">//  In the non kernel case see if the there was tag and if</span>
03568                         <span class="comment">//  so then update the entry to show that it's been freed</span>
03569                         <span class="comment">//</span>
03570 
03571                         <span class="keywordflow">if</span> (TagIndex != 0) {
03572 
03573                             <a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">PHEAP_FREE_ENTRY_EXTRA</a> FreeExtra;
03574 
03575                             BusyBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> |= <a class="code" href="../../d3/d9/heap_8h.html#a9">HEAP_ENTRY_EXTRA_PRESENT</a>;
03576 
03577                             FreeExtra = (<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html">PHEAP_FREE_ENTRY_EXTRA</a>)(BusyBlock + BusyBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>) - 1;
03578 
03579                             FreeExtra-&gt;<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html#o0">TagIndex</a> = TagIndex;
03580                             FreeExtra-&gt;<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html#o1">FreeBackTraceIndex</a> = 0;
03581 
03582 <span class="preprocessor">    #if i386</span>
03583 <span class="preprocessor"></span>
03584                             <span class="comment">//</span>
03585                             <span class="comment">//  In the x86 case we can also capture the stack</span>
03586                             <span class="comment">//  backtrace</span>
03587                             <span class="comment">//</span>
03588 
03589                             <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o2">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a24">HEAP_CAPTURE_STACK_BACKTRACES</a>) {
03590 
03591                                 FreeExtra-&gt;<a class="code" href="../../d2/d6/struct__HEAP__FREE__ENTRY__EXTRA.html#o1">FreeBackTraceIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
03592                             }
03593 
03594 <span class="preprocessor">    #endif // i386</span>
03595 <span class="preprocessor"></span>
03596                         }
03597 
03598 <span class="preprocessor">    #endif // NTOS_KERNEL_RUNTIME</span>
03599 <span class="preprocessor"></span>
03600                     } <span class="keywordflow">else</span> {
03601 
03602                         <span class="comment">//</span>
03603                         <span class="comment">//  Otherwise the block is big enough to decommit so have a</span>
03604                         <span class="comment">//  worker routine to do the decommit</span>
03605                         <span class="comment">//</span>
03606 
03607                         <a class="code" href="../../d9/d9/heappriv_8h.html#a35">RtlpDeCommitFreeBlock</a>( Heap, (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)BusyBlock, FreeSize );
03608                     }
03609 
03610                     <span class="comment">//</span>
03611                     <span class="comment">//  And say the free worked fine</span>
03612                     <span class="comment">//</span>
03613 
03614                     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03615                 }
03616 
03617             } <span class="keywordflow">else</span> {
03618 
03619                 <span class="comment">//</span>
03620                 <span class="comment">//  Not a busy block, or it's not aligned or the segment is</span>
03621                 <span class="comment">//  to big, meaning it's corrupt</span>
03622                 <span class="comment">//</span>
03623 
03624                 <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( STATUS_INVALID_PARAMETER );
03625             }
03626 
03627         } except( EXCEPTION_EXECUTE_HANDLER ) {
03628 
03629             <a class="code" href="../../d9/d9/heappriv_8h.html#a9">SET_LAST_STATUS</a>( GetExceptionCode() );
03630 
03631             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03632         }
03633 
03634     } finally {
03635 
03636         <span class="comment">//</span>
03637         <span class="comment">//  Unlock the heap</span>
03638         <span class="comment">//</span>
03639 
03640         <span class="keywordflow">if</span> (LockAcquired) {
03641 
03642             <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o31">LockVariable</a> );
03643         }
03644     }
03645 
03646     <span class="comment">//</span>
03647     <span class="comment">//  And return to our caller</span>
03648     <span class="comment">//</span>
03649 
03650     <span class="keywordflow">return</span> Result;
03651 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="heappriv.h::RtlpAddHeapToProcessList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAddHeapToProcessList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Heap</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04457">4457</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d4/d6/struct__HEAP__LOCK.html#o2">_HEAP_LOCK::Lock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00078">RtlAcquireLockRoutine</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00061">RtlpProcessHeapsListBuffer</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00053">RtlpProcessHeapsListLock</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00079">RtlReleaseLockRoutine</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.
<p>
<pre class="fragment"><div>04463                    :
04464 
04465     This routine adds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified heap to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap list <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04466     current process
04467 
04468 Arguments:
04469 
04470     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being added
04471 
04472 Return Value:
04473 
04474     None.
04475 
04476 --*/
04477 
04478 {
04479     PPEB Peb = NtCurrentPeb();
04480     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> *NewList;
04481 
04482     <span class="comment">//</span>
04483     <span class="comment">//  Lock the processes heap list</span>
04484     <span class="comment">//</span>
04485 
04486     <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( &amp;<a class="code" href="../../d5/d9/heapdll_8c.html#a3">RtlpProcessHeapsListLock</a>.<a class="code" href="../../d4/d6/struct__HEAP__LOCK.html#o2">Lock</a> );
04487 
04488     <span class="keywordflow">try</span> {
04489 
04490         <span class="comment">//</span>
04491         <span class="comment">//  If the processes heap list is already full then we'll</span>
04492         <span class="comment">//  double the size of the heap list for the process</span>
04493         <span class="comment">//</span>
04494 
04495         <span class="keywordflow">if</span> (Peb-&gt;NumberOfHeaps == Peb-&gt;MaximumNumberOfHeaps) {
04496 
04497             <span class="comment">//</span>
04498             <span class="comment">//  Double the size</span>
04499             <span class="comment">//</span>
04500 
04501             Peb-&gt;MaximumNumberOfHeaps *= 2;
04502 
04503             <span class="comment">//</span>
04504             <span class="comment">//  Allocate space for the new list</span>
04505             <span class="comment">//</span>
04506 
04507             NewList = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(),
04508                                        0,
04509                                        Peb-&gt;MaximumNumberOfHeaps * <span class="keyword">sizeof</span>( *NewList ));
04510 
04511             <span class="keywordflow">if</span> (NewList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04512 
04513                 leave;
04514             }
04515 
04516             <span class="comment">//</span>
04517             <span class="comment">//  Copy over the old buffer to the new buffer</span>
04518             <span class="comment">//</span>
04519 
04520             RtlMoveMemory( NewList,
04521                            Peb-&gt;ProcessHeaps,
04522                            Peb-&gt;NumberOfHeaps * <span class="keyword">sizeof</span>( *NewList ));
04523 
04524             <span class="comment">//</span>
04525             <span class="comment">//  Check if we should free the previous heap list buffer</span>
04526             <span class="comment">//</span>
04527 
04528             <span class="keywordflow">if</span> (Peb-&gt;ProcessHeaps != <a class="code" href="../../d5/d9/heapdll_8c.html#a4">RtlpProcessHeapsListBuffer</a>) {
04529 
04530                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, Peb-&gt;ProcessHeaps );
04531             }
04532 
04533             <span class="comment">//</span>
04534             <span class="comment">//  Set the new list</span>
04535             <span class="comment">//</span>
04536 
04537             Peb-&gt;ProcessHeaps = NewList;
04538         }
04539 
04540         <span class="comment">//</span>
04541         <span class="comment">//  Add the input heap to the next free heap list slot, and note that</span>
04542         <span class="comment">//  the processes heap list index is really one beyond the actualy</span>
04543         <span class="comment">//  index used to get the processes heap</span>
04544         <span class="comment">//</span>
04545 
04546         Peb-&gt;ProcessHeaps[ Peb-&gt;NumberOfHeaps++ ] = Heap;
04547         Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o11">ProcessHeapsListIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Peb-&gt;NumberOfHeaps;
04548 
04549     } finally {
04550 
04551         <span class="comment">//</span>
04552         <span class="comment">//  Unlock the processes heap list</span>
04553         <span class="comment">//</span>
04554 
04555         <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( &amp;<a class="code" href="../../d5/d9/heapdll_8c.html#a3">RtlpProcessHeapsListLock</a>.<a class="code" href="../../d4/d6/struct__HEAP__LOCK.html#o2">Lock</a> );
04556     }
04557 
04558     <span class="comment">//</span>
04559     <span class="comment">//  And return to our caller</span>
04560     <span class="comment">//</span>
04561 
04562     <span class="keywordflow">return</span>;
04563 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="heappriv.h::RtlpAdjustHeapLookasideDepth" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpAdjustHeapLookasideDepth           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lookaside</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html#l00130">130</a> of file <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html">rtl/lookasid.c</a>.
<p>
References <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00039">MINIMUM_ALLOCATION_THRESHOLD</a>, <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00033">MINIMUM_LOOKASIDE_DEPTH</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>.
<p>
<pre class="fragment"><div>00136                    :
00137 
00138     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called periodically to adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum depth of
00139     a single heap lookaside list.
00140 
00141 Arguments:
00142 
00143     Lookaside - Supplies a pointer to a heap lookaside list structure.
00144 
00145 Return Value:
00146 
00147     None.
00148 
00149 --*/
00150 
00151 {
00152     ULONG Allocates;
00153     ULONG Misses;
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Compute the total number of allocations and misses for this scan</span>
00157     <span class="comment">// period.</span>
00158     <span class="comment">//</span>
00159 
00160     Allocates = Lookaside-&gt;TotalAllocates - Lookaside-&gt;LastTotalAllocates;
00161     Lookaside-&gt;LastTotalAllocates = Lookaside-&gt;TotalAllocates;
00162     Misses = Lookaside-&gt;AllocateMisses - Lookaside-&gt;LastAllocateMisses;
00163     Lookaside-&gt;LastAllocateMisses = Lookaside-&gt;AllocateMisses;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Compute target depth of lookaside list.</span>
00167     <span class="comment">//</span>
00168 
00169     {
00170         ULONG Ratio;
00171         ULONG Target;
00172 
00173         <span class="comment">//</span>
00174         <span class="comment">// If the allocate rate is less than the mimimum threshold, then lower</span>
00175         <span class="comment">// the maximum depth of the lookaside list. Otherwise, if the miss rate</span>
00176         <span class="comment">// is less than .5%, then lower the maximum depth. Otherwise, raise the</span>
00177         <span class="comment">// maximum depth based on the miss rate.</span>
00178         <span class="comment">//</span>
00179 
00180         <span class="keywordflow">if</span> (Misses &gt;= Allocates) {
00181             Misses = Allocates;
00182         }
00183 
00184         <span class="keywordflow">if</span> (Allocates == 0) {
00185             Allocates = 1;
00186         }
00187 
00188         Ratio = (Misses * 1000) / Allocates;
00189         Target = Lookaside-&gt;Depth;
00190         <span class="keywordflow">if</span> (Allocates &lt; <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a2">MINIMUM_ALLOCATION_THRESHOLD</a>) {
00191             <span class="keywordflow">if</span> (Target &gt; (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a> + 10)) {
00192                 Target -= 10;
00193 
00194             } <span class="keywordflow">else</span> {
00195                 Target = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00196             }
00197 
00198         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Ratio &lt; 5) {
00199             <span class="keywordflow">if</span> (Target &gt; (<a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a> + 1)) {
00200                 Target -= 1;
00201 
00202             } <span class="keywordflow">else</span> {
00203                 Target = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00204             }
00205 
00206         } <span class="keywordflow">else</span> {
00207             Target += ((Ratio * Lookaside-&gt;MaximumDepth) / (1000 * 2)) + 5;
00208             <span class="keywordflow">if</span> (Target &gt; Lookaside-&gt;MaximumDepth) {
00209                 Target = Lookaside-&gt;MaximumDepth;
00210             }
00211         }
00212 
00213         Lookaside-&gt;Depth = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Target;
00214     }
00215 
00216     <span class="keywordflow">return</span>;
00217 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="heappriv.h::RtlpAllocateFromHeapLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI PVOID RtlpAllocateFromHeapLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lookaside</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html#l00222">222</a> of file <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html">rtl/lookasid.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d9/ntrtlp_8h.html#a46">RtlpInterlockedPopEntrySList()</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.
<p>
<pre class="fragment"><div>00228                    :
00229 
00230     This function removes (pops) the first entry from the specified
00231     heap lookaside list.
00232 
00233 Arguments:
00234 
00235     Lookaside - Supplies a pointer to a paged lookaside list structure.
00236 
00237 Return Value:
00238 
00239     If an entry is removed from the specified lookaside list, then the
00240     address of the entry is returned as the function value. Otherwise,
00241     NULL is returned.
00242 
00243 --*/
00244 
00245 {
00246 
00247     PVOID Entry;
00248 
00249     Lookaside-&gt;TotalAllocates += 1;
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">//  We need to protect ourselves from a second thread that can cause us</span>
00253     <span class="comment">//  to fault on the pop. If we do fault then we'll just do a regular pop</span>
00254     <span class="comment">//  operation</span>
00255     <span class="comment">//</span>
00256 
00257 <span class="preprocessor">#if defined(_X86_)</span>
00258 <span class="preprocessor"></span>
00259     <span class="keywordflow">if</span> (USER_SHARED_DATA-&gt;ProcessorFeatures[PF_COMPARE_EXCHANGE_DOUBLE]) {
00260 
00261 <span class="preprocessor">#endif // defined(_X86_)</span>
00262 <span class="preprocessor"></span>
00263         <span class="keywordflow">try</span> {
00264 
00265             Entry = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a46">RtlpInterlockedPopEntrySList</a>(&amp;Lookaside-&gt;ListHead);
00266 
00267         } except (EXCEPTION_EXECUTE_HANDLER) {
00268 
00269             Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00270         }
00271 
00272         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273 
00274             <span class="keywordflow">return</span> Entry;
00275         }
00276 <span class="preprocessor">#if defined(_X86_)</span>
00277 <span class="preprocessor"></span>
00278     }
00279 
00280 <span class="preprocessor">#endif // defined(_X86_)</span>
00281 <span class="preprocessor"></span>
00282     Lookaside-&gt;AllocateMisses += 1;
00283     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00284 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="heappriv.h::RtlpCheckBusyBlockTail" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCheckBusyBlockTail           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BusyBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">6117</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00394">CHECK_HEAP_TAIL_SIZE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00043">CheckHeapFillPattern</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00239">HEAP_ENTRY_VIRTUAL_ALLOC</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">HeapDebugBreak</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06070">RtlpGetSizeOfBigBlock()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01696">RtlpValidateHeapEntry()</a>, and <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01790">RtlpValidateHeapSegment()</a>.
<p>
<pre class="fragment"><div>06123                    :
06124 
06125     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes beyond <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user specified
06126     allocation have been modified.  It does <span class="keyword">this</span> by checking <span class="keywordflow">for</span> a tail
06127     fill pattern
06128 
06129 Arguments:
06130 
06131     BusyBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap block being queried
06132 
06133 Return Value:
06134 
06135     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> still okay and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
06136 
06137 --*/
06138 
06139 {
06140     PCHAR Tail;
06141     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, cbEqual;
06142 
06143     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
06144 
06145     <span class="comment">//</span>
06146     <span class="comment">//  Compute the user allocated size of the input heap block</span>
06147     <span class="comment">//</span>
06148 
06149     <span class="keywordflow">if</span> (BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) {
06150 
06151         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d9/d9/heappriv_8h.html#a40">RtlpGetSizeOfBigBlock</a>( BusyBlock );
06152 
06153     } <span class="keywordflow">else</span> {
06154 
06155         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (BusyBlock-&gt;Size &lt;&lt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>) - BusyBlock-&gt;UnusedBytes;
06156     }
06157 
06158     <span class="comment">//</span>
06159     <span class="comment">//  Compute a pointer to the tail of the input block.  This would</span>
06160     <span class="comment">//  be the space right after the user allocated portion</span>
06161     <span class="comment">//</span>
06162 
06163     Tail = (PCHAR)(BusyBlock + 1) + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
06164 
06165     <span class="comment">//</span>
06166     <span class="comment">//  Check if the tail fill pattern is still there</span>
06167     <span class="comment">//</span>
06168 
06169     cbEqual = RtlCompareMemory( Tail,
06170                                 CheckHeapFillPattern,
06171                                 CHECK_HEAP_TAIL_SIZE );
06172 
06173     <span class="comment">//</span>
06174     <span class="comment">//  If the number we get back isn't equal to the tail size then</span>
06175     <span class="comment">//  someone modified the block beyond its user specified allocation</span>
06176     <span class="comment">//  size</span>
06177     <span class="comment">//</span>
06178 
06179     <span class="keywordflow">if</span> (cbEqual != <a class="code" href="../../d3/d9/heap_8h.html#a25">CHECK_HEAP_TAIL_SIZE</a>) {
06180 
06181         <span class="comment">//</span>
06182         <span class="comment">//  Do some debug printing</span>
06183         <span class="comment">//</span>
06184 
06185         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap block at %p modified at %p past requested size of %lx\n"</span>,
06186                          BusyBlock,
06187                          Tail + cbEqual,
06188                          Size ));
06189 
06190         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( BusyBlock );
06191 
06192         <span class="comment">//</span>
06193         <span class="comment">//  And tell our caller there was an error</span>
06194         <span class="comment">//</span>
06195 
06196         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
06197 
06198     } <span class="keywordflow">else</span> {
06199 
06200         <span class="comment">//</span>
06201         <span class="comment">//  And return to our caller that the tail is fine</span>
06202         <span class="comment">//</span>
06203 
06204         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06205     }
06206 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="heappriv.h::RtlpCheckHeapSignature" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpCheckHeapSignature           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Caller</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04250">4250</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00387">HEAP_SIGNATURE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">HeapDebugBreak</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00388">RtlDebugDestroyHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01498">RtlDebugQueryTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01654">RtlDebugWalkHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00390">RtlLockHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00454">RtlUnlockHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.
<p>
<pre class="fragment"><div>04257                    :
04258 
04259     This routine verifies that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being called with a properly identified
04260     heap.
04261 
04262 Arguments:
04263 
04264     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being checked
04265 
04266     Caller - Supplies a string that can be used to identify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
04267 
04268 Return Value:
04269 
04270     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap signature <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present, and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04271 
04272 --*/
04273 
04274 {
04275     <span class="comment">//</span>
04276     <span class="comment">//  If the heap signature matches then that is the only</span>
04277     <span class="comment">//  checking we do</span>
04278     <span class="comment">//</span>
04279 
04280     <span class="keywordflow">if</span> (Heap-&gt;Signature == <a class="code" href="../../d3/d9/heap_8h.html#a19">HEAP_SIGNATURE</a>) {
04281 
04282         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04283 
04284     } <span class="keywordflow">else</span> {
04285 
04286         <span class="comment">//</span>
04287         <span class="comment">//  We have a bad heap signature.  Print out some information, break</span>
04288         <span class="comment">//  into the debugger, and then return false</span>
04289         <span class="comment">//</span>
04290 
04291         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid heap signature for heap at %x"</span>, Heap ));
04292 
04293         <span class="keywordflow">if</span> (Caller != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04294 
04295             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">", passed to %s"</span>, Caller );
04296         }
04297 
04298         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"\n"</span> );
04299 
04300         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( &amp;Heap-&gt;Signature );
04301 
04302         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04303     }
04304 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="heappriv.h::RtlpCoalesceFreeBlocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> RtlpCoalesceFreeBlocks           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RemoveFromFreeList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05312">5312</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00200">_HEAP_FREE_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00231">HEAP_MAXIMUM_BLOCK_SIZE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00039">HEAPASSERT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00277">_HEAP_SEGMENT::LastEntryInSegment</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00182">_HEAP_FREE_ENTRY::PreviousSize</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00465">RtlpRemoveFreeBlock</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00189">_HEAP_FREE_ENTRY::SegmentIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00174">_HEAP_FREE_ENTRY::Size</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04312">RtlpCoalesceHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>.
<p>
<pre class="fragment"><div>05321                    :
05322 
05323     This routine coalesces <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free block together.
05324 
05325 Arguments:
05326 
05327     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being manipulated
05328 
05329     FreeBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free block that we want coalesced
05330 
05331     FreeSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free block.  On <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
05332         contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly coalesced free block
05333 
05334     RemoveFromFreeList - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input free block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already on a
05335         free list and needs to be removed to before coalescing
05336 
05337 Return Value:
05338 
05339     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> - returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly coalesced free block
05340 
05341 --*/
05342 
05343 {
05344     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock1, NextFreeBlock;
05345 
05346     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05347 
05348     <span class="comment">//</span>
05349     <span class="comment">//  Point to the preceding block</span>
05350     <span class="comment">//</span>
05351 
05352     FreeBlock1 = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock - FreeBlock-&gt;PreviousSize);
05353 
05354     <span class="comment">//</span>
05355     <span class="comment">//  Check if there is a preceding block, and if it is free, and the two sizes</span>
05356     <span class="comment">//  put together will still fit on a free lists.</span>
05357     <span class="comment">//</span>
05358 
05359     <span class="keywordflow">if</span> ((FreeBlock1 != FreeBlock) &amp;&amp;
05360         !(FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) &amp;&amp;
05361         ((*FreeSize + FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>) &lt;= <a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>)) {
05362 
05363         <span class="comment">//</span>
05364         <span class="comment">//  We are going to merge ourselves with the preceding block</span>
05365         <span class="comment">//</span>
05366 
05367         <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(FreeBlock-&gt;PreviousSize == FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>);
05368 
05369         <span class="comment">//</span>
05370         <span class="comment">//  Check if we need to remove the input block from the free list</span>
05371         <span class="comment">//</span>
05372 
05373         <span class="keywordflow">if</span> (RemoveFromFreeList) {
05374 
05375             <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, FreeBlock );
05376 
05377             Heap-&gt;TotalFreeSize -= FreeBlock-&gt;Size;
05378 
05379             <span class="comment">//</span>
05380             <span class="comment">//  We're removed so we don't have to do it again</span>
05381             <span class="comment">//</span>
05382 
05383             RemoveFromFreeList = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05384         }
05385 
05386         <span class="comment">//</span>
05387         <span class="comment">//  Remove the preceding block from its free list</span>
05388         <span class="comment">//</span>
05389 
05390         <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, FreeBlock1 );
05391 
05392         <span class="comment">//</span>
05393         <span class="comment">//  Copy over the last entry flag if necessary from what we're freeing</span>
05394         <span class="comment">//  to the preceding block</span>
05395         <span class="comment">//</span>
05396 
05397         FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> = FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
05398 
05399         <span class="keywordflow">if</span>( FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a> ) {
05400 
05401             <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
05402 
05403             Segment = Heap-&gt;Segments[FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o2">SegmentIndex</a>];
05404             Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock1;
05405         }
05406 
05407         <span class="comment">//</span>
05408         <span class="comment">//  Point to the preceding block, and adjust the sizes for the</span>
05409         <span class="comment">//  new free block.  It is the total of both blocks.</span>
05410         <span class="comment">//</span>
05411 
05412         FreeBlock = FreeBlock1;
05413 
05414         *FreeSize += FreeBlock1-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
05415 
05416         Heap-&gt;TotalFreeSize -= FreeBlock1-&gt;Size;
05417 
05418         FreeBlock-&gt;Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*FreeSize;
05419 
05420         <span class="comment">//</span>
05421         <span class="comment">//  Check if we need to update the previous size of the next</span>
05422         <span class="comment">//  entry</span>
05423         <span class="comment">//</span>
05424 
05425         <span class="keywordflow">if</span> (!(FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
05426 
05427             ((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock + *FreeSize)-&gt;PreviousSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*FreeSize;
05428         }
05429     }
05430 
05431     <span class="comment">//</span>
05432     <span class="comment">//  Check if there is a following block.</span>
05433     <span class="comment">//</span>
05434 
05435     <span class="keywordflow">if</span> (!(FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
05436 
05437         <span class="comment">//</span>
05438         <span class="comment">//  There is a following block so now get a pointer to it</span>
05439         <span class="comment">//  and check if it is free and if putting the two blocks together</span>
05440         <span class="comment">//  still fits on a free list</span>
05441         <span class="comment">//</span>
05442 
05443         NextFreeBlock = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock + *FreeSize);
05444 
05445         <span class="keywordflow">if</span> (!(NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) &amp;&amp;
05446             ((*FreeSize + NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>) &lt;= <a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>)) {
05447 
05448             <span class="comment">//</span>
05449             <span class="comment">//  We are going to merge ourselves with the following block</span>
05450             <span class="comment">//</span>
05451 
05452             <a class="code" href="../../d9/d9/heappriv_8h.html#a0">HEAPASSERT</a>(*FreeSize == NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a>);
05453 
05454             <span class="comment">//</span>
05455             <span class="comment">//  Check if we need to remove the input block from the free list</span>
05456             <span class="comment">//</span>
05457 
05458             <span class="keywordflow">if</span> (RemoveFromFreeList) {
05459 
05460                 <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, FreeBlock );
05461 
05462                 Heap-&gt;TotalFreeSize -= FreeBlock-&gt;Size;
05463 
05464                 <span class="comment">//</span>
05465                 <span class="comment">//  **** this assignment isn't necessary because there isn't</span>
05466                 <span class="comment">//  **** any more merging after this one</span>
05467                 <span class="comment">//</span>
05468 
05469                 RemoveFromFreeList = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05470             }
05471 
05472             <span class="comment">//</span>
05473             <span class="comment">//  Copy up the last entry flag if necessary from the following</span>
05474             <span class="comment">//  block to our input block</span>
05475             <span class="comment">//</span>
05476 
05477             FreeBlock-&gt;Flags = NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
05478 
05479             <span class="keywordflow">if</span>( FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a> ) {
05480 
05481                 <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
05482 
05483                 Segment = Heap-&gt;Segments[FreeBlock-&gt;SegmentIndex];
05484                 Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock;
05485             }
05486 
05487             <span class="comment">//</span>
05488             <span class="comment">//  Remove the following block from its free list</span>
05489             <span class="comment">//</span>
05490 
05491             <a class="code" href="../../d9/d9/heappriv_8h.html#a18">RtlpRemoveFreeBlock</a>( Heap, NextFreeBlock );
05492 
05493             <span class="comment">//</span>
05494             <span class="comment">//  Adjust the size for the newly combined block</span>
05495             <span class="comment">//</span>
05496 
05497             *FreeSize += NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
05498 
05499             Heap-&gt;TotalFreeSize -= NextFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
05500 
05501             FreeBlock-&gt;Size = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*FreeSize;
05502 
05503             <span class="comment">//</span>
05504             <span class="comment">//  Check if we need to update the previous size of the next block</span>
05505             <span class="comment">//</span>
05506 
05507             <span class="keywordflow">if</span> (!(FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
05508 
05509                 ((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock + *FreeSize)-&gt;PreviousSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*FreeSize;
05510             }
05511         }
05512     }
05513 
05514     <span class="comment">//</span>
05515     <span class="comment">//  And return the free block to our caller</span>
05516     <span class="comment">//</span>
05517 
05518     <span class="keywordflow">return</span> FreeBlock;
05519 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="heappriv.h::RtlpCoalesceHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> RtlpCoalesceHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Heap</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04312">4312</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00200">_HEAP_FREE_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00233">HEAP_MAXIMUM_FREELISTS</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00182">_HEAP_FREE_ENTRY::PreviousSize</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05312">RtlpCoalesceFreeBlocks()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00174">_HEAP_FREE_ENTRY::Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02401">RtlCompactHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>.
<p>
<pre class="fragment"><div>04318                    :
04319 
04320     This routine scans through heap and coalesces its free blocks
04321 
04322 Arguments:
04323 
04324     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being modified
04325 
04326 Return Value:
04327 
04328     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> - returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> largest free block
04329         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap
04330 
04331 --*/
04332 
04333 {
04334     SIZE_T OldFreeSize;
04335     SIZE_T FreeSize;
04336     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
04337     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock, LargestFreeBlock;
04338     PLIST_ENTRY FreeListHead, Next;
04339 
04340     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
04341 
04342     LargestFreeBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04343 
04344     <span class="comment">//</span>
04345     <span class="comment">//  For every free list in the heap, going from smallest to</span>
04346     <span class="comment">//  largest and skipping the zero index one we will</span>
04347     <span class="comment">//  scan the free list coalesceing the free blocks</span>
04348     <span class="comment">//</span>
04349 
04350     FreeListHead = &amp;Heap-&gt;FreeLists[ 1 ];
04351 
04352     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>;
04353 
04354     <span class="keywordflow">while</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>--) {
04355 
04356         <span class="comment">//</span>
04357         <span class="comment">//  Scan the individual free list</span>
04358         <span class="comment">//</span>
04359 
04360         Next = FreeListHead-&gt;Blink;
04361 
04362         <span class="keywordflow">while</span> (FreeListHead != Next) {
04363 
04364             <span class="comment">//</span>
04365             <span class="comment">//  Get a pointer to the current free list entry, and remember its</span>
04366             <span class="comment">//  next and size</span>
04367             <span class="comment">//</span>
04368 
04369             FreeBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>, FreeList );
04370 
04371             Next = Next-&gt;Flink;
04372             OldFreeSize = FreeSize = FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>;
04373 
04374             <span class="comment">//</span>
04375             <span class="comment">//  Coalesce the block</span>
04376             <span class="comment">//</span>
04377 
04378             FreeBlock = <a class="code" href="../../d9/d9/heappriv_8h.html#a34">RtlpCoalesceFreeBlocks</a>( Heap,
04379                                                 FreeBlock,
04380                                                 &amp;FreeSize,
04381                                                 TRUE );
04382 
04383             <span class="comment">//</span>
04384             <span class="comment">//  If the new free size is not equal to the old free size</span>
04385             <span class="comment">//  then we actually did some changes otherwise the coalesce</span>
04386             <span class="comment">//  calll was essentialy a noop</span>
04387             <span class="comment">//</span>
04388 
04389             <span class="keywordflow">if</span> (FreeSize != OldFreeSize) {
04390 
04391                 <span class="comment">//</span>
04392                 <span class="comment">//  Check if we should decommit this block because it is too</span>
04393                 <span class="comment">//  large and it is either at the beginning or end of a</span>
04394                 <span class="comment">//  committed run.  Otherwise just insert the new sized</span>
04395                 <span class="comment">//  block into its corresponding free list.  We'll hit this</span>
04396                 <span class="comment">//  block again when we visit larger free lists.</span>
04397                 <span class="comment">//</span>
04398 
04399                 <span class="keywordflow">if</span> (FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> &gt;= (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>)
04400 
04401                         &amp;&amp;
04402 
04403                     (FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a> == 0 ||
04404                      (FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>))) {
04405 
04406                     <a class="code" href="../../d9/d9/heappriv_8h.html#a35">RtlpDeCommitFreeBlock</a>( Heap, FreeBlock, FreeSize );
04407 
04408                 } <span class="keywordflow">else</span> {
04409 
04410                     <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, FreeBlock, FreeSize );
04411                 }
04412 
04413                 Next = FreeListHead-&gt;Blink;
04414 
04415             } <span class="keywordflow">else</span> {
04416 
04417                 <span class="comment">//</span>
04418                 <span class="comment">//  Remember the largest free block we've found so far</span>
04419                 <span class="comment">//</span>
04420 
04421                 <span class="keywordflow">if</span> ((LargestFreeBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
04422                     (LargestFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> &lt; FreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a>)) {
04423 
04424                     LargestFreeBlock = FreeBlock;
04425                 }
04426             }
04427         }
04428 
04429         <span class="comment">//</span>
04430         <span class="comment">//  Go to the next free list.  When we hit the largest dedicated</span>
04431         <span class="comment">//  size free list we'll fall back to the [0] index list</span>
04432         <span class="comment">//</span>
04433 
04434         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> == 1) {
04435 
04436             FreeListHead = &amp;Heap-&gt;FreeLists[ 0 ];
04437 
04438         } <span class="keywordflow">else</span> {
04439 
04440             FreeListHead++;
04441         }
04442     }
04443 
04444     <span class="comment">//</span>
04445     <span class="comment">//  And return to our caller</span>
04446     <span class="comment">//</span>
04447 
04448     <span class="keywordflow">return</span> LargestFreeBlock;
04449 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="heappriv.h::RtlpDeCommitFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDeCommitFreeBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">5527</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00260">_HEAP_SEGMENT::Entry</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00269">_HEAP_SEGMENT::FirstEntry</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00200">_HEAP_FREE_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00277">_HEAP_SEGMENT::LastEntryInSegment</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00272">_HEAP_SEGMENT::NumberOfUnCommittedPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00053">_HEAP_ENTRY::PreviousSize</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00182">_HEAP_FREE_ENTRY::PreviousSize</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00031">ROUND_DOWN_TO_POWER2</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00030">ROUND_UP_TO_POWER2</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03962">RtlpCreateUnCommittedRange()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04169">RtlpDestroyUnCommittedRange()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00322">RtlpInsertFreeBlockDirect</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04227">RtlpInsertUnCommittedPages()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00060">_HEAP_ENTRY::SegmentIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00174">_HEAP_FREE_ENTRY::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04312">RtlpCoalesceHeap()</a>.
<p>
<pre class="fragment"><div>05535                    :
05536 
05537     This routine takes a free block and decommits <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usually called
05538     because <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> beyond <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> decommit threshold
05539 
05540 Arguments:
05541 
05542     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being manipulated
05543 
05544     FreeBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block being decommitted
05545 
05546     FreeSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free block being decommitted
05547 
05548 Return Value:
05549 
05550     None.
05551 
05552 --*/
05553 
05554 {
05555     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05556     ULONG_PTR DeCommitAddress;
05557     SIZE_T DeCommitSize;
05558     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> LeadingFreeSize, TrailingFreeSize;
05559     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
05560     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> LeadingFreeBlock, TrailingFreeBlock;
05561     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> LeadingBusyBlock, TrailingBusyBlock;
05562     <a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html">PHEAP_UNCOMMMTTED_RANGE</a> UnCommittedRange;
05563 
05564     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05565 
05566     <span class="comment">//</span>
05567     <span class="comment">//  If the heap has a user specified decommit routine then we won't really</span>
05568     <span class="comment">//  decommit anything instead we'll call a worker routine to chop it up</span>
05569     <span class="comment">//  into pieces that will fit on the free lists</span>
05570     <span class="comment">//</span>
05571 
05572     <span class="keywordflow">if</span> (Heap-&gt;CommitRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05573 
05574         <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, FreeBlock, FreeSize );
05575 
05576         <span class="keywordflow">return</span>;
05577     }
05578 
05579     <span class="comment">//</span>
05580     <span class="comment">//  Get a pointer to the owning segment</span>
05581     <span class="comment">//</span>
05582 
05583     Segment = Heap-&gt;Segments[ FreeBlock-&gt;SegmentIndex ];
05584 
05585     <span class="comment">//</span>
05586     <span class="comment">//  The leading busy block identifies the preceding in use block before</span>
05587     <span class="comment">//  what we are trying to decommit.  It is only used if what we are trying</span>
05588     <span class="comment">//  decommit is right on a page boundary and then it is the block right</span>
05589     <span class="comment">//  before us if it exists.</span>
05590     <span class="comment">//</span>
05591     <span class="comment">//  The leading free block is used to identify whatever space is needed</span>
05592     <span class="comment">//  to round up the callers specified address to a page address.  If the</span>
05593     <span class="comment">//  caller already gave us a page aligned address then the free block</span>
05594     <span class="comment">//  address is identical to what the caller supplied.</span>
05595     <span class="comment">//</span>
05596 
05597     LeadingBusyBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05598     LeadingFreeBlock = FreeBlock;
05599 
05600     <span class="comment">//</span>
05601     <span class="comment">//  Make sure the block we are trying to decommit start on the next full</span>
05602     <span class="comment">//  page boundary.  The leading free size is the size of whatever it takes</span>
05603     <span class="comment">//  to round up the free block to the next page specified in units of</span>
05604     <span class="comment">//  heap entries.</span>
05605     <span class="comment">//</span>
05606 
05607     DeCommitAddress = <a class="code" href="../../d3/d9/heap_8h.html#a1">ROUND_UP_TO_POWER2</a>( LeadingFreeBlock, PAGE_SIZE );
05608     LeadingFreeSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)DeCommitAddress - (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)LeadingFreeBlock);
05609 
05610     <span class="comment">//</span>
05611     <span class="comment">//  If we leading free size only has space for one heap entry then we'll</span>
05612     <span class="comment">//  bump it up to include the next page, because we don't want to leave</span>
05613     <span class="comment">//  anything that small laying around.  Otherwise if we have a preceding</span>
05614     <span class="comment">//  block and the leading free size is zero then identify the preceding</span>
05615     <span class="comment">//  block as the leading busy block</span>
05616     <span class="comment">//</span>
05617 
05618     <span class="keywordflow">if</span> (LeadingFreeSize == 1) {
05619 
05620         DeCommitAddress += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
05621         LeadingFreeSize += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
05622 
05623     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LeadingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a> != 0) {
05624 
05625         <span class="keywordflow">if</span> (DeCommitAddress == (ULONG_PTR)LeadingFreeBlock) {
05626 
05627             LeadingBusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)LeadingFreeBlock - LeadingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a>;
05628         }
05629     }
05630 
05631     <span class="comment">//</span>
05632     <span class="comment">//  The trailing busy block identifies the block immediately after the one</span>
05633     <span class="comment">//  we are trying to decommit provided what we are decommitting ends right</span>
05634     <span class="comment">//  on a page boundary otherwise the trailing busy block stays null and</span>
05635     <span class="comment">//  the trailing free block value is used.</span>
05636     <span class="comment">//</span>
05637     <span class="comment">//  **** gdk ****</span>
05638     <span class="comment">//  **** the assignment of tailing free block doesn't seem right because</span>
05639     <span class="comment">//  **** Free size should be in bytes, and not heap entries</span>
05640     <span class="comment">//</span>
05641 
05642     TrailingBusyBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05643     TrailingFreeBlock = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock + FreeSize);
05644 
05645     <span class="comment">//</span>
05646     <span class="comment">//  Make sure the block we are trying to decommit ends on a page boundary.</span>
05647     <span class="comment">//</span>
05648     <span class="comment">//  And compute how many heap entries we had to backup to make it land on a</span>
05649     <span class="comment">//  page boundary.</span>
05650     <span class="comment">//</span>
05651 
05652     DeCommitSize = <a class="code" href="../../d3/d9/heap_8h.html#a2">ROUND_DOWN_TO_POWER2</a>( (ULONG_PTR)TrailingFreeBlock, PAGE_SIZE );
05653     TrailingFreeSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)TrailingFreeBlock - (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)DeCommitSize);
05654 
05655     <span class="comment">//</span>
05656     <span class="comment">//  If the trailing free size is exactly one heap in size then we will</span>
05657     <span class="comment">//  nibble off a bit more from the decommit size because free block of</span>
05658     <span class="comment">//  exactly one heap entry in size are useless.  Otherwise if we actually</span>
05659     <span class="comment">//  ended on a page boundary and there is a block after us then indicate</span>
05660     <span class="comment">//  that we have a trailing busy block</span>
05661     <span class="comment">//</span>
05662 
05663     <span class="keywordflow">if</span> (TrailingFreeSize == (<span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">HEAP_ENTRY</a> ) &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>)) {
05664 
05665         DeCommitSize -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
05666         TrailingFreeSize += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
05667 
05668     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TrailingFreeSize == 0) &amp;&amp; !(FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
05669 
05670         TrailingBusyBlock = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)TrailingFreeBlock;
05671     }
05672 
05673     <span class="comment">//</span>
05674     <span class="comment">//  Now adjust the trailing free block to compensate for the trailing free size</span>
05675     <span class="comment">//  we just computed.</span>
05676     <span class="comment">//</span>
05677 
05678     TrailingFreeBlock = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)TrailingFreeBlock - TrailingFreeSize);
05679 
05680     <span class="comment">//</span>
05681     <span class="comment">//  Right now DeCommit size is really a pointer.  If it points at is beyond</span>
05682     <span class="comment">//  the decommit address then make the size really be just the byte count</span>
05683     <span class="comment">//  to decommit.  Otherwise the decommit size is zero.</span>
05684     <span class="comment">//</span>
05685 
05686     <span class="keywordflow">if</span> (DeCommitSize &gt; DeCommitAddress) {
05687 
05688         DeCommitSize -= DeCommitAddress;
05689 
05690     } <span class="keywordflow">else</span> {
05691 
05692         DeCommitSize = 0;
05693     }
05694 
05695     <span class="comment">//</span>
05696     <span class="comment">//  **** this next test is bogus given the if-then-else that just preceded it</span>
05697     <span class="comment">//</span>
05698     <span class="comment">//  Now check if we still have something to decommit</span>
05699     <span class="comment">//</span>
05700 
05701     <span class="keywordflow">if</span> (DeCommitSize != 0) {
05702 
05703         <span class="comment">//</span>
05704         <span class="comment">//  Before freeing the memory to MM we have to be sure we can create </span>
05705         <span class="comment">//  a PHEAP_UNCOMMMTTED_RANGE later. So we do it right now</span>
05706         <span class="comment">//</span>
05707 
05708         UnCommittedRange = <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a10">RtlpCreateUnCommittedRange</a>(Segment);
05709 
05710         <span class="keywordflow">if</span> (UnCommittedRange == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05711             
05712             <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Failing creating uncommitted range (%x for %x)\n"</span>, DeCommitAddress, DeCommitSize ));
05713 
05714             <span class="comment">//</span>
05715             <span class="comment">//  We weren't successful in the decommit so now simply</span>
05716             <span class="comment">//  add the leading free block to the free list</span>
05717             <span class="comment">//</span>
05718 
05719             <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, LeadingFreeBlock, FreeSize );
05720 
05721             <span class="keywordflow">return</span>;
05722         }
05723 
05724         <span class="comment">//</span>
05725         <span class="comment">//  Decommit the memory</span>
05726         <span class="comment">//</span>
05727 
05728         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
05729                                       (PVOID *)&amp;DeCommitAddress,
05730                                       &amp;DeCommitSize,
05731                                       MEM_DECOMMIT );
05732 
05733         <span class="comment">//</span>
05734         <span class="comment">//  Push back the UnCommittedRange structure. Now the insert cannot fail</span>
05735         <span class="comment">//</span>
05736 
05737         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a11">RtlpDestroyUnCommittedRange</a>( Segment, UnCommittedRange );
05738 
05739         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
05740 
05741             <span class="comment">//</span>
05742             <span class="comment">//  Insert information regarding the pages we just decommitted</span>
05743             <span class="comment">//  to the lsit of uncommited pages in the segment</span>
05744             <span class="comment">//</span>
05745 
05746             <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a12">RtlpInsertUnCommittedPages</a>( Segment,
05747                                         DeCommitAddress,
05748                                         DeCommitSize );
05749             <span class="comment">//</span>
05750             <span class="comment">//  Adjust the segments count of uncommitted pages</span>
05751             <span class="comment">//</span>
05752 
05753             Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o9">NumberOfUnCommittedPages</a> += (ULONG)(DeCommitSize / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
05754 
05755             <span class="comment">//</span>
05756             <span class="comment">//  If we have a leading free block then mark its proper state</span>
05757             <span class="comment">//  update the heap, and put it on the free list</span>
05758             <span class="comment">//</span>
05759 
05760             <span class="keywordflow">if</span> (LeadingFreeSize != 0) {
05761 
05762                 LeadingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> = <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
05763                 LeadingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> = LeadingFreeSize;
05764                 Heap-&gt;TotalFreeSize += LeadingFreeSize;
05765 
05766                 Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)LeadingFreeBlock;
05767 
05768                 <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, LeadingFreeBlock, LeadingFreeSize );
05769 
05770             <span class="comment">//</span>
05771             <span class="comment">//  Otherwise if we actually have a leading busy block then</span>
05772             <span class="comment">//  make sure the busy block knows we're uncommitted</span>
05773             <span class="comment">//</span>
05774 
05775             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LeadingBusyBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05776 
05777                 LeadingBusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> |= <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
05778 
05779                 Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = LeadingBusyBlock;
05780 
05781             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> &gt;= (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)DeCommitAddress)
05782                             &amp;&amp;
05783                        ((PCHAR)Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> &lt; ((PCHAR)DeCommitAddress + DeCommitSize))) {
05784 
05785                      Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o14">LastEntryInSegment</a> = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>;
05786             }
05787 
05788             <span class="comment">//</span>
05789             <span class="comment">//  If there is a trailing free block then sets its state,</span>
05790             <span class="comment">//  update the heap, and insert it on a free list</span>
05791             <span class="comment">//</span>
05792 
05793             <span class="keywordflow">if</span> (TrailingFreeSize != 0) {
05794 
05795                 TrailingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o1">PreviousSize</a> = 0;
05796                 TrailingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o2">SegmentIndex</a> = Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o0">Entry</a>.<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a>;
05797                 TrailingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o3">Flags</a> = 0;
05798                 TrailingFreeBlock-&gt;<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html#o0">Size</a> = TrailingFreeSize;
05799 
05800                 ((<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)TrailingFreeBlock + TrailingFreeSize))-&gt;PreviousSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)TrailingFreeSize;
05801 
05802                 <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, TrailingFreeBlock, TrailingFreeSize );
05803 
05804                 Heap-&gt;TotalFreeSize += TrailingFreeSize;
05805 
05806             <span class="comment">//</span>
05807             <span class="comment">//  Otherwise if we actually have a succeeding block then</span>
05808             <span class="comment">//  make it know we are uncommitted</span>
05809             <span class="comment">//</span>
05810 
05811             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TrailingBusyBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05812 
05813                 TrailingBusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o1">PreviousSize</a> = 0;
05814             }
05815 
05816         } <span class="keywordflow">else</span> {
05817 
05818             <span class="comment">//</span>
05819             <span class="comment">//  We weren't successful in the decommit so now simply</span>
05820             <span class="comment">//  add the leading free block to the free list</span>
05821             <span class="comment">//</span>
05822 
05823             <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, LeadingFreeBlock, FreeSize );
05824         }
05825 
05826     } <span class="keywordflow">else</span> {
05827 
05828         <span class="comment">//</span>
05829         <span class="comment">//  There is nothing left to decommit to take our leading free block</span>
05830         <span class="comment">//  and put it on a free list</span>
05831         <span class="comment">//</span>
05832 
05833         <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap, LeadingFreeBlock, FreeSize );
05834     }
05835 
05836     <span class="comment">//</span>
05837     <span class="comment">//  And return to our caller</span>
05838     <span class="comment">//</span>
05839 
05840     <span class="keywordflow">return</span>;
05841 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="heappriv.h::RtlpDeleteHeapLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID RtlpDeleteHeapLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Lookaside</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html#l00101">101</a> of file <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html">rtl/lookasid.c</a>.
<p>
<pre class="fragment"><div>00107                    :
00108 
00109     This function frees any entries specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookaside structure.
00110 
00111 Arguments:
00112 
00113     Lookaside - Supplies a pointer to a heap lookaside list structure.
00114 
00115 Return Value:
00116 
00117     None.
00118 
00119 --*/
00120 
00121 {
00122 
00123     PVOID Entry;
00124 
00125     <span class="keywordflow">return</span>;
00126 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="heappriv.h::RtlpDestroyTags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpDestroyTags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Heap</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05893">5893</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00339">_HEAP::TagEntries</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>.
<p>
<pre class="fragment"><div>05899                    :
05900 
05901     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to completely remove all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal tag entries
05902     in use by a heap
05903 
05904 Arguments:
05905 
05906     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being modified
05907 
05908 Return Value:
05909 
05910     None.
05911 
05912 --*/
05913 
05914 {
05915     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05916     SIZE_T RegionSize;
05917 
05918     <span class="comment">//</span>
05919     <span class="comment">//  We will only do the action if the heap has some tag entries</span>
05920     <span class="comment">//</span>
05921 
05922     <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05923 
05924         <span class="comment">//</span>
05925         <span class="comment">//  Release all the memory used by the tag entries</span>
05926         <span class="comment">//</span>
05927 
05928         RegionSize = 0;
05929 
05930         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
05931                                       &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>,
05932                                       &amp;RegionSize,
05933                                       MEM_RELEASE );
05934 
05935         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
05936 
05937             Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05938         }
05939     }
05940 
05941     <span class="comment">//</span>
05942     <span class="comment">//  And return to our caller</span>
05943     <span class="comment">//</span>
05944 
05945     <span class="keywordflow">return</span>;
05946 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="heappriv.h::RtlpFindAndCommitPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> RtlpFindAndCommitPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Segment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PSIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID AddressWanted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04422">4422</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00254">_HEAP_UNCOMMMTTED_RANGE::Address</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">HeapDebugBreak</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00253">_HEAP_UNCOMMMTTED_RANGE::Next</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00053">_HEAP_ENTRY::PreviousSize</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04169">RtlpDestroyUnCommittedRange()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00060">_HEAP_ENTRY::SegmentIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00045">_HEAP_ENTRY::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00255">_HEAP_UNCOMMMTTED_RANGE::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>.
<p>
<pre class="fragment"><div>04431                    :
04432 
04433     This function searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied segment <span class="keywordflow">for</span> an uncommitted range that
04434     satisfies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified size.  It commits <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range and returns a heap entry
04435     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
04436 
04437 Arguments:
04438 
04439     Heap - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being maniuplated
04440 
04441     Segment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment being searched
04442 
04443     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of what we need to look <span class="keywordflow">for</span>, on <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> contains
04444         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of what we're just found and committed.
04445 
04446     AddressWanted - Optionally gives an address where we would like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages
04447         based.  If supplied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry must start at <span class="keyword">this</span> address
04448 
04449 Return Value:
04450 
04451     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly committed range that
04452         satisfies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given size requirement, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> we could not find
04453         something large enough and/or based at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address wanted.
04454 
04455 --*/
04456 
04457 {
04458     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04459     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> FirstEntry, LastEntry, PreviousLastEntry;
04460     <a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html">PHEAP_UNCOMMMTTED_RANGE</a> PreviousUnCommittedRange, UnCommittedRange, *pp;
04461     ULONG_PTR Address;
04462     SIZE_T Length;
04463 
04464     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
04465 
04466     <span class="comment">//</span>
04467     <span class="comment">//  What the outer loop does is cycle through the uncommited ranges</span>
04468     <span class="comment">//  stored in in the specified segment</span>
04469     <span class="comment">//</span>
04470 
04471     PreviousUnCommittedRange = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04472     pp = &amp;Segment-&gt;UnCommittedRanges;
04473 
04474     <span class="keywordflow">while</span> (UnCommittedRange = *pp) {
04475 
04476         <span class="comment">//</span>
04477         <span class="comment">//  Check for the best of worlds, where the size of this current</span>
04478         <span class="comment">//  uncommitted range satisfies our size request and either the user</span>
04479         <span class="comment">//  didn't specify an address or the address match</span>
04480         <span class="comment">//</span>
04481 
04482         <span class="keywordflow">if</span> ((UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> &gt;= *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) &amp;&amp;
04483             (!ARGUMENT_PRESENT( AddressWanted ) || (UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> == (ULONG_PTR)AddressWanted ))) {
04484 
04485             <span class="comment">//</span>
04486             <span class="comment">//  Calculate an address</span>
04487             <span class="comment">//</span>
04488 
04489             Address = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a>;
04490 
04491             <span class="comment">//</span>
04492             <span class="comment">//  Commit the memory.  If the heap doesn't have a commit</span>
04493             <span class="comment">//  routine then use the default mm supplied routine.</span>
04494             <span class="comment">//</span>
04495 
04496             <span class="keywordflow">if</span> (Heap-&gt;CommitRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04497 
04498                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (Heap-&gt;CommitRoutine)( Heap,
04499                                                 (PVOID *)&amp;Address,
04500                                                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> );
04501 
04502             } <span class="keywordflow">else</span> {
04503 
04504                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
04505                                                   (PVOID *)&amp;Address,
04506                                                   0,
04507                                                   Size,
04508                                                   MEM_COMMIT,
04509                                                   PAGE_READWRITE );
04510 
04511             }
04512 
04513             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
04514 
04515                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04516             }
04517 
04518             <span class="comment">//</span>
04519             <span class="comment">//  At this point we have some committed memory, with Address and Size</span>
04520             <span class="comment">//  giving us the necessary details</span>
04521             <span class="comment">//</span>
04522             <span class="comment">//  Update the number of uncommitted pages in the segment and if necessary</span>
04523             <span class="comment">//  mark down the largest uncommitted range</span>
04524             <span class="comment">//</span>
04525 
04526             Segment-&gt;NumberOfUnCommittedPages -= (ULONG) (*<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04527 
04528             <span class="keywordflow">if</span> (Segment-&gt;LargestUnCommittedRange == UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>) {
04529 
04530                 Segment-&gt;LargestUnCommittedRange = 0;
04531             }
04532 
04533             <span class="comment">//</span>
04534             <span class="comment">//  First entry is the start of the newly committed range</span>
04535             <span class="comment">//</span>
04536 
04537             FirstEntry = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)Address;
04538 
04539             <span class="comment">//</span>
04540             <span class="comment">//  We want last entry to point to the last real entry before</span>
04541             <span class="comment">//  this newly committed spot.  To do this we start by</span>
04542             <span class="comment">//  setting last entry to either the first entry for the</span>
04543             <span class="comment">//  segment or (if we can do better), to right after the last</span>
04544             <span class="comment">//  uncommitted range we examined.  Either way it points to</span>
04545             <span class="comment">//  some committed range</span>
04546             <span class="comment">//</span>
04547 
04548             <span class="keywordflow">if</span> ((Segment-&gt;LastEntryInSegment-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>) &amp;&amp;
04549                 (ULONG_PTR)(Segment-&gt;LastEntryInSegment + Segment-&gt;LastEntryInSegment-&gt;Size) == UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a>) {
04550 
04551                 LastEntry = Segment-&gt;LastEntryInSegment;
04552 
04553             } <span class="keywordflow">else</span> {
04554 
04555                 <span class="keywordflow">if</span> (PreviousUnCommittedRange == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04556 
04557                     LastEntry = Segment-&gt;FirstEntry;
04558 
04559                 } <span class="keywordflow">else</span> {
04560 
04561                     LastEntry = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)(PreviousUnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> +
04562                                               PreviousUnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>);
04563                 }
04564 
04565                 <span class="comment">//</span>
04566                 <span class="comment">//  Now we zoom through the entries until we find the one</span>
04567                 <span class="comment">//  marked last</span>
04568                 <span class="comment">//</span>
04569 
04570                 <span class="keywordflow">while</span> (!(LastEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
04571 
04572                     PreviousLastEntry = LastEntry;
04573                     LastEntry += LastEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
04574 
04575                     <span class="keywordflow">if</span> (((PCHAR)LastEntry &gt;= (PCHAR)Segment-&gt;LastValidEntry) || (LastEntry-&gt;Size == 0)) {
04576 
04577                         <span class="comment">//</span>
04578                         <span class="comment">//  Check for the situation where the last entry in the</span>
04579                         <span class="comment">//  segment isn't marked as a last entry but does put</span>
04580                         <span class="comment">//  us right where the have a new committed range</span>
04581                         <span class="comment">//</span>
04582 
04583                         <span class="keywordflow">if</span> (LastEntry == (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)Address) {
04584 
04585                             LastEntry = PreviousLastEntry;
04586 
04587                             <span class="keywordflow">break</span>;
04588                         }
04589 
04590                         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap missing last entry in committed range near %x\n"</span>, PreviousLastEntry ));
04591                         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( PreviousLastEntry );
04592 
04593                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04594                     }
04595                 }
04596             }
04597 
04598             <span class="comment">//</span>
04599             <span class="comment">//  Turn off the last bit on this entry because what's following</span>
04600             <span class="comment">//  is no longer uncommitted</span>
04601             <span class="comment">//</span>
04602 
04603             LastEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp;= ~<a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
04604 
04605             <span class="comment">//</span>
04606             <span class="comment">//  Shrink the uncommited range by the size we've committed</span>
04607             <span class="comment">//</span>
04608 
04609             UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> += *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04610             UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> -= *<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04611 
04612             <span class="comment">//</span>
04613             <span class="comment">//  Now if the size is zero then we've committed everything that there</span>
04614             <span class="comment">//  was in the range.  Otherwise make sure the first entry of what</span>
04615             <span class="comment">//  we've just committed knows that an uncommitted range follows.</span>
04616             <span class="comment">//</span>
04617 
04618             <span class="keywordflow">if</span> (UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> == 0) {
04619 
04620                 <span class="comment">//</span>
04621                 <span class="comment">//  This uncommitted range is about to vanish.  Base on if the</span>
04622                 <span class="comment">//  range is the last one in the segemnt then we know how to</span>
04623                 <span class="comment">//  mark the committed range as being last or not.</span>
04624                 <span class="comment">//</span>
04625 
04626                 <span class="keywordflow">if</span> (UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o1">Address</a> == (ULONG_PTR)Segment-&gt;LastValidEntry) {
04627 
04628                     FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
04629 
04630                     Segment-&gt;LastEntryInSegment = FirstEntry;
04631 
04632                 } <span class="keywordflow">else</span> {
04633 
04634                     FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = 0;
04635 
04636                     Segment-&gt;LastEntryInSegment = Segment-&gt;FirstEntry;
04637                 }
04638 
04639                 <span class="comment">//</span>
04640                 <span class="comment">//  Remove this zero sized range from the uncommitted range</span>
04641                 <span class="comment">//  list, and update the segment counters</span>
04642                 <span class="comment">//</span>
04643 
04644                 *pp = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o0">Next</a>;
04645 
04646                 <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a11">RtlpDestroyUnCommittedRange</a>( Segment, UnCommittedRange );
04647 
04648                 Segment-&gt;NumberOfUnCommittedRanges -= 1;
04649 
04650             } <span class="keywordflow">else</span> {
04651 
04652                 <span class="comment">//</span>
04653                 <span class="comment">//  Otherwise the range is not empty so we know what we committed</span>
04654                 <span class="comment">//  is immediately followed by an uncommitted range</span>
04655                 <span class="comment">//</span>
04656 
04657                 FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
04658 
04659                 Segment-&gt;LastEntryInSegment = FirstEntry;
04660             }
04661 
04662             <span class="comment">//</span>
04663             <span class="comment">//  Update the fields in the first entry, and optional</span>
04664             <span class="comment">//  following entry.</span>
04665             <span class="comment">//</span>
04666 
04667             FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a> = LastEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a>;
04668             FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(*<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>);
04669             FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o1">PreviousSize</a> = LastEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
04670 
04671             <span class="keywordflow">if</span> (!(FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
04672 
04673                 (FirstEntry + FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>)-&gt;PreviousSize = FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
04674             }
04675 
04676             <span class="comment">//</span>
04677             <span class="comment">//  Now if we adjusted the largest uncommitted range to zero then</span>
04678             <span class="comment">//  we need to go back and find the largest uncommitted range</span>
04679             <span class="comment">//  To do that we simply zoom down the uncommitted range list</span>
04680             <span class="comment">//  remembering the largest one</span>
04681             <span class="comment">//</span>
04682 
04683             <span class="keywordflow">if</span> (Segment-&gt;LargestUnCommittedRange == 0) {
04684 
04685                 UnCommittedRange = Segment-&gt;UnCommittedRanges;
04686 
04687                 <span class="keywordflow">while</span> (UnCommittedRange != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04688 
04689                     <span class="keywordflow">if</span> (UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a> &gt;= Segment-&gt;LargestUnCommittedRange) {
04690 
04691                         Segment-&gt;LargestUnCommittedRange = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o2">Size</a>;
04692                     }
04693 
04694                     UnCommittedRange = UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o0">Next</a>;
04695                 }
04696             }
04697 
04698             <span class="comment">//</span>
04699             <span class="comment">//  And return the heap entry to our caller</span>
04700             <span class="comment">//</span>
04701 
04702             <span class="keywordflow">return</span> (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)FirstEntry;
04703 
04704         } <span class="keywordflow">else</span> {
04705 
04706             <span class="comment">//</span>
04707             <span class="comment">//  Otherwise the current uncommited range is too small or</span>
04708             <span class="comment">//  doesn't have the right address so go to the next uncommitted</span>
04709             <span class="comment">//  range entry</span>
04710             <span class="comment">//</span>
04711 
04712             PreviousUnCommittedRange = UnCommittedRange;
04713             pp = &amp;UnCommittedRange-&gt;<a class="code" href="../../d5/d7/struct__HEAP__UNCOMMMTTED__RANGE.html#o0">Next</a>;
04714         }
04715     }
04716 
04717     <span class="comment">//</span>
04718     <span class="comment">//  At this point we did not find an uncommitted range entry that satisfied</span>
04719     <span class="comment">//  our requirements either because of size and/or address.  So return null</span>
04720     <span class="comment">//  to tell the user we didn't find anything.</span>
04721     <span class="comment">//</span>
04722 
04723     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04724 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="heappriv.h::RtlpFreeToHeapLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI BOOLEAN RtlpFreeToHeapLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lookaside</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html#l00288">288</a> of file <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html">rtl/lookasid.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ntrtlp_8h.html#a47">RtlpInterlockedPushEntrySList()</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00431">RtlpQueryDepthSList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>.
<p>
<pre class="fragment"><div>00295                    :
00296 
00297     This function inserts (pushes) the specified entry into the specified
00298     paged lookaside list.
00299 
00300 Arguments:
00301 
00302     Lookaside - Supplies a pointer to a paged lookaside list structure.
00303 
00304     Entry - Supples a pointer to the entry that is inserted in the
00305         lookaside list.
00306 
00307 Return Value:
00308 
00309     BOOLEAN - TRUE if the entry was put on the lookaside list and FALSE
00310         otherwise.
00311 
00312 --*/
00313 
00314 {
00315     Lookaside-&gt;TotalFrees += 1;
00316 
00317 <span class="preprocessor">#if defined(_X86_)</span>
00318 <span class="preprocessor"></span>
00319     <span class="keywordflow">if</span> (USER_SHARED_DATA-&gt;ProcessorFeatures[PF_COMPARE_EXCHANGE_DOUBLE]) {
00320 
00321 <span class="preprocessor">#endif // defined(_X86_)</span>
00322 <span class="preprocessor"></span>
00323         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/ntrtlp_8h.html#a14">RtlpQueryDepthSList</a>(&amp;Lookaside-&gt;ListHead) &lt; Lookaside-&gt;Depth) {
00324 
00325             <span class="comment">//</span>
00326             <span class="comment">//  We need to protect ourselves from a second thread that can</span>
00327             <span class="comment">//  cause us to fault on the push.  If we do fault then we'll</span>
00328             <span class="comment">//  just do a regular free operation</span>
00329             <span class="comment">//</span>
00330 
00331             <span class="keywordflow">try</span> {
00332 
00333                 <a class="code" href="../../d5/d9/ntrtlp_8h.html#a47">RtlpInterlockedPushEntrySList</a>(&amp;Lookaside-&gt;ListHead,
00334                                               (PSINGLE_LIST_ENTRY)Entry);
00335 
00336             } except (EXCEPTION_EXECUTE_HANDLER) {
00337 
00338                 Lookaside-&gt;FreeMisses += 1;
00339 
00340                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00341             }
00342 
00343             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00344         }
00345 
00346 <span class="preprocessor">#if defined(_X86_)</span>
00347 <span class="preprocessor"></span>
00348     }
00349 
00350 <span class="preprocessor">#endif // defined(_X86_)</span>
00351 <span class="preprocessor"></span>
00352     Lookaside-&gt;FreeMisses += 1;
00353 
00354     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00355 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="heappriv.h::RtlpGetExtraStuffPointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> RtlpGetExtraStuffPointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BusyBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06008">6008</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00161">_HEAP_VIRTUAL_ALLOC_ENTRY::ExtraStuff</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00239">HEAP_ENTRY_VIRTUAL_ALLOC</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00045">_HEAP_ENTRY::Size</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01192">RtlGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01790">RtlpValidateHeapSegment()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l01356">RtlSetUserValueHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02976">RtlUsageHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.
<p>
<pre class="fragment"><div>06014                    :
06015 
06016     This routine calculates where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extra stuff record will be given
06017     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> busy block and returns a pointer to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The caller must have
06018     already checked that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry extry field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present
06019 
06020 Arguments:
06021 
06022     BusyBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> busy block whose extra stuff we are seeking
06023 
06024 Return Value:
06025 
06026     <a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a> - returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extra stuff record.
06027 
06028 --*/
06029 
06030 {
06031     ULONG AllocationIndex;
06032 
06033     <span class="comment">//</span>
06034     <span class="comment">//  On big blocks the extra stuff is automatically part of the</span>
06035     <span class="comment">//  block</span>
06036     <span class="comment">//</span>
06037 
06038     <span class="keywordflow">if</span> (BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) {
06039 
06040         <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
06041 
06042         VirtualAllocBlock = CONTAINING_RECORD( BusyBlock, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock );
06043 
06044         <span class="keywordflow">return</span> &amp;VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>;
06045 
06046     } <span class="keywordflow">else</span> {
06047 
06048         <span class="comment">//</span>
06049         <span class="comment">//  On non big blocks the extra stuff follows immediately after</span>
06050         <span class="comment">//  the allocation itself.</span>
06051         <span class="comment">//</span>
06052         <span class="comment">//  **** What a hack</span>
06053         <span class="comment">//  **** We do some funny math here because the busy block</span>
06054         <span class="comment">//  **** stride is 8 bytes we know we can stride it by its</span>
06055         <span class="comment">//  **** index minus one to get to the end of the allocation</span>
06056         <span class="comment">//</span>
06057 
06058         AllocationIndex = BusyBlock-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o0">Size</a>;
06059 
06060         <span class="keywordflow">return</span> (<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html">PHEAP_ENTRY_EXTRA</a>)(BusyBlock + AllocationIndex - 1);
06061     }
06062 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="heappriv.h::RtlpGetSizeOfBigBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T RtlpGetSizeOfBigBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BusyBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06070">6070</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00162">_HEAP_VIRTUAL_ALLOC_ENTRY::CommitSize</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">RtlpCheckBusyBlockTail()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03655">RtlSizeHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l03714">RtlWalkHeap()</a>.
<p>
<pre class="fragment"><div>06076                    :
06077 
06078     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> big allocation block
06079 
06080 Arguments:
06081 
06082     BusyBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block being queried
06083 
06084 Return Value:
06085 
06086     SIZE_T - Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, that was allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> big
06087         block
06088 
06089 --*/
06090 
06091 {
06092     <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
06093 
06094     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
06095 
06096     <span class="comment">//</span>
06097     <span class="comment">//  Get a pointer to the block header itself</span>
06098     <span class="comment">//</span>
06099 
06100     VirtualAllocBlock = CONTAINING_RECORD( BusyBlock, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock );
06101 
06102     <span class="comment">//</span>
06103     <span class="comment">//  The size allocated to the block is actually the difference between the</span>
06104     <span class="comment">//  commit size stored in the virtual alloc block and the size stored in</span>
06105     <span class="comment">//  in the block.</span>
06106     <span class="comment">//</span>
06107 
06108     <span class="keywordflow">return</span> VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> - BusyBlock-&gt;Size;
06109 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="heappriv.h::RtlpGetTagName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PWSTR RtlpGetTagName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TagIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05425">5425</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00233">HEAP_MAXIMUM_FREELISTS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00405">HEAP_NUMBER_OF_PSEUDO_TAG</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00337">_HEAP::NextAvailableTagIndex</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00365">_HEAP::PseudoTagEntries</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00462">RtlpGlobalTagHeap</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00075">RtlpPseudoTagNameBuffer</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00339">_HEAP::TagEntries</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00308">_HEAP_TAG_ENTRY::TagName</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, and <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>.
<p>
<pre class="fragment"><div>05432                    :
05433 
05434     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag denoted by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap, tagindex
05435     tuple.
05436 
05437     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called by heapdbg when doing a debug <a class="code" href="../../d0/d1/rtdeltre_8c.html#a5">print</a> to
05438     generate a tag name <span class="keywordflow">for</span> printing
05439 
05440 Arguments:
05441 
05442     Heap - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag being queried
05443 
05444     TagIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag being queried
05445 
05446 Return Value:
05447 
05448     PWSTR - returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> indicated tag
05449 
05450 --*/
05451 
05452 {
05453     <span class="comment">//</span>
05454     <span class="comment">//  If the processes global tag heap has not been initialized then</span>
05455     <span class="comment">//  not tag has a name</span>
05456     <span class="comment">//</span>
05457 
05458     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05459 
05460         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05461     }
05462 
05463     <span class="comment">//</span>
05464     <span class="comment">//  We only deal with non zero tag indices</span>
05465     <span class="comment">//</span>
05466 
05467     <span class="keywordflow">if</span> (TagIndex != 0) {
05468 
05469         <span class="comment">//</span>
05470         <span class="comment">//  If the tag index is for a pseudo tag then we clear the</span>
05471         <span class="comment">//  the psuedo bit and generate a pseudo tag name</span>
05472         <span class="comment">//</span>
05473 
05474         <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
05475 
05476             TagIndex &amp;= ~HEAP_PSEUDO_TAG_FLAG;
05477 
05478             <span class="comment">//</span>
05479             <span class="comment">//  Check that the tag index is valid and that the heap</span>
05480             <span class="comment">//  has some psuedo tag entries</span>
05481             <span class="comment">//</span>
05482 
05483             <span class="keywordflow">if</span> ((TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>) &amp;&amp;
05484                 (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05485 
05486                 <span class="comment">//</span>
05487                 <span class="comment">//  A pseudo tag index of zero denote objects</span>
05488                 <span class="comment">//</span>
05489 
05490                 <span class="keywordflow">if</span> (TagIndex == 0) {
05491 
05492                     swprintf( RtlpPseudoTagNameBuffer, L<span class="stringliteral">"Objects&gt;%4u"</span>,
05493                               HEAP_MAXIMUM_FREELISTS &lt;&lt; HEAP_GRANULARITY_SHIFT );
05494 
05495                 <span class="comment">//</span>
05496                 <span class="comment">//  A psuedo tag index less than the free list maximum</span>
05497                 <span class="comment">//  denotes the dedicated free list</span>
05498                 <span class="comment">//</span>
05499 
05500                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>) {
05501 
05502                     swprintf( RtlpPseudoTagNameBuffer, L<span class="stringliteral">"Objects=%4u"</span>, TagIndex &lt;&lt; HEAP_GRANULARITY_SHIFT );
05503 
05504                 <span class="comment">//</span>
05505                 <span class="comment">//  Otherwise the pseudo tag is for the big allocations</span>
05506                 <span class="comment">//</span>
05507 
05508                 } <span class="keywordflow">else</span> {
05509 
05510                     swprintf( RtlpPseudoTagNameBuffer, L<span class="stringliteral">"VirtualAlloc"</span> );
05511                 }
05512 
05513                 <span class="keywordflow">return</span> <a class="code" href="../../d5/d9/heapdll_8c.html#a6">RtlpPseudoTagNameBuffer</a>;
05514             }
05515 
05516         <span class="comment">//</span>
05517         <span class="comment">//  Otherwise if the tag index is for a global tag then we pull</span>
05518         <span class="comment">//  the name off of the global heap.  Provided the index is valid</span>
05519         <span class="comment">//  and the heap does have some tag entries</span>
05520         <span class="comment">//</span>
05521 
05522         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
05523 
05524             TagIndex &amp;= ~HEAP_GLOBAL_TAG;
05525 
05526             <span class="keywordflow">if</span> ((TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05527                 (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05528 
05529                 <span class="keywordflow">return</span> <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ].<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o5">TagName</a>;
05530             }
05531 
05532         <span class="comment">//</span>
05533         <span class="comment">//  Otherwise we'll pull the name off of the input heap</span>
05534         <span class="comment">//  provided the index is valid and the heap does have some</span>
05535         <span class="comment">//  tag entries</span>
05536         <span class="comment">//</span>
05537 
05538         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TagIndex &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05539                    (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05540 
05541             <span class="keywordflow">return</span> Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ].<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o5">TagName</a>;
05542         }
05543     }
05544 
05545     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05546 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="heappriv.h::RtlpInitializeHeapLookaside" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID RtlpInitializeHeapLookaside           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/struct__HEAP__LOOKASIDE.html">PHEAP_LOOKASIDE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lookaside</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Depth</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html#l00045">45</a> of file <a class="el" href="../../d1/d5/rtl_2lookasid_8c-source.html">rtl/lookasid.c</a>.
<p>
References <a class="el" href="../../d0/d5/ex_2lookasid_8c-source.html#l00033">MINIMUM_LOOKASIDE_DEPTH</a>, and <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00405">RtlpInitializeSListHead</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>.
<p>
<pre class="fragment"><div>00052                    :
00053 
00054     This function initializes a heap lookaside list structure
00055 
00056 Arguments:
00057 
00058     Lookaside - Supplies a pointer to a heap lookaside list structure.
00059 
00060     Allocate - Supplies a pointer to an allocate function.
00061 
00062     Free - Supplies a pointer to a free function.
00063 
00064     <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap that backs <span class="keyword">this</span> lookaside list
00065 
00066     Flags - Supplies a set of heap flags.
00067 
00068     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookaside list entries.
00069 
00070     Depth - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum depth of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookaside list.
00071 
00072 Return Value:
00073 
00074     None.
00075 
00076 --*/
00077 
00078 {
00079 
00080     <span class="comment">//</span>
00081     <span class="comment">// Initialize the lookaside list structure.</span>
00082     <span class="comment">//</span>
00083 
00084     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a13">RtlpInitializeSListHead</a>(&amp;Lookaside-&gt;ListHead);
00085 
00086     Lookaside-&gt;Depth = <a class="code" href="../../d9/d5/ex_2lookasid_8c.html#a1">MINIMUM_LOOKASIDE_DEPTH</a>;
00087     Lookaside-&gt;MaximumDepth = 256; <span class="comment">//Depth;</span>
00088     Lookaside-&gt;TotalAllocates = 0;
00089     Lookaside-&gt;AllocateMisses = 0;
00090     Lookaside-&gt;TotalFrees = 0;
00091     Lookaside-&gt;FreeMisses = 0;
00092 
00093     Lookaside-&gt;LastTotalAllocates = 0;
00094     Lookaside-&gt;LastAllocateMisses = 0;
00095 
00096     <span class="keywordflow">return</span>;
00097 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="heappriv.h::RtlpInitializeHeapSegment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpInitializeHeapSegment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Segment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>SegmentIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>UnCommittedAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CommitLimitAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04732">4732</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00224">HEAP_GRANULARITY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00280">HEAP_SEGMENT_SIGNATURE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00053">_HEAP_ENTRY::PreviousSize</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00030">ROUND_UP_TO_POWER2</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01432">RtlGetNtGlobalFlags()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">RtlpInsertFreeBlock()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04227">RtlpInsertUnCommittedPages()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00060">_HEAP_ENTRY::SegmentIndex</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l00191">RtlCreateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02132">RtlExtendHeap()</a>, and <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>.
<p>
<pre class="fragment"><div>04744                    :
04745 
04746     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> internal structures <span class="keywordflow">for</span> a heap segment.
04747     The caller supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment being
04748     initialized
04749 
04750 Arguments:
04751 
04752     Heap - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap owning <span class="keyword">this</span> segment
04753 
04754     Segment - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment being initialized
04755 
04756     SegmentIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segement index within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap that <span class="keyword">this</span>
04757         <span class="keyword">new</span> segment <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being assigned
04758 
04759     Flags - Supplies flags controlling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment
04760         Valid flags are:
04761 
04762             <a class="code" href="../../d3/d9/heap_8h.html#a18">HEAP_SEGMENT_USER_ALLOCATED</a>
04763 
04764     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment
04765 
04766     UnCommittedAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> uncommited range starts
04767 
04768     CommitLimitAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top address available to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> segment
04769 
04770 Return Value:
04771 
04772     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
04773 
04774 --*/
04775 
04776 {
04777     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04778     <a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a> FirstEntry;
04779     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PreviousSize, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04780     ULONG NumberOfPages;
04781     ULONG NumberOfCommittedPages;
04782     ULONG NumberOfUnCommittedPages;
04783     SIZE_T CommitSize;
04784     ULONG <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>();
04785 
04786     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
04787 
04788     <span class="comment">//</span>
04789     <span class="comment">//  Compute the total number of pages possible in this segment</span>
04790     <span class="comment">//</span>
04791 
04792     NumberOfPages = (ULONG) (((PCHAR)CommitLimitAddress - (PCHAR)BaseAddress) / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04793 
04794     <span class="comment">//</span>
04795     <span class="comment">//  First entry points to the first possible segment entry after</span>
04796     <span class="comment">//  the segment header</span>
04797     <span class="comment">//</span>
04798 
04799     FirstEntry = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)<a class="code" href="../../d3/d9/heap_8h.html#a1">ROUND_UP_TO_POWER2</a>( Segment + 1,
04800                                                   HEAP_GRANULARITY );
04801 
04802     <span class="comment">//</span>
04803     <span class="comment">//  Now if the heap is equal to the base address for the segment which</span>
04804     <span class="comment">//  it the case for the segment zero then the previous size is the</span>
04805     <span class="comment">//  heap header.  Otherwise there isn't a previous entry</span>
04806     <span class="comment">//</span>
04807 
04808     <span class="keywordflow">if</span> ((PVOID)Heap == BaseAddress) {
04809 
04810         PreviousSize = Heap-&gt;Entry.Size;
04811 
04812     } <span class="keywordflow">else</span> {
04813 
04814         PreviousSize = 0;
04815     }
04816 
04817     <span class="comment">//</span>
04818     <span class="comment">//  Compute the index size of the segement header</span>
04819     <span class="comment">//</span>
04820 
04821     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(((PCHAR)FirstEntry - (PCHAR)Segment) &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>);
04822 
04823     <span class="comment">//</span>
04824     <span class="comment">//  If the first available heap entry is not committed and</span>
04825     <span class="comment">//  it is beyond the heap limit then we cannot initialize</span>
04826     <span class="comment">//</span>
04827 
04828     <span class="keywordflow">if</span> ((PCHAR)(FirstEntry + 1) &gt;= (PCHAR)UnCommittedAddress) {
04829 
04830         <span class="keywordflow">if</span> ((PCHAR)(FirstEntry + 1) &gt;= (PCHAR)CommitLimitAddress) {
04831 
04832             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04833         }
04834 
04835         <span class="comment">//</span>
04836         <span class="comment">//  Enough of the segment has not been committed so we</span>
04837         <span class="comment">//  will commit enough now to handle the first entry</span>
04838         <span class="comment">//</span>
04839 
04840         CommitSize = (PCHAR)(FirstEntry + 1) - (PCHAR)UnCommittedAddress;
04841 
04842         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
04843                                           (PVOID *)&amp;UnCommittedAddress,
04844                                           0,
04845                                           &amp;CommitSize,
04846                                           MEM_COMMIT,
04847                                           PAGE_READWRITE );
04848 
04849         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
04850 
04851             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04852         }
04853 
04854         <span class="comment">//</span>
04855         <span class="comment">//  Because we had to commit some memory we need to adjust</span>
04856         <span class="comment">//  the uncommited address</span>
04857         <span class="comment">//</span>
04858 
04859         UnCommittedAddress = (PVOID)((PCHAR)UnCommittedAddress + CommitSize);
04860     }
04861 
04862     <span class="comment">//</span>
04863     <span class="comment">//  At this point we know there is enough memory committed to handle the</span>
04864     <span class="comment">//  segment header and one heap entry</span>
04865     <span class="comment">//</span>
04866     <span class="comment">//  Now compute the number of uncommited pages and the number of committed</span>
04867     <span class="comment">//  pages</span>
04868     <span class="comment">//</span>
04869 
04870     NumberOfUnCommittedPages = (ULONG)(((PCHAR)CommitLimitAddress - (PCHAR)UnCommittedAddress) / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04871     NumberOfCommittedPages = NumberOfPages - NumberOfUnCommittedPages;
04872 
04873     <span class="comment">//</span>
04874     <span class="comment">//  Initialize the heap segment heap entry.  We</span>
04875     <span class="comment">//  calculated earlier if there was a previous entry</span>
04876     <span class="comment">//</span>
04877 
04878     Segment-&gt;Entry.PreviousSize = PreviousSize;
04879     Segment-&gt;Entry.Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
04880     Segment-&gt;Entry.Flags = <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>;
04881     Segment-&gt;Entry.SegmentIndex = SegmentIndex;
04882 
04883 <span class="preprocessor">#if i386 &amp;&amp; !NTOS_KERNEL_RUNTIME</span>
04884 <span class="preprocessor"></span>
04885     <span class="comment">//</span>
04886     <span class="comment">//  In the non kernel x86 case see if we need to capture the callers stack</span>
04887     <span class="comment">//  backtrace</span>
04888     <span class="comment">//</span>
04889 
04890     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_USER_STACK_TRACE_DB) {
04891 
04892         Segment-&gt;AllocatorBackTraceIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)RtlLogStackBackTrace();
04893     }
04894 
04895 <span class="preprocessor">#endif // i386 &amp;&amp; !NTOS_KERNEL_RUNTIME</span>
04896 <span class="preprocessor"></span>
04897     <span class="comment">//</span>
04898     <span class="comment">//  Now initializes the heap segment</span>
04899     <span class="comment">//</span>
04900 
04901     Segment-&gt;Signature = <a class="code" href="../../d3/d9/heap_8h.html#a17">HEAP_SEGMENT_SIGNATURE</a>;
04902     Segment-&gt;Flags = Flags;
04903     Segment-&gt;Heap = Heap;
04904     Segment-&gt;BaseAddress = BaseAddress;
04905     Segment-&gt;FirstEntry = FirstEntry;
04906     Segment-&gt;LastValidEntry = (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)((PCHAR)BaseAddress + (NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
04907     Segment-&gt;NumberOfPages = NumberOfPages;
04908     Segment-&gt;NumberOfUnCommittedPages = NumberOfUnCommittedPages;
04909 
04910     <span class="comment">//</span>
04911     <span class="comment">//  If there are uncommitted pages then we need to insert them</span>
04912     <span class="comment">//  into the uncommitted ranges list</span>
04913     <span class="comment">//</span>
04914 
04915     <span class="keywordflow">if</span> (NumberOfUnCommittedPages) {
04916 
04917         <a class="code" href="../../d1/d9/rtl_2heap_8c.html#a12">RtlpInsertUnCommittedPages</a>( Segment,
04918                                     (ULONG_PTR)UnCommittedAddress,
04919                                     NumberOfUnCommittedPages * PAGE_SIZE );
04920     }
04921 
04922     <span class="comment">//</span>
04923     <span class="comment">//  Have the containing heap point to this segment via the specified index</span>
04924     <span class="comment">//</span>
04925 
04926     Heap-&gt;Segments[ SegmentIndex ] = Segment;
04927 
04928     <span class="comment">//</span>
04929     <span class="comment">//  Initialize the first free heap entry after the heap segment header and</span>
04930     <span class="comment">//  put it in the free list.  This first entry will be for whatever is left</span>
04931     <span class="comment">//  of the committed range</span>
04932     <span class="comment">//</span>
04933 
04934     PreviousSize = Segment-&gt;Entry.Size;
04935     FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> = <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>;
04936 
04937     Segment-&gt;LastEntryInSegment = FirstEntry;
04938 
04939     FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o1">PreviousSize</a> = PreviousSize;
04940     FirstEntry-&gt;<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o2">SegmentIndex</a> = SegmentIndex;
04941 
04942     <a class="code" href="../../d9/d9/heappriv_8h.html#a36">RtlpInsertFreeBlock</a>( Heap,
04943                          (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)FirstEntry,
04944                          (<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)UnCommittedAddress - FirstEntry);
04945 
04946     <span class="comment">//</span>
04947     <span class="comment">//  And return to our caller</span>
04948     <span class="comment">//</span>
04949 
04950     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04951 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="heappriv.h::RtlpInsertFreeBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpInsertFreeBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05849">5849</a> of file <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html">rtl/heap.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00263">_HEAP_SEGMENT::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00240">HEAP_ENTRY_LAST_ENTRY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00231">HEAP_MAXIMUM_BLOCK_SIZE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00270">_HEAP_SEGMENT::LastValidEntry</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00322">RtlpInsertFreeBlockDirect</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02931">RtlFreeHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04312">RtlpCoalesceHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05527">RtlpDeCommitFreeBlock()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l05024">RtlpExtendHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l04732">RtlpInitializeHeapSegment()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.
<p>
<pre class="fragment"><div>05857                    :
05858 
05859     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> take a piece of committed memory and adds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05860     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate free lists <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap.  If necessary <span class="keyword">this</span>
05861     routine will divide up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free block to sizes that fit
05862     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> free list
05863 
05864 
05865 Arguments:
05866 
05867     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> owning heap
05868 
05869     FreeBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block being freed
05870 
05871     FreeSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block being freed
05872 
05873 Return Value:
05874 
05875     None.
05876 
05877 --*/
05878 
05879 {
05880     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PreviousSize, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
05881     UCHAR Flags;
05882     UCHAR SegmentIndex;
05883     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
05884 
05885     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
05886 
05887     <span class="comment">//</span>
05888     <span class="comment">//  Get the size of the previous block, the index of the segment</span>
05889     <span class="comment">//  containing this block, and the flags specific to the block</span>
05890     <span class="comment">//</span>
05891 
05892     PreviousSize = FreeBlock-&gt;PreviousSize;
05893 
05894     SegmentIndex = FreeBlock-&gt;SegmentIndex;
05895     Segment = Heap-&gt;Segments[ SegmentIndex ];
05896 
05897     Flags = FreeBlock-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o2">Flags</a>;
05898 
05899     <span class="comment">//</span>
05900     <span class="comment">//  Adjust the total amount free in the heap</span>
05901     <span class="comment">//</span>
05902 
05903     Heap-&gt;TotalFreeSize += FreeSize;
05904 
05905     <span class="comment">//</span>
05906     <span class="comment">//  Now, while there is still something left to add to the free list</span>
05907     <span class="comment">//  we'll process the information</span>
05908     <span class="comment">//</span>
05909 
05910     <span class="keywordflow">while</span> (FreeSize != 0) {
05911 
05912         <span class="comment">//</span>
05913         <span class="comment">//  If the size is too big for our free lists then we'll</span>
05914         <span class="comment">//  chop it down.</span>
05915         <span class="comment">//</span>
05916 
05917         <span class="keywordflow">if</span> (FreeSize &gt; (ULONG)<a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>) {
05918 
05919             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a>;
05920 
05921             <span class="comment">//</span>
05922             <span class="comment">//  This little adjustment is so that we don't have a remainder</span>
05923             <span class="comment">//  that is too small to be useful on the next iteration</span>
05924             <span class="comment">//  through the loop</span>
05925             <span class="comment">//</span>
05926 
05927             <span class="keywordflow">if</span> (FreeSize == ((ULONG)<a class="code" href="../../d3/d9/heap_8h.html#a5">HEAP_MAXIMUM_BLOCK_SIZE</a> + 1)) {
05928 
05929                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> -= 16;
05930             }
05931 
05932             <span class="comment">//</span>
05933             <span class="comment">//  Guarantee that Last entry does not get set in this</span>
05934             <span class="comment">//  block.</span>
05935             <span class="comment">//</span>
05936 
05937             FreeBlock-&gt;Flags = 0;
05938 
05939         } <span class="keywordflow">else</span> {
05940 
05941             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeSize;
05942 
05943             <span class="comment">//</span>
05944             <span class="comment">//  This could propagate the last entry flag</span>
05945             <span class="comment">//</span>
05946 
05947             FreeBlock-&gt;Flags = Flags;
05948         }
05949 
05950         <span class="comment">//</span>
05951         <span class="comment">//  Update the block sizes and then insert this</span>
05952         <span class="comment">//  block into a free list</span>
05953         <span class="comment">//</span>
05954 
05955         FreeBlock-&gt;PreviousSize = PreviousSize;
05956         FreeBlock-&gt;SegmentIndex = SegmentIndex;
05957         FreeBlock-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
05958 
05959         <a class="code" href="../../d9/d9/heappriv_8h.html#a14">RtlpInsertFreeBlockDirect</a>( Heap, FreeBlock, Size );
05960 
05961         <span class="comment">//</span>
05962         <span class="comment">//  Note the size of what we just freed, and then update</span>
05963         <span class="comment">//  our state information for the next time through the</span>
05964         <span class="comment">//  loop</span>
05965         <span class="comment">//</span>
05966 
05967         PreviousSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
05968 
05969         FreeSize -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
05970         FreeBlock = (<a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a>)((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);
05971 
05972         <span class="comment">//</span>
05973         <span class="comment">//  Check if we're done with the free block based on the</span>
05974         <span class="comment">//  segment information, otherwise go back up and check size</span>
05975         <span class="comment">//  Note that is means that we can get called with a very</span>
05976         <span class="comment">//  large size and still work.</span>
05977         <span class="comment">//</span>
05978 
05979         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>)FreeBlock &gt;= Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>) {
05980 
05981             <span class="keywordflow">return</span>;
05982         }
05983     }
05984 
05985     <span class="comment">//</span>
05986     <span class="comment">//  If the block we're freeing did not think it was the last entry</span>
05987     <span class="comment">//  then tell the next block our real size.</span>
05988     <span class="comment">//</span>
05989 
05990     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a12">HEAP_ENTRY_LAST_ENTRY</a>)) {
05991 
05992         FreeBlock-&gt;PreviousSize = PreviousSize;
05993     }
05994 
05995     <span class="comment">//</span>
05996     <span class="comment">//  And return to our caller</span>
05997     <span class="comment">//</span>
05998 
05999     <span class="keywordflow">return</span>;
06000 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="heappriv.h::RtlpRemoveHeapFromProcessList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpRemoveHeapFromProcessList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Heap</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04571">4571</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d4/d6/struct__HEAP__LOCK.html#o2">_HEAP_LOCK::Lock</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00078">RtlAcquireLockRoutine</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00053">RtlpProcessHeapsListLock</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00076">RtlpUpdateHeapListIndex()</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00079">RtlReleaseLockRoutine</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01133">RtlDestroyHeap()</a>.
<p>
<pre class="fragment"><div>04577                    :
04578 
04579     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified heap to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap list <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04580     current process
04581 
04582 Arguments:
04583 
04584     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being removed
04585 
04586 Return Value:
04587 
04588     None.
04589 
04590 --*/
04591 
04592 {
04593     PPEB Peb = NtCurrentPeb();
04594     <a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> *p, *p1;
04595     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
04596 
04597     <span class="comment">//</span>
04598     <span class="comment">//  Lock the current processes heap list lock</span>
04599     <span class="comment">//</span>
04600 
04601     <a class="code" href="../../d9/d9/heappriv_8h.html#a3">RtlAcquireLockRoutine</a>( &amp;<a class="code" href="../../d5/d9/heapdll_8c.html#a3">RtlpProcessHeapsListLock</a>.<a class="code" href="../../d4/d6/struct__HEAP__LOCK.html#o2">Lock</a> );
04602 
04603     <span class="keywordflow">try</span> {
04604 
04605         <span class="comment">//</span>
04606         <span class="comment">//  We only want to the the work if the current process actually has some</span>
04607         <span class="comment">//  heaps, the index stored in the heap is within the range for active</span>
04608         <span class="comment">//  heaps.  Note that the heaps stored index is bias by one.</span>
04609         <span class="comment">//</span>
04610 
04611         <span class="keywordflow">if</span> ((Peb-&gt;NumberOfHeaps != 0) &amp;&amp;
04612             (Heap-&gt;ProcessHeapsListIndex != 0) &amp;&amp;
04613             (Heap-&gt;ProcessHeapsListIndex &lt;= Peb-&gt;NumberOfHeaps)) {
04614 
04615             <span class="comment">//</span>
04616             <span class="comment">//  Establish a pointer into the array of process heaps at the</span>
04617             <span class="comment">//  current heap location and one beyond</span>
04618             <span class="comment">//</span>
04619 
04620             p = (<a class="code" href="../../d5/d5/struct__HEAP.html">PHEAP</a> *)&amp;Peb-&gt;ProcessHeaps[ Heap-&gt;ProcessHeapsListIndex - 1 ];
04621 
04622             p1 = p + 1;
04623 
04624             <span class="comment">//</span>
04625             <span class="comment">//  Calculate the number of heaps that exist beyond the current</span>
04626             <span class="comment">//  heap in the array including the current heap location</span>
04627             <span class="comment">//</span>
04628 
04629             <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Peb-&gt;NumberOfHeaps - (Heap-&gt;ProcessHeapsListIndex - 1);
04630 
04631             <span class="comment">//</span>
04632             <span class="comment">//  For every heap beyond the current one that we are removing</span>
04633             <span class="comment">//  we'll move that heap down to the previous index.</span>
04634             <span class="comment">//</span>
04635 
04636             <span class="keywordflow">while</span> (--<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
04637 
04638                 <span class="comment">//</span>
04639                 <span class="comment">//  Copy the heap process array entry of the next entry to</span>
04640                 <span class="comment">//  the current entry, and move p1 to the next next entry</span>
04641                 <span class="comment">//</span>
04642 
04643                 *p = *p1++;
04644 
04645                 <span class="comment">//</span>
04646                 <span class="comment">//  This is simply a debugging call</span>
04647                 <span class="comment">//</span>
04648 
04649                 <a class="code" href="../../d9/d9/heappriv_8h.html#a49">RtlpUpdateHeapListIndex</a>( (*p)-&gt;ProcessHeapsListIndex,
04650                                          (USHORT)((*p)-&gt;ProcessHeapsListIndex - 1));
04651 
04652                 <span class="comment">//</span>
04653                 <span class="comment">//  Assign the moved heap its new heap index</span>
04654                 <span class="comment">//</span>
04655 
04656                 (*p)-&gt;ProcessHeapsListIndex -= 1;
04657 
04658                 <span class="comment">//</span>
04659                 <span class="comment">//  Move on to the next heap entry</span>
04660                 <span class="comment">//</span>
04661 
04662                 p += 1;
04663             }
04664 
04665             <span class="comment">//</span>
04666             <span class="comment">//  Zero out the last process heap pointer, update the count, and</span>
04667             <span class="comment">//  make the heap we just removed realize it has been removed by</span>
04668             <span class="comment">//  zeroing out its process heap list index</span>
04669             <span class="comment">//</span>
04670 
04671             Peb-&gt;ProcessHeaps[ --Peb-&gt;NumberOfHeaps ] = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04672             Heap-&gt;ProcessHeapsListIndex = 0;
04673         }
04674 
04675     } finally {
04676 
04677         <span class="comment">//</span>
04678         <span class="comment">//  Unlock the current processes heap list lock</span>
04679         <span class="comment">//</span>
04680 
04681         <a class="code" href="../../d9/d9/heappriv_8h.html#a4">RtlReleaseLockRoutine</a>( &amp;<a class="code" href="../../d5/d9/heapdll_8c.html#a3">RtlpProcessHeapsListLock</a>.<a class="code" href="../../d4/d6/struct__HEAP__LOCK.html#o2">Lock</a> );
04682     }
04683 
04684     <span class="keywordflow">return</span>;
04685 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="heappriv.h::RtlpResetTags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpResetTags           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Heap</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05802">5802</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00312">_HEAP_PSEUDO_TAG_ENTRY::Allocs</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00303">_HEAP_TAG_ENTRY::Allocs</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00313">_HEAP_PSEUDO_TAG_ENTRY::Frees</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00304">_HEAP_TAG_ENTRY::Frees</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00405">HEAP_NUMBER_OF_PSEUDO_TAG</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00337">_HEAP::NextAvailableTagIndex</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00365">_HEAP::PseudoTagEntries</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00314">_HEAP_PSEUDO_TAG_ENTRY::Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00305">_HEAP_TAG_ENTRY::Size</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00339">_HEAP::TagEntries</a>.
<p>
<pre class="fragment"><div>05808                    :
05809 
05810     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to reset all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag entries in a heap
05811 
05812 Arguments:
05813 
05814     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being modified
05815 
05816 Return Value:
05817 
05818     None.
05819 
05820 --*/
05821 
05822 {
05823     <a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a> TagEntry;
05824     <a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html">PHEAP_PSEUDO_TAG_ENTRY</a> PseudoTagEntry;
05825     ULONG i;
05826 
05827     <span class="comment">//</span>
05828     <span class="comment">//  We only have work to do if the heap has any allocated tag entries</span>
05829     <span class="comment">//</span>
05830 
05831     TagEntry = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>;
05832 
05833     <span class="keywordflow">if</span> (TagEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05834 
05835         <span class="comment">//</span>
05836         <span class="comment">//  For every tag entry in the heap we will zero out its counters</span>
05837         <span class="comment">//</span>
05838 
05839         <span class="keywordflow">for</span> (i=0; i&lt;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>; i++) {
05840 
05841             TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o0">Allocs</a> = 0;
05842             TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o1">Frees</a> = 0;
05843             TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a> = 0;
05844 
05845             <span class="comment">//</span>
05846             <span class="comment">//  Advance to the next tag entry</span>
05847             <span class="comment">//</span>
05848 
05849             TagEntry += 1;
05850         }
05851     }
05852 
05853     <span class="comment">//</span>
05854     <span class="comment">//  We will only reset the pseudo tags if they exist</span>
05855     <span class="comment">//</span>
05856 
05857     PseudoTagEntry = Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a>;
05858 
05859     <span class="keywordflow">if</span> (PseudoTagEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05860 
05861         <span class="comment">//</span>
05862         <span class="comment">//  For every pseudo tag entry in the heap we will zero out its</span>
05863         <span class="comment">//  counters</span>
05864         <span class="comment">//</span>
05865 
05866         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>; i++) {
05867 
05868             PseudoTagEntry-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o0">Allocs</a> = 0;
05869             PseudoTagEntry-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o1">Frees</a> = 0;
05870             PseudoTagEntry-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a> = 0;
05871 
05872             <span class="comment">//</span>
05873             <span class="comment">//  Advance to the next pseudo tag entry</span>
05874             <span class="comment">//</span>
05875 
05876             PseudoTagEntry += 1;
05877         }
05878     }
05879 
05880     <span class="comment">//</span>
05881     <span class="comment">//  And return to our caller</span>
05882     <span class="comment">//</span>
05883 
05884     <span class="keywordflow">return</span>;
05885 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="heappriv.h::RtlpUpdateHeapListIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpUpdateHeapListIndex           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewIndex</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00076">76</a> of file <a class="el" href="../../d5/d8/heapdbg_8c-source.html">heapdbg.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00450">_HEAP_STOP_ON_VALUES::AllocTag</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00454">_HEAP_STOP_ON_VALUES::FreeTag</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00443">_HEAP_STOP_ON_TAG::HeapIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00452">_HEAP_STOP_ON_VALUES::ReAllocTag</a>, and <a class="el" href="../../d4/d8/heap_8h-source.html#l00463">RtlpHeapStopOn</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04571">RtlpRemoveHeapFromProcessList()</a>.
<p>
<pre class="fragment"><div>00083                    :
00084 
00085 Arguments:
00086 
00087 Return Value:
00088 
00089 --*/
00090 
00091 {
00092     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00093 
00094         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o1">AllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00095     }
00096 
00097     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00098 
00099         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o3">ReAllocTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00100     }
00101 
00102     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> == OldIndex) {
00103 
00104         <a class="code" href="../../d3/d9/heap_8h.html#a65">RtlpHeapStopOn</a>.<a class="code" href="../../d2/d7/struct__HEAP__STOP__ON__VALUES.html#o5">FreeTag</a>.<a class="code" href="../../d9/d6/struct__HEAP__STOP__ON__TAG.html#o2">HeapIndex</a> = NewIndex;
00105     }
00106 
00107     <span class="keywordflow">return</span>;
00108 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="heappriv.h::RtlpUpdateTagEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RtlpUpdateTagEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TagIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>OldSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NewSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Action</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/heapdll_8c-source.html#l05554">5554</a> of file <a class="el" href="../../d6/d8/heapdll_8c-source.html">heapdll.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00090">Action</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00303">_HEAP_TAG_ENTRY::Allocs</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a29">FreeAction</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00304">_HEAP_TAG_ENTRY::Frees</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00233">HEAP_MAXIMUM_FREELISTS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00405">HEAP_NUMBER_OF_PSEUDO_TAG</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a24">HEAP_TAG_ACTION</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00337">_HEAP::NextAvailableTagIndex</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00365">_HEAP::PseudoTagEntries</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a31">ReAllocationAction</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00462">RtlpGlobalTagHeap</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00305">_HEAP_TAG_ENTRY::Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00339">_HEAP::TagEntries</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d9/d9/heappriv_8h.html#a60a28">VirtualAllocationAction</a>, and <a class="el" href="../../d9/d9/heappriv_8h.html#a60a32">VirtualReAllocationAction</a>.
<p>
Referenced by <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l03273">RtlFreeHeapSlowly()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>.
<p>
<pre class="fragment"><div>05564                    :
05565 
05566     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to modify a tag entry
05567 
05568 Arguments:
05569 
05570     Heap - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap being modified
05571 
05572     TagIndex - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag being modified
05573 
05574     OldSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old allocation index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag
05575 
05576     NewSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> allocation index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tag
05577 
05578     <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of action being performed on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> heap tag
05579 
05580 Return Value:
05581 
05582     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> - Returns a tag index <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly updated tag
05583 
05584 --*/
05585 
05586 {
05587     <a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a> TagEntry;
05588 
05589     <span class="comment">//</span>
05590     <span class="comment">//  If the processes tag heap does not exist then we'll return a zero index</span>
05591     <span class="comment">//  right away</span>
05592     <span class="comment">//</span>
05593 
05594     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05595 
05596         <span class="keywordflow">return</span> 0;
05597     }
05598 
05599     <span class="comment">//</span>
05600     <span class="comment">//  If the action is greater than or equal to free action then it is</span>
05601     <span class="comment">//  either FreeAction, VirtualFreeAction, ReAllocationAction, or</span>
05602     <span class="comment">//  VirtualReAllocationAction.  Which means we already should have a tag</span>
05603     <span class="comment">//  that is simply being modified</span>
05604     <span class="comment">//</span>
05605 
05606     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> &gt;= <a class="code" href="../../d9/d9/heappriv_8h.html#a60a29">FreeAction</a>) {
05607 
05608         <span class="comment">//</span>
05609         <span class="comment">//  If the tag index is zero then there is nothing for us to do</span>
05610         <span class="comment">//</span>
05611 
05612         <span class="keywordflow">if</span> (TagIndex == 0) {
05613 
05614             <span class="keywordflow">return</span> 0;
05615         }
05616 
05617         <span class="comment">//</span>
05618         <span class="comment">//  If this is a pseudo tag then make sure the rest of the tag index</span>
05619         <span class="comment">//  after we remove the psuedo bit is valid and that the heap is</span>
05620         <span class="comment">//  actually maintaining pseudo tags</span>
05621         <span class="comment">//</span>
05622 
05623         <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
05624 
05625             TagIndex &amp;= ~HEAP_PSEUDO_TAG_FLAG;
05626 
05627             <span class="keywordflow">if</span> ((TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>) &amp;&amp;
05628                 (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05629 
05630                 TagEntry = (<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a>)(Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> + TagIndex);
05631 
05632                 TagIndex |= HEAP_PSEUDO_TAG_FLAG;
05633 
05634             } <span class="keywordflow">else</span> {
05635 
05636                 <span class="keywordflow">return</span> 0;
05637             }
05638 
05639         <span class="comment">//</span>
05640         <span class="comment">//  Otherwise if this is a global tag then make sure the tag index</span>
05641         <span class="comment">//  after we remove the global bit is valid and that the global tag</span>
05642         <span class="comment">//  heap has some tag entries</span>
05643         <span class="comment">//</span>
05644 
05645         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
05646 
05647             TagIndex &amp;= ~HEAP_GLOBAL_TAG;
05648 
05649             <span class="keywordflow">if</span> ((TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05650                 (<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05651 
05652                 TagEntry = &amp;<a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ];
05653 
05654                 TagIndex |= HEAP_GLOBAL_TAG;
05655 
05656             } <span class="keywordflow">else</span> {
05657 
05658                 <span class="keywordflow">return</span> 0;
05659             }
05660 
05661         <span class="comment">//</span>
05662         <span class="comment">//  Otherwise we have a regular tag index that we need to make sure</span>
05663         <span class="comment">//  is a valid value and that the heap has some tag entries</span>
05664         <span class="comment">//</span>
05665 
05666         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TagIndex &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05667                    (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05668 
05669             TagEntry = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ];
05670 
05671         } <span class="keywordflow">else</span> {
05672 
05673             <span class="keywordflow">return</span> 0;
05674         }
05675 
05676         <span class="comment">//</span>
05677         <span class="comment">//  At this point we have a tag entry and tag index.  Increment the</span>
05678         <span class="comment">//  number of frees we've done on the tag, and decrement the size by</span>
05679         <span class="comment">//  the number of bytes we've just freed</span>
05680         <span class="comment">//</span>
05681 
05682         TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o1">Frees</a> += 1;
05683 
05684         TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a> -= OldSize;
05685 
05686         <span class="comment">//</span>
05687         <span class="comment">//  Now if the action is either ReAllocationAction or</span>
05688         <span class="comment">//  VirtualReAllocationAction.  Then we get to add back in the</span>
05689         <span class="comment">//  new size and the allocation count</span>
05690         <span class="comment">//</span>
05691 
05692         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> &gt;= <a class="code" href="../../d9/d9/heappriv_8h.html#a60a31">ReAllocationAction</a>) {
05693 
05694             <span class="comment">//</span>
05695             <span class="comment">//  If the this is a pseudo tag then we tag entry goes off the</span>
05696             <span class="comment">//  pseudo tag list</span>
05697             <span class="comment">//</span>
05698 
05699             <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
05700 
05701                 TagIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NewSize &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> ?
05702                                         NewSize :
05703                                         (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d9/d9/heappriv_8h.html#a60a32">VirtualReAllocationAction</a> ? <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> : 0));
05704 
05705                 TagEntry = (<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a>)(Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> + TagIndex);
05706 
05707                 TagIndex |= HEAP_PSEUDO_TAG_FLAG;
05708             }
05709 
05710             TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o0">Allocs</a> += 1;
05711 
05712             TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a> += NewSize;
05713         }
05714 
05715     <span class="comment">//</span>
05716     <span class="comment">//  The action is either AllocationAction or VirtualAllocationAction</span>
05717     <span class="comment">//</span>
05718 
05719     } <span class="keywordflow">else</span> {
05720 
05721         <span class="comment">//</span>
05722         <span class="comment">//  Check if the supplied tag index is a regular tag and that it is</span>
05723         <span class="comment">//  valid for the tags in this heap</span>
05724         <span class="comment">//</span>
05725 
05726         <span class="keywordflow">if</span> ((TagIndex != 0) &amp;&amp;
05727             (TagIndex &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05728             (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05729 
05730             TagEntry = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ];
05731 
05732         <span class="comment">//</span>
05733         <span class="comment">//  Otherwise if this is a global tag then make sure that it is a</span>
05734         <span class="comment">//  valid global index</span>
05735         <span class="comment">//</span>
05736 
05737         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
05738 
05739             TagIndex &amp;= ~HEAP_GLOBAL_TAG;
05740 
05741             Heap = <a class="code" href="../../d3/d9/heap_8h.html#a64">RtlpGlobalTagHeap</a>;
05742 
05743             <span class="keywordflow">if</span> ((TagIndex &lt; Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o14">NextAvailableTagIndex</a>) &amp;&amp;
05744                 (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
05745 
05746                 TagEntry = &amp;Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o16">TagEntries</a>[ TagIndex ];
05747 
05748                 TagIndex |= HEAP_GLOBAL_TAG;
05749 
05750             } <span class="keywordflow">else</span> {
05751 
05752                 <span class="keywordflow">return</span> 0;
05753             }
05754 
05755         <span class="comment">//</span>
05756         <span class="comment">//  Otherwise if this is a pseudo tag then build a valid tag index</span>
05757         <span class="comment">//  based on the new size of the allocation</span>
05758         <span class="comment">//</span>
05759 
05760         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05761 
05762             TagIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(NewSize &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> ?
05763                                     NewSize :
05764                                     (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d9/d9/heappriv_8h.html#a60a28">VirtualAllocationAction</a> ? <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a> : 0));
05765 
05766             TagEntry = (<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a>)(Heap-&gt;<a class="code" href="../../d5/d5/struct__HEAP.html#o29">PseudoTagEntries</a> + TagIndex);
05767 
05768             TagIndex |= HEAP_PSEUDO_TAG_FLAG;
05769 
05770         <span class="comment">//</span>
05771         <span class="comment">//  Otherwise the user didn't call us with a valid tag</span>
05772         <span class="comment">//</span>
05773 
05774         } <span class="keywordflow">else</span> {
05775 
05776             <span class="keywordflow">return</span> 0;
05777         }
05778 
05779         <span class="comment">//</span>
05780         <span class="comment">//  At this point we have a valid tag entry and tag index, so</span>
05781         <span class="comment">//  update the tag entry state to reflect this new allocation</span>
05782         <span class="comment">//</span>
05783 
05784         TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o0">Allocs</a> += 1;
05785 
05786         TagEntry-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a> += NewSize;
05787     }
05788 
05789     <span class="comment">//</span>
05790     <span class="comment">//  And return to our caller with the new tag index</span>
05791     <span class="comment">//</span>
05792 
05793     <span class="keywordflow">return</span> TagIndex;
05794 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="heappriv.h::RtlpValidateHeap" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpValidateHeap           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlwaysValidate</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">2025</a> of file <a class="el" href="../../d5/d8/heapdbg_8c-source.html">heapdbg.c</a>.
<p>
References <a class="el" href="../../d4/d8/heap_8h-source.html#l00164">_HEAP_VIRTUAL_ALLOC_ENTRY::BusyBlock</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00162">_HEAP_VIRTUAL_ALLOC_ENTRY::CommitSize</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00161">_HEAP_VIRTUAL_ALLOC_ENTRY::ExtraStuff</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00076">_HEAP_ENTRY::Flags</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00238">HEAP_ENTRY_FILL_PATTERN</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00228">HEAP_GRANULARITY_SHIFT</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00233">HEAP_MAXIMUM_FREELISTS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00234">HEAP_MAXIMUM_SEGMENTS</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00405">HEAP_NUMBER_OF_PSEUDO_TAG</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00390">HEAP_VALIDATE_ALL_ENABLED</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">HeapDebugBreak</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00246">RTL_PAGED_CODE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">RtlpCheckBusyBlockTail()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">RtlpValidateHeapHeaders()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01790">RtlpValidateHeapSegment()</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00461">RtlpValidateHeapTagsEnable</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00305">_HEAP_TAG_ENTRY::Size</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00314">_HEAP_PSEUDO_TAG_ENTRY::Size</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00121">_HEAP_ENTRY_EXTRA::TagIndex</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00308">_HEAP_TAG_ENTRY::TagName</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00388">RtlDebugDestroyHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01498">RtlDebugQueryTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01572">RtlDebugUsageHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01654">RtlDebugWalkHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01338">RtlDebugZeroHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.
<p>
<pre class="fragment"><div>02032                    :
02033 
02034 Arguments:
02035 
02036 Return Value:
02037 
02038 --*/
02039 
02040 {
02041     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02042     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
02043     PLIST_ENTRY Head, Next;
02044     <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">PHEAP_FREE_ENTRY</a> FreeBlock;
02045     BOOLEAN EmptyFreeList;
02046     ULONG NumberOfFreeListEntries;
02047     ULONG CountOfFreeBlocks;
02048     SIZE_T TotalFreeSize;
02049     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02050     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PreviousSize;
02051     UCHAR SegmentIndex;
02052     PVOID BadAddress;
02053     PSIZE_T ComputedTagEntries = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02054     PSIZE_T ComputedPseudoTagEntries = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02055     <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">PHEAP_VIRTUAL_ALLOC_ENTRY</a> VirtualAllocBlock;
02056     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
02057 
02058     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02059 
02060     BadAddress = Heap;
02061 
02062     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a50">RtlpValidateHeapHeaders</a>( Heap, FALSE )) {
02063 
02064         <span class="keywordflow">goto</span> errorExit;
02065     }
02066 
02067     <span class="keywordflow">if</span> (!AlwaysValidate &amp;&amp; !(Heap-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a22">HEAP_VALIDATE_ALL_ENABLED</a>)) {
02068 
02069         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02070     }
02071 
02072     NumberOfFreeListEntries = 0;
02073     Head = &amp;Heap-&gt;FreeLists[ 0 ];
02074 
02075     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>++) {
02076 
02077         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> != 0) {
02078 
02079             EmptyFreeList = (BOOLEAN)(IsListEmpty( Head ));
02080             BadAddress = &amp;Heap-&gt;u.FreeListsInUseBytes[ <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / 8 ];
02081 
02082             <span class="keywordflow">if</span> (Heap-&gt;u.FreeListsInUseBytes[ <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> / 8 ] &amp; (1 &lt;&lt; (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &amp; 7)) ) {
02083 
02084                 <span class="keywordflow">if</span> (EmptyFreeList) {
02085 
02086                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list empty but marked as non-empty\n"</span>,
02087                                      Size ));
02088 
02089                     <span class="keywordflow">goto</span> errorExit;
02090                 }
02091 
02092             } <span class="keywordflow">else</span> {
02093 
02094                 <span class="keywordflow">if</span> (!EmptyFreeList) {
02095 
02096                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list non-empty but marked as empty\n"</span>,
02097                                      Size ));
02098 
02099                     <span class="keywordflow">goto</span> errorExit;
02100                 }
02101             }
02102         }
02103 
02104         Next = Head-&gt;Flink;
02105         PreviousSize = 0;
02106 
02107         <span class="keywordflow">while</span> (Head != Next) {
02108 
02109             FreeBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d1/d6/struct__HEAP__FREE__ENTRY.html">HEAP_FREE_ENTRY</a>, FreeList );
02110             Next = Next-&gt;Flink;
02111 
02112             BadAddress = FreeBlock;
02113 
02114             <span class="keywordflow">if</span> (FreeBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>) {
02115 
02116                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"dedicated (%04x) free list element %lx is marked busy\n"</span>,
02117                                  Size,
02118                                  FreeBlock ));
02119 
02120                 <span class="keywordflow">goto</span> errorExit;
02121             }
02122 
02123             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> != 0) &amp;&amp; (FreeBlock-&gt;Size != <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>)) {
02124 
02125                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Dedicated (%04x) free list element %lx is wrong size (%04x)\n"</span>,
02126                                  Size,
02127                                  FreeBlock,
02128                                  FreeBlock-&gt;Size ));
02129 
02130                 <span class="keywordflow">goto</span> errorExit;
02131 
02132             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) &amp;&amp; (FreeBlock-&gt;Size &lt; <a class="code" href="../../d3/d9/heap_8h.html#a6">HEAP_MAXIMUM_FREELISTS</a>)) {
02133 
02134                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Non-Dedicated free list element %lx with too small size (%04x)\n"</span>,
02135                                  FreeBlock,
02136                                  FreeBlock-&gt;Size ));
02137 
02138                 <span class="keywordflow">goto</span> errorExit;
02139 
02140             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == 0) &amp;&amp; (FreeBlock-&gt;Size &lt; PreviousSize)) {
02141 
02142                 <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Non-Dedicated free list element %lx is out of order\n"</span>,
02143                                  FreeBlock ));
02144 
02145                 <span class="keywordflow">goto</span> errorExit;
02146 
02147             } <span class="keywordflow">else</span> {
02148 
02149                 PreviousSize = FreeBlock-&gt;Size;
02150             }
02151 
02152             NumberOfFreeListEntries++;
02153         }
02154 
02155         Head++;
02156     }
02157 
02158     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a> + Heap-&gt;NextAvailableTagIndex + 1) * <span class="keyword">sizeof</span>( SIZE_T );
02159 
02160     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d9/heap_8h.html#a63">RtlpValidateHeapTagsEnable</a>) &amp;&amp; (Heap-&gt;PseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02161 
02162         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
02163                                           &amp;ComputedPseudoTagEntries,
02164                                           0,
02165                                           &amp;Size,
02166                                           MEM_COMMIT,
02167                                           PAGE_READWRITE );
02168 
02169         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02170 
02171             ComputedTagEntries = ComputedPseudoTagEntries + <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>;
02172         }
02173     }
02174 
02175     Head = &amp;Heap-&gt;VirtualAllocdBlocks;
02176     Next = Head-&gt;Flink;
02177 
02178     <span class="keywordflow">while</span> (Head != Next) {
02179 
02180         VirtualAllocBlock = CONTAINING_RECORD( Next, <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, Entry );
02181 
02182         <span class="keywordflow">if</span> (ComputedTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02183 
02184             TagIndex = VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o1">ExtraStuff</a>.<a class="code" href="../../d8/d5/struct__HEAP__ENTRY__EXTRA.html#o1">TagIndex</a>;
02185 
02186             <span class="keywordflow">if</span> (TagIndex != 0) {
02187 
02188                 <span class="keywordflow">if</span> (TagIndex &amp; HEAP_PSEUDO_TAG_FLAG) {
02189 
02190                     TagIndex &amp;= ~HEAP_PSEUDO_TAG_FLAG;
02191 
02192                     <span class="keywordflow">if</span> (TagIndex &lt; <a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>) {
02193 
02194                         ComputedPseudoTagEntries[ TagIndex ] +=
02195                             VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
02196                     }
02197 
02198                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &amp; HEAP_GLOBAL_TAG) {
02199 
02200                     <span class="comment">//</span>
02201                     <span class="comment">//  Ignore these since they are global across more than</span>
02202                     <span class="comment">//  one heap.</span>
02203                     <span class="comment">//</span>
02204 
02205                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TagIndex &lt; Heap-&gt;NextAvailableTagIndex) {
02206 
02207                     ComputedTagEntries[ TagIndex ] +=
02208                         VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o2">CommitSize</a> &gt;&gt; <a class="code" href="../../d3/d9/heap_8h.html#a4">HEAP_GRANULARITY_SHIFT</a>;
02209                 }
02210             }
02211         }
02212 
02213         <span class="keywordflow">if</span> (VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a>.<a class="code" href="../../d7/d5/struct__HEAP__ENTRY.html#o3">Flags</a> &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>) {
02214 
02215             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a>( &amp;VirtualAllocBlock-&gt;<a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html#o4">BusyBlock</a> )) {
02216 
02217                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02218             }
02219         }
02220 
02221         Next = Next-&gt;Flink;
02222     }
02223 
02224     CountOfFreeBlocks = 0;
02225     TotalFreeSize = 0;
02226 
02227     <span class="keywordflow">for</span> (SegmentIndex=0; SegmentIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>; SegmentIndex++) {
02228 
02229         Segment = Heap-&gt;Segments[ SegmentIndex ];
02230 
02231         <span class="keywordflow">if</span> (Segment) {
02232 
02233             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d9/heapdbg_8c.html#a27">RtlpValidateHeapSegment</a>( Heap,
02234                                           Segment,
02235                                           SegmentIndex,
02236                                           &amp;CountOfFreeBlocks,
02237                                           &amp;TotalFreeSize,
02238                                           &amp;BadAddress,
02239                                           ComputedTagEntries,
02240                                           ComputedPseudoTagEntries )) {
02241 
02242                 <span class="keywordflow">goto</span> errorExit;
02243             }
02244         }
02245     }
02246 
02247     BadAddress = Heap;
02248 
02249     <span class="keywordflow">if</span> (NumberOfFreeListEntries != CountOfFreeBlocks) {
02250 
02251         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Number of free blocks in arena (%ld) does not match number in the free lists (%ld)\n"</span>,
02252                          CountOfFreeBlocks,
02253                          NumberOfFreeListEntries ));
02254 
02255         <span class="keywordflow">goto</span> errorExit;
02256     }
02257 
02258     <span class="keywordflow">if</span> (Heap-&gt;TotalFreeSize != TotalFreeSize) {
02259 
02260         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Total size of free blocks in arena (%ld) does not match number total in heap header (%ld)\n"</span>,
02261                          TotalFreeSize,
02262                          Heap-&gt;TotalFreeSize ));
02263 
02264         <span class="keywordflow">goto</span> errorExit;
02265     }
02266 
02267     <span class="keywordflow">if</span> (ComputedPseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02268 
02269         <a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html">PHEAP_PSEUDO_TAG_ENTRY</a> PseudoTagEntries;
02270         <a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html">PHEAP_TAG_ENTRY</a> TagEntries;
02271         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TagIndex;
02272 
02273         PseudoTagEntries = Heap-&gt;PseudoTagEntries;
02274 
02275         <span class="keywordflow">if</span> (PseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02276 
02277             <span class="keywordflow">for</span> (TagIndex=1; TagIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a32">HEAP_NUMBER_OF_PSEUDO_TAG</a>; TagIndex++) {
02278 
02279                 PseudoTagEntries += 1;
02280 
02281                 <span class="keywordflow">if</span> (ComputedPseudoTagEntries[ TagIndex ] != PseudoTagEntries-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a>) {
02282 
02283                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Pseudo Tag %04x size incorrect (%x != %x) %x\n"</span>,
02284                                      TagIndex,
02285                                      PseudoTagEntries-&gt;<a class="code" href="../../d7/d6/struct__HEAP__PSEUDO__TAG__ENTRY.html#o2">Size</a>,
02286                                      ComputedPseudoTagEntries[ TagIndex ]
02287                                      &amp;ComputedPseudoTagEntries[ TagIndex ] ));
02288 
02289                     <span class="keywordflow">goto</span> errorExit;
02290                 }
02291             }
02292         }
02293 
02294         TagEntries = Heap-&gt;TagEntries;
02295 
02296         <span class="keywordflow">if</span> (TagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02297 
02298             <span class="keywordflow">for</span> (TagIndex=1; TagIndex&lt;Heap-&gt;NextAvailableTagIndex; TagIndex++) {
02299 
02300                 TagEntries += 1;
02301 
02302                 <span class="keywordflow">if</span> (ComputedTagEntries[ TagIndex ] != TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a>) {
02303 
02304                     <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Tag %04x (%ws) size incorrect (%x != %x) %x\n"</span>,
02305                                      TagIndex,
02306                                      TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o5">TagName</a>,
02307                                      TagEntries-&gt;<a class="code" href="../../d3/d7/struct__HEAP__TAG__ENTRY.html#o2">Size</a>,
02308                                      ComputedTagEntries[ TagIndex ],
02309                                      &amp;ComputedTagEntries[ TagIndex ] ));
02310 
02311                     <span class="keywordflow">goto</span> errorExit;
02312                 }
02313             }
02314         }
02315 
02316         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02317 
02318         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
02319                              &amp;ComputedPseudoTagEntries,
02320                              &amp;Size,
02321                              MEM_RELEASE );
02322     }
02323 
02324 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02325 
02326     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02327 
02328 errorExit:
02329 
02330     <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( BadAddress );
02331 
02332     <span class="keywordflow">if</span> (ComputedPseudoTagEntries != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02333 
02334         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02335 
02336         <a class="code" href="../../d3/d7/freevm_8c.html#a6">NtFreeVirtualMemory</a>( NtCurrentProcess(),
02337                              &amp;ComputedPseudoTagEntries,
02338                              &amp;Size,
02339                              MEM_RELEASE );
02340     }
02341 
02342     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02343 
02344 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="heappriv.h::RtlpValidateHeapEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpValidateHeapEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__HEAP__ENTRY.html">PHEAP_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BusyBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Reason</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01696">1696</a> of file <a class="el" href="../../d5/d8/heapdbg_8c-source.html">heapdbg.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00269">_HEAP_SEGMENT::FirstEntry</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00236">HEAP_ENTRY_BUSY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00238">HEAP_ENTRY_FILL_PATTERN</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00239">HEAP_ENTRY_VIRTUAL_ALLOC</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00224">HEAP_GRANULARITY</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00234">HEAP_MAXIMUM_SEGMENTS</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00134">HeapDebugBreak</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00270">_HEAP_SEGMENT::LastValidEntry</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l06117">RtlpCheckBusyBlockTail()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00919">RtlDebugGetUserInfoHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01086">RtlDebugSetUserFlagsHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01002">RtlDebugSetUserValueHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01177">RtlDebugSizeHeap()</a>, and <a class="el" href="../../d6/d8/heapdll_8c-source.html#l02530">RtlValidateHeap()</a>.
<p>
<pre class="fragment"><div>01704                    :
01705 
01706 Arguments:
01707 
01708 Return Value:
01709 
01710 --*/
01711 
01712 {
01713     <a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html">PHEAP_SEGMENT</a> Segment;
01714     UCHAR SegmentIndex;
01715     BOOLEAN Result;
01716 
01717     <span class="keywordflow">if</span> ((BusyBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01718 
01719             ||
01720 
01721         ((ULONG_PTR)BusyBlock &amp; (<a class="code" href="../../d3/d9/heap_8h.html#a3">HEAP_GRANULARITY</a>-1))
01722 
01723             ||
01724 
01725         ((BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) &amp;&amp;
01726          ((ULONG_PTR)BusyBlock &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)) != FIELD_OFFSET( <a class="code" href="../../d6/d7/struct__HEAP__VIRTUAL__ALLOC__ENTRY.html">HEAP_VIRTUAL_ALLOC_ENTRY</a>, BusyBlock ))
01727 
01728             ||
01729 
01730         (!(BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) &amp;&amp;
01731          ((BusyBlock-&gt;SegmentIndex &gt;= <a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>) ||
01732           !(Segment = Heap-&gt;Segments[ BusyBlock-&gt;SegmentIndex ]) ||
01733           (BusyBlock &lt; Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>) ||
01734           (BusyBlock &gt;= Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>)))
01735 
01736             ||
01737 
01738         !(BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a8">HEAP_ENTRY_BUSY</a>)
01739 
01740             ||
01741 
01742         ((BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a10">HEAP_ENTRY_FILL_PATTERN</a>) &amp;&amp; !<a class="code" href="../../d9/d9/heappriv_8h.html#a42">RtlpCheckBusyBlockTail</a>( BusyBlock ))) {
01743 
01744 InvalidBlock:
01745 
01746         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Invalid Address specified to %s( %lx, %lx )\n"</span>,
01747                          Reason,
01748                          Heap,
01749                          BusyBlock + 1 ));
01750 
01751         <a class="code" href="../../d9/d9/heappriv_8h.html#a11">HeapDebugBreak</a>( BusyBlock );
01752 
01753         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01754 
01755     } <span class="keywordflow">else</span> {
01756 
01757         <span class="keywordflow">if</span> (BusyBlock-&gt;Flags &amp; <a class="code" href="../../d3/d9/heap_8h.html#a11">HEAP_ENTRY_VIRTUAL_ALLOC</a>) {
01758 
01759             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01760 
01761         } <span class="keywordflow">else</span> {
01762 
01763             <span class="keywordflow">for</span> (SegmentIndex=0; SegmentIndex&lt;<a class="code" href="../../d3/d9/heap_8h.html#a7">HEAP_MAXIMUM_SEGMENTS</a>; SegmentIndex++) {
01764 
01765                 Segment = Heap-&gt;Segments[ SegmentIndex ];
01766 
01767                 <span class="keywordflow">if</span> (Segment) {
01768 
01769                     <span class="keywordflow">if</span> ((BusyBlock &gt;= Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o7">FirstEntry</a>) &amp;&amp;
01770                         (BusyBlock &lt; Segment-&gt;<a class="code" href="../../d8/d6/struct__HEAP__SEGMENT.html#o8">LastValidEntry</a>)) {
01771 
01772                         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01773                         <span class="keywordflow">break</span>;
01774                     }
01775                 }
01776             }
01777         }
01778 
01779         <span class="keywordflow">if</span> (!Result) {
01780 
01781             <span class="keywordflow">goto</span> InvalidBlock;
01782         }
01783 
01784         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01785     }
01786 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="heappriv.h::RtlpValidateHeapHeaders" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlpValidateHeapHeaders           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d5/struct__HEAP.html">PHEAP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Heap</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Recompute</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00112">112</a> of file <a class="el" href="../../d5/d8/heapdbg_8c-source.html">heapdbg.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00034">Description</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00121">HeapDebugPrint</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>, <a class="el" href="../../d4/d8/heap_8h-source.html#l00460">RtlpValidateHeapHdrsEnable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00444">RtlDebugAllocateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01260">RtlDebugCompactHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00204">RtlDebugCreateHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l01421">RtlDebugCreateTagHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00797">RtlDebugFreeHeap()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00603">RtlDebugReAllocateHeap()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l04693">RtlpGrowBlockInPlace()</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00323">RtlpSerializeHeap()</a>, and <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l02025">RtlpValidateHeap()</a>.
<p>
<pre class="fragment"><div>00119                    :
00120 
00121 Arguments:
00122 
00123 Return Value:
00124 
00125 --*/
00126 
00127 {
00128     ULONG i;
00129     SIZE_T <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00130     SIZE_T nEqual;
00131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00132 
00133     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d9/heap_8h.html#a62">RtlpValidateHeapHdrsEnable</a>) {
00134 
00135         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00136     }
00137 
00138     <span class="keywordflow">if</span> (Heap-&gt;HeaderValidateCopy == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00139 
00140         <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Heap-&gt;HeaderValidateLength;
00141 
00142         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d6/allocvm_8c.html#a7">NtAllocateVirtualMemory</a>( NtCurrentProcess(),
00143                                           &amp;Heap-&gt;HeaderValidateCopy,
00144                                           0,
00145                                           &amp;n,
00146                                           MEM_COMMIT,
00147                                           PAGE_READWRITE );
00148 
00149         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00150 
00151             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00152         }
00153 
00154         Recompute = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00155     }
00156 
00157     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = Heap-&gt;HeaderValidateLength;
00158 
00159     <span class="keywordflow">if</span> (!Recompute) {
00160 
00161         nEqual = RtlCompareMemory( Heap,
00162                                    Heap-&gt;HeaderValidateCopy,
00163                                    n );
00164 
00165     } <span class="keywordflow">else</span> {
00166 
00167         RtlMoveMemory( Heap-&gt;HeaderValidateCopy,
00168                        Heap,
00169                        n );
00170 
00171         nEqual = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>;
00172     }
00173 
00174     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> != nEqual) {
00175 
00176         <a class="code" href="../../d9/d9/heappriv_8h.html#a10">HeapDebugPrint</a>(( <span class="stringliteral">"Heap %x - headers modified (%x is %x instead of %x)\n"</span>,
00177                          Heap,
00178                          (PCHAR)Heap + nEqual,
00179                          *(PULONG)((PCHAR)Heap + nEqual),
00180                          *(PULONG)((PCHAR)Heap-&gt;HeaderValidateCopy + nEqual)));
00181 
00182         <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i ].Description != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; i++) {
00183 
00184             <span class="keywordflow">if</span> ((nEqual &gt;= <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i ].Offset) &amp;&amp;
00185                 (nEqual &lt; <a class="code" href="../../d4/d9/heapdbg_8c.html#a5">RtlpHeapHeaderFieldOffsets</a>[ i+1 ].Offset)) {
00186 
00187                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"    This is located in the %s field of the heap header.\n"</span>,
00188                                  RtlpHeapHeaderFieldOffsets[ i ].Description );
00189 
00190                 <span class="keywordflow">break</span>;
00191             }
00192         }
00193 
00194         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00195 
00196     } <span class="keywordflow">else</span> {
00197 
00198         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00199     }
00200 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a23" doxytag="heappriv.h::CheckHeapFillPattern" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UCHAR <a class="el" href="../../d9/d9/heappriv_8h.html#a23">CheckHeapFillPattern</a>[CHECK_HEAP_TAIL_SIZE]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/heappriv_8h-source.html#l00046">46</a> of file <a class="el" href="../../d0/d9/heappriv_8h-source.html">heappriv.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:04 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
