<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rmlogon.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rmlogon.c File Reference</h1><code>#include "<a class="el" href="../../d2/d9/rmp_8h-source.html">rmp.h</a>"</code><br>
<code>#include &lt;bugcodes.h&gt;</code><br>

<p>
<a href="../../d0/d9/rmlogon_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>(PLogonId)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a2">SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a4">SepGetLogonSessionTrack</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a5">SepInformLsaOfDeletedLogon</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a6">SepInformFileSystemsOfDeletedLogon</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a7">SepNotifyFileSystems</a> (IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a8">SepRmCreateLogonSessionWrkr</a> (IN PRM_COMMAND_MESSAGE CommandMessage, OUT PRM_REPLY_MESSAGE ReplyMessage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a9">SepRmDeleteLogonSessionWrkr</a> (IN PRM_COMMAND_MESSAGE CommandMessage, OUT PRM_REPLY_MESSAGE ReplyMessage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a10">SepReferenceLogonSession</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a11">SepDeReferenceLogonSession</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a12">SepCreateLogonSessionTrack</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a13">SepDeleteLogonSessionTrack</a> (IN PLUID LogonId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a14">SeRegisterLogonSessionTerminatedRoutine</a> (IN <a class="el" href="../../d0/d5/se_8h.html#a35">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a> CallbackRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a15">SeUnregisterLogonSessionTerminatedRoutine</a> (IN <a class="el" href="../../d0/d5/se_8h.html#a35">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a> CallbackRoutine)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a16">SeMarkLogonSessionForTerminationNotification</a> (IN PLUID LogonId)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">SEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a> = {0}</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="rmlogon.c::SepLogonSessionIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SepLogonSessionIndex          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PLogonId&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                    \
     (PLogonId)-&gt;LowPart &amp; <a class="code" href="../../d1/d0/rmp_8h.html#a0">SEP_LOGON_TRACK_INDEX_MASK</a>                         \
     )
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">109</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00979">SeMarkLogonSessionForTerminationNotification()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00541">SepCreateLogonSessionTrack()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00655">SepDeleteLogonSessionTrack()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>, and <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">SepReferenceLogonSession()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a3" doxytag="rmlogon.c::PSEP_FILE_SYSTEM_NOTIFY_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> * <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01049">SepInformFileSystemsOfDeletedLogon()</a>, and <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01107">SepNotifyFileSystems()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="rmlogon.c::SEP_FILE_SYSTEM_NOTIFY_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>  <a class="el" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a16" doxytag="rmlogon.c::SeMarkLogonSessionForTerminationNotification" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeMarkLogonSessionForTerminationNotification           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00979">979</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d2/d9/rmp_8h-source.html#l00131">_SEP_LOGON_SESSION_REFERENCES::Flags</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00129">_SEP_LOGON_SESSION_REFERENCES::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00128">_SEP_LOGON_SESSION_REFERENCES::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00134">SEP_TERMINATION_NOTIFY</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">SepLogonSessionIndex</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00229">SepLogonSessions</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
<pre class="fragment"><div>00985                    :
00986 
00987     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> systems that have registered <span class="keywordflow">for</span> logon-termination notification
00988     can mark logon sessions they are interested in <span class="keywordflow">for</span> callback by calling
00989     <span class="keyword">this</span> routine.
00990 
00991 Arguments:
00992 
00993     LogonId - The logon <span class="keywordtype">id</span> <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system should be notified
00994         when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> terminated.
00995 
00996 Returns:
00997 
00998     Nothing.
00999 
01000 --*/
01001 
01002 {
01003 
01004     ULONG SessionArrayIndex;
01005     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
01006 
01007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01008 
01009     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
01010 
01011     <span class="comment">//</span>
01012     <span class="comment">// Protect modification of reference monitor database</span>
01013     <span class="comment">//</span>
01014 
01015     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
01016 
01017 
01018     <span class="comment">//</span>
01019     <span class="comment">// Now walk the list for our logon session array hash index.</span>
01020     <span class="comment">//</span>
01021 
01022     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
01023                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
01024     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
01025 
01026     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01027 
01028         <span class="comment">//</span>
01029         <span class="comment">// If we found it, decrement the reference count and return</span>
01030         <span class="comment">//</span>
01031 
01032         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
01033             Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o3">Flags</a> |= <a class="code" href="../../d1/d0/rmp_8h.html#a8">SEP_TERMINATION_NOTIFY</a>;
01034             <span class="keywordflow">break</span>;
01035         }
01036 
01037         Previous = Current;
01038         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
01039     }
01040 
01041     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
01042 
01043     <span class="keywordflow">return</span>( (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ? STATUS_SUCCESS : STATUS_NOT_FOUND );
01044 
01045 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="rmlogon.c::SepCreateLogonSessionTrack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepCreateLogonSessionTrack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00541">541</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00129">_SEP_LOGON_SESSION_REFERENCES::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00128">_SEP_LOGON_SESSION_REFERENCES::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00130">_SEP_LOGON_SESSION_REFERENCES::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d1/d0/rmp_8h.html#a14">SEP_LOGON_SESSION_REFERENCES</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">SepLogonSessionIndex</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00229">SepLogonSessions</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00122">SepRmCreateLogonSessionWrkr()</a>, and <a class="el" href="../../d3/d9/rmvars_8c-source.html#l00095">SepRmDbInitialization()</a>.
<p>
<pre class="fragment"><div>00547                    :
00548 
00549     This routine creates a <span class="keyword">new</span> logon session tracking record.
00550 
00551     This should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called as a dispatch routine <span class="keywordflow">for</span> a LSA-&gt;RM
00552     call (and once during system initialization).
00553 
00554     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified logon session already exists, then an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00555 
00556 
00557 
00558 Arguments:
00559 
00560     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span> which a <span class="keyword">new</span> logon track <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00561         to be created.
00562 
00563 Return Value:
00564 
00565     STATUS_SUCCESS - The logon session track was created successfully.
00566 
00567     STATUS_LOGON_SESSION_EXISTS - The logon session already exists.
00568         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <span class="keyword">new</span> one has not been created.
00569 
00570 --*/
00571 
00572 {
00573 
00574     ULONG SessionArrayIndex;
00575     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00576     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> LogonSessionTrack;
00577 
00578     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">// Make sure we can allocate a new logon session track record</span>
00582     <span class="comment">//</span>
00583 
00584     LogonSessionTrack = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00585                         <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00586                             PagedPool,
00587                             <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">SEP_LOGON_SESSION_REFERENCES</a>),
00588                             'sLeS'
00589                             );
00590 
00591     <span class="keywordflow">if</span> (LogonSessionTrack == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00592         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00593     }
00594 
00595     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a> = (*LogonId);
00596     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> = 0;
00597 
00598 
00599 
00600     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00601 
00602     <span class="comment">//</span>
00603     <span class="comment">// Protect modification of reference monitor database</span>
00604     <span class="comment">//</span>
00605 
00606     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00607 
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// Now walk the list for our logon session array hash index</span>
00611     <span class="comment">// looking for a duplicate logon session ID.</span>
00612     <span class="comment">//</span>
00613 
00614     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00615                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00616     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00617 
00618     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00619 
00620         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00621 
00622             <span class="comment">//</span>
00623             <span class="comment">// One already exists. Hmmm.</span>
00624             <span class="comment">//</span>
00625 
00626             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00627             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LogonSessionTrack);
00628             <span class="keywordflow">return</span> STATUS_LOGON_SESSION_EXISTS;
00629 
00630         }
00631 
00632         Previous = Current;
00633         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00634     }
00635 
00636 
00637     <span class="comment">//</span>
00638     <span class="comment">// Reached the end of the list without finding a duplicate.</span>
00639     <span class="comment">// Add the new one.</span>
00640     <span class="comment">//</span>
00641 
00642     LogonSessionTrack-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ];
00643     <a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ] = LogonSessionTrack;
00644 
00645 
00646 
00647 
00648     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00649     <span class="keywordflow">return</span> STATUS_SUCCESS;
00650 
00651 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="rmlogon.c::SepDeleteLogonSessionTrack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepDeleteLogonSessionTrack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00655">655</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00129">_SEP_LOGON_SESSION_REFERENCES::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00128">_SEP_LOGON_SESSION_REFERENCES::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00130">_SEP_LOGON_SESSION_REFERENCES::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">SepLogonSessionIndex</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00229">SepLogonSessions</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00200">SepRmDeleteLogonSessionWrkr()</a>.
<p>
<pre class="fragment"><div>00661                    :
00662 
00663     This routine creates a <span class="keyword">new</span> logon session tracking record.
00664 
00665     This should <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called as a dispatch routine <span class="keywordflow">for</span> a LSA-&gt;RM
00666     call (and once during system initialization).
00667 
00668     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified logon session already exists, then an error <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00669 
00670 
00671 
00672 Arguments:
00673 
00674     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> whose logon track <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00675         to be deleted.
00676 
00677 Return Value:
00678 
00679     STATUS_SUCCESS - The logon session track was deleted successfully.
00680 
00681     STATUS_BAD_LOGON_SESSION_STATE - The logon session has a non-zero
00682         reference count and can not be deleted.
00683 
00684     STATUS_NO_SUCH_LOGON_SESSION - The specified logon session does not
00685         exist.
00686 
00687 
00688 --*/
00689 
00690 {
00691 
00692     ULONG SessionArrayIndex;
00693     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00694 
00695     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00696 
00697     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">// Protect modification of reference monitor database</span>
00701     <span class="comment">//</span>
00702 
00703     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00704 
00705 
00706     <span class="comment">//</span>
00707     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00708     <span class="comment">//</span>
00709 
00710     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00711                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00712     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00713 
00714     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">// If we found it, make sure reference count is zero</span>
00718         <span class="comment">//</span>
00719 
00720         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00721 
00722             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> == 0) {
00723 
00724                 <span class="comment">//</span>
00725                 <span class="comment">// Pull it from the list</span>
00726                 <span class="comment">//</span>
00727 
00728                 Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00729 
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// No longer need to protect our pointer to this</span>
00733                 <span class="comment">// record.</span>
00734                 <span class="comment">//</span>
00735 
00736                 <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00737 
00738 
00739                 <span class="comment">//</span>
00740                 <span class="comment">// Deallocate the logon session track record.</span>
00741                 <span class="comment">//</span>
00742 
00743                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)Current );
00744 
00745 
00746                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00747 
00748             }
00749 
00750             <span class="comment">//</span>
00751             <span class="comment">// reference count was not zero.  This is not considered</span>
00752             <span class="comment">// a healthy situation.  Return an error and let someone</span>
00753             <span class="comment">// else declare the bug check.</span>
00754             <span class="comment">//</span>
00755 
00756             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00757             <span class="keywordflow">return</span> STATUS_BAD_LOGON_SESSION_STATE;
00758         }
00759 
00760         Previous = Current;
00761         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00762     }
00763 
00764     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Someone asked us to delete a logon session that isn't</span>
00768     <span class="comment">// in the database.</span>
00769     <span class="comment">//</span>
00770 
00771     <span class="keywordflow">return</span> STATUS_NO_SUCH_LOGON_SESSION;
00772 
00773 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="rmlogon.c::SepDeReferenceLogonSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepDeReferenceLogonSession           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">384</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00131">_SEP_LOGON_SESSION_REFERENCES::Flags</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00070">KeBugCheck()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00129">_SEP_LOGON_SESSION_REFERENCES::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00128">_SEP_LOGON_SESSION_REFERENCES::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00130">_SEP_LOGON_SESSION_REFERENCES::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00134">SEP_TERMINATION_NOTIFY</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01049">SepInformFileSystemsOfDeletedLogon()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00777">SepInformLsaOfDeletedLogon()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">SepLogonSessionIndex</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00229">SepLogonSessions</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>, and <a class="el" href="../../d5/d2/token_8c-source.html#l02156">SepTokenDeleteMethod()</a>.
<p>
<pre class="fragment"><div>00390                    :
00391 
00392     This routine decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count of a logon session
00393     tracking record.
00394 
00395     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> decremented to zero, then there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no
00396     possibility <span class="keywordflow">for</span> any more tokens to exist <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session.
00397     In <span class="keyword">this</span> <span class="keywordflow">case</span>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> notified that a logon session has
00398     terminated.
00399 
00400 
00401 
00402 Arguments:
00403 
00404     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> whose logon track <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00405         to be decremented.
00406 
00407 Return Value:
00408 
00409     None.
00410 
00411 --*/
00412 
00413 {
00414 
00415     ULONG SessionArrayIndex;
00416     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00417 
00418 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00419 <span class="preprocessor"></span>    ULONG Refs;
00420 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00421 <span class="preprocessor"></span>
00422     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00423 
00424     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// Protect modification of reference monitor database</span>
00428     <span class="comment">//</span>
00429 
00430     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00431 
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00435     <span class="comment">//</span>
00436 
00437     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00438                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00439     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00440 
00441     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// If we found it, decrement the reference count and return</span>
00445         <span class="comment">//</span>
00446 
00447         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00448             Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> -= 1;
00449             <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> == 0) {
00450 
00451                 <span class="comment">//</span>
00452                 <span class="comment">// Pull it from the list</span>
00453                 <span class="comment">//</span>
00454 
00455                 Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a> = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00456 
00457 
00458                 <span class="comment">//</span>
00459                 <span class="comment">// No longer need to protect our pointer to this</span>
00460                 <span class="comment">// record.</span>
00461                 <span class="comment">//</span>
00462 
00463                 <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00464 
00465                 <span class="comment">//</span>
00466                 <span class="comment">// Asynchronoously inform file systems that this logon session</span>
00467                 <span class="comment">// is going away, if atleast one FS expressed interest in this</span>
00468                 <span class="comment">// logon session.</span>
00469                 <span class="comment">//</span>
00470 
00471                 <span class="keywordflow">if</span> (Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o3">Flags</a> &amp; <a class="code" href="../../d1/d0/rmp_8h.html#a8">SEP_TERMINATION_NOTIFY</a>) {
00472                     <a class="code" href="../../d9/d9/rmlogon_8c.html#a6">SepInformFileSystemsOfDeletedLogon</a>( LogonId );
00473                 }
00474 
00475                 <span class="comment">//</span>
00476                 <span class="comment">// Deallocate the logon session track record.</span>
00477                 <span class="comment">//</span>
00478 
00479                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( (PVOID)Current );
00480 
00481 
00482 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00483 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): -- ** logon session: (%d, %d) to ZERO by (%d, %d)\n"</span>,
00484                       LogonId-&gt;HighPart, LogonId-&gt;LowPart,
00485                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00486                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00487 
00488 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00489 <span class="preprocessor"></span>
00490                 <span class="comment">//</span>
00491                 <span class="comment">// Inform the LSA about the deletion of this logon session.</span>
00492                 <span class="comment">//</span>
00493 
00494                 <a class="code" href="../../d9/d9/rmlogon_8c.html#a5">SepInformLsaOfDeletedLogon</a>( LogonId );
00495 
00496 
00497 
00498                 <span class="keywordflow">return</span>;
00499 
00500             }
00501 
00502             <span class="comment">//</span>
00503             <span class="comment">// reference count was incremented, but not to zero.</span>
00504             <span class="comment">//</span>
00505 
00506 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00507 <span class="preprocessor"></span>            Refs = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a>;
00508 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00509 <span class="preprocessor"></span>
00510             <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00511 
00512 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00513 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): -- logon session: (%d, %d) to %d by (%d, %d)\n"</span>,
00514                       LogonId-&gt;HighPart, LogonId-&gt;LowPart, Refs,
00515                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00516                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00517 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00518 <span class="preprocessor"></span>
00519             <span class="keywordflow">return</span>;
00520         }
00521 
00522         Previous = Current;
00523         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00524     }
00525 
00526     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">// Bad news, someone asked us to decrement the reference count of</span>
00530     <span class="comment">// a logon session we didn't know existed.</span>
00531     <span class="comment">//</span>
00532 
00533     <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>( DEREF_UNKNOWN_LOGON_SESSION );
00534 
00535     <span class="keywordflow">return</span>;
00536 
00537 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="rmlogon.c::SepGetLogonSessionTrack" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepGetLogonSessionTrack           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="rmlogon.c::SepInformFileSystemsOfDeletedLogon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepInformFileSystemsOfDeletedLogon           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01049">1049</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00049">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT::LogonId</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01950">PWORKER_THREAD_ROUTINE</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01107">SepNotifyFileSystems()</a>, and <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00048">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT::WorkItem</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>.
<p>
<pre class="fragment"><div>01055                    :
01056 
01057     This routine informs interested <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> systems of a deleted logon.
01058 
01059     Note that we can not be guaranteed that we are in a whole (or wholesome)
01060     thread, since we may be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of process deletion and object
01061     rundown.  Therefore, we must queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work off to a worker thread.
01062 
01063 
01064 Arguments:
01065 
01066     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> which has been deleted.
01067 
01068 Return Value:
01069 
01070     None.
01071 
01072 --*/
01073 
01074 {
01075     <a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> FSNotifyContext;
01076 
01077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01078 
01079     FSNotifyContext = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01080                             NonPagedPool,
01081                             <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">SEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>),
01082                             'SFeS');
01083 
01084     <span class="keywordflow">if</span> (FSNotifyContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085 
01086         <span class="comment">//</span>
01087         <span class="comment">// I don't know what to do here... file systems will loose track of a</span>
01088         <span class="comment">// logon session, but the system isn't really harmed in any way.</span>
01089         <span class="comment">//</span>
01090 
01091         <span class="keywordflow">return</span>;
01092 
01093     }
01094 
01095     FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">LogonId</a> = *LogonId;
01096 
01097     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o0">WorkItem</a>,
01098                           (<a class="code" href="../../d5/d8/ex_8h.html#a111">PWORKER_THREAD_ROUTINE</a>) SepNotifyFileSystems,
01099                           (PVOID) FSNotifyContext);
01100 
01101     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o0">WorkItem</a>, DelayedWorkQueue );
01102 
01103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="rmlogon.c::SepInformLsaOfDeletedLogon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepInformLsaOfDeletedLogon           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00777">777</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d5/sep_8h-source.html#l00364">_SEP_LSA_WORK_ITEM::CleanupFunction</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00365">_SEP_LSA_WORK_ITEM::CleanupParameter</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00354">_SEP_LSA_WORK_ITEM::CommandNumber</a>, <a class="el" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">_SEP_LSA_WORK_ITEM::CommandParams</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00355">_SEP_LSA_WORK_ITEM::CommandParamsLength</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00330">_SEP_LSA_WORK_ITEM::CommandParamsMemoryType</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d6/sep_8h.html#a28">PSEP_LSA_WORK_ITEM</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00356">_SEP_LSA_WORK_ITEM::ReplyBuffer</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00357">_SEP_LSA_WORK_ITEM::ReplyBufferLength</a>, <a class="el" href="../../d6/d6/sep_8h.html#a27">SEP_LSA_WORK_ITEM</a>, <a class="el" href="../../d6/d6/sep_8h.html#a77a33">SepDeleteLogon</a>, <a class="el" href="../../d1/d4/adtlog_8c-source.html#l00600">SepQueueWorkItem()</a>, <a class="el" href="../../d7/d5/sep_8h-source.html#l00336">_SEP_LSA_WORK_ITEM::Tag</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00384">SepDeReferenceLogonSession()</a>.
<p>
<pre class="fragment"><div>00783                    :
00784 
00785     This routine informs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deletion of a logon session.
00786 
00787     Note that we can not be guaranteed that we are in a whole (or wholesome)
00788     thread, since we may be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> middle of process deletion and object
00789     rundown.  Therefore, we must queue <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work off to a worker thread which
00790     can then make an LPC call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA.
00791 
00792 
00793 
00794 
00795 Arguments:
00796 
00797     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> which has been deleted.
00798 
00799 Return Value:
00800 
00801     None.
00802 
00803 --*/
00804 
00805 {
00806     <a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">PSEP_LSA_WORK_ITEM</a> DeleteLogonItem;
00807 
00808     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00809 
00810     <span class="comment">//</span>
00811     <span class="comment">// Pass the LUID value along with the work queue item.</span>
00812     <span class="comment">// Note that the worker thread is responsible for freeing the WorkItem data</span>
00813     <span class="comment">// structure.</span>
00814     <span class="comment">//</span>
00815 
00816     DeleteLogonItem = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html">SEP_LSA_WORK_ITEM</a>), 'wLeS' );
00817     <span class="keywordflow">if</span> (DeleteLogonItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">// I don't know what to do here... we loose track of a logon session,</span>
00821         <span class="comment">// but the system isn't really harmed in any way.</span>
00822         <span class="comment">//</span>
00823 
00824         <span class="keywordflow">return</span>;
00825 
00826     }
00827 
00828     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o5">CommandParams</a>.LogonId   = (*LogonId);
00829     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o6">CommandNumber</a>           = LsapLogonSessionDeletedCommand;
00830     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o7">CommandParamsLength</a>     = <span class="keyword">sizeof</span>( LUID );
00831     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o8">ReplyBuffer</a>             = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00832     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o9">ReplyBufferLength</a>       = 0;
00833     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o10">CleanupFunction</a>         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00834     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o11">CleanupParameter</a>        = 0;
00835     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o2">Tag</a>                     = <a class="code" href="../../d6/d6/sep_8h.html#a77a33">SepDeleteLogon</a>;
00836     DeleteLogonItem-&gt;<a class="code" href="../../d8/d1/struct__SEP__LSA__WORK__ITEM.html#o1">CommandParamsMemoryType</a> = SepRmImmediateMemory;
00837 
00838     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d6/sep_8h.html#a68">SepQueueWorkItem</a>( DeleteLogonItem, TRUE )) {
00839 
00840         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DeleteLogonItem );
00841     }
00842 
00843     <span class="keywordflow">return</span>;
00844 
00845 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="rmlogon.c::SepNotifyFileSystems" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepNotifyFileSystems           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Context</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01107">1107</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d2/d9/rmp_8h-source.html#l00147">_SEP_LOGON_SESSION_TERMINATED_NOTIFICATION::CallbackRoutine</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00049">_SEP_FILE_SYSTEM_NOTIFY_CONTEXT::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00146">_SEP_LOGON_SESSION_TERMINATED_NOTIFICATION::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d9/rmlogon_8c.html#a3">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00038">SeFileSystemNotifyRoutinesHead</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00057">SepRmAcquireDbReadLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00063">SepRmReleaseDbReadLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01049">SepInformFileSystemsOfDeletedLogon()</a>.
<p>
<pre class="fragment"><div>01110 {
01111     <a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a> FSNotifyContext =
01112         (<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html">PSEP_FILE_SYSTEM_NOTIFY_CONTEXT</a>) Context;
01113 
01114     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NextCallback;
01115 
01116     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Protect modification of the list of FS callbacks.</span>
01120     <span class="comment">//</span>
01121 
01122     <a class="code" href="../../d1/d0/rmp_8h.html#a2">SepRmAcquireDbReadLock</a>();
01123 
01124     NextCallback = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
01125 
01126     <span class="keywordflow">while</span> (NextCallback != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01127 
01128         NextCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o1">CallbackRoutine</a>( &amp;FSNotifyContext-&gt;<a class="code" href="../../d5/d1/struct__SEP__FILE__SYSTEM__NOTIFY__CONTEXT.html#o1">LogonId</a> );
01129 
01130         NextCallback = NextCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
01131     }
01132 
01133     <a class="code" href="../../d1/d0/rmp_8h.html#a4">SepRmReleaseDbReadLock</a>();
01134 
01135     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( FSNotifyContext );
01136 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="rmlogon.c::SepReferenceLogonSession" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SepReferenceLogonSession           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLUID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LogonId</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00278">278</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00129">_SEP_LOGON_SESSION_REFERENCES::LogonId</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00128">_SEP_LOGON_SESSION_REFERENCES::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d0/rmp_8h.html#a15">PSEP_LOGON_SESSION_REFERENCES</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00130">_SEP_LOGON_SESSION_REFERENCES::ReferenceCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00109">SepLogonSessionIndex</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00229">SepLogonSessions</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/token_8c-source.html#l02213">SepCreateToken()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l00362">SepDuplicateToken()</a>, and <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01939">SepFilterToken()</a>.
<p>
<pre class="fragment"><div>00284                    :
00285 
00286     This routine increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count of a logon session
00287     tracking record.
00288 
00289 
00290 
00291 Arguments:
00292 
00293     LogonId - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logon session <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> whose logon track <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00294         to be incremented.
00295 
00296 Return Value:
00297 
00298     STATUS_SUCCESS - The reference count was successfully incremented.
00299 
00300     STATUS_NO_SUCH_LOGON_SESSION - The specified logon session doesn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a>
00301         exist in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference monitor's database.
00302 
00303 --*/
00304 
00305 {
00306 
00307     ULONG SessionArrayIndex;
00308     <a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a> Previous, Current;
00309 
00310 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00311 <span class="preprocessor"></span>    ULONG Refs;
00312 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00313 <span class="preprocessor"></span>
00314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00315 
00316     SessionArrayIndex = <a class="code" href="../../d9/d9/rmlogon_8c.html#a0">SepLogonSessionIndex</a>( LogonId );
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Protect modification of reference monitor database</span>
00320     <span class="comment">//</span>
00321 
00322     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00323 
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Now walk the list for our logon session array hash index.</span>
00327     <span class="comment">//</span>
00328 
00329     Previous = (<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html">PSEP_LOGON_SESSION_REFERENCES</a>)
00330                ((PVOID)&amp;<a class="code" href="../../d1/d0/rmp_8h.html#a22">SepLogonSessions</a>[ SessionArrayIndex ]);
00331     Current = Previous-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00332 
00333     <span class="keywordflow">while</span> (Current != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// If we found it, increment the reference count and return</span>
00337         <span class="comment">//</span>
00338 
00339         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>( LogonId, &amp;Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o1">LogonId</a>) ) {
00340 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00341 <span class="preprocessor"></span>             ULONG Refs;
00342 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00343 <span class="preprocessor"></span>
00344              Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a> += 1;
00345 
00346 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00347 <span class="preprocessor"></span>             Refs = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o2">ReferenceCount</a>;
00348 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00349 <span class="preprocessor"></span>
00350              <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00351 
00352 <span class="preprocessor">#ifdef SEP_TRACK_LOGON_SESSION_REFS</span>
00353 <span class="preprocessor"></span>             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"SE (rm): ++ logon session: (%d, %d) to %d by (%d, %d)\n"</span>,
00354                       LogonId-&gt;HighPart, LogonId-&gt;LowPart, Refs,
00355                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueProcess,
00356                       <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Cid.UniqueThread);
00357 
00358 <span class="preprocessor">#endif //SEP_TRACK_LOGON_SESSION_REFS</span>
00359 <span class="preprocessor"></span>             <span class="keywordflow">return</span> STATUS_SUCCESS;
00360         }
00361 
00362         Previous = Current;
00363         Current = Current-&gt;<a class="code" href="../../d6/d1/struct__SEP__LOGON__SESSION__REFERENCES.html#o0">Next</a>;
00364     }
00365 
00366     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Bad news, someone asked us to increment the reference count of</span>
00370     <span class="comment">// a logon session we didn't know existed.  This might be a new</span>
00371     <span class="comment">// token being created, so return an error status and let the caller</span>
00372     <span class="comment">// decide if it warrants a bug check or not.</span>
00373     <span class="comment">//</span>
00374 
00375 
00376     <span class="keywordflow">return</span> STATUS_NO_SUCH_LOGON_SESSION;
00377 
00378 
00379 
00380 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="rmlogon.c::SepRmCreateLogonSessionWrkr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepRmCreateLogonSessionWrkr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRM_COMMAND_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>CommandMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRM_REPLY_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyMessage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00122">122</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03425">ReplyMessage()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00541">SepCreateLogonSessionTrack()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00129                    :
00130 
00131     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatch routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA --&gt; RM
00132     <span class="stringliteral">"CreateLogonSession"</span> call.
00133 
00134     The arguments passed to <span class="keyword">this</span> routine are defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00135     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d1/d0/rmp_8h.html#a13">SEP_RM_COMMAND_WORKER</a>.
00136 
00137 
00138 Arguments:
00139 
00140     CommandMessage - Points to structure containing RM command message
00141         information consisting of an LPC PORT_MESSAGE structure followed
00142         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> command number (RmComponentTestCommand) and a command-specific
00143         body.  The command-specific body of this parameter is a LUID of the
00144         logon session to be created.
00145 
00146     ReplyMessage - Pointer to structure containing LSA reply message
00147         information consisting of an LPC PORT_MESSAGE structure followed
00148         by the command ReturnedStatus field in which a status code from the
00149         command will be returned.
00150 
00151 Return Value:
00152 
00153     VOID
00154 
00155 --*/
00156 
00157 {
00158 
00159     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00160     LUID LogonId;
00161 
00162     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00163 
00164     <span class="comment">//</span>
00165     <span class="comment">// Check that command is expected type</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CommandMessage-&gt;CommandNumber == RmCreateLogonSession );
00169 
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Typecast the command parameter to what we expect.</span>
00173     <span class="comment">//</span>
00174 
00175     LogonId = *((LUID UNALIGNED *) CommandMessage-&gt;CommandParams);
00176 
00177 
00178 
00179     <span class="comment">//</span>
00180     <span class="comment">// Try to create the logon session tracking record</span>
00181     <span class="comment">//</span>
00182 
00183     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a31">SepCreateLogonSessionTrack</a>( &amp;LogonId );
00184 
00185 
00186 
00187     <span class="comment">//</span>
00188     <span class="comment">// Set the reply status</span>
00189     <span class="comment">//</span>
00190 
00191     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>-&gt;ReturnedStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00192 
00193 
00194     <span class="keywordflow">return</span>;
00195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="rmlogon.c::SepRmDeleteLogonSessionWrkr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SepRmDeleteLogonSessionWrkr           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PRM_COMMAND_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>CommandMessage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PRM_REPLY_MESSAGE&nbsp;</td>
          <td class="mdname" nowrap> <em>ReplyMessage</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00200">200</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03425">ReplyMessage()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00655">SepDeleteLogonSessionTrack()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00207                    :
00208 
00209     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatch routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LSA --&gt; RM
00210     <span class="stringliteral">"DeleteLogonSession"</span> call.
00211 
00212     The arguments passed to <span class="keyword">this</span> routine are defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00213     <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d1/d0/rmp_8h.html#a13">SEP_RM_COMMAND_WORKER</a>.
00214 
00215 
00216 Arguments:
00217 
00218     CommandMessage - Points to structure containing RM command message
00219         information consisting of an LPC PORT_MESSAGE structure followed
00220         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> command number (RmComponentTestCommand) and a command-specific
00221         body.  The command-specific body of this parameter is a LUID of the
00222         logon session to be created.
00223 
00224     ReplyMessage - Pointer to structure containing LSA reply message
00225         information consisting of an LPC PORT_MESSAGE structure followed
00226         by the command ReturnedStatus field in which a status code from the
00227         command will be returned.
00228 
00229 Return Value:
00230 
00231     VOID
00232 
00233 --*/
00234 
00235 {
00236 
00237     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00238     LUID LogonId;
00239 
00240     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00241 
00242     <span class="comment">//</span>
00243     <span class="comment">// Check that command is expected type</span>
00244     <span class="comment">//</span>
00245 
00246     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( CommandMessage-&gt;CommandNumber == RmDeleteLogonSession );
00247 
00248 
00249     <span class="comment">//</span>
00250     <span class="comment">// Typecast the command parameter to what we expect.</span>
00251     <span class="comment">//</span>
00252 
00253     LogonId = *((LUID UNALIGNED *) CommandMessage-&gt;CommandParams);
00254 
00255 
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Try to create the logon session tracking record</span>
00259     <span class="comment">//</span>
00260 
00261     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d0/rmp_8h.html#a32">SepDeleteLogonSessionTrack</a>( &amp;LogonId );
00262 
00263 
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// Set the reply status</span>
00267     <span class="comment">//</span>
00268 
00269     <a class="code" href="../../d3/d8/client_8c.html#a125">ReplyMessage</a>-&gt;ReturnedStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00270 
00271 
00272     <span class="keywordflow">return</span>;
00273 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="rmlogon.c::SeRegisterLogonSessionTerminatedRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeRegisterLogonSessionTerminatedRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/se_8h.html#a35">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CallbackRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00849">849</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d2/d9/rmp_8h-source.html#l00147">_SEP_LOGON_SESSION_TERMINATED_NOTIFICATION::CallbackRoutine</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00146">_SEP_LOGON_SESSION_TERMINATED_NOTIFICATION::Next</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00434">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a>, <a class="el" href="../../d1/d0/rmp_8h.html#a17">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00038">SeFileSystemNotifyRoutinesHead</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, and <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>.
<p>
<pre class="fragment"><div>00855                    :
00856 
00857     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> systems that are interested in being
00858     notified when a logon session <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
00859 
00860 Arguments:
00861 
00862     CallbackRoutine - Address of routine to call back when a logon session
00863         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being deleted.
00864 
00865 Return Value:
00866 
00867     STATUS_SUCCESS - Successfully registered routine
00868 
00869     STATUS_INVALID_PARAMETER - CallbackRoutine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00870 
00871     STATUS_INSUFFICIENT_RESOURCE - Unable to allocate list entry.
00872 
00873 --*/
00874 
00875 {
00876     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NewCallback;
00877 
00878     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00879 
00880     <span class="keywordflow">if</span> (CallbackRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00881         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00882     }
00883 
00884     NewCallback = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00885                         PagedPool,
00886                         <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">SEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a>),
00887                         'SFeS');
00888 
00889     <span class="keywordflow">if</span> (NewCallback == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00890         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00891     }
00892 
00893     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00894 
00895     NewCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00896 
00897     NewCallback-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o1">CallbackRoutine</a> = CallbackRoutine;
00898 
00899     <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = NewCallback;
00900 
00901     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00902 
00903     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00904 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="rmlogon.c::SeUnregisterLogonSessionTerminatedRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS SeUnregisterLogonSessionTerminatedRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d5/se_8h.html#a35">PSE_LOGON_SESSION_TERMINATED_ROUTINE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CallbackRoutine</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00908">908</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00146">_SEP_LOGON_SESSION_TERMINATED_NOTIFICATION::Next</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00038">SeFileSystemNotifyRoutinesHead</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00060">SepRmAcquireDbWriteLock</a>, <a class="el" href="../../d2/d9/rmp_8h-source.html#l00066">SepRmReleaseDbWriteLock</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00914                    :
00915 
00916     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dual of <a class="code" href="../../d0/d5/se_8h.html#a193">SeRegisterLogonSessionTerminatedRoutine</a>. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> System
00917     *MUST* call <span class="keyword">this</span> before <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unloaded.
00918 
00919 Arguments:
00920 
00921     CallbackRoutine - Address of routine that was originally passed in to
00922         <a class="code" href="../../d0/d5/se_8h.html#a193">SeRegisterLogonSessionTerminatedRoutine</a>.
00923 
00924 Return Value:
00925 
00926     STATUS_SUCCESS - Successfully removed callback routine
00927 
00928     STATUS_INVALID_PARAMETER - CallbackRoutine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00929 
00930     STATUS_NOT_FOUND - Didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> find and entry <span class="keywordflow">for</span> CallbackRoutine
00931 
00932 --*/
00933 {
00934     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00935     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> PreviousEntry;
00936     <a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">PSEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> NotifyEntry;
00937 
00938     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00939 
00940     <span class="keywordflow">if</span> (CallbackRoutine == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00942     }
00943 
00944     <a class="code" href="../../d1/d0/rmp_8h.html#a3">SepRmAcquireDbWriteLock</a>();
00945 
00946     <span class="keywordflow">for</span> (PreviousEntry = &amp;<a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>,
00947             NotifyEntry = <a class="code" href="../../d9/d9/rmlogon_8c.html#a1">SeFileSystemNotifyRoutinesHead</a>.<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00948                 NotifyEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00949                     PreviousEntry = NotifyEntry,
00950                         NotifyEntry = NotifyEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>) {
00951 
00952          <span class="keywordflow">if</span> (NotifyEntry-&gt;CallbackRoutine == CallbackRoutine)
00953              <span class="keywordflow">break</span>;
00954 
00955     }
00956 
00957     <span class="keywordflow">if</span> (NotifyEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00958 
00959         PreviousEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a> = NotifyEntry-&gt;<a class="code" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html#o0">Next</a>;
00960 
00961         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NotifyEntry );
00962 
00963         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00964 
00965     } <span class="keywordflow">else</span> {
00966 
00967         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
00968 
00969     }
00970 
00971     <a class="code" href="../../d1/d0/rmp_8h.html#a5">SepRmReleaseDbWriteLock</a>();
00972 
00973     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00974 
00975 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="rmlogon.c::SeFileSystemNotifyRoutinesHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d1/struct__SEP__LOGON__SESSION__TERMINATED__NOTIFICATION.html">SEP_LOGON_SESSION_TERMINATED_NOTIFICATION</a> <a class="el" href="../../d1/d0/rmp_8h.html#a18">SeFileSystemNotifyRoutinesHead</a> = {0}          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00038">38</a> of file <a class="el" href="../../d0/d9/rmlogon_8c-source.html">rmlogon.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l01107">SepNotifyFileSystems()</a>, <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00849">SeRegisterLogonSessionTerminatedRoutine()</a>, and <a class="el" href="../../d0/d9/rmlogon_8c-source.html#l00908">SeUnregisterLogonSessionTerminatedRoutine()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
