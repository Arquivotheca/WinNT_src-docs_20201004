<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtbatcr.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtbatcr.c</h1><a href="../../d8/d0/rtbatcr_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rtbatcr.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    NT level registry api test program, basic non-error paths.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Do a batch create.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    rtbatcr    &lt;KeyPath&gt; &lt;KeyName&gt; &lt;basename&gt; &lt;#children&gt; &lt;#values&gt;</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Will attempt to create key &lt;KeyName&gt; as child of &lt;KeyPath&gt;  If</span>
00018 <span class="comment">    &lt;#children&gt; and &lt;#values&gt; are 0, this is all it does.  If &lt;KeyName&gt;</span>
00019 <span class="comment">    already exists, it will simply be used.</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Will create &lt;#children&gt; child cells, with names of the form</span>
00022 <span class="comment">    &lt;base&gt;0  &lt;base&gt;1, etc.  Will create &lt;#values&gt; value entries,</span>
00023 <span class="comment">    with similar names, for each created child key.  Data of</span>
00024 <span class="comment">    values will be a constant string including their name.</span>
00025 <span class="comment"></span>
00026 <span class="comment">    Example:</span>
00027 <span class="comment"></span>
00028 <span class="comment">        rtbatcr    \REGISTRY\MACHINE\TEST bigkey runa_ 100 100</span>
00029 <span class="comment">        rtbatcr    \REGISTRY\MACHINE\TEST\bigkey runa_1 runb_ 100 100</span>
00030 <span class="comment"></span>
00031 <span class="comment">        Will create bigkey, give it 100 values calls runa_1 through</span>
00032 <span class="comment">        runa_100, create 100 subkeys called runa_1 through runa_100</span>
00033 <span class="comment">        for each of those children.</span>
00034 <span class="comment"></span>
00035 <span class="comment">        It will then open bigkey\runa_1, and create 100 subkeys and</span>
00036 <span class="comment">        100 values each for that.</span>
00037 <span class="comment"></span>
00038 <span class="comment">Author:</span>
00039 <span class="comment"></span>
00040 <span class="comment">    Bryan Willman (bryanwi)  10-Dec-91</span>
00041 <span class="comment"></span>
00042 <span class="comment">Revision History:</span>
00043 <span class="comment"></span>
00044 <span class="comment">--*/</span>
00045 
00046 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00047 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00048 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00049 <span class="preprocessor">#include &lt;string.h&gt;</span>
00050 
<a name="l00051"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">00051</a> <span class="preprocessor">#define WORK_SIZE   1024</span>
00052 <span class="preprocessor"></span>
00053 <span class="keywordtype">void</span> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(<span class="keywordtype">int</span>, <span class="keywordtype">char</span> *);
00054 <span class="keywordtype">void</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>();
00055 
<a name="l00056"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">00056</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> = 0;
00057 
<a name="l00058"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">00058</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>;
<a name="l00059"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">00059</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
<a name="l00060"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">00060</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a>;
<a name="l00061"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">00061</a> ULONG           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a>;
<a name="l00062"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">00062</a> UCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
<a name="l00063"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">00063</a> UCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
<a name="l00064"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">00064</a> STRING          <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>;
<a name="l00065"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a9">00065</a> BOOLEAN         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a9">CreateVolatile</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00066 
<a name="l00067"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">00067</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>;
<a name="l00068"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">00068</a> WCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
00069 
00070 <span class="keywordtype">void</span>
<a name="l00071"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a14">00071</a> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(
00072     <span class="keywordtype">int</span> argc,
00073     <span class="keywordtype">char</span> *argv[]
00074     )
00075 {
00076     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00077     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00078     HANDLE          BaseHandle;
00079     HANDLE          WorkHandle;
00080     ULONG           Disposition;
00081     UNICODE_STRING  ClassName;
00082     ULONG           i;
00083     ULONG           j;
00084     PUCHAR  p;
00085     ULONG           CreateOption;
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">// Process args</span>
00089     <span class="comment">//</span>
00090 
00091     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(argc, argv);
00092 
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">// Set up and create/open KeyPath|KeyName</span>
00096     <span class="comment">//</span>
00097 
00098     printf(<span class="stringliteral">"rtbatcr: starting\n"</span>);
00099 
00100     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>;
00101     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00102     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = &amp;(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[0]);
00103 
00104     <a class="code" href="../../d2/d7/string_8c.html#a8">RtlCopyString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>);
00105 
00106     p = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer;
00107     p += <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length;
00108     *p = <span class="charliteral">'\\'</span>;
00109     p++;
00110     *p = <span class="charliteral">'\0'</span>;
00111     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length += 2;
00112 
00113     <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, (PSTRING)&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
00114 
00115     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00116         &amp;ClassName,
00117         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Test Class Name"</span>
00118         );
00119 
00120     InitializeObjectAttributes(
00121         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00122         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00123         0,
00124         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00125         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00126         );
00127     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00128 
00129     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/rtbatcr_8c.html#a9">CreateVolatile</a>) {
00130         CreateOption = REG_OPTION_VOLATILE;
00131     } <span class="keywordflow">else</span> {
00132         CreateOption = 0;
00133     }
00134 
00135     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00136                 &amp;BaseHandle,
00137                 MAXIMUM_ALLOWED,
00138                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00139                 0,
00140                 &amp;ClassName,
00141                 CreateOption,
00142                 &amp;Disposition
00143                 );
00144     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00145         printf(<span class="stringliteral">"rtbatcr: t0: %08lx\n"</span>, status);
00146         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00147         <span class="keywordflow">goto</span> punt;
00148     }
00149 
00150 
00151     <span class="comment">//</span>
00152     <span class="comment">// Create NumberChildren subkeys</span>
00153     <span class="comment">//</span>
00154 
00155     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a>; i++) {
00156 
00157         <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"%s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, i);
00158         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>);
00159         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00160 
00161 
00162         InitializeObjectAttributes(
00163             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00164             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00165             0,
00166             BaseHandle,
00167             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00168             );
00169         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00170 
00171         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00172                     &amp;WorkHandle,
00173                     MAXIMUM_ALLOWED,
00174                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00175                     0,
00176                     &amp;ClassName,
00177                     CreateOption,
00178                     &amp;Disposition
00179                     );
00180         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00181             printf(<span class="stringliteral">"rtbatcr: t1: status = %08lx i = %d\n"</span>, status, i);
00182             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00183         }
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Create NumberValues value entries for each (current) key</span>
00187         <span class="comment">//</span>
00188 
00189         <span class="keywordflow">for</span> (j = 0; j &lt; <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a>; j++) {
00190 
00191             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"%s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, j);
00192             <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>);
00193             <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>, &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00194 
00195             <a class="code" href="../../d6/d9/heappage_8c.html#a68">sprintf</a>(
00196                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>, <span class="stringliteral">"This is a rtbatcr value for %s%d"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, j
00197                 );
00198 
00199             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00200                         WorkHandle,
00201                         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00202                         j,
00203                         j,
00204                         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>,
00205                         <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a7">formatbuffer</a>)+1
00206                         );
00207             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00208                 printf(<span class="stringliteral">"rtbatcr: t2: status = %08lx j = %d\n"</span>, status, j);
00209                 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>++;
00210             }
00211         }
00212         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(WorkHandle);
00213     }
00214 
00215 punt:
00216     printf(<span class="stringliteral">"rtbatcr: %d failures\n"</span>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>);
00217     <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>);
00218 }
00219 
00220 
00221 <span class="keywordtype">void</span>
<a name="l00222"></a><a class="code" href="../../d8/d0/rtbatcr_8c.html#a15">00222</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(
00223     <span class="keywordtype">int</span> argc,
00224     <span class="keywordtype">char</span> *argv[]
00225     )
00226 {
00227     ANSI_STRING temp;
00228 
00229     <span class="keywordflow">if</span> ( (argc &lt; 3) || (argc &gt; 7) )
00230     {
00231         printf(<span class="stringliteral">"Usage: %s [volatile] &lt;KeyPath&gt; &lt;KeyName&gt; [&lt;basename&gt; &lt;#children&gt; &lt;#values&gt;]\n"</span>,
00232                 argv[0]);
00233         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00234     }
00235 
00236     <span class="keywordflow">if</span> (_stricmp(argv[1],<span class="stringliteral">"volatile"</span>)==0) {
00237         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a9">CreateVolatile</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00238         ++argv;
00239     }
00240 
00241     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00242         &amp;temp,
00243         argv[1]
00244         );
00245 
00246     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00247         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00248         &amp;temp,
00249         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00250         );
00251 
00252     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00253         &amp;temp,
00254         argv[2]
00255         );
00256 
00257     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00258         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00259         &amp;temp,
00260         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00261         );
00262 
00263     <span class="keywordflow">if</span> (argc &lt; 6) {
00264 
00265         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a> = 0;
00266         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a> = 0;
00267 
00268     } <span class="keywordflow">else</span> {
00269 
00270         strcpy(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a6">BaseName</a>, argv[3]);
00271         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a4">NumberChildren</a> = atoi(argv[4]);
00272         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a5">NumberValues</a> = atoi(argv[5]);
00273 
00274     }
00275     <span class="keywordflow">return</span>;
00276 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
