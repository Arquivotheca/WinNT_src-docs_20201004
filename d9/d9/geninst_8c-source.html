<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: geninst.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>geninst.c</h1><a href="../../d8/d0/geninst_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1998  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    geninst.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This modules contains routines to implement GenInstall of an inf section.</span>
00013 <span class="comment">    This is based on the code from the setupapi. Currently, it only supports</span>
00014 <span class="comment">    a subset of GenInstall functionality i.e AddReg and DelReg and BitReg.</span>
00015 <span class="comment"></span>
00016 <span class="comment">Author:</span>
00017 <span class="comment"></span>
00018 <span class="comment">    Santosh Jodh (santoshj) 08-Aug-1998</span>
00019 <span class="comment"></span>
00020 <span class="comment"></span>
00021 <span class="comment">Environment:</span>
00022 <span class="comment"></span>
00023 <span class="comment">    Kernel mode.</span>
00024 <span class="comment"></span>
00025 <span class="comment">Revision History:</span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00031 <span class="preprocessor">#include "stdlib.h"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/parseini_8h.html">parseini.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="../../d9/d0/geninst_8h.html">geninst.h</a>"</span>
00034 
00035 <span class="keyword">typedef</span>
00036 BOOLEAN
<a name="l00037"></a><a class="code" href="../../d8/d0/geninst_8c.html#a18">00037</a> (* PFN_INFRULE)(
00038     IN PVOID InfHandle,
00039     IN PCHAR Section,
00040     IN PVOID <a class="code" href="../../d8/d0/geninst_8c.html#a22">RefData</a>
00041     );
00042 
00043 <span class="keyword">typedef</span>
00044 BOOLEAN
<a name="l00045"></a><a class="code" href="../../d8/d0/geninst_8c.html#a19">00045</a> (* PFN_REGLINE)(
00046     IN PVOID InfHandle,
00047     IN PCHAR Section,
00048     IN ULONG LineIndex
00049     );
00050 
00051 BOOLEAN
00052 <a class="code" href="../../d8/d0/geninst_8c.html#a24">CmpProcessReg</a>(
00053     IN PVOID InfHandle,
00054     IN PCHAR Section,
00055     IN PVOID RefData
00056     );
00057 
00058 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00059 <a class="code" href="../../d8/d0/geninst_8c.html#a25">CmpProcessAddRegLine</a>(
00060     IN PVOID InfHandle,
00061     IN PCHAR Section,
00062     IN ULONG LineIndex
00063     );
00064 
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00066 <a class="code" href="../../d8/d0/geninst_8c.html#a26">CmpProcessDelRegLine</a>(
00067     IN PVOID InfHandle,
00068     IN PCHAR Section,
00069     IN ULONG LineIndex
00070     );
00071 
00072 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00073 <a class="code" href="../../d8/d0/geninst_8c.html#a27">CmpProcessBitRegLine</a>(
00074     IN PVOID InfHandle,
00075     IN PCHAR Section,
00076     IN ULONG LineIndex
00077     );
00078 
00079 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00080 <a class="code" href="../../d8/d0/geninst_8c.html#a28">CmpGetAddRegInfData</a>(
00081     IN PVOID InfHandle,
00082     IN PCHAR Section,
00083     IN ULONG LineIndex,
00084     IN ULONG ValueIndex,
00085     IN ULONG ValueType,
00086     OUT PVOID *Data,
00087     OUT PULONG DataSize
00088     );
00089 
00090 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00091 <a class="code" href="../../d8/d0/geninst_8c.html#a29">CmpOpenRegKey</a>(
00092     IN OUT PHANDLE Key,
00093     IN OUT PULONG Disposition,
00094     IN PCHAR Root,
00095     IN PCHAR SubKey,
00096     IN ULONG DesiredAccess,
00097     IN BOOLEAN Create
00098     );
00099 
00100 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00101 <a class="code" href="../../d8/d0/geninst_8c.html#a30">CmpAppendStringToMultiSz</a>(
00102     IN HANDLE Key,
00103     IN PCHAR ValueName,
00104     IN OUT PVOID *Data,
00105     IN OUT PULONG DataSize
00106     );
00107 
00108 <span class="comment">//</span>
00109 <span class="comment">// Copied from setupapi.h</span>
00110 <span class="comment">//</span>
00111 <span class="comment">// Flags for AddReg section lines in INF.  The corresponding value</span>
00112 <span class="comment">// is &lt;ValueType&gt; in the AddReg line format given below:</span>
00113 <span class="comment">//</span>
00114 <span class="comment">// &lt;RegRootString&gt;,&lt;SubKey&gt;,&lt;ValueName&gt;,&lt;ValueType&gt;,&lt;Value&gt;...</span>
00115 <span class="comment">//</span>
00116 <span class="comment">// The low word contains basic flags concerning the general data type</span>
00117 <span class="comment">// and AddReg action. The high word contains values that more specifically</span>
00118 <span class="comment">// identify the data type of the registry value.  The high word is ignored</span>
00119 <span class="comment">// by the 16-bit Windows 95 SETUPX APIs.</span>
00120 <span class="comment">//</span>
00121 
<a name="l00122"></a><a class="code" href="../../d8/d0/geninst_8c.html#a0">00122</a> <span class="preprocessor">#define FLG_ADDREG_BINVALUETYPE     ( 0x00000001 )</span>
<a name="l00123"></a><a class="code" href="../../d8/d0/geninst_8c.html#a1">00123</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_NOCLOBBER        ( 0x00000002 )</span>
<a name="l00124"></a><a class="code" href="../../d8/d0/geninst_8c.html#a2">00124</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_DELVAL           ( 0x00000004 )</span>
<a name="l00125"></a><a class="code" href="../../d8/d0/geninst_8c.html#a3">00125</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_APPEND           ( 0x00000008 ) // Currently supported only</span>
00126 <span class="preprocessor"></span>                                                   <span class="comment">// for REG_MULTI_SZ values.</span>
<a name="l00127"></a><a class="code" href="../../d8/d0/geninst_8c.html#a4">00127</a> <span class="preprocessor">#define FLG_ADDREG_KEYONLY          ( 0x00000010 ) // Just create the key, ignore value</span>
<a name="l00128"></a><a class="code" href="../../d8/d0/geninst_8c.html#a5">00128</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_OVERWRITEONLY    ( 0x00000020 ) // Set only if value already exists</span>
00129 <span class="preprocessor"></span>
<a name="l00130"></a><a class="code" href="../../d8/d0/geninst_8c.html#a6">00130</a> <span class="preprocessor">#define FLG_ADDREG_TYPE_MASK        ( 0xFFFF0000 | FLG_ADDREG_BINVALUETYPE )</span>
<a name="l00131"></a><a class="code" href="../../d8/d0/geninst_8c.html#a7">00131</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_SZ          ( 0x00000000                           )</span>
<a name="l00132"></a><a class="code" href="../../d8/d0/geninst_8c.html#a8">00132</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_MULTI_SZ    ( 0x00010000                           )</span>
<a name="l00133"></a><a class="code" href="../../d8/d0/geninst_8c.html#a9">00133</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_EXPAND_SZ   ( 0x00020000                           )</span>
<a name="l00134"></a><a class="code" href="../../d8/d0/geninst_8c.html#a10">00134</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_BINARY      ( 0x00000000 | FLG_ADDREG_BINVALUETYPE )</span>
<a name="l00135"></a><a class="code" href="../../d8/d0/geninst_8c.html#a11">00135</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_DWORD       ( 0x00010000 | FLG_ADDREG_BINVALUETYPE )</span>
<a name="l00136"></a><a class="code" href="../../d8/d0/geninst_8c.html#a12">00136</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_ADDREG_TYPE_NONE        ( 0x00020000 | FLG_ADDREG_BINVALUETYPE )</span>
00137 <span class="preprocessor"></span>
<a name="l00138"></a><a class="code" href="../../d8/d0/geninst_8c.html#a13">00138</a> <span class="preprocessor">#define FLG_BITREG_CLEAR            ( 0x00000000 )</span>
<a name="l00139"></a><a class="code" href="../../d8/d0/geninst_8c.html#a14">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_BITREG_SET              ( 0x00000001 )</span>
<a name="l00140"></a><a class="code" href="../../d8/d0/geninst_8c.html#a15">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_BITREG_TYPE_BINARY      ( 0x00000000 )</span>
<a name="l00141"></a><a class="code" href="../../d8/d0/geninst_8c.html#a16">00141</a> <span class="preprocessor"></span><span class="preprocessor">#define FLG_BITREG_TYPE_DWORD       ( 0x00000002 )</span>
00142 <span class="preprocessor"></span>
00143 <span class="comment">//</span>
00144 <span class="comment">// We currently only support AddReg and DelReg sections.</span>
00145 <span class="comment">//</span>
00146 
<a name="l00147"></a><a class="code" href="../../d8/d0/geninst_8c.html#a17">00147</a> <span class="preprocessor">#define NUM_OF_INF_RULES    3</span>
00148 <span class="preprocessor"></span>
00149 <span class="comment">//</span>
00150 <span class="comment">// GenInstall methods we support.</span>
00151 <span class="comment">//</span>
00152 
00153 <span class="keyword">struct </span>{
<a name="l00154"></a><a class="code" href="../../d8/d0/geninst_8c.html#a20">00154</a>     PCHAR       <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
<a name="l00155"></a><a class="code" href="../../d8/d0/geninst_8c.html#a21">00155</a>     <a class="code" href="../../d8/d0/geninst_8c.html#a18">PFN_INFRULE</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a>;
<a name="l00156"></a><a class="code" href="../../d8/d0/geninst_8c.html#a22">00156</a>     PVOID       <a class="code" href="../../d8/d0/geninst_8c.html#a22">RefData</a>;
00157 } <a class="code" href="../../d8/d0/geninst_8c.html#a23">gInfRuleTable</a>[<a class="code" href="../../d8/d0/geninst_8c.html#a17">NUM_OF_INF_RULES</a>] =
00158 {
00159     {<span class="stringliteral">"AddReg"</span>, <a class="code" href="../../d8/d0/geninst_8c.html#a24">CmpProcessReg</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a25">CmpProcessAddRegLine</a>},
00160     {<span class="stringliteral">"DelReg"</span>, <a class="code" href="../../d8/d0/geninst_8c.html#a24">CmpProcessReg</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a26">CmpProcessDelRegLine</a>},
00161     {<span class="stringliteral">"BitReg"</span>, <a class="code" href="../../d8/d0/geninst_8c.html#a24">CmpProcessReg</a>, <a class="code" href="../../d8/d0/geninst_8c.html#a27">CmpProcessBitRegLine</a>}
00162 };
00163 
00164 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00165 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpAppendStringToMultiSz)</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpOpenRegKey)</span>
00167 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGetAddRegInfData)</span>
00168 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpProcessReg)</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpProcessAddRegLine)</span>
00170 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpProcessDelRegLine)</span>
00171 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpProcessBitRegLine)</span>
00172 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpGenInstall)</span>
00173 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00174 <span class="preprocessor"></span>
00175 BOOLEAN
<a name="l00176"></a><a class="code" href="../../d9/d0/geninst_8h.html#a0">00176</a> <a class="code" href="../../d9/d0/geninst_8h.html#a0">CmpGenInstall</a>(
00177     IN PVOID InfHandle,
00178     IN PCHAR Section
00179     )
00180 
00181 <span class="comment">/*++</span>
00182 <span class="comment"></span>
00183 <span class="comment">    Routine Description:</span>
00184 <span class="comment"></span>
00185 <span class="comment">        This routine does a GenInstall of the section in the inf.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    Input Parameters:</span>
00188 <span class="comment"></span>
00189 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00190 <span class="comment"></span>
00191 <span class="comment">        Section - Name of the section to be read.</span>
00192 <span class="comment"></span>
00193 <span class="comment">    Return Value:</span>
00194 <span class="comment"></span>
00195 <span class="comment">        TRUE iff the entire section was processed successfully.</span>
00196 <span class="comment"></span>
00197 <span class="comment">--*/</span>
00198 
00199 {
00200     ULONG   ruleNumber;
00201     ULONG   i;
00202     PCHAR   ruleName;
00203     PCHAR   regSection;
00204     BOOLEAN result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00205 
00206     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/parseini_8h.html#a3">CmpSearchInfSection</a>(InfHandle, Section))
00207     {
00208         <span class="comment">//</span>
00209         <span class="comment">// Go through all the rules in the section and try to process</span>
00210         <span class="comment">// each of them.</span>
00211         <span class="comment">//</span>
00212 
00213         <span class="keywordflow">for</span> (   ruleNumber = 0;
00214                 ruleName = <a class="code" href="../../d6/d3/parseini_8h.html#a2">CmpGetKeyName</a>(InfHandle, Section, ruleNumber);
00215                 ruleNumber++)
00216         {
00217 
00218             <span class="comment">//</span>
00219             <span class="comment">// Search for the proceesing function in our table.</span>
00220             <span class="comment">//</span>
00221 
00222             <span class="keywordflow">for</span> (   i = 0;
00223                     i &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a17">NUM_OF_INF_RULES</a> &amp;&amp;
00224                         _stricmp(ruleName, <a class="code" href="../../d8/d0/geninst_8c.html#a23">gInfRuleTable</a>[i].<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
00225                     i++);
00226 
00227             <span class="keywordflow">if</span> (    i &gt;= <a class="code" href="../../d8/d0/geninst_8c.html#a17">NUM_OF_INF_RULES</a> ||
00228                     (regSection = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
00229                                                             Section,
00230                                                             ruleNumber,
00231                                                             0)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00232                     !<a class="code" href="../../d6/d3/parseini_8h.html#a3">CmpSearchInfSection</a>(InfHandle, Section))
00233             {
00234                 result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00235                 <span class="keywordflow">break</span>;
00236             }
00237 
00238             <span class="keywordflow">if</span> (!(*<a class="code" href="../../d8/d0/geninst_8c.html#a23">gInfRuleTable</a>[i].Action)(InfHandle, regSection, <a class="code" href="../../d8/d0/geninst_8c.html#a23">gInfRuleTable</a>[i].RefData))
00239             {
00240                 result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00241             }
00242         }
00243 
00244         <span class="comment">//</span>
00245         <span class="comment">// All inf rules processed.</span>
00246         <span class="comment">//</span>
00247 
00248         <span class="keywordflow">if</span> (ruleNumber)
00249         {
00250             result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00251         }
00252     }
00253 
00254     <span class="keywordflow">return</span> (result);
00255 }
00256 
00257 BOOLEAN
<a name="l00258"></a><a class="code" href="../../d8/d0/geninst_8c.html#a24">00258</a> <a class="code" href="../../d8/d0/geninst_8c.html#a24">CmpProcessReg</a>(
00259     IN PVOID InfHandle,
00260     IN PCHAR Section,
00261     IN PVOID RefData
00262     )
00263 
00264 <span class="comment">/*++</span>
00265 <span class="comment"></span>
00266 <span class="comment">    Routine Description:</span>
00267 <span class="comment"></span>
00268 <span class="comment">        This routine processes a AddReg section in the inf.</span>
00269 <span class="comment"></span>
00270 <span class="comment">    Input Parameters:</span>
00271 <span class="comment"></span>
00272 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00273 <span class="comment"></span>
00274 <span class="comment">        Section - Name of the section to be read.</span>
00275 <span class="comment"></span>
00276 <span class="comment">    Return Value:</span>
00277 <span class="comment"></span>
00278 <span class="comment">        TRUE iff the entire section was processed successfully.</span>
00279 <span class="comment"></span>
00280 <span class="comment">--*/</span>
00281 
00282 {
00283     ULONG       lineIndex;
00284     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status = STATUS_SUCCESS;
00285     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    temp;
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// Process all the lines in the xxxReg Section.</span>
00289     <span class="comment">//</span>
00290 
00291     <span class="keywordflow">for</span> (   lineIndex = 0;
00292             <a class="code" href="../../d6/d3/parseini_8h.html#a4">CmpSearchInfLine</a>(InfHandle, Section, lineIndex);
00293             lineIndex++)
00294     {
00295         temp = (*(<a class="code" href="../../d8/d0/geninst_8c.html#a19">PFN_REGLINE</a>)<a class="code" href="../../d8/d0/geninst_8c.html#a22">RefData</a>)(InfHandle, Section, lineIndex);
00296         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(temp))
00297         {
00298             status = temp;
00299         }
00300     }
00301 
00302     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00303     {
00304         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00305     }
00306 
00307     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00308 }
00309 
00310 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00311"></a><a class="code" href="../../d8/d0/geninst_8c.html#a25">00311</a> <a class="code" href="../../d8/d0/geninst_8c.html#a25">CmpProcessAddRegLine</a>(
00312     IN PVOID InfHandle,
00313     IN PCHAR Section,
00314     IN ULONG LineIndex
00315     )
00316 
00317 <span class="comment">/*++</span>
00318 <span class="comment"></span>
00319 <span class="comment">    Routine Description:</span>
00320 <span class="comment"></span>
00321 <span class="comment">        This routine processes a AddReg line in the inf.</span>
00322 <span class="comment"></span>
00323 <span class="comment">    Input Parameters:</span>
00324 <span class="comment"></span>
00325 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00326 <span class="comment"></span>
00327 <span class="comment">        Section - Name of the section to be read.</span>
00328 <span class="comment"></span>
00329 <span class="comment">        LineIndex - Index of the line to be read.</span>
00330 <span class="comment"></span>
00331 <span class="comment">    Return Value:</span>
00332 <span class="comment"></span>
00333 <span class="comment">        Standard NT status value.</span>
00334 <span class="comment"></span>
00335 <span class="comment">--*/</span>
00336 
00337 {
00338     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_UNSUCCESSFUL;
00339     PCHAR               rootKeyName;
00340     PCHAR               subKeyName;
00341     PCHAR               valueName;
00342     ULONG               flags;
00343     ULONG               valueType;
00344     PCHAR               buffer;
00345     HANDLE              key;
00346     ULONG               disposition;
00347     BOOLEAN             dontSet;
00348     PVOID               data = 0;
00349     ULONG               dataSize = 0;
00350     ANSI_STRING         ansiString;
00351     UNICODE_STRING      unicodeString;
00352     OBJECT_ATTRIBUTES   objectAttributes;
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// Get the root-key name.</span>
00356     <span class="comment">//</span>
00357 
00358     rootKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
00359                                             Section,
00360                                             LineIndex,
00361                                             0);
00362     <span class="keywordflow">if</span> (rootKeyName)
00363     {
00364         <span class="comment">//</span>
00365         <span class="comment">// Get the optional sub-key name.</span>
00366         <span class="comment">//</span>
00367 
00368         subKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(    InfHandle,
00369                                                 Section,
00370                                                 LineIndex,
00371                                                 1);
00372 
00373         <span class="comment">//</span>
00374         <span class="comment">// Value name is optional. Can be NULL or "".</span>
00375         <span class="comment">//</span>
00376 
00377         valueName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>( InfHandle,
00378                                             Section,
00379                                             LineIndex,
00380                                             2);
00381         <span class="comment">//</span>
00382         <span class="comment">// If we don't have a value name, the type is REG_SZ to force</span>
00383         <span class="comment">// the right behavior in RegSetValueEx. Otherwise get the data type.</span>
00384         <span class="comment">//</span>
00385 
00386         valueType = REG_SZ;
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Read in the flags.</span>
00390         <span class="comment">//</span>
00391 
00392         <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(    InfHandle,
00393                                 Section,
00394                                 LineIndex,
00395                                 3,
00396                                 &amp;flags))
00397         {
00398             flags = 0;
00399         }
00400 
00401         <span class="comment">//</span>
00402         <span class="comment">// Convert the flags to the registry type.</span>
00403         <span class="comment">//</span>
00404 
00405         <span class="keywordflow">switch</span>(flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a6">FLG_ADDREG_TYPE_MASK</a>)
00406         {
00407 
00408             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a7">FLG_ADDREG_TYPE_SZ</a>:
00409 
00410                 valueType = REG_SZ;
00411                 <span class="keywordflow">break</span>;
00412 
00413             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a8">FLG_ADDREG_TYPE_MULTI_SZ</a>:
00414 
00415                 valueType = REG_MULTI_SZ;
00416                 <span class="keywordflow">break</span>;
00417 
00418             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a9">FLG_ADDREG_TYPE_EXPAND_SZ</a>:
00419 
00420                 valueType = REG_EXPAND_SZ;
00421                 <span class="keywordflow">break</span>;
00422 
00423             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a10">FLG_ADDREG_TYPE_BINARY</a>:
00424 
00425                 valueType = REG_BINARY;
00426                 <span class="keywordflow">break</span>;
00427 
00428             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a11">FLG_ADDREG_TYPE_DWORD</a>:
00429 
00430                 valueType = REG_DWORD;
00431                 <span class="keywordflow">break</span>;
00432 
00433             <span class="keywordflow">case</span> <a class="code" href="../../d8/d0/geninst_8c.html#a12">FLG_ADDREG_TYPE_NONE</a>:
00434 
00435                 valueType = REG_NONE;
00436                 <span class="keywordflow">break</span>;
00437 
00438             <span class="keywordflow">default</span> :
00439 
00440                 <span class="comment">//</span>
00441                 <span class="comment">// If the FLG_ADDREG_BINVALUETYPE is set, then the highword</span>
00442                 <span class="comment">// can contain just about any random reg data type ordinal value.</span>
00443                 <span class="comment">//</span>
00444 
00445                 <span class="keywordflow">if</span>(flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a0">FLG_ADDREG_BINVALUETYPE</a>)
00446                 {
00447                     <span class="comment">//</span>
00448                     <span class="comment">// Disallow the following reg data types:</span>
00449                     <span class="comment">//</span>
00450                     <span class="comment">//    REG_NONE, REG_SZ, REG_EXPAND_SZ, REG_MULTI_SZ</span>
00451                     <span class="comment">//</span>
00452 
00453                     valueType = HIGHWORD(flags);
00454 
00455                     <span class="keywordflow">if</span>(valueType &lt; REG_BINARY || valueType == REG_MULTI_SZ)
00456                     {
00457                         <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00458                     }
00459 
00460                 }
00461                 <span class="keywordflow">else</span>
00462                 {
00463                     <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00464                 }
00465                 <span class="keywordflow">break</span>;
00466         }
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">// Presently, the append behavior flag is only supported for</span>
00470         <span class="comment">// REG_MULTI_SZ values.</span>
00471         <span class="comment">//</span>
00472 
00473         <span class="keywordflow">if</span>((flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a3">FLG_ADDREG_APPEND</a>) &amp;&amp; valueType != REG_MULTI_SZ)
00474         {
00475             <span class="keywordflow">return</span> (STATUS_INVALID_PARAMETER);
00476         }
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">// W9x compatibility.</span>
00480         <span class="comment">//</span>
00481 
00482         <span class="keywordflow">if</span>( (!valueName || *valueName == <span class="charliteral">'\0'</span>) &amp;&amp; valueType == REG_EXPAND_SZ)
00483         {
00484             valueType = REG_SZ;
00485         }
00486 
00487         status = <a class="code" href="../../d8/d0/geninst_8c.html#a28">CmpGetAddRegInfData</a>(   InfHandle,
00488                                         Section,
00489                                         LineIndex,
00490                                         4,
00491                                         valueType,
00492                                         &amp;data,
00493                                         &amp;dataSize);
00494 
00495         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00496         {
00497             <span class="comment">//</span>
00498             <span class="comment">// Open the specified key if possible.</span>
00499             <span class="comment">//</span>
00500 
00501             status = <a class="code" href="../../d8/d0/geninst_8c.html#a29">CmpOpenRegKey</a>( &amp;key,
00502                                     &amp;disposition,
00503                                     rootKeyName,
00504                                     subKeyName,
00505                                     KEY_QUERY_VALUE | KEY_SET_VALUE,
00506                                     (BOOLEAN)!(flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a5">FLG_ADDREG_OVERWRITEONLY</a>));
00507             <span class="comment">//</span>
00508             <span class="comment">// This variable gets set to TRUE if we dont actually want to set</span>
00509             <span class="comment">// the value.</span>
00510             <span class="comment">//</span>
00511 
00512             dontSet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00513             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00514             {
00515                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a3">FLG_ADDREG_APPEND</a>)
00516                 {
00517                     status = <a class="code" href="../../d8/d0/geninst_8c.html#a30">CmpAppendStringToMultiSz</a>(  key,
00518                                                         valueName,
00519                                                         &amp;data,
00520                                                         &amp;dataSize);
00521                 }
00522                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00523                 {
00524                     <span class="comment">//</span>
00525                     <span class="comment">// W9x compatibility.</span>
00526                     <span class="comment">//</span>
00527 
00528                     <span class="keywordflow">if</span> (disposition == REG_OPENED_EXISTING_KEY)
00529                     {
00530                         <span class="keywordflow">if</span> (    (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a1">FLG_ADDREG_NOCLOBBER</a>) &amp;&amp;
00531                                 (valueName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || *valueName == <span class="charliteral">'\0'</span>))
00532                         {
00533                             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, <span class="stringliteral">""</span>);
00534                             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00535                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00536                             {
00537 
00538                                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(   key,
00539                                                             &amp;unicodeString,
00540                                                             KeyValueBasicInformation,
00541                                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00542                                                             0,
00543                                                             &amp;disposition);
00544                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || status == STATUS_BUFFER_TOO_SMALL)
00545                                 {
00546                                     flags &amp;= ~<a class="code" href="../../d8/d0/geninst_8c.html#a1">FLG_ADDREG_NOCLOBBER</a>;
00547                                 }
00548                                 status = STATUS_SUCCESS;
00549 
00550                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00551                             }
00552                         }
00553 
00554                         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a2">FLG_ADDREG_DELVAL</a>)
00555                         {
00556                             <span class="comment">//</span>
00557                             <span class="comment">// setupx compatibility.</span>
00558                             <span class="comment">//</span>
00559 
00560                             dontSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00561                             <span class="keywordflow">if</span> (valueName)
00562                             {
00563                                 <span class="comment">//</span>
00564                                 <span class="comment">// Delete the specified value.</span>
00565                                 <span class="comment">//</span>
00566 
00567                                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, valueName);
00568                                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00569                                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00570                                 {
00571                                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(key, &amp;unicodeString);
00572                                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00573                                 }
00574                             }
00575                         }
00576                     }
00577                     <span class="keywordflow">else</span>
00578                     {
00579                         flags &amp;= ~<a class="code" href="../../d8/d0/geninst_8c.html#a1">FLG_ADDREG_NOCLOBBER</a>;
00580                     }
00581 
00582                     <span class="keywordflow">if</span> (!dontSet)
00583                     {
00584                         <span class="comment">//</span>
00585                         <span class="comment">// Respect the key only flag.</span>
00586                         <span class="comment">//</span>
00587 
00588                         <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a4">FLG_ADDREG_KEYONLY</a>))
00589                         {
00590                             <span class="comment">//</span>
00591                             <span class="comment">// If no clobber flag is set, make sure that the value does not</span>
00592                             <span class="comment">// already exist.</span>
00593                             <span class="comment">//</span>
00594 
00595                             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, valueName);
00596                             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00597                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00598                             {
00599                                 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    existStatus;
00600 
00601                                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a1">FLG_ADDREG_NOCLOBBER</a>)
00602                                 {
00603                                     existStatus = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(  key,
00604                                                                     &amp;unicodeString,
00605                                                                     KeyValueBasicInformation,
00606                                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00607                                                                     0,
00608                                                                     &amp;disposition);
00609                                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(existStatus) || existStatus == STATUS_BUFFER_TOO_SMALL) {
00610                                         dontSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00611                                     }
00612                                 }
00613                                 <span class="keywordflow">else</span>
00614                                 {
00615                                     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a5">FLG_ADDREG_OVERWRITEONLY</a>)
00616                                     {
00617                                         existStatus = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(  key,
00618                                                                         &amp;unicodeString,
00619                                                                         KeyValueBasicInformation,
00620                                                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00621                                                                         0,
00622                                                                         &amp;disposition);
00623                                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(existStatus) &amp;&amp; existStatus != STATUS_BUFFER_TOO_SMALL) {
00624                                             dontSet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00625                                         }
00626                                     }
00627                                 }
00628 
00629                                 <span class="keywordflow">if</span> (!dontSet)
00630                                 {
00631                                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( key,
00632                                                             &amp;unicodeString,
00633                                                             0,
00634                                                             valueType,
00635                                                             data,
00636                                                             dataSize);
00637                                 }
00638 
00639                                 <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00640                             }
00641                         }
00642                     }
00643                 }
00644 
00645                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key);
00646             }
00647             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a5">FLG_ADDREG_OVERWRITEONLY</a>)
00648             {
00649                 status = STATUS_SUCCESS;
00650             }
00651         }
00652     }
00653 
00654     <span class="keywordflow">return</span> (status);
00655 }
00656 
00657 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00658"></a><a class="code" href="../../d8/d0/geninst_8c.html#a26">00658</a> <a class="code" href="../../d8/d0/geninst_8c.html#a26">CmpProcessDelRegLine</a>(
00659     IN PVOID InfHandle,
00660     IN PCHAR Section,
00661     IN ULONG LineIndex
00662     )
00663 
00664 <span class="comment">/*++</span>
00665 <span class="comment"></span>
00666 <span class="comment">    Routine Description:</span>
00667 <span class="comment"></span>
00668 <span class="comment">        This routine processes a DelReg line in the inf.</span>
00669 <span class="comment"></span>
00670 <span class="comment">    Input Parameters:</span>
00671 <span class="comment"></span>
00672 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00673 <span class="comment"></span>
00674 <span class="comment">        Section - Name of the section to be read.</span>
00675 <span class="comment"></span>
00676 <span class="comment">        LineIndex - Index of the line to be read.</span>
00677 <span class="comment"></span>
00678 <span class="comment">    Return Value:</span>
00679 <span class="comment"></span>
00680 <span class="comment">        Standard NT status value.</span>
00681 <span class="comment"></span>
00682 <span class="comment">--*/</span>
00683 
00684 {
00685     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_UNSUCCESSFUL;
00686     PCHAR               rootKeyName;
00687     PCHAR               subKeyName;
00688     PCHAR               valueName;
00689     HANDLE              key;
00690     ULONG               disposition;
00691     ANSI_STRING         ansiString;
00692     UNICODE_STRING      unicodeString;
00693 
00694     <span class="comment">//</span>
00695     <span class="comment">// Read the required fields.</span>
00696     <span class="comment">//</span>
00697 
00698     rootKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
00699                                             Section,
00700                                             LineIndex,
00701                                             0);
00702 
00703     subKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(    InfHandle,
00704                                             Section,
00705                                             LineIndex,
00706                                             1);
00707 
00708     <span class="keywordflow">if</span> (rootKeyName &amp;&amp; subKeyName)
00709     {
00710         <span class="comment">//</span>
00711         <span class="comment">// Read the optional field.</span>
00712         <span class="comment">//</span>
00713 
00714         valueName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>( InfHandle,
00715                                             Section,
00716                                             LineIndex,
00717                                             2);
00718 
00719         <span class="comment">//</span>
00720         <span class="comment">// Open the specified registry key.</span>
00721         <span class="comment">//</span>
00722 
00723         status = <a class="code" href="../../d8/d0/geninst_8c.html#a29">CmpOpenRegKey</a>( &amp;key,
00724                                 &amp;disposition,
00725                                 rootKeyName,
00726                                 subKeyName,
00727                                 KEY_ALL_ACCESS,
00728                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00729 
00730         <span class="comment">//</span>
00731         <span class="comment">// Proceed if we successfully opened the registry key.</span>
00732         <span class="comment">//</span>
00733 
00734         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00735         {
00736 
00737             <span class="comment">//</span>
00738             <span class="comment">// If the key was successfully opened, do the DelReg.</span>
00739             <span class="comment">//</span>
00740 
00741             <span class="keywordflow">if</span> (valueName)
00742             {
00743                 <span class="comment">//</span>
00744                 <span class="comment">// Delete the specified value.</span>
00745                 <span class="comment">//</span>
00746 
00747                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, valueName);
00748                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00749                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00750                 {
00751                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a16">NtDeleteValueKey</a>(key, &amp;unicodeString);
00752                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00753                 }
00754             }
00755             <span class="keywordflow">else</span>
00756             {
00757                 <span class="comment">//</span>
00758                 <span class="comment">// No value specified. The subkey needs to be deleted.</span>
00759                 <span class="comment">//</span>
00760 
00761                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a15">NtDeleteKey</a>(key);
00762             }
00763 
00764             <span class="comment">//</span>
00765             <span class="comment">// Close the key handle.</span>
00766             <span class="comment">//</span>
00767 
00768             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key);
00769         }
00770     }
00771 
00772     <span class="keywordflow">return</span> (status);
00773 }
00774 
00775 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00776"></a><a class="code" href="../../d8/d0/geninst_8c.html#a27">00776</a> <a class="code" href="../../d8/d0/geninst_8c.html#a27">CmpProcessBitRegLine</a>(
00777     IN PVOID InfHandle,
00778     IN PCHAR Section,
00779     IN ULONG LineIndex
00780     )
00781 
00782 <span class="comment">/*++</span>
00783 <span class="comment"></span>
00784 <span class="comment">    Routine Description:</span>
00785 <span class="comment"></span>
00786 <span class="comment">        This routine processes a BitReg line in the inf.</span>
00787 <span class="comment"></span>
00788 <span class="comment">    Input Parameters:</span>
00789 <span class="comment"></span>
00790 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
00791 <span class="comment"></span>
00792 <span class="comment">        Section - Name of the section to be read.</span>
00793 <span class="comment"></span>
00794 <span class="comment">        LineIndex - Index of the line to be read.</span>
00795 <span class="comment"></span>
00796 <span class="comment">    Return Value:</span>
00797 <span class="comment"></span>
00798 <span class="comment">        Standard NT status value.</span>
00799 <span class="comment"></span>
00800 <span class="comment">--*/</span>
00801 
00802 {
00803     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status = STATUS_UNSUCCESSFUL;
00804     PCHAR                       rootKeyName;
00805     PCHAR                       subKeyName;
00806     PCHAR                       valueName;
00807     ULONG                       flags;
00808     ULONG                       mask;
00809     ULONG                       field;
00810     HANDLE                      key;
00811     ULONG                       disposition;
00812     ANSI_STRING                 ansiString;
00813     UNICODE_STRING              unicodeString;
00814     PCHAR                       buffer;
00815     ULONG                       size;
00816     PKEY_VALUE_FULL_INFORMATION valueInfo;
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">// Get the root-key name.</span>
00820     <span class="comment">//</span>
00821 
00822     rootKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
00823                                             Section,
00824                                             LineIndex,
00825                                             0);
00826     <span class="keywordflow">if</span> (rootKeyName)
00827     {
00828         <span class="comment">//</span>
00829         <span class="comment">// Get the optional sub-key name.</span>
00830         <span class="comment">//</span>
00831 
00832         subKeyName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(    InfHandle,
00833                                                 Section,
00834                                                 LineIndex,
00835                                                 1);
00836 
00837         <span class="comment">//</span>
00838         <span class="comment">// Value name is optional. Can be NULL or "".</span>
00839         <span class="comment">//</span>
00840 
00841         valueName = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>( InfHandle,
00842                                             Section,
00843                                             LineIndex,
00844                                             2);
00845         <span class="keywordflow">if</span> (valueName &amp;&amp; *valueName)
00846         {
00847             <span class="comment">//</span>
00848             <span class="comment">// Read in the flags.</span>
00849             <span class="comment">//</span>
00850 
00851             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(    InfHandle,
00852                                     Section,
00853                                     LineIndex,
00854                                     3,
00855                                     &amp;flags))
00856             {
00857                 flags = 0;
00858             }
00859 
00860             <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(    InfHandle,
00861                                     Section,
00862                                     LineIndex,
00863                                     4,
00864                                     &amp;mask))
00865             {
00866                 mask = 0;
00867             }
00868 
00869             <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a16">FLG_BITREG_TYPE_DWORD</a>))
00870             {
00871                 <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(    InfHandle,
00872                                         Section,
00873                                         LineIndex,
00874                                         5,
00875                                         &amp;field))
00876                 {
00877                     <span class="keywordflow">return</span> (status);
00878                 }
00879             }
00880 
00881             <span class="comment">//</span>
00882             <span class="comment">// Open the specified registry key.</span>
00883             <span class="comment">//</span>
00884 
00885             status = <a class="code" href="../../d8/d0/geninst_8c.html#a29">CmpOpenRegKey</a>( &amp;key,
00886                                     &amp;disposition,
00887                                     rootKeyName,
00888                                     subKeyName,
00889                                     KEY_ALL_ACCESS,
00890                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00891             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00892             {
00893                 <span class="comment">//</span>
00894                 <span class="comment">// Read the existing data.</span>
00895                 <span class="comment">//</span>
00896 
00897                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, valueName);
00898                 status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00899                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00900                 {
00901                     size = 0;
00902                     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(   key,
00903                                                 &amp;unicodeString,
00904                                                 KeyValueFullInformation,
00905                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00906                                                 0,
00907                                                 &amp;size);
00908                     <span class="keywordflow">if</span> (size)
00909                     {
00910                         status = STATUS_NO_MEMORY;
00911                         buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size, CM_GENINST_TAG);
00912                         <span class="keywordflow">if</span> (buffer)
00913                         {
00914                             status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(   key,
00915                                                         &amp;unicodeString,
00916                                                         KeyValueFullInformation,
00917                                                         buffer,
00918                                                         size,
00919                                                         &amp;size);
00920                             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
00921                             {
00922                                 valueInfo = (PKEY_VALUE_FULL_INFORMATION)buffer;
00923                                 <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a16">FLG_BITREG_TYPE_DWORD</a>)
00924                                 {
00925                                     <span class="keywordflow">if</span> (valueInfo-&gt;Type == REG_DWORD &amp;&amp; valueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))
00926                                     {
00927                                         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a14">FLG_BITREG_SET</a>)
00928                                         {
00929                                             *(PULONG)(buffer + valueInfo-&gt;DataOffset) |= mask;
00930                                         }
00931                                         <span class="keywordflow">else</span>
00932                                         {
00933                                             *(PULONG)(buffer + valueInfo-&gt;DataOffset) &amp;= ~mask;
00934                                         }
00935                                     }
00936                                 }
00937                                 <span class="keywordflow">else</span>
00938                                 {
00939                                     <span class="keywordflow">if</span> (valueInfo-&gt;Type == REG_BINARY &amp;&amp; field &lt; valueInfo-&gt;DataLength)
00940                                     {
00941                                         <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d8/d0/geninst_8c.html#a14">FLG_BITREG_SET</a>)
00942                                         {
00943                                             *(PUCHAR)(buffer + valueInfo-&gt;DataOffset + field) |= mask;
00944                                         }
00945                                         <span class="keywordflow">else</span>
00946                                         {
00947                                             *(PUCHAR)(buffer + valueInfo-&gt;DataOffset + field) &amp;= ~mask;
00948                                         }
00949                                     }
00950                                 }
00951                                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>( key,
00952                                                         &amp;unicodeString,
00953                                                         0,
00954                                                         valueInfo-&gt;Type,
00955                                                         buffer + valueInfo-&gt;DataOffset,
00956                                                         valueInfo-&gt;DataLength);
00957                             }
00958                             <span class="keywordflow">else</span>
00959                             {
00960                                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Value cannot be read for BitReg in %s line %d\n"</span>, Section, LineIndex);
00961                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
00962                             }
00963                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
00964                         }
00965                         <span class="keywordflow">else</span>
00966                         {
00967                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(buffer);
00968                             status = STATUS_NO_MEMORY;
00969                         }
00970                     }
00971 
00972                     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
00973                 }
00974                 <span class="comment">//</span>
00975                 <span class="comment">// Close the key handle.</span>
00976                 <span class="comment">//</span>
00977 
00978                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(key);
00979             }
00980         }
00981     }
00982 
00983     <span class="keywordflow">return</span> (status);
00984 }
00985 
00986 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00987"></a><a class="code" href="../../d8/d0/geninst_8c.html#a28">00987</a> <a class="code" href="../../d8/d0/geninst_8c.html#a28">CmpGetAddRegInfData</a>(
00988     IN PVOID InfHandle,
00989     IN PCHAR Section,
00990     IN ULONG LineIndex,
00991     IN ULONG ValueIndex,
00992     IN ULONG ValueType,
00993     OUT PVOID *Data,
00994     OUT PULONG DataSize
00995     )
00996 
00997 <span class="comment">/*++</span>
00998 <span class="comment"></span>
00999 <span class="comment">    Routine Description:</span>
01000 <span class="comment"></span>
01001 <span class="comment">        This routine reads AddReg data from the inf.</span>
01002 <span class="comment"></span>
01003 <span class="comment">    Input Parameters:</span>
01004 <span class="comment"></span>
01005 <span class="comment">        InfHandle - Handle to the inf to be read.</span>
01006 <span class="comment"></span>
01007 <span class="comment">        Section - Name of the section to be read.</span>
01008 <span class="comment"></span>
01009 <span class="comment">        LineIndex - Index of the line to be read.</span>
01010 <span class="comment"></span>
01011 <span class="comment">        ValueIndex - Index of the value to be read.</span>
01012 <span class="comment"></span>
01013 <span class="comment">        ValueType - Data type to be read.</span>
01014 <span class="comment"></span>
01015 <span class="comment">        Data - Receives pointer to the buffer in which data has been read.</span>
01016 <span class="comment"></span>
01017 <span class="comment">        DataSize - Receives the size of the data buffer.</span>
01018 <span class="comment"></span>
01019 <span class="comment">    Return Value:</span>
01020 <span class="comment"></span>
01021 <span class="comment">        Standard NT status value.</span>
01022 <span class="comment"></span>
01023 <span class="comment">--*/</span>
01024 
01025 {
01026     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_UNSUCCESSFUL;
01027     PCHAR           str;
01028     ULONG           count;
01029     ULONG           i;
01030     ANSI_STRING     ansiString;
01031     UNICODE_STRING  unicodeString;
01032 
01033     <span class="comment">//</span>
01034     <span class="comment">// Validate the required fields.</span>
01035     <span class="comment">//</span>
01036 
01037     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Data);
01038     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataSize);
01039 
01040     <span class="keywordflow">switch</span> (ValueType)
01041     {
01042         <span class="keywordflow">case</span> REG_DWORD:
01043 
01044             *DataSize = <span class="keyword">sizeof</span>(ULONG);
01045             *Data = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *DataSize, CM_GENINST_TAG);
01046             <span class="keywordflow">if</span> (*Data)
01047             {
01048                 <span class="comment">//</span>
01049                 <span class="comment">// DWORD data is specified as four bytes in W9x.</span>
01050                 <span class="comment">//</span>
01051 
01052                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/parseini_8h.html#a6">CmpGetSectionLineIndexValueCount</a>(   InfHandle,
01053                                                         Section,
01054                                                         LineIndex) == 8)
01055                 {
01056                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a8">CmpGetBinaryField</a>( InfHandle,
01057                                             Section,
01058                                             LineIndex,
01059                                             ValueIndex,
01060                                             *Data,
01061                                             *DataSize,
01062                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01063                     {
01064                         *((PULONG)*Data) = 0;
01065                     }
01066 
01067                     status = STATUS_SUCCESS;
01068                 }
01069                 <span class="keywordflow">else</span>
01070                 {
01071                     <span class="comment">//</span>
01072                     <span class="comment">// Get the DWORD value.</span>
01073                     <span class="comment">//</span>
01074 
01075                     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d3/parseini_8h.html#a7">CmpGetIntField</a>(    InfHandle,
01076                                             Section,
01077                                             LineIndex,
01078                                             4,
01079                                             *Data))
01080                     {
01081                         *((PULONG)*Data) = 0;
01082                     }
01083 
01084                     status = STATUS_SUCCESS;
01085                 }
01086             }
01087             <span class="keywordflow">else</span>
01088             {
01089                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Data);
01090                 status = STATUS_NO_MEMORY;
01091             }
01092 
01093             <span class="keywordflow">break</span>;
01094 
01095         <span class="keywordflow">case</span> REG_SZ:
01096         <span class="keywordflow">case</span> REG_EXPAND_SZ:
01097 
01098             <span class="comment">//</span>
01099             <span class="comment">// Null terminated string. Gets converted to unicode before being</span>
01100             <span class="comment">// added into the registry.</span>
01101             <span class="comment">//</span>
01102 
01103             str = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
01104                                             Section,
01105                                             LineIndex,
01106                                             ValueIndex);
01107             <span class="keywordflow">if</span> (str)
01108             {
01109                 <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, str);
01110                 *DataSize = (ansiString.Length &lt;&lt; 1) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01111                 unicodeString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)*DataSize;
01112                 unicodeString.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *DataSize, CM_GENINST_TAG);
01113                 *Data = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01114                 <span class="keywordflow">if</span> (unicodeString.Buffer)
01115                 {
01116                     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01117                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01118                     {
01119                         *Data = unicodeString.Buffer;
01120                         status = STATUS_SUCCESS;
01121                     }
01122                 }
01123                 <span class="keywordflow">else</span>
01124                 {
01125                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(unicodeString.Buffer);
01126                     status = STATUS_NO_MEMORY;
01127                 }
01128             }
01129             <span class="keywordflow">else</span>
01130             {
01131                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(str);
01132                 status = STATUS_NO_MEMORY;
01133             }
01134 
01135             <span class="keywordflow">break</span>;
01136 
01137         <span class="keywordflow">case</span> REG_MULTI_SZ:
01138 
01139             *DataSize = 0;
01140             *Data = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01141 
01142             <span class="comment">//</span>
01143             <span class="comment">// Loop to determine the total memory that needs to be allocated.</span>
01144             <span class="comment">//</span>
01145 
01146             count = <a class="code" href="../../d6/d3/parseini_8h.html#a6">CmpGetSectionLineIndexValueCount</a>(   InfHandle,
01147                                                         Section,
01148                                                         LineIndex);
01149             <span class="keywordflow">if</span> (count &gt; ValueIndex)
01150             {
01151                 count -= ValueIndex;
01152                 <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
01153                 {
01154                     str = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
01155                                                     Section,
01156                                                     LineIndex,
01157                                                     ValueIndex + i);
01158                     <span class="keywordflow">if</span> (str == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01159                     {
01160                         <span class="keywordflow">break</span>;
01161                     }
01162 
01163                     *DataSize += ((<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(str) * <span class="keyword">sizeof</span>(WCHAR)) + <span class="keyword">sizeof</span>(UNICODE_NULL));
01164                 }
01165 
01166                 <span class="keywordflow">if</span> (i == count)
01167                 {
01168                     <span class="comment">//</span>
01169                     <span class="comment">// Account for the terminating NULL.</span>
01170                     <span class="comment">//</span>
01171 
01172                     *DataSize += <span class="keyword">sizeof</span>(UNICODE_NULL);
01173                     *Data = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *DataSize, CM_GENINST_TAG);
01174                     <span class="keywordflow">if</span> (*Data)
01175                     {
01176                         <span class="keywordflow">for</span> (   i = 0, unicodeString.Buffer = *Data;
01177                                 i &lt; count;
01178                                 i++, (PCHAR)unicodeString.Buffer += unicodeString.MaximumLength)
01179                         {
01180                             str = <a class="code" href="../../d6/d3/parseini_8h.html#a5">CmpGetSectionLineIndex</a>(   InfHandle,
01181                                                             Section,
01182                                                             LineIndex,
01183                                                             ValueIndex + i);
01184                             <span class="keywordflow">if</span> (str == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01185                             {
01186                                 <span class="keywordflow">break</span>;
01187                             }
01188                             <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, str);
01189                             unicodeString.MaximumLength = (ansiString.Length * <span class="keyword">sizeof</span>(WCHAR)) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01190                             status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01191                             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01192                             {
01193                                 <span class="keywordflow">break</span>;
01194                             }
01195                         }
01196 
01197                         <span class="comment">//</span>
01198                         <span class="comment">// Terminate the multi-sz string.</span>
01199                         <span class="comment">//</span>
01200 
01201                         <span class="keywordflow">if</span> (i == count)
01202                         {
01203                             unicodeString.Buffer[0] = UNICODE_NULL;
01204                             status = STATUS_SUCCESS;
01205                         }
01206                     }
01207                     <span class="keywordflow">else</span>
01208                     {
01209                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Data);
01210                         status = STATUS_NO_MEMORY;
01211                     }
01212                 }
01213             }
01214 
01215             <span class="keywordflow">break</span>;
01216 
01217         <span class="keywordflow">case</span> REG_BINARY:
01218         <span class="keywordflow">default</span>:
01219 
01220             <span class="comment">//</span>
01221             <span class="comment">// Free form binary data.</span>
01222             <span class="comment">//</span>
01223 
01224             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/parseini_8h.html#a8">CmpGetBinaryField</a>(  InfHandle,
01225                                     Section,
01226                                     LineIndex,
01227                                     ValueIndex,
01228                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01229                                     0,
01230                                     DataSize) &amp;&amp; *DataSize)
01231             {
01232                 *Data = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *DataSize, CM_GENINST_TAG);
01233                 <span class="keywordflow">if</span> (*Data)
01234                 {
01235                     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d3/parseini_8h.html#a8">CmpGetBinaryField</a>( InfHandle,
01236                                             Section,
01237                                             LineIndex,
01238                                             4,
01239                                             *Data,
01240                                             *DataSize,
01241                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))
01242                     {
01243                         status = STATUS_SUCCESS;
01244                     }
01245                 }
01246                 <span class="keywordflow">else</span>
01247                 {
01248                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Data);
01249                     status = STATUS_NO_MEMORY;
01250                 }
01251             }
01252             <span class="keywordflow">else</span>
01253             {
01254                 status = STATUS_UNSUCCESSFUL;
01255             }
01256 
01257             <span class="keywordflow">break</span>;
01258     }
01259 
01260     <span class="keywordflow">return</span> (status);
01261 }
01262 
01263 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01264"></a><a class="code" href="../../d8/d0/geninst_8c.html#a29">01264</a> <a class="code" href="../../d8/d0/geninst_8c.html#a29">CmpOpenRegKey</a>(
01265     IN OUT PHANDLE Key,
01266     IN OUT PULONG Disposition,
01267     IN PCHAR Root,
01268     IN PCHAR SubKey,
01269     IN ULONG DesiredAccess,
01270     IN BOOLEAN Create
01271     )
01272 
01273 <span class="comment">/*++</span>
01274 <span class="comment"></span>
01275 <span class="comment">    Routine Description:</span>
01276 <span class="comment"></span>
01277 <span class="comment">        This routine opens\creates a handle to the registry key.</span>
01278 <span class="comment"></span>
01279 <span class="comment">    Input Parameters:</span>
01280 <span class="comment"></span>
01281 <span class="comment">        Key - Receives the handle to the key.</span>
01282 <span class="comment"></span>
01283 <span class="comment">        Disposition - Receives the disposition of the key.</span>
01284 <span class="comment"></span>
01285 <span class="comment">        Root - Abbreviated name of the root key.</span>
01286 <span class="comment"></span>
01287 <span class="comment">        SubKey - Name of the subkey under the root.</span>
01288 <span class="comment"></span>
01289 <span class="comment">        DesiredAccess - Desired access flags for the key.</span>
01290 <span class="comment"></span>
01291 <span class="comment">        Create - TRUE if the key needs to be created instead of opened.</span>
01292 <span class="comment"></span>
01293 <span class="comment">    Return Value:</span>
01294 <span class="comment"></span>
01295 <span class="comment">        Standard NT status value.</span>
01296 <span class="comment"></span>
01297 <span class="comment">--*/</span>
01298 
01299 {
01300     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_OBJECT_NAME_INVALID;
01301     ULONG               size;
01302     PCHAR               str;
01303     ANSI_STRING         ansiString;
01304     UNICODE_STRING      unicodeString;
01305     OBJECT_ATTRIBUTES   objectAttributes;
01306 
01307     str = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01308     size = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(SubKey) + 1;
01309 
01310     <span class="comment">//</span>
01311     <span class="comment">// Check if we understand the specified root name.</span>
01312     <span class="comment">//</span>
01313 
01314     <span class="keywordflow">if</span> (_stricmp(Root, <span class="stringliteral">"HKLM"</span>) == 0)
01315     {
01316         size += <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(<span class="stringliteral">"\\Registry\\Machine\\"</span>);
01317         str = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size, CM_GENINST_TAG);
01318         <span class="keywordflow">if</span> (str)
01319         {
01320             strcpy(str, <span class="stringliteral">"\\Registry\\Machine\\"</span>);
01321             strcat(str, SubKey);
01322         }
01323         <span class="keywordflow">else</span>
01324         {
01325             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(str);
01326             status = STATUS_NO_MEMORY;
01327         }
01328     }
01329     <span class="keywordflow">else</span>
01330     {
01331         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(_stricmp(Root, <span class="stringliteral">"HKLM"</span>) == 0);
01332     }
01333 
01334     <span class="comment">//</span>
01335     <span class="comment">// Proceed if we have a valid key name.</span>
01336     <span class="comment">//</span>
01337 
01338     <span class="keywordflow">if</span> (str)
01339     {
01340         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, str);
01341         status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01342         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01343         {
01344             InitializeObjectAttributes( &amp;objectAttributes,
01345                                         &amp;unicodeString,
01346                                         OBJ_CASE_INSENSITIVE,
01347                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01348                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01349             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>)
01350             {
01351                 <span class="comment">//</span>
01352                 <span class="comment">// Create a new key or open an existing one.</span>
01353                 <span class="comment">//</span>
01354 
01355                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01356                                         DesiredAccess,
01357                                         &amp;objectAttributes,
01358                                         0,
01359                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01360                                         REG_OPTION_NON_VOLATILE,
01361                                         Disposition ? Disposition : &amp;size);
01362             }
01363             <span class="keywordflow">else</span>
01364             {
01365                 <span class="comment">//</span>
01366                 <span class="comment">// Open existing key.</span>
01367                 <span class="comment">//</span>
01368 
01369                 <span class="keywordflow">if</span> (Disposition)
01370                 {
01371                     *Disposition = REG_OPENED_EXISTING_KEY;
01372                 }
01373                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01374                                     DesiredAccess,
01375                                     &amp;objectAttributes);
01376             }
01377 
01378             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
01379         }
01380         <span class="keywordflow">else</span>
01381         {
01382             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
01383         }
01384 
01385         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(str);
01386     }
01387 
01388     <span class="keywordflow">return</span> (status);
01389 }
01390 
01391 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01392"></a><a class="code" href="../../d8/d0/geninst_8c.html#a30">01392</a> <a class="code" href="../../d8/d0/geninst_8c.html#a30">CmpAppendStringToMultiSz</a>(
01393     IN HANDLE Key,
01394     IN PCHAR ValueName,
01395     IN OUT PVOID *Data,
01396     IN OUT PULONG DataSize
01397     )
01398 
01399 <span class="comment">/*++</span>
01400 <span class="comment"></span>
01401 <span class="comment">    Routine Description:</span>
01402 <span class="comment"></span>
01403 <span class="comment">        This routine opens\creates a handle to the registry key.</span>
01404 <span class="comment"></span>
01405 <span class="comment">    Input Parameters:</span>
01406 <span class="comment"></span>
01407 <span class="comment">        Key - Receives the handle to the key.</span>
01408 <span class="comment"></span>
01409 <span class="comment">        ValueName - Name of the value to be appended to.</span>
01410 <span class="comment"></span>
01411 <span class="comment">        Data - Buffer containing the multi-sz to be appended.</span>
01412 <span class="comment"></span>
01413 <span class="comment">        DataSize - Size of the data.</span>
01414 <span class="comment"></span>
01415 <span class="comment">    Return Value:</span>
01416 <span class="comment"></span>
01417 <span class="comment">        Standard NT status value.</span>
01418 <span class="comment"></span>
01419 <span class="comment">--*/</span>
01420 
01421 {
01422     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
01423     ULONG                       size;
01424     ANSI_STRING                 ansiString;
01425     UNICODE_STRING              unicodeString;
01426     PKEY_VALUE_FULL_INFORMATION valueInfo;
01427     PVOID                       buffer;
01428     PVOID                       str;
01429 
01430     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DataSize &amp;&amp; *DataSize);
01431     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*Data);
01432 
01433     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(&amp;ansiString, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
01434     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;unicodeString, &amp;ansiString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01435     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01436     {
01437         size = 0;
01438         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01439                                     &amp;unicodeString,
01440                                     KeyValueFullInformation,
01441                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01442                                     0,
01443                                     &amp;size);
01444         <span class="keywordflow">if</span> (size)
01445         {
01446             buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, size, CM_GENINST_TAG);
01447             <span class="keywordflow">if</span> (buffer)
01448             {
01449                 status = <a class="code" href="../../d7/d7/ntapi_8c.html#a25">NtQueryValueKey</a>(   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01450                                             &amp;unicodeString,
01451                                             KeyValueFullInformation,
01452                                             buffer,
01453                                             size,
01454                                             &amp;size);
01455                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))
01456                 {
01457                     valueInfo = (PKEY_VALUE_FULL_INFORMATION)buffer;
01458                     str = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(    <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01459                                                     valueInfo-&gt;DataLength +
01460                                                         *DataSize - <span class="keyword">sizeof</span>(UNICODE_NULL),
01461                                                     CM_GENINST_TAG);
01462                     <span class="keywordflow">if</span> (str)
01463                     {
01464                         memcpy( str,
01465                                 (PCHAR)buffer + valueInfo-&gt;DataOffset,
01466                                 valueInfo-&gt;DataLength);
01467                         memcpy( (PCHAR)str + valueInfo-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL),
01468                                 *Data,
01469                                 *DataSize);
01470                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*Data);
01471                         *Data = str;
01472                         *DataSize += valueInfo-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
01473                     }
01474                     <span class="keywordflow">else</span>
01475                     {
01476                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpAppendStringToMultiSz: Failed to allocate memory!\n"</span>);
01477                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(str);
01478                         status = STATUS_NO_MEMORY;
01479                     }
01480                 }
01481                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(buffer);
01482             }
01483             <span class="keywordflow">else</span>
01484             {
01485                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"CmpAppendStringToMultiSz: Failed to allocate memory!\n"</span>);
01486                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(buffer);
01487                 status = STATUS_NO_MEMORY;
01488             }
01489         }
01490         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;unicodeString);
01491     }
01492 
01493     <span class="keywordflow">return</span> (status);
01494 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:08 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
