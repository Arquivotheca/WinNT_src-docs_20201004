<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpioapi.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpioapi.c</h1><a href="../../d8/d0/pnpioapi_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1995  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    pnpsubs.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the plug-and-play IO system APIs.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Shie-Lin Tzong (shielint) 3-Jan-1995</span>
00017 <span class="comment">    Andrew Thornton (andrewth) 5-Sept-1996</span>
00018 <span class="comment">    Paula Tomlinson (paulat) 1-May-1997</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment"></span>
00027 <span class="comment">--*/</span>
00028 
00029 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00030 <span class="preprocessor">#pragma hdrstop</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stddef.h&gt;</span>
00032 <span class="preprocessor">#include &lt;wdmguid.h&gt;</span>
00033 <span class="preprocessor">#include &lt;pnpmgr.h&gt;</span>
00034 <span class="preprocessor">#include &lt;<a class="code" href="../../d8/d1/pnpsetup_8h.html">pnpsetup.h</a>&gt;</span>
00035 <span class="preprocessor">#include "..\pnp\pnpi.h"</span>
00036 
00037 <span class="preprocessor">#ifdef POOL_TAGGING</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define ExAllocatePool(a,b) ExAllocatePoolWithTag(a,b,'oipP')</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
<a name="l00042"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a0">00042</a> <span class="preprocessor">#define PNP_DEVICE_EVENT_ENTRY_TAG 'EEpP'</span>
00043 <span class="preprocessor"></span>
00044 
00045 <span class="comment">//</span>
00046 <span class="comment">// Define device state work item.</span>
00047 <span class="comment">//</span>
00048 
<a name="l00049"></a><a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html">00049</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html">_DEVICE_WORK_ITEM</a> {
<a name="l00050"></a><a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o0">00050</a>     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o0">WorkItem</a>;
<a name="l00051"></a><a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o1">00051</a>     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o1">DeviceObject</a>;
<a name="l00052"></a><a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o2">00052</a>     PVOID <a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o2">Context</a>;
00053 } <a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html">DEVICE_WORK_ITEM</a>, *<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html">PDEVICE_WORK_ITEM</a>;
00054 
<a name="l00055"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html">00055</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html">_ASYNC_TDC_WORK_ITEM</a> {
<a name="l00056"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o0">00056</a>     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o0">WorkItem</a>;
<a name="l00057"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o1">00057</a>     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o1">DeviceObject</a>;
<a name="l00058"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o2">00058</a>     <a class="code" href="../../d6/d9/pnp_8h.html#a51">PDEVICE_CHANGE_COMPLETE_CALLBACK</a> <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o2">Callback</a>;
<a name="l00059"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o3">00059</a>     PVOID <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o3">Context</a>;
<a name="l00060"></a><a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o4">00060</a>     <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a> <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o4">NotificationStructure</a>;
00061 }   <a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html">ASYNC_TDC_WORK_ITEM</a>, *<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html">PASYNC_TDC_WORK_ITEM</a>;
00062 
<a name="l00063"></a><a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">00063</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">_NOTIFICATION_CALLBACK_PARAM_BLOCK</a> {
<a name="l00064"></a><a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">00064</a>     <a class="code" href="../../d6/d9/pnp_8h.html#a50">PDRIVER_NOTIFICATION_CALLBACK_ROUTINE</a> <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>;
<a name="l00065"></a><a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">00065</a>     PVOID   <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>;
<a name="l00066"></a><a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">00066</a>     PVOID   <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>;
00067 } <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a>, *<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">PNOTIFICATION_CALLBACK_PARAM_BLOCK</a>;
00068 
00069 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00070 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a50">IopQueueDeviceWorkItem</a>(
00071     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00072     IN PVOID WorkerRoutine,
00073     IN PVOID Context
00074     );
00075 
00076 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00077 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a51">IopInvalidateDeviceStateWorker</a>(
00078     PVOID Context
00079     );
00080 
00081 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00082 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a52">IopReportTargetDeviceChangeAsyncWorker</a>(
00083     PVOID Context
00084     );
00085 
00086 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00087 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a53">IopRequestDeviceEjectWorker</a>(
00088     PVOID Context
00089     );
00090 
00091 BOOLEAN
00092 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a54">IopIsReportedAlready</a>(
00093     IN HANDLE Handle,
00094     IN PUNICODE_STRING ServiceName,
00095     IN PCM_RESOURCE_LIST ResourceList
00096     );
00097 
00098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00099 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a55">IopSetupDeviceObjectFromDeviceClass</a>(
00100     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Pdo,
00101     IN HANDLE InterfaceClassKey
00102     );
00103 
00104 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00105 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a56">IopSetSecurityObjectFromRegistry</a>(
00106     IN PVOID Object,
00107     IN HANDLE Key
00108     );
00109 
00110 
00111 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00112 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a> (
00113     PVOID CallbackParams
00114     );
00115 <span class="comment">//</span>
00116 <span class="comment">// Definitions for IoOpenDeviceRegistryKey</span>
00117 <span class="comment">//</span>
00118 
<a name="l00119"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a1">00119</a> <span class="preprocessor">#define PATH_CURRENTCONTROLSET_HW_PROFILE_CURRENT TEXT("\\Registry\\Machine\\System\\CurrentControlSet\\Hardware Profiles\\Current\\System\\CurrentControlSet")</span>
<a name="l00120"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a2">00120</a> <span class="preprocessor"></span><span class="preprocessor">#define PATH_CURRENTCONTROLSET                    TEXT("\\Registry\\Machine\\System\\CurrentControlSet")</span>
<a name="l00121"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a3">00121</a> <span class="preprocessor"></span><span class="preprocessor">#define PATH_ENUM                                 TEXT("Enum\\")</span>
<a name="l00122"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a4">00122</a> <span class="preprocessor"></span><span class="preprocessor">#define PATH_CONTROL_CLASS                        TEXT("Control\\Class\\")</span>
<a name="l00123"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a5">00123</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_RESTPATH_BUF_LEN            512</span>
00124 <span class="preprocessor"></span>
00125 <span class="comment">//</span>
00126 <span class="comment">// Definitions for PnpGetDeviceInterfaces</span>
00127 <span class="comment">//</span>
00128 
<a name="l00129"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a6">00129</a> <span class="preprocessor">#define INITIAL_INFO_BUFFER_SIZE         512</span>
<a name="l00130"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a7">00130</a> <span class="preprocessor"></span><span class="preprocessor">#define INFO_BUFFER_GROW_SIZE            64</span>
<a name="l00131"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a8">00131</a> <span class="preprocessor"></span><span class="preprocessor">#define INITIAL_SYMLINK_BUFFER_SIZE      1024</span>
<a name="l00132"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a9">00132</a> <span class="preprocessor"></span><span class="preprocessor">#define SYMLINK_BUFFER_GROW_SIZE         128</span>
<a name="l00133"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a10">00133</a> <span class="preprocessor"></span><span class="preprocessor">#define INITIAL_RETURN_BUFFER_SIZE       4096</span>
<a name="l00134"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a11">00134</a> <span class="preprocessor"></span><span class="preprocessor">#define RETURN_BUFFER_GROW_SIZE          512</span>
00135 <span class="preprocessor"></span><span class="comment">//</span>
00136 <span class="comment">// This should never have to grow, since 200 is the maximum length of a device</span>
00137 <span class="comment">// instance name...</span>
00138 <span class="comment">//</span>
<a name="l00139"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a12">00139</a> <span class="preprocessor">#define INITIAL_DEVNODE_NAME_BUFFER_SIZE   (FIELD_OFFSET(KEY_VALUE_PARTIAL_INFORMATION, Data) + (200 * sizeof(WCHAR)))</span>
00140 <span class="preprocessor"></span>
00141 <span class="comment">//</span>
00142 <span class="comment">// Definitions for PnpOpenDeviceInterfaceRegistryKey</span>
00143 <span class="comment">//</span>
00144 
<a name="l00145"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">00145</a> <span class="preprocessor">#define KEY_STRING_PREFIX                       TEXT("##?#")</span>
<a name="l00146"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a14">00146</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_STRING_PREFIX_SIZE                  ( sizeof(KEY_STRING_PREFIX) - sizeof(UNICODE_NULL) )</span>
<a name="l00147"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a15">00147</a> <span class="preprocessor"></span><span class="preprocessor">#define KEY_STRING_PREFIX_LENGTH                ( KEY_STRING_PREFIX_SIZE / sizeof(WCHAR) )</span>
00148 <span class="preprocessor"></span><span class="comment">// #define SYMBOLIC_LINK_NAME_PREFIX_SIZE          ( sizeof(L"\\DosDevices\\") - sizeof(UNICODE_NULL) )</span>
00149 <span class="comment">// #define SYMBOLIC_LINK_NAME_PREFIX_LENGTH        ( SYMBOLIC_LINK_NAME_PREFIX_SIZE / sizeof(WCHAR) )</span>
00150 
00151 <span class="comment">//</span>
00152 <span class="comment">// Definitions for PnpRegisterDeviceInterface</span>
00153 <span class="comment">//</span>
00154 
<a name="l00155"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a16">00155</a> <span class="preprocessor">#define SEPERATOR_STRING                   TEXT("\\")</span>
<a name="l00156"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a17">00156</a> <span class="preprocessor"></span><span class="preprocessor">#define SEPERATOR_CHAR                     (L'\\')</span>
<a name="l00157"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a18">00157</a> <span class="preprocessor"></span><span class="preprocessor">#define ALT_SEPERATOR_CHAR                 (L'/')</span>
<a name="l00158"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a19">00158</a> <span class="preprocessor"></span><span class="preprocessor">#define REPLACED_SEPERATOR_STRING          TEXT("#")</span>
<a name="l00159"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a20">00159</a> <span class="preprocessor"></span><span class="preprocessor">#define REPLACED_SEPERATOR_CHAR            (L'#')</span>
<a name="l00160"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">00160</a> <span class="preprocessor"></span><span class="preprocessor">#define USER_SYMLINK_STRING_PREFIX         TEXT("\\\\?\\")</span>
<a name="l00161"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a22">00161</a> <span class="preprocessor"></span><span class="preprocessor">#define USER_SYMLINK_STRING_PREFIX_LENGTH  (( sizeof(USER_SYMLINK_STRING_PREFIX) - sizeof(UNICODE_NULL) ) / sizeof(WCHAR) )</span>
<a name="l00162"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">00162</a> <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_SYMLINK_STRING_PREFIX       TEXT("\\??\\")</span>
<a name="l00163"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a24">00163</a> <span class="preprocessor"></span><span class="preprocessor">#define KERNEL_SYMLINK_STRING_PREFIX_LENGTH (( sizeof(KERNEL_SYMLINK_STRING_PREFIX) - sizeof(UNICODE_NULL) ) / sizeof(WCHAR) )</span>
<a name="l00164"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a25">00164</a> <span class="preprocessor"></span><span class="preprocessor">#define REFSTRING_PREFIX_CHAR              (L'#')</span>
00165 <span class="preprocessor"></span>
00166 <span class="comment">//</span>
00167 <span class="comment">// Definitions for PpCreateLegacyDeviceIds</span>
00168 <span class="comment">//</span>
00169 
<a name="l00170"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a26">00170</a> <span class="preprocessor">#define LEGACY_COMPATIBLE_ID_BASE           TEXT("DETECTED")</span>
00171 <span class="preprocessor"></span>
00172 <span class="comment">//</span>
00173 <span class="comment">// Guid related definitions</span>
00174 <span class="comment">//</span>
00175 
<a name="l00176"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a27">00176</a> <span class="preprocessor">#define GUID_STRING_LENGTH  38</span>
<a name="l00177"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a28">00177</a> <span class="preprocessor"></span><span class="preprocessor">#define GUID_STRING_SIZE    GUID_STRING_LENGTH * sizeof(WCHAR)</span>
00178 <span class="preprocessor"></span>
00179 <span class="comment">//</span>
00180 <span class="comment">// Kernel mode notification data</span>
00181 <span class="comment">//</span>
00182 
<a name="l00183"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">00183</a> LIST_ENTRY <a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[<a class="code" href="../../d9/d0/pnpiop_8h.html#a111">NOTIFY_DEVICE_CLASS_HASH_BUCKETS</a>];
<a name="l00184"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">00184</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>;
<a name="l00185"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">00185</a> <a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">PSETUP_NOTIFY_DATA</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
<a name="l00186"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">00186</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>;
<a name="l00187"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">00187</a> LIST_ENTRY <a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>;
<a name="l00188"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">00188</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>;
<a name="l00189"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">00189</a> <span class="keyword">extern</span> BOOLEAN     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a>;
<a name="l00190"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">00190</a> <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>  <a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>;
00191 <span class="keyword">extern</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a58">PiNotifyUserMode</a>(
00192     PPNP_DEVICE_EVENT_ENTRY DeviceEvent
00193     );
00194 
<a name="l00195"></a><a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">00195</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">_DEFERRED_REGISTRATION_ENTRY</a> {
<a name="l00196"></a><a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o0">00196</a>     LIST_ENTRY            <a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o0">ListEntry</a>;
<a name="l00197"></a><a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">00197</a>     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>  <a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>;
00198 } <a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">DEFERRED_REGISTRATION_ENTRY</a>, *<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">PDEFERRED_REGISTRATION_ENTRY</a>;
<a name="l00199"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">00199</a> LIST_ENTRY <a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>;
<a name="l00200"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">00200</a> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>;
00201 
00202 <span class="comment">//</span>
00203 <span class="comment">// Prototypes</span>
00204 <span class="comment">//</span>
00205 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00206 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(
00207     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
00208     IN PVOID Data,
00209     IN ULONG DataSize
00210     );
00211 
00212 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00213 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a60">IopOverwriteBuffer</a>(
00214     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
00215     IN PVOID Data,
00216     IN ULONG DataSize
00217     );
00218 
00219 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00220 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a61">IopRealloc</a>(
00221     IN OUT PVOID *Buffer,
00222     IN ULONG OldSize,
00223     IN ULONG NewSize
00224     );
00225 
00226 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00227 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(
00228     IN PUNICODE_STRING SymbolicLinkName,
00229     IN ACCESS_MASK DesiredAccess,
00230     OUT PHANDLE DeviceInterfaceClassKey     OPTIONAL,
00231     OUT PHANDLE DeviceInterfaceKey          OPTIONAL,
00232     OUT PHANDLE DeviceInterfaceInstanceKey  OPTIONAL
00233     );
00234 
00235 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00236 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a63">IopBuildSymbolicLinkStrings</a>(
00237     IN PUNICODE_STRING DeviceString,
00238     IN PUNICODE_STRING GuidString,
00239     IN PUNICODE_STRING ReferenceString      OPTIONAL,
00240     OUT PUNICODE_STRING UserString,
00241     OUT PUNICODE_STRING KernelString
00242     );
00243 
00244 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00245 <a class="code" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a>(
00246     OUT PUNICODE_STRING OutString,
00247     IN PUNICODE_STRING InString
00248     );
00249 
00250 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00251 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a65">IopDropReferenceString</a>(
00252     OUT PUNICODE_STRING OutString,
00253     IN PUNICODE_STRING InString
00254     );
00255 
00256 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00257 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(
00258     IN  PUNICODE_STRING SymbolicLinkName,
00259     OUT PUNICODE_STRING PrefixString        OPTIONAL,
00260     OUT PUNICODE_STRING MungedPathString    OPTIONAL,
00261     OUT PUNICODE_STRING GuidString          OPTIONAL,
00262     OUT PUNICODE_STRING RefString           OPTIONAL,
00263     OUT PBOOLEAN        RefStringPresent    OPTIONAL,
00264     OUT LPGUID Guid                         OPTIONAL
00265     );
00266 
00267 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00268 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue</a>(
00269     IN HANDLE KeyHandle,
00270     IN PUNICODE_STRING ValueName,
00271     IN PUNICODE_STRING ValueData
00272     );
00273 
00274 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00275 <a class="code" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification</a>(
00276     VOID
00277     );
00278 
00279 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00280 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>(
00281     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a> notify
00282     );
00283 
00284 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00285 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>(
00286     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a> Notify
00287     );
00288 
00289 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00290 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a71">IopRegisterTargetDeviceNotification</a>(
00291     IN ULONG Flags,
00292     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
00293     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
00294     IN PDRIVER_NOTIFICATION_CALLBACK_ROUTINE CallbackRoutine,
00295     IN PVOID Context,
00296     IN BOOLEAN AddLast,
00297     OUT PVOID *NotificationEntry
00298     );
00299 
00300 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00301 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(
00302     OUT PHANDLE InterfaceKeyHandle           OPTIONAL,
00303     OUT PULONG InterfaceKeyDisposition       OPTIONAL,
00304     OUT PHANDLE InterfaceInstanceKeyHandle   OPTIONAL,
00305     OUT PULONG InterfaceInstanceDisposition  OPTIONAL,
00306     IN HANDLE InterfaceClassKeyHandle,
00307     IN PUNICODE_STRING DeviceInterfaceName,
00308     IN ACCESS_MASK DesiredAccess,
00309     IN BOOLEAN Create
00310     );
00311 
00312 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00313 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a73">PpCreateLegacyDeviceIds</a>(
00314     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00315     IN PUNICODE_STRING DriverName,
00316     IN PCM_RESOURCE_LIST Resources
00317     );
00318 
00319 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00320 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopIsReportedAlready)</span>
00321 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoCreateDriver)</span>
00322 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoDeleteDriver)</span>
00323 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoReportDetectedDevice)</span>
00324 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoOpenDeviceRegistryKey)</span>
00325 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoGetDeviceProperty)</span>
00326 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoRegisterPlugPlayNotification)</span>
00327 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoUnregisterPlugPlayNotification)</span>
00328 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoGetDeviceInterfaces)</span>
00329 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetDeviceInterfaces)</span>
00330 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoSetDeviceInterfaceState)</span>
00331 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoRegisterDeviceInterface)</span>
00332 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRegisterDeviceInterface)</span>
00333 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopUnregisterDeviceInterface)</span>
00334 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveDeviceInterfaces)</span>
00335 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoOpenDeviceInterfaceRegistryKey)</span>
00336 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoGetDeviceInterfaceAlias)</span>
00337 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDeviceInterfaceKeysFromSymbolicLink)</span>
00338 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopBuildSymbolicLinkStrings)</span>
00339 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReplaceSeperatorWithPound)</span>
00340 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateUnicodeString)</span>
00341 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeAllocatedUnicodeString)</span>
00342 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDropReferenceString)</span>
00343 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRealloc)</span>
00344 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopSetRegistryStringValue)</span>
00345 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRegisterTargetDeviceNotification)</span>
00346 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNotifyDeviceClassChange)</span>
00347 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNotifyTargetDeviceChange)</span>
00348 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNotifyHwProfileChange)</span>
00349 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopNotifySetupDeviceArrival)</span>
00350 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRequestHwProfileChangeNotification)</span>
00351 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoNotifyPowerOperationVetoed)</span>
00352 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDereferenceNotify)</span>
00353 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopReferenceNotify)</span>
00354 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopInitializePlugPlayNotification)</span>
00355 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoSynchronousInvalidateDeviceRelations)</span>
00356 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopParseSymbolicLinkName)</span>
00357 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOverwriteBuffer)</span>
00358 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAppendBuffer)</span>
00359 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopFreeBuffer)</span>
00360 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopResizeBuffer)</span>
00361 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateBuffer)</span>
00362 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopOpenOrCreateDeviceInterfaceSubKeys)</span>
00363 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoIsWdmVersionAvailable)</span>
00364 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoGetDmaAdapter)</span>
00365 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopGetRelatedTargetDevice)</span>
00366 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IoGetRelatedTargetDevice)</span>
00367 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopResourceRequirementsChanged)</span>
00368 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PpCreateLegacyDeviceIds)</span>
00369 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopPnPHydraCallback)</span>
00370 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00371 <span class="preprocessor"></span>
00372 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00373"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">00373</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>(
00374     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
00375     IN DEVICE_REGISTRY_PROPERTY DeviceProperty,
00376     IN ULONG BufferLength,
00377     OUT PVOID PropertyBuffer,
00378     OUT PULONG ResultLength
00379     )
00380 
00381 <span class="comment">/*++</span>
00382 <span class="comment"></span>
00383 <span class="comment">Routine Description:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    This routine lets drivers query the registry properties associated with the</span>
00386 <span class="comment">    specified device.</span>
00387 <span class="comment"></span>
00388 <span class="comment">Parameters:</span>
00389 <span class="comment"></span>
00390 <span class="comment">    DeviceObject - Supplies the device object whoes registry property is to be</span>
00391 <span class="comment">                   returned.  This device object should be the one created by</span>
00392 <span class="comment">                   a bus driver.</span>
00393 <span class="comment"></span>
00394 <span class="comment">    DeviceProperty - Specifies what device property to get.</span>
00395 <span class="comment"></span>
00396 <span class="comment">    BufferLength - Specifies the length, in byte, of the PropertyBuffer.</span>
00397 <span class="comment"></span>
00398 <span class="comment">    PropertyBuffer - Supplies a pointer to a buffer to receive property data.</span>
00399 <span class="comment"></span>
00400 <span class="comment">    ResultLength - Supplies a pointer to a variable to receive the size of the</span>
00401 <span class="comment">                   property data returned.</span>
00402 <span class="comment"></span>
00403 <span class="comment">ReturnValue:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    Status code that indicates whether or not the function was successful.  If</span>
00406 <span class="comment">    PropertyBuffer is not big enough to hold requested data, STATUS_BUFFER_TOO_SMALL</span>
00407 <span class="comment">    will be returned and ResultLength will be set to the number of bytes actually</span>
00408 <span class="comment">    required.</span>
00409 <span class="comment"></span>
00410 <span class="comment">--*/</span>
00411 
00412 {
00413     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00414     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">DEVICE_CAPABILITIES</a> capabilities;
00415     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00416     HANDLE handle;
00417     PWSTR valueName, keyName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00419     ULONG valueType;
00420     ULONG length;
00421     POBJECT_NAME_INFORMATION deviceObjectName;
00422     PWSTR deviceInstanceName;
00423     PWCHAR enumeratorNameEnd;
00424 
00425     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00426 
00427     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(DeviceObject);
00428 
00429     <span class="comment">//</span>
00430     <span class="comment">// Initialize out parameters</span>
00431     <span class="comment">//</span>
00432 
00433     *ResultLength = 0;
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// Map Device Property to registry value name and value type.</span>
00437     <span class="comment">//</span>
00438 
00439     <span class="keywordflow">switch</span> (DeviceProperty) {
00440 
00441     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a83">DevicePropertyDeviceDescription</a>:
00442         valueName = REGSTR_VALUE_DEVICE_DESC;
00443         valueType = REG_SZ;
00444         <span class="keywordflow">break</span>;
00445 
00446     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a84">DevicePropertyHardwareID</a>:
00447         valueName = REGSTR_VAL_HARDWAREID;
00448         valueType = REG_MULTI_SZ;
00449         <span class="keywordflow">break</span>;
00450 
00451     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a85">DevicePropertyCompatibleIDs</a>:
00452         valueName = REGSTR_VAL_COMPATIBLEIDS;
00453         valueType = REG_MULTI_SZ;
00454         <span class="keywordflow">break</span>;
00455 
00456     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a86">DevicePropertyBootConfiguration</a>:
00457         keyName   = REGSTR_KEY_LOG_CONF;
00458         valueName = REGSTR_VAL_BOOTCONFIG;
00459         valueType = REG_RESOURCE_LIST;
00460         <span class="keywordflow">break</span>;
00461 
00462     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a87">DevicePropertyBootConfigurationTranslated</a>:
00463         <span class="comment">//</span>
00464         <span class="comment">// BUGBUG(andrewth) - support this!</span>
00465         <span class="comment">//</span>
00466         <span class="keywordflow">return</span> STATUS_NOT_SUPPORTED;
00467         <span class="keywordflow">break</span>;
00468 
00469     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a88">DevicePropertyClassName</a>:
00470         valueName = REGSTR_VALUE_CLASS;
00471         valueType = REG_SZ;
00472         <span class="keywordflow">break</span>;
00473 
00474     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a89">DevicePropertyClassGuid</a>:
00475         valueName = REGSTR_VALUE_CLASSGUID;
00476         valueType = REG_SZ;
00477         <span class="keywordflow">break</span>;
00478 
00479     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a90">DevicePropertyDriverKeyName</a>:
00480         valueName = REGSTR_VALUE_DRIVER;
00481         valueType = REG_SZ;
00482         <span class="keywordflow">break</span>;
00483 
00484     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a91">DevicePropertyManufacturer</a>:
00485         valueName = REGSTR_VAL_MFG;
00486         valueType = REG_SZ;
00487         <span class="keywordflow">break</span>;
00488 
00489     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a92">DevicePropertyFriendlyName</a>:
00490         valueName = REGSTR_VALUE_FRIENDLYNAME;
00491         valueType = REG_SZ;
00492         <span class="keywordflow">break</span>;
00493 
00494     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a93">DevicePropertyLocationInformation</a>:
00495         valueName = REGSTR_VAL_LOCATION_INFORMATION;
00496         valueType = REG_SZ;
00497         <span class="keywordflow">break</span>;
00498 
00499     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a100">DevicePropertyUINumber</a>:
00500         valueName = REGSTR_VAL_UI_NUMBER;
00501         valueType = REG_DWORD;
00502         <span class="keywordflow">break</span>;
00503 
00504     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a94">DevicePropertyPhysicalDeviceObjectName</a>:
00505 
00506         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == (1 &amp; BufferLength));  <span class="comment">// had better be an even length</span>
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Create a buffer for the Obj manager.</span>
00510         <span class="comment">//</span>
00511         length = BufferLength + <span class="keyword">sizeof</span> (OBJECT_NAME_INFORMATION);
00512 
00513         deviceObjectName = (POBJECT_NAME_INFORMATION)
00514                             <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
00515 
00516         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == deviceObjectName) {
00517             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00518         }
00519 
00520         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a> (DeviceObject,
00521                                     deviceObjectName,
00522                                     length,
00523                                     ResultLength);
00524 
00525         <span class="keywordflow">if</span> (STATUS_INFO_LENGTH_MISMATCH == status) {
00526             status = STATUS_BUFFER_TOO_SMALL;
00527         }
00528 
00529         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00530 
00531             <span class="keywordflow">if</span> (deviceObjectName-&gt;Name.Length == 0)  {
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">// PDO has no NAME, probably it's been deleted</span>
00535                 <span class="comment">//</span>
00536                 *ResultLength = 0;
00537 
00538             } <span class="keywordflow">else</span> {
00539 
00540                 *ResultLength = deviceObjectName-&gt;Name.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00541                 <span class="keywordflow">if</span> (*ResultLength &gt; BufferLength) {
00542                     status = STATUS_BUFFER_TOO_SMALL;
00543                 } <span class="keywordflow">else</span> {
00544 
00545                     RtlCopyMemory(PropertyBuffer,
00546                                   deviceObjectName-&gt;Name.Buffer,
00547                                   deviceObjectName-&gt;Name.Length);
00548                     *(PWCHAR) (((PUCHAR) PropertyBuffer) + deviceObjectName-&gt;Name.Length) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00549                 }
00550             }
00551         } <span class="keywordflow">else</span> {
00552             *ResultLength -= <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
00553         }
00554 
00555         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (deviceObjectName);
00556         <span class="keywordflow">return</span> status;
00557 
00558 
00559     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a95">DevicePropertyBusTypeGuid</a>:
00560 
00561         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00562         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o21">ChildBusTypeIndex</a> != 0xffff
00563         &amp;&amp;  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o21">ChildBusTypeIndex</a> &lt; <a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o0">Count</a>) {
00564 
00565             *ResultLength = <span class="keyword">sizeof</span>(GUID);
00566 
00567             <span class="keywordflow">if</span>(*ResultLength &lt;= BufferLength) {
00568 
00569                 RtlCopyMemory(PropertyBuffer,
00570                               &amp;(<a class="code" href="../../d1/d0/pnpdata_8c.html#a22">IopBusTypeGuidList</a>-&gt;<a class="code" href="../../d8/d5/struct__BUS__TYPE__GUID__LIST.html#o2">Guid</a>[deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o21">ChildBusTypeIndex</a>]),
00571                               <span class="keyword">sizeof</span>(GUID));
00572 
00573                 status = STATUS_SUCCESS;
00574 
00575             } <span class="keywordflow">else</span> {
00576 
00577                 status = STATUS_BUFFER_TOO_SMALL;
00578 
00579             }
00580 
00581         } <span class="keywordflow">else</span> {
00582             status = STATUS_OBJECT_NAME_NOT_FOUND;
00583         }
00584 
00585         <span class="keywordflow">return</span> status;
00586 
00587     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a96">DevicePropertyLegacyBusType</a>:
00588 
00589         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00590         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a> != InterfaceTypeUndefined) {
00591 
00592             *ResultLength = <span class="keyword">sizeof</span>(INTERFACE_TYPE);
00593 
00594             <span class="keywordflow">if</span>(*ResultLength &lt;= BufferLength) {
00595 
00596                 *(PINTERFACE_TYPE)PropertyBuffer = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a>;
00597                 status = STATUS_SUCCESS;
00598 
00599             } <span class="keywordflow">else</span> {
00600                 status = STATUS_BUFFER_TOO_SMALL;
00601             }
00602 
00603         } <span class="keywordflow">else</span> {
00604             status = STATUS_OBJECT_NAME_NOT_FOUND;
00605         }
00606 
00607         <span class="keywordflow">return</span> status;
00608 
00609     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a97">DevicePropertyBusNumber</a>:
00610 
00611         <span class="comment">//</span>
00612         <span class="comment">// Retrieve the property from the parent's devnode field.</span>
00613         <span class="comment">//</span>
00614 
00615         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00616         <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a> &amp; 0x80000000) != 0x80000000) {
00617 
00618             *ResultLength = <span class="keyword">sizeof</span>(ULONG);
00619 
00620             <span class="keywordflow">if</span>(*ResultLength &lt;= BufferLength) {
00621 
00622                 *(PULONG)PropertyBuffer = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a>;
00623                 status = STATUS_SUCCESS;
00624 
00625             } <span class="keywordflow">else</span> {
00626                 status = STATUS_BUFFER_TOO_SMALL;
00627             }
00628 
00629         } <span class="keywordflow">else</span> {
00630             status = STATUS_OBJECT_NAME_NOT_FOUND;
00631         }
00632 
00633         <span class="keywordflow">return</span> status;
00634 
00635     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a98">DevicePropertyEnumeratorName</a>:
00636 
00637         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (0 == (1 &amp; BufferLength));  <span class="comment">// had better be an even length</span>
00638 
00639         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00640         deviceInstanceName = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer;
00641 
00642         <span class="comment">//</span>
00643         <span class="comment">// There should always be a string here, except for (possibly)</span>
00644         <span class="comment">// HTREE\Root\0, but no one should ever be calling us with that PDO</span>
00645         <span class="comment">// anyway.</span>
00646         <span class="comment">//</span>
00647         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (deviceInstanceName);
00648 
00649         <span class="comment">//</span>
00650         <span class="comment">// We know we're going to find a separator character (\) in the string,</span>
00651         <span class="comment">// so the fact that unicode strings may not be null-terminated isn't</span>
00652         <span class="comment">// a problem.</span>
00653         <span class="comment">//</span>
00654         enumeratorNameEnd = wcschr(deviceInstanceName, OBJ_NAME_PATH_SEPARATOR);
00655         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (enumeratorNameEnd);
00656 
00657         <span class="comment">//</span>
00658         <span class="comment">// Compute required length, minus null terminating character.</span>
00659         <span class="comment">//</span>
00660         length = (ULONG)((PUCHAR)enumeratorNameEnd - (PUCHAR)deviceInstanceName);
00661 
00662         <span class="comment">//</span>
00663         <span class="comment">// Store required length in caller-supplied OUT parameter.</span>
00664         <span class="comment">//</span>
00665         *ResultLength = length + <span class="keyword">sizeof</span>(UNICODE_NULL);
00666 
00667         <span class="keywordflow">if</span>(*ResultLength &gt; BufferLength) {
00668             status = STATUS_BUFFER_TOO_SMALL;
00669         } <span class="keywordflow">else</span> {
00670             memcpy((PUCHAR)PropertyBuffer, (PUCHAR)deviceInstanceName, length);
00671             *(PWCHAR)((PUCHAR)PropertyBuffer + length) = UNICODE_NULL;
00672             status = STATUS_SUCCESS;
00673         }
00674 
00675         <span class="keywordflow">return</span> status;
00676 
00677     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a170a99">DevicePropertyAddress</a>:
00678 
00679         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00680 
00681         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a330">IopQueryDeviceCapabilities</a>(deviceNode, &amp;capabilities);
00682 
00683         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o21">Address</a> != 0xFFFFFFFF)) {
00684 
00685             *ResultLength = <span class="keyword">sizeof</span>(ULONG);
00686 
00687             <span class="keywordflow">if</span>(*ResultLength &lt;= BufferLength) {
00688 
00689                 *(PULONG)PropertyBuffer = capabilities.<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o21">Address</a>;
00690                 status = STATUS_SUCCESS;
00691 
00692             } <span class="keywordflow">else</span> {
00693                 status = STATUS_BUFFER_TOO_SMALL;
00694             }
00695 
00696         } <span class="keywordflow">else</span> {
00697             status = STATUS_OBJECT_NAME_NOT_FOUND;
00698         }
00699 
00700         <span class="keywordflow">return</span> status;
00701 
00702     <span class="keywordflow">default</span>:
00703         status = STATUS_INVALID_PARAMETER_2;
00704         <span class="keywordflow">goto</span> clean0;
00705     }
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
00709     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
00710     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
00711     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
00712     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulatio</span>
00713     <span class="comment">// portion solves this problem</span>
00714     <span class="comment">//</span>
00715 
00716     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00717     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00718 
00719     <span class="comment">//</span>
00720     <span class="comment">// Based on the PDO specified by caller, find the handle of its device</span>
00721     <span class="comment">// instance registry key.</span>
00722     <span class="comment">//</span>
00723 
00724     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(DeviceObject, &amp;handle, KEY_READ);
00725     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00726         <span class="keywordflow">goto</span> clean1;
00727     }
00728 
00729     <span class="comment">//</span>
00730     <span class="comment">// If the data is stored in a subkey then open this key and close the old one</span>
00731     <span class="comment">//</span>
00732 
00733     <span class="keywordflow">if</span> (keyName) {
00734         HANDLE subKeyHandle;
00735         UNICODE_STRING unicodeKey;
00736 
00737         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeKey, keyName);
00738         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;subKeyHandle,
00739                                        handle,
00740                                        &amp;unicodeKey,
00741                                        KEY_READ
00742                                        );
00743 
00744         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
00745             ZwClose(handle);
00746             handle = subKeyHandle;
00747         } <span class="keywordflow">else</span> {
00748             <span class="keywordflow">goto</span> clean2;
00749         }
00750 
00751     }
00752 
00753     <span class="comment">//</span>
00754     <span class="comment">// Read the registry value of the desired value name</span>
00755     <span class="comment">//</span>
00756 
00757     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a> (handle,
00758                                   valueName,
00759                                   &amp;keyValueInformation);
00760 
00761 
00762     <span class="comment">//</span>
00763     <span class="comment">// We have finished using the registry so clean up and release our resources</span>
00764     <span class="comment">//</span>
00765 
00766 clean2:
00767     ZwClose(handle);
00768 clean1:
00769     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
00770     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00771 
00772     <span class="comment">//</span>
00773     <span class="comment">// If we have been sucessful finding the info hand it back to the caller</span>
00774     <span class="comment">//</span>
00775 
00776     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00777 
00778         <span class="comment">//</span>
00779         <span class="comment">// Return the length of the data (or the required length if the buffer is too small)</span>
00780         <span class="comment">//</span>
00781 
00782         *ResultLength = keyValueInformation-&gt;DataLength;
00783 
00784         <span class="comment">//</span>
00785         <span class="comment">// Check that the buffer we have been given is big enough and that the value returned is</span>
00786         <span class="comment">// of the correct registry type</span>
00787         <span class="comment">//</span>
00788 
00789         <span class="keywordflow">if</span> (keyValueInformation-&gt;DataLength &lt;= BufferLength) {
00790             <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == valueType) {
00791                 RtlCopyMemory(PropertyBuffer,
00792                               <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation),
00793                               keyValueInformation-&gt;DataLength);
00794 
00795             } <span class="keywordflow">else</span> {
00796                status = STATUS_INVALID_PARAMETER_2;
00797             }
00798         } <span class="keywordflow">else</span> {
00799             status = STATUS_BUFFER_TOO_SMALL;
00800         }
00801 
00802         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00803     }
00804 
00805 clean0:
00806     <span class="keywordflow">return</span> status;
00807 }
00808 
00809 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00810"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a75">00810</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a75">IoOpenDeviceRegistryKey</a>(
00811     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
00812     IN ULONG DevInstKeyType,
00813     IN ACCESS_MASK DesiredAccess,
00814     OUT PHANDLE DevInstRegKey
00815     )
00816 
00817 <span class="comment">/*++</span>
00818 <span class="comment"></span>
00819 <span class="comment">Routine Description:</span>
00820 <span class="comment"></span>
00821 <span class="comment">    This routine returns a handle to an opened registry key that the driver</span>
00822 <span class="comment">    may use to store/retrieve configuration information specific to a particular</span>
00823 <span class="comment">    device instance.</span>
00824 <span class="comment"></span>
00825 <span class="comment">    The driver must call ZwClose to close the handle returned from this api</span>
00826 <span class="comment">    when access is no longer required.</span>
00827 <span class="comment"></span>
00828 <span class="comment">Parameters:</span>
00829 <span class="comment"></span>
00830 <span class="comment">    DeviceObject   - Supples the device object of the physical device instance to</span>
00831 <span class="comment">                     open a registry storage key for.  Normally it is a device object</span>
00832 <span class="comment">                     created by the hal bus extender.</span>
00833 <span class="comment"></span>
00834 <span class="comment">    DevInstKeyType - Supplies flags specifying which storage key associated with</span>
00835 <span class="comment">                     the device instance is to be opened.  May be a combination of</span>
00836 <span class="comment">                     the following value:</span>
00837 <span class="comment"></span>
00838 <span class="comment">                     PLUGPLAY_REGKEY_DEVICE - Open a key for storing device specific</span>
00839 <span class="comment">                         (driver-independent) information relating to the device instance.</span>
00840 <span class="comment">                         The flag may not be specified with PLUGPLAY_REGKEY_DRIVER.</span>
00841 <span class="comment"></span>
00842 <span class="comment">                     PLUGPLAY_REGKEY_DRIVER - Open a key for storing driver-specific</span>
00843 <span class="comment">                         information relating to the device instance,  This flag may</span>
00844 <span class="comment">                         not be specified with PLUGPLAY_REGKEY_DEVICE.</span>
00845 <span class="comment"></span>
00846 <span class="comment">                     PLUGPLAY_REGKEY_CURRENT_HWPROFILE - If this flag is specified,</span>
00847 <span class="comment">                         then a key in the current hardware profile branch will be</span>
00848 <span class="comment">                         opened for the specified storage type.  This allows the driver</span>
00849 <span class="comment">                         to access configuration information that is hardware profile</span>
00850 <span class="comment">                         specific.</span>
00851 <span class="comment"></span>
00852 <span class="comment">    DesiredAccess - Specifies the access mask for the key to be opened.</span>
00853 <span class="comment"></span>
00854 <span class="comment">    DevInstRegKey - Supplies the address of a variable that receives a handle to the</span>
00855 <span class="comment">                    opened key for the specified registry storage location.</span>
00856 <span class="comment"></span>
00857 <span class="comment">Return Value:</span>
00858 <span class="comment"></span>
00859 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
00860 <span class="comment"></span>
00861 <span class="comment">--*/</span>
00862 
00863 {
00864 
00865     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, appendStatus;
00866     HANDLE hBasePath;
00867     UNICODE_STRING unicodeBasePath, unicodeRestPath;
00868 
00869     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00870 
00871     <span class="comment">//</span>
00872     <span class="comment">// Until SCSIPORT stops passing non PDOs allow the system to boot.</span>
00873     <span class="comment">//</span>
00874     <span class="comment">// ASSERT_PDO(PhysicalDeviceObject);</span>
00875     <span class="comment">//</span>
00876 
00877     <span class="comment">//</span>
00878     <span class="comment">// Initialise out parameters</span>
00879     <span class="comment">//</span>
00880 
00881     *DevInstRegKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">// Allocate a buffer to build the RestPath string in</span>
00885     <span class="comment">//</span>
00886 
00887     <span class="keywordflow">if</span>(!(unicodeRestPath.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a5">MAX_RESTPATH_BUF_LEN</a>))) {
00888         status = STATUS_INSUFFICIENT_RESOURCES;
00889         <span class="keywordflow">goto</span> clean0;
00890     }
00891 
00892     unicodeRestPath.Length=0;
00893     unicodeRestPath.MaximumLength=<a class="code" href="../../d8/d0/pnpioapi_8c.html#a5">MAX_RESTPATH_BUF_LEN</a>;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Select the base path to the CurrentControlSet based on if we are dealing with</span>
00897     <span class="comment">// a hardware profile or not</span>
00898     <span class="comment">//</span>
00899 
00900     <span class="keywordflow">if</span>(DevInstKeyType &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a4">PLUGPLAY_REGKEY_CURRENT_HWPROFILE</a>) {
00901         PiWstrToUnicodeString(&amp;unicodeBasePath, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a1">PATH_CURRENTCONTROLSET_HW_PROFILE_CURRENT</a>);
00902 
00903     } <span class="keywordflow">else</span> {
00904         PiWstrToUnicodeString(&amp;unicodeBasePath, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a2">PATH_CURRENTCONTROLSET</a>);
00905     }
00906 
00907     <span class="comment">//</span>
00908     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
00909     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
00910     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
00911     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
00912     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
00913     <span class="comment">// portion solves this problem</span>
00914     <span class="comment">//</span>
00915 
00916     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00917     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00918 
00919     <span class="comment">//</span>
00920     <span class="comment">// Open the base registry key</span>
00921     <span class="comment">//</span>
00922 
00923     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hBasePath,
00924                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00925                                    &amp;unicodeBasePath,
00926                                    KEY_READ
00927                                    );
00928 
00929     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00930         <span class="keywordflow">goto</span> clean1;
00931     }
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">// Build the RestPath string</span>
00935     <span class="comment">//</span>
00936 
00937     <span class="keywordflow">switch</span> (DevInstKeyType) {
00938 
00939     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a2">PLUGPLAY_REGKEY_DEVICE</a>:
00940     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a2">PLUGPLAY_REGKEY_DEVICE</a> + <a class="code" href="../../d6/d9/pnp_8h.html#a4">PLUGPLAY_REGKEY_CURRENT_HWPROFILE</a>:
00941         {
00942             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> pDeviceNode;
00943 
00944             <span class="comment">//</span>
00945             <span class="comment">// Initialise the rest path with Enum\</span>
00946             <span class="comment">//</span>
00947 
00948             appendStatus = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;unicodeRestPath, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a3">PATH_ENUM</a>);
00949             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( appendStatus ));
00950             <span class="comment">//</span>
00951             <span class="comment">// Get the Enumerator\DeviceID\InstanceID path from the DeviceNode</span>
00952             <span class="comment">//</span>
00953 
00954             pDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
00955 
00956             <span class="comment">//</span>
00957             <span class="comment">// Ensure this is a PDO and not an FDO (only PDO's have a DeviceNode)</span>
00958             <span class="comment">//</span>
00959 
00960             <span class="keywordflow">if</span> (pDeviceNode) {
00961                 appendStatus = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;unicodeRestPath, &amp;(pDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>));
00962                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( appendStatus ));
00963             } <span class="keywordflow">else</span> {
00964                 status = STATUS_INVALID_DEVICE_REQUEST;
00965             }
00966 
00967             <span class="keywordflow">break</span>;
00968         }
00969 
00970     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a3">PLUGPLAY_REGKEY_DRIVER</a>:
00971     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a3">PLUGPLAY_REGKEY_DRIVER</a> + <a class="code" href="../../d6/d9/pnp_8h.html#a4">PLUGPLAY_REGKEY_CURRENT_HWPROFILE</a>:
00972         {
00973 
00974             HANDLE hDeviceKey;
00975             PKEY_VALUE_FULL_INFORMATION pDriverKeyInfo;
00976 
00977             <span class="comment">//</span>
00978             <span class="comment">// Initialise the rest path with Control\Class\</span>
00979             <span class="comment">//</span>
00980 
00981             appendStatus = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;unicodeRestPath, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a4">PATH_CONTROL_CLASS</a>);
00982             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( appendStatus ));
00983 
00984             <span class="comment">//</span>
00985             <span class="comment">// Open the device instance key for this device</span>
00986             <span class="comment">//</span>
00987 
00988             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(PhysicalDeviceObject, &amp;hDeviceKey, KEY_READ);
00989 
00990             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
00991                 <span class="keywordflow">goto</span> clean1;
00992             }
00993 
00994             <span class="comment">//</span>
00995             <span class="comment">// See if we have a driver value</span>
00996             <span class="comment">//</span>
00997 
00998             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hDeviceKey, REGSTR_VALUE_DRIVER, &amp;pDriverKeyInfo );
00999 
01000             <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
01001 
01002                 <span class="keywordflow">if</span>(pDriverKeyInfo-&gt;Type == REG_SZ) {
01003 
01004                 <span class="comment">//</span>
01005                 <span class="comment">// Append &lt;DevInstClass&gt;&lt;ClassInstanceOrdinal&gt;</span>
01006                 <span class="comment">//</span>
01007 
01008                 appendStatus = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;unicodeRestPath, (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pDriverKeyInfo));
01009                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( appendStatus ));
01010 
01011                 } <span class="keywordflow">else</span> {
01012                     <span class="comment">//</span>
01013                     <span class="comment">// We have a driver key with a non REG_SZ type - something is wrong - blame the PDO!</span>
01014                     <span class="comment">//</span>
01015 
01016                     status = STATUS_INVALID_PARAMETER_1;
01017                 }
01018 
01019                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDriverKeyInfo);
01020             }
01021 
01022             ZwClose(hDeviceKey);
01023 
01024             <span class="keywordflow">break</span>;
01025         }
01026     <span class="keywordflow">default</span>:
01027         status = STATUS_INVALID_PARAMETER_3;
01028         <span class="keywordflow">goto</span> clean2;
01029     }
01030 
01031 
01032     <span class="comment">//</span>
01033     <span class="comment">// If we succeeded in building the rest path then open the key and hand it back to the caller</span>
01034     <span class="comment">//</span>
01035 
01036     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
01037         <span class="keywordflow">if</span> (DevInstKeyType == <a class="code" href="../../d6/d9/pnp_8h.html#a2">PLUGPLAY_REGKEY_DEVICE</a>) {
01038 
01039             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a304">IopOpenDeviceParametersSubkey</a>(DevInstRegKey,
01040                                                    hBasePath,
01041                                                    &amp;unicodeRestPath,
01042                                                    DesiredAccess);
01043         } <span class="keywordflow">else</span> {
01044 
01045             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( DevInstRegKey,
01046                                              hBasePath,
01047                                              &amp;unicodeRestPath,
01048                                              DesiredAccess,
01049                                              REG_OPTION_NON_VOLATILE,
01050                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01051                                              );
01052         }
01053     }
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">// Free up resources</span>
01057     <span class="comment">//</span>
01058 
01059 clean2:
01060     ZwClose(hBasePath);
01061 clean1:
01062     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01063     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01064     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(unicodeRestPath.Buffer);
01065 clean0:
01066     <span class="keywordflow">return</span> status;
01067 
01068 }
01069 
01070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01071"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a76">01071</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a76">IoCreateDriver</a>(
01072     IN PUNICODE_STRING DriverName    OPTIONAL,
01073     IN PDRIVER_INITIALIZE InitializationFunction
01074     )
01075 <span class="comment">/*++</span>
01076 <span class="comment"></span>
01077 <span class="comment">Routine Description:</span>
01078 <span class="comment"></span>
01079 <span class="comment">    This routine creates a driver object for a kernel component that</span>
01080 <span class="comment">    was not loaded as a driver.  If the creation of the driver object</span>
01081 <span class="comment">    succeeds, Initialization function is invoked with the same parameters</span>
01082 <span class="comment">    as passed to DriverEntry.</span>
01083 <span class="comment"></span>
01084 <span class="comment">Parameters:</span>
01085 <span class="comment"></span>
01086 <span class="comment">    DriverName - Supplies the name of the driver for which a driver object</span>
01087 <span class="comment">                 is to be created.</span>
01088 <span class="comment"></span>
01089 <span class="comment">    InitializationFunction - Equivalent to DriverEntry().</span>
01090 <span class="comment"></span>
01091 <span class="comment">ReturnValue:</span>
01092 <span class="comment"></span>
01093 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01094 <span class="comment"></span>
01095 <span class="comment">Notes:</span>
01096 <span class="comment"></span>
01097 <span class="comment">--*/</span>
01098 {
01099     OBJECT_ATTRIBUTES objectAttributes;
01100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01101     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
01102     HANDLE driverHandle;
01103     ULONG objectSize;
01104     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> length;
01105     UNICODE_STRING driverName, serviceName;
01106     WCHAR buffer[60];
01107     ULONG i;
01108 
01109     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01110 
01111     <span class="keywordflow">if</span> (DriverName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01112 
01113         <span class="comment">//</span>
01114         <span class="comment">// Madeup a name for the driver object.</span>
01115         <span class="comment">//</span>
01116 
01117         length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\%08u"</span>, <a class="code" href="../../d4/d9/ke_8h.html#a147">KeTickCount</a>);
01118         driverName.Length = length * <span class="keyword">sizeof</span>(WCHAR);
01119         driverName.MaximumLength = driverName.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
01120         driverName.Buffer = buffer;                                                           \
01121     } <span class="keywordflow">else</span> {
01122         driverName = *DriverName;
01123     }
01124 
01125     <span class="comment">//</span>
01126     <span class="comment">// Attempt to create the driver object</span>
01127     <span class="comment">//</span>
01128 
01129     InitializeObjectAttributes( &amp;objectAttributes,
01130                                 &amp;driverName,
01131                                 OBJ_PERMANENT | OBJ_CASE_INSENSITIVE,
01132                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01133                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01134 
01135     objectSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> ) + <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">DRIVER_EXTENSION</a> );
01136     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01137                              <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
01138                              &amp;objectAttributes,
01139                              <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01140                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01141                              objectSize,
01142                              0,
01143                              0,
01144                              &amp;driverObject );
01145 
01146     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )){
01147 
01148         <span class="comment">//</span>
01149         <span class="comment">// Driver object creation failed</span>
01150         <span class="comment">//</span>
01151 
01152         <span class="keywordflow">return</span> status;
01153     }
01154 
01155     <span class="comment">//</span>
01156     <span class="comment">// We've created a driver object, initialize it.</span>
01157     <span class="comment">//</span>
01158 
01159     RtlZeroMemory( driverObject, objectSize );
01160     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a> = (<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html">PDRIVER_EXTENSION</a>)(driverObject + 1);
01161     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o0">DriverObject</a> = driverObject;
01162     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a3">IO_TYPE_DRIVER</a>;
01163     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> );
01164     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> = <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>;
01165     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d0/d5/io_8h.html#a42">IRP_MJ_MAXIMUM_FUNCTION</a>; i++)
01166         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o14">MajorFunction</a>[i] = <a class="code" href="../../d2/d4/internal_8c.html#a45">IopInvalidDeviceRequest</a>;
01167     driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o11">DriverInit</a> = InitializationFunction;
01168 
01169     serviceName.Buffer = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, driverName.Length + <span class="keyword">sizeof</span>(WCHAR));
01170     <span class="keywordflow">if</span> (serviceName.Buffer) {
01171         serviceName.MaximumLength = driverName.Length + <span class="keyword">sizeof</span>(WCHAR);
01172         serviceName.Length = driverName.Length;
01173         RtlMoveMemory(serviceName.Buffer, driverName.Buffer, driverName.Length);
01174         serviceName.Buffer[serviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01175         driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a> = serviceName;
01176     } <span class="keywordflow">else</span> {
01177         status = STATUS_INSUFFICIENT_RESOURCES;
01178         <span class="keywordflow">goto</span> errorFreeDriverObject;
01179     }
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">// Insert it into the object table.</span>
01183     <span class="comment">//</span>
01184 
01185     status = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( driverObject,
01186                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01187                              FILE_READ_DATA,
01188                              0,
01189                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01190                              &amp;driverHandle );
01191 
01192     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )){
01193 
01194         <span class="comment">//</span>
01195         <span class="comment">// Couldn't insert the driver object into the table.</span>
01196         <span class="comment">// The object got dereferenced by the object manager. Just exit</span>
01197         <span class="comment">//</span>
01198 
01199         <span class="keywordflow">goto</span> errorReturn;
01200     }
01201 
01202     <span class="comment">//</span>
01203     <span class="comment">// Reference the handle and obtain a pointer to the driver object so that</span>
01204     <span class="comment">// the handle can be deleted without the object going away.</span>
01205     <span class="comment">//</span>
01206 
01207     status = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( driverHandle,
01208                                         0,
01209                                         <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
01210                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01211                                         (PVOID *) &amp;driverObject,
01212                                         (<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">POBJECT_HANDLE_INFORMATION</a>) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01213     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
01214        <span class="comment">//</span>
01215        <span class="comment">// Backout here is probably bogus. If the ref didn't work then the handle is probably bad</span>
01216        <span class="comment">// Do this right though just in case there are other common error returns for ObRef...</span>
01217        <span class="comment">//</span>
01218        ZwMakeTemporaryObject( driverHandle ); <span class="comment">// Cause handle close to free the object</span>
01219        ZwClose( driverHandle ); <span class="comment">// Close the handle.</span>
01220        <span class="keywordflow">goto</span> errorReturn;
01221     }
01222 
01223     ZwClose( driverHandle );
01224 
01225     <span class="comment">//</span>
01226     <span class="comment">// Store the name of the device driver in the driver object so that it</span>
01227     <span class="comment">// can be easily found by the error log thread.</span>
01228     <span class="comment">//</span>
01229 
01230     driverObject-&gt;DriverName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
01231                                                       driverName.MaximumLength );
01232     <span class="keywordflow">if</span> (driverObject-&gt;DriverName.Buffer) {
01233         driverObject-&gt;DriverName.MaximumLength = driverName.MaximumLength;
01234         driverObject-&gt;DriverName.Length = driverName.Length;
01235 
01236         RtlCopyMemory( driverObject-&gt;DriverName.Buffer,
01237                        driverName.Buffer,
01238                        driverName.MaximumLength );
01239     }
01240 
01241     <span class="comment">//</span>
01242     <span class="comment">// Call the driver initialization routine</span>
01243     <span class="comment">//</span>
01244 
01245     status = (*InitializationFunction)(driverObject, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01246 
01247     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )){
01248 
01249 errorFreeDriverObject:
01250 
01251         <span class="comment">//</span>
01252         <span class="comment">// If we were unsuccessful, we need to get rid of the driverObject</span>
01253         <span class="comment">// that we created.</span>
01254         <span class="comment">//</span>
01255 
01256         <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( driverObject );
01257         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( driverObject );
01258     }
01259 errorReturn:
01260     <span class="keywordflow">return</span> status;
01261 }
01262 
01263 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01264"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a77">01264</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a77">IoDeleteDriver</a>(
01265     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject
01266     )
01267 <span class="comment">/*++</span>
01268 <span class="comment"></span>
01269 <span class="comment">Routine Description:</span>
01270 <span class="comment"></span>
01271 <span class="comment">    This routine deletes a driver object created explicitly through</span>
01272 <span class="comment">    IoCreateDriver.</span>
01273 <span class="comment"></span>
01274 <span class="comment">Parameters:</span>
01275 <span class="comment"></span>
01276 <span class="comment">    DriverObject - Supplies a pointer to the driver object to be deleted.</span>
01277 <span class="comment"></span>
01278 <span class="comment">ReturnValue:</span>
01279 <span class="comment"></span>
01280 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01281 <span class="comment"></span>
01282 <span class="comment">Notes:</span>
01283 <span class="comment"></span>
01284 <span class="comment">--*/</span>
01285 {
01286 
01287     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DriverObject);
01288 }
01289 
01290 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01291"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a78">01291</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a78">IoSynchronousInvalidateDeviceRelations</a>(
01292     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01293     DEVICE_RELATION_TYPE Type
01294     )
01295 
01296 <span class="comment">/*++</span>
01297 <span class="comment"></span>
01298 <span class="comment">Routine Description:</span>
01299 <span class="comment"></span>
01300 <span class="comment">    This API notifies the system that changes have occurred in the device</span>
01301 <span class="comment">    relations of the specified type for the supplied DeviceObject.   All</span>
01302 <span class="comment">    cached information concerning the relationships must be invalidated,</span>
01303 <span class="comment">    and if needed re-obtained via IRP_MN_QUERY_DEVICE_RELATIONS.</span>
01304 <span class="comment"></span>
01305 <span class="comment">    This routine performs device enumeration synchronously.</span>
01306 <span class="comment">    Note, A driver can NOT call this IO api while processing pnp irps AND</span>
01307 <span class="comment">    A driver can NOT call this api from any system thread except the system</span>
01308 <span class="comment">    threads created by the driver itself.</span>
01309 <span class="comment"></span>
01310 <span class="comment">Parameters:</span>
01311 <span class="comment"></span>
01312 <span class="comment">    DeviceObject - the PDEVICE_OBJECT for which the specified relation type</span>
01313 <span class="comment">                   information has been invalidated.  This pointer is valid</span>
01314 <span class="comment">                   for the duration of the call.</span>
01315 <span class="comment"></span>
01316 <span class="comment">    Type - specifies the type of the relation being invalidated.</span>
01317 <span class="comment"></span>
01318 <span class="comment">ReturnValue:</span>
01319 <span class="comment"></span>
01320 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01321 <span class="comment"></span>
01322 <span class="comment">--*/</span>
01323 
01324 {
01325     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01326     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01327     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> completionEvent;
01328 
01329     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01330 
01331     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(DeviceObject);
01332 
01333     <span class="keywordflow">switch</span> (Type) {
01334     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>:
01335 
01336         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a>) {
01337 
01338             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01339 
01340             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
01341 
01342                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;completionEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01343 
01344                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( DeviceObject,
01345                                                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>,
01346                                                  &amp;completionEvent,
01347                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01348 
01349                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01350 
01351                     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;completionEvent,
01352                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
01353                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01354                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01355                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01356                 }
01357             } <span class="keywordflow">else</span> {
01358                 status = STATUS_UNSUCCESSFUL;
01359             }
01360         } <span class="keywordflow">else</span> {
01361             <span class="comment">//</span>
01362             <span class="comment">// BUGBUG - This check may be too much.  For now ...</span>
01363             <span class="comment">//</span>
01364 
01365             status = STATUS_UNSUCCESSFUL;  <span class="comment">// BUGBUG- better status code</span>
01366         }
01367 
01368 
01369         <span class="keywordflow">break</span>;
01370 
01371     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>:
01372 
01373         <span class="comment">//</span>
01374         <span class="comment">// For Ejection relation change, we will ignore it.  We don't keep track</span>
01375         <span class="comment">// the Ejection relation.  We will query the Ejection relation only when</span>
01376         <span class="comment">// we are requested to eject a device.</span>
01377         <span class="comment">//</span>
01378 
01379         status = STATUS_NOT_SUPPORTED;
01380         <span class="keywordflow">break</span>;
01381 
01382     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>:
01383 
01384 
01385         <span class="comment">//</span>
01386         <span class="comment">// Call off to Po code, which will do the right thing</span>
01387         <span class="comment">//</span>
01388         <a class="code" href="../../d1/d2/po_8h.html#a65">PoInvalidateDevicePowerRelations</a>(DeviceObject);
01389         <span class="keywordflow">break</span>;
01390     }
01391     <span class="keywordflow">return</span> status;
01392 }
01393 
01394 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01395"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">01395</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a79">IoInvalidateDeviceRelations</a>(
01396     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
01397     DEVICE_RELATION_TYPE Type
01398     )
01399 
01400 <span class="comment">/*++</span>
01401 <span class="comment"></span>
01402 <span class="comment">Routine Description:</span>
01403 <span class="comment"></span>
01404 <span class="comment">    This API notifies the system that changes have occurred in the device</span>
01405 <span class="comment">    relations of the specified type for the supplied DeviceObject.   All</span>
01406 <span class="comment">    cached information concerning the relationships must be invalidated,</span>
01407 <span class="comment">    and if needed re-obtained via IRP_MN_QUERY_DEVICE_RELATIONS.</span>
01408 <span class="comment"></span>
01409 <span class="comment">Parameters:</span>
01410 <span class="comment"></span>
01411 <span class="comment">    DeviceObject - the PDEVICE_OBJECT for which the specified relation type</span>
01412 <span class="comment">                   information has been invalidated.  This pointer is valid</span>
01413 <span class="comment">                   for the duration of the call.</span>
01414 <span class="comment"></span>
01415 <span class="comment">    Type - specifies the type of the relation being invalidated.</span>
01416 <span class="comment"></span>
01417 <span class="comment">ReturnValue:</span>
01418 <span class="comment"></span>
01419 <span class="comment">    none.</span>
01420 <span class="comment"></span>
01421 <span class="comment">--*/</span>
01422 
01423 {
01424 
01425     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01426     KIRQL        oldIrql;
01427 
01428     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(DeviceObject);
01429 
01430     <span class="keywordflow">switch</span> (Type) {
01431     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a412">BusRelations</a>:
01432 
01433         <span class="comment">//</span>
01434         <span class="comment">// If the call was made before PnP completes device enumeration</span>
01435         <span class="comment">// we can safely ignore it.  PnP manager will do it without</span>
01436         <span class="comment">// driver's request.</span>
01437         <span class="comment">//</span>
01438 
01439         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01440         <span class="keywordflow">if</span> (deviceNode) {
01441 
01442             ExAcquireSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, &amp;oldIrql);
01443             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a27">DNF_BEING_ENUMERATED</a>) {
01444                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a26">DNF_IO_INVALIDATE_DEVICE_RELATIONS_PENDING</a>;
01445                 ExReleaseSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, oldIrql);
01446             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>)                       &amp;&amp;
01447                 !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a>)) {
01448                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a28">DNF_ENUMERATION_REQUEST_QUEUED</a>;
01449                 ExReleaseSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, oldIrql);
01450 
01451                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( DeviceObject,
01452                                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a218">ReenumerateDeviceTree</a>,
01453                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01454                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01455             } <span class="keywordflow">else</span> {
01456                 ExReleaseSpinLock(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a7">IopPnPSpinLock</a>, oldIrql);
01457             }
01458         }
01459         <span class="keywordflow">break</span>;
01460 
01461     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a413">EjectionRelations</a>:
01462 
01463         <span class="comment">//</span>
01464         <span class="comment">// For Ejection relation change, we will ignore it.  We don't keep track</span>
01465         <span class="comment">// the Ejection relation.  We will query the Ejection relation only when</span>
01466         <span class="comment">// we are requested to eject a device.</span>
01467 
01468         <span class="keywordflow">break</span>;
01469 
01470     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a602a414">PowerRelations</a>:
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">// Call off to Po code, which will do the right thing</span>
01474         <span class="comment">//</span>
01475         <a class="code" href="../../d1/d2/po_8h.html#a65">PoInvalidateDevicePowerRelations</a>(DeviceObject);
01476         <span class="keywordflow">break</span>;
01477     }
01478 }
01479 
01480 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01481"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a80">01481</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a80">IoRequestDeviceEject</a>(
01482     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject
01483     )
01484 
01485 <span class="comment">/*++</span>
01486 <span class="comment"></span>
01487 <span class="comment">Routine Description:</span>
01488 <span class="comment"></span>
01489 <span class="comment">    This API notifies that the device eject button has been pressed. This API must</span>
01490 <span class="comment">    be called at IRQL &lt;= DISPATCH_LEVEL.</span>
01491 <span class="comment"></span>
01492 <span class="comment">    This API informs PnP that a device eject has been requested, the device will</span>
01493 <span class="comment">    not necessarily be ejected as a result of this API.  The device will only be</span>
01494 <span class="comment">    ejected if the drivers associated with it agree to stop and the device is</span>
01495 <span class="comment">    successfully powered down.  Note that eject in this context refers to device</span>
01496 <span class="comment">    eject, not to media (floppies, cds, tapes) eject.  For example, eject of a</span>
01497 <span class="comment">    cd-rom disk drive, not ejection of a cd-rom disk.</span>
01498 <span class="comment"></span>
01499 <span class="comment">Arguments:</span>
01500 <span class="comment"></span>
01501 <span class="comment">    DeviceObject - the PDEVICE_OBJECT for the device whose eject button has</span>
01502 <span class="comment">                   been pressed.  This pointer is valid for the duration of</span>
01503 <span class="comment">                   the call, if the API wants to keep a copy of it, it</span>
01504 <span class="comment">                   should obtain its own reference to the object</span>
01505 <span class="comment">                   (ObReferenceObject).</span>
01506 <span class="comment"></span>
01507 <span class="comment">ReturnValue:</span>
01508 <span class="comment"></span>
01509 <span class="comment">    None.</span>
01510 <span class="comment"></span>
01511 <span class="comment">--*/</span>
01512 
01513 {
01514     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(DeviceObject);
01515 
01516     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a50">IopQueueDeviceWorkItem</a>(DeviceObject, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a53">IopRequestDeviceEjectWorker</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01517 }
01518 
01519 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01520"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a53">01520</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a53">IopRequestDeviceEjectWorker</a>(
01521     PVOID Context
01522     )
01523 {
01524     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a32">PDEVICE_WORK_ITEM</a> deviceWorkItem = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a32">PDEVICE_WORK_ITEM</a>)Context;
01525     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o1">DeviceObject</a>;
01526 
01527     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceWorkItem);
01528 
01529     <span class="comment">//</span>
01530     <span class="comment">// Queue the event, we'll return immediately after it's queued.</span>
01531     <span class="comment">//</span>
01532 
01533     <a class="code" href="../../d6/d9/pnp_8h.html#a158">PpSetTargetDeviceRemove</a>( deviceObject,
01534                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01535                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01536                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01537                              CM_PROB_DEVICE_NOT_THERE,
01538                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01539                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01540                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01541                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01542 
01543     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
01544 }
01545 
01546 
01547 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01548"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a81">01548</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a81">IoReportDetectedDevice</a>(
01549     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
01550     IN INTERFACE_TYPE LegacyBusType,
01551     IN ULONG BusNumber,
01552     IN ULONG SlotNumber,
01553     IN PCM_RESOURCE_LIST ResourceList,
01554     IN PIO_RESOURCE_REQUIREMENTS_LIST ResourceRequirements OPTIONAL,
01555     IN BOOLEAN ResourceAssigned,
01556     IN OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *DeviceObject
01557     )
01558 
01559 <span class="comment">/*++</span>
01560 <span class="comment"></span>
01561 <span class="comment">Routine Description:</span>
01562 <span class="comment"></span>
01563 <span class="comment">    PnP device drivers call this API to report any device detected.  This routine</span>
01564 <span class="comment">    creates a Physical Device object, reference the Physical Device object and</span>
01565 <span class="comment">    returns back to the callers.  Once the detected device is reported, the Pnp manager</span>
01566 <span class="comment">    considers the device has been fully controlled by the reporting drivers.  Thus it</span>
01567 <span class="comment">    will not invoke AddDevice entry and send StartDevice irp to the driver.</span>
01568 <span class="comment"></span>
01569 <span class="comment">    The driver needs to report the resources it used to detect this device such that</span>
01570 <span class="comment">    pnp manager can perform duplicates detection on this device.</span>
01571 <span class="comment"></span>
01572 <span class="comment">    The caller must dereference the DeviceObject once it no longer needs it.</span>
01573 <span class="comment"></span>
01574 <span class="comment">Parameters:</span>
01575 <span class="comment"></span>
01576 <span class="comment">    DriverObject - Supplies the driver object of the driver who detected</span>
01577 <span class="comment">                   this device.</span>
01578 <span class="comment"></span>
01579 <span class="comment">    ResourceList - Supplies a pointer to the resource list which the driver used</span>
01580 <span class="comment">                   to detect the device.</span>
01581 <span class="comment"></span>
01582 <span class="comment">    ResourceRequirements - supplies a pointer to the resource requirements list</span>
01583 <span class="comment">                   for the detected device.  This is optional.</span>
01584 <span class="comment"></span>
01585 <span class="comment">    ResourceAssigned - if TRUE, the driver already called IoReportResourceUsage or</span>
01586 <span class="comment">                   IoAssignResource to get the ownership of the resources.  Otherwise,</span>
01587 <span class="comment">                   the PnP manager will call IoReportResourceUsage to allocate the</span>
01588 <span class="comment">                   resources for the driver.</span>
01589 <span class="comment"></span>
01590 <span class="comment">    DeviceObject - if NULL, this routine will create a PDO and return it thru this variable.</span>
01591 <span class="comment">                   Otherwise, a PDO is already created and this routine will simply use the supplied</span>
01592 <span class="comment">                   PDO.</span>
01593 <span class="comment"></span>
01594 <span class="comment">Return Value:</span>
01595 <span class="comment"></span>
01596 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
01597 <span class="comment"></span>
01598 <span class="comment"></span>
01599 <span class="comment">--*/</span>
01600 
01601 {
01602     WCHAR buffer[60];
01603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01604     UNICODE_STRING deviceName, instanceName, unicodeName, *serviceName, driverName;
01605     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
01606     ULONG length, i = 0, disposition, tmpValue, listSize = 0;
01607     HANDLE handle, handle1, logConfHandle, controlHandle, hTreeHandle, enumHandle;
01608     PCM_RESOURCE_LIST cmResource;
01609     PWSTR p;
01610     LARGE_INTEGER tickCount;
01611     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
01612     BOOLEAN newlyCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01613 
01614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01615 
01616     <span class="keywordflow">if</span> (*DeviceObject) {
01617 
01618         deviceObject = *DeviceObject;
01619 
01620         <span class="comment">//</span>
01621         <span class="comment">// The PDO is already known. simply handle the resourcelist and resreq list.</span>
01622         <span class="comment">// This is a hack for NDIS drivers.</span>
01623         <span class="comment">//</span>
01624         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(*DeviceObject)-&gt;DeviceObjectExtension-&gt;DeviceNode;
01625         <span class="keywordflow">if</span> (!deviceNode) {
01626             <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01627         }
01628 
01629         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01630         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01631 
01632         <span class="comment">//</span>
01633         <span class="comment">// Write ResourceList and ResReq list to the device instance</span>
01634         <span class="comment">//</span>
01635 
01636         status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a> (*DeviceObject,
01637                                                   &amp;handle,
01638                                                   KEY_ALL_ACCESS
01639                                                   );
01640         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01641             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01642             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01643             <span class="keywordflow">return</span> status;
01644         }
01645         <span class="keywordflow">if</span> (ResourceAssigned) {
01646             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_NO_RESOURCE_AT_INIT);
01647             tmpValue = 1;
01648             ZwSetValueKey(handle,
01649                           &amp;unicodeName,
01650                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01651                           REG_DWORD,
01652                           &amp;tmpValue,
01653                           <span class="keyword">sizeof</span>(tmpValue)
01654                           );
01655         }
01656         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
01657         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
01658                                          handle,
01659                                          &amp;unicodeName,
01660                                          KEY_ALL_ACCESS,
01661                                          REG_OPTION_NON_VOLATILE,
01662                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01663                                          );
01664         ZwClose(handle);
01665         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01666 
01667             <span class="comment">//</span>
01668             <span class="comment">// Write the ResourceList and and ResourceRequirements to the logconf key under</span>
01669             <span class="comment">// device instance key.</span>
01670             <span class="comment">//</span>
01671 
01672             <span class="keywordflow">if</span> (ResourceList) {
01673                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
01674                 ZwSetValueKey(
01675                           logConfHandle,
01676                           &amp;unicodeName,
01677                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01678                           REG_RESOURCE_LIST,
01679                           ResourceList,
01680                           listSize = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceList)
01681                           );
01682             }
01683             <span class="keywordflow">if</span> (ResourceRequirements) {
01684                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_BASIC_CONFIG_VECTOR);
01685                 ZwSetValueKey(
01686                           logConfHandle,
01687                           &amp;unicodeName,
01688                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01689                           REG_RESOURCE_REQUIREMENTS_LIST,
01690                           ResourceRequirements,
01691                           ResourceRequirements-&gt;ListSize
01692                           );
01693             }
01694             ZwClose(logConfHandle);
01695         }
01696         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01697         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01698         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01699             <span class="keywordflow">goto</span> checkResource;
01700         } <span class="keywordflow">else</span> {
01701             <span class="keywordflow">return</span> status;
01702         }
01703     }
01704 
01705     <span class="comment">//</span>
01706     <span class="comment">// Normal case: *DeviceObject is NULL</span>
01707     <span class="comment">//</span>
01708 
01709     *DeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01710     serviceName = &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName;
01711 
01712     <span class="comment">//</span>
01713     <span class="comment">// Special handling for driver object created thru IoCreateDriver.</span>
01714     <span class="comment">// When a builtin driver calls IoReportDetectedDevice, the ServiceKeyName of</span>
01715     <span class="comment">// the driver object is set to \Driver\DriverName.  To create a detected device</span>
01716     <span class="comment">// instance key, we will take only the DriverName.</span>
01717     <span class="comment">//</span>
01718 
01719     <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>) {
01720         p = serviceName-&gt;Buffer + (serviceName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) - 1;
01721         driverName.Length = 0;
01722         <span class="keywordflow">while</span> (*p != <span class="charliteral">'\\'</span> &amp;&amp; (p != serviceName-&gt;Buffer)) {
01723             p--;
01724             driverName.Length += <span class="keyword">sizeof</span>(WCHAR);
01725         }
01726         <span class="keywordflow">if</span> (p == serviceName-&gt;Buffer) {
01727             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01728         } <span class="keywordflow">else</span> {
01729             p++;
01730             driverName.Buffer = p;
01731             driverName.MaximumLength = driverName.Length + <span class="keyword">sizeof</span>(WCHAR);
01732         }
01733     } <span class="keywordflow">else</span> {
01734 
01735         <span class="comment">//</span>
01736         <span class="comment">// Before doing anything first perform duplicate detection</span>
01737         <span class="comment">//</span>
01738 
01739         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a109">IopDuplicateDetection</a>(
01740                      LegacyBusType,
01741                      <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
01742                      SlotNumber,
01743                      &amp;deviceNode
01744                  );
01745 
01746         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceNode) {
01747             deviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
01748             <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) ||
01749                 (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(deviceNode) &amp;&amp;
01750                  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o8">Problem</a> != CM_PROB_NOT_CONFIGURED &amp;&amp;
01751                  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o8">Problem</a> != CM_PROB_REINSTALL &amp;&amp;
01752                  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o8">Problem</a> != CM_PROB_FAILED_INSTALL)) {
01753 
01754                 <span class="comment">//</span>
01755                 <span class="comment">// BUGBUG: This assumption may not be true.</span>
01756                 <span class="comment">//</span>
01757 
01758                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
01759 
01760                 <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
01761             }
01762 
01763             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a30">DNF_HAS_PROBLEM</a>;
01764             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o8">Problem</a> = 0;
01765 
01766             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(DriverObject);
01767             <span class="keywordflow">goto</span> checkResource;
01768         }
01769 
01770     }
01771 
01772     <span class="comment">//</span>
01773     <span class="comment">// Create a PDO and its DeviceNode</span>
01774     <span class="comment">//</span>
01775 
01776     <span class="comment">//</span>
01777     <span class="comment">// Madeup a name for the device object.</span>
01778     <span class="comment">//</span>
01779 
01780     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;tickCount);
01781     length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Device\\%04u%x"</span>, <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>, tickCount.LowPart);
01782     deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
01783     deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
01784     deviceName.Buffer = buffer;                                                           \
01785 
01786     status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>,
01787                              <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
01788                              &amp;deviceName,
01789                              FILE_DEVICE_CONTROLLER,
01790                              0,
01791                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01792                              &amp;deviceObject );
01793 
01794     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01795         deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;   <span class="comment">// Mark this is a PDO</span>
01796         deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(deviceObject);
01797         <span class="keywordflow">if</span> (deviceNode) {
01798 
01799             <span class="comment">//</span>
01800             <span class="comment">// First delete the Legacy_DriverName key and subkeys from Enum\Root, if exits.</span>
01801             <span class="comment">//</span>
01802 
01803             <span class="keywordflow">if</span> (!(DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>)) {
01804                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a34">IopDeleteLegacyKey</a>(DriverObject);
01805             }
01806 
01807             <span class="comment">//</span>
01808             <span class="comment">// Create the compatible id list we'll use for this made-up device.</span>
01809             <span class="comment">//</span>
01810 
01811             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a73">PpCreateLegacyDeviceIds</a>(
01812                         deviceObject,
01813                         ((DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>) ?
01814                             &amp;driverName : serviceName),
01815                         ResourceList);
01816 
01817             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01818                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01819             }
01820 
01821             <span class="comment">//</span>
01822             <span class="comment">// Create/Open a registry key for the device instance and</span>
01823             <span class="comment">// write the addr of the device object to registry</span>
01824             <span class="comment">//</span>
01825 
01826             <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>) {
01827                 length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ROOT\\%s"</span>, driverName.Buffer);
01828             } <span class="keywordflow">else</span> {
01829                 length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ROOT\\%s"</span>, serviceName-&gt;Buffer);
01830             }
01831             deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
01832             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(length &lt;= <span class="keyword">sizeof</span>(buffer) - 10);
01833             deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
01834             deviceName.Buffer = buffer;
01835 
01836             <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01837             <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01838 
01839             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;enumHandle,
01840                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01841                                            &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a23">CmRegistryMachineSystemCurrentControlSetEnumName</a>,
01842                                            KEY_ALL_ACCESS
01843                                            );
01844             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01845                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01846             }
01847 
01848             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle1,
01849                                              enumHandle,
01850                                              &amp;deviceName,
01851                                              KEY_ALL_ACCESS,
01852                                              REG_OPTION_NON_VOLATILE,
01853                                              &amp;disposition
01854                                              );
01855 
01856             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01857                 deviceName.Buffer[deviceName.Length / <span class="keyword">sizeof</span>(WCHAR)] =
01858                            OBJ_NAME_PATH_SEPARATOR;
01859                 deviceName.Length += <span class="keyword">sizeof</span>(WCHAR);
01860                 <span class="keywordflow">if</span> (disposition != REG_CREATED_NEW_KEY) {
01861                     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01862                         PiUlongToInstanceKeyUnicodeString(&amp;instanceName,
01863                                                           buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
01864                                                           <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
01865                                                           i
01866                                                           );
01867                         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
01868                                                          handle1,
01869                                                          &amp;instanceName,
01870                                                          KEY_ALL_ACCESS,
01871                                                          REG_OPTION_NON_VOLATILE,
01872                                                          &amp;disposition
01873                                                          );
01874                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01875                             <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
01876                                 ZwClose(handle1);
01877                                 <span class="keywordflow">break</span>;
01878                             } <span class="keywordflow">else</span> {
01879                                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a54">IopIsReportedAlready</a>(handle, serviceName, ResourceList)) {
01880 
01881                                     <span class="comment">//</span>
01882                                     <span class="comment">// Write the reported resources to registry in case the irq changed</span>
01883                                     <span class="comment">//</span>
01884 
01885                                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
01886                                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
01887                                                                      handle,
01888                                                                      &amp;unicodeName,
01889                                                                      KEY_ALL_ACCESS,
01890                                                                      REG_OPTION_NON_VOLATILE,
01891                                                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01892                                                                      );
01893                                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01894 
01895                                         <span class="comment">//</span>
01896                                         <span class="comment">// Write the ResourceList and and ResourceRequirements to the device instance key</span>
01897                                         <span class="comment">//</span>
01898 
01899                                         <span class="keywordflow">if</span> (ResourceList) {
01900                                             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
01901                                             ZwSetValueKey(
01902                                                       logConfHandle,
01903                                                       &amp;unicodeName,
01904                                                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01905                                                       REG_RESOURCE_LIST,
01906                                                       ResourceList,
01907                                                       listSize = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceList)
01908                                                       );
01909                                         }
01910                                         <span class="keywordflow">if</span> (ResourceRequirements) {
01911                                             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_BASIC_CONFIG_VECTOR);
01912                                             ZwSetValueKey(
01913                                                       logConfHandle,
01914                                                       &amp;unicodeName,
01915                                                       <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01916                                                       REG_RESOURCE_REQUIREMENTS_LIST,
01917                                                       ResourceRequirements,
01918                                                       ResourceRequirements-&gt;ListSize
01919                                                       );
01920                                         }
01921                                         ZwClose(logConfHandle);
01922                                     }
01923 
01924                                     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
01925                                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01926                                     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
01927                                     ZwClose(handle1);
01928                                     deviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a> (
01929                                                            handle, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);  <span class="comment">// Add a reference</span>
01930                                     ZwClose(handle);
01931                                     ZwClose(enumHandle);
01932                                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceObject);
01933                                     <span class="keywordflow">if</span> (deviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01934                                         status = STATUS_UNSUCCESSFUL;
01935                                         <span class="keywordflow">return</span> status;
01936                                     }
01937                                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)
01938                                                   deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01939                                     <span class="keywordflow">goto</span> checkResource;
01940                                 } <span class="keywordflow">else</span> {
01941                                     i++;
01942                                     ZwClose(handle);
01943                                     <span class="keywordflow">continue</span>;
01944                                 }
01945                             }
01946                         } <span class="keywordflow">else</span> {
01947                             ZwClose(handle1);
01948                             ZwClose(enumHandle);
01949                             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01950                         }
01951                     }
01952                 } <span class="keywordflow">else</span> {
01953 
01954                     <span class="comment">//</span>
01955                     <span class="comment">// This is a new device key.  So, instance is 0.  Create it.</span>
01956                     <span class="comment">//</span>
01957 
01958                     PiUlongToInstanceKeyUnicodeString(&amp;instanceName,
01959                                                       buffer + deviceName.Length / <span class="keyword">sizeof</span>(WCHAR),
01960                                                       <span class="keyword">sizeof</span>(buffer) - deviceName.Length,
01961                                                       i
01962                                                       );
01963                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;handle,
01964                                                      handle1,
01965                                                      &amp;instanceName,
01966                                                      KEY_ALL_ACCESS,
01967                                                      REG_OPTION_NON_VOLATILE,
01968                                                      &amp;disposition
01969                                                      );
01970                     ZwClose(handle1);
01971                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01972                         ZwClose(enumHandle);
01973                         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01974                     }
01975                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(disposition == REG_CREATED_NEW_KEY);
01976                 }
01977             } <span class="keywordflow">else</span> {
01978                 ZwClose(enumHandle);
01979                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
01980             }
01981 
01982             deviceName.Length += instanceName.Length;
01983             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(disposition == REG_CREATED_NEW_KEY);
01984             newlyCreated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01985 
01986             <span class="comment">//</span>
01987             <span class="comment">// Initialize new device instance registry key</span>
01988             <span class="comment">//</span>
01989 
01990             <span class="keywordflow">if</span> (ResourceAssigned) {
01991                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_NO_RESOURCE_AT_INIT);
01992                 tmpValue = 1;
01993                 ZwSetValueKey(handle,
01994                               &amp;unicodeName,
01995                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
01996                               REG_DWORD,
01997                               &amp;tmpValue,
01998                               <span class="keyword">sizeof</span>(tmpValue)
01999                               );
02000             }
02001             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
02002             logConfHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02003             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
02004                                              handle,
02005                                              &amp;unicodeName,
02006                                              KEY_ALL_ACCESS,
02007                                              REG_OPTION_NON_VOLATILE,
02008                                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02009                                              );
02010 
02011             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02012 
02013             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02014 
02015                 <span class="comment">//</span>
02016                 <span class="comment">// Write the ResourceList and and ResourceRequirements to the logconf key under</span>
02017                 <span class="comment">// device instance key.</span>
02018                 <span class="comment">//</span>
02019 
02020                 <span class="keywordflow">if</span> (ResourceList) {
02021                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VAL_BOOTCONFIG);
02022                     ZwSetValueKey(
02023                               logConfHandle,
02024                               &amp;unicodeName,
02025                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02026                               REG_RESOURCE_LIST,
02027                               ResourceList,
02028                               listSize = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceList)
02029                               );
02030                 }
02031                 <span class="keywordflow">if</span> (ResourceRequirements) {
02032                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_BASIC_CONFIG_VECTOR);
02033                     ZwSetValueKey(
02034                               logConfHandle,
02035                               &amp;unicodeName,
02036                               <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02037                               REG_RESOURCE_REQUIREMENTS_LIST,
02038                               ResourceRequirements,
02039                               ResourceRequirements-&gt;ListSize
02040                               );
02041                 }
02042                 <span class="comment">//ZwClose(logConfHandle);</span>
02043             }
02044 
02045             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_VALUE_CONFIG_FLAGS);
02046             tmpValue = CONFIGFLAG_FINISH_INSTALL;
02047             ZwSetValueKey(handle,
02048                           &amp;unicodeName,
02049                           <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02050                           REG_DWORD,
02051                           &amp;tmpValue,
02052                           <span class="keyword">sizeof</span>(tmpValue)
02053                           );
02054 
02055             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_LEGACY);
02056             tmpValue = 0;
02057             ZwSetValueKey(
02058                         handle,
02059                         &amp;unicodeName,
02060                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02061                         REG_DWORD,
02062                         &amp;tmpValue,
02063                         <span class="keyword">sizeof</span>(ULONG)
02064                         );
02065 
02066             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_CONTROL);
02067             controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02068             <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;controlHandle,
02069                                     handle,
02070                                     &amp;unicodeName,
02071                                     KEY_ALL_ACCESS,
02072                                     REG_OPTION_VOLATILE,
02073                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02074                                     );
02075 
02076             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02077 
02078             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02079 
02080                 <span class="comment">//</span>
02081                 <span class="comment">// Write DeviceObject reference ...</span>
02082                 <span class="comment">//</span>
02083 
02084                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REFERENCE);
02085                 status = ZwSetValueKey(controlHandle,
02086                                        &amp;unicodeName,
02087                                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02088                                        REG_DWORD,
02089                                        (PULONG_PTR)&amp;deviceObject,
02090                                        <span class="keyword">sizeof</span>(ULONG_PTR)
02091                                        );
02092                 PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REPORTED);
02093                 tmpValue = 1;
02094                 status = ZwSetValueKey(controlHandle,
02095                                        &amp;unicodeName,
02096                                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02097                                        REG_DWORD,
02098                                        &amp;tmpValue,
02099                                        <span class="keyword">sizeof</span>(ULONG)
02100                                        );
02101                 status = ZwSetValueKey(handle,
02102                                        &amp;unicodeName,
02103                                        <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02104                                        REG_DWORD,
02105                                        &amp;tmpValue,
02106                                        <span class="keyword">sizeof</span>(ULONG)
02107                                        );
02108 
02109                 <span class="comment">//ZwClose(controlHandle);</span>
02110             }
02111 
02112             ZwClose(enumHandle);
02113 
02114             <span class="comment">//</span>
02115             <span class="comment">// Create Service value name and set it to the calling driver's service</span>
02116             <span class="comment">// key name.</span>
02117             <span class="comment">//</span>
02118 
02119             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_SERVICE);
02120             p = (PWSTR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, serviceName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL));
02121             <span class="keywordflow">if</span> (!p) {
02122                 <span class="keywordflow">goto</span> CleanupRegistry;
02123             }
02124             RtlMoveMemory(p, serviceName-&gt;Buffer, serviceName-&gt;Length);
02125             p[serviceName-&gt;Length / <span class="keyword">sizeof</span> (WCHAR)] = UNICODE_NULL;
02126             ZwSetValueKey(
02127                         handle,
02128                         &amp;unicodeName,
02129                         <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02130                         REG_SZ,
02131                         p,
02132                         serviceName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
02133                         );
02134             <span class="keywordflow">if</span> (DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>) {
02135                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a> = *serviceName;
02136             } <span class="keywordflow">else</span> {
02137                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(p);
02138             }
02139 
02140             <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
02141             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02142             <span class="comment">//ZwClose(logConfHandle);</span>
02143             <span class="comment">//ZwClose(controlHandle);</span>
02144             <span class="comment">//ZwClose(handle);</span>
02145 
02146             <span class="comment">//</span>
02147             <span class="comment">// Register the device for the driver and save the device</span>
02148             <span class="comment">// instance path in device node.</span>
02149             <span class="comment">//</span>
02150 
02151             <span class="keywordflow">if</span> (!(DriverObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a145">DRVO_BUILTIN_DRIVER</a>)) {
02152                 <a class="code" href="../../d6/d9/pnp_8h.html#a138">PpDeviceRegistration</a>( &amp;deviceName,
02153                                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02154                                       &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>
02155                                       );
02156             }
02157 
02158             <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a4">IopConcatenateUnicodeStrings</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>, &amp;deviceName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02159 
02160             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a9">DNF_ENUMERATED</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a>;
02161 
02162             <a class="code" href="../../d9/d0/pnpiop_8h.html#a250">IopInsertTreeDeviceNode</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>, deviceNode);
02163 
02164             <span class="comment">//</span>
02165             <span class="comment">// Add a reference to the DeviceObject for ourself</span>
02166             <span class="comment">//</span>
02167 
02168             <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(deviceObject);
02169 
02170             <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>(deviceObject, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02171 
02172             <span class="keywordflow">goto</span> checkResource;
02173         } <span class="keywordflow">else</span> {
02174             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
02175             status = STATUS_INSUFFICIENT_RESOURCES;
02176         }
02177     }
02178     <span class="keywordflow">return</span> status;
02179 checkResource:
02180 
02181 
02182     <span class="comment">//</span>
02183     <span class="comment">// At this point the *DeviceObject is established.  Check if we need to report resources for</span>
02184     <span class="comment">// the detected device.  If we failed to</span>
02185     <span class="comment">//</span>
02186 
02187     <span class="keywordflow">if</span> (ResourceAssigned) {
02188         <span class="comment">//ASSERT(deviceNode-&gt;ResourceList == NULL);      // make sure we have not reported resources yet.</span>
02189 
02190         <span class="comment">//</span>
02191         <span class="comment">// If the driver specifies it already has acquired the resource.  We will put a flag</span>
02192         <span class="comment">// in the device instance path to not to allocate resources at boot time.  The Driver</span>
02193         <span class="comment">// may do detection and report it again.</span>
02194         <span class="comment">//</span>
02195 
02196         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>; <span class="comment">// do not need resources for this boot.</span>
02197         <span class="keywordflow">if</span> (ResourceList) {
02198 
02199             <span class="comment">//</span>
02200             <span class="comment">// Write the resource list to the reported device instance key.</span>
02201             <span class="comment">//</span>
02202 
02203             listSize = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceList);
02204             <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (deviceNode, ResourceList, listSize);
02205         }
02206     } <span class="keywordflow">else</span> {
02207         BOOLEAN conflict;
02208 
02209         <span class="keywordflow">if</span> (ResourceList &amp;&amp; ResourceList-&gt;Count &amp;&amp; ResourceList-&gt;List[0].PartialResourceList.Count) {
02210             <span class="keywordflow">if</span> (listSize == 0) {
02211                 listSize = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceList);
02212             }
02213             cmResource = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, listSize);
02214             <span class="keywordflow">if</span> (cmResource) {
02215                 RtlCopyMemory(cmResource, ResourceList, listSize);
02216                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, PNPMGR_STR_PNP_MANAGER);
02217                 status = <a class="code" href="../../d1/d8/report_8c.html#a14">IoReportResourceUsageInternal</a>(
02218                              <a class="code" href="../../d6/d9/pnp_8h.html#a174a126">ArbiterRequestLegacyReported</a>,
02219                              &amp;unicodeName,       <span class="comment">// DriverClassName OPTIONAL,</span>
02220                              <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>,  <span class="comment">// DriverObject,</span>
02221                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,               <span class="comment">// DriverList OPTIONAL,</span>
02222                              0,                  <span class="comment">// DriverListSize OPTIONAL,</span>
02223                              deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
02224                                                  <span class="comment">// DeviceObject OPTIONAL,</span>
02225                              cmResource,         <span class="comment">// DeviceList OPTIONAL,</span>
02226                              listSize,           <span class="comment">// DeviceListSize OPTIONAL,</span>
02227                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,              <span class="comment">// OverrideConflict,</span>
02228                              &amp;conflict           <span class="comment">// ConflictDetected</span>
02229                              );
02230                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResource);
02231                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || conflict) {
02232                     status = STATUS_CONFLICTING_ADDRESSES;
02233                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_NORMAL_CONFLICT);
02234                 }
02235             } <span class="keywordflow">else</span> {
02236                 status = STATUS_INSUFFICIENT_RESOURCES;
02237                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a80">IopSetDevNodeProblem</a>(deviceNode, CM_PROB_OUT_OF_MEMORY);
02238             }
02239         } <span class="keywordflow">else</span> {
02240             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceRequirements == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02241             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>; <span class="comment">// do not need resources for this boot.</span>
02242         }
02243     }
02244 
02245     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02246 
02247         <a class="code" href="../../d9/d0/pnpiop_8h.html#a356">IopDoDeferredSetInterfaceState</a>(deviceNode);
02248 
02249         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a25">DNF_NEED_ENUMERATION_ONLY</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a10">DNF_NEED_QUERY_IDS</a>;
02250         *DeviceObject = deviceObject;
02251         <span class="keywordflow">if</span> (newlyCreated) {
02252             <span class="keywordflow">if</span> (controlHandle) {
02253                 ZwClose(controlHandle);
02254             }
02255             <span class="keywordflow">if</span> (logConfHandle) {
02256                 ZwClose(logConfHandle);
02257             }
02258             ZwClose(handle);
02259         }
02260         <span class="keywordflow">return</span> status;
02261 
02262     }
02263 CleanupRegistry:
02264     <a class="code" href="../../d9/d0/pnpiop_8h.html#a279">IopReleaseDeviceResources</a>(deviceNode, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02265     <span class="keywordflow">if</span> (newlyCreated) {
02266         <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(deviceObject);
02267         <span class="keywordflow">if</span> (controlHandle) {
02268             ZwDeleteKey(controlHandle);
02269         }
02270         <span class="keywordflow">if</span> (logConfHandle) {
02271             ZwDeleteKey(logConfHandle);
02272         }
02273         <span class="keywordflow">if</span> (handle) {
02274             ZwDeleteKey(handle);
02275         }
02276     }
02277     <span class="keywordflow">return</span> status;
02278 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02279     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
02280     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
02281     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(*DeviceObject);
02282     <span class="keywordflow">return</span> status;
02283 }
02284 
02285 BOOLEAN
<a name="l02286"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a54">02286</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a54">IopIsReportedAlready</a>(
02287     IN HANDLE Handle,
02288     IN PUNICODE_STRING ServiceName,
02289     IN PCM_RESOURCE_LIST ResourceList
02290     )
02291 
02292 <span class="comment">/*++</span>
02293 <span class="comment"></span>
02294 <span class="comment">Routine Description:</span>
02295 <span class="comment"></span>
02296 <span class="comment">    This routine determines if the reported device instance is already reported</span>
02297 <span class="comment">    or not.</span>
02298 <span class="comment"></span>
02299 <span class="comment">Parameters:</span>
02300 <span class="comment"></span>
02301 <span class="comment">    Handle - Supplies a handle to the reported device instance key.</span>
02302 <span class="comment"></span>
02303 <span class="comment">    ServiceName - supplies a pointer to a the unicode service key name.</span>
02304 <span class="comment"></span>
02305 <span class="comment">    ResourceList - supplies a pointer to the reported Resource list.</span>
02306 <span class="comment"></span>
02307 <span class="comment">Return Value:</span>
02308 <span class="comment"></span>
02309 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02310 <span class="comment"></span>
02311 <span class="comment">--*/</span>
02312 
02313 {
02314     PKEY_VALUE_FULL_INFORMATION keyValueInfo1 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, keyValueInfo2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02315     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02316     UNICODE_STRING unicodeName;
02317     HANDLE logConfHandle, controlHandle = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02318     BOOLEAN returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02319     PCM_RESOURCE_LIST cmResource = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02320     ULONG tmpValue;
02321 
02322     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02323 
02324     <span class="comment">//</span>
02325     <span class="comment">// If this registry key is for a device reported during the same boot</span>
02326     <span class="comment">// this is not a duplicate.</span>
02327     <span class="comment">//</span>
02328 
02329     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_CONTROL);
02330     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;controlHandle,
02331                                    <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
02332                                    &amp;unicodeName,
02333                                    KEY_ALL_ACCESS
02334                                    );
02335     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02336         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(controlHandle,
02337                                      REGSTR_VALUE_DEVICE_REPORTED,
02338                                      &amp;keyValueInfo1);
02339         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02340             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02341         }
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">// Check if "Service" value matches what the caller passed in.</span>
02345         <span class="comment">//</span>
02346 
02347         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>, REGSTR_VALUE_SERVICE, &amp;keyValueInfo1);
02348         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02349             <span class="keywordflow">if</span> ((keyValueInfo1-&gt;Type == REG_SZ) &amp;&amp;
02350                 (keyValueInfo1-&gt;DataLength != 0)) {
02351                 unicodeName.Buffer = (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInfo1);
02352                 unicodeName.MaximumLength = unicodeName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)keyValueInfo1-&gt;DataLength;
02353                 <span class="keywordflow">if</span> (unicodeName.Buffer[(keyValueInfo1-&gt;DataLength / <span class="keyword">sizeof</span>(WCHAR)) - 1] == UNICODE_NULL) {
02354                     unicodeName.Length -= <span class="keyword">sizeof</span>(WCHAR);
02355                 }
02356                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(ServiceName, &amp;unicodeName, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
02357 
02358                     <span class="comment">//</span>
02359                     <span class="comment">// Next check if resources are the same</span>
02360                     <span class="comment">//</span>
02361 
02362                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeName, REGSTR_KEY_LOG_CONF);
02363                     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;logConfHandle,
02364                                                    <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
02365                                                    &amp;unicodeName,
02366                                                    KEY_READ
02367                                                    );
02368                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02369                         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(logConfHandle,
02370                                                      REGSTR_VAL_BOOTCONFIG,
02371                                                      &amp;keyValueInfo2);
02372                         ZwClose(logConfHandle);
02373                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02374                             <span class="keywordflow">if</span> ((keyValueInfo2-&gt;Type == REG_RESOURCE_LIST) &amp;&amp;
02375                                 (keyValueInfo2-&gt;DataLength != 0)) {
02376                                 cmResource = (PCM_RESOURCE_LIST)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInfo2);
02377                                 <span class="keywordflow">if</span> (ResourceList &amp;&amp; cmResource &amp;&amp;
02378                                     <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a16">IopIsDuplicatedDevices</a>(ResourceList, cmResource, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02379                                     returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02380                                 }
02381                             }
02382                         }
02383                     }
02384                     <span class="keywordflow">if</span> (!ResourceList &amp;&amp; !cmResource) {
02385                         returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02386                     }
02387                 }
02388             }
02389         }
02390         <span class="keywordflow">if</span> (returnValue == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02391 
02392             <span class="comment">//</span>
02393             <span class="comment">// Mark this key has been used.</span>
02394             <span class="comment">//</span>
02395 
02396             PiWstrToUnicodeString(&amp;unicodeName, REGSTR_VALUE_DEVICE_REPORTED);
02397             tmpValue = 1;
02398             status = ZwSetValueKey(controlHandle,
02399                                    &amp;unicodeName,
02400                                    <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
02401                                    REG_DWORD,
02402                                    &amp;tmpValue,
02403                                    <span class="keyword">sizeof</span>(ULONG)
02404                                    );
02405             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02406                 returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02407             }
02408         }
02409     }
02410 
02411 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02412     <span class="keywordflow">if</span> (controlHandle) {
02413         ZwClose(controlHandle);
02414     }
02415 
02416     <span class="keywordflow">if</span> (keyValueInfo1) {
02417         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInfo1);
02418     }
02419     <span class="keywordflow">if</span> (keyValueInfo2) {
02420         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInfo2);
02421     }
02422     <span class="keywordflow">return</span> returnValue;
02423 }
02424 
02425 
02426 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02427"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a370">02427</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(
02428     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
02429     IN ULONG Size
02430     )
02431 
02432 <span class="comment">/*++</span>
02433 <span class="comment"></span>
02434 <span class="comment">Routine Description:</span>
02435 <span class="comment"></span>
02436 <span class="comment">    Allocates a buffer of Size bytes and initialises the BUFFER_INFO</span>
02437 <span class="comment">    structure so the current position is at the start of the buffer.</span>
02438 <span class="comment"></span>
02439 <span class="comment">Parameters:</span>
02440 <span class="comment"></span>
02441 <span class="comment">    Info - Pointer to a buffer info structure to be used to manage the new</span>
02442 <span class="comment">           buffer</span>
02443 <span class="comment"></span>
02444 <span class="comment">    Size - The number of bytes to be allocated for the buffer</span>
02445 <span class="comment"></span>
02446 <span class="comment">Return Value:</span>
02447 <span class="comment"></span>
02448 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02449 <span class="comment"></span>
02450 <span class="comment">--*/</span>
02451 
02452 {
02453     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02454 
02455     <span class="keywordflow">if</span> (!(Info-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>))) {
02456         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02457     }
02458 
02459     Info-&gt;Current = Info-&gt;Buffer;
02460     Info-&gt;MaxSize = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02461 
02462     <span class="keywordflow">return</span> STATUS_SUCCESS;
02463 }
02464 
02465 
02466 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02467"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a371">02467</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(
02468     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
02469     IN ULONG NewSize,
02470     IN BOOLEAN CopyContents
02471     )
02472 
02473 <span class="comment">/*++</span>
02474 <span class="comment"></span>
02475 <span class="comment">Routine Description:</span>
02476 <span class="comment"></span>
02477 <span class="comment">    Allocates a new buffer of NewSize bytes and associates it with Info, freeing the</span>
02478 <span class="comment">    old buffer.  It will optionally copy the data stored in the old buffer into the</span>
02479 <span class="comment">    new buffer and update the current position.</span>
02480 <span class="comment"></span>
02481 <span class="comment">Parameters:</span>
02482 <span class="comment"></span>
02483 <span class="comment">    Info - Pointer to a buffer info structure to be used to manage the buffer</span>
02484 <span class="comment"></span>
02485 <span class="comment">    NewSize - The new size of the buffer in bytes</span>
02486 <span class="comment"></span>
02487 <span class="comment">    CopyContents - If TRUE indicates that the contents of the old buffer should be</span>
02488 <span class="comment">                   copied to the new buffer</span>
02489 <span class="comment"></span>
02490 <span class="comment">Return Value:</span>
02491 <span class="comment"></span>
02492 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02493 <span class="comment"></span>
02494 <span class="comment">--*/</span>
02495 
02496 {
02497     ULONG used;
02498     PCHAR newBuffer;
02499 
02500     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02501 
02502     used = (ULONG)(Info-&gt;Current - Info-&gt;Buffer);
02503 
02504     <span class="keywordflow">if</span> (!(newBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NewSize))) {
02505         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02506     }
02507 
02508     <span class="keywordflow">if</span> (CopyContents) {
02509 
02510         <span class="comment">//</span>
02511         <span class="comment">// Assert there is room in the buffer</span>
02512         <span class="comment">//</span>
02513 
02514         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(used &lt; NewSize);
02515 
02516         RtlCopyMemory(newBuffer,
02517                       Info-&gt;Buffer,
02518                       used);
02519 
02520         Info-&gt;Current = newBuffer + used;
02521 
02522     } <span class="keywordflow">else</span> {
02523 
02524         Info-&gt;Current = newBuffer;
02525     }
02526 
02527     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Info-&gt;Buffer);
02528 
02529     Info-&gt;Buffer = newBuffer;
02530     Info-&gt;MaxSize = NewSize;
02531 
02532     <span class="keywordflow">return</span> STATUS_SUCCESS;
02533 }
02534 
02535 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02536"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a372">02536</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(
02537     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info
02538     )
02539 
02540 <span class="comment">/*++</span>
02541 <span class="comment"></span>
02542 <span class="comment">Routine Description:</span>
02543 <span class="comment"></span>
02544 <span class="comment">    Frees the buffer associated with Info and resets all Info fields</span>
02545 <span class="comment"></span>
02546 <span class="comment">Parameters:</span>
02547 <span class="comment"></span>
02548 <span class="comment">    Info - Pointer to a buffer info structure to be used to manage the buffer</span>
02549 <span class="comment"></span>
02550 <span class="comment">Return Value:</span>
02551 <span class="comment"></span>
02552 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02553 <span class="comment"></span>
02554 <span class="comment">--*/</span>
02555 
02556 {
02557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02558 
02559     <span class="comment">//</span>
02560     <span class="comment">// Free the buffer</span>
02561     <span class="comment">//</span>
02562 
02563     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Info-&gt;Buffer);
02564 
02565     <span class="comment">//</span>
02566     <span class="comment">// Zero out the info parameters so we can't accidently used the free buffer</span>
02567     <span class="comment">//</span>
02568 
02569     Info-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02570     Info-&gt;Current = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02571     Info-&gt;MaxSize = 0;
02572 }
02573 
02574 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02575"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">02575</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(
02576     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
02577     IN PVOID Data,
02578     IN ULONG DataSize
02579     )
02580 
02581 <span class="comment">/*++</span>
02582 <span class="comment"></span>
02583 <span class="comment">Routine Description:</span>
02584 <span class="comment"></span>
02585 <span class="comment">    Copies the data to the end of the buffer, resizing if necessary.  The current</span>
02586 <span class="comment">    position is set to the end of the data just added.</span>
02587 <span class="comment"></span>
02588 <span class="comment">Parameters:</span>
02589 <span class="comment"></span>
02590 <span class="comment">    Info - Pointer to a buffer info structure to be used to manage the buffer</span>
02591 <span class="comment"></span>
02592 <span class="comment">    Data - Pointer to the data to be added to the buffer</span>
02593 <span class="comment"></span>
02594 <span class="comment">    DataSize - The size of the data pointed to by Data in bytes</span>
02595 <span class="comment"></span>
02596 <span class="comment">Return Value:</span>
02597 <span class="comment"></span>
02598 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02599 <span class="comment"></span>
02600 <span class="comment">--*/</span>
02601 {
02602 
02603     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02604     ULONG free, used;
02605 
02606     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02607 
02608     used = (ULONG)(Info-&gt;Current - Info-&gt;Buffer);
02609     free = Info-&gt;MaxSize - used;
02610 
02611     <span class="keywordflow">if</span> (free &lt; DataSize) {
02612         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(Info, used + DataSize, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02613 
02614         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02615             <span class="keywordflow">goto</span> clean0;
02616         }
02617 
02618     }
02619 
02620     <span class="comment">//</span>
02621     <span class="comment">// Copy the data into the buffer</span>
02622     <span class="comment">//</span>
02623 
02624     RtlCopyMemory(Info-&gt;Current,
02625                   Data,
02626                   DataSize);
02627 
02628     <span class="comment">//</span>
02629     <span class="comment">// Advance down the buffer</span>
02630     <span class="comment">//</span>
02631 
02632     Info-&gt;Current += DataSize;
02633 
02634 clean0:
02635     <span class="keywordflow">return</span> status;
02636 
02637 }
02638 
02639 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02640"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a60">02640</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a60">IopOverwriteBuffer</a>(
02641     IN <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">PBUFFER_INFO</a> Info,
02642     IN PVOID Data,
02643     IN ULONG DataSize
02644     )
02645 
02646 <span class="comment">/*++</span>
02647 <span class="comment"></span>
02648 <span class="comment">Routine Description:</span>
02649 <span class="comment"></span>
02650 <span class="comment">    Copies data into the buffer, overwriting what is currently present,</span>
02651 <span class="comment">    resising if necessary.  The current position is set to the end of the</span>
02652 <span class="comment">    data just added.</span>
02653 <span class="comment"></span>
02654 <span class="comment">Parameters:</span>
02655 <span class="comment"></span>
02656 <span class="comment">    Info - Pointer to a buffer info structure to be used to manage the buffer</span>
02657 <span class="comment"></span>
02658 <span class="comment">    Data - Pointer to the data to be added to the buffer</span>
02659 <span class="comment"></span>
02660 <span class="comment">    DataSize - The size of the data pointed to by Data in bytes</span>
02661 <span class="comment"></span>
02662 <span class="comment">Return Value:</span>
02663 <span class="comment"></span>
02664 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02665 <span class="comment"></span>
02666 <span class="comment">--*/</span>
02667 
02668 {
02669     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
02670     ULONG free;
02671 
02672     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Info);
02673 
02674     free = Info-&gt;MaxSize;
02675 
02676 
02677     <span class="keywordflow">if</span> (free &lt; DataSize) {
02678         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(Info, DataSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02679 
02680         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02681             <span class="keywordflow">goto</span> clean0;
02682         }
02683 
02684     }
02685 
02686     <span class="comment">//</span>
02687     <span class="comment">// Copy the data into the buffer</span>
02688     <span class="comment">//</span>
02689 
02690     RtlCopyMemory(Info-&gt;Buffer,
02691                   Data,
02692                   DataSize);
02693 
02694     <span class="comment">//</span>
02695     <span class="comment">// Advance down the buffer</span>
02696     <span class="comment">//</span>
02697 
02698     Info-&gt;Current += DataSize;
02699 
02700 clean0:
02701     <span class="keywordflow">return</span> status;
02702 }
02703 
<a name="l02704"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a29">02704</a> <span class="preprocessor">#define DBG_GET_ASSOC 0</span>
02705 <span class="preprocessor"></span>
02706 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02707"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a355">02707</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a355">IopGetDeviceInterfaces</a>(
02708         IN CONST GUID *InterfaceClassGuid,
02709         IN PUNICODE_STRING DevicePath   OPTIONAL,
02710         IN ULONG Flags,
02711         IN BOOLEAN UserModeFormat,
02712         OUT PWSTR *SymbolicLinkList,
02713         OUT PULONG SymbolicLinkListSize OPTIONAL
02714         )
02715 
02716 <span class="comment">/*++</span>
02717 <span class="comment"></span>
02718 <span class="comment">Routine Description:</span>
02719 <span class="comment"></span>
02720 <span class="comment">    This API allows a WDM driver to get a list of paths that represent all</span>
02721 <span class="comment">    devices registered for the specified interface class.</span>
02722 <span class="comment"></span>
02723 <span class="comment">Parameters:</span>
02724 <span class="comment"></span>
02725 <span class="comment">    InterfaceClassGuid - Supplies a pointer to a GUID representing the interface class</span>
02726 <span class="comment">        for whom a list of members is to be retrieved</span>
02727 <span class="comment"></span>
02728 <span class="comment">    DevicePath - Optionally, supplies a pointer to a unicode string containing the</span>
02729 <span class="comment">        enumeration path for a device for whom interfaces of the specified class are</span>
02730 <span class="comment">        to be re-trieved.  If this parameter  is not supplied, then all interface</span>
02731 <span class="comment">        devices (regardless of what physical device exposes them) will be returned.</span>
02732 <span class="comment"></span>
02733 <span class="comment">    Flags - Supplies flags that modify the behavior of list retrieval.</span>
02734 <span class="comment">        The following flags are presently defined:</span>
02735 <span class="comment"></span>
02736 <span class="comment">        DEVICE_INTERFACE_INCLUDE_NONACTIVE -- If this flag is specified, then all</span>
02737 <span class="comment">            interface devices, whether currently active or not, will be returned</span>
02738 <span class="comment">            (potentially filtered based on the Physi-calDeviceObject, if specified).</span>
02739 <span class="comment"></span>
02740 <span class="comment">    UserModeFormat - If TRUE the multi-sz returned will have user mode prefixes</span>
02741 <span class="comment">        (\\?\) otherwise they will have kernel mode prefixes (\??\).</span>
02742 <span class="comment"></span>
02743 <span class="comment">    SymbolicLinkList - Supplies the address of a character pointer, that on</span>
02744 <span class="comment">        success will contain a multi-sz list of \??\ symbolic link</span>
02745 <span class="comment">        names that provide the requested functionality.  The caller is</span>
02746 <span class="comment">        responsible for freeing the memory via ExFreePool.</span>
02747 <span class="comment"></span>
02748 <span class="comment">Return Value:</span>
02749 <span class="comment"></span>
02750 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
02751 <span class="comment"></span>
02752 <span class="comment">--*/</span>
02753 
02754 {
02755     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02756     UNICODE_STRING guidString, tempString, defaultString, symLinkString, devnodeString;
02757     <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a> returnBuffer, infoBuffer, symLinkBuffer, devnodeNameBuffer;
02758     PKEY_VALUE_FULL_INFORMATION pDefaultInfo;
02759     ULONG tempLong, keyIndex, instanceKeyIndex, resultSize;
02760     HANDLE hDeviceClasses, hClass, hKey, hInstanceKey, hControl;
02761     BOOLEAN defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02762 
02763     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02764 
02765     <span class="comment">//</span>
02766     <span class="comment">// Initialise out parameters</span>
02767     <span class="comment">//</span>
02768 
02769     *SymbolicLinkList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02770 
02771     <span class="comment">//</span>
02772     <span class="comment">// Convert the GUID into a string</span>
02773     <span class="comment">//</span>
02774 
02775     status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a>(InterfaceClassGuid, &amp;guidString);
02776     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02777         <span class="keywordflow">goto</span> finalClean;
02778     }
02779 
02780 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02781 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Getting associations for class %wZ\n"</span>, &amp;guidString);
02782 <span class="preprocessor">#endif</span>
02783 <span class="preprocessor"></span>
02784     <span class="comment">//</span>
02785     <span class="comment">// Allocate initial buffers</span>
02786     <span class="comment">//</span>
02787 
02788     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;returnBuffer,
02789                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a10">INITIAL_RETURN_BUFFER_SIZE</a>
02790                                );
02791 
02792     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02793         <span class="keywordflow">goto</span> clean0;
02794     }
02795 
02796     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;infoBuffer,
02797                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a6">INITIAL_INFO_BUFFER_SIZE</a>
02798                                );
02799 
02800     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02801         <span class="keywordflow">goto</span> clean1;
02802     }
02803 
02804     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;symLinkBuffer,
02805                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a8">INITIAL_SYMLINK_BUFFER_SIZE</a>
02806                                );
02807 
02808     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02809         <span class="keywordflow">goto</span> clean2;
02810     }
02811 
02812     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;devnodeNameBuffer,
02813                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a12">INITIAL_DEVNODE_NAME_BUFFER_SIZE</a>
02814                                );
02815 
02816     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02817         <span class="keywordflow">goto</span> clean2a;
02818     }
02819 
02820     <span class="comment">//</span>
02821     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
02822     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
02823     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
02824     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
02825     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
02826     <span class="comment">// portion solves this problem</span>
02827     <span class="comment">//</span>
02828 
02829     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
02830     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02831 
02832     <span class="comment">//</span>
02833     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses key</span>
02834     <span class="comment">//</span>
02835 
02836     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
02837     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hDeviceClasses,
02838                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02839                                      &amp;tempString,
02840                                      KEY_ALL_ACCESS,
02841                                      REG_OPTION_NON_VOLATILE,
02842                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
02843                                      );
02844 
02845     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02846         <span class="keywordflow">goto</span> clean3;
02847     }
02848 
02849     <span class="comment">//</span>
02850     <span class="comment">// Open function class GUID key</span>
02851     <span class="comment">//</span>
02852 
02853     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hClass,
02854                                    hDeviceClasses,
02855                                    &amp;guidString,
02856                                    KEY_ALL_ACCESS
02857                                    );
02858     ZwClose(hDeviceClasses);
02859 
02860     <span class="keywordflow">if</span>(status == STATUS_OBJECT_NAME_NOT_FOUND || status == STATUS_OBJECT_PATH_NOT_FOUND) {
02861 
02862         <span class="comment">//</span>
02863         <span class="comment">// The path does not exist - return a single null character buffer</span>
02864         <span class="comment">//</span>
02865 
02866         status = STATUS_SUCCESS;
02867         <span class="keywordflow">goto</span> clean5;
02868     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02869         <span class="keywordflow">goto</span> clean3;
02870     }
02871 
02872     <span class="comment">//</span>
02873     <span class="comment">// Get the default value if it exists</span>
02874     <span class="comment">//</span>
02875 
02876     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hClass,
02877                                  REGSTR_VAL_DEFAULT,
02878                                  &amp;pDefaultInfo
02879                                  );
02880 
02881 
02882     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
02883         &amp;&amp; pDefaultInfo-&gt;Type == REG_SZ
02884         &amp;&amp; pDefaultInfo-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(WCHAR)) {
02885 
02886         <span class="comment">//</span>
02887         <span class="comment">// We have a default - construct a counted string from the default</span>
02888         <span class="comment">//</span>
02889 
02890         defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02891         defaultString.Buffer = (PWSTR) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pDefaultInfo);
02892         defaultString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) pDefaultInfo-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
02893         defaultString.MaximumLength = defaultString.Length;
02894 
02895 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02896 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Class default: %wZ\n"</span>, &amp;defaultString);
02897 <span class="preprocessor">#endif</span>
02898 <span class="preprocessor"></span>
02899         <span class="comment">//</span>
02900         <span class="comment">// Open the device interface instance key for the default name.</span>
02901         <span class="comment">//</span>
02902         status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02903                                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02904                                                        &amp;hKey,
02905                                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02906                                                        hClass,
02907                                                        &amp;defaultString,
02908                                                        KEY_READ,
02909                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
02910                                                       );
02911 
02912         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02913             defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02914             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
02915             <span class="comment">//</span>
02916             <span class="comment">// Continue with the call but ignore the invalid default entry</span>
02917             <span class="comment">//</span>
02918 <span class="preprocessor">#if DBG_GET_ASSOC</span>
02919 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WDM Warning: Default entry for class %zW is invalid\n"</span>, &amp;guidString);
02920 <span class="preprocessor">#endif</span>
02921 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
02922 
02923             <span class="comment">//</span>
02924             <span class="comment">// If we are just supposed to return live interfaces, then make sure this default</span>
02925             <span class="comment">// interface is linked.</span>
02926             <span class="comment">//</span>
02927 
02928             <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>)) {
02929 
02930                 defaultPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02931 
02932                 <span class="comment">//</span>
02933                 <span class="comment">// Open the control subkey</span>
02934                 <span class="comment">//</span>
02935 
02936                 PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
02937                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
02938                                                hKey,
02939                                                &amp;tempString,
02940                                                KEY_ALL_ACCESS
02941                                                );
02942 
02943                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02944                     <span class="comment">//</span>
02945                     <span class="comment">// Get the linked value</span>
02946                     <span class="comment">//</span>
02947 
02948                     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
02949                     status = ZwQueryValueKey(hControl,
02950                                              &amp;tempString,
02951                                              KeyValuePartialInformation,
02952                                              (PVOID) infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
02953                                              infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
02954                                              &amp;resultSize
02955                                              );
02956 
02957                     ZwClose(hControl);
02958 
02959                     <span class="comment">//</span>
02960                     <span class="comment">// We don't need to check the buffer was big enough because it starts</span>
02961                     <span class="comment">// off that way and doesn't get any smaller!</span>
02962                     <span class="comment">//</span>
02963 
02964                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
02965                         &amp;&amp; (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Type == REG_DWORD)
02966                         &amp;&amp; (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG))) {
02967 
02968                         defaultPresent = *(PULONG)(((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Data)
02969                                        ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
02970                                        : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02971                     }
02972                 }
02973             }
02974 
02975             ZwClose(hKey);
02976 
02977             <span class="keywordflow">if</span>(defaultPresent) {
02978                 <span class="comment">//</span>
02979                 <span class="comment">// Add the default as the first entry in the return buffer and patch to usermode if necessary</span>
02980                 <span class="comment">//</span>
02981                 status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(&amp;returnBuffer,
02982                                          defaultString.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
02983                                          defaultString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
02984                                         );
02985 
02986                 <span class="keywordflow">if</span> (!UserModeFormat) {
02987 
02988                     RtlCopyMemory(returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
02989                                   <a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>,
02990                                   <a class="code" href="../../d8/d0/pnpioapi_8c.html#a24">KERNEL_SYMLINK_STRING_PREFIX_LENGTH</a>
02991                                   );
02992                 }
02993 
02994             } <span class="keywordflow">else</span> {
02995                 <span class="comment">//</span>
02996                 <span class="comment">// The default device interface isn't active--free the memory for the name buffer now.</span>
02997                 <span class="comment">//</span>
02998                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
02999             }
03000         }
03001 
03002     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND || status == STATUS_OBJECT_PATH_NOT_FOUND) {
03003         <span class="comment">//</span>
03004         <span class="comment">// Do nothing - there is no default</span>
03005         <span class="comment">//</span>
03006     } <span class="keywordflow">else</span> {
03007         <span class="comment">//</span>
03008         <span class="comment">// An unexpected error occured - clean up</span>
03009         <span class="comment">//</span>
03010         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03011 
03012             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
03013             status = STATUS_UNSUCCESSFUL;
03014         }
03015 
03016         ZwClose(hClass);
03017         <span class="keywordflow">goto</span> clean4;
03018     }
03019 
03020     <span class="comment">//</span>
03021     <span class="comment">// Iterate through the subkeys under this interface class key.</span>
03022     <span class="comment">//</span>
03023 
03024     keyIndex = 0;
03025 
03026     <span class="keywordflow">while</span>((status = ZwEnumerateKey(hClass,
03027                                    keyIndex,
03028                                    KeyBasicInformation,
03029                                    (PVOID) infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03030                                    infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
03031                                    &amp;resultSize
03032                                    )) != STATUS_NO_MORE_ENTRIES)
03033     {
03034 
03035         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
03036 
03037             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;infoBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03038 
03039             <span class="keywordflow">continue</span>;
03040 
03041         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03042             ZwClose(hClass);
03043             <span class="keywordflow">goto</span> clean4;
03044         }
03045 
03046         <span class="comment">//</span>
03047         <span class="comment">// Open up this interface key.</span>
03048         <span class="comment">//</span>
03049         tempString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength;
03050         tempString.MaximumLength = tempString.Length;
03051         tempString.Buffer = ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Name;
03052 
03053 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03054 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Key %u enumerated %wZ\n"</span>, keyIndex, &amp;tempString);
03055 <span class="preprocessor">#endif</span>
03056 <span class="preprocessor"></span>
03057         <span class="comment">//</span>
03058         <span class="comment">// Open the associated key</span>
03059         <span class="comment">//</span>
03060 
03061         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hKey,
03062                                        hClass,
03063                                        &amp;tempString,
03064                                        KEY_READ
03065                                        );
03066 
03067         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03068             <span class="comment">//</span>
03069             <span class="comment">// For some reason we couldn't open this key--skip it and move on.</span>
03070             <span class="comment">//</span>
03071 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03072 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tCouldn't open interface key!\n"</span>);
03073 <span class="preprocessor">#endif</span>
03074 <span class="preprocessor"></span>            keyIndex++;
03075             <span class="keywordflow">continue</span>;
03076         }
03077 
03078         <span class="comment">//</span>
03079         <span class="comment">// If we're filtering on a particular PDO, then retrieve the owning device</span>
03080         <span class="comment">// instance name for this interface key, and make sure they match.</span>
03081         <span class="comment">//</span>
03082         PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_DEVICE_INSTANCE);
03083         <span class="keywordflow">while</span> ((status = ZwQueryValueKey(hKey,
03084                                          &amp;tempString,
03085                                          KeyValuePartialInformation,
03086                                          devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03087                                          devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
03088                                          &amp;resultSize
03089                                          )) == STATUS_BUFFER_TOO_SMALL ) {
03090 
03091             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;devnodeNameBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03092 
03093             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03094                 ZwClose(hKey);
03095                 ZwClose(hClass);
03096                 <span class="keywordflow">goto</span> clean4;
03097             }
03098         }
03099 
03100         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03101               &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Type == REG_SZ
03102               &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength &gt; <span class="keyword">sizeof</span>(WCHAR) ) ) {
03103 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03104 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tDevice instance entry corrupt\n"</span>);
03105 <span class="preprocessor">#endif</span>
03106 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
03107         }
03108 
03109         <span class="comment">//</span>
03110         <span class="comment">// Build counted string</span>
03111         <span class="comment">//</span>
03112 
03113         devnodeString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
03114         devnodeString.MaximumLength = tempString.Length;
03115         devnodeString.Buffer = (PWSTR) ((PKEY_VALUE_PARTIAL_INFORMATION)(devnodeNameBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Data;
03116 
03117         <span class="comment">//</span>
03118         <span class="comment">// Enumerate each interface instance subkey under this PDO's interface key.</span>
03119         <span class="comment">//</span>
03120         instanceKeyIndex = 0;
03121 
03122         <span class="keywordflow">while</span>((status = ZwEnumerateKey(hKey,
03123                                        instanceKeyIndex,
03124                                        KeyBasicInformation,
03125                                        (PVOID) infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03126                                        infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
03127                                        &amp;resultSize
03128                                        )) != STATUS_NO_MORE_ENTRIES)
03129         {
03130 
03131             <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
03132 
03133                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;infoBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03134 
03135                 <span class="keywordflow">continue</span>;
03136 
03137             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03138                 ZwClose(hKey);
03139                 ZwClose(hClass);
03140                 <span class="keywordflow">goto</span> clean4;
03141             }
03142 
03143             <span class="comment">//</span>
03144             <span class="comment">// Open up this interface instance key.</span>
03145             <span class="comment">//</span>
03146             tempString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength;
03147             tempString.MaximumLength = tempString.Length;
03148             tempString.Buffer = ((PKEY_BASIC_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Name;
03149 
03150 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03151 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Instance key %u enumerated %wZ\n"</span>, instanceKeyIndex, &amp;tempString);
03152 <span class="preprocessor">#endif</span>
03153 <span class="preprocessor"></span>
03154             <span class="comment">//</span>
03155             <span class="comment">// Open the associated key</span>
03156             <span class="comment">//</span>
03157 
03158             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInstanceKey,
03159                                            hKey,
03160                                            &amp;tempString,
03161                                            KEY_READ
03162                                            );
03163 
03164             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03165                 <span class="comment">//</span>
03166                 <span class="comment">// For some reason we couldn't open this key--skip it and move on.</span>
03167                 <span class="comment">//</span>
03168 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03169 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tCouldn't open interface key!\n"</span>);
03170 <span class="preprocessor">#endif</span>
03171 <span class="preprocessor"></span>                instanceKeyIndex++;
03172                 <span class="keywordflow">continue</span>;
03173             }
03174 
03175             <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>)) {
03176 
03177                 <span class="comment">//</span>
03178                 <span class="comment">// Open the control subkey</span>
03179                 <span class="comment">//</span>
03180 
03181                 PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
03182                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
03183                                                hInstanceKey,
03184                                                &amp;tempString,
03185                                                KEY_READ
03186                                                );
03187 
03188                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03189 
03190                     <span class="comment">//</span>
03191                     <span class="comment">// We have no control subkey so can't be linked -</span>
03192                     <span class="comment">// continue enumerating the keys ignoring this one</span>
03193                     <span class="comment">//</span>
03194 
03195 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03196 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNo control subkey\n"</span>);
03197 <span class="preprocessor">#endif</span>
03198 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03199                 }
03200 
03201                 <span class="comment">//</span>
03202                 <span class="comment">// Get the linked value</span>
03203                 <span class="comment">//</span>
03204 
03205                 PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
03206                 status = ZwQueryValueKey(hControl,
03207                                          &amp;tempString,
03208                                          KeyValuePartialInformation,
03209                                          (PVOID) infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03210                                          infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
03211                                          &amp;resultSize
03212                                          );
03213 
03214                 ZwClose(hControl);
03215 
03216                 <span class="comment">//</span>
03217                 <span class="comment">// We don't need to check the buffer was big enough because it starts</span>
03218                 <span class="comment">// off that way and doesn't get any smaller!</span>
03219                 <span class="comment">//</span>
03220 
03221                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03222                     || (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Type != REG_DWORD)
03223                     || (((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength != <span class="keyword">sizeof</span>(ULONG))
03224                     || !*(PULONG)(((PKEY_VALUE_PARTIAL_INFORMATION)(infoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Data)) {
03225 
03226                     <span class="comment">//</span>
03227                     <span class="comment">// We are NOT linked so continue enumerating the keys ignoring this one</span>
03228                     <span class="comment">//</span>
03229 
03230 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03231 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNot Linked\n"</span>);
03232 <span class="preprocessor">#endif</span>
03233 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03234                 }
03235             }
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// Open the "SymbolicLink" value and place the information into the symLink buffer</span>
03239             <span class="comment">//</span>
03240 
03241             PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_SYMBOLIC_LINK);
03242             <span class="keywordflow">while</span> ((status = ZwQueryValueKey(hInstanceKey,
03243                                              &amp;tempString,
03244                                              KeyValuePartialInformation,
03245                                              symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03246                                              symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
03247                                              &amp;resultSize
03248                                              )) == STATUS_BUFFER_TOO_SMALL ) {
03249 
03250                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;symLinkBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03251 
03252                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03253                     ZwClose(hInstanceKey);
03254                     ZwClose(hKey);
03255                     ZwClose(hClass);
03256                     <span class="keywordflow">goto</span> clean4;
03257                 }
03258             }
03259 
03260             <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)
03261                 &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Type == REG_SZ
03262                 &amp;&amp; ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength &gt; <span class="keyword">sizeof</span>(WCHAR) ) ) {
03263 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03264 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tSymbolic link entry corrupt\n"</span>);
03265 <span class="preprocessor">#endif</span>
03266 <span class="preprocessor"></span>                <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03267             }
03268 
03269             <span class="comment">//</span>
03270             <span class="comment">// Build counted string from value data</span>
03271             <span class="comment">//</span>
03272 
03273             symLinkString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;DataLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
03274             symLinkString.MaximumLength = symLinkString.Length;
03275             symLinkString.Buffer = (PWSTR) ((PKEY_VALUE_PARTIAL_INFORMATION)(symLinkBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Data;
03276 
03277             <span class="comment">//</span>
03278             <span class="comment">// If we have a default, check this is not it</span>
03279             <span class="comment">//</span>
03280 
03281             <span class="keywordflow">if</span> (defaultPresent) {
03282 
03283                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;defaultString, &amp;symLinkString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) == 0) {
03284 
03285                     <span class="comment">//</span>
03286                     <span class="comment">// We have already added the default to the beginning of the buffer so skip it</span>
03287                     <span class="comment">//</span>
03288 
03289 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03290 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tDefault entry skipped\n"</span>);
03291 <span class="preprocessor">#endif</span>
03292 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03293                 }
03294             }
03295 
03296             <span class="comment">//</span>
03297             <span class="comment">// If we are only returning interfaces for a particular PDO then check</span>
03298             <span class="comment">// this is from that PDO</span>
03299             <span class="comment">//</span>
03300             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(DevicePath)) {
03301                 <span class="comment">//</span>
03302                 <span class="comment">// Check if it is from the same PDO</span>
03303                 <span class="comment">//</span>
03304                 <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(DevicePath, &amp;devnodeString, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) != 0) {
03305                     <span class="comment">//</span>
03306                     <span class="comment">// If not then go onto the next key</span>
03307                     <span class="comment">//</span>
03308 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03309 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tNot from the correct PDO\n"</span>);
03310 <span class="preprocessor">#endif</span>
03311 <span class="preprocessor"></span>                    <span class="keywordflow">goto</span> CloseInterfaceInstanceKeyAndContinue;
03312                 }
03313             }
03314 
03315             <span class="comment">//</span>
03316             <span class="comment">// Copy the symLink string to the return buffer including the NULL termination</span>
03317             <span class="comment">//</span>
03318 
03319             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a59">IopAppendBuffer</a>(&amp;returnBuffer,
03320                                      symLinkString.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
03321                                      symLinkString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
03322                                      );
03323 
03324             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PWSTR) returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o1">Current</a>)[-1] == UNICODE_NULL);
03325 
03326 <span class="preprocessor">#if DBG_GET_ASSOC</span>
03327 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\tAdded to return buffer\n"</span>);
03328 <span class="preprocessor">#endif</span>
03329 <span class="preprocessor"></span>
03330             <span class="comment">//</span>
03331             <span class="comment">// If we are returning KM strings then patch the prefix</span>
03332             <span class="comment">//</span>
03333 
03334             <span class="keywordflow">if</span> (!UserModeFormat) {
03335 
03336                 RtlCopyMemory(returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o1">Current</a> - (symLinkString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)),
03337                               <a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>,
03338                               <a class="code" href="../../d8/d0/pnpioapi_8c.html#a24">KERNEL_SYMLINK_STRING_PREFIX_LENGTH</a>
03339                               );
03340             }
03341 
03342 CloseInterfaceInstanceKeyAndContinue:
03343             ZwClose(hInstanceKey);
03344             instanceKeyIndex++;
03345         }
03346 
03347 CloseInterfaceKeyAndContinue:
03348         ZwClose(hKey);
03349         keyIndex++;
03350     }
03351 
03352     ZwClose(hClass);
03353 
03354 clean5:
03355     <span class="comment">//</span>
03356     <span class="comment">// We've got then all!  Resize to leave space for a terminating NULL.</span>
03357     <span class="comment">//</span>
03358 
03359     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;returnBuffer,
03360                              (ULONG) (returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o1">Current</a> - returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a> + <span class="keyword">sizeof</span>(UNICODE_NULL)),
03361                              <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
03362                              );
03363 
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// Terminate the buffer</span>
03368         <span class="comment">//</span>
03369         *((PWSTR) returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o1">Current</a>) = UNICODE_NULL;
03370     }
03371 
03372 clean4:
03373     <span class="keywordflow">if</span> (defaultPresent) {
03374         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDefaultInfo);
03375     }
03376 
03377 clean3:
03378     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03379     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03380     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;devnodeNameBuffer);
03381 
03382 clean2a:
03383     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;symLinkBuffer);
03384 
03385 clean2:
03386     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;infoBuffer);
03387 
03388 clean1:
03389     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03390         <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;returnBuffer);
03391     }
03392 
03393 clean0:
03394     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidString);
03395 
03396 finalClean:
03397     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03398 
03399         *SymbolicLinkList = (PWSTR) returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>;
03400 
03401         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SymbolicLinkListSize)) {
03402             *SymbolicLinkListSize = returnBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>;
03403         }
03404 
03405     } <span class="keywordflow">else</span> {
03406 
03407         *SymbolicLinkList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03408 
03409         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(SymbolicLinkListSize)) {
03410             *SymbolicLinkListSize = 0;
03411         }
03412 
03413     }
03414 
03415     <span class="keywordflow">return</span> status;
03416 }
03417 
03418 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03419"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a86">03419</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a86">IoGetDeviceInterfaces</a>(
03420     IN CONST GUID *InterfaceClassGuid,
03421     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject OPTIONAL,
03422     IN ULONG Flags,
03423     OUT PWSTR *SymbolicLinkList
03424     )
03425 
03426 <span class="comment">/*++</span>
03427 <span class="comment"></span>
03428 <span class="comment">Routine Description:</span>
03429 <span class="comment"></span>
03430 <span class="comment">    This API allows a WDM driver to get a list of paths that represent all</span>
03431 <span class="comment">    device interfaces registered for the specified interface class.</span>
03432 <span class="comment"></span>
03433 <span class="comment">Parameters:</span>
03434 <span class="comment"></span>
03435 <span class="comment">    InterfaceClassGuid - Supplies a pointer to a GUID representing the interface class</span>
03436 <span class="comment">        for whom a list of members is to be retrieved</span>
03437 <span class="comment"></span>
03438 <span class="comment">    PhysicalDeviceObject - Optionally, supplies a pointer to the PDO for whom</span>
03439 <span class="comment">        interfaces of the specified class are to be re-trieved.  If this parameter</span>
03440 <span class="comment">        is not supplied, then all interface devices (regardless of what physical</span>
03441 <span class="comment">        device exposes them) will be returned.</span>
03442 <span class="comment"></span>
03443 <span class="comment">    Flags - Supplies flags that modify the behavior of list retrieval.</span>
03444 <span class="comment">        The following flags are presently defined:</span>
03445 <span class="comment"></span>
03446 <span class="comment">        DEVICE_INTERFACE_INCLUDE_NONACTIVE -- If this flag is specified, then all</span>
03447 <span class="comment">            device interfaces, whether currently active or not, will be returned</span>
03448 <span class="comment">            (potentially filtered based on the PhysicalDeviceObject, if specified).</span>
03449 <span class="comment"></span>
03450 <span class="comment">    SymbolicLinkList - Supplies the address of a character pointer, that on</span>
03451 <span class="comment">        success will contain a multi-sz list of \DosDevices\ symbolic link</span>
03452 <span class="comment">        names that provide the requested functionality.  The caller is</span>
03453 <span class="comment">        responsible for freeing the memory via ExFreePool</span>
03454 <span class="comment"></span>
03455 <span class="comment">Return Value:</span>
03456 <span class="comment"></span>
03457 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03458 <span class="comment"></span>
03459 <span class="comment">--*/</span>
03460 
03461 {
03462     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03463     PUNICODE_STRING pDeviceName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03464     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> pDeviceNode;
03465 
03466     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03467 
03468     <span class="comment">//</span>
03469     <span class="comment">// Check we have a PDO and if so extract the instance path from it</span>
03470     <span class="comment">//</span>
03471 
03472     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PhysicalDeviceObject)) {
03473 
03474         <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(PhysicalDeviceObject);
03475         pDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03476         pDeviceName = &amp;pDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
03477     }
03478 
03479     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a355">IopGetDeviceInterfaces</a>(InterfaceClassGuid,
03480                                     pDeviceName,
03481                                     Flags,
03482                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03483                                     SymbolicLinkList,
03484                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03485                                     );
03486     <span class="keywordflow">return</span> status;
03487 }
03488 
03489 
03490 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03491"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a61">03491</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a61">IopRealloc</a>(
03492     IN OUT PVOID *Buffer,
03493     IN ULONG OldSize,
03494     IN ULONG NewSize
03495 )
03496 
03497 <span class="comment">/*++</span>
03498 <span class="comment"></span>
03499 <span class="comment">Routine Description:</span>
03500 <span class="comment"></span>
03501 <span class="comment">    This implements a variation of the traditional C realloc routine.</span>
03502 <span class="comment"></span>
03503 <span class="comment">Parameters:</span>
03504 <span class="comment"></span>
03505 <span class="comment">    Buffer - Supplies a pointer to a pointer to the buffer that is being</span>
03506 <span class="comment">        reallocated.  On sucessful completion it the pointer will be updated</span>
03507 <span class="comment">        to point to the new buffer, on failure it will still point to the old</span>
03508 <span class="comment">        buffer.</span>
03509 <span class="comment"></span>
03510 <span class="comment">    OldSize - The size in bytes of the memory block referenced by Buffer</span>
03511 <span class="comment"></span>
03512 <span class="comment">    NewSize - The desired new size in bytes of the buffer.  This can be larger</span>
03513 <span class="comment">        or smaller than the OldSize</span>
03514 <span class="comment"></span>
03515 <span class="comment">Return Value:</span>
03516 <span class="comment"></span>
03517 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03518 <span class="comment"></span>
03519 <span class="comment">--*/</span>
03520 
03521 {
03522 
03523     PVOID newBuffer;
03524 
03525     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03526 
03527     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
03528 
03529     <span class="comment">//</span>
03530     <span class="comment">// Allocate a new buffer</span>
03531     <span class="comment">//</span>
03532 
03533     <span class="keywordflow">if</span> (!(newBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, NewSize))) {
03534         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03535     }
03536 
03537     <span class="comment">//</span>
03538     <span class="comment">// Copy the contents of the old buffer</span>
03539     <span class="comment">//</span>
03540 
03541     <span class="keywordflow">if</span>(OldSize &lt;= NewSize) {
03542         RtlCopyMemory(newBuffer, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> , OldSize);
03543     } <span class="keywordflow">else</span> {
03544         RtlCopyMemory(newBuffer, *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> , NewSize);
03545     }
03546     <span class="comment">//</span>
03547     <span class="comment">// Free up the old buffer</span>
03548     <span class="comment">//</span>
03549 
03550     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>);
03551 
03552     <span class="comment">//</span>
03553     <span class="comment">// Hand the new buffer back to the caller</span>
03554     <span class="comment">//</span>
03555 
03556     *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = newBuffer;
03557 
03558     <span class="keywordflow">return</span> STATUS_SUCCESS;
03559 
03560 }
03561 
03562 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03563"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a87">03563</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a87">IoSetDeviceInterfaceState</a>(
03564     IN PUNICODE_STRING SymbolicLinkName,
03565     IN BOOLEAN Enable
03566     )
03567 
03568 <span class="comment">/*++</span>
03569 <span class="comment"></span>
03570 <span class="comment">Routine Description:</span>
03571 <span class="comment"></span>
03572 <span class="comment">    This DDI allows a device class to activate and deactivate an association</span>
03573 <span class="comment">    previously registered using IoRegisterDeviceInterface</span>
03574 <span class="comment"></span>
03575 <span class="comment">Parameters:</span>
03576 <span class="comment"></span>
03577 <span class="comment">    SymbolicLinkName - Supplies a pointer to the symbolic link name which was</span>
03578 <span class="comment">        returned by IoRegisterDeviceInterface when the interface was registered,</span>
03579 <span class="comment">        or as returned by IoGetDeviceInterfaces.</span>
03580 <span class="comment"></span>
03581 <span class="comment">    Enable - If TRUE (non-zero), the interface will be enabled.  If FALSE, it</span>
03582 <span class="comment">        will be disabled.</span>
03583 <span class="comment"></span>
03584 <span class="comment">Return Value:</span>
03585 <span class="comment"></span>
03586 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03587 <span class="comment"></span>
03588 <span class="comment">--*/</span>
03589 
03590 {
03591     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03592 
03593     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03594 
03595     <span class="comment">//</span>
03596     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
03597     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
03598     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
03599     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
03600     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
03601     <span class="comment">// portion solves this problem</span>
03602     <span class="comment">//</span>
03603 
03604     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03605     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03606 
03607     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a357">IopProcessSetInterfaceState</a>(SymbolicLinkName, Enable, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03608 
03609     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03610     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03611 
03612     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !Enable) {
03613         <span class="comment">//</span>
03614         <span class="comment">// If we failed to disable an interface (most likely because the</span>
03615         <span class="comment">// interface keys have already been deleted) report success.</span>
03616         <span class="comment">//</span>
03617         status = STATUS_SUCCESS;
03618     }
03619 
03620     <span class="keywordflow">return</span> status;
03621 }
03622 
03623 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03624"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a88">03624</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a88">IoOpenDeviceInterfaceRegistryKey</a>(
03625     IN PUNICODE_STRING SymbolicLinkName,
03626     IN ACCESS_MASK DesiredAccess,
03627     OUT PHANDLE DeviceInterfaceKey
03628     )
03629 
03630 <span class="comment">/*++</span>
03631 <span class="comment"></span>
03632 <span class="comment">Routine Description:</span>
03633 <span class="comment"></span>
03634 <span class="comment">    This routine will open the registry key where the data associated with a</span>
03635 <span class="comment">    specific device interface can be stored.</span>
03636 <span class="comment"></span>
03637 <span class="comment">Parameters:</span>
03638 <span class="comment"></span>
03639 <span class="comment">    SymbolicLinkName - Supplies a pointer to the symbolic link name which was</span>
03640 <span class="comment">        returned by IoRegisterDeviceInterface when the device class was registered.</span>
03641 <span class="comment"></span>
03642 <span class="comment">    DesiredAccess - Supplies the access privileges to the key the caller wants.</span>
03643 <span class="comment"></span>
03644 <span class="comment">    DeviceInterfaceKey - Supplies a pointer to a handle which on success will</span>
03645 <span class="comment">        contain the handle to the requested registry key.</span>
03646 <span class="comment"></span>
03647 <span class="comment">Return Value:</span>
03648 <span class="comment"></span>
03649 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03650 <span class="comment"></span>
03651 <span class="comment">--*/</span>
03652 
03653 {
03654     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03655     HANDLE hKey;
03656     UNICODE_STRING unicodeString;
03657 
03658     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03659 
03660     <span class="comment">//</span>
03661     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
03662     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
03663     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
03664     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
03665     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
03666     <span class="comment">// portion solves this problem</span>
03667     <span class="comment">//</span>
03668 
03669     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03670     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03671 
03672     <span class="comment">//</span>
03673     <span class="comment">// Open the interface device key</span>
03674     <span class="comment">//</span>
03675 
03676     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
03677                                                     KEY_READ,
03678                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03679                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03680                                                     &amp;hKey
03681                                                     );
03682     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03683         <span class="keywordflow">goto</span> clean0;
03684     }
03685 
03686     <span class="comment">//</span>
03687     <span class="comment">// Open the "Device Parameters" subkey.</span>
03688     <span class="comment">//</span>
03689 
03690     PiWstrToUnicodeString(&amp;unicodeString, REGSTR_KEY_DEVICEPARAMETERS);
03691     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( DeviceInterfaceKey,
03692                                      hKey,
03693                                      &amp;unicodeString,
03694                                      DesiredAccess,
03695                                      REG_OPTION_NON_VOLATILE,
03696                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
03697                                      );
03698     ZwClose(hKey);
03699 
03700 clean0:
03701     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03702     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03703 
03704     <span class="keywordflow">return</span> status;
03705 }
03706 
03707 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03708"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">03708</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(
03709     IN PUNICODE_STRING SymbolicLinkName,
03710     IN ACCESS_MASK DesiredAccess,
03711     OUT PHANDLE DeviceInterfaceClassKey    OPTIONAL,
03712     OUT PHANDLE DeviceInterfaceKey         OPTIONAL,
03713     OUT PHANDLE DeviceInterfaceInstanceKey OPTIONAL
03714     )
03715 
03716 <span class="comment">/*++</span>
03717 <span class="comment"></span>
03718 <span class="comment">Routine Description:</span>
03719 <span class="comment"></span>
03720 <span class="comment">    This routine will open the registry key where the data associated with the</span>
03721 <span class="comment">    device pointed to by SymbolicLinkName is stored.  If the path does not exist</span>
03722 <span class="comment">    it will not be created.</span>
03723 <span class="comment"></span>
03724 <span class="comment">Parameters:</span>
03725 <span class="comment"></span>
03726 <span class="comment">    SymbolicLinkName - Supplies a pointer to the symbolic link name.</span>
03727 <span class="comment"></span>
03728 <span class="comment">    DesiredAccess - Supplies the access privto the function class instance key the</span>
03729 <span class="comment">        caller wants.</span>
03730 <span class="comment"></span>
03731 <span class="comment">    DeviceInterfaceClassKey - Optionally, supplies the address of a variable that</span>
03732 <span class="comment">        receives a handle to the device class key for the interface.</span>
03733 <span class="comment"></span>
03734 <span class="comment">    DeviceInterfaceKey - Optionally, supplies the address of a variable that receives</span>
03735 <span class="comment">        a handle to the device interface (parent) key.</span>
03736 <span class="comment"></span>
03737 <span class="comment">    DeviceInterfaceInstanceKey - Optionally, Supplies the address of a variable that</span>
03738 <span class="comment">        receives a handle to the device interface instance key (i.e., the</span>
03739 <span class="comment">        refstring-specific one).</span>
03740 <span class="comment"></span>
03741 <span class="comment">Return Value:</span>
03742 <span class="comment"></span>
03743 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03744 <span class="comment"></span>
03745 <span class="comment"></span>
03746 <span class="comment">--*/</span>
03747 
03748 {
03749     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03750     UNICODE_STRING guidString, tempString;
03751     HANDLE hDeviceClasses, hFunctionClass;
03752 
03753     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03754 
03755     <span class="comment">//</span>
03756     <span class="comment">// Get guid from symbolic link name</span>
03757     <span class="comment">//</span>
03758     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;guidString, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03759 
03760     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
03761         <span class="keywordflow">goto</span> clean0;
03762     }
03763 
03764     <span class="comment">//</span>
03765     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
03766     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
03767     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
03768     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
03769     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
03770     <span class="comment">// portion solves this problem</span>
03771     <span class="comment">//</span>
03772 
03773     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
03774     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03775 
03776     <span class="comment">//</span>
03777     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses key</span>
03778     <span class="comment">//</span>
03779 
03780     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
03781     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hDeviceClasses,
03782                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03783                                    &amp;tempString,
03784                                    KEY_READ
03785                                    );
03786 
03787     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
03788         <span class="keywordflow">goto</span> clean1;
03789     }
03790 
03791     <span class="comment">//</span>
03792     <span class="comment">// Open function class GUID key</span>
03793     <span class="comment">//</span>
03794 
03795     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hFunctionClass,
03796                                    hDeviceClasses,
03797                                    &amp;guidString,
03798                                    KEY_READ
03799                                    );
03800 
03801     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
03802         <span class="keywordflow">goto</span> clean2;
03803     }
03804 
03805     <span class="comment">//</span>
03806     <span class="comment">// Open device interface instance key</span>
03807     <span class="comment">//</span>
03808     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(DeviceInterfaceKey,
03809                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03810                                                    DeviceInterfaceInstanceKey,
03811                                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03812                                                    hFunctionClass,
03813                                                    SymbolicLinkName,
03814                                                    DesiredAccess,
03815                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
03816                                                   );
03817 
03818     <span class="keywordflow">if</span>((!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) || (!ARGUMENT_PRESENT(DeviceInterfaceClassKey))) {
03819         ZwClose(hFunctionClass);
03820     } <span class="keywordflow">else</span> {
03821         *DeviceInterfaceClassKey = hFunctionClass;
03822     }
03823 
03824 clean2:
03825     ZwClose(hDeviceClasses);
03826 clean1:
03827     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
03828     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
03829 clean0:
03830     <span class="keywordflow">return</span> status;
03831 
03832 }
03833 
03834 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03835"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a89">03835</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a89">IoRegisterDeviceInterface</a>(
03836     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
03837     IN CONST GUID *InterfaceClassGuid,
03838     IN PUNICODE_STRING ReferenceString      OPTIONAL,
03839     OUT PUNICODE_STRING SymbolicLinkName
03840     )
03841 
03842 <span class="comment">/*++</span>
03843 <span class="comment"></span>
03844 <span class="comment">Routine Description:</span>
03845 <span class="comment"></span>
03846 <span class="comment">    This device driver interface allows a WDM driver to register a particular</span>
03847 <span class="comment">    interface of its underlying hardware (ie PDO) as a member of a function class.</span>
03848 <span class="comment"></span>
03849 <span class="comment">Parameters:</span>
03850 <span class="comment"></span>
03851 <span class="comment">    PhysicalDeviceObject - Supplies a pointer to the PDO for the P&amp;P device</span>
03852 <span class="comment">        instance associated with the functionality being registered</span>
03853 <span class="comment"></span>
03854 <span class="comment">    InterfaceClassGuid - Supplies a pointer to the GUID representring the functionality</span>
03855 <span class="comment">        to be registered</span>
03856 <span class="comment"></span>
03857 <span class="comment">    ReferenceString - Optionally, supplies an additional context string which is</span>
03858 <span class="comment">        appended to the enumeration path of the device</span>
03859 <span class="comment"></span>
03860 <span class="comment">    SymbolicLinkName - Supplies a pointer to a string which on success will contain the</span>
03861 <span class="comment">        kernel mode path of the symbolic link used to open this device.</span>
03862 <span class="comment"></span>
03863 <span class="comment">Return Value:</span>
03864 <span class="comment"></span>
03865 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03866 <span class="comment"></span>
03867 <span class="comment">--*/</span>
03868 
03869 {
03870     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> pDeviceNode;
03871     PUNICODE_STRING pDeviceString;
03872     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03873     PWSTR   pRefString;
03874     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  count;
03875 
03876     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03877 
03878     <span class="comment">//</span>
03879     <span class="comment">// Until PartMgr/Disk stop registering non PDOs allow the system to boot.</span>
03880     <span class="comment">//</span>
03881     <span class="comment">// ASSERT_PDO(PhysicalDeviceObject);</span>
03882     <span class="comment">//</span>
03883 
03884     <span class="comment">//</span>
03885     <span class="comment">// Ensure we have a PDO - only PDO's have a device node attached</span>
03886     <span class="comment">//</span>
03887 
03888     pDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
03889     <span class="keywordflow">if</span> (pDeviceNode) {
03890 
03891         <span class="comment">//</span>
03892         <span class="comment">// Get the instance path string</span>
03893         <span class="comment">//</span>
03894         pDeviceString = &amp;pDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
03895 
03896         <span class="keywordflow">if</span> (pDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Length == 0) {
03897             <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
03898         }
03899 
03900         <span class="comment">//</span>
03901         <span class="comment">// Make sure the ReferenceString does not contain any path seperator characters</span>
03902         <span class="comment">//</span>
03903         <span class="keywordflow">if</span> (ReferenceString) {
03904             pRefString = ReferenceString-&gt;Buffer;
03905             count = ReferenceString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
03906             <span class="keywordflow">while</span> (count--) {
03907                 <span class="keywordflow">if</span>((*pRefString == <a class="code" href="../../d8/d0/pnpioapi_8c.html#a17">SEPERATOR_CHAR</a>) || (*pRefString == <a class="code" href="../../d8/d0/pnpioapi_8c.html#a18">ALT_SEPERATOR_CHAR</a>)) {
03908                     status = STATUS_INVALID_DEVICE_REQUEST;
03909                     KdPrint((<span class="stringliteral">"IoRegisterDeviceInterface: Invalid RefString!! failed with status = %8.8X\n"</span>, status));
03910                     <span class="keywordflow">return</span> status;
03911                 }
03912                 pRefString++;
03913             }
03914         }
03915 
03916         <span class="keywordflow">return</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a352">IopRegisterDeviceInterface</a>(pDeviceString,
03917                                           InterfaceClassGuid,
03918                                           ReferenceString,
03919                                           <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,           <span class="comment">// kernel-mode format</span>
03920                                           SymbolicLinkName
03921                                           );
03922     } <span class="keywordflow">else</span> {
03923 
03924         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
03925     }
03926 }
03927 
03928 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l03929"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a352">03929</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a352">IopRegisterDeviceInterface</a>(
03930     IN PUNICODE_STRING DeviceInstanceName,
03931     IN CONST GUID *InterfaceClassGuid,
03932     IN PUNICODE_STRING ReferenceString      OPTIONAL,
03933     IN BOOLEAN UserModeFormat,
03934     OUT PUNICODE_STRING SymbolicLinkName
03935     )
03936 
03937 <span class="comment">/*++</span>
03938 <span class="comment"></span>
03939 <span class="comment">Routine Description:</span>
03940 <span class="comment"></span>
03941 <span class="comment">    This is the worker routine for PnpRegisterDeviceInterface.  It is also</span>
03942 <span class="comment">    called by the user-mode ConfigMgr (via an NtPlugPlayControl), which is why it</span>
03943 <span class="comment">    must take a device instance name instead of a PDO (since the device instance</span>
03944 <span class="comment">    may not currently be 'live'), and also why it must optionally return the user-</span>
03945 <span class="comment">    mode form of the interface device name (i.e., "\\?\" instead of "\??\").</span>
03946 <span class="comment"></span>
03947 <span class="comment">Parameters:</span>
03948 <span class="comment"></span>
03949 <span class="comment">    DeviceInstanceName - Supplies the name of the device instance for which a</span>
03950 <span class="comment">        device interface is being registered.</span>
03951 <span class="comment"></span>
03952 <span class="comment">    InterfaceClassGuid - Supplies a pointer to the GUID representring the class</span>
03953 <span class="comment">        of the device interface being registered.</span>
03954 <span class="comment"></span>
03955 <span class="comment">    ReferenceString - Optionally, supplies an additional context string which is</span>
03956 <span class="comment">        appended to the enumeration path of the device</span>
03957 <span class="comment"></span>
03958 <span class="comment">    UserModeFormat - If non-zero, then the symbolic link name returned for the</span>
03959 <span class="comment">        interface device is in user-mode form (i.e., "\\?\").  If zero (FALSE),</span>
03960 <span class="comment">        it is in kernel-mode form (i.e., "\??\").</span>
03961 <span class="comment"></span>
03962 <span class="comment">    SymbolicLinkName - Supplies a pointer to a string which on success will contain</span>
03963 <span class="comment">        either the kernel-mode or user-mode path of the symbolic link used to open</span>
03964 <span class="comment">        this device.</span>
03965 <span class="comment"></span>
03966 <span class="comment">Return Value:</span>
03967 <span class="comment"></span>
03968 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
03969 <span class="comment"></span>
03970 <span class="comment">--*/</span>
03971 
03972 {
03973     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03974     UNICODE_STRING tempString, guidString, otherString;
03975     PUNICODE_STRING pUserString, pKernelString;
03976     HANDLE hTemp1, hTemp2, hInterfaceInstanceKey;
03977     ULONG InterfaceDisposition, InterfaceInstanceDisposition;
03978 
03979     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03980 
03981     <span class="comment">//</span>
03982     <span class="comment">// Convert the class guid into string form</span>
03983     <span class="comment">//</span>
03984 
03985     status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a>(InterfaceClassGuid, &amp;guidString);
03986     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
03987         <span class="keywordflow">goto</span> clean0;
03988     }
03989 
03990     <span class="comment">//</span>
03991     <span class="comment">// Construct both flavors of symbolic link name (go ahead and store the form</span>
03992     <span class="comment">// that the user wants in the SymbolicLinkName parameter they supplied--this</span>
03993     <span class="comment">// saves us from having to copy the appropriate string over to their string</span>
03994     <span class="comment">// later).</span>
03995     <span class="comment">//</span>
03996     <span class="keywordflow">if</span>(UserModeFormat) {
03997         pUserString = SymbolicLinkName;
03998         pKernelString = &amp;otherString;
03999     } <span class="keywordflow">else</span> {
04000         pKernelString = SymbolicLinkName;
04001         pUserString = &amp;otherString;
04002     }
04003 
04004     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a63">IopBuildSymbolicLinkStrings</a>(DeviceInstanceName,
04005                                          &amp;guidString,
04006                                          ReferenceString,
04007                                          pUserString,
04008                                          pKernelString
04009                                          );
04010     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04011         <span class="keywordflow">goto</span> clean1;
04012     }
04013 
04014     <span class="comment">//</span>
04015     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
04016     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
04017     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
04018     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
04019     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
04020     <span class="comment">// portion solves this problem</span>
04021     <span class="comment">//</span>
04022 
04023     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04024     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04025 
04026     <span class="comment">//</span>
04027     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses key into hTemp1</span>
04028     <span class="comment">//</span>
04029 
04030     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
04031     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTemp1,
04032                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04033                                      &amp;tempString,
04034                                      KEY_CREATE_SUB_KEY,
04035                                      REG_OPTION_NON_VOLATILE,
04036                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04037                                      );
04038 
04039     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
04040         <span class="keywordflow">goto</span> clean2;
04041     }
04042 
04043     <span class="comment">//</span>
04044     <span class="comment">// Open/create function class GUID key into hTemp2</span>
04045     <span class="comment">//</span>
04046 
04047     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTemp2,
04048                                      hTemp1,
04049                                      &amp;guidString,
04050                                      KEY_CREATE_SUB_KEY,
04051                                      REG_OPTION_NON_VOLATILE,
04052                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04053                                      );
04054     ZwClose(hTemp1);
04055 
04056     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
04057         <span class="keywordflow">goto</span> clean2;
04058     }
04059 
04060     <span class="comment">//</span>
04061     <span class="comment">// Now open/create the two-level device interface hierarchy underneath this</span>
04062     <span class="comment">// interface class key.</span>
04063     <span class="comment">//</span>
04064     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(&amp;hTemp1,
04065                                                    &amp;InterfaceDisposition,
04066                                                    &amp;hInterfaceInstanceKey,
04067                                                    &amp;InterfaceInstanceDisposition,
04068                                                    hTemp2,
04069                                                    pUserString,
04070                                                    KEY_WRITE | DELETE,
04071                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
04072                                                   );
04073 
04074     ZwClose(hTemp2);
04075 
04076     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04077         <span class="keywordflow">goto</span> clean2;
04078     }
04079 
04080     <span class="comment">//</span>
04081     <span class="comment">// Create the device instance value under the device interface key</span>
04082     <span class="comment">//</span>
04083 
04084     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_DEVICE_INSTANCE);
04085     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue</a>(hTemp1,
04086                                        &amp;tempString,
04087                                        DeviceInstanceName
04088                                        );
04089     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04090         <span class="keywordflow">goto</span> clean3;
04091     }
04092 
04093     <span class="comment">//</span>
04094     <span class="comment">// Create symbolic link value under interface instance subkey</span>
04095     <span class="comment">//</span>
04096 
04097     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_SYMBOLIC_LINK);
04098     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue</a>(hInterfaceInstanceKey,
04099                                        &amp;tempString,
04100                                        pUserString
04101                                        );
04102 
04103 clean3:
04104     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04105         <span class="comment">//</span>
04106         <span class="comment">// Since we failed to register the device interface, delete any keys</span>
04107         <span class="comment">// that were newly created in the attempt.</span>
04108         <span class="comment">//</span>
04109         <span class="keywordflow">if</span>(InterfaceInstanceDisposition == REG_CREATED_NEW_KEY) {
04110             ZwDeleteKey(hInterfaceInstanceKey);
04111         } <span class="keywordflow">else</span> {
04112             ZwClose(hInterfaceInstanceKey);
04113         }
04114 
04115         <span class="keywordflow">if</span>(InterfaceDisposition == REG_CREATED_NEW_KEY) {
04116             ZwDeleteKey(hTemp1);
04117         } <span class="keywordflow">else</span> {
04118             ZwClose(hTemp1);
04119         }
04120     } <span class="keywordflow">else</span> {
04121         ZwClose(hInterfaceInstanceKey);
04122         ZwClose(hTemp1);
04123     }
04124 
04125 clean2:
04126     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
04127     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04128     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;otherString);
04129     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04130         <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(SymbolicLinkName);
04131     }
04132 
04133 clean1:
04134     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidString);
04135 clean0:
04136     <span class="keywordflow">return</span> status;
04137 }
04138 
04139 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04140"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a353">04140</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a353">IopUnregisterDeviceInterface</a>(
04141     IN PUNICODE_STRING SymbolicLinkName
04142     )
04143 
04144 <span class="comment">/*++</span>
04145 <span class="comment"></span>
04146 <span class="comment">Routine Description:</span>
04147 <span class="comment"></span>
04148 <span class="comment">    This routine removes the interface instance subkey of</span>
04149 <span class="comment">    ReferenceString from the interface for DeviceInstanceName to the</span>
04150 <span class="comment">    given InterfaceClassGuid.  If the interface instance specified by</span>
04151 <span class="comment">    the Reference String portion of SymbolicLinkName is the only</span>
04152 <span class="comment">    instance of the interface, the interface subkey is removed from</span>
04153 <span class="comment">    the device class key as well.</span>
04154 <span class="comment"></span>
04155 <span class="comment">Parameters:</span>
04156 <span class="comment"></span>
04157 <span class="comment">    SymbolicLinkName - Supplies a pointer to a unicode string which</span>
04158 <span class="comment">        contains the symbolic link name of the device to unregister.</span>
04159 <span class="comment"></span>
04160 <span class="comment">Return Value:</span>
04161 <span class="comment"></span>
04162 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04163 <span class="comment"></span>
04164 <span class="comment">--*/</span>
04165 
04166 {
04167     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_SUCCESS, context;
04168     HANDLE          hInterfaceClassKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04169                     hInterfaceInstanceKey=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hControl=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04170     UNICODE_STRING  tempString, mungedPathString, guidString, refString;
04171     BOOLEAN         refStringPresent;
04172     GUID            guid;
04173     UNICODE_STRING  interfaceKeyName, instanceKeyName;
04174     ULONG           linked, remainingSubKeys;
04175     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>          length;
04176     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
04177     PKEY_FULL_INFORMATION keyInformation;
04178 
04179 
04180     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04181 
04182     <span class="comment">//</span>
04183     <span class="comment">// Check that the supplied symbolic link is present, and can be parsed</span>
04184     <span class="comment">//</span>
04185     <span class="keywordflow">if</span> ( (!ARGUMENT_PRESENT(SymbolicLinkName)) ||
04186          (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName,
04187                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04188                                               &amp;mungedPathString,
04189                                               &amp;guidString,
04190                                               &amp;refString,
04191                                               &amp;refStringPresent,
04192                                               &amp;guid))) ) {
04193         status = STATUS_INVALID_PARAMETER;
04194         <span class="keywordflow">goto</span> clean0;
04195     }
04196 
04197     <span class="comment">//</span>
04198     <span class="comment">// Allocate a unicode string for the interface instance key name.</span>
04199     <span class="comment">// (includes the REFSTRING_PREFIX_CHAR, and ReferenceString, if present)</span>
04200     <span class="comment">//</span>
04201     length = <span class="keyword">sizeof</span>(WCHAR) + refString.Length;
04202     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;instanceKeyName,
04203                                       length);
04204     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04205         <span class="keywordflow">goto</span> clean0;
04206     }
04207 
04208     <span class="comment">//</span>
04209     <span class="comment">// Set the MaximumLength of the Buffer, and append the</span>
04210     <span class="comment">// REFSTRING_PREFIX_CHAR to it.</span>
04211     <span class="comment">//</span>
04212     *instanceKeyName.Buffer = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a25">REFSTRING_PREFIX_CHAR</a>;
04213     instanceKeyName.Length = <span class="keyword">sizeof</span>(WCHAR);
04214     instanceKeyName.MaximumLength = length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04215 
04216     <span class="comment">//</span>
04217     <span class="comment">// Append the ReferenceString to the prefix char, if necessary.</span>
04218     <span class="comment">//</span>
04219     <span class="keywordflow">if</span> (refStringPresent) {
04220         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;instanceKeyName, &amp;refString);
04221     }
04222 
04223     instanceKeyName.Buffer[instanceKeyName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04224 
04225     <span class="comment">//</span>
04226     <span class="comment">// Allocate a unicode string for the interface key name.</span>
04227     <span class="comment">// (includes KEY_STRING_PREFIX, mungedPathString, separating '#'</span>
04228     <span class="comment">//  char, and the guidString)</span>
04229     <span class="comment">//</span>
04230     length = <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">KEY_STRING_PREFIX</a>) + mungedPathString.Length +
04231              <span class="keyword">sizeof</span>(WCHAR) + guidString.Length;
04232 
04233     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;interfaceKeyName,
04234                                       length);
04235     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04236         <span class="keywordflow">goto</span> clean1;
04237     }
04238 
04239     interfaceKeyName.MaximumLength = length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04240 
04241     <span class="comment">//</span>
04242     <span class="comment">// Copy the symbolic link name (without refString) to the interfaceKeyNam</span>
04243     <span class="comment">//</span>
04244     RtlCopyMemory(interfaceKeyName.Buffer, SymbolicLinkName-&gt;Buffer, length);
04245     interfaceKeyName.Length = length;
04246     interfaceKeyName.Buffer[interfaceKeyName.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04247 
04248     <span class="comment">//</span>
04249     <span class="comment">// Replace the "\??\" or "\\?\" symbolic link name prefix with "##?#"</span>
04250     <span class="comment">//</span>
04251     RtlCopyMemory(interfaceKeyName.Buffer,
04252                   <a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">KEY_STRING_PREFIX</a>,
04253                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">KEY_STRING_PREFIX</a>));
04254 
04255     <span class="comment">//</span>
04256     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
04257     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
04258     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
04259     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
04260     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
04261     <span class="comment">// portion solves this problem</span>
04262     <span class="comment">//</span>
04263 
04264     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
04265     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04266 
04267     <span class="comment">//</span>
04268     <span class="comment">// Get class, interface, and instance handles</span>
04269     <span class="comment">//</span>
04270     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
04271                                                     KEY_ALL_ACCESS,
04272                                                     &amp;hInterfaceClassKey,
04273                                                     &amp;hInterfaceKey,
04274                                                     &amp;hInterfaceInstanceKey
04275                                                     );
04276     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04277         <span class="keywordflow">goto</span> clean2;
04278     }
04279 
04280     <span class="comment">//</span>
04281     <span class="comment">// Determine whether this interface is currently "enabled"</span>
04282     <span class="comment">//</span>
04283     linked = 0;
04284     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
04285     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
04286                                    hInterfaceInstanceKey,
04287                                    &amp;tempString,
04288                                    KEY_ALL_ACCESS
04289                                    );
04290     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04291         <span class="comment">//</span>
04292         <span class="comment">// Check the "linked" value under the "Control" subkey of this</span>
04293         <span class="comment">// interface instance</span>
04294         <span class="comment">//</span>
04295         keyValueInformation=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04296         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hControl,
04297                                      REGSTR_VAL_LINKED,
04298                                      &amp;keyValueInformation);
04299 
04300         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04301             <span class="keywordflow">if</span> (keyValueInformation-&gt;Type == REG_DWORD &amp;&amp;
04302                 keyValueInformation-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
04303 
04304                 linked = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(keyValueInformation));
04305                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
04306             }
04307         }
04308 
04309         ZwClose(hControl);
04310         hControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04311     }
04312 
04313     <span class="comment">//</span>
04314     <span class="comment">// Ignore any status code returned while attempting to retieve the</span>
04315     <span class="comment">// state of the device.  The value of linked will tell us if we</span>
04316     <span class="comment">// need to disable the interface instance first.</span>
04317     <span class="comment">//</span>
04318     <span class="comment">// If no instance "Control" subkey or "linked" value was present</span>
04319     <span class="comment">//     (status == STATUS_OBJECT_NAME_NOT_FOUND), this interface instance</span>
04320     <span class="comment">//     is not currently enabled -- ok to delete.</span>
04321     <span class="comment">//</span>
04322     <span class="comment">// If the attempt to retrieve these values failed with some other error,</span>
04323     <span class="comment">//     any attempt to disable the interface will also likely fail,</span>
04324     <span class="comment">//     so we'll just have to delete this instance anyways.</span>
04325     <span class="comment">//</span>
04326     status = STATUS_SUCCESS;
04327 
04328     <span class="keywordflow">if</span> (linked) {
04329         <span class="comment">//</span>
04330         <span class="comment">// Disabled the active interface before unregistering it, ignore any</span>
04331         <span class="comment">// status returned, we'll delete this interface instance key anyways.</span>
04332         <span class="comment">//</span>
04333         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a87">IoSetDeviceInterfaceState</a>(SymbolicLinkName, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04334     }
04335 
04336     <span class="comment">//</span>
04337     <span class="comment">// Recursively delete the interface instance key, if it exists.</span>
04338     <span class="comment">//</span>
04339     ZwClose(hInterfaceInstanceKey);
04340     hInterfaceInstanceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04341     <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a> (hInterfaceKey, instanceKeyName.Buffer);
04342 
04343     <span class="comment">//</span>
04344     <span class="comment">// Find out how many subkeys to the interface key remain.</span>
04345     <span class="comment">//</span>
04346     status = <a class="code" href="../../d0/d6/iop_8h.html#a179">IopGetRegistryKeyInformation</a>(hInterfaceKey,
04347                                           &amp;keyInformation);
04348     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04349         <span class="keywordflow">goto</span> clean3;
04350     }
04351 
04352     remainingSubKeys = keyInformation-&gt;SubKeys;
04353 
04354     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyInformation);
04355 
04356     <span class="comment">//</span>
04357     <span class="comment">// See if a volatile "Control" subkey exists under this interface key</span>
04358     <span class="comment">//</span>
04359     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
04360     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hControl,
04361                                    hInterfaceKey,
04362                                    &amp;tempString,
04363                                    KEY_READ
04364                                    );
04365     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04366         ZwClose(hControl);
04367         hControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04368     }
04369     <span class="keywordflow">if</span> ((remainingSubKeys==0) ||
04370         ((remainingSubKeys==1) &amp;&amp; (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)))) {
04371         <span class="comment">//</span>
04372         <span class="comment">// If the interface key has no subkeys, or the only the remaining subkey</span>
04373         <span class="comment">// is the volatile interface "Control" subkey, then there are no more</span>
04374         <span class="comment">// instances to this interface.  We should delete the interface key</span>
04375         <span class="comment">// itself also.</span>
04376         <span class="comment">//</span>
04377         ZwClose(hInterfaceKey);
04378         hInterfaceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04379 
04380         <a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a> (hInterfaceClassKey, interfaceKeyName.Buffer);
04381     }
04382 
04383     status = STATUS_SUCCESS;
04384 
04385 
04386 clean3:
04387     <span class="keywordflow">if</span> (hControl) {
04388         ZwClose(hControl);
04389     }
04390     <span class="keywordflow">if</span> (hInterfaceInstanceKey) {
04391         ZwClose(hInterfaceInstanceKey);
04392     }
04393     <span class="keywordflow">if</span> (hInterfaceKey) {
04394         ZwClose(hInterfaceKey);
04395     }
04396     <span class="keywordflow">if</span> (hInterfaceClassKey) {
04397         ZwClose(hInterfaceClassKey);
04398     }
04399 
04400 clean2:
04401     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
04402     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
04403 
04404     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;interfaceKeyName);
04405 
04406 clean1:
04407     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;instanceKeyName);
04408 
04409 clean0:
04410     <span class="keywordflow">return</span> status;
04411 }
04412 
04413 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04414"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a354">04414</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a354">IopRemoveDeviceInterfaces</a>(
04415     IN PUNICODE_STRING DeviceInstancePath
04416     )
04417 
04418 <span class="comment">/*++</span>
04419 <span class="comment"></span>
04420 <span class="comment">Routine Description:</span>
04421 <span class="comment"></span>
04422 <span class="comment">    This routine checks all device class keys under</span>
04423 <span class="comment">    HKLM\SYSTEM\CCS\Control\DeviceClasses for interfaces for which the</span>
04424 <span class="comment">    DeviceInstance value matches the supplied DeviceInstancePath.  Instances of</span>
04425 <span class="comment">    such device interfaces are unregistered, and the device interface subkey</span>
04426 <span class="comment">    itself is removed.</span>
04427 <span class="comment"></span>
04428 <span class="comment">    Note that a lock on the registry must have already been acquired,</span>
04429 <span class="comment">    by the caller of this routine.</span>
04430 <span class="comment"></span>
04431 <span class="comment">Parameters:</span>
04432 <span class="comment"></span>
04433 <span class="comment">    DeviceInterfacePath - Supplies a pointer to a unicode string which</span>
04434 <span class="comment">        contains the DeviceInterface name of the device for which</span>
04435 <span class="comment">        interfaces to are to be removed.</span>
04436 <span class="comment"></span>
04437 <span class="comment">Return Value:</span>
04438 <span class="comment"></span>
04439 <span class="comment">    Status code that indicates whether or not the function was</span>
04440 <span class="comment">    successful.</span>
04441 <span class="comment"></span>
04442 <span class="comment">--*/</span>
04443 
04444 {
04445     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status, context;
04446     HANDLE         hDeviceClasses=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hClassGUID=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterface=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04447     UNICODE_STRING tempString, guidString, interfaceString, deviceInstanceString;
04448     ULONG          resultSize, classIndex, interfaceIndex;
04449     ULONG          symbolicLinkListSize;
04450     PWCHAR         symbolicLinkList, symLink;
04451     <a class="code" href="../../d4/d5/struct__BUFFER__INFO.html">BUFFER_INFO</a>    classInfoBuffer, interfaceInfoBuffer;
04452     PKEY_VALUE_FULL_INFORMATION deviceInstanceInfo;
04453     BOOLEAN        deletedInterface;
04454     GUID           classGUID;
04455 
04456     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04457 
04458     <span class="comment">//</span>
04459     <span class="comment">// Allocate initial buffers</span>
04460     <span class="comment">//</span>
04461     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;classInfoBuffer,
04462                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a6">INITIAL_INFO_BUFFER_SIZE</a>);
04463     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04464         <span class="keywordflow">goto</span> clean0;
04465     }
04466 
04467     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a370">IopAllocateBuffer</a>(&amp;interfaceInfoBuffer,
04468                                <a class="code" href="../../d8/d0/pnpioapi_8c.html#a6">INITIAL_INFO_BUFFER_SIZE</a>);
04469     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04470         <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;classInfoBuffer);
04471         <span class="keywordflow">goto</span> clean0;
04472     }
04473 
04474     <span class="comment">//</span>
04475     <span class="comment">// Open HKLM\System\CurrentControlSet\Control\DeviceClasses</span>
04476     <span class="comment">//</span>
04477     PiWstrToUnicodeString(&amp;tempString, REGSTR_FULL_PATH_DEVICE_CLASSES);
04478     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hDeviceClasses,
04479                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04480                                    &amp;tempString,
04481                                    KEY_READ
04482                                    );
04483     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
04484         <span class="keywordflow">goto</span> clean1;
04485     }
04486 
04487     <span class="comment">//</span>
04488     <span class="comment">// Enumerate all device classes</span>
04489     <span class="comment">//</span>
04490     classIndex = 0;
04491 
04492     <span class="keywordflow">while</span>((status = ZwEnumerateKey(hDeviceClasses,
04493                                    classIndex,
04494                                    KeyBasicInformation,
04495                                    (PVOID) classInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
04496                                    classInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
04497                                    &amp;resultSize)) != STATUS_NO_MORE_ENTRIES) {
04498 
04499         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
04500             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;classInfoBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04501             <span class="keywordflow">continue</span>;
04502         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04503             <span class="keywordflow">goto</span> clean1;
04504         }
04505 
04506         <span class="comment">//</span>
04507         <span class="comment">// Get the key name for this device class</span>
04508         <span class="comment">//</span>
04509         guidString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PKEY_BASIC_INFORMATION)(classInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength;
04510         guidString.MaximumLength = guidString.Length;
04511         guidString.Buffer = ((PKEY_BASIC_INFORMATION)(classInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Name;
04512 
04513         <span class="comment">//</span>
04514         <span class="comment">// Open the key for this device class</span>
04515         <span class="comment">//</span>
04516         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hClassGUID,
04517                                        hDeviceClasses,
04518                                        &amp;guidString,
04519                                        KEY_ALL_ACCESS
04520                                        );
04521         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04522             <span class="comment">//</span>
04523             <span class="comment">// Couldn't open key for this device class -- skip it and move on.</span>
04524             <span class="comment">//</span>
04525             <span class="keywordflow">goto</span> CloseClassKeyAndContinue;
04526         }
04527 
04528         <span class="comment">//</span>
04529         <span class="comment">// Enumerate all device interfaces for this device class</span>
04530         <span class="comment">//</span>
04531         interfaceIndex = 0;
04532 
04533         <span class="keywordflow">while</span>((status = ZwEnumerateKey(hClassGUID,
04534                                        interfaceIndex,
04535                                        KeyBasicInformation,
04536                                        (PVOID) interfaceInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>,
04537                                        interfaceInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o2">MaxSize</a>,
04538                                        &amp;resultSize)) != STATUS_NO_MORE_ENTRIES) {
04539 
04540             <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
04541                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a371">IopResizeBuffer</a>(&amp;interfaceInfoBuffer, resultSize, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04542                 <span class="keywordflow">continue</span>;
04543             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04544                 <span class="keywordflow">goto</span> clean1;
04545             }
04546 
04547             <span class="comment">//</span>
04548             <span class="comment">// This interface key has not yet been deleted</span>
04549             <span class="comment">//</span>
04550             deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04551 
04552             <span class="comment">//</span>
04553             <span class="comment">// Create a NULL-terminated unicode string for the interface key name</span>
04554             <span class="comment">//</span>
04555             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;interfaceString,
04556                                               (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength);
04557 
04558             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04559                 <span class="keywordflow">goto</span> clean1;
04560             }
04561 
04562             interfaceString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;NameLength;
04563             interfaceString.MaximumLength = interfaceString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
04564             RtlCopyMemory(interfaceString.Buffer,
04565                           ((PKEY_BASIC_INFORMATION)(interfaceInfoBuffer.<a class="code" href="../../d4/d5/struct__BUFFER__INFO.html#o0">Buffer</a>))-&gt;Name,
04566                           interfaceString.Length);
04567             interfaceString.Buffer[interfaceString.Length/<span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
04568 
04569             <span class="comment">//</span>
04570             <span class="comment">// Open the device interface key</span>
04571             <span class="comment">//</span>
04572             status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInterface,
04573                                            hClassGUID,
04574                                            &amp;interfaceString,
04575                                            KEY_ALL_ACCESS
04576                                            );
04577             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04578                 <span class="comment">//</span>
04579                 <span class="comment">// Couldn't open the device interface key -- skip it and move on.</span>
04580                 <span class="comment">//</span>
04581                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04582                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04583             }
04584 
04585             <span class="comment">//</span>
04586             <span class="comment">// Get the DeviceInstance value for this interface key</span>
04587             <span class="comment">//</span>
04588             status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterface,
04589                                          REGSTR_VAL_DEVICE_INSTANCE,
04590                                          &amp;deviceInstanceInfo);
04591 
04592             <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04593                 <span class="comment">//</span>
04594                 <span class="comment">//  Couldn't get the DeviceInstance for this interface --</span>
04595                 <span class="comment">//  skip it and move on.</span>
04596                 <span class="comment">//</span>
04597                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04598             }
04599 
04600             <span class="keywordflow">if</span>((deviceInstanceInfo-&gt;Type == REG_SZ) &amp;&amp;
04601                (deviceInstanceInfo-&gt;DataLength != 0)) {
04602 
04603                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;deviceInstanceString,
04604                                                (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(deviceInstanceInfo),
04605                                                deviceInstanceInfo-&gt;DataLength);
04606 
04607             } <span class="keywordflow">else</span> {
04608                 <span class="comment">//</span>
04609                 <span class="comment">// DeviceInstance value is invalid -- skip it and move on.</span>
04610                 <span class="comment">//</span>
04611                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceInfo);
04612                 <span class="keywordflow">goto</span> CloseInterfaceKeyAndContinue;
04613 
04614             }
04615 
04616             <span class="comment">//</span>
04617             <span class="comment">// Compare the DeviceInstance of this interface to DeviceInstancePath</span>
04618             <span class="comment">//</span>
04619             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(&amp;deviceInstanceString, DeviceInstancePath, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
04620 
04621                 ZwClose(hInterface);
04622                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04623 
04624                 <span class="comment">//</span>
04625                 <span class="comment">// Retrieve all instances of this device interface</span>
04626                 <span class="comment">// (active and non-active)</span>
04627                 <span class="comment">//</span>
04628                 <a class="code" href="../../d1/d7/guid_8c.html#a4">RtlGUIDFromString</a>(&amp;guidString, &amp;classGUID);
04629 
04630                 status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a355">IopGetDeviceInterfaces</a>(&amp;classGUID,
04631                                                 DeviceInstancePath,
04632                                                 <a class="code" href="../../d6/d9/pnp_8h.html#a5">DEVICE_INTERFACE_INCLUDE_NONACTIVE</a>,
04633                                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,       <span class="comment">// kernel-mode format</span>
04634                                                 &amp;symbolicLinkList,
04635                                                 &amp;symbolicLinkListSize);
04636 
04637                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04638 
04639                     <span class="comment">//</span>
04640                     <span class="comment">// Iterate through all instances of the interface</span>
04641                     <span class="comment">//</span>
04642                     symLink = symbolicLinkList;
04643                     <span class="keywordflow">while</span>(*symLink != UNICODE_NULL) {
04644 
04645                         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, symLink);
04646 
04647                         <span class="comment">//</span>
04648                         <span class="comment">// Unregister this instance of the interface.  Since we are</span>
04649                         <span class="comment">// removing the device, ignore any returned status, since</span>
04650                         <span class="comment">// there isn't anything we can do about interfaces which</span>
04651                         <span class="comment">// fail unregistration.</span>
04652                         <span class="comment">//</span>
04653                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a353">IopUnregisterDeviceInterface</a>(&amp;tempString);
04654 
04655                         symLink += ((tempString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)) / <span class="keyword">sizeof</span>(WCHAR));
04656                     }
04657                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(symbolicLinkList);
04658                 }
04659 
04660                 <span class="comment">//</span>
04661                 <span class="comment">// Recursively delete the interface key, if it still exists.</span>
04662                 <span class="comment">// While IopUnregisterDeviceInterface will itself delete the</span>
04663                 <span class="comment">// interface key if no interface instance subkeys remain, if any</span>
04664                 <span class="comment">// of the above calls to IopUnregisterDeviceInterface failed to</span>
04665                 <span class="comment">// delete an interface instance key, subkeys will remain, and</span>
04666                 <span class="comment">// the interface key will not have been deleted.  We'll catch</span>
04667                 <span class="comment">// that here.</span>
04668                 <span class="comment">//</span>
04669                 status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hInterface,
04670                                                hClassGUID,
04671                                                &amp;interfaceString,
04672                                                KEY_READ
04673                                                );
04674                 <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)){
04675                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d1/pnpsubs_8c.html#a41">IopDeleteKeyRecursive</a>(hClassGUID,
04676                                                          interfaceString.Buffer))) {
04677                         deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04678                     }
04679                     ZwDeleteKey(hInterface);
04680                     ZwClose(hInterface);
04681                     hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04682                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
04683                     <span class="comment">//</span>
04684                     <span class="comment">// Interface was already deleted by IopUnregisterDeviceInterface</span>
04685                     <span class="comment">//</span>
04686                     deletedInterface = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04687                 }
04688             }
04689 
04690             <span class="comment">//</span>
04691             <span class="comment">// Free allocated key info structure</span>
04692             <span class="comment">//</span>
04693             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceInstanceInfo);
04694 
04695 CloseInterfaceKeyAndContinue:
04696 
04697             <span class="keywordflow">if</span> (hInterface != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04698                 ZwClose(hInterface);
04699                 hInterface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04700             }
04701 
04702             <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;interfaceString);
04703 
04704             <span class="comment">//</span>
04705             <span class="comment">// Only increment the enumeration index for non-deleted keys</span>
04706             <span class="comment">//</span>
04707             <span class="keywordflow">if</span> (!deletedInterface) {
04708                 interfaceIndex++;
04709             }
04710 
04711         }
04712 
04713 CloseClassKeyAndContinue:
04714 
04715         <span class="keywordflow">if</span> (hClassGUID != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04716             ZwClose(hClassGUID);
04717             hClassGUID = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04718         }
04719         classIndex++;
04720     }
04721 
04722 clean1:
04723     <span class="keywordflow">if</span> (hInterface) {
04724         ZwClose(hInterface);
04725     }
04726     <span class="keywordflow">if</span> (hClassGUID) {
04727         ZwClose(hClassGUID);
04728     }
04729     <span class="keywordflow">if</span> (hDeviceClasses) {
04730         ZwClose(hDeviceClasses);
04731     }
04732 
04733     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;interfaceInfoBuffer);
04734     <a class="code" href="../../d9/d0/pnpiop_8h.html#a372">IopFreeBuffer</a>(&amp;classInfoBuffer);
04735 
04736 clean0:
04737     <span class="keywordflow">return</span> status;
04738 }
04739 
04740 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04741"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">04741</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a72">IopOpenOrCreateDeviceInterfaceSubKeys</a>(
04742     OUT PHANDLE InterfaceKeyHandle           OPTIONAL,
04743     OUT PULONG InterfaceKeyDisposition       OPTIONAL,
04744     OUT PHANDLE InterfaceInstanceKeyHandle   OPTIONAL,
04745     OUT PULONG InterfaceInstanceDisposition  OPTIONAL,
04746     IN HANDLE InterfaceClassKeyHandle,
04747     IN PUNICODE_STRING DeviceInterfaceName,
04748     IN ACCESS_MASK DesiredAccess,
04749     IN BOOLEAN Create
04750     )
04751 
04752 <span class="comment">/*++</span>
04753 <span class="comment"></span>
04754 <span class="comment">Routine Description:</span>
04755 <span class="comment"></span>
04756 <span class="comment">    This API opens or creates a two-level registry hierarchy underneath the</span>
04757 <span class="comment">    specified interface class key for a particular device interface.  The first</span>
04758 <span class="comment">    level is the (munged) symbolic link name (sans RefString).  The second level</span>
04759 <span class="comment">    is the refstring, prepended with a '#' sign (if the device interface has no</span>
04760 <span class="comment">    refstring, then this key name is simply '#').</span>
04761 <span class="comment"></span>
04762 <span class="comment">Parameters:</span>
04763 <span class="comment"></span>
04764 <span class="comment">    InterfaceKeyHandle - Optionally, supplies the address of a variable that</span>
04765 <span class="comment">        receives a handle to the interface key (1st level in the hierarchy).</span>
04766 <span class="comment"></span>
04767 <span class="comment">    InterfaceKeyDisposition - Optionally, supplies the address of a variable that</span>
04768 <span class="comment">        receives either REG_CREATED_NEW_KEY or REG_OPENED_EXISTING_KEY indicating</span>
04769 <span class="comment">        whether the interface key was newly-created.</span>
04770 <span class="comment"></span>
04771 <span class="comment">    InterfaceInstanceKeyHandle - Optionally, supplies the address of a variable</span>
04772 <span class="comment">        that receives a handle to the interface instance key (2nd level in the</span>
04773 <span class="comment">        hierarchy).</span>
04774 <span class="comment"></span>
04775 <span class="comment">    InterfaceInstanceDisposition - Optionally, supplies the address of a variable</span>
04776 <span class="comment">        that receives either REG_CREATED_NEW_KEY or REG_OPENED_EXISTING_KEY</span>
04777 <span class="comment">        indicating whether the interface instance key was newly-created.</span>
04778 <span class="comment"></span>
04779 <span class="comment">    InterfaceClassKeyHandle - Supplies a handle to the interface class key under</span>
04780 <span class="comment">        which the device interface keys are to be opened/created.</span>
04781 <span class="comment"></span>
04782 <span class="comment">    DeviceInterfaceName - Supplies the (user-mode or kernel-mode form) device</span>
04783 <span class="comment">        interface name.</span>
04784 <span class="comment"></span>
04785 <span class="comment">    DesiredAccess - Specifies the desired access that the caller needs to the keys.</span>
04786 <span class="comment"></span>
04787 <span class="comment">    Create - Determines if the keys are to be created if they do not exist.</span>
04788 <span class="comment"></span>
04789 <span class="comment">Return Value:</span>
04790 <span class="comment"></span>
04791 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04792 <span class="comment"></span>
04793 <span class="comment">--*/</span>
04794 
04795 {
04796     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04797     UNICODE_STRING TempString, RefString;
04798     WCHAR PoundCharBuffer;
04799     HANDLE hTempInterface, hTempInterfaceInstance;
04800     ULONG TempInterfaceDisposition;
04801     BOOLEAN RefStringPresent=<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04802 
04803     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04804 
04805     <span class="comment">//</span>
04806     <span class="comment">// Make a copy of the device interface name, since we're going to munge it.</span>
04807     <span class="comment">//</span>
04808     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;TempString, DeviceInterfaceName-&gt;Length);
04809 
04810     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04811         <span class="keywordflow">goto</span> clean0;
04812     }
04813 
04814     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(&amp;TempString, DeviceInterfaceName);
04815 
04816     <span class="comment">//</span>
04817     <span class="comment">// Find the refstring component (if there is one).</span>
04818     <span class="comment">//</span>
04819     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(&amp;TempString,
04820                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04821                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04822                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04823                                       &amp;RefString,
04824                                       &amp;RefStringPresent,
04825                                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04826                                      );
04827     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
04828 
04829     <span class="keywordflow">if</span>(RefStringPresent) {
04830         <span class="comment">//</span>
04831         <span class="comment">// Truncate the device interface name before the refstring separator char.</span>
04832         <span class="comment">//</span>
04833         RefString.Buffer--;
04834         RefString.Length += <span class="keyword">sizeof</span>(WCHAR);
04835         RefString.MaximumLength += <span class="keyword">sizeof</span>(WCHAR);
04836         TempString.MaximumLength = TempString.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PUCHAR)RefString.Buffer - (PUCHAR)TempString.Buffer);
04837     } <span class="keywordflow">else</span> {
04838         <span class="comment">//</span>
04839         <span class="comment">// Set up refstring to point to a temporary character buffer that will hold</span>
04840         <span class="comment">// the single '#' used for the key name when no refstring is present.</span>
04841         <span class="comment">//</span>
04842         RefString.Buffer = &amp;PoundCharBuffer;
04843         RefString.Length = RefString.MaximumLength = <span class="keyword">sizeof</span>(PoundCharBuffer);
04844     }
04845 
04846     <span class="comment">//</span>
04847     <span class="comment">// Replace the "\??\" or "\\?\" symbolic link name prefix with ##?#</span>
04848     <span class="comment">//</span>
04849     RtlCopyMemory(TempString.Buffer, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">KEY_STRING_PREFIX</a>, <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a13">KEY_STRING_PREFIX</a>));
04850 
04851     <span class="comment">//</span>
04852     <span class="comment">// Munge the string</span>
04853     <span class="comment">//</span>
04854     <a class="code" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a>(&amp;TempString, &amp;TempString);
04855 
04856     <span class="comment">//</span>
04857     <span class="comment">// Now open/create this subkey under the interface class key.</span>
04858     <span class="comment">//</span>
04859 
04860     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
04861         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTempInterface,
04862                                          InterfaceClassKeyHandle,
04863                                          &amp;TempString,
04864                                          DesiredAccess,
04865                                          REG_OPTION_NON_VOLATILE,
04866                                          &amp;TempInterfaceDisposition
04867                                          );
04868     } <span class="keywordflow">else</span> {
04869         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hTempInterface,
04870                                        InterfaceClassKeyHandle,
04871                                        &amp;TempString,
04872                                        DesiredAccess
04873                                        );
04874     }
04875 
04876     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04877         <span class="keywordflow">goto</span> clean1;
04878     }
04879 
04880     <span class="comment">//</span>
04881     <span class="comment">// Store a '#' as the first character of the RefString, and then we're ready to open the</span>
04882     <span class="comment">// refstring subkey.</span>
04883     <span class="comment">//</span>
04884     *RefString.Buffer = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a25">REFSTRING_PREFIX_CHAR</a>;
04885 
04886     <span class="comment">//</span>
04887     <span class="comment">// Now open/create the subkey under the interface key representing this interface instance</span>
04888     <span class="comment">// (i.e., differentiated by refstring).</span>
04889     <span class="comment">//</span>
04890 
04891     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a>) {
04892         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hTempInterfaceInstance,
04893                                        hTempInterface,
04894                                        &amp;RefString,
04895                                        DesiredAccess,
04896                                        REG_OPTION_NON_VOLATILE,
04897                                        InterfaceInstanceDisposition
04898                                        );
04899     } <span class="keywordflow">else</span> {
04900         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;hTempInterfaceInstance,
04901                                        hTempInterface,
04902                                        &amp;RefString,
04903                                        DesiredAccess
04904                                        );
04905     }
04906 
04907     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04908         <span class="comment">//</span>
04909         <span class="comment">// Store any requested return values in the caller-supplied buffers.</span>
04910         <span class="comment">//</span>
04911         <span class="keywordflow">if</span>(InterfaceKeyHandle) {
04912             *InterfaceKeyHandle = hTempInterface;
04913         } <span class="keywordflow">else</span> {
04914             ZwClose(hTempInterface);
04915         }
04916         <span class="keywordflow">if</span>(InterfaceKeyDisposition) {
04917             *InterfaceKeyDisposition = TempInterfaceDisposition;
04918         }
04919         <span class="keywordflow">if</span>(InterfaceInstanceKeyHandle) {
04920             *InterfaceInstanceKeyHandle = hTempInterfaceInstance;
04921         } <span class="keywordflow">else</span> {
04922             ZwClose(hTempInterfaceInstance);
04923         }
04924         <span class="comment">//</span>
04925         <span class="comment">// (no need to set InterfaceInstanceDisposition--we already set it above)</span>
04926         <span class="comment">//</span>
04927     } <span class="keywordflow">else</span> {
04928         <span class="comment">//</span>
04929         <span class="comment">// If the interface key was newly-created above, then delete it.</span>
04930         <span class="comment">//</span>
04931         <span class="keywordflow">if</span>(TempInterfaceDisposition == REG_CREATED_NEW_KEY) {
04932             ZwDeleteKey(hTempInterface);
04933         } <span class="keywordflow">else</span> {
04934             ZwClose(hTempInterface);
04935         }
04936     }
04937 
04938 clean1:
04939     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;TempString);
04940 
04941 clean0:
04942     <span class="keywordflow">return</span> status;
04943 }
04944 
04945 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04946"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a93">04946</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a93">IoGetDeviceInterfaceAlias</a>(
04947     IN PUNICODE_STRING SymbolicLinkName,
04948     IN CONST GUID *AliasInterfaceClassGuid,
04949     OUT PUNICODE_STRING AliasSymbolicLinkName
04950     )
04951 
04952 <span class="comment">/*++</span>
04953 <span class="comment"></span>
04954 <span class="comment">Routine Description:</span>
04955 <span class="comment"></span>
04956 <span class="comment">    This API returns a symbolic link name (i.e., device interface) of a</span>
04957 <span class="comment">    particular interface class that 'aliases' the specified device interface.</span>
04958 <span class="comment">    Two device interfaces are considered aliases of each other if the</span>
04959 <span class="comment">    following two criteria are met:</span>
04960 <span class="comment"></span>
04961 <span class="comment">        1.  Both interfaces are exposed by the same PDO (devnode).</span>
04962 <span class="comment">        2.  Both interfaces share the same RefString.</span>
04963 <span class="comment"></span>
04964 <span class="comment">Parameters:</span>
04965 <span class="comment"></span>
04966 <span class="comment">    SymbolicLinkName - Supplies the name of the device interface whose alias is</span>
04967 <span class="comment">        to be retrieved.</span>
04968 <span class="comment"></span>
04969 <span class="comment">    AliasInterfaceClassGuid - Supplies a pointer to the GUID representing the interface</span>
04970 <span class="comment">        class for which an alias is to be retrieved.</span>
04971 <span class="comment"></span>
04972 <span class="comment">    AliasSymbolicLinkName - Supplies a pointer to a string which, upon success,</span>
04973 <span class="comment">        will contain the name of the device interface in the specified class that</span>
04974 <span class="comment">        aliases the SymbolicLinkName interface.  (This symbolic link name will be</span>
04975 <span class="comment">        returned in either kernel-mode or user-mode form, depeding upon the form</span>
04976 <span class="comment">        of the SymbolicLinkName path).</span>
04977 <span class="comment"></span>
04978 <span class="comment">        It is the caller's responsibility to free the buffer allocated for this</span>
04979 <span class="comment">        string via ExFreePool().</span>
04980 <span class="comment"></span>
04981 <span class="comment">Return Value:</span>
04982 <span class="comment"></span>
04983 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
04984 <span class="comment"></span>
04985 <span class="comment">--*/</span>
04986 
04987 {
04988     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04989     HANDLE hKey;
04990     PKEY_VALUE_FULL_INFORMATION pDeviceInstanceInfo;
04991     UNICODE_STRING deviceInstanceString, refString, guidString, otherString;
04992     PUNICODE_STRING pUserString, pKernelString;
04993     BOOLEAN refStringPresent, userModeFormat;
04994 
04995     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
04996 
04997     <span class="comment">//</span>
04998     <span class="comment">// Convert the class guid into string form</span>
04999     <span class="comment">//</span>
05000 
05001     status = <a class="code" href="../../d1/d7/guid_8c.html#a2">RtlStringFromGUID</a>(AliasInterfaceClassGuid, &amp;guidString);
05002     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ){
05003         <span class="keywordflow">goto</span> clean0;
05004     }
05005 
05006     <span class="comment">//</span>
05007     <span class="comment">// Enter critical section and acquire a lock on the registry.  Both these</span>
05008     <span class="comment">// mechanisms are required to prevent deadlock in the case where an APC</span>
05009     <span class="comment">// routine calls this routine after the registry resource has been claimed</span>
05010     <span class="comment">// in this case it would wait blocking this thread so the registry would</span>
05011     <span class="comment">// never be released -&gt; deadlock.  Critical sectioning the registry manipulation</span>
05012     <span class="comment">// portion solves this problem</span>
05013     <span class="comment">//</span>
05014 
05015     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05016     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05017 
05018     <span class="comment">//</span>
05019     <span class="comment">// Open the (parent) device interface key--not the refstring-specific one.</span>
05020     <span class="comment">//</span>
05021 
05022     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
05023                                                     KEY_READ,
05024                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05025                                                     &amp;hKey,
05026                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05027                                                     );
05028     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05029         <span class="keywordflow">goto</span> clean1;
05030     }
05031 
05032     <span class="comment">//</span>
05033     <span class="comment">// Get the name of the device instance that 'owns' this interface.</span>
05034     <span class="comment">//</span>
05035 
05036     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hKey, REGSTR_VAL_DEVICE_INSTANCE, &amp;pDeviceInstanceInfo);
05037 
05038     ZwClose(hKey);
05039 
05040     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05041         <span class="keywordflow">goto</span> clean1;
05042     }
05043 
05044     <span class="keywordflow">if</span>(pDeviceInstanceInfo-&gt;Type == REG_SZ) {
05045 
05046         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;deviceInstanceString,
05047                                        (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pDeviceInstanceInfo),
05048                                        pDeviceInstanceInfo-&gt;DataLength
05049                                       );
05050 
05051     } <span class="keywordflow">else</span> {
05052 
05053         status = STATUS_INVALID_PARAMETER_1;
05054         <span class="keywordflow">goto</span> clean2;
05055 
05056     }
05057 
05058     <span class="comment">//</span>
05059     <span class="comment">// Now parse out the refstring, so that we can construct the name of the interface device's</span>
05060     <span class="comment">// alias.  (NOTE: we have not yet verified that the alias actually exists, we're only</span>
05061     <span class="comment">// constructing what its name would be, if it did exist.)</span>
05062     <span class="comment">//</span>
05063     <span class="comment">// Don't bother to check the return code.  If this were a bad string, we'd have already</span>
05064     <span class="comment">// failed above when we called IopDeviceInterfaceKeysFromSymbolicLink.</span>
05065     <span class="comment">//</span>
05066     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName,
05067                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05068                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05069                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05070                              &amp;refString,
05071                              &amp;refStringPresent,
05072                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05073                             );
05074 
05075     <span class="comment">//</span>
05076     <span class="comment">// Did the caller supply us with a user-mode or kernel-mode format path?</span>
05077     <span class="comment">//</span>
05078     userModeFormat = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>) ==
05079                           RtlCompareMemory(SymbolicLinkName-&gt;Buffer,
05080                                            <a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>,
05081                                            <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>)
05082                                           ));
05083 
05084     <span class="keywordflow">if</span>(userModeFormat) {
05085         pUserString = AliasSymbolicLinkName;
05086         pKernelString = &amp;otherString;
05087     } <span class="keywordflow">else</span> {
05088         pKernelString = AliasSymbolicLinkName;
05089         pUserString = &amp;otherString;
05090     }
05091 
05092     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a63">IopBuildSymbolicLinkStrings</a>(&amp;deviceInstanceString,
05093                                          &amp;guidString,
05094                                          refStringPresent ? &amp;refString : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05095                                          pUserString,
05096                                          pKernelString
05097                                          );
05098     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05099         <span class="keywordflow">goto</span> clean2;
05100     }
05101 
05102     <span class="comment">//</span>
05103     <span class="comment">// OK, we now have the symbolic link name of the alias, but we don't yet know whether</span>
05104     <span class="comment">// it actually exists.  Check this by attempting to open the associated registry key.</span>
05105     <span class="comment">//</span>
05106     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(AliasSymbolicLinkName,
05107                                                     KEY_READ,
05108                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05109                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
05110                                                     &amp;hKey
05111                                                     );
05112 
05113     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05114         <span class="comment">//</span>
05115         <span class="comment">// Alias exists--close the key handle.</span>
05116         <span class="comment">//</span>
05117         ZwClose(hKey);
05118     } <span class="keywordflow">else</span> {
05119         <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(AliasSymbolicLinkName);
05120     }
05121 
05122     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;otherString);
05123 
05124 clean2:
05125     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pDeviceInstanceInfo);
05126 
05127 clean1:
05128     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
05129     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05130     <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;guidString);
05131 
05132 clean0:
05133     <span class="keywordflow">return</span> status;
05134 }
05135 
05136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05137"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a63">05137</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a63">IopBuildSymbolicLinkStrings</a>(
05138     IN PUNICODE_STRING DeviceString,
05139     IN PUNICODE_STRING GuidString,
05140     IN PUNICODE_STRING ReferenceString      OPTIONAL,
05141     OUT PUNICODE_STRING UserString,
05142     OUT PUNICODE_STRING KernelString
05143 )
05144 <span class="comment">/*++</span>
05145 <span class="comment"></span>
05146 <span class="comment">Routine Description:</span>
05147 <span class="comment"></span>
05148 <span class="comment">    This routine will construct various strings used in the registration of</span>
05149 <span class="comment">    function device class associations (IoRegisterDeviceClassAssociation).</span>
05150 <span class="comment">    The specific strings are detailed below</span>
05151 <span class="comment"></span>
05152 <span class="comment">Parameters:</span>
05153 <span class="comment"></span>
05154 <span class="comment">    DeviceString - Supplies a pointer to the instance path of the device.</span>
05155 <span class="comment">        It is of the form &lt;Enumerator&gt;&lt;Device&gt;&lt;Instance&gt;.</span>
05156 <span class="comment"></span>
05157 <span class="comment">    GuidString - Supplies a pointer to the string representation of the</span>
05158 <span class="comment">        function class guid.</span>
05159 <span class="comment"></span>
05160 <span class="comment">    ReferenceString - Supplies a pointer to the reference string for the given</span>
05161 <span class="comment">        device to exhibit the given function.  This is optional</span>
05162 <span class="comment"></span>
05163 <span class="comment">    UserString - Supplies a pointer to an uninitialised string which on success</span>
05164 <span class="comment">        will contain the string to be assigned to the "SymbolicLink" value under the</span>
05165 <span class="comment">        KeyString.  It is of the format \\?&lt;MungedDeviceString&gt;&lt;GuidString&gt;&lt;Reference&gt;</span>
05166 <span class="comment">        When no longer required it should be freed using IopFreeAllocatedUnicodeString.</span>
05167 <span class="comment"></span>
05168 <span class="comment">    KernelString - Supplies a pointer to an uninitialised string which on success</span>
05169 <span class="comment">        will contain the kernel mode path of the device and is of the format</span>
05170 <span class="comment">        \??&lt;MungedDeviceString&gt;&lt;GuidString&gt;&lt;Reference&gt;. When no longer required it</span>
05171 <span class="comment">        should be freed using IopFreeAllocatedUnicodeString.</span>
05172 <span class="comment"></span>
05173 <span class="comment">Return Value:</span>
05174 <span class="comment"></span>
05175 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05176 <span class="comment"></span>
05177 <span class="comment">--*/</span>
05178 
05179 {
05180     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05181     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> length, count;
05182     UNICODE_STRING mungedDeviceString;
05183 
05184     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05185 
05186     <span class="comment">//</span>
05187     <span class="comment">// The code is optimised to use the fact that \\.\ and \??\ are the same size - if</span>
05188     <span class="comment">// these prefixes change then we need to change the code.</span>
05189     <span class="comment">//</span>
05190 
05191     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>) == <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>));
05192 
05193     <span class="comment">//</span>
05194     <span class="comment">// Calculate the lengths of the strings</span>
05195     <span class="comment">//</span>
05196 
05197     length = <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>) + DeviceString-&gt;Length +
05198              <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a19">REPLACED_SEPERATOR_STRING</a>) + GuidString-&gt;Length;
05199 
05200     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(ReferenceString)) {
05201         length += <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a16">SEPERATOR_STRING</a>) + ReferenceString-&gt;Length;
05202     }
05203 
05204     <span class="comment">//</span>
05205     <span class="comment">// Allocate space for the strings</span>
05206     <span class="comment">//</span>
05207 
05208     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(KernelString, length);
05209     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05210         <span class="keywordflow">goto</span> clean0;
05211     }
05212 
05213     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(UserString, length);
05214     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05215         <span class="keywordflow">goto</span> clean1;
05216     }
05217 
05218     <span class="comment">//</span>
05219     <span class="comment">// Allocate a temporary string to hold the munged device string</span>
05220     <span class="comment">//</span>
05221 
05222     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;mungedDeviceString, DeviceString-&gt;Length);
05223     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05224         <span class="keywordflow">goto</span> clean2;
05225     }
05226 
05227     <span class="comment">//</span>
05228     <span class="comment">// Copy and munge the device string</span>
05229     <span class="comment">//</span>
05230 
05231     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a>(&amp;mungedDeviceString, DeviceString);
05232     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05233         <span class="keywordflow">goto</span> clean3;
05234     }
05235 
05236     <span class="comment">//</span>
05237     <span class="comment">// Construct the user mode string</span>
05238     <span class="comment">//</span>
05239 
05240     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(UserString, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>);
05241     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(UserString, &amp;mungedDeviceString);
05242     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(UserString, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a19">REPLACED_SEPERATOR_STRING</a>);
05243     <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(UserString, GuidString);
05244 
05245     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReferenceString)) {
05246         <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(UserString, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a16">SEPERATOR_STRING</a>);
05247         <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(UserString, ReferenceString);
05248     }
05249 
05250     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( UserString-&gt;Length == length );
05251 
05252     <span class="comment">//</span>
05253     <span class="comment">// Construct the kernel mode string by replacing the prefix on the value string</span>
05254     <span class="comment">//</span>
05255 
05256     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(KernelString, UserString);
05257     RtlCopyMemory(KernelString-&gt;Buffer,
05258                   <a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>,
05259                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>)
05260                  );
05261 
05262 clean3:
05263     <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;mungedDeviceString);
05264 
05265 clean2:
05266     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05267         <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(UserString);
05268     }
05269 
05270 clean1:
05271     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05272         <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(KernelString);
05273     }
05274 
05275 clean0:
05276     <span class="keywordflow">return</span> status;
05277 }
05278 
05279 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05280"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a64">05280</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a358">IopReplaceSeperatorWithPound</a>(
05281     OUT PUNICODE_STRING OutString,
05282     IN PUNICODE_STRING InString
05283     )
05284 
05285 <span class="comment">/*++</span>
05286 <span class="comment"></span>
05287 <span class="comment">Routine Description:</span>
05288 <span class="comment"></span>
05289 <span class="comment">    This routine will copy a string from InString to OutString replacing any occurence of</span>
05290 <span class="comment">    '\' or '/' with '#' as it goes.</span>
05291 <span class="comment"></span>
05292 <span class="comment">Parameters:</span>
05293 <span class="comment"></span>
05294 <span class="comment">    OutString - Supplies a pointer to a string which has already been initialised to</span>
05295 <span class="comment">        have a buffer large enough to accomodate the string.  The contents of this</span>
05296 <span class="comment">        string will be over written</span>
05297 <span class="comment"></span>
05298 <span class="comment">    InString - Supplies a pointer to the string to be munged</span>
05299 <span class="comment"></span>
05300 <span class="comment">Return Value:</span>
05301 <span class="comment"></span>
05302 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05303 <span class="comment"></span>
05304 <span class="comment">Remarks:</span>
05305 <span class="comment"></span>
05306 <span class="comment">    In place munging can be performed - ie. the In and Out strings can be the same.</span>
05307 <span class="comment"></span>
05308 <span class="comment">--*/</span>
05309 
05310 {
05311     PWSTR pInPosition, pOutPosition;
05312     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> count;
05313 
05314     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05315 
05316     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InString);
05317     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OutString);
05318 
05319     <span class="comment">//</span>
05320     <span class="comment">// Ensure we have enough space in the output string</span>
05321     <span class="comment">//</span>
05322 
05323     <span class="keywordflow">if</span>(InString-&gt;Length &gt; OutString-&gt;MaximumLength) {
05324         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
05325     }
05326 
05327     pInPosition = InString-&gt;Buffer;
05328     pOutPosition = OutString-&gt;Buffer;
05329     count = InString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
05330 
05331     <span class="comment">//</span>
05332     <span class="comment">// Traverse the in string copying and replacing all occurences of '\' or '/'</span>
05333     <span class="comment">// with '#'</span>
05334     <span class="comment">//</span>
05335 
05336     <span class="keywordflow">while</span> (count--) {
05337         <span class="keywordflow">if</span>((*pInPosition == <a class="code" href="../../d8/d0/pnpioapi_8c.html#a17">SEPERATOR_CHAR</a>) || (*pInPosition == <a class="code" href="../../d8/d0/pnpioapi_8c.html#a18">ALT_SEPERATOR_CHAR</a>)) {
05338             *pOutPosition = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a20">REPLACED_SEPERATOR_CHAR</a>;
05339         } <span class="keywordflow">else</span> {
05340             *pOutPosition = *pInPosition;
05341         }
05342         pInPosition++;
05343         pOutPosition++;
05344     }
05345 
05346     OutString-&gt;Length = InString-&gt;Length;
05347 
05348     <span class="keywordflow">return</span> STATUS_SUCCESS;
05349 
05350 }
05351 
05352 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05353"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a65">05353</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a65">IopDropReferenceString</a>(
05354     OUT PUNICODE_STRING OutString,
05355     IN PUNICODE_STRING InString
05356     )
05357 
05358 <span class="comment">/*++</span>
05359 <span class="comment"></span>
05360 <span class="comment">Routine Description:</span>
05361 <span class="comment"></span>
05362 <span class="comment">    This routine removes the reference string from a symbolic link name.  No space</span>
05363 <span class="comment">    is allocated for the out string so no attempt should be made to free the buffer</span>
05364 <span class="comment">    of OutString.</span>
05365 <span class="comment"></span>
05366 <span class="comment">Parameters:</span>
05367 <span class="comment"></span>
05368 <span class="comment">    SymbolicLinkName - Supplies a pointer to a symbolic link name string.</span>
05369 <span class="comment">        Both the prefixed strings are valid.</span>
05370 <span class="comment"></span>
05371 <span class="comment">    GuidReferenceString - Supplies a pointer to an uninitialised string which on</span>
05372 <span class="comment">        success will contain the symbolic link name without the reference string.</span>
05373 <span class="comment">        See the note on storage allocation above.</span>
05374 <span class="comment"></span>
05375 <span class="comment">Return Value:</span>
05376 <span class="comment"></span>
05377 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05378 <span class="comment"></span>
05379 <span class="comment">Remarks:</span>
05380 <span class="comment"></span>
05381 <span class="comment">    The string returned in OutString is dependant on the buffer of</span>
05382 <span class="comment">    InString and is only valid as long as InString is valid.</span>
05383 <span class="comment"></span>
05384 <span class="comment">--*/</span>
05385 
05386 {
05387     UNICODE_STRING refString;
05388     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05389     BOOLEAN refStringPresent;
05390 
05391     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05392 
05393     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(InString);
05394     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(OutString);
05395 
05396     OutString-&gt;Buffer = InString-&gt;Buffer;
05397 
05398     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(InString, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;refString, &amp;refStringPresent, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
05399 
05400     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05401         <span class="comment">//</span>
05402         <span class="comment">// If we have a refstring then subtract it's length</span>
05403         <span class="comment">//</span>
05404         <span class="keywordflow">if</span> (refStringPresent) {
05405             OutString-&gt;Length = InString-&gt;Length - (refString.Length + <span class="keyword">sizeof</span>(WCHAR));
05406         } <span class="keywordflow">else</span> {
05407             OutString-&gt;Length = InString-&gt;Length;
05408         }
05409 
05410     } <span class="keywordflow">else</span> {
05411         <span class="comment">//</span>
05412         <span class="comment">// Invalidate the returned string</span>
05413         <span class="comment">//</span>
05414         OutString-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05415         OutString-&gt;Length = 0;
05416     }
05417 
05418     OutString-&gt;MaximumLength = OutString-&gt;Length;
05419 
05420     <span class="keywordflow">return</span> status;
05421 }
05422 
05423 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05424"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">05424</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(
05425     IN  PUNICODE_STRING SymbolicLinkName,
05426     OUT PUNICODE_STRING PrefixString        OPTIONAL,
05427     OUT PUNICODE_STRING MungedPathString    OPTIONAL,
05428     OUT PUNICODE_STRING GuidString          OPTIONAL,
05429     OUT PUNICODE_STRING RefString           OPTIONAL,
05430     OUT PBOOLEAN        RefStringPresent    OPTIONAL,
05431     OUT LPGUID Guid                         OPTIONAL
05432     )
05433 
05434 <span class="comment">/*++</span>
05435 <span class="comment"></span>
05436 <span class="comment">Routine Description:</span>
05437 <span class="comment"></span>
05438 <span class="comment">    This routine breaks apart a symbolic link name constructed by</span>
05439 <span class="comment">    IopBuildSymbolicLinkNames.  Both formats of name are valid - user</span>
05440 <span class="comment">    mode \\?\ and kernel mode \??\.</span>
05441 <span class="comment"></span>
05442 <span class="comment">Parameters:</span>
05443 <span class="comment"></span>
05444 <span class="comment">    SymbolicLinkName - Supplies a pointer to the symbolic link name to</span>
05445 <span class="comment">        be analysed.</span>
05446 <span class="comment"></span>
05447 <span class="comment">    PrefixString - Optionally contains a pointer to a string which will contain</span>
05448 <span class="comment">        the prefix of the string.</span>
05449 <span class="comment"></span>
05450 <span class="comment">    MungedPathString - Optionally contains a pointer to a string which will contain</span>
05451 <span class="comment">        the enumeration path of the device with all occurences of '\' replaced with '#'.</span>
05452 <span class="comment"></span>
05453 <span class="comment">    GuidString - Optionally contains a pointer to a string which will contain</span>
05454 <span class="comment">        the device class guid in string format from the string.</span>
05455 <span class="comment"></span>
05456 <span class="comment">    RefString - Optionally contains a pointer to a string which will contain</span>
05457 <span class="comment">        the refstring of the string if one is present, otherwise it is undefined.</span>
05458 <span class="comment"></span>
05459 <span class="comment">    RefStringPresent - Optionally contains a pointer to a boolean value which will</span>
05460 <span class="comment">        be set to true if a refstring is present.</span>
05461 <span class="comment"></span>
05462 <span class="comment">    Guid - Optionally contains a pointer to a guid which will contain</span>
05463 <span class="comment">        the function class guid of the string.</span>
05464 <span class="comment"></span>
05465 <span class="comment">Return Value:</span>
05466 <span class="comment"></span>
05467 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05468 <span class="comment"></span>
05469 <span class="comment">--*/</span>
05470 
05471 {
05472     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
05473     PWSTR pCurrent;
05474     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> last, current, <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, guid, reference = 0;
05475     UNICODE_STRING tempString;
05476     GUID tempGuid;
05477     BOOLEAN haveRefString;
05478 
05479     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05480 
05481     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>) == <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>));
05482 
05483     <span class="comment">//</span>
05484     <span class="comment">// Sanity check on the incoming string - if it does not have a \\?\ or \??\ prefix then fail</span>
05485     <span class="comment">//</span>
05486 
05487     <span class="keywordflow">if</span> (!(RtlCompareMemory(SymbolicLinkName-&gt;Buffer,
05488                            <a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>,
05489                            <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>)
05490                           ) != <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>)
05491        || RtlCompareMemory(SymbolicLinkName-&gt;Buffer,
05492                            <a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>,
05493                            <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>)
05494                           ) != <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>)
05495        )) {
05496 
05497         status = STATUS_INVALID_PARAMETER;
05498         <span class="keywordflow">goto</span> clean0;
05499     }
05500 
05501 
05502     <span class="comment">//</span>
05503     <span class="comment">// check that the input buffer really is big enough</span>
05504     <span class="comment">//</span>
05505     <span class="keywordflow">if</span> (SymbolicLinkName-&gt;Length &lt;(<a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>)+<a class="code" href="../../d8/d0/pnpioapi_8c.html#a28">GUID_STRING_SIZE</a>+1)) {
05506         status = STATUS_INVALID_PARAMETER;
05507         <span class="keywordflow">goto</span> clean0;
05508 
05509     }
05510 
05511     <span class="comment">//</span>
05512     <span class="comment">// Break apart the string into it's constituent parts</span>
05513     <span class="comment">//</span>
05514 
05515     <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a21">USER_SYMLINK_STRING_PREFIX</a>) + 1;
05516 
05517     <span class="comment">//</span>
05518     <span class="comment">// Find the '\' seperator</span>
05519     <span class="comment">//</span>
05520 
05521     pCurrent = SymbolicLinkName-&gt;Buffer + <a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>);
05522 
05523     <span class="keywordflow">for</span> (current = 0;
05524          current &lt; (SymbolicLinkName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) - <a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>);
05525          current++, pCurrent++) {
05526 
05527         <span class="keywordflow">if</span>(*pCurrent == <a class="code" href="../../d8/d0/pnpioapi_8c.html#a17">SEPERATOR_CHAR</a>) {
05528             reference = current + 1 + <a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>);
05529             <span class="keywordflow">break</span>;
05530         }
05531 
05532     }
05533 
05534     <span class="comment">//</span>
05535     <span class="comment">// If we don't have a reference string fake it to where it would have been</span>
05536     <span class="comment">//</span>
05537 
05538     <span class="keywordflow">if</span> (reference == 0) {
05539         haveRefString = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05540         reference = SymbolicLinkName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) + 1;
05541 
05542     } <span class="keywordflow">else</span> {
05543         haveRefString = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05544     }
05545 
05546     <span class="comment">//</span>
05547     <span class="comment">// Check the guid looks plausable</span>
05548     <span class="comment">//</span>
05549 
05550     tempString.Length = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a28">GUID_STRING_SIZE</a>;
05551     tempString.MaximumLength = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a28">GUID_STRING_SIZE</a>;
05552     tempString.Buffer = SymbolicLinkName-&gt;Buffer + reference - <a class="code" href="../../d8/d0/pnpioapi_8c.html#a27">GUID_STRING_LENGTH</a> - 1;
05553 
05554     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d7/guid_8c.html#a4">RtlGUIDFromString</a>(&amp;tempString, &amp;tempGuid) )) {
05555         status = STATUS_INVALID_PARAMETER;
05556         <span class="keywordflow">goto</span> clean0;
05557     }
05558 
05559     guid = reference - <a class="code" href="../../d8/d0/pnpioapi_8c.html#a27">GUID_STRING_LENGTH</a> - 1;
05560 
05561     <span class="comment">//</span>
05562     <span class="comment">// Setup return strings</span>
05563     <span class="comment">//</span>
05564 
05565     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PrefixString)) {
05566         PrefixString-&gt;Length = <a class="code" href="../../d9/d0/pnpiop_8h.html#a102">IopConstStringSize</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>);
05567         PrefixString-&gt;MaximumLength = PrefixString-&gt;Length;
05568         PrefixString-&gt;Buffer = SymbolicLinkName-&gt;Buffer;
05569     }
05570 
05571     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(MungedPathString)) {
05572         MungedPathString-&gt;Length = (reference - 1 - <a class="code" href="../../d8/d0/pnpioapi_8c.html#a27">GUID_STRING_LENGTH</a> - 1 -
05573                                    <a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>)) *
05574                                    <span class="keyword">sizeof</span>(WCHAR);
05575         MungedPathString-&gt;MaximumLength = MungedPathString-&gt;Length;
05576         MungedPathString-&gt;Buffer = SymbolicLinkName-&gt;Buffer +
05577                                    <a class="code" href="../../d9/d0/pnpiop_8h.html#a103">IopConstStringLength</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a23">KERNEL_SYMLINK_STRING_PREFIX</a>);
05578 
05579     }
05580 
05581     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(GuidString)) {
05582         GuidString-&gt;Length = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a28">GUID_STRING_SIZE</a>;
05583         GuidString-&gt;MaximumLength = GuidString-&gt;Length;
05584         GuidString-&gt;Buffer = SymbolicLinkName-&gt;Buffer + reference -
05585                              <a class="code" href="../../d8/d0/pnpioapi_8c.html#a27">GUID_STRING_LENGTH</a> - 1;
05586     }
05587 
05588     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RefString)) {
05589         <span class="comment">//</span>
05590         <span class="comment">// Check if we have a refstring</span>
05591         <span class="comment">//</span>
05592         <span class="keywordflow">if</span> (haveRefString) {
05593             RefString-&gt;Length = SymbolicLinkName-&gt;Length -
05594                                   (reference * <span class="keyword">sizeof</span>(WCHAR));
05595             RefString-&gt;MaximumLength = RefString-&gt;Length;
05596             RefString-&gt;Buffer = SymbolicLinkName-&gt;Buffer + reference;
05597         } <span class="keywordflow">else</span> {
05598             RefString-&gt;Length = 0;
05599             RefString-&gt;MaximumLength = 0;
05600             RefString-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05601         }
05602     }
05603 
05604     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RefStringPresent)) {
05605         *RefStringPresent = haveRefString;
05606     }
05607 
05608     <span class="keywordflow">if</span>(ARGUMENT_PRESENT(Guid)) {
05609         *Guid = tempGuid;
05610     }
05611 
05612 clean0:
05613 
05614     <span class="keywordflow">return</span> status;
05615 
05616 }
05617 
05618 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05619"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a373">05619</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(
05620     IN OUT PUNICODE_STRING String,
05621     IN USHORT Length
05622     )
05623 
05624 <span class="comment">/*++</span>
05625 <span class="comment"></span>
05626 <span class="comment">Routine Description:</span>
05627 <span class="comment"></span>
05628 <span class="comment">    This routine allocates a buffer for a unicode string of a given length</span>
05629 <span class="comment">    and initialises the UNICODE_STRING structure appropriately. When the</span>
05630 <span class="comment">    string is no longer required it can be freed using IopFreeAllocatedString.</span>
05631 <span class="comment">    The buffer also be directly deleted by ExFreePool and so can be handed</span>
05632 <span class="comment">    back to a caller.</span>
05633 <span class="comment"></span>
05634 <span class="comment">Parameters:</span>
05635 <span class="comment"></span>
05636 <span class="comment">    String - Supplies a pointer to an uninitialised unicode string which will</span>
05637 <span class="comment">        be manipulated by the function.</span>
05638 <span class="comment"></span>
05639 <span class="comment">    Length - The number of BYTES long that the string will be.</span>
05640 <span class="comment"></span>
05641 <span class="comment">Return Value:</span>
05642 <span class="comment"></span>
05643 <span class="comment">    Either STATUS_INSUFFICIENT_RESOURCES indicating paged pool is exhausted or</span>
05644 <span class="comment">    STATUS_SUCCESS.</span>
05645 <span class="comment"></span>
05646 <span class="comment">Remarks:</span>
05647 <span class="comment"></span>
05648 <span class="comment">    The buffer allocated will be one character (2 bytes) more than length specified.</span>
05649 <span class="comment">    This is to allow for easy null termination of the strings - eg for registry</span>
05650 <span class="comment">    storage.</span>
05651 <span class="comment"></span>
05652 <span class="comment">--*/</span>
05653 
05654 {
05655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05656 
05657     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length = 0;
05658     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength = Length + <span class="keyword">sizeof</span>(UNICODE_NULL);
05659 
05660     <span class="keywordflow">if</span>(!(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length + <span class="keyword">sizeof</span>(UNICODE_NULL)))) {
05661         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05662     } <span class="keywordflow">else</span> {
05663         <span class="keywordflow">return</span> STATUS_SUCCESS;
05664     }
05665 }
05666 
05667 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05668"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a374">05668</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(
05669     PUNICODE_STRING String
05670     )
05671 
05672 <span class="comment">/*++</span>
05673 <span class="comment"></span>
05674 <span class="comment">Routine Description:</span>
05675 <span class="comment"></span>
05676 <span class="comment">    This routine frees a string previously allocated with IopAllocateUnicodeString.</span>
05677 <span class="comment"></span>
05678 <span class="comment">Parameters:</span>
05679 <span class="comment"></span>
05680 <span class="comment">    String - Supplies a pointer to the string that has been previously allocated.</span>
05681 <span class="comment"></span>
05682 <span class="comment">Return Value:</span>
05683 <span class="comment"></span>
05684 <span class="comment">    None</span>
05685 <span class="comment"></span>
05686 <span class="comment">--*/</span>
05687 
05688 {
05689     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05690 
05691     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
05692 
05693     <span class="comment">//</span>
05694     <span class="comment">// If we have a buffer free it</span>
05695     <span class="comment">//</span>
05696 
05697     <span class="keywordflow">if</span>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer) {
05698 
05699         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer);
05700 
05701     }
05702 
05703     <span class="comment">//</span>
05704     <span class="comment">// Blank out the string</span>
05705     <span class="comment">//</span>
05706 
05707     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05708     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length = 0;
05709     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;MaximumLength = 0;
05710 
05711 }
05712 
05713 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05714"></a><a class="code" href="../../d0/d5/io_8h.html#a587">05714</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a67">IopSetRegistryStringValue</a>(
05715     IN HANDLE KeyHandle,
05716     IN PUNICODE_STRING ValueName,
05717     IN PUNICODE_STRING ValueData
05718     )
05719 
05720 <span class="comment">/*++</span>
05721 <span class="comment"></span>
05722 <span class="comment">Routine Description:</span>
05723 <span class="comment"></span>
05724 <span class="comment">    Sets a value key in the registry to a specific value of string (REG_SZ) type.</span>
05725 <span class="comment"></span>
05726 <span class="comment">Parameters:</span>
05727 <span class="comment"></span>
05728 <span class="comment">    KeyHandle - A handle to the key under which the value is stored.</span>
05729 <span class="comment"></span>
05730 <span class="comment">    ValueName - Supplies a pointer to the name of the value key</span>
05731 <span class="comment"></span>
05732 <span class="comment">    ValueData - Supplies a pointer to the string to be stored in the key.  The data</span>
05733 <span class="comment">        will automatically be null terminated for storage in the registry.</span>
05734 <span class="comment"></span>
05735 <span class="comment">Return Value:</span>
05736 <span class="comment"></span>
05737 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05738 <span class="comment"></span>
05739 <span class="comment">--*/</span>
05740 
05741 {
05742     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05743 
05744     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05745 
05746     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>);
05747     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ValueData);
05748     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>-&gt;Buffer);
05749     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ValueData-&gt;Buffer);
05750 
05751     <span class="comment">//</span>
05752     <span class="comment">// Null terminate the string</span>
05753     <span class="comment">//</span>
05754 
05755     <span class="keywordflow">if</span> ((ValueData-&gt;MaximumLength - ValueData-&gt;Length) &gt;= <span class="keyword">sizeof</span>(UNICODE_NULL)) {
05756 
05757         <span class="comment">//</span>
05758         <span class="comment">// There is room in the buffer so just append a null</span>
05759         <span class="comment">//</span>
05760 
05761         ValueData-&gt;Buffer[(ValueData-&gt;Length / <span class="keyword">sizeof</span>(WCHAR))] = UNICODE_NULL;
05762 
05763         <span class="comment">//</span>
05764         <span class="comment">// Set the registry value</span>
05765         <span class="comment">//</span>
05766 
05767         status = ZwSetValueKey(KeyHandle,
05768                                <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
05769                                0,
05770                                REG_SZ,
05771                                (PVOID) ValueData-&gt;Buffer,
05772                                ValueData-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
05773                                );
05774 
05775     } <span class="keywordflow">else</span> {
05776 
05777         UNICODE_STRING tempString;
05778 
05779         <span class="comment">//</span>
05780         <span class="comment">// There is no room so allocate a new buffer and so we need to build</span>
05781         <span class="comment">// a new string with room</span>
05782         <span class="comment">//</span>
05783 
05784         status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a373">IopAllocateUnicodeString</a>(&amp;tempString, ValueData-&gt;Length);
05785 
05786         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05787             <span class="keywordflow">goto</span> clean0;
05788         }
05789 
05790         <span class="comment">//</span>
05791         <span class="comment">// Copy the input string to the output string</span>
05792         <span class="comment">//</span>
05793 
05794         tempString.Length = ValueData-&gt;Length;
05795         RtlCopyMemory(tempString.Buffer, ValueData-&gt;Buffer, ValueData-&gt;Length);
05796 
05797         <span class="comment">//</span>
05798         <span class="comment">// Add the null termination</span>
05799         <span class="comment">//</span>
05800 
05801         tempString.Buffer[tempString.Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
05802 
05803         <span class="comment">//</span>
05804         <span class="comment">// Set the registry value</span>
05805         <span class="comment">//</span>
05806 
05807         status = ZwSetValueKey(KeyHandle,
05808                                <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
05809                                0,
05810                                REG_SZ,
05811                                (PVOID) tempString.Buffer,
05812                                tempString.Length + <span class="keyword">sizeof</span>(UNICODE_NULL)
05813                                );
05814 
05815         <span class="comment">//</span>
05816         <span class="comment">// Free the temporary string</span>
05817         <span class="comment">//</span>
05818 
05819         <a class="code" href="../../d9/d0/pnpiop_8h.html#a374">IopFreeAllocatedUnicodeString</a>(&amp;tempString);
05820 
05821     }
05822 
05823 clean0:
05824     <span class="keywordflow">return</span> status;
05825 
05826 }
05827 
05828 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l05829"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a96">05829</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a96">IoUnregisterPlugPlayNotification</a>(
05830     IN PVOID NotificationEntry
05831     )
05832 
05833 <span class="comment">/*++</span>
05834 <span class="comment"></span>
05835 <span class="comment">Routine Description:</span>
05836 <span class="comment"></span>
05837 <span class="comment">    This routine unregisters a notification previously registered via</span>
05838 <span class="comment">    IoRegisterPlugPlayNotification.  A driver cannot be unloaded until it has</span>
05839 <span class="comment">    unregistered all of its notification handles.</span>
05840 <span class="comment"></span>
05841 <span class="comment">Parameters:</span>
05842 <span class="comment"></span>
05843 <span class="comment">    NotificationEntry - This provices the cookie returned by IoRegisterPlugPlayNotification</span>
05844 <span class="comment">        which identifies the registration in question.</span>
05845 <span class="comment"></span>
05846 <span class="comment">Return Value:</span>
05847 <span class="comment"></span>
05848 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
05849 <span class="comment"></span>
05850 <span class="comment">--*/</span>
05851 
05852 {
05853     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a> entry;
05854     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> lock;
05855     BOOLEAN wasDeferred = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05856 
05857     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05858 
05859     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NotificationEntry);
05860 
05861     entry = (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)NotificationEntry;
05862 
05863     lock = entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o7">Lock</a>;
05864 
05865     ExAcquireFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
05866     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a>) {
05867         <span class="comment">//</span>
05868         <span class="comment">// Before unregistering the entry, we need to make sure that it's not sitting</span>
05869         <span class="comment">// around in the deferred registration list.</span>
05870         <span class="comment">//</span>
05871         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
05872 
05873         <span class="keywordflow">if</span> (!IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>)) {
05874 
05875             PLIST_ENTRY link;
05876             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
05877 
05878             link = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>.Flink;
05879             deferredNode = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a>)link;
05880 
05881             <span class="keywordflow">while</span> (link != (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>) {
05882                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a>);
05883                 <span class="keywordflow">if</span> (deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a> == entry) {
05884                     wasDeferred = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05885                     <span class="keywordflow">if</span> (lock) {
05886                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(lock);
05887                     }
05888                     link = link-&gt;Flink;
05889                     RemoveEntryList((PLIST_ENTRY)deferredNode);
05890                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)deferredNode-&gt;NotifyEntry);
05891                     <span class="keywordflow">if</span> (lock) {
05892                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(lock);
05893                     }
05894                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deferredNode);
05895                     deferredNode = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a>)link;
05896                 } <span class="keywordflow">else</span> {
05897                     link = link-&gt;Flink;
05898                     deferredNode = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a>)link;
05899                 }
05900             }
05901         }
05902 
05903         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
05904     } <span class="keywordflow">else</span> {
05905         <span class="comment">//</span>
05906         <span class="comment">// If there is currently no notification in progress, the deferred</span>
05907         <span class="comment">// registration list must be empty.</span>
05908         <span class="comment">//</span>
05909         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>));
05910     }
05911     ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
05912 
05913     <span class="comment">//</span>
05914     <span class="comment">// Acquire lock</span>
05915     <span class="comment">//</span>
05916     <span class="keywordflow">if</span> (lock) {
05917         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(lock);
05918     }
05919 
05920     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(wasDeferred == entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a>);
05921 
05922     <span class="keywordflow">if</span> (!entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a> || wasDeferred) {
05923         <span class="comment">//</span>
05924         <span class="comment">// Dereference the entry if it is currently registered, or had its</span>
05925         <span class="comment">// registration pending completion of the notification in progress.</span>
05926         <span class="comment">//</span>
05927 
05928         <span class="comment">//</span>
05929         <span class="comment">// Mark the entry as unregistered so we don't notify on it</span>
05930         <span class="comment">//</span>
05931 
05932         entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05933 
05934         <span class="comment">//</span>
05935         <span class="comment">// Dereference it thus deleting if no longer required</span>
05936         <span class="comment">//</span>
05937 
05938         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>(entry);
05939     }
05940 
05941     <span class="comment">//</span>
05942     <span class="comment">// Release the lock</span>
05943     <span class="comment">//</span>
05944 
05945     <span class="keywordflow">if</span> (lock) {
05946         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(lock);
05947     }
05948 
05949     <span class="keywordflow">return</span> STATUS_SUCCESS;
05950 
05951 }
05952 
05953 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05954"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a364">05954</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a364">IopProcessDeferredRegistrations</a>(
05955     VOID
05956     )
05957 <span class="comment">/*++</span>
05958 <span class="comment"></span>
05959 <span class="comment">Routine Description:</span>
05960 <span class="comment"></span>
05961 <span class="comment">    This routine removes notification entries from the deferred registration</span>
05962 <span class="comment">    list, marking them as "registered" so that they can receive notifications.</span>
05963 <span class="comment"></span>
05964 <span class="comment">Parameters:</span>
05965 <span class="comment"></span>
05966 <span class="comment">    None.</span>
05967 <span class="comment"></span>
05968 <span class="comment">Return Value:</span>
05969 <span class="comment"></span>
05970 <span class="comment">    None.</span>
05971 <span class="comment"></span>
05972 <span class="comment">  --*/</span>
05973 {
05974     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
05975     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> lock;
05976 
05977     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
05978 
05979     <span class="keywordflow">while</span> (!IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>)) {
05980 
05981         deferredNode = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a>)RemoveHeadList(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>);
05982 
05983         <span class="comment">//</span>
05984         <span class="comment">// Acquire this entry's list lock.</span>
05985         <span class="comment">//</span>
05986         lock = deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o7">Lock</a>;
05987         <span class="keywordflow">if</span> (lock) {
05988             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(lock);
05989         }
05990 
05991         <span class="comment">//</span>
05992         <span class="comment">// Mark this entry as registered.</span>
05993         <span class="comment">//</span>
05994         deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05995 
05996         <span class="comment">//</span>
05997         <span class="comment">// Dereference the notification entry when removing it from the deferred</span>
05998         <span class="comment">// list, and free the node.</span>
05999         <span class="comment">//</span>
06000         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a>);
06001         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deferredNode);
06002 
06003         <span class="comment">//</span>
06004         <span class="comment">// Release this entry's list lock.</span>
06005         <span class="comment">//</span>
06006         <span class="keywordflow">if</span> (lock) {
06007             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(lock);
06008             lock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06009         }
06010     }
06011 
06012     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
06013 }
06014 
06015 
06016 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06017"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a98">06017</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a98">IoReportTargetDeviceChange</a>(
06018     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
06019     IN PVOID NotificationStructure  <span class="comment">// always begins with a PLUGPLAY_NOTIFICATION_HEADER</span>
06020     )
06021 
06022 <span class="comment">/*++</span>
06023 <span class="comment"></span>
06024 <span class="comment">Routine Description:</span>
06025 <span class="comment"></span>
06026 <span class="comment">    This routine may be used to give notification of 3rd-party target device</span>
06027 <span class="comment">    change events.  This API will notify every driver that has registered for</span>
06028 <span class="comment">    notification on a file object associated with PhysicalDeviceObject about</span>
06029 <span class="comment">    the event indicated in the NotificationStructure.</span>
06030 <span class="comment"></span>
06031 <span class="comment">Parameters:</span>
06032 <span class="comment"></span>
06033 <span class="comment">    PhysicalDeviceObject - Provides a pointer to the PDO that the change begin</span>
06034 <span class="comment">        reported is associated with.</span>
06035 <span class="comment"></span>
06036 <span class="comment">    NotificationStructure - Provides a pointer to the notification structure to be</span>
06037 <span class="comment">        sent to all parties registered for notifications about changes to</span>
06038 <span class="comment">        PhysicalDeviceObject.</span>
06039 <span class="comment"></span>
06040 <span class="comment">Return Value:</span>
06041 <span class="comment"></span>
06042 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06043 <span class="comment"></span>
06044 <span class="comment">Note:</span>
06045 <span class="comment"></span>
06046 <span class="comment">    This API may only be used to report non-PnP target device changes.  In particular,</span>
06047 <span class="comment">    it will fail if it's called with the NotificationStructure-&gt;Event field set to</span>
06048 <span class="comment">    GUID_TARGET_DEVICE_QUERY_REMOVE, GUID_TARGET_DEVICE_REMOVE_CANCELLED, or</span>
06049 <span class="comment">    GUID_TARGET_DEVICE_REMOVE_COMPLETE.</span>
06050 <span class="comment"></span>
06051 <span class="comment">--*/</span>
06052 {
06053 
06054     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
06055     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> completionEvent;
06056     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> completionStatus;
06057     <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a> notifyStruct;
06058     LONG                   dataSize;
06059 
06060     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06061 
06062     notifyStruct = (<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>)NotificationStructure;
06063 
06064     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(notifyStruct);
06065 
06066     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(PhysicalDeviceObject);
06067 
06068     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o3">FileObject</a>);
06069 
06070 
06071     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_QUERY_REMOVE) ||
06072         <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_REMOVE_CANCELLED) ||
06073         <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_REMOVE_COMPLETE)) {
06074 
06075         <span class="comment">//</span>
06076         <span class="comment">//  Passed in an illegal value</span>
06077         <span class="comment">//</span>
06078 
06079 <span class="preprocessor">#if DBG</span>
06080 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Illegal Event type passed as custom notification\n"</span>);
06081 <span class="preprocessor">#endif</span>
06082 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06083 
06084     }
06085 
06086     <span class="keywordflow">if</span> (notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a> &lt; FIELD_OFFSET(<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer)) {
06087 
06088         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06089     }
06090 
06091     dataSize = notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a> - FIELD_OFFSET(<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer);
06092 
06093     <span class="keywordflow">if</span> (notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o4">NameBufferOffset</a> != -1 &amp;&amp; notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o4">NameBufferOffset</a> &gt; dataSize)  {
06094 
06095         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06096     }
06097 
06098     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;completionEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06099 
06100     status = <a class="code" href="../../d6/d9/pnp_8h.html#a157">PpSetCustomTargetEvent</a>( PhysicalDeviceObject,
06101                                      &amp;completionEvent,
06102                                      &amp;completionStatus,
06103                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06104                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06105                                      notifyStruct);
06106 
06107     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
06108 
06109         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;completionEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
06110 
06111         status = completionStatus;
06112     }
06113 
06114     <span class="keywordflow">return</span> status;
06115 }
06116 
06117 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06118"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a99">06118</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a99">IoReportTargetDeviceChangeAsynchronous</a>(
06119     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
06120     IN PVOID NotificationStructure,  <span class="comment">// always begins with a PLUGPLAY_NOTIFICATION_HEADER</span>
06121     IN PDEVICE_CHANGE_COMPLETE_CALLBACK Callback        OPTIONAL,
06122     IN PVOID Context    OPTIONAL
06123     )
06124 
06125 <span class="comment">/*++</span>
06126 <span class="comment"></span>
06127 <span class="comment">Routine Description:</span>
06128 <span class="comment"></span>
06129 <span class="comment">    This routine may be used to give notification of 3rd-party target device</span>
06130 <span class="comment">    change events.  This API will notify every driver that has registered for</span>
06131 <span class="comment">    notification on a file object associated with PhysicalDeviceObject about</span>
06132 <span class="comment">    the event indicated in the NotificationStructure.</span>
06133 <span class="comment"></span>
06134 <span class="comment">Parameters:</span>
06135 <span class="comment"></span>
06136 <span class="comment">    PhysicalDeviceObject - Provides a pointer to the PDO that the change begin</span>
06137 <span class="comment">        reported is associated with.</span>
06138 <span class="comment"></span>
06139 <span class="comment">    NotificationStructure - Provides a pointer to the notification structure to be</span>
06140 <span class="comment">        sent to all parties registered for notifications about changes to</span>
06141 <span class="comment">        PhysicalDeviceObject.</span>
06142 <span class="comment"></span>
06143 <span class="comment">Return Value:</span>
06144 <span class="comment"></span>
06145 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06146 <span class="comment"></span>
06147 <span class="comment">Note:</span>
06148 <span class="comment"></span>
06149 <span class="comment">    This API may only be used to report non-PnP target device changes.  In particular,</span>
06150 <span class="comment">    it will fail if it's called with the NotificationStructure-&gt;Event field set to</span>
06151 <span class="comment">    GUID_TARGET_DEVICE_QUERY_REMOVE, GUID_TARGET_DEVICE_REMOVE_CANCELLED, or</span>
06152 <span class="comment">    GUID_TARGET_DEVICE_REMOVE_COMPLETE.</span>
06153 <span class="comment"></span>
06154 <span class="comment">--*/</span>
06155 {
06156     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a34">PASYNC_TDC_WORK_ITEM</a>    asyncWorkItem;
06157     <a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>        workItem;
06158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                status;
06159     LONG                    dataSize;
06160 
06161     <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>   notifyStruct;
06162 
06163     notifyStruct = (<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>)NotificationStructure;
06164 
06165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(notifyStruct);
06166 
06167     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(PhysicalDeviceObject);
06168 
06169     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o3">FileObject</a>);
06170 
06171     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_QUERY_REMOVE) ||
06172         <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_REMOVE_CANCELLED) ||
06173         <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o2">Event</a>, &amp;GUID_TARGET_DEVICE_REMOVE_COMPLETE)) {
06174 
06175         <span class="comment">//</span>
06176         <span class="comment">//  Passed in an illegal value</span>
06177         <span class="comment">//</span>
06178 
06179 <span class="preprocessor">#if DBG</span>
06180 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Illegal Event type passed as custom notification\n"</span>);
06181 <span class="preprocessor">#endif</span>
06182 <span class="preprocessor"></span>        <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06183 
06184     }
06185 
06186     <span class="keywordflow">if</span> (notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a> &lt; FIELD_OFFSET(<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer)) {
06187 
06188         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06189     }
06190 
06191     dataSize = notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a> - FIELD_OFFSET(<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a>, CustomDataBuffer);
06192 
06193     <span class="keywordflow">if</span> (notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o4">NameBufferOffset</a> != -1 &amp;&amp; notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o4">NameBufferOffset</a> &gt; dataSize)  {
06194 
06195         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06196     }
06197 
06198     <span class="comment">//</span>
06199     <span class="comment">// Since this routine can be called at DPC level we need to queue</span>
06200     <span class="comment">// a work item and process it when the irql drops.</span>
06201     <span class="comment">//</span>
06202 
06203     asyncWorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
06204                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html">ASYNC_TDC_WORK_ITEM</a>) + notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a>);
06205 
06206     <span class="keywordflow">if</span> (asyncWorkItem != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06207 
06208         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(PhysicalDeviceObject);
06209 
06210         asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o1">DeviceObject</a> = PhysicalDeviceObject;
06211         asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o4">NotificationStructure</a> =
06212             (<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>)((PUCHAR)asyncWorkItem + <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a33">ASYNC_TDC_WORK_ITEM</a>));
06213 
06214         RtlCopyMemory( asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o4">NotificationStructure</a>,
06215                        notifyStruct,
06216                        notifyStruct-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o1">Size</a>);
06217 
06218         asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o2">Callback</a> = Callback;
06219         asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o3">Context</a> = Context;
06220         workItem = &amp;asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o0">WorkItem</a>;
06221 
06222         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(workItem, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a52">IopReportTargetDeviceChangeAsyncWorker</a>, asyncWorkItem);
06223 
06224         <span class="comment">//</span>
06225         <span class="comment">// Queue a work item to do the enumeration</span>
06226         <span class="comment">//</span>
06227 
06228         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>(workItem, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a>);
06229         status = STATUS_PENDING;
06230     } <span class="keywordflow">else</span> {
06231         <span class="comment">//</span>
06232         <span class="comment">// Failed to allocate memory for work item.  Nothing we can do ...</span>
06233         <span class="comment">//</span>
06234 
06235         status = STATUS_INSUFFICIENT_RESOURCES;
06236     }
06237 
06238     <span class="keywordflow">return</span> status;
06239 }
06240 
06241 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06242"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a52">06242</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a52">IopReportTargetDeviceChangeAsyncWorker</a>(
06243     PVOID Context
06244     )
06245 
06246 <span class="comment">/*++</span>
06247 <span class="comment"></span>
06248 <span class="comment">Routine Description:</span>
06249 <span class="comment"></span>
06250 <span class="comment">    This routine is the worker routine of IoInvalidateDeviceState.</span>
06251 <span class="comment">    Its main purpose is to invoke IopSynchronousQueryDeviceState and release</span>
06252 <span class="comment">    work item space.</span>
06253 <span class="comment"></span>
06254 <span class="comment">Parameters:</span>
06255 <span class="comment"></span>
06256 <span class="comment">    Context - Supplies a pointer to the ASYNC_TDC_WORK_ITEM.</span>
06257 <span class="comment"></span>
06258 <span class="comment">ReturnValue:</span>
06259 <span class="comment"></span>
06260 <span class="comment">    None.</span>
06261 <span class="comment"></span>
06262 <span class="comment">--*/</span>
06263 
06264 {
06265     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a34">PASYNC_TDC_WORK_ITEM</a> asyncWorkItem = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a34">PASYNC_TDC_WORK_ITEM</a>)Context;
06266 
06267     <a class="code" href="../../d6/d9/pnp_8h.html#a157">PpSetCustomTargetEvent</a>( asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o1">DeviceObject</a>,
06268                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06269                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06270                             asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o2">Callback</a>,
06271                             asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o3">Context</a>,
06272                             asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o4">NotificationStructure</a>);
06273 
06274     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(asyncWorkItem-&gt;<a class="code" href="../../d5/d9/struct__ASYNC__TDC__WORK__ITEM.html#o1">DeviceObject</a>);
06275     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(asyncWorkItem);
06276 }
06277 
06278 
06279 
06280 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06281"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a100">06281</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a100">IoInvalidateDeviceState</a>(
06282     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject
06283     )
06284 
06285 <span class="comment">/*++</span>
06286 <span class="comment"></span>
06287 <span class="comment">Routine Description:</span>
06288 <span class="comment"></span>
06289 <span class="comment">    This API will cause the PnP manager to send the specified PDO an IRP_MN_QUERY_PNP_DEVICE_STATE</span>
06290 <span class="comment">    IRP.</span>
06291 <span class="comment"></span>
06292 <span class="comment">Parameters:</span>
06293 <span class="comment"></span>
06294 <span class="comment">    PhysicalDeviceObject - Provides a pointer to the PDO who's state is to be invalidated.</span>
06295 <span class="comment"></span>
06296 <span class="comment">Return Value:</span>
06297 <span class="comment"></span>
06298 <span class="comment">    none.</span>
06299 <span class="comment"></span>
06300 <span class="comment">--*/</span>
06301 {
06302     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06303 
06304     <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(PhysicalDeviceObject);
06305 
06306     <span class="comment">//</span>
06307     <span class="comment">// If the call was made before PnP completes device enumeration</span>
06308     <span class="comment">// we can safely ignore it.  PnP manager will do it without</span>
06309     <span class="comment">// driver's request.  If the device was already removed or surprised</span>
06310     <span class="comment">// removed then ignore it as well since this is only valid for started</span>
06311     <span class="comment">// devices.</span>
06312     <span class="comment">//</span>
06313 
06314     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
06315 
06316     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) != <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
06317         <span class="keywordflow">return</span>;
06318     }
06319 
06320     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a50">IopQueueDeviceWorkItem</a>( PhysicalDeviceObject,
06321                             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a51">IopInvalidateDeviceStateWorker</a>,
06322                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06323 }
06324 
06325 
06326 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06327"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a50">06327</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a50">IopQueueDeviceWorkItem</a>(
06328     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
06329     IN PVOID WorkerRoutine,
06330     IN PVOID Context
06331     )
06332 
06333 <span class="comment">/*++</span>
06334 <span class="comment"></span>
06335 <span class="comment">Routine Description:</span>
06336 <span class="comment"></span>
06337 <span class="comment">    This API will cause the PnP manager to send the specified PDO an</span>
06338 <span class="comment">    IRP_MN_QUERY_PNP_DEVICE_STATE IRP.</span>
06339 <span class="comment"></span>
06340 <span class="comment">Parameters:</span>
06341 <span class="comment"></span>
06342 <span class="comment">    PhysicalDeviceObject - Provides a pointer to the PDO who's state is to be</span>
06343 <span class="comment">    invalidated.</span>
06344 <span class="comment"></span>
06345 <span class="comment">Return Value:</span>
06346 <span class="comment"></span>
06347 <span class="comment">    none.</span>
06348 <span class="comment"></span>
06349 <span class="comment">--*/</span>
06350 
06351 {
06352     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a32">PDEVICE_WORK_ITEM</a> deviceWorkItem;
06353 
06354     <span class="comment">//</span>
06355     <span class="comment">// Since this routine can be called at DPC level we need to queue</span>
06356     <span class="comment">// a work item and process it when the irql drops.</span>
06357     <span class="comment">//</span>
06358 
06359     deviceWorkItem = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html">DEVICE_WORK_ITEM</a>));
06360     <span class="keywordflow">if</span> (deviceWorkItem == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06361 
06362         <span class="comment">//</span>
06363         <span class="comment">// Failed to allocate memory for work item.  Nothing we can do ...</span>
06364         <span class="comment">//</span>
06365 
06366         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06367     }
06368 
06369     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(PhysicalDeviceObject);
06370     deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o1">DeviceObject</a> = PhysicalDeviceObject;
06371     deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o2">Context</a> = Context;
06372 
06373     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o0">WorkItem</a>,
06374                           WorkerRoutine,
06375                           deviceWorkItem);
06376 
06377     <span class="comment">//</span>
06378     <span class="comment">// Queue a work item to do the enumeration</span>
06379     <span class="comment">//</span>
06380 
06381     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o0">WorkItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a206">DelayedWorkQueue</a> );
06382 
06383     <span class="keywordflow">return</span> STATUS_SUCCESS;
06384 }
06385 
06386 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06387"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a51">06387</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a51">IopInvalidateDeviceStateWorker</a>(
06388     PVOID Context
06389     )
06390 
06391 <span class="comment">/*++</span>
06392 <span class="comment"></span>
06393 <span class="comment">Routine Description:</span>
06394 <span class="comment"></span>
06395 <span class="comment">    This routine is the worker routine of IoInvalidateDeviceState.</span>
06396 <span class="comment">    Its main purpose is to invoke IopSynchronousQueryDeviceState and release</span>
06397 <span class="comment">    work item space.</span>
06398 <span class="comment"></span>
06399 <span class="comment">Parameters:</span>
06400 <span class="comment"></span>
06401 <span class="comment">    Context - Supplies a pointer to the DEVICE_WORK_ITEM.</span>
06402 <span class="comment"></span>
06403 <span class="comment">ReturnValue:</span>
06404 <span class="comment"></span>
06405 <span class="comment">    None.</span>
06406 <span class="comment"></span>
06407 <span class="comment">--*/</span>
06408 
06409 {
06410     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a32">PDEVICE_WORK_ITEM</a> deviceWorkItem = (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a32">PDEVICE_WORK_ITEM</a>)Context;
06411     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = deviceWorkItem-&gt;<a class="code" href="../../d1/d5/struct__DEVICE__WORK__ITEM.html#o1">DeviceObject</a>;
06412     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06413 
06414     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceWorkItem);
06415 
06416     <span class="comment">//</span>
06417     <span class="comment">// If the device was removed or surprised removed while the work item was</span>
06418     <span class="comment">// queued then ignore it.</span>
06419     <span class="comment">//</span>
06420 
06421     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06422 
06423     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a32">DNF_REMOVE_PENDING_CLOSES</a>)) == <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
06424 
06425         <a class="code" href="../../d0/d1/pnpirp_8c.html#a32">IopQueryDeviceState</a>(deviceObject);
06426 
06427         <span class="comment">//</span>
06428         <span class="comment">// PCMCIA driver uses this when switching between Cardbus and R2 cards.</span>
06429         <span class="comment">//</span>
06430         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(deviceObject);
06431     }
06432 
06433     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(deviceObject);
06434 }
06435 <span class="comment">//</span>
06436 <span class="comment">// Private routines</span>
06437 <span class="comment">//</span>
06438 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06439"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a278">06439</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a278">IopResourceRequirementsChanged</a>(
06440     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
06441     IN BOOLEAN StopRequired
06442     )
06443 
06444 <span class="comment">/*++</span>
06445 <span class="comment"></span>
06446 <span class="comment">Routine Description:</span>
06447 <span class="comment"></span>
06448 <span class="comment">    This routine handles request of device resource requirements list change.</span>
06449 <span class="comment"></span>
06450 <span class="comment">Parameters:</span>
06451 <span class="comment"></span>
06452 <span class="comment">    PhysicalDeviceObject - Provides a pointer to the PDO who's state is to be invalidated.</span>
06453 <span class="comment"></span>
06454 <span class="comment">    StopRequired - Supplies a BOOLEAN value to indicate if the resources reallocation needs</span>
06455 <span class="comment">                   to be done after device stopped.</span>
06456 <span class="comment"></span>
06457 <span class="comment">Return Value:</span>
06458 <span class="comment"></span>
06459 <span class="comment">    none.</span>
06460 <span class="comment"></span>
06461 <span class="comment">--*/</span>
06462 
06463 {
06464     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06465     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> device = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06466 
06467     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06468 
06469     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
06470 
06471     <span class="comment">//</span>
06472     <span class="comment">// Clear the NO_RESOURCE_REQUIRED flags.</span>
06473     <span class="comment">//</span>
06474 
06475     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
06476 
06477     <span class="comment">//</span>
06478     <span class="comment">// If for some reason this device did not start, we need to clear some flags</span>
06479     <span class="comment">// such that it can be started later.  In this case, we call IopRequestDeviceEnumeration</span>
06480     <span class="comment">// with NULL device object, so the devices will be handled in non-started case.  They will</span>
06481     <span class="comment">// be assigned resources, started and enumerated.</span>
06482     <span class="comment">//</span>
06483 
06484     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>;
06485 
06486     <a class="code" href="../../d9/d0/pnpiop_8h.html#a79">IopClearDevNodeProblem</a>(deviceNode);
06487 
06488     <span class="comment">//</span>
06489     <span class="comment">// If the device is already started, we call IopRequestDeviceEnumeration with</span>
06490     <span class="comment">// the device object.</span>
06491     <span class="comment">//</span>
06492 
06493     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
06494         device = PhysicalDeviceObject;
06495         <span class="keywordflow">if</span> (StopRequired == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
06496             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>;
06497         } <span class="keywordflow">else</span> {
06498 
06499             <span class="comment">//</span>
06500             <span class="comment">// Explicitly clear it.</span>
06501             <span class="comment">//</span>
06502 
06503             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>;
06504         }
06505     }
06506 
06507     <a class="code" href="../../d9/d0/pnpiop_8h.html#a305">IopRequestDeviceAction</a>( device, <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
06508 }
06509 
06510 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06511"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a68">06511</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a346">IopInitializePlugPlayNotification</a>(
06512     VOID
06513     )
06514 
06515 <span class="comment">/*++</span>
06516 <span class="comment"></span>
06517 <span class="comment">Routine Description:</span>
06518 <span class="comment"></span>
06519 <span class="comment">    This routine performs initialization required before any of the notification</span>
06520 <span class="comment">    APIs can be called.</span>
06521 <span class="comment"></span>
06522 <span class="comment">Parameters:</span>
06523 <span class="comment"></span>
06524 <span class="comment">    None</span>
06525 <span class="comment"></span>
06526 <span class="comment">Return Value:</span>
06527 <span class="comment"></span>
06528 <span class="comment">    None</span>
06529 <span class="comment"></span>
06530 <span class="comment">--*/</span>
06531 
06532 {
06533     ULONG count;
06534 
06535     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06536 
06537     <span class="comment">//</span>
06538     <span class="comment">// Initialize the notification structures</span>
06539     <span class="comment">//</span>
06540 
06541     <span class="keywordflow">for</span> (count = 0; count &lt; <a class="code" href="../../d9/d0/pnpiop_8h.html#a111">NOTIFY_DEVICE_CLASS_HASH_BUCKETS</a>; count++) {
06542 
06543         InitializeListHead(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[count]);
06544 
06545     }
06546 
06547     <span class="comment">//</span>
06548     <span class="comment">// Initialize the profile notification list</span>
06549     <span class="comment">//</span>
06550     InitializeListHead(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>);
06551 
06552     <span class="comment">//</span>
06553     <span class="comment">// Initialize the deferred registration list</span>
06554     <span class="comment">//</span>
06555     InitializeListHead(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>);
06556 
06557     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
06558     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
06559     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
06560     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
06561 }
06562 
06563 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06564"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">06564</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>(
06565     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a> Notify
06566     )
06567 
06568 <span class="comment">/*++</span>
06569 <span class="comment"></span>
06570 <span class="comment">Routine Description:</span>
06571 <span class="comment"></span>
06572 <span class="comment">    This routine increments the reference count for a notification entry.</span>
06573 <span class="comment"></span>
06574 <span class="comment">Parameters:</span>
06575 <span class="comment"></span>
06576 <span class="comment">    Notify - Supplies a pointer to the notification entry to be referenced</span>
06577 <span class="comment"></span>
06578 <span class="comment">Return Value:</span>
06579 <span class="comment"></span>
06580 <span class="comment">    None</span>
06581 <span class="comment"></span>
06582 <span class="comment">Note:</span>
06583 <span class="comment"></span>
06584 <span class="comment">    The appropriate symchronization lock must be held on the notification</span>
06585 <span class="comment">    list before this routine can be called</span>
06586 <span class="comment"></span>
06587 <span class="comment">--*/</span>
06588 
06589 {
06590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06591 
06592     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Notify);
06593     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o5">RefCount</a> &gt; 0);
06594 
06595     Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o5">RefCount</a>++;
06596 
06597 }
06598 
06599 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l06600"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">06600</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>(
06601     <a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a> Notify
06602     )
06603 
06604 <span class="comment">/*++</span>
06605 <span class="comment"></span>
06606 <span class="comment">Routine Description:</span>
06607 <span class="comment"></span>
06608 <span class="comment">    This routine decrements the reference count for a notification entry, removing</span>
06609 <span class="comment">    the entry from the list and freeing the associated memory if there are no</span>
06610 <span class="comment">    outstanding reference counts.</span>
06611 <span class="comment"></span>
06612 <span class="comment">Parameters:</span>
06613 <span class="comment"></span>
06614 <span class="comment">    Notify - Supplies a pointer to the notification entry to be referenced</span>
06615 <span class="comment"></span>
06616 <span class="comment">Return Value:</span>
06617 <span class="comment"></span>
06618 <span class="comment">    None</span>
06619 <span class="comment"></span>
06620 <span class="comment">Note:</span>
06621 <span class="comment"></span>
06622 <span class="comment">    The appropriate symchronization lock must be held on the notification</span>
06623 <span class="comment">    list before this routine can be called</span>
06624 <span class="comment"></span>
06625 <span class="comment">--*/</span>
06626 
06627 {
06628     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06629 
06630     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Notify);
06631     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o5">RefCount</a> &gt; 0);
06632 
06633     Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o5">RefCount</a>--;
06634 
06635     <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o5">RefCount</a> == 0) {
06636 
06637         <span class="comment">//</span>
06638         <span class="comment">// If the refcount is zero then the node should have been deregisterd</span>
06639         <span class="comment">// and is no longer needs to be in the list so remove and free it</span>
06640         <span class="comment">//</span>
06641 
06642         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a>);
06643 
06644         <span class="comment">//</span>
06645         <span class="comment">// Dereference the driver object that registered for notifications</span>
06646         <span class="comment">//</span>
06647 
06648         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>);
06649 
06650         <span class="comment">//</span>
06651         <span class="comment">// If this notification entry is for target device change, dereference</span>
06652         <span class="comment">// the PDO upon which this notification entry was hooked.</span>
06653         <span class="comment">//</span>
06654 
06655         <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o1">EventCategory</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a172a114">EventCategoryTargetDeviceChange</a>) {
06656             <a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a> entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)Notify;
06657 
06658             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a>) {
06659                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a>);
06660                 entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06661             }
06662         }
06663 
06664         RemoveEntryList((PLIST_ENTRY)Notify);
06665 
06666         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Notify);
06667 
06668     }
06669 }
06670 
06671 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06672"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a348">06672</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a348">IopRequestHwProfileChangeNotification</a>(
06673     IN   LPGUID                         EventGuid,
06674     IN   PROFILE_NOTIFICATION_TIME      NotificationTime,
06675     OUT  PPNP_VETO_TYPE                 VetoType            OPTIONAL,
06676     OUT  PUNICODE_STRING                VetoName            OPTIONAL
06677     )
06678 
06679 <span class="comment">/*++</span>
06680 <span class="comment"></span>
06681 <span class="comment">Routine Description:</span>
06682 <span class="comment"></span>
06683 <span class="comment">    This routine is used to notify all registered drivers of a hardware profile</span>
06684 <span class="comment">    change.  If the operation is a HW provile change query then the operation</span>
06685 <span class="comment">    is synchronous and the veto information is propagated.  All other operations</span>
06686 <span class="comment">    are asynchronous and veto information is not returned.</span>
06687 <span class="comment"></span>
06688 <span class="comment">Parameters:</span>
06689 <span class="comment"></span>
06690 <span class="comment">    EventTypeGuid       - The event that has occured</span>
06691 <span class="comment"></span>
06692 <span class="comment">    NotificationTime    - This is used to tell if we are already in an event</span>
06693 <span class="comment">                          when delivering a synchronous notification (ie,</span>
06694 <span class="comment">                          querying profile change to eject). It is one of</span>
06695 <span class="comment">                          three values:</span>
06696 <span class="comment">                              PROFILE_IN_PNPEVENT</span>
06697 <span class="comment">                              PROFILE_NOT_IN_PNPEVENT</span>
06698 <span class="comment">                              PROFILE_PERHAPS_IN_PNPEVENT</span>
06699 <span class="comment"></span>
06700 <span class="comment">    VetoType            - Type of vetoer.</span>
06701 <span class="comment"></span>
06702 <span class="comment">    VetoName            - Name of vetoer.</span>
06703 <span class="comment"></span>
06704 <span class="comment">Return Value:</span>
06705 <span class="comment"></span>
06706 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06707 <span class="comment"></span>
06708 <span class="comment">Note:</span>
06709 <span class="comment"></span>
06710 <span class="comment">    The contents of the notification structure *including* all pointers is only</span>
06711 <span class="comment">    valid during the callback routine to which it was passed.  If the data is</span>
06712 <span class="comment">    required after the duration of the callback then it must be physically copied</span>
06713 <span class="comment">    by the callback routine.</span>
06714 <span class="comment"></span>
06715 <span class="comment">--*/</span>
06716 
06717 {
06718     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status=STATUS_SUCCESS,completionStatus;
06719     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> completionEvent;
06720     ULONG dataSize,totalSize;
06721     PPNP_DEVICE_EVENT_ENTRY deviceEvent;
06722 
06723     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06724 
06725     <span class="keywordflow">if</span> (
06726          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06727                        (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE)) &amp;&amp;
06728          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06729                        (LPGUID)&amp;GUID_HWPROFILE_CHANGE_CANCELLED)) &amp;&amp;
06730          (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid,
06731                        (LPGUID)&amp;GUID_HWPROFILE_CHANGE_COMPLETE)) ) {
06732 
06733          <span class="comment">//</span>
06734          <span class="comment">//  Passed in an illegal value</span>
06735          <span class="comment">//</span>
06736 
06737 <span class="preprocessor"> #if DBG</span>
06738 <span class="preprocessor"></span>         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Illegal Event type passed as profile notification\n"</span>);
06739 <span class="preprocessor"> #endif</span>
06740 <span class="preprocessor"></span>         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06741      }
06742 
06743 
06744      <span class="comment">//</span>
06745      <span class="comment">// Only the query changes are synchronous, and in that case we must</span>
06746      <span class="comment">// know definitely whether we are nested within a Pnp event or not.</span>
06747      <span class="comment">//</span>
06748      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE))||
06749             (NotificationTime != <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a210">PROFILE_PERHAPS_IN_PNPEVENT</a>)) ;
06750 
06751      <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE) ) {
06752 
06753          <span class="comment">//</span>
06754          <span class="comment">// Asynchronous case. Very easy.</span>
06755          <span class="comment">//</span>
06756          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!ARGUMENT_PRESENT(VetoName));
06757          <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!ARGUMENT_PRESENT(VetoType));
06758 
06759          <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/pnp_8h.html#a166">PpSetHwProfileChangeEvent</a>( EventGuid,
06760                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06761                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06762                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06763                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
06764                                            );
06765      }
06766 
06767      <span class="comment">//</span>
06768      <span class="comment">// Query notifications are synchronous. Determine if we are currently</span>
06769      <span class="comment">// within an event, in which case we must do the notify here instead</span>
06770      <span class="comment">// of queueing it up.</span>
06771      <span class="comment">//</span>
06772      <span class="keywordflow">if</span> (NotificationTime == <a class="code" href="../../d9/d0/pnpiop_8h.html#a388a209">PROFILE_NOT_IN_PNPEVENT</a>) {
06773 
06774          <span class="comment">//</span>
06775          <span class="comment">// Queue up and block on the notification.</span>
06776          <span class="comment">//</span>
06777          <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;completionEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
06778 
06779          status = <a class="code" href="../../d6/d9/pnp_8h.html#a166">PpSetHwProfileChangeEvent</a>( EventGuid,
06780                                              &amp;completionEvent,
06781                                              &amp;completionStatus,
06782                                              VetoType,
06783                                              VetoName
06784                                              );
06785 
06786          <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
06787 
06788              <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;completionEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
06789 
06790              status = completionStatus;
06791          }
06792 
06793          <span class="keywordflow">return</span> status ;
06794      }
06795 
06796      <span class="comment">//</span>
06797      <span class="comment">// Synchronous notify inside our Pnp event.</span>
06798      <span class="comment">//</span>
06799      <span class="comment">// ADRIAO BUGBUG 11/12/98 -</span>
06800      <span class="comment">//     GROSS, UGLY, SINFUL HACK - We are MANUALLY sending the profile</span>
06801      <span class="comment">// query change notification because we are blocking inside a PnPEvent and</span>
06802      <span class="comment">// thus can't queue/wait on another!</span>
06803      <span class="comment">//</span>
06804      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
06805 
06806      dataSize =  <span class="keyword">sizeof</span>(PLUGPLAY_EVENT_BLOCK);
06807 
06808      totalSize = dataSize + FIELD_OFFSET (PNP_DEVICE_EVENT_ENTRY,Data);
06809 
06810      deviceEvent = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
06811                                           totalSize,
06812                                           <a class="code" href="../../d8/d0/pnpioapi_8c.html#a0">PNP_DEVICE_EVENT_ENTRY_TAG</a>);
06813 
06814      <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == deviceEvent) {
06815          <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
06816      }
06817 
06818      <span class="comment">//</span>
06819      <span class="comment">//Setup the PLUGPLAY_EVENT_BLOCK</span>
06820      <span class="comment">//</span>
06821      RtlZeroMemory ((PVOID)deviceEvent,totalSize);
06822      deviceEvent-&gt;Data.EventCategory = HardwareProfileChangeEvent;
06823      RtlCopyMemory(&amp;deviceEvent-&gt;Data.EventGuid, EventGuid, <span class="keyword">sizeof</span>(GUID));
06824      deviceEvent-&gt;Data.TotalSize = dataSize;
06825      deviceEvent-&gt;CallerEvent = &amp;completionEvent;
06826      deviceEvent-&gt;Data.Result = &amp;completionStatus;
06827      deviceEvent-&gt;VetoType = VetoType;
06828      deviceEvent-&gt;VetoName = VetoName;
06829 
06830      <span class="comment">//</span>
06831      <span class="comment">// Notify K-Mode</span>
06832      <span class="comment">//</span>
06833      status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a>(&amp;deviceEvent-&gt;Data.EventGuid,
06834                                        VetoType,
06835                                        VetoName);
06836 
06837      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06838          <span class="keywordflow">return</span> status;
06839      }
06840 
06841      <span class="comment">//</span>
06842      <span class="comment">// Notify user-mode (synchronously).</span>
06843      <span class="comment">//</span>
06844      status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a58">PiNotifyUserMode</a>(deviceEvent);
06845 
06846      <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06847          <span class="comment">//</span>
06848          <span class="comment">// Notify K-mode that the query has been cancelled.</span>
06849          <span class="comment">//</span>
06850          <a class="code" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a>((LPGUID)&amp;GUID_HWPROFILE_CHANGE_CANCELLED,
06851                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
06852                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
06853      }
06854      <span class="keywordflow">return</span> status;
06855 }
06856 
06857 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l06858"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a359">06858</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a359">IopNotifyHwProfileChange</a>(
06859     IN  LPGUID           EventGuid,
06860     OUT PPNP_VETO_TYPE   VetoType    OPTIONAL,
06861     OUT PUNICODE_STRING  VetoName    OPTIONAL
06862     )
06863 <span class="comment">/*++</span>
06864 <span class="comment"></span>
06865 <span class="comment">Routine Description:</span>
06866 <span class="comment"></span>
06867 <span class="comment">    This routine is used to deliver the HWProfileNotifications. It is</span>
06868 <span class="comment">    called from the worker thread only</span>
06869 <span class="comment">    It does not return until all interested parties have been notified.</span>
06870 <span class="comment"></span>
06871 <span class="comment">Parameters:</span>
06872 <span class="comment"></span>
06873 <span class="comment">    EventTypeGuid - The event that has occured</span>
06874 <span class="comment"></span>
06875 <span class="comment">Return Value:</span>
06876 <span class="comment"></span>
06877 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
06878 <span class="comment"></span>
06879 <span class="comment">Note:</span>
06880 <span class="comment"></span>
06881 <span class="comment">    The contents of the notification structure *including* all pointers is only</span>
06882 <span class="comment">    valid during the callback routine to which it was passed.  If the data is</span>
06883 <span class="comment">    required after the duration of the callback then it must be physically copied</span>
06884 <span class="comment">    by the callback routine.</span>
06885 <span class="comment"></span>
06886 <span class="comment">--*/</span>
06887 {
06888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status=STATUS_SUCCESS;
06889     <a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>  pNotifyList;
06890     PLIST_ENTRY link;
06891 <span class="preprocessor">#if DBG</span>
06892 <span class="preprocessor"></span>    ULONG originalApcDisable;
06893 <span class="preprocessor">#endif</span>
06894 <span class="preprocessor"></span>
06895 
06896     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06897 
06898     <span class="comment">//Lock the Profile Notification List</span>
06899     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a> (&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
06900 
06901     <span class="comment">//</span>
06902     <span class="comment">//  Grab the list head (inside the lock)</span>
06903     <span class="comment">//</span>
06904     link = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>.Flink;
06905     pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
06906 
06907     <span class="comment">//</span>
06908     <span class="comment">//circular list</span>
06909     <span class="comment">//</span>
06910     <span class="keywordflow">while</span> (link != (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>) {
06911         <span class="keywordflow">if</span> (!pNotifyList-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
06912 
06913             <a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html">HWPROFILE_CHANGE_NOTIFICATION</a> notification;
06914 
06915             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
06916             ULONG Console=0;
06917 
06918             <span class="comment">//</span>
06919             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
06920             <span class="comment">// and then release the lock</span>
06921             <span class="comment">//</span>
06922             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06923             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
06924 
06925             <span class="comment">//</span>
06926             <span class="comment">// Fill in the notification</span>
06927             <span class="comment">//</span>
06928 
06929             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
06930             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html">HWPROFILE_CHANGE_NOTIFICATION</a>);
06931             notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o2">Event</a> = *EventGuid;
06932 
06933 <span class="preprocessor">#if DBG</span>
06934 <span class="preprocessor"></span>            originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
06935 <span class="preprocessor">#endif</span>
06936 <span class="preprocessor"></span>            <span class="comment">//</span>
06937             <span class="comment">// Reference the notify and call back</span>
06938             <span class="comment">//</span>
06939             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
06940             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
06941             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
06942 
06943 
06944             <span class="comment">//</span>
06945             <span class="comment">// Dispatch this function via the memory manager.</span>
06946             <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
06947             <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
06948             <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
06949             <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
06950             <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
06951             <span class="comment">// then the callback is called directly.</span>
06952             <span class="comment">//</span>
06953             status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
06954 <span class="preprocessor">#if DBG</span>
06955 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
06956                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyHwProfileChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
06957                          &amp;pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
06958                 DbgBreakPoint();
06959             }
06960 <span class="preprocessor">#endif</span>
06961 <span class="preprocessor"></span>
06962             <span class="comment">//</span>
06963             <span class="comment">// If the caller returned anything other than success and it was a</span>
06964             <span class="comment">// query hardware profile change, we veto the query and send cancels</span>
06965             <span class="comment">// to all callers that already got the query.</span>
06966             <span class="comment">//</span>
06967 
06968             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
06969                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_HWPROFILE_QUERY_CHANGE)) {
06970 
06971                 <span class="keywordflow">if</span> (VetoType) {
06972                     *VetoType = PNP_VetoDriver;
06973                 }
06974                 <span class="keywordflow">if</span> (VetoName) {
06975                     VetoName-&gt;Length = 0;
06976                     <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(VetoName, &amp;pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
06977                 }
06978 
06979                 notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o2">Event</a> = GUID_HWPROFILE_CHANGE_CANCELLED;
06980                 notification.<a class="code" href="../../d9/d8/struct__HWPROFILE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(GUID_HWPROFILE_CHANGE_CANCELLED);
06981 
06982                 <span class="comment">//</span>
06983                 <span class="comment">// Dereference the entry which vetoed the query change.</span>
06984                 <span class="comment">//</span>
06985                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
06986                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06987 
06988                 <span class="keywordflow">do</span> {
06989                     pNotifyList = (<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
06990                     <span class="keywordflow">if</span> (!pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a>) {
06991                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
06992                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
06993 
06994 <span class="preprocessor">#if DBG</span>
06995 <span class="preprocessor"></span>                        originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
06996 <span class="preprocessor">#endif</span>
06997 <span class="preprocessor"></span>                        callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
06998                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
06999                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
07000 
07001                         <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
07002 <span class="preprocessor">#if DBG</span>
07003 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07004                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyHwProfileChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07005                                      &amp;pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, pNotifyList-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07006                             DbgBreakPoint();
07007                         }
07008 <span class="preprocessor">#endif</span>
07009 <span class="preprocessor"></span>
07010                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
07011                         link = link-&gt;Blink;
07012                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
07013 
07014                     } <span class="keywordflow">else</span> {
07015                         link = link-&gt;Blink;
07016                     }
07017                 } <span class="keywordflow">while</span> (link != (PLIST_ENTRY)&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>);
07018 
07019                 <span class="keywordflow">goto</span> Clean0;
07020             }
07021 
07022             <span class="comment">//</span>
07023             <span class="comment">// Reacquire the lock, walk forward, and dereference</span>
07024             <span class="comment">//</span>
07025             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a> (&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
07026             link = link-&gt;Flink;
07027             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)pNotifyList);
07028             pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
07029 
07030         } <span class="keywordflow">else</span> {
07031             <span class="comment">//</span>
07032             <span class="comment">//Walk forward if we hit an unregistered node</span>
07033             <span class="comment">//</span>
07034             <span class="keywordflow">if</span> (pNotifyList) {
07035                 <span class="comment">//</span>
07036                 <span class="comment">//walk forward</span>
07037                 <span class="comment">//</span>
07038                 link = link-&gt;Flink;
07039                 pNotifyList=(<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a>)link;
07040             }
07041         }
07042     }
07043 
07044  Clean0:
07045 
07046     <span class="comment">//UnLock the Profile Notification List</span>
07047     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a> (&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
07048 
07049     <span class="keywordflow">return</span> status;
07050 }
07051 
07052 
07053 
07054 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07055"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a349">07055</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a349">IopNotifyTargetDeviceChange</a>(
07056     LPCGUID EventGuid,
07057     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
07058     PVOID NotificationStructure,
07059     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> *VetoingDriver
07060     )
07061 
07062 <span class="comment">/*++</span>
07063 <span class="comment"></span>
07064 <span class="comment">Routine Description:</span>
07065 <span class="comment"></span>
07066 <span class="comment">    This routine is used to notify all registered drivers of a change to a</span>
07067 <span class="comment">    particular device. It does not return until all interested parties have</span>
07068 <span class="comment">    been notified.</span>
07069 <span class="comment"></span>
07070 <span class="comment">Parameters:</span>
07071 <span class="comment"></span>
07072 <span class="comment">    EventGuid - The event that has occured</span>
07073 <span class="comment"></span>
07074 <span class="comment">    DeviceObject - The device object that has changed.  The devnode for this</span>
07075 <span class="comment">        device object contains a list of callback routines that have registered</span>
07076 <span class="comment">        for notification of any changes on this device object.</span>
07077 <span class="comment"></span>
07078 <span class="comment">Return Value:</span>
07079 <span class="comment"></span>
07080 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
07081 <span class="comment"></span>
07082 <span class="comment">Note:</span>
07083 <span class="comment"></span>
07084 <span class="comment">    The contents of the notification structure *including* all pointers is only</span>
07085 <span class="comment">    valid during the callback routine to which it was passed.  If the data is</span>
07086 <span class="comment">    required after the duration of the callback then it must be physically copied</span>
07087 <span class="comment">    by the callback routine.</span>
07088 <span class="comment"></span>
07089 <span class="comment">--*/</span>
07090 
07091 {
07092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07093     PLIST_ENTRY link, lastLink;
07094     <a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a> entry;
07095     <a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html">TARGET_DEVICE_REMOVAL_NOTIFICATION</a> notification;
07096     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07097     BOOLEAN reverse;
07098 <span class="preprocessor">#if DBG</span>
07099 <span class="preprocessor"></span>    KIRQL originalIrql;
07100     ULONG originalApcDisable;
07101 <span class="preprocessor">#endif</span>
07102 <span class="preprocessor"></span>
07103     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07104 
07105     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07106     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(EventGuid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07107 
07108     <span class="comment">//</span>
07109     <span class="comment">// Reference the device object so it can't go away while we're doing notification</span>
07110     <span class="comment">//</span>
07111     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceObject);
07112 
07113     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
07114 
07115     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07116 
07117 
07118     <span class="keywordflow">if</span> (NotificationStructure) {
07119         <span class="comment">//</span>
07120         <span class="comment">//We're handling a custom notification</span>
07121         <span class="comment">//</span>
07122 
07123         ((<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">PTARGET_DEVICE_CUSTOM_NOTIFICATION</a>)NotificationStructure)-&gt;Version = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07124 
07125     } <span class="keywordflow">else</span> {
07126         <span class="comment">//</span>
07127         <span class="comment">// Fill in the notification</span>
07128         <span class="comment">//</span>
07129 
07130         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07131         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html">TARGET_DEVICE_REMOVAL_NOTIFICATION</a>);
07132         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o2">Event</a> = *EventGuid;
07133     }
07134 
07135     <span class="comment">//</span>
07136     <span class="comment">// Lock the notify list</span>
07137     <span class="comment">//</span>
07138 
07139     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07140 
07141     <span class="comment">//</span>
07142     <span class="comment">// Get the first entry</span>
07143     <span class="comment">//</span>
07144 
07145     reverse = <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_TARGET_DEVICE_REMOVE_CANCELLED);
07146 
07147     <span class="keywordflow">if</span> (reverse) {
07148         link = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>.Blink;
07149     } <span class="keywordflow">else</span> {
07150         link = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>.Flink;
07151     }
07152 
07153     <span class="comment">//</span>
07154     <span class="comment">// Iterate through the list</span>
07155     <span class="comment">//</span>
07156 
07157     <span class="keywordflow">while</span> (link != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>) {
07158 
07159         entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)link;
07160 
07161         <span class="comment">//</span>
07162         <span class="comment">// Only callback on registered nodes</span>
07163         <span class="comment">//</span>
07164 
07165         <span class="keywordflow">if</span> (!entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o6">Unregistered</a>) {
07166 
07167             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
07168             ULONG Console=0;
07169 
07170             <span class="comment">//</span>
07171             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
07172             <span class="comment">// and then release the lock</span>
07173             <span class="comment">//</span>
07174 
07175             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07176             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07177 
07178 <span class="preprocessor">#if DBG</span>
07179 <span class="preprocessor"></span>            originalIrql = KeGetCurrentIrql();
07180             originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07181 <span class="preprocessor">#endif</span>
07182 <span class="preprocessor"></span>
07183             <span class="comment">//</span>
07184             <span class="comment">// Callback the entity that registered and examine return value</span>
07185             <span class="comment">//</span>
07186 
07187             <span class="keywordflow">if</span> (NotificationStructure) {
07188                 <a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html">TARGET_DEVICE_CUSTOM_NOTIFICATION</a> *notificationStructure = NotificationStructure;
07189 
07190                 notificationStructure-&gt;<a class="code" href="../../d0/d0/struct__TARGET__DEVICE__CUSTOM__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;FileObject;
07191 
07192                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
07193                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=NotificationStructure;
07194                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
07195 
07196 
07197                 <span class="comment">//</span>
07198                 <span class="comment">// Dispatch this function via the memory manager.</span>
07199                 <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
07200                 <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
07201                 <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
07202                 <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
07203                 <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
07204                 <span class="comment">// then the callback is called directly.</span>
07205                 <span class="comment">//</span>
07206                 status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
07207 
07208 
07209             } <span class="keywordflow">else</span> {
07210                 notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;FileObject;
07211 
07212                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
07213                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07214                 callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
07215 
07216                 status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
07217 
07218             }
07219 
07220 <span class="preprocessor">#if DBG</span>
07221 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalIrql != KeGetCurrentIrql()) {
07222                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned at raised IRQL = %d, original = %d\n"</span>,
07223                          &amp;entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, KeGetCurrentIrql(), originalIrql);
07224                 DbgBreakPoint();
07225             }
07226             <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07227                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07228                          &amp;entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07229                 DbgBreakPoint();
07230             }
07231 <span class="preprocessor">#endif</span>
07232 <span class="preprocessor"></span>
07233             <span class="comment">//</span>
07234             <span class="comment">// If the caller returned anything other than success and it was</span>
07235             <span class="comment">// a query remove, we veto the query remove and send cancels to</span>
07236             <span class="comment">// all callers that already got the query remove.</span>
07237             <span class="comment">//</span>
07238 
07239             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp;
07240                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(EventGuid, (LPGUID)&amp;GUID_TARGET_DEVICE_QUERY_REMOVE)) {
07241 
07242                 <span class="keywordflow">if</span> (VetoingDriver != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07243                     *VetoingDriver = entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>;
07244                 }
07245 
07246                 notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o2">Event</a> = GUID_TARGET_DEVICE_REMOVE_CANCELLED;
07247 
07248                 <span class="comment">//</span>
07249                 <span class="comment">// Dereference the entry which vetoed the query remove.</span>
07250                 <span class="comment">//</span>
07251                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07252                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07253 
07254                 <span class="keywordflow">do</span> {
07255                     entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)link;
07256                     <span class="keywordflow">if</span> (!entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o6">Unregistered</a>) {
07257                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07258                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07259 
07260                         notification.<a class="code" href="../../d2/d0/struct__TARGET__DEVICE__REMOVAL__NOTIFICATION.html#o3">FileObject</a> = entry-&gt;FileObject;
07261 <span class="preprocessor">#if DBG</span>
07262 <span class="preprocessor"></span>                        originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07263 <span class="preprocessor">#endif</span>
07264 <span class="preprocessor"></span>
07265                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
07266                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07267                         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
07268 
07269                         <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
07270 
07271 <span class="preprocessor">#if DBG</span>
07272 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07273                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyTargetDeviceChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07274                                      &amp;entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07275                             DbgBreakPoint();
07276                         }
07277 <span class="preprocessor">#endif</span>
07278 <span class="preprocessor"></span>
07279                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07280                         link = link-&gt;Blink;
07281                         <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07282 
07283                     } <span class="keywordflow">else</span> {
07284                         link = link-&gt;Blink;
07285                     }
07286                 } <span class="keywordflow">while</span> (link != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>);
07287 
07288                 <span class="keywordflow">goto</span> Clean0;
07289             }
07290 
07291             <span class="comment">//</span>
07292             <span class="comment">// Reacquire the lock and dereference</span>
07293             <span class="comment">//</span>
07294             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07295             <span class="keywordflow">if</span> (reverse) {
07296                 link = link-&gt;Blink;
07297             } <span class="keywordflow">else</span> {
07298                 link = link-&gt;Flink;
07299             }
07300             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07301 
07302         } <span class="keywordflow">else</span> {
07303 
07304             <span class="comment">//</span>
07305             <span class="comment">// Advance down the list</span>
07306             <span class="comment">//</span>
07307             <span class="keywordflow">if</span> (reverse) {
07308                 link = link-&gt;Blink;
07309             } <span class="keywordflow">else</span> {
07310                 link = link-&gt;Flink;
07311             }
07312         }
07313     }
07314 
07315 Clean0:
07316 
07317     <span class="comment">//</span>
07318     <span class="comment">// Release the lock and dereference the object</span>
07319     <span class="comment">//</span>
07320 
07321     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07322 
07323     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceObject);
07324 
07325     <span class="keywordflow">return</span> status;
07326 }
07327 
07328 
07329 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07330"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a351">07330</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a351">IopNotifyDeviceClassChange</a>(
07331     LPGUID EventGuid,
07332     LPGUID ClassGuid,
07333     PUNICODE_STRING SymbolicLinkName
07334     )
07335 
07336 <span class="comment">/*++</span>
07337 <span class="comment"></span>
07338 <span class="comment">Routine Description:</span>
07339 <span class="comment"></span>
07340 <span class="comment">    This routine is used to notify all registered drivers of a changes to a</span>
07341 <span class="comment">    particular class of device. It does not return until all interested parties have</span>
07342 <span class="comment">    been notified.</span>
07343 <span class="comment"></span>
07344 <span class="comment">Parameters:</span>
07345 <span class="comment"></span>
07346 <span class="comment">    EventTypeGuid - The event that has occured</span>
07347 <span class="comment"></span>
07348 <span class="comment">    ClassGuid - The device class this change has occured in</span>
07349 <span class="comment"></span>
07350 <span class="comment">    SymbolicLinkName - The kernel mode symbolic link name of the interface device</span>
07351 <span class="comment">        that changed</span>
07352 <span class="comment"></span>
07353 <span class="comment">Return Value:</span>
07354 <span class="comment"></span>
07355 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
07356 <span class="comment"></span>
07357 <span class="comment">Note:</span>
07358 <span class="comment"></span>
07359 <span class="comment">    The contents of the notification structure *including* all pointers is only</span>
07360 <span class="comment">    valid during the callback routine to which it was passed.  If the data is</span>
07361 <span class="comment">    required after the duration of the callback then it must be physically copied</span>
07362 <span class="comment">    by the callback routine.</span>
07363 <span class="comment"></span>
07364 <span class="comment">--*/</span>
07365 
07366 {
07367     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07368     PLIST_ENTRY link;
07369     <a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a> entry;
07370     <a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a> notification;
07371     ULONG hash;
07372 <span class="preprocessor">#if DBG</span>
07373 <span class="preprocessor"></span>    KIRQL originalIrql;
07374     ULONG originalApcDisable;
07375 <span class="preprocessor">#endif</span>
07376 <span class="preprocessor"></span>
07377     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07378 
07379     <span class="comment">//</span>
07380     <span class="comment">// Fill in the notification</span>
07381     <span class="comment">//</span>
07382 
07383     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07384     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a>);
07385     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o2">Event</a> = *EventGuid;
07386     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o3">InterfaceClassGuid</a> = *ClassGuid;
07387     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o4">SymbolicLinkName</a> = SymbolicLinkName;
07388 
07389     <span class="comment">//</span>
07390     <span class="comment">// Lock the notify list</span>
07391     <span class="comment">//</span>
07392 
07393     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07394 
07395     <span class="comment">//</span>
07396     <span class="comment">// Get the first entry</span>
07397     <span class="comment">//</span>
07398 
07399     hash = <a class="code" href="../../d9/d0/pnpiop_8h.html#a106">IopHashGuid</a>(ClassGuid);
07400     link = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[hash].Flink;
07401 
07402     <span class="comment">//</span>
07403     <span class="comment">// Iterate through the list</span>
07404     <span class="comment">//</span>
07405 
07406     <span class="keywordflow">while</span> (link != &amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[hash]) {
07407 
07408         entry = (<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a>) link;
07409 
07410         <span class="comment">//</span>
07411         <span class="comment">// Only callback on registered nodes of the correct device class</span>
07412         <span class="comment">//</span>
07413 
07414         <span class="keywordflow">if</span> ( !entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o6">Unregistered</a> &amp;&amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a109">IopCompareGuid</a>(&amp;(entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o8">ClassGuid</a>), ClassGuid) ) {
07415 
07416             <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
07417             ULONG Console=0;
07418             <span class="comment">//</span>
07419             <span class="comment">// Reference the entry so that no one deletes during the callback</span>
07420             <span class="comment">// and then release the lock</span>
07421             <span class="comment">//</span>
07422 
07423             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07424             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07425 
07426 <span class="preprocessor">#if DBG</span>
07427 <span class="preprocessor"></span>            originalIrql = KeGetCurrentIrql();
07428             originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07429 <span class="preprocessor">#endif</span>
07430 <span class="preprocessor"></span>
07431             <span class="comment">//</span>
07432             <span class="comment">// Callback the entity that registered and ignore the return value as</span>
07433             <span class="comment">// we arn't interested in it</span>
07434             <span class="comment">//</span>
07435 
07436             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>);
07437             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07438             callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o3">Context</a>;
07439 
07440 
07441             <span class="comment">//</span>
07442             <span class="comment">// Dispatch this function via the memory manager.</span>
07443             <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
07444             <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
07445             <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
07446             <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
07447             <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
07448             <span class="comment">// then the callback is called directly.</span>
07449             <span class="comment">//</span>
07450             <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
07451 
07452 
07453 
07454 <span class="preprocessor">#if DBG</span>
07455 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (originalIrql != KeGetCurrentIrql()) {
07456                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyDeviceClassChange: Driver %Z, notification handler @ 0x%p returned at raised IRQL = %d, original = %d\n"</span>,
07457                          &amp;entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, KeGetCurrentIrql(), originalIrql);
07458                 DbgBreakPoint();
07459             }
07460             <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
07461                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopNotifyDeviceClassChange: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
07462                          &amp;entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o4">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>, entry-&gt;<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html#o2">Callback</a>, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
07463                 DbgBreakPoint();
07464             }
07465 <span class="preprocessor">#endif</span>
07466 <span class="preprocessor"></span>            <span class="comment">//</span>
07467             <span class="comment">// Reacquire the lock and dereference</span>
07468             <span class="comment">//</span>
07469 
07470             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07471             link = link-&gt;Flink;
07472             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a70">IopDereferenceNotify</a>( (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>) entry );
07473 
07474         } <span class="keywordflow">else</span> {
07475 
07476             <span class="comment">//</span>
07477             <span class="comment">// Advance down the list</span>
07478             <span class="comment">//</span>
07479 
07480             link = link-&gt;Flink;
07481         }
07482     }
07483 
07484     <span class="comment">//</span>
07485     <span class="comment">// Release the lock</span>
07486     <span class="comment">//</span>
07487 
07488     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07489 
07490     <span class="keywordflow">return</span> status;
07491 }
07492 
07493 
07494 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l07495"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">07495</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a106">IoRegisterPlugPlayNotification</a>(
07496     IN IO_NOTIFICATION_EVENT_CATEGORY EventCategory,
07497     IN ULONG EventCategoryFlags,
07498     IN PVOID EventCategoryData OPTIONAL,
07499     IN <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject,
07500     IN PDRIVER_NOTIFICATION_CALLBACK_ROUTINE CallbackRoutine,
07501     IN PVOID Context,
07502     OUT PVOID *NotificationEntry
07503     )
07504 <span class="comment">/*++</span>
07505 <span class="comment"></span>
07506 <span class="comment">Routine Description:</span>
07507 <span class="comment"></span>
07508 <span class="comment">    IoRegisterPlugPlayNotification provides a mechanism by which WDM drivers may</span>
07509 <span class="comment">    receive notification (via callback) for a variety of Plug&amp;Play events.</span>
07510 <span class="comment"></span>
07511 <span class="comment">Arguments:</span>
07512 <span class="comment"></span>
07513 <span class="comment">    EventCategory - Specifies the event category being registered for.  WDM drivers</span>
07514 <span class="comment">        may currently register for hard-ware profile changes, device class changes</span>
07515 <span class="comment">        (instance arrivals and removals), and target device changes (query-removal,</span>
07516 <span class="comment">        cancel-removal, removal-complete, as well as 3rd-party extensible events).</span>
07517 <span class="comment"></span>
07518 <span class="comment">    EventCategoryFlags - Supplies flags that modify the behavior of event registration.</span>
07519 <span class="comment">        There is a separate group of flags defined for each event category.  Presently,</span>
07520 <span class="comment">        only the interface device change event category has any flags defined:</span>
07521 <span class="comment"></span>
07522 <span class="comment">            DEVICE_CLASS_NOTIFY_FOR_EXISTING_DEVICES -- Drivers wishing to retrieve a</span>
07523 <span class="comment">                complete list of all interface devices presently available, and keep</span>
07524 <span class="comment">                the list up-to-date (i.e., receive notification of interface device</span>
07525 <span class="comment">                arrivals and removals), may specify this flag.  This will cause the</span>
07526 <span class="comment">                PnP manager to immediately notify the driver about every currently-existing</span>
07527 <span class="comment">                device of the specified interface class.</span>
07528 <span class="comment"></span>
07529 <span class="comment">    EventCategoryData - Used to  'filter' events of the desired category based on the</span>
07530 <span class="comment">        supplied criteria.  Not all event categories will use this parameter.  The</span>
07531 <span class="comment">        event categories presently defined use this information as fol-lows:</span>
07532 <span class="comment"></span>
07533 <span class="comment">        EventCategoryHardwareProfileChange -- this parameter is unused, and should be NULL.</span>
07534 <span class="comment">        EventCategoryDeviceClassChange -- LPGUID representing the interface class of interest</span>
07535 <span class="comment">        EventCategoryTargetDeviceChange -- PFILE_OBJECT of interest</span>
07536 <span class="comment"></span>
07537 <span class="comment">    DriverObject - The caller must supply a reference to its driver object (obtained via</span>
07538 <span class="comment">        ObReferenceObject), to prevent the driver from being unloaded while registered for</span>
07539 <span class="comment">        notification.  The PnP Manager will dereference the driver object when the driver</span>
07540 <span class="comment">        unregisters for notification via IoUnregisterPlugPlayNotification).</span>
07541 <span class="comment"></span>
07542 <span class="comment">    CallbackRoutine - Entry point within the driver that the PnP manager should call</span>
07543 <span class="comment">        whenever an applicable PnP event occurs.  The entry point must have the</span>
07544 <span class="comment">        following prototype:</span>
07545 <span class="comment"></span>
07546 <span class="comment">            typedef</span>
07547 <span class="comment">            NTSTATUS</span>
07548 <span class="comment">            (*PDRIVER_NOTIFICATION_CALLBACK_ROUTINE) (</span>
07549 <span class="comment">                IN PVOID NotificationStructure,</span>
07550 <span class="comment">                IN PVOID Context</span>
07551 <span class="comment">                );</span>
07552 <span class="comment"></span>
07553 <span class="comment">        where NotificationStructure contains information about the event.  Each event</span>
07554 <span class="comment">        GUID within an event category may potentially have its own notification structure</span>
07555 <span class="comment">        format, but the buffer must al-ways begin with a PLUGPLAY_NOTIFICATION_HEADER,</span>
07556 <span class="comment">        which indicates the size and ver-sion of the structure, as well as the GUID for</span>
07557 <span class="comment">        the event.</span>
07558 <span class="comment"></span>
07559 <span class="comment">        The Context parameter provides the callback with the same context data that the</span>
07560 <span class="comment">        caller passed in during registration.</span>
07561 <span class="comment"></span>
07562 <span class="comment">    Context - Points to the context data passed to the callback upon event notification.</span>
07563 <span class="comment"></span>
07564 <span class="comment">    NotificationEntry - Upon success, receives a handle representing the notification</span>
07565 <span class="comment">        registration.  This handle may be used to unregister for notification via</span>
07566 <span class="comment">        IoUnregisterPlugPlayNotification.</span>
07567 <span class="comment"></span>
07568 <span class="comment">--*/</span>
07569 {
07570 
07571     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07572 <span class="preprocessor">#if DBG</span>
07573 <span class="preprocessor"></span>    ULONG originalApcDisable;
07574 <span class="preprocessor">#endif</span>
07575 <span class="preprocessor"></span>
07576     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07577 
07578     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NotificationEntry);
07579 
07580     <span class="comment">//</span>
07581     <span class="comment">// Initialize out parameters</span>
07582     <span class="comment">//</span>
07583 
07584     *NotificationEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07585 
07586     <span class="comment">//</span>
07587     <span class="comment">// Reference the driver object so it doesn't go away while we still have</span>
07588     <span class="comment">// a pointer outstanding</span>
07589     <span class="comment">//</span>
07590     status = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>(DriverObject,
07591                                         0,
07592                                         <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
07593                                         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>
07594                                         );
07595 
07596     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07597         <span class="keywordflow">return</span> status;
07598     }
07599 
07600     <span class="keywordflow">switch</span> (EventCategory) {
07601 
07602     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a172a111">EventCategoryReserved</a>:
07603         {
07604 
07605             <a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">PSETUP_NOTIFY_DATA</a> setupData;
07606 
07607             <span class="comment">//</span>
07608             <span class="comment">// Allocate space for the setup data</span>
07609             <span class="comment">//</span>
07610 
07611             setupData = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html">SETUP_NOTIFY_DATA</a>));
07612             <span class="keywordflow">if</span> (!setupData) {
07613                 status = STATUS_INSUFFICIENT_RESOURCES;
07614                 <span class="keywordflow">goto</span> clean0;
07615             }
07616 
07617             <span class="comment">//</span>
07618             <span class="comment">// Store the required information</span>
07619             <span class="comment">//</span>
07620             InitializeListHead(&amp;(setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o0">ListEntry</a>));
07621             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o1">EventCategory</a> = EventCategory;
07622             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o2">Callback</a> = CallbackRoutine;
07623             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o3">Context</a> = Context;
07624             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o5">RefCount</a> = 1;
07625             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07626             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o7">Lock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07627             setupData-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o4">DriverObject</a> = DriverObject;
07628 
07629             <span class="comment">//</span>
07630             <span class="comment">// Activate the notifications</span>
07631             <span class="comment">//</span>
07632 
07633             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a> = setupData;
07634 
07635             <span class="comment">//</span>
07636             <span class="comment">// Explicitly NULL out the returned entry as you can *NOT* unregister</span>
07637             <span class="comment">// for setup notifications</span>
07638             <span class="comment">//</span>
07639 
07640             *NotificationEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07641 
07642             <span class="keywordflow">break</span>;
07643 
07644         }
07645 
07646     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a172a112">EventCategoryHardwareProfileChange</a>:
07647         {
07648             <a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">PHWPROFILE_NOTIFY_ENTRY</a> entry;
07649 
07650             <span class="comment">//</span>
07651             <span class="comment">// new entry</span>
07652             <span class="comment">//</span>
07653             entry =<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,<span class="keyword">sizeof</span> (<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html">HWPROFILE_NOTIFY_ENTRY</a>));
07654             <span class="keywordflow">if</span> (!entry) {
07655                 status = STATUS_INSUFFICIENT_RESOURCES;
07656                 <span class="keywordflow">goto</span> clean0;
07657             }
07658 
07659             <span class="comment">//</span>
07660             <span class="comment">// grab the fields</span>
07661             <span class="comment">//</span>
07662 
07663             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o1">EventCategory</a> = EventCategory;
07664             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o2">Callback</a> = CallbackRoutine;
07665             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o3">Context</a> = Context;
07666             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o5">RefCount</a> = 1;
07667             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07668             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o7">Lock</a> = &amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>;
07669             entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o4">DriverObject</a> = DriverObject;
07670 
07671             ExAcquireFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07672             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a>) {
07673                 <span class="comment">//</span>
07674                 <span class="comment">// If a notification is in progress, mark the entry as</span>
07675                 <span class="comment">// Unregistered until after the current notification is</span>
07676                 <span class="comment">// complete.</span>
07677                 <span class="comment">//</span>
07678 
07679                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
07680 
07681                 deferredNode = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">DEFERRED_REGISTRATION_ENTRY</a>));
07682                 <span class="keywordflow">if</span> (!deferredNode) {
07683                     ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07684                     status = STATUS_INSUFFICIENT_RESOURCES;
07685                     <span class="keywordflow">goto</span> clean0;
07686                 }
07687 
07688                 deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a> = (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry;
07689 
07690                 <span class="comment">//</span>
07691                 <span class="comment">// Consider this entry unregistered during the current</span>
07692                 <span class="comment">// notification</span>
07693                 <span class="comment">//</span>
07694                 entry-&gt;<a class="code" href="../../d0/d9/struct__HWPROFILE__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07695 
07696                 <span class="comment">//</span>
07697                 <span class="comment">// Reference the entry so that it doesn't go away until it has</span>
07698                 <span class="comment">// been removed from the deferred registration list</span>
07699                 <span class="comment">//</span>
07700                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07701 
07702                 <span class="comment">//</span>
07703                 <span class="comment">// Add this entry to the deferred registration list</span>
07704                 <span class="comment">//</span>
07705                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07706                 InsertTailList(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>, (PLIST_ENTRY)deferredNode);
07707                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07708             } <span class="keywordflow">else</span> {
07709                 <span class="comment">//</span>
07710                 <span class="comment">// If there is currently no notification in progress, the deferred</span>
07711                 <span class="comment">// registration list must be empty.</span>
07712                 <span class="comment">//</span>
07713                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>));
07714             }
07715             ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07716 
07717             <span class="comment">//</span>
07718             <span class="comment">// Lock the list, insert the new entry, and unlock it.</span>
07719             <span class="comment">//</span>
07720 
07721             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
07722             InsertTailList(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a41">IopProfileNotifyList</a>, (PLIST_ENTRY)entry);
07723             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a42">IopHwProfileNotifyLock</a>);
07724 
07725             *NotificationEntry = entry;
07726 
07727             <span class="keywordflow">break</span>;
07728         }
07729     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a172a114">EventCategoryTargetDeviceChange</a>:
07730         {
07731             <a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a> entry;
07732             <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
07733             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07734 
07735             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(EventCategoryData);
07736 
07737             <span class="comment">//</span>
07738             <span class="comment">// Allocate a new list entry</span>
07739             <span class="comment">//</span>
07740 
07741             entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">TARGET_DEVICE_NOTIFY_ENTRY</a>));
07742             <span class="keywordflow">if</span> (!entry) {
07743                 status = STATUS_INSUFFICIENT_RESOURCES;
07744                 <span class="keywordflow">goto</span> clean0;
07745             }
07746 
07747             <span class="comment">//</span>
07748             <span class="comment">// Retrieve the device object associated with this file handle.</span>
07749             <span class="comment">//</span>
07750             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a350">IopGetRelatedTargetDevice</a>((<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)EventCategoryData,
07751                                                &amp;deviceNode);
07752             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07753                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
07754                 <span class="keywordflow">goto</span> clean0;
07755             }
07756 
07757             <span class="comment">//</span>
07758             <span class="comment">// Fill out the entry</span>
07759             <span class="comment">//</span>
07760 
07761             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o1">EventCategory</a> = EventCategory;
07762             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o2">Callback</a> = CallbackRoutine;
07763             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o3">Context</a> = Context;
07764             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o4">DriverObject</a> = DriverObject;
07765             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o5">RefCount</a> = 1;
07766             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07767             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o7">Lock</a> = &amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>;
07768             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o8">FileObject</a> = (<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>)EventCategoryData;
07769 
07770             <span class="comment">//</span>
07771             <span class="comment">// The PDO associated with the devnode we got back from</span>
07772             <span class="comment">// IopGetRelatedTargetDevice has already been referenced by that</span>
07773             <span class="comment">// routine.  Store this reference away in the notification entry,</span>
07774             <span class="comment">// so we can deref it later when the notification entry is unregistered.</span>
07775             <span class="comment">//</span>
07776 
07777             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
07778             entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a> = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
07779 
07780             ExAcquireFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07781             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a>) {
07782                 <span class="comment">//</span>
07783                 <span class="comment">// If a notification is in progress, mark the entry as</span>
07784                 <span class="comment">// Unregistered until after the current notification is</span>
07785                 <span class="comment">// complete.</span>
07786                 <span class="comment">//</span>
07787 
07788                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
07789 
07790                 deferredNode = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">DEFERRED_REGISTRATION_ENTRY</a>));
07791                 <span class="keywordflow">if</span> (!deferredNode) {
07792                     ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07793                     status = STATUS_INSUFFICIENT_RESOURCES;
07794                     <span class="keywordflow">goto</span> clean0;
07795                 }
07796 
07797                 deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a> = (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry;
07798 
07799                 <span class="comment">//</span>
07800                 <span class="comment">// Consider this entry unregistered during the current</span>
07801                 <span class="comment">// notification</span>
07802                 <span class="comment">//</span>
07803                 entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07804 
07805                 <span class="comment">//</span>
07806                 <span class="comment">// Reference the entry so that it doesn't go away until it has</span>
07807                 <span class="comment">// been removed from the deferred registration list</span>
07808                 <span class="comment">//</span>
07809                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07810 
07811                 <span class="comment">//</span>
07812                 <span class="comment">// Add this entry to the deferred registration list</span>
07813                 <span class="comment">//</span>
07814                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07815                 InsertTailList(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>, (PLIST_ENTRY)deferredNode);
07816                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07817             } <span class="keywordflow">else</span> {
07818                 <span class="comment">//</span>
07819                 <span class="comment">// If there is currently no notification in progress, the deferred</span>
07820                 <span class="comment">// registration list must be empty.</span>
07821                 <span class="comment">//</span>
07822                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>));
07823             }
07824             ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07825 
07826             <span class="comment">//</span>
07827             <span class="comment">// Lock the list, insert the new entry, and unlock it.</span>
07828             <span class="comment">//</span>
07829 
07830             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07831             InsertTailList(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>, (PLIST_ENTRY)entry);
07832             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
07833 
07834             *NotificationEntry = entry;
07835             <span class="keywordflow">break</span>;
07836         }
07837 
07838     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a172a113">EventCategoryDeviceInterfaceChange</a>:
07839         {
07840             <a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">PDEVICE_CLASS_NOTIFY_ENTRY</a> entry;
07841 
07842             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(EventCategoryData);
07843 
07844             <span class="comment">//</span>
07845             <span class="comment">// Allocate a new list entry</span>
07846             <span class="comment">//</span>
07847 
07848             entry = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html">DEVICE_CLASS_NOTIFY_ENTRY</a>));
07849             <span class="keywordflow">if</span> (!entry) {
07850                 status = STATUS_INSUFFICIENT_RESOURCES;
07851                 <span class="keywordflow">goto</span> clean0;
07852             }
07853 
07854             <span class="comment">//</span>
07855             <span class="comment">// Fill out the entry</span>
07856             <span class="comment">//</span>
07857 
07858             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o1">EventCategory</a> = EventCategory;
07859             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o2">Callback</a> = CallbackRoutine;
07860             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o3">Context</a> = Context;
07861             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o8">ClassGuid</a> = *((LPGUID) EventCategoryData);
07862             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o5">RefCount</a> = 1;
07863             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07864             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o7">Lock</a> = &amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>;
07865             entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o4">DriverObject</a> = DriverObject;
07866 
07867             ExAcquireFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07868             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a43">PiNotificationInProgress</a>) {
07869                 <span class="comment">//</span>
07870                 <span class="comment">// If a notification is in progress, mark the entry as</span>
07871                 <span class="comment">// Unregistered until after the current notification is</span>
07872                 <span class="comment">// complete.</span>
07873                 <span class="comment">//</span>
07874 
07875                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a46">PDEFERRED_REGISTRATION_ENTRY</a> deferredNode;
07876 
07877                 deferredNode = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html">DEFERRED_REGISTRATION_ENTRY</a>));
07878                 <span class="keywordflow">if</span> (!deferredNode) {
07879                     ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07880                     status = STATUS_INSUFFICIENT_RESOURCES;
07881                     <span class="keywordflow">goto</span> clean0;
07882                 }
07883 
07884                 deferredNode-&gt;<a class="code" href="../../d4/d2/struct__DEFERRED__REGISTRATION__ENTRY.html#o1">NotifyEntry</a> = (<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry;
07885 
07886                 <span class="comment">//</span>
07887                 <span class="comment">// Consider this entry unregistered during the current</span>
07888                 <span class="comment">// notification</span>
07889                 <span class="comment">//</span>
07890                 entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o6">Unregistered</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07891 
07892                 <span class="comment">//</span>
07893                 <span class="comment">// Reference the entry so that it doesn't go away until it has</span>
07894                 <span class="comment">// been removed from the deferred registration list</span>
07895                 <span class="comment">//</span>
07896                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a69">IopReferenceNotify</a>((<a class="code" href="../../d0/d4/struct__NOTIFY__ENTRY__HEADER.html">PNOTIFY_ENTRY_HEADER</a>)entry);
07897 
07898                 <span class="comment">//</span>
07899                 <span class="comment">// Add this entry to the deferred registration list</span>
07900                 <span class="comment">//</span>
07901                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07902                 InsertTailList(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>, (PLIST_ENTRY)deferredNode);
07903                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a48">IopDeferredRegistrationLock</a>);
07904             } <span class="keywordflow">else</span> {
07905                 <span class="comment">//</span>
07906                 <span class="comment">// If there is currently no notification in progress, the deferred</span>
07907                 <span class="comment">// registration list must be empty.</span>
07908                 <span class="comment">//</span>
07909                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a47">IopDeferredRegistrationList</a>));
07910             }
07911             ExReleaseFastMutex(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a44">PiNotificationInProgressLock</a>);
07912 
07913             <span class="comment">//</span>
07914             <span class="comment">// Lock the list</span>
07915             <span class="comment">//</span>
07916 
07917             <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07918 
07919             <span class="comment">//</span>
07920             <span class="comment">// Insert it at the tail</span>
07921             <span class="comment">//</span>
07922 
07923             InsertTailList( (PLIST_ENTRY) &amp;(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a37">IopDeviceClassNotifyList</a>[ <a class="code" href="../../d9/d0/pnpiop_8h.html#a106">IopHashGuid</a>(&amp;(entry-&gt;<a class="code" href="../../d4/d3/struct__DEVICE__CLASS__NOTIFY__ENTRY.html#o8">ClassGuid</a>)) ]),
07924                             (PLIST_ENTRY) entry
07925                           );
07926 
07927             <span class="comment">//</span>
07928             <span class="comment">// Unlock the list</span>
07929             <span class="comment">//</span>
07930 
07931             <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a38">IopDeviceClassNotifyLock</a>);
07932 
07933             <span class="comment">//</span>
07934             <span class="comment">// See if we need to notify for all the device classes already present</span>
07935             <span class="comment">//</span>
07936 
07937             <span class="keywordflow">if</span> (EventCategoryFlags &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a6">PNPNOTIFY_DEVICE_INTERFACE_INCLUDE_EXISTING_INTERFACES</a>) {
07938 
07939                 PWCHAR pSymbolicLinks, pCurrent;
07940                 <a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a> notification;
07941                 UNICODE_STRING unicodeString;
07942 
07943                 <span class="comment">//</span>
07944                 <span class="comment">// Fill in the notification structure</span>
07945                 <span class="comment">//</span>
07946 
07947                 notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
07948                 notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html">DEVICE_INTERFACE_CHANGE_NOTIFICATION</a>);
07949                 notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o2">Event</a> = GUID_DEVICE_INTERFACE_ARRIVAL;
07950                 notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o3">InterfaceClassGuid</a> = entry-&gt;ClassGuid;
07951 
07952                 <span class="comment">//</span>
07953                 <span class="comment">// Get the list of all the devices of this function class that are</span>
07954                 <span class="comment">// already in the system</span>
07955                 <span class="comment">//</span>
07956 
07957                 status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a86">IoGetDeviceInterfaces</a>(&amp;(entry-&gt;ClassGuid),
07958                                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
07959                                                 0,
07960                                                 &amp;pSymbolicLinks
07961                                                 );
07962                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07963                     <span class="comment">//</span>
07964                     <span class="comment">// No buffer will have been returned so just return status</span>
07965                     <span class="comment">//</span>
07966                     <span class="keywordflow">goto</span> clean0;
07967                 }
07968 
07969                 <span class="comment">//</span>
07970                 <span class="comment">// Callback for each device currently in the system</span>
07971                 <span class="comment">//</span>
07972 
07973                 pCurrent = pSymbolicLinks;
07974                 <span class="keywordflow">while</span>(*pCurrent != UNICODE_NULL) {
07975                     <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
07976                     ULONG Console=0;
07977 
07978                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, pCurrent);
07979                     notification.<a class="code" href="../../d0/d4/struct__DEVICE__INTERFACE__CHANGE__NOTIFICATION.html#o4">SymbolicLinkName</a> = &amp;unicodeString;
07980 
07981 <span class="preprocessor">#if DBG</span>
07982 <span class="preprocessor"></span>                    originalApcDisable = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable;
07983 <span class="preprocessor">#endif</span>
07984 <span class="preprocessor"></span>                    <span class="comment">//</span>
07985                     <span class="comment">// Call back on the registered notification routine</span>
07986                     <span class="comment">//</span>
07987                     callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(*CallbackRoutine);
07988                     callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
07989                     callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=Context;
07990 
07991 
07992                     <span class="comment">//</span>
07993                     <span class="comment">// Dispatch this function via the memory manager.</span>
07994                     <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
07995                     <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
07996                     <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
07997                     <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
07998                     <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
07999                     <span class="comment">// then the callback is called directly.</span>
08000                     <span class="comment">//</span>
08001                     <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
08002 
08003 <span class="preprocessor">#if DBG</span>
08004 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (originalApcDisable != <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable) {
08005                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IoRegisterPlugPlayNotification: Driver %Z, notification handler @ 0x%p returned with different KernelApcDisable = %d, original = %d\n"</span>,
08006                                  &amp;entry-&gt;DriverObject-&gt;DriverName, entry-&gt;Callback, <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;KernelApcDisable, originalApcDisable);
08007                         DbgBreakPoint();
08008                     }
08009 <span class="preprocessor">#endif</span>
08010 <span class="preprocessor"></span>
08011                     pCurrent += (unicodeString.Length / <span class="keyword">sizeof</span>(WCHAR)) + 1;
08012 
08013                 }
08014 
08015                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pSymbolicLinks);
08016 
08017             }
08018 
08019             *NotificationEntry = entry;
08020         }
08021 
08022         <span class="keywordflow">break</span>;
08023     }
08024 
08025 clean0:
08026 
08027     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08028         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DriverObject);
08029     }
08030 
08031     <span class="keywordflow">return</span> status;
08032 }
08033 
08034 
08035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08036"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a350">08036</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a350">IopGetRelatedTargetDevice</a>(
08037     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
08038     OUT <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *DeviceNode
08039     )
08040 
08041 <span class="comment">/*++</span>
08042 <span class="comment"></span>
08043 <span class="comment">Routine Description:</span>
08044 <span class="comment"></span>
08045 <span class="comment">    IopGetRelatedTargetDevice retrieves the device object associated with</span>
08046 <span class="comment">    the specified file object and then sends a query device relations irp</span>
08047 <span class="comment">    to that device object.</span>
08048 <span class="comment"></span>
08049 <span class="comment">    NOTE: The PDO associated with the returned device node has been referenced,</span>
08050 <span class="comment">    and must be dereferenced when no longer needed.</span>
08051 <span class="comment"></span>
08052 <span class="comment">Arguments:</span>
08053 <span class="comment"></span>
08054 <span class="comment">    FileObject - Specifies the file object that is associated with the device</span>
08055 <span class="comment">                 object that will receive the query device relations irp.</span>
08056 <span class="comment"></span>
08057 <span class="comment">    DeviceNode - Returns the related target device node.</span>
08058 <span class="comment"></span>
08059 <span class="comment">ReturnValue</span>
08060 <span class="comment"></span>
08061 <span class="comment">    Returns an NTSTATUS value.</span>
08062 <span class="comment"></span>
08063 <span class="comment">--*/</span>
08064 
08065 {
08066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08067     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a> irpSp;
08068     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
08069     <a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html">PDEVICE_RELATIONS</a> deviceRelations;
08070 
08071     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FileObject);
08072 
08073     <span class="comment">//</span>
08074     <span class="comment">// Retrieve the device object associated with this file handle.</span>
08075     <span class="comment">//</span>
08076 
08077     deviceObject = <a class="code" href="../../d4/d6/iosubs_8c.html#a76">IoGetRelatedDeviceObject</a>(FileObject);
08078     <span class="keywordflow">if</span> (!deviceObject) {
08079         <span class="keywordflow">return</span> STATUS_NO_SUCH_DEVICE;
08080     }
08081 
08082     <span class="comment">//</span>
08083     <span class="comment">// Query what the "actual" target device node should be for</span>
08084     <span class="comment">// this file object. Initialize the stack location to pass to</span>
08085     <span class="comment">// IopSynchronousCall() and then send the IRP to the device</span>
08086     <span class="comment">// object that's associated with the file handle.</span>
08087     <span class="comment">//</span>
08088 
08089     RtlZeroMemory(&amp;irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>));
08090     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>;
08091     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a72">IRP_MN_QUERY_DEVICE_RELATIONS</a>;
08092     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDeviceRelations.Type = <a class="code" href="../../d0/d5/io_8h.html#a602a416">TargetDeviceRelation</a>;
08093     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> = deviceObject;
08094     irpSp.<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> = FileObject;
08095 
08096     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a18">IopSynchronousCall</a>(deviceObject, &amp;irpSp, &amp;deviceRelations);
08097     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08098 <span class="preprocessor">#if 0</span>
08099 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpMgr: Contact dev owner for %WZ, which may not correctly support\n"</span>,
08100                  &amp;deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>);
08101         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        IRP_MN_QUERY_DEVICE_RELATIONS:TargetDeviceRelation\n"</span>);
08102         <span class="comment">//ASSERT(0);</span>
08103 <span class="preprocessor">#endif</span>
08104 <span class="preprocessor"></span>        <span class="keywordflow">return</span> status;
08105     }
08106 
08107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceRelations);
08108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o0">Count</a> == 1);
08109 
08110     *DeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceRelations-&gt;<a class="code" href="../../d0/d5/struct__DEVICE__RELATIONS.html#o1">Objects</a>[0]-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08111     <span class="keywordflow">if</span> (!*DeviceNode) {
08112         status = STATUS_NO_SUCH_DEVICE;
08113     }
08114 
08115     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceRelations);
08116     <span class="keywordflow">return</span> status;
08117 }
08118 
08119 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08120"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a108">08120</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a108">IoGetRelatedTargetDevice</a>(
08121     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject,
08122     OUT <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *DeviceObject
08123     )
08124 
08125 <span class="comment">/*++</span>
08126 <span class="comment"></span>
08127 <span class="comment">Routine Description:</span>
08128 <span class="comment"></span>
08129 <span class="comment">    IoGetRelatedTargetDevice retrieves the device object associated with</span>
08130 <span class="comment">    the specified file object and then sends a query device relations irp</span>
08131 <span class="comment">    to that device object.</span>
08132 <span class="comment"></span>
08133 <span class="comment">    NOTE: The PDO associated with the returned device node has been referenced,</span>
08134 <span class="comment">    and must be dereferenced when no longer needed.</span>
08135 <span class="comment"></span>
08136 <span class="comment">Arguments:</span>
08137 <span class="comment"></span>
08138 <span class="comment">    FileObject - Specifies the file object that is associated with the device</span>
08139 <span class="comment">                 object that will receive the query device relations irp.</span>
08140 <span class="comment"></span>
08141 <span class="comment">    DeviceObject - Returns the related target device object.</span>
08142 <span class="comment"></span>
08143 <span class="comment">ReturnValue</span>
08144 <span class="comment"></span>
08145 <span class="comment">    Returns an NTSTATUS value.</span>
08146 <span class="comment"></span>
08147 <span class="comment">--*/</span>
08148 
08149 {
08150     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08151     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08152 
08153     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a350">IopGetRelatedTargetDevice</a>( FileObject, &amp;deviceNode );
08154     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceNode != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08155         *DeviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
08156     }
08157     <span class="keywordflow">return</span> status;
08158 }
08159 
08160 
08161 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08162"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a347">08162</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a347">IopNotifySetupDeviceArrival</a>(
08163     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,    <span class="comment">// PDO of the device</span>
08164     HANDLE EnumEntryKey,                    <span class="comment">// Handle into the enum branch of the registry for this device</span>
08165     BOOLEAN InstallDriver
08166     )
08167 
08168 <span class="comment">/*++</span>
08169 <span class="comment"></span>
08170 <span class="comment">Routine Description:</span>
08171 <span class="comment"></span>
08172 <span class="comment">    This routine is used to notify setup (during text-mode setup) of arrivals</span>
08173 <span class="comment">    of a particular device. It does not return until all interested parties have</span>
08174 <span class="comment">    been notified.</span>
08175 <span class="comment"></span>
08176 <span class="comment">Parameters:</span>
08177 <span class="comment"></span>
08178 <span class="comment">    PhysicalDeviceObject - Supplies a pointer to the PDO of the newly arrived</span>
08179 <span class="comment">        device.</span>
08180 <span class="comment"></span>
08181 <span class="comment">    EnumEntryKey - Supplies a handle to the key associated with the devide under</span>
08182 <span class="comment">        the Enum\ branch of the registry.  Can be NULL in which case the key</span>
08183 <span class="comment">        will be opened here.</span>
08184 <span class="comment"></span>
08185 <span class="comment">    InstallDriver - Indicates whether setup should attempt to install a driver</span>
08186 <span class="comment">                    for this object.  Device objects created through</span>
08187 <span class="comment">                    IoReportDetectedDevice() already have a driver but we want</span>
08188 <span class="comment">                    to indicate them to setup anyway.</span>
08189 <span class="comment"></span>
08190 <span class="comment">Return Value:</span>
08191 <span class="comment"></span>
08192 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
08193 <span class="comment"></span>
08194 <span class="comment">Note:</span>
08195 <span class="comment"></span>
08196 <span class="comment">    The contents of the notification structure *including* all pointers is only</span>
08197 <span class="comment">    valid during the callback routine to which it was passed.  If the data is</span>
08198 <span class="comment">    required after the duration of the callback then it must be physically copied</span>
08199 <span class="comment">    by the callback routine.</span>
08200 <span class="comment"></span>
08201 <span class="comment">--*/</span>
08202 
08203 {
08204     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08205 
08206     <span class="comment">//</span>
08207     <span class="comment">// Only perform notifications if someone has registered</span>
08208     <span class="comment">//</span>
08209 
08210     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>) {
08211 
08212         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08213         <a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html">SETUP_DEVICE_ARRIVAL_NOTIFICATION</a> notification;
08214         <a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html">NOTIFICATION_CALLBACK_PARAM_BLOCK</a> callparams;
08215         ULONG Console=0;
08216         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
08217         HANDLE enumKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08218 
08219         <span class="comment">//</span>
08220         <span class="comment">// Fill in the notification</span>
08221         <span class="comment">//</span>
08222 
08223         <span class="keywordflow">if</span> (!EnumEntryKey) {
08224             status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a24">IopDeviceObjectToDeviceInstance</a>(PhysicalDeviceObject,
08225                                                      &amp;enumKey,
08226                                                      KEY_WRITE);
08227             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08228                 <span class="keywordflow">return</span> status;
08229             }
08230             EnumEntryKey = enumKey;
08231         }
08232 
08233         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o0">Version</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a110">PNP_NOTIFICATION_VERSION</a>;
08234         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o1">Size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html">SETUP_DEVICE_ARRIVAL_NOTIFICATION</a>);
08235         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o2">Event</a> = GUID_SETUP_DEVICE_ARRIVAL;
08236         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o3">PhysicalDeviceObject</a> = PhysicalDeviceObject;
08237         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o4">EnumEntryKey</a> = EnumEntryKey;
08238         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08239         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o5">EnumPath</a> = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
08240         notification.<a class="code" href="../../d4/d2/struct__SETUP__DEVICE__ARRIVAL__NOTIFICATION.html#o6">InstallDriver</a> = InstallDriver;
08241 
08242         <span class="comment">//</span>
08243         <span class="comment">// Reference the notify and call back</span>
08244         <span class="comment">//</span>
08245 
08246         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>=(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o2">Callback</a>);
08247         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>=&amp;notification;
08248         callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>=<a class="code" href="../../d8/d0/pnpioapi_8c.html#a39">IopSetupNotifyData</a>-&gt;<a class="code" href="../../d7/d2/struct__SETUP__NOTIFY__DATA.html#o3">Context</a>;
08249 
08250 
08251         <span class="comment">//</span>
08252         <span class="comment">// Dispatch this function via the memory manager.</span>
08253         <span class="comment">// Win32K is a driver that can have multiple copies. If Hydra</span>
08254         <span class="comment">// is running, the Mem. manager will check if the callback exists</span>
08255         <span class="comment">// in "per session" space. If that is the case, it will attach to the</span>
08256         <span class="comment">// console (hence the 3rd param of PULONG containing 0) session and deliver</span>
08257         <span class="comment">// it. If either Hydra is not running, or the callback is outside session space</span>
08258         <span class="comment">// then the callback is called directly.</span>
08259         <span class="comment">//</span>
08260         status = <a class="code" href="../../d2/d1/mm_8h.html#a197">MmDispatchWin32Callout</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a146">PKWIN32_CALLOUT</a>)callparams.<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>,&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a>,&amp;callparams,&amp;Console);
08261         <span class="keywordflow">if</span> (enumKey) {
08262             ZwClose(enumKey);
08263         }
08264 
08265         <span class="keywordflow">return</span> status;
08266 
08267     } <span class="keywordflow">else</span> {
08268 
08269         <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
08270 
08271     }
08272 }
08273 
08274 BOOLEAN
<a name="l08275"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a110">08275</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a110">IoIsWdmVersionAvailable</a>(
08276     IN UCHAR MajorVersion,
08277     IN UCHAR MinorVersion
08278     )
08279 
08280 <span class="comment">/*++</span>
08281 <span class="comment"></span>
08282 <span class="comment">Routine Description:</span>
08283 <span class="comment"></span>
08284 <span class="comment">    This routine reports whether WDM functionality is available that</span>
08285 <span class="comment">    is greater than or equal to the specified major and minor version.</span>
08286 <span class="comment"></span>
08287 <span class="comment">Parameters:</span>
08288 <span class="comment"></span>
08289 <span class="comment">    MajorVersion - Supplies the WDM major version that is required.</span>
08290 <span class="comment"></span>
08291 <span class="comment">    MinorVersion - Supplies the WDM minor version that is required.</span>
08292 <span class="comment"></span>
08293 <span class="comment">Return Value:</span>
08294 <span class="comment"></span>
08295 <span class="comment">    If WDM support is available at _at least_ the requested level, the</span>
08296 <span class="comment">    return value is TRUE, otherwise it is FALSE.</span>
08297 <span class="comment"></span>
08298 <span class="comment">--*/</span>
08299 
08300 {
08301     <span class="keywordflow">return</span> ((MajorVersion &lt; <a class="code" href="../../d0/d5/io_8h.html#a225">WDM_MAJORVERSION</a>) ||
08302             ((MajorVersion == <a class="code" href="../../d0/d5/io_8h.html#a225">WDM_MAJORVERSION</a>) &amp;&amp; (MinorVersion &lt;= <a class="code" href="../../d0/d5/io_8h.html#a226">WDM_MINORVERSION</a>)));
08303 }
08304 
08305 <a class="code" href="../../d0/d9/ntosdef_8h.html#a29">NTKERNELAPI</a>
08306 <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a>
<a name="l08307"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a111">08307</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a111">IoGetDmaAdapter</a>(
08308     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject    OPTIONAL,
08309     IN <a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html">PDEVICE_DESCRIPTION</a> DeviceDescription,
08310     IN OUT PULONG NumberOfMapRegisters
08311     )
08312 <span class="comment">/*++</span>
08313 <span class="comment"></span>
08314 <span class="comment">Routine Description:</span>
08315 <span class="comment"></span>
08316 <span class="comment">    This function returns the appropriate DMA adapter object for the device</span>
08317 <span class="comment">    defined in the device description structure.  This code is a wrapper</span>
08318 <span class="comment">    which queries the bus interface standard and then calls the returned</span>
08319 <span class="comment">    get DMA adapter function.   If an adapter object was not retrieved then</span>
08320 <span class="comment">    a legecy function is attempted.</span>
08321 <span class="comment"></span>
08322 <span class="comment">Arguments:</span>
08323 <span class="comment"></span>
08324 <span class="comment">    PhysicalDeviceObject - Optionally, supplies the PDO for the device</span>
08325 <span class="comment">        requesting the DMA adapter.  If not supplied, this routine performs the</span>
08326 <span class="comment">        function of the non-PnP HalGetDmaAdapter routine.</span>
08327 <span class="comment"></span>
08328 <span class="comment">    DeviceDescriptor - Supplies a description of the deivce.</span>
08329 <span class="comment"></span>
08330 <span class="comment">    NumberOfMapRegisters - Returns the maximum number of map registers which</span>
08331 <span class="comment">        may be allocated by the device driver.</span>
08332 <span class="comment"></span>
08333 <span class="comment">Return Value:</span>
08334 <span class="comment"></span>
08335 <span class="comment">    A pointer to the requested adapter object or NULL if an adapter could not</span>
08336 <span class="comment">    be created.</span>
08337 <span class="comment"></span>
08338 <span class="comment">--*/</span>
08339 
08340 {
08341     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> event;
08342     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08343     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
08344     IO_STATUS_BLOCK ioStatusBlock;
08345     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpStack;
08346     <a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html">BUS_INTERFACE_STANDARD</a> busInterface;
08347     <a class="code" href="../../d7/d6/struct__DMA__ADAPTER.html">PDMA_ADAPTER</a> dmaAdapter = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08348     <a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html">PDEVICE_DESCRIPTION</a> deviceDescriptionToUse;
08349     <a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html">DEVICE_DESCRIPTION</a> privateDeviceDescription;
08350     ULONG resultLength;
08351     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
08352 
08353     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08354 
08355     <span class="keywordflow">if</span> (PhysicalDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08356 
08357         <a class="code" href="../../d9/d0/pnpiop_8h.html#a4">ASSERT_PDO</a>(PhysicalDeviceObject);
08358 
08359         <span class="comment">//</span>
08360         <span class="comment">// First off, determine whether or not the caller has requested that we</span>
08361         <span class="comment">// automatically fill in the proper InterfaceType value into the</span>
08362         <span class="comment">// DEVICE_DESCRIPTION structure used in retrieving the DMA adapter object.</span>
08363         <span class="comment">// If so, then retrieve that interface type value into our own copy of</span>
08364         <span class="comment">// the DEVICE_DESCRIPTION buffer.</span>
08365         <span class="comment">//</span>
08366         <span class="keywordflow">if</span> ((DeviceDescription-&gt;InterfaceType == InterfaceTypeUndefined) ||
08367             (DeviceDescription-&gt;InterfaceType == PNPBus)) {
08368             <span class="comment">//</span>
08369             <span class="comment">// Make a copy of the caller-supplied device description, so</span>
08370             <span class="comment">// we can modify it to fill in the correct interface type.</span>
08371             <span class="comment">//</span>
08372             RtlCopyMemory(&amp;privateDeviceDescription,
08373                           DeviceDescription,
08374                           <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html">DEVICE_DESCRIPTION</a>)
08375                          );
08376 
08377             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>(PhysicalDeviceObject,
08378                                          <a class="code" href="../../d6/d9/pnp_8h.html#a170a96">DevicePropertyLegacyBusType</a>,
08379                                          <span class="keyword">sizeof</span>(privateDeviceDescription.<a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html#o11">InterfaceType</a>),
08380                                          (PVOID)&amp;(privateDeviceDescription.<a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html#o11">InterfaceType</a>),
08381                                          &amp;resultLength
08382                                         );
08383 
08384             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08385 
08386                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_OBJECT_NAME_NOT_FOUND);
08387 
08388                 <span class="comment">//</span>
08389                 <span class="comment">// Since the enumerator didn't tell us what interface type to</span>
08390                 <span class="comment">// use for this PDO, we'll fall back to our default.  This is</span>
08391                 <span class="comment">// ISA for machines where the legacy bus is ISA or EISA, and it</span>
08392                 <span class="comment">// is MCA for machines whose legacy bus is MicroChannel.</span>
08393                 <span class="comment">//</span>
08394                 privateDeviceDescription.<a class="code" href="../../d7/d3/struct__DEVICE__DESCRIPTION.html#o11">InterfaceType</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
08395             }
08396 
08397             <span class="comment">//</span>
08398             <span class="comment">// Use our private device description buffer from now on.</span>
08399             <span class="comment">//</span>
08400             deviceDescriptionToUse = &amp;privateDeviceDescription;
08401 
08402         } <span class="keywordflow">else</span> {
08403             <span class="comment">//</span>
08404             <span class="comment">// Use the caller-supplied device description.</span>
08405             <span class="comment">//</span>
08406             deviceDescriptionToUse = DeviceDescription;
08407         }
08408 
08409         <span class="comment">//</span>
08410         <span class="comment">// Now, query for the BUS_INTERFACE_STANDARD interface from the PDO.</span>
08411         <span class="comment">//</span>
08412         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;event, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
08413 
08414         targetDevice = <a class="code" href="../../d4/d6/iosubs_8c.html#a67">IoGetAttachedDeviceReference</a>(PhysicalDeviceObject);
08415 
08416         irp = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a>,
08417                                             targetDevice,
08418                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
08419                                             0,
08420                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
08421                                             &amp;event,
08422                                             &amp;ioStatusBlock );
08423 
08424         <span class="keywordflow">if</span> (irp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08425             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08426         }
08427 
08428         RtlZeroMemory( &amp;busInterface, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html">BUS_INTERFACE_STANDARD</a> ));
08429 
08430         irpStack = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
08431         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> = <a class="code" href="../../d0/d5/io_8h.html#a73">IRP_MN_QUERY_INTERFACE</a>;
08432         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceType = (LPGUID) &amp;GUID_BUS_INTERFACE_STANDARD;
08433         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Size = <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d9/pnp_8h.html#a22">BUS_INTERFACE_STANDARD</a> );
08434         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Version = 1;
08435         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.Interface = (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a>) &amp;busInterface;
08436         irpStack-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryInterface.InterfaceSpecificData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08437 
08438         <span class="comment">//</span>
08439         <span class="comment">// Initialize the status to error in case the ACPI driver decides not to</span>
08440         <span class="comment">// set it correctly.</span>
08441         <span class="comment">//</span>
08442 
08443         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_NOT_SUPPORTED;
08444 
08445         status = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(targetDevice, irp);
08446 
08447         <span class="keywordflow">if</span> (status == STATUS_PENDING) {
08448 
08449             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;event, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
08450             status = ioStatusBlock.Status;
08451 
08452         }
08453 
08454         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(targetDevice);
08455 
08456         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status)) {
08457 
08458             <span class="keywordflow">if</span> (busInterface.<a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html#o6">GetDmaAdapter</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08459 
08460 
08461                 dmaAdapter = busInterface.<a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html#o6">GetDmaAdapter</a>( busInterface.<a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html#o2">Context</a>,
08462                                                          deviceDescriptionToUse,
08463                                                          NumberOfMapRegisters );
08464 
08465             }
08466 
08467             <span class="comment">//</span>
08468             <span class="comment">// Dereference the interface</span>
08469             <span class="comment">//</span>
08470 
08471             busInterface.<a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html#o4">InterfaceDereference</a>( busInterface.<a class="code" href="../../d7/d5/struct__BUS__INTERFACE__STANDARD.html#o2">Context</a> );
08472         }
08473 
08474     } <span class="keywordflow">else</span> {
08475         <span class="comment">//</span>
08476         <span class="comment">// The caller didn't specify the PDO, so we'll just use the device</span>
08477         <span class="comment">// description exactly as they specified it (i.e., we can't attempt to</span>
08478         <span class="comment">// make our own determination of what interface type to use).</span>
08479         <span class="comment">//</span>
08480         deviceDescriptionToUse = DeviceDescription;
08481     }
08482 
08483 <span class="preprocessor">#if !defined(NO_LEGACY_DRIVERS)</span>
08484 <span class="preprocessor"></span>    <span class="comment">//</span>
08485     <span class="comment">// If there is no DMA adapter, try the legacy mode code.</span>
08486     <span class="comment">//</span>
08487 
08488     <span class="keywordflow">if</span> (dmaAdapter == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08489 
08490         dmaAdapter = <a class="code" href="../../d2/d7/hal_8h.html#a33">HalGetDmaAdapter</a>( PhysicalDeviceObject,
08491                                        deviceDescriptionToUse,
08492                                        NumberOfMapRegisters );
08493 
08494     }
08495 <span class="preprocessor">#endif // NO_LEGACY_DRIVERS</span>
08496 <span class="preprocessor"></span>
08497     <span class="keywordflow">return</span>( dmaAdapter );
08498 }
08499 
08500 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08501"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a304">08501</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a304">IopOpenDeviceParametersSubkey</a>(
08502     OUT HANDLE *ParamKeyHandle,
08503     IN  HANDLE ParentKeyHandle,
08504     IN  PUNICODE_STRING SubKeyString,
08505     IN  ACCESS_MASK DesiredAccess
08506     )
08507 
08508 <span class="comment">/*++</span>
08509 <span class="comment"></span>
08510 <span class="comment">Routine Description:</span>
08511 <span class="comment"></span>
08512 <span class="comment">    This routine reports whether WDM functionality is available that</span>
08513 <span class="comment">    is greater than or equal to the specified major and minor version.</span>
08514 <span class="comment"></span>
08515 <span class="comment">Parameters:</span>
08516 <span class="comment"></span>
08517 <span class="comment">    MajorVersion - Supplies the WDM major version that is required.</span>
08518 <span class="comment"></span>
08519 <span class="comment">    MinorVersion - Supplies the WDM minor version that is required.</span>
08520 <span class="comment"></span>
08521 <span class="comment">Return Value:</span>
08522 <span class="comment"></span>
08523 <span class="comment">    If WDM support is available at _at least_ the requested level, the</span>
08524 <span class="comment">    return value is TRUE, otherwise it is FALSE.</span>
08525 <span class="comment"></span>
08526 <span class="comment">--*/</span>
08527 
08528 {
08529     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    status;
08530     ULONG                       disposition;
08531     ULONG                       lengthSD;
08532     PSECURITY_DESCRIPTOR        oldSD = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08533     SECURITY_DESCRIPTOR         newSD;
08534     ACL_SIZE_INFORMATION        aclSizeInfo;
08535     PACL                        oldDacl;
08536     PACL                        newDacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08537     ULONG                       sizeDacl;
08538     BOOLEAN                     daclPresent, daclDefaulted;
08539     PACCESS_ALLOWED_ACE         ace;
08540     ULONG                       aceIndex;
08541     HANDLE                      deviceKeyHandle;
08542     UNICODE_STRING              deviceParamString;
08543 
08544     <span class="comment">//</span>
08545     <span class="comment">// First try and open the device key</span>
08546     <span class="comment">//</span>
08547     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;deviceKeyHandle,
08548                                    ParentKeyHandle,
08549                                    SubKeyString,
08550                                    KEY_WRITE
08551                                    );
08552 
08553     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08554         <span class="keywordflow">return</span> status;
08555     }
08556 
08557     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceParamString, REGSTR_KEY_DEVICEPARAMETERS);
08558 
08559     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( ParamKeyHandle,
08560                                      deviceKeyHandle,
08561                                      &amp;deviceParamString,
08562                                      DesiredAccess | READ_CONTROL | WRITE_DAC,
08563                                      REG_OPTION_NON_VOLATILE,
08564                                      &amp;disposition
08565                                      );
08566 
08567     ZwClose(deviceKeyHandle);
08568 
08569     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08570         KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: IopCreateRegistryKeyEx failed, status = %8.8X\n"</span>, status));
08571         <span class="keywordflow">return</span> status;
08572     }
08573 
08574     <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
08575 
08576         <span class="comment">//</span>
08577         <span class="comment">// Need to set an ACL on the key if it was created</span>
08578         <span class="comment">//</span>
08579         <span class="comment">//</span>
08580         <span class="comment">// Get the security descriptor from the key so we can add the</span>
08581         <span class="comment">// administrator.</span>
08582         <span class="comment">//</span>
08583         status = ZwQuerySecurityObject(*ParamKeyHandle,
08584                                        DACL_SECURITY_INFORMATION,
08585                                        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
08586                                        0,
08587                                        &amp;lengthSD);
08588 
08589         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
08590             oldSD = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, lengthSD );
08591 
08592             <span class="keywordflow">if</span> (oldSD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08593 
08594                 status = ZwQuerySecurityObject(*ParamKeyHandle,
08595                                                DACL_SECURITY_INFORMATION,
08596                                                oldSD,
08597                                                lengthSD,
08598                                                &amp;lengthSD);
08599                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08600                     KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwQuerySecurityObject failed, status = %8.8X\n"</span>, status));
08601                     <span class="keywordflow">goto</span> Cleanup0;
08602                 }
08603             } <span class="keywordflow">else</span>  {
08604 
08605                 KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: Failed to allocate memory, status = %8.8X\n"</span>, status));
08606                 status = STATUS_NO_MEMORY;
08607                 <span class="keywordflow">goto</span> Cleanup0;
08608             }
08609         } <span class="keywordflow">else</span> {
08610            KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwQuerySecurityObject failed %8.8X\n"</span>,status));
08611            status = STATUS_UNSUCCESSFUL;
08612            <span class="keywordflow">goto</span> Cleanup0;
08613         }
08614 
08615         status = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
08616                                               SECURITY_DESCRIPTOR_REVISION );
08617         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
08618 
08619         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08620 
08621             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlCreateSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08622             <span class="keywordflow">goto</span> Cleanup0;
08623         }
08624         <span class="comment">//</span>
08625         <span class="comment">// get the current DACL</span>
08626         <span class="comment">//</span>
08627         status = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>(oldSD, &amp;daclPresent, &amp;oldDacl, &amp;daclDefaulted);
08628 
08629         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
08630 
08631         <span class="comment">//</span>
08632         <span class="comment">// calculate the size of the new DACL</span>
08633         <span class="comment">//</span>
08634 
08635         <span class="keywordflow">if</span> (daclPresent) {
08636 
08637             status = <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a>( oldDacl,
08638                                              &amp;aclSizeInfo,
08639                                              <span class="keyword">sizeof</span>(ACL_SIZE_INFORMATION),
08640                                              AclSizeInformation);
08641 
08642 
08643             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08644 
08645                 KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlQueryInformationAcl failed, status = %8.8X\n"</span>, status));
08646                 <span class="keywordflow">goto</span> Cleanup0;
08647             }
08648 
08649             sizeDacl = aclSizeInfo.AclBytesInUse;
08650         } <span class="keywordflow">else</span> {
08651             sizeDacl = <span class="keyword">sizeof</span>(ACL);
08652         }
08653 
08654         sizeDacl += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE) + <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(<a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>) - <span class="keyword">sizeof</span>(ULONG);
08655 
08656         <span class="comment">//</span>
08657         <span class="comment">// create and initialize the new DACL</span>
08658         <span class="comment">//</span>
08659         newDacl = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, sizeDacl);
08660 
08661         <span class="keywordflow">if</span> (newDacl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08662 
08663             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ExAllocatePool failed\n"</span>));
08664             <span class="keywordflow">goto</span> Cleanup0;
08665         }
08666 
08667         status = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(newDacl, sizeDacl, ACL_REVISION);
08668 
08669         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08670 
08671             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlCreateAcl failed, status = %8.8X\n"</span>, status));
08672             <span class="keywordflow">goto</span> Cleanup0;
08673         }
08674 
08675         <span class="comment">//</span>
08676         <span class="comment">// copy the current (original) DACL into this new one</span>
08677         <span class="comment">//</span>
08678         <span class="keywordflow">if</span> (daclPresent) {
08679 
08680             <span class="keywordflow">for</span> (aceIndex = 0; aceIndex &lt; aclSizeInfo.AceCount; aceIndex++) {
08681 
08682                 status = <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a>(oldDacl, aceIndex, (PVOID *)&amp;ace);
08683 
08684                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08685 
08686                     KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlGetAce failed, status = %8.8X\n"</span>, status));
08687                     <span class="keywordflow">goto</span> Cleanup0;
08688                 }
08689 
08690                 <span class="comment">//</span>
08691                 <span class="comment">// We need to skip copying any ACEs which refer to the Administrator</span>
08692                 <span class="comment">// to ensure that our full control ACE is the one and only.</span>
08693                 <span class="comment">//</span>
08694                 <span class="keywordflow">if</span> ((ace-&gt;Header.AceType != ACCESS_ALLOWED_ACE_TYPE &amp;&amp;
08695                      ace-&gt;Header.AceType != ACCESS_DENIED_ACE_TYPE) ||
08696                      !<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>((PSID)&amp;ace-&gt;SidStart, <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>)) {
08697 
08698                     status = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>( newDacl,
08699                                         ACL_REVISION,
08700                                         ~0U,
08701                                         ace,
08702                                         ace-&gt;Header.AceSize
08703                                         );
08704 
08705                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08706 
08707                         KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlAddAce failed, status = %8.8X\n"</span>, status));
08708                         <span class="keywordflow">goto</span> Cleanup0;
08709                     }
08710                 }
08711             }
08712         }
08713 
08714         <span class="comment">//</span>
08715         <span class="comment">// and my new admin-full ace to this new DACL</span>
08716         <span class="comment">//</span>
08717         status = <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a>( newDacl,
08718                                            ACL_REVISION,
08719                                            CONTAINER_INHERIT_ACE,
08720                                            KEY_ALL_ACCESS,
08721                                            <a class="code" href="../../d0/d5/se_8h.html#a56">SeAliasAdminsSid</a>
08722                                            );
08723         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08724 
08725             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlAddAccessAllowedAceEx failed, status = %8.8X\n"</span>, status));
08726             <span class="keywordflow">goto</span> Cleanup0;
08727         }
08728 
08729         <span class="comment">//</span>
08730         <span class="comment">// Set the new DACL in the absolute security descriptor</span>
08731         <span class="comment">//</span>
08732         status = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>( (PSECURITY_DESCRIPTOR) &amp;newSD,
08733                                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
08734                                                newDacl,
08735                                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
08736                                                );
08737 
08738         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08739 
08740             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlSetDaclSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08741             <span class="keywordflow">goto</span> Cleanup0;
08742         }
08743 
08744         <span class="comment">//</span>
08745         <span class="comment">// validate the new security descriptor</span>
08746         <span class="comment">//</span>
08747         status = <a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a>(&amp;newSD);
08748 
08749         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08750 
08751             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: RtlValidSecurityDescriptor failed, status = %8.8X\n"</span>, status));
08752             <span class="keywordflow">goto</span> Cleanup0;
08753         }
08754 
08755 
08756         status = ZwSetSecurityObject( *ParamKeyHandle,
08757                                       DACL_SECURITY_INFORMATION,
08758                                       &amp;newSD
08759                                       );
08760         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08761 
08762             KdPrint((<span class="stringliteral">"IopOpenDeviceParametersSubkey: ZwSetSecurityObject failed, status = %8.8X\n"</span>, status));
08763             <span class="keywordflow">goto</span> Cleanup0;
08764         }
08765     }
08766 
08767     <span class="comment">//</span>
08768     <span class="comment">// If we encounter an error updating the DACL we still return success.</span>
08769     <span class="comment">//</span>
08770 
08771 Cleanup0:
08772 
08773     <span class="keywordflow">if</span> (oldSD != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08774         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(oldSD);
08775     }
08776 
08777     <span class="keywordflow">if</span> (newDacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08778         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newDacl);
08779     }
08780 
08781     <span class="keywordflow">return</span> STATUS_SUCCESS;
08782 }
08783 
08784 <span class="preprocessor">#if 0</span>
08785 <span class="preprocessor"></span>
08786 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
08787 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a55">IopSetupDeviceObjectFromDeviceClass</a>(
08788     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject,
08789     IN HANDLE DeviceClassKey
08790     )
08791 <span class="comment">/*++</span>
08792 <span class="comment"></span>
08793 <span class="comment">Routine Description:</span>
08794 <span class="comment"></span>
08795 <span class="comment">    This routine will migrate device object settings from the device class</span>
08796 <span class="comment">    key in the registry to the physical device object.  The possible settings</span>
08797 <span class="comment">    are:</span>
08798 <span class="comment"></span>
08799 <span class="comment">        * DeviceType - the I/O system type for the device object</span>
08800 <span class="comment">        * DeviceCharacteristics - the I/O system characteristic flags to be</span>
08801 <span class="comment">                                  set for the device object</span>
08802 <span class="comment">        * DefaultAcl - the default ACL for the device object.  This can be</span>
08803 <span class="comment">                       overridden by setting a device specific ACL in the</span>
08804 <span class="comment">                       device node in the registry.</span>
08805 <span class="comment"></span>
08806 <span class="comment">    The routine will then use the DeviceType and DeviceCharacteristics specified</span>
08807 <span class="comment">    to determine whether a VPB should be allocated as well as to set default</span>
08808 <span class="comment">    security if none is specified in the registry.</span>
08809 <span class="comment"></span>
08810 <span class="comment">Arguments:</span>
08811 <span class="comment"></span>
08812 <span class="comment">    PhysicalDeviceObject - the PDO we are to configure</span>
08813 <span class="comment"></span>
08814 <span class="comment">    DeviceClassKey - a handle to the this particular device class's information</span>
08815 <span class="comment">                     in the Control\DeviceClasses section of the registry.</span>
08816 <span class="comment"></span>
08817 <span class="comment">Return Value:</span>
08818 <span class="comment"></span>
08819 <span class="comment">    status</span>
08820 <span class="comment"></span>
08821 <span class="comment">--*/</span>
08822 
08823 {
08824     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> topOfStack = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(PhysicalDeviceObject);
08825     UNICODE_STRING valueName;
08826 
08827     DEVICE_TYPE deviceType = PhysicalDeviceObject-&gt;DeviceType;
08828     ULONG characteristics = PhysicalDeviceObject-&gt;Characteristics;
08829 
08830     BOOLEAN deviceTypeChanged;
08831 
08832     PKEY_VALUE_FULL_INFORMATION info;
08833     PUCHAR data;
08834 
08835     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08836 
08837     <span class="comment">//</span>
08838     <span class="comment">// First read from the registry to find the device type and characteristics</span>
08839     <span class="comment">// values.</span>
08840     <span class="comment">//</span>
08841 
08842     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_TYPE);
08843     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceClassKey,
08844                                  valueName.Buffer,
08845                                  &amp;info);
08846 
08847     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08848         data = ((PUCHAR) info) + info-&gt;DataOffset;
08849         deviceType = *((PULONG) data);
08850         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
08851     }
08852 
08853     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_CHARACTERISTICS);
08854     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(DeviceClassKey,
08855                                  valueName.Buffer,
08856                                  &amp;info);
08857 
08858     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08859         data = ((PUCHAR) info) + info-&gt;DataOffset;
08860         characteristics = *((PULONG) data);
08861 
08862         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(info);
08863     }
08864 
08865     <span class="comment">//</span>
08866     <span class="comment">// Assign the device type to the PDO and OR in the characteristics bits</span>
08867     <span class="comment">// with the ones already set.</span>
08868     <span class="comment">//</span>
08869 
08870     <span class="comment">//</span>
08871     <span class="comment">// Make sure no one registered for two incompatible device classes.</span>
08872     <span class="comment">//</span>
08873 
08874     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PhysicalDeviceObject-&gt;DeviceType == FILE_DEVICE_PNP_WITH_INTERFACE) ||
08875            (PhysicalDeviceObject-&gt;DeviceType == deviceType));
08876 
08877     <span class="keywordflow">if</span>(PhysicalDeviceObject-&gt;DeviceType != deviceType) {
08878         deviceTypeChanged = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
08879     }
08880 
08881     PhysicalDeviceObject-&gt;DeviceType = deviceType;
08882     PhysicalDeviceObject-&gt;Characteristics |= characteristics;
08883 
08884     <span class="comment">//</span>
08885     <span class="comment">// Propagate the device type to the top of the stack too.</span>
08886     <span class="comment">//</span>
08887 
08888     topOfStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> = deviceType;
08889     topOfStack-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> |= characteristics;
08890 
08891     <span class="comment">//</span>
08892     <span class="comment">// Setup security on the PDO now if the device type was changed.</span>
08893     <span class="comment">//</span>
08894 
08895     <span class="keywordflow">if</span>(deviceTypeChanged) {
08896 
08897         status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a56">IopSetSecurityObjectFromRegistry</a>(PhysicalDeviceObject,
08898                                                   DeviceClassKey);
08899 
08900         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08901 
08902             BOOLEAN hasName;
08903             <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> buffer[SECURITY_DESCRIPTOR_MIN_LENGTH];
08904             PSECURITY_DESCRIPTOR securityDescriptor;
08905             SECURITY_INFORMATION securityInformation = 0;
08906 
08907             <span class="comment">//</span>
08908             <span class="comment">// Security couldn't be set from the registry.  Build the default</span>
08909             <span class="comment">// security descriptor for this object and we'll set that instead.</span>
08910             <span class="comment">//</span>
08911 
08912             hasName = ((PhysicalDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a127">DO_DEVICE_HAS_NAME</a>) ==
08913                        <a class="code" href="../../d0/d5/io_8h.html#a127">DO_DEVICE_HAS_NAME</a>);
08914 
08915             securityDescriptor =
08916                 <a class="code" href="../../d4/d6/iosubs_8c.html#a127">IopCreateDefaultDeviceSecurityDescriptor</a>(
08917                     deviceType,
08918                     PhysicalDeviceObject-&gt;Characteristics,
08919                     hasName,
08920                     buffer,
08921                     &amp;securityInformation
08922                     );
08923 
08924             <span class="keywordflow">if</span>(securityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08925 
08926                 SECURITY_INFORMATION securityInformation = 0;
08927 
08928 
08929                 status = <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a>(PhysicalDeviceObject,
08930                                                       securityInformation,
08931                                                       securityDescriptor);
08932             }
08933         }
08934 
08935         <span class="comment">//</span>
08936         <span class="comment">// If the device is a mass storage type device then we should mark</span>
08937         <span class="comment">// it for VPB allocation later on down the line.</span>
08938         <span class="comment">//</span>
08939 
08940         <span class="keywordflow">if</span>((deviceType == FILE_DEVICE_DISK) ||
08941            (deviceType == FILE_DEVICE_CD_ROM) ||
08942            (deviceType == FILE_DEVICE_TAPE) ||
08943            (deviceType == FILE_DEVICE_VIRTUAL_DISK)) {
08944 
08945             <a class="code" href="../../d4/d6/iosubs_8c.html#a44">IopCreateVpb</a>(PhysicalDeviceObject);
08946             <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;PhysicalDeviceObject-&gt;DeviceLock,
08947                                SynchronizationEvent,
08948                                TRUE );
08949             <a class="code" href="../../d1/d2/po_8h.html#a70">PoVolumeDevice</a>(PhysicalDeviceObject);
08950         }
08951     }
08952 
08953     <span class="keywordflow">return</span> status;
08954 }
08955 <span class="preprocessor">#endif</span>
08956 <span class="preprocessor"></span>
08957 
08958 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l08959"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a56">08959</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a56">IopSetSecurityObjectFromRegistry</a>(
08960     IN PVOID Object,
08961     IN HANDLE Key
08962     )
08963 <span class="comment">/*++</span>
08964 <span class="comment"></span>
08965 <span class="comment">Routine Description:</span>
08966 <span class="comment"></span>
08967 <span class="comment">    This routine will read in the security information stored in the specified</span>
08968 <span class="comment">    registry key and assign that security to the specified object.  If the</span>
08969 <span class="comment">    registry key contains a SecurityDescriptor value it will be validated and</span>
08970 <span class="comment">    assigned to the object if valid.</span>
08971 <span class="comment"></span>
08972 <span class="comment">Arguments:</span>
08973 <span class="comment"></span>
08974 <span class="comment">    Object - the object to be secured.</span>
08975 <span class="comment"></span>
08976 <span class="comment">    Key - the registry key these values are saved in.</span>
08977 <span class="comment"></span>
08978 <span class="comment">Return Value:</span>
08979 <span class="comment"></span>
08980 <span class="comment">    status</span>
08981 <span class="comment"></span>
08982 <span class="comment">--*/</span>
08983 
08984 {
08985     UNICODE_STRING valueName;
08986 
08987     PKEY_VALUE_FULL_INFORMATION info = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08988 
08989     PSECURITY_DESCRIPTOR descriptor;
08990     PSECURITY_DESCRIPTOR capturedDescriptor;
08991 
08992     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
08993 
08994     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;valueName, REGSTR_VAL_DEVICE_SECURITY_DESCRIPTOR);
08995 
08996     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
08997                                  valueName.Buffer,
08998                                  &amp;info);
08999 
09000     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09001         <span class="keywordflow">return</span> status;
09002     }
09003 
09004     descriptor = (((PUCHAR) info) + info-&gt;DataOffset);
09005 
09006     status = <a class="code" href="../../d2/d5/se_2capture_8c.html#a1">SeCaptureSecurityDescriptor</a>(descriptor,
09007                                          <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
09008                                          <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
09009                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
09010                                          &amp;capturedDescriptor);
09011 
09012     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(descriptor);
09013 
09014     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09015         <span class="keywordflow">return</span> status;
09016     }
09017 
09018     <span class="keywordflow">try</span> {
09019 
09020         SECURITY_INFORMATION securityInformation;
09021 
09022         PSID sid;
09023         PACL acl;
09024         BOOLEAN present, tmp;
09025 
09026         RtlZeroMemory(&amp;securityInformation, <span class="keyword">sizeof</span>(securityInformation));
09027 
09028         <span class="comment">//</span>
09029         <span class="comment">// See what information is in the captured descriptor so we can build</span>
09030         <span class="comment">// up a securityInformation block to go with it.</span>
09031         <span class="comment">//</span>
09032 
09033         status = <a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a>(capturedDescriptor, &amp;sid, &amp;tmp);
09034 
09035         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (sid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
09036             securityInformation |= OWNER_SECURITY_INFORMATION;
09037         }
09038 
09039         status = <a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a>(capturedDescriptor, &amp;sid, &amp;tmp);
09040 
09041         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (sid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
09042             securityInformation |= GROUP_SECURITY_INFORMATION;
09043         }
09044 
09045         status = <a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a>(capturedDescriptor,
09046                                               &amp;present,
09047                                               &amp;acl,
09048                                               &amp;tmp);
09049 
09050         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (present)) {
09051             securityInformation |= SACL_SECURITY_INFORMATION;
09052         }
09053 
09054         status = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>(capturedDescriptor,
09055                                               &amp;present,
09056                                               &amp;acl,
09057                                               &amp;tmp);
09058 
09059         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (present)) {
09060             securityInformation |= DACL_SECURITY_INFORMATION;
09061         }
09062 
09063         status = <a class="code" href="../../d9/d1/obse_8c.html#a1">ObSetSecurityObjectByPointer</a>(Object,
09064                                               securityInformation,
09065                                               capturedDescriptor);
09066     } finally {
09067         <a class="code" href="../../d2/d5/se_2capture_8c.html#a2">SeReleaseSecurityDescriptor</a>(capturedDescriptor,
09068                                     <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
09069                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09070     }
09071 
09072     <span class="keywordflow">return</span> status;
09073 }
09074 
09075 
09076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09077"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a73">09077</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a73">PpCreateLegacyDeviceIds</a>(
09078     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject,
09079     IN PUNICODE_STRING DriverName,
09080     IN PCM_RESOURCE_LIST Resources
09081     )
09082 {
09083     <a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">PIOPNP_DEVICE_EXTENSION</a> deviceExtension = DeviceObject-&gt;DeviceExtension;
09084     PWCHAR buffer;
09085 
09086     ULONG length = 0;
09087 
09088     INTERFACE_TYPE interface;
09089     PWCHAR interfaceNames[] ={<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
09090                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Internal"</span>,
09091                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Isa"</span>,
09092                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Eisa"</span>,
09093                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MicroChannel"</span>,
09094                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TurboChannel"</span>,
09095                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCIBus"</span>,
09096                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"VMEBus"</span>,
09097                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"NuBus"</span>,
09098                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PCMCIABus"</span>,
09099                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"CBus"</span>,
09100                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MPIBus"</span>,
09101                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"MPSABus"</span>,
09102                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ProcessorInternal"</span>,
09103                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"InternalPowerBus"</span>,
09104                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PNPISABus"</span>,
09105                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"PNPBus"</span>,
09106                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Other"</span>,
09107                               <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Root"</span>};
09108 
09109 
09110      <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09111 
09112     <span class="keywordflow">if</span>(Resources != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09113 
09114         interface = Resources-&gt;List[0].InterfaceType;
09115 
09116         <span class="keywordflow">if</span>((interface &gt; MaximumInterfaceType) ||
09117            (interface &lt; InterfaceTypeUndefined)) {
09118             interface = MaximumInterfaceType;
09119         }
09120     } <span class="keywordflow">else</span> {
09121         interface = Internal;
09122     }
09123 
09124     interface++;
09125 
09126     <span class="comment">//</span>
09127     <span class="comment">// The compatible ID generated will be</span>
09128     <span class="comment">// DETECTED&lt;InterfaceName&gt;&lt;Driver Name&gt;</span>
09129     <span class="comment">//</span>
09130 
09131     length = wcslen(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a26">LEGACY_COMPATIBLE_ID_BASE</a>) * <span class="keyword">sizeof</span>(WCHAR);
09132     length += wcslen(interfaceNames[interface]) * <span class="keyword">sizeof</span>(WCHAR);
09133     length += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
09134     length += DriverName-&gt;Length;
09135     length += <span class="keyword">sizeof</span>(UNICODE_NULL);
09136 
09137     length += wcslen(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a26">LEGACY_COMPATIBLE_ID_BASE</a>) * <span class="keyword">sizeof</span>(WCHAR);
09138     length += <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
09139     length += DriverName-&gt;Length;
09140     length += <span class="keyword">sizeof</span>(UNICODE_NULL) * 2;
09141 
09142     buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, length);
09143     deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o0">CompatibleIdList</a> = buffer;
09144 
09145     <span class="keywordflow">if</span>(buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09146         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
09147     }
09148 
09149     RtlZeroMemory(buffer, length);
09150 
09151     swprintf(buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws%ws\\%wZ"</span>, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a26">LEGACY_COMPATIBLE_ID_BASE</a>,
09152                                      interfaceNames[interface],
09153                                      DriverName);
09154 
09155     <span class="comment">//</span>
09156     <span class="comment">// Adjust the buffer to point to the end and generate the second</span>
09157     <span class="comment">// compatible id string.</span>
09158     <span class="comment">//</span>
09159 
09160     buffer += wcslen(buffer) + 1;
09161 
09162     swprintf(buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"%ws\\%wZ"</span>, <a class="code" href="../../d8/d0/pnpioapi_8c.html#a26">LEGACY_COMPATIBLE_ID_BASE</a>, DriverName);
09163 
09164     deviceExtension-&gt;<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html#o1">CompatibleIdListSize</a> = length;
09165 
09166     <span class="keywordflow">return</span> STATUS_SUCCESS;
09167 }
09168 
09169 
09170 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09171"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a113">09171</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a113">IoNotifyPowerOperationVetoed</a>(
09172     IN POWER_ACTION             VetoedPowerOperation,
09173     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>           TargetedDeviceObject    OPTIONAL,
09174     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>           VetoingDeviceObject
09175     )
09176 <span class="comment">/*++</span>
09177 <span class="comment"></span>
09178 <span class="comment">--*/</span>
09179 {
09180     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode, vetoingDeviceNode;
09181     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
09182 
09183     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09184 
09185     <span class="comment">//</span>
09186     <span class="comment">// We have to types of power events, system wide (standby) and device</span>
09187     <span class="comment">// targetted (warm eject). Rather than have two different veto mechanisms,</span>
09188     <span class="comment">// we just retarget the operation against the root device if none is</span>
09189     <span class="comment">// specified (hey, someone's gotta represent the system, right?).</span>
09190     <span class="comment">//</span>
09191     <span class="keywordflow">if</span> (TargetedDeviceObject) {
09192 
09193         deviceObject = TargetedDeviceObject;
09194 
09195     } <span class="keywordflow">else</span> {
09196 
09197         deviceObject = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
09198     }
09199 
09200     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
09201     <span class="keywordflow">if</span> (!deviceNode) {
09202         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
09203     }
09204 
09205     vetoingDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)VetoingDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
09206     <span class="keywordflow">if</span> (!vetoingDeviceNode) {
09207         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_3;
09208     }
09209 
09210     <span class="keywordflow">return</span> <a class="code" href="../../d6/d9/pnp_8h.html#a168">PpSetPowerVetoEvent</a>(
09211         VetoedPowerOperation,
09212         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09213         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09214         deviceObject,
09215         PNP_VetoDevice,
09216         &amp;vetoingDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>
09217         );
09218 }
09219 
09220 ULONG
<a name="l09221"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a114">09221</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a114">IoPnPDeliverServicePowerNotification</a>(
09222     ULONG   PwrNotification,
09223     BOOLEAN Synchronous
09224     )
09225 {
09226 
09227     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
09228     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> completionEvent;
09229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> completionStatus=STATUS_SUCCESS;
09230     PNP_VETO_TYPE vetoType = PNP_VetoTypeUnknown;
09231     UNICODE_STRING vetoName;
09232 
09233     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09234 
09235 <span class="preprocessor">#define MAX_VETO_NAME_LENGTH    512 //From Revent.c make it common</span>
09236 <span class="preprocessor"></span>
09237     <span class="keywordflow">if</span> (Synchronous) {
09238 
09239 
09240 
09241         vetoName.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,<a class="code" href="../../d8/d0/pnpioapi_8c.html#a30">MAX_VETO_NAME_LENGTH</a>*<span class="keyword">sizeof</span> (WCHAR));
09242 
09243         <span class="keywordflow">if</span> (vetoName.Buffer) {
09244             vetoName.MaximumLength = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a30">MAX_VETO_NAME_LENGTH</a>;
09245         }<span class="keywordflow">else</span> {
09246             vetoName.MaximumLength = 0;
09247         }
09248         vetoName.Length = 0;
09249 
09250         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(&amp;completionEvent, NotificationEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09251 
09252         status = <a class="code" href="../../d6/d9/pnp_8h.html#a165">PpSetPowerEvent</a>(
09253             PwrNotification,
09254             &amp;completionEvent,
09255             &amp;completionStatus,
09256             &amp;vetoType,&amp;vetoName
09257             );
09258 
09259         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
09260 
09261             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;completionEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
09262             status = completionStatus;
09263 
09264             <span class="keywordflow">if</span> (vetoType == PNP_VetoWindowsService) {
09265                 <a class="code" href="../../d4/d6/iosubs_8c.html#a94">IoRaiseInformationalHardError</a> (STATUS_DRIVER_FAILED_SLEEP,&amp;vetoName,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
09266             }
09267 
09268         }
09269         <span class="keywordflow">if</span> (vetoName.Buffer) {
09270             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (vetoName.Buffer);
09271         }
09272 
09273     } <span class="keywordflow">else</span> {
09274         status = <a class="code" href="../../d6/d9/pnp_8h.html#a165">PpSetPowerEvent</a>(
09275             PwrNotification,
09276             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09277             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09278             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09279             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
09280             );
09281     }
09282 
09283     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((completionStatus == STATUS_SUCCESS) ||
09284             (completionStatus == STATUS_UNSUCCESSFUL));
09285     <span class="comment">//</span>
09286     <span class="comment">// The private code in Win32k that calls this, assumes that 0 is failure, !0 is success</span>
09287     <span class="comment">//</span>
09288 
09289     <span class="keywordflow">return</span> (completionStatus != STATUS_UNSUCCESSFUL);
09290 
09291 }
09292 
09293 
09294 <span class="comment">//</span>
09295 <span class="comment">// Release the references to the device object for all the notifications entries</span>
09296 <span class="comment">// of a device object. Then fixup the notification node to not point to a physical</span>
09297 <span class="comment">// device object. The notification node will be released when IoUnregisterPlugPlayNotification</span>
09298 <span class="comment">// is actually called, but the device object will already be gone.</span>
09299 <span class="comment">//</span>
09300 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l09301"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a115">09301</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a385">IopOrphanNotification</a>(
09302     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> TargetNode
09303     )
09304 {
09305     <a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a> entry;
09306     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> lock;
09307 
09308     <a class="code" href="../../d9/d0/pnpiop_8h.html#a107">IopAcquireNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
09309 
09310     <span class="keywordflow">while</span> (!IsListEmpty(&amp;TargetNode-&gt;TargetDeviceNotify)) {
09311         entry = (<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html">PTARGET_DEVICE_NOTIFY_ENTRY</a>)RemoveHeadList(&amp;TargetNode-&gt;TargetDeviceNotify);
09312         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o1">EventCategory</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a172a114">EventCategoryTargetDeviceChange</a>) {
09313 
09314             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a>) {
09315                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a>);
09316                 entry-&gt;<a class="code" href="../../d1/d0/struct__TARGET__DEVICE__NOTIFY__ENTRY.html#o9">PhysicalDeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09317             }
09318         }
09319     }
09320 
09321     <a class="code" href="../../d9/d0/pnpiop_8h.html#a108">IopReleaseNotifyLock</a>(&amp;<a class="code" href="../../d8/d0/pnpioapi_8c.html#a40">IopTargetDeviceNotifyLock</a>);
09322 }
09323 
09324 
09325 <span class="comment">//</span>
09326 <span class="comment">// This is the dispatch routine for plug and play notifications on the</span>
09327 <span class="comment">// "far side" of the memory manager. If this notification is destined for</span>
09328 <span class="comment">// a routine in "session space" the mmgr will have attached us to the session.</span>
09329 <span class="comment">// Otherwise we just dispatch in the context of the system process</span>
09330 <span class="comment">//</span>
09331 
09332 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09333"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">09333</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a57">IopPnPHydraCallback</a> (
09334     PVOID CallbackParams
09335     )
09336 {
09337     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a36">PNOTIFICATION_CALLBACK_PARAM_BLOCK</a> params=(<a class="code" href="../../d8/d0/pnpioapi_8c.html#a36">PNOTIFICATION_CALLBACK_PARAM_BLOCK</a>)CallbackParams;
09338     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
09339 
09340     status = (params-&gt;<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o0">Callout</a>)(params-&gt;<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o1">NotificationStructure</a>,params-&gt;<a class="code" href="../../d7/d3/struct__NOTIFICATION__CALLBACK__PARAM__BLOCK.html#o2">Context</a>);
09341 
09342     <span class="keywordflow">return</span> status;
09343 }
09344 
09345 <span class="comment">//</span>
09346 <span class="comment">// An IO_GET_LEGACY_VETO_LIST_CONTEXT structure.</span>
09347 <span class="comment">//</span>
09348 
<a name="l09349"></a><a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html">09349</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l09350"></a><a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o0">09350</a>     PWSTR *                     VetoList;
<a name="l09351"></a><a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o1">09351</a>     ULONG                       VetoListLength;
<a name="l09352"></a><a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o2">09352</a>     PPNP_VETO_TYPE              VetoType;
<a name="l09353"></a><a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o3">09353</a>     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> *                  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09354 } <a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html">IO_GET_LEGACY_VETO_LIST_CONTEXT</a>, *<a class="code" href="../../d8/d0/pnpioapi_8c.html#a49">PIO_GET_LEGACY_VETO_LIST_CONTEXT</a>;
09355 
09356 BOOLEAN
<a name="l09357"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a116">09357</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a116">IopAppendLegacyVeto</a>(
09358     IN PIO_GET_LEGACY_VETO_LIST_CONTEXT Context,
09359     IN PUNICODE_STRING VetoName
09360     )
09361 <span class="comment">/*++</span>
09362 <span class="comment"></span>
09363 <span class="comment">Routine Description:</span>
09364 <span class="comment"></span>
09365 <span class="comment">    This routine appends a veto (driver name or device instance path) to the</span>
09366 <span class="comment">    veto list.</span>
09367 <span class="comment"></span>
09368 <span class="comment">Parameters:</span>
09369 <span class="comment"></span>
09370 <span class="comment">    Context - An IO_GET_LEGACY_VETO_LIST_CONTEXT pointer.</span>
09371 <span class="comment"></span>
09372 <span class="comment">    VetoName - The name of the driver/device to append to the veto list.</span>
09373 <span class="comment"></span>
09374 <span class="comment">ReturnValue:</span>
09375 <span class="comment"></span>
09376 <span class="comment">    A BOOLEAN which indicates whether the append operation was successful.</span>
09377 <span class="comment"></span>
09378 <span class="comment">--*/</span>
09379 {
09380     ULONG Length;
09381     PWSTR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
09382 
09383     <span class="comment">//</span>
09384     <span class="comment">// Compute the length of the (new) veto list.  This is the length of</span>
09385     <span class="comment">// the old veto list + the size of the new veto + the size of the</span>
09386     <span class="comment">// terminating '\0'.</span>
09387     <span class="comment">//</span>
09388 
09389     Length = Context-&gt;VetoListLength + VetoName-&gt;Length + <span class="keyword">sizeof</span> (WCHAR);
09390 
09391     <span class="comment">//</span>
09392     <span class="comment">// Allocate the new veto list.</span>
09393     <span class="comment">//</span>
09394 
09395     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
09396                  <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
09397                  Length
09398              );
09399 
09400     <span class="comment">//</span>
09401     <span class="comment">// If we succeeded in allocating the new veto list, copy the old</span>
09402     <span class="comment">// veto list to the new list, append the new veto, and finally,</span>
09403     <span class="comment">// append a terminating '\0'.  Otherwise, update the status to</span>
09404     <span class="comment">// indicate an error; IopGetLegacyVetoList will free the veto list</span>
09405     <span class="comment">// before it returns.</span>
09406     <span class="comment">//</span>
09407 
09408     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09409 
09410         <span class="keywordflow">if</span> (*Context-&gt;VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09411 
09412             RtlMoveMemory(
09413                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>,
09414                 *Context-&gt;VetoList,
09415                 Context-&gt;VetoListLength
09416             );
09417 
09418             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*Context-&gt;VetoList);
09419 
09420         }
09421 
09422         RtlMoveMemory(
09423             &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[Context-&gt;VetoListLength / sizeof (WCHAR)],
09424             VetoName-&gt;Buffer,
09425             VetoName-&gt;Length
09426         );
09427 
09428         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[Length / <span class="keyword">sizeof</span> (WCHAR) - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
09429 
09430         *Context-&gt;VetoList = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
09431         Context-&gt;VetoListLength = Length;
09432 
09433         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09434 
09435     } <span class="keywordflow">else</span> {
09436 
09437         *Context-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
09438 
09439         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09440 
09441     }
09442 }
09443 
09444 BOOLEAN
<a name="l09445"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a117">09445</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a117">IopGetLegacyVetoListDevice</a>(
09446     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
09447     IN PIO_GET_LEGACY_VETO_LIST_CONTEXT Context
09448     )
09449 <span class="comment">/*++</span>
09450 <span class="comment"></span>
09451 <span class="comment">Routine Description:</span>
09452 <span class="comment"></span>
09453 <span class="comment">    This routine determines whether the specified device node should be added to</span>
09454 <span class="comment">    the veto list, and if so, calls IopAppendLegacyVeto to add it.</span>
09455 <span class="comment"></span>
09456 <span class="comment">Parameters:</span>
09457 <span class="comment"></span>
09458 <span class="comment">    DeviceNode - The device node to be added.</span>
09459 <span class="comment"></span>
09460 <span class="comment">    Context - An IO_GET_LEGACY_VETO_LIST_CONTEXT pointer.</span>
09461 <span class="comment"></span>
09462 <span class="comment">ReturnValue:</span>
09463 <span class="comment"></span>
09464 <span class="comment">    A BOOLEAN value which indicates whether the device node enumeration</span>
09465 <span class="comment">    process should be terminated or not.</span>
09466 <span class="comment"></span>
09467 <span class="comment">--*/</span>
09468 {
09469     <a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html">PDEVICE_CAPABILITIES</a> DeviceCapabilities;
09470 
09471     <span class="comment">//</span>
09472     <span class="comment">// A device node should be added added to the veto list, if it has the</span>
09473     <span class="comment">// NonDynamic capability.</span>
09474     <span class="comment">//</span>
09475 
09476     DeviceCapabilities = <a class="code" href="../../d9/d0/pnpiop_8h.html#a101">IopDeviceNodeFlagsToCapabilities</a>(DeviceNode);
09477 
09478     <span class="keywordflow">if</span> (DeviceCapabilities-&gt;<a class="code" href="../../d3/d3/struct__DEVICE__CAPABILITIES.html#o17">NonDynamic</a>) {
09479 
09480         <span class="comment">//</span>
09481         <span class="comment">// Update the veto type.  If an error occurrs while adding the device</span>
09482         <span class="comment">// node to the veto list, or the caller did not provide a veto list</span>
09483         <span class="comment">// pointer, terminate the enumeration process now.</span>
09484         <span class="comment">//</span>
09485 
09486         *Context-&gt;VetoType = PNP_VetoLegacyDevice;
09487 
09488         <span class="keywordflow">if</span> (Context-&gt;VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09489 
09490             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/pnpioapi_8c.html#a116">IopAppendLegacyVeto</a>(Context, &amp;DeviceNode-&gt;InstancePath)) {
09491                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09492             }
09493 
09494         } <span class="keywordflow">else</span> {
09495 
09496             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09497 
09498         }
09499 
09500     }
09501 
09502     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09503 }
09504 
09505 BOOLEAN
<a name="l09506"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a118">09506</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a118">IopGetLegacyVetoListDeviceNode</a>(
09507     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
09508     IN PIO_GET_LEGACY_VETO_LIST_CONTEXT Context
09509     )
09510 <span class="comment">/*++</span>
09511 <span class="comment"></span>
09512 <span class="comment">Routine Description:</span>
09513 <span class="comment"></span>
09514 <span class="comment">    This routine recusively walks the device tree, invoking</span>
09515 <span class="comment">    IopGetLegacyVetoListDevice to add device nodes to the veto list</span>
09516 <span class="comment">    (as appropriate).</span>
09517 <span class="comment"></span>
09518 <span class="comment">Parameters:</span>
09519 <span class="comment"></span>
09520 <span class="comment">    DeviceNode - The device node.</span>
09521 <span class="comment"></span>
09522 <span class="comment">    Context - An IO_GET_LEGACY_VETO_LIST_CONTEXT pointer.</span>
09523 <span class="comment"></span>
09524 <span class="comment"></span>
09525 <span class="comment">ReturnValue:</span>
09526 <span class="comment"></span>
09527 <span class="comment">    A BOOLEAN value which indicates whether the device tree enumeration</span>
09528 <span class="comment">    process should be terminated or not.</span>
09529 <span class="comment"></span>
09530 <span class="comment">--*/</span>
09531 {
09532     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Child;
09533 
09534     <span class="comment">//</span>
09535     <span class="comment">// Determine whether the device node should be added to the veto</span>
09536     <span class="comment">// list and add it.  If an operation is unsuccessful or we determine</span>
09537     <span class="comment">// the veto type but the caller doesn't need the veto list, then we</span>
09538     <span class="comment">// terminate our search now.</span>
09539     <span class="comment">//</span>
09540 
09541     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/pnpioapi_8c.html#a117">IopGetLegacyVetoListDevice</a>(DeviceNode, Context)) {
09542         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09543     }
09544 
09545     <span class="comment">//</span>
09546     <span class="comment">// Call ourselves recursively to enumerate our children.  If while</span>
09547     <span class="comment">// enumerating our children we determine we can terminate the search</span>
09548     <span class="comment">// prematurely, do so.</span>
09549     <span class="comment">//</span>
09550 
09551     <span class="keywordflow">for</span> (Child = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
09552          Child != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09553          Child = Child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
09554 
09555         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d0/pnpioapi_8c.html#a118">IopGetLegacyVetoListDeviceNode</a>(Child, Context)) {
09556             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09557         }
09558 
09559     }
09560 
09561     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09562 }
09563 
09564 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l09565"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a119">09565</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a119">IopGetLegacyVetoListDrivers</a>(
09566     IN PIO_GET_LEGACY_VETO_LIST_CONTEXT Context
09567     )
09568 {
09569     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
09570     OBJECT_ATTRIBUTES attributes;
09571     UNICODE_STRING driverString;
09572     POBJECT_DIRECTORY_INFORMATION dirInfo;
09573     HANDLE directoryHandle;
09574     ULONG dirInfoLength, neededLength, dirContext;
09575     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
09576     BOOLEAN restartScan;
09577 
09578     dirInfoLength = 0;
09579     dirInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09580     restartScan = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
09581 
09582     <span class="comment">//</span>
09583     <span class="comment">// Get handle to \\Driver directory</span>
09584     <span class="comment">//</span>
09585 
09586     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;driverString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver"</span>);
09587 
09588     InitializeObjectAttributes(&amp;attributes,
09589                                &amp;driverString,
09590                                OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,
09591                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
09592                                <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
09593                                );
09594 
09595     status = ZwOpenDirectoryObject(&amp;directoryHandle,
09596                                    DIRECTORY_QUERY,
09597                                    &amp;attributes
09598                                    );
09599     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09600         *Context-&gt;Status = status;
09601         <span class="keywordflow">return</span>;
09602     }
09603 
09604     <span class="keywordflow">for</span> (;;) {
09605 
09606         <span class="comment">//</span>
09607         <span class="comment">// Get info on next object in directory.  If the buffer is too</span>
09608         <span class="comment">// small, reallocate it and try again.  Otherwise, any failure</span>
09609         <span class="comment">// including STATUS_NO_MORE_ENTRIES breaks us out.</span>
09610         <span class="comment">//</span>
09611 
09612         status = ZwQueryDirectoryObject(directoryHandle,
09613                                         dirInfo,
09614                                         dirInfoLength,
09615                                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,           <span class="comment">// force one at a time</span>
09616                                         restartScan,
09617                                         &amp;dirContext,
09618                                         &amp;neededLength);
09619         <span class="keywordflow">if</span> (status == STATUS_BUFFER_TOO_SMALL) {
09620             dirInfoLength = neededLength;
09621             <span class="keywordflow">if</span> (dirInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09622                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(dirInfo);
09623             }
09624             dirInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, dirInfoLength);
09625             <span class="keywordflow">if</span> (dirInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09626                 *Context-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
09627                 <span class="keywordflow">break</span>;
09628             }
09629             status = ZwQueryDirectoryObject(directoryHandle,
09630                                             dirInfo,
09631                                             dirInfoLength,
09632                                             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,       <span class="comment">// force one at a time</span>
09633                                             restartScan,
09634                                             &amp;dirContext,
09635                                             &amp;neededLength);
09636         }
09637         restartScan = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
09638 
09639         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09640             <span class="keywordflow">break</span>;
09641         }
09642 
09643         <span class="comment">//</span>
09644         <span class="comment">// Have name of object.  Create object path and use</span>
09645         <span class="comment">// ObReferenceObjectByName() to get DriverObject.  This may</span>
09646         <span class="comment">// fail non-fatally if DriverObject has gone away in the interim.</span>
09647         <span class="comment">//</span>
09648 
09649         driverString.MaximumLength = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\"</span>) +
09650             dirInfo-&gt;Name.Length;
09651         driverString.Length = driverString.MaximumLength - <span class="keyword">sizeof</span>(WCHAR);
09652         driverString.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
09653                                              driverString.MaximumLength);
09654         <span class="keywordflow">if</span> (driverString.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09655             *Context-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
09656             <span class="keywordflow">break</span>;
09657         }
09658 
09659         swprintf(driverString.Buffer, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\Driver\\%ws"</span>, dirInfo-&gt;Name.Buffer);
09660         status = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>(&amp;driverString,
09661                                          OBJ_CASE_INSENSITIVE,
09662                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// access state</span>
09663                                          0,                    <span class="comment">// access mask</span>
09664                                          <a class="code" href="../../d3/d5/iodata_8c.html#a36">IoDriverObjectType</a>,
09665                                          <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
09666                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                 <span class="comment">// parse context</span>
09667                                          &amp;driverObject);
09668 
09669         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(driverString.Buffer);
09670 
09671         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09672             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o0">Type</a> == <a class="code" href="../../d0/d5/io_8h.html#a3">IO_TYPE_DRIVER</a>);
09673             <span class="keywordflow">if</span> (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o3">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a149">DRVO_LEGACY_RESOURCES</a>) {
09674                 <span class="comment">//</span>
09675                 <span class="comment">// Update the veto type.  If the caller provided a</span>
09676                 <span class="comment">// veto list pointer, add the driver to the veto list.</span>
09677                 <span class="comment">// If an error occurs while adding the driver to the</span>
09678                 <span class="comment">// veto list, or the caller did not provide a veto</span>
09679                 <span class="comment">// list pointer, terminate the driver enumeration now.</span>
09680                 <span class="comment">//</span>
09681                 <span class="comment">// NOTE: Driver may be loaded but not running,</span>
09682                 <span class="comment">// distinction is not made here.</span>
09683 
09684 
09685                 *Context-&gt;VetoType = PNP_VetoLegacyDriver;
09686 
09687                 <span class="keywordflow">if</span> (Context-&gt;VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09688                     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a116">IopAppendLegacyVeto</a>(Context, &amp;dirInfo-&gt;Name);
09689                 }
09690             }
09691             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(driverObject);
09692 
09693             <span class="comment">//</span>
09694             <span class="comment">// Early out if we have a veto and the caller didn't want a list or</span>
09695             <span class="comment">// we hit some error already</span>
09696             <span class="comment">//</span>
09697             <span class="keywordflow">if</span> (((*Context-&gt;VetoType == PNP_VetoLegacyDriver) &amp;&amp;
09698                 (Context-&gt;VetoList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) ||
09699                 !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(*Context-&gt;Status)) {
09700                 <span class="keywordflow">break</span>;
09701             }
09702         }
09703     }
09704     <span class="keywordflow">if</span> (dirInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09705         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(dirInfo);
09706     }
09707 
09708     ZwClose(directoryHandle);
09709 }
09710 
09711 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09712"></a><a class="code" href="../../d8/d0/pnpioapi_8c.html#a120">09712</a> <a class="code" href="../../d8/d0/pnpioapi_8c.html#a120">IoGetLegacyVetoList</a>(
09713     OUT PWSTR *VetoList OPTIONAL,
09714     OUT PPNP_VETO_TYPE VetoType
09715     )
09716 <span class="comment">/*++</span>
09717 <span class="comment"></span>
09718 <span class="comment">Routine Description:</span>
09719 <span class="comment"></span>
09720 <span class="comment">    This routine is used by PNP and PO to determine whether legacy drivers and</span>
09721 <span class="comment">    devices are installed in the system.  This routine is conceptually a</span>
09722 <span class="comment">    QUERY_REMOVE_DEVICE and QUERY_POWER-like interface for legacy drivers</span>
09723 <span class="comment">    and devices.</span>
09724 <span class="comment"></span>
09725 <span class="comment">Parameters:</span>
09726 <span class="comment"></span>
09727 <span class="comment">    VetoList - A pointer to a PWSTR. (Optional)  If specified,</span>
09728 <span class="comment">        IoGetLegacyVetoList will allocate a veto list, and return a</span>
09729 <span class="comment">        pointer to the veto list in VetoList.</span>
09730 <span class="comment"></span>
09731 <span class="comment">    VetoType - A pointer to a PNP_VETO_TYPE.  If no legacy drivers</span>
09732 <span class="comment">        or devices are found in the system, VetoType is assigned</span>
09733 <span class="comment">        PNP_VetoTypeUnknown.  If one or more legacy drivers are installed,</span>
09734 <span class="comment">        VetoType is assigned PNP_VetoLegacyDriver.  If one or more</span>
09735 <span class="comment">        legacy devices are installed, VetoType is assigned</span>
09736 <span class="comment">        PNP_VetoLegacyDevice.  VetoType is assigned independent of</span>
09737 <span class="comment">        whether a VetoList is created.</span>
09738 <span class="comment"></span>
09739 <span class="comment">ReturnValue:</span>
09740 <span class="comment"></span>
09741 <span class="comment">    An NTSTATUS value indicating whether the IoGetLegacyVetoList() operation</span>
09742 <span class="comment">    was successful.</span>
09743 <span class="comment"></span>
09744 <span class="comment">--*/</span>
09745 {
09746     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09747     <a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html">IO_GET_LEGACY_VETO_LIST_CONTEXT</a> Context;
09748     UNICODE_STRING UnicodeString;
09749 
09750     <span class="comment">//</span>
09751     <span class="comment">// Initialize the veto list.</span>
09752     <span class="comment">//</span>
09753 
09754     <span class="keywordflow">if</span> (VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09755         *VetoList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09756     }
09757 
09758     <span class="comment">//</span>
09759     <span class="comment">// Initialize the veto type.</span>
09760     <span class="comment">//</span>
09761 
09762     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(VetoType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
09763 
09764     *VetoType = PNP_VetoTypeUnknown;
09765 
09766     <span class="comment">//</span>
09767     <span class="comment">// Initialize the status.</span>
09768     <span class="comment">//</span>
09769 
09770     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
09771 
09772     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a14">PnPInitialized</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
09773 
09774         <span class="comment">//</span>
09775         <span class="comment">// Can't touch anything, but nothing is really started either.</span>
09776         <span class="comment">//</span>
09777         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09778     }
09779 
09780     <span class="comment">//</span>
09781     <span class="comment">// Initialize our local context.</span>
09782     <span class="comment">//</span>
09783 
09784     Context.<a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o0">VetoList</a> = VetoList;
09785     Context.<a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o1">VetoListLength</a> = 0;
09786     Context.<a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o2">VetoType</a> = VetoType;
09787     Context.<a class="code" href="../../d6/d7/structIO__GET__LEGACY__VETO__LIST__CONTEXT.html#o3">Status</a> = &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09788 
09789     <span class="comment">//</span>
09790     <span class="comment">// Enumerate all driver objects.  This process can: (1) modify</span>
09791     <span class="comment">// the veto list, (2) modify the veto type and/or (3) modify the</span>
09792     <span class="comment">// status.</span>
09793     <span class="comment">//</span>
09794 
09795     <a class="code" href="../../d8/d0/pnpioapi_8c.html#a119">IopGetLegacyVetoListDrivers</a>(&amp;Context);
09796 
09797     <span class="comment">//</span>
09798     <span class="comment">// If the driver enumeration process was successful and no legacy</span>
09799     <span class="comment">// drivers were detected, enumerate all device nodes.  The same</span>
09800     <span class="comment">// context values as above may be modified during device enumeration.</span>
09801     <span class="comment">//</span>
09802 
09803     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
09804 
09805         <span class="keywordflow">if</span> (*VetoType == PNP_VetoTypeUnknown) {
09806 
09807             <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
09808 
09809             <a class="code" href="../../d8/d0/pnpioapi_8c.html#a118">IopGetLegacyVetoListDeviceNode</a>(
09810                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
09811                 &amp;Context
09812             );
09813 
09814             <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
09815 
09816         }
09817 
09818     }
09819 
09820     <span class="comment">//</span>
09821     <span class="comment">// If the previous operation(s) was/were successful, and the caller</span>
09822     <span class="comment">// provided a veto list pointer and we have constructed a veto</span>
09823     <span class="comment">// list, terminate the veto list with an empty string, i.e. MULTI_SZ.</span>
09824     <span class="comment">//</span>
09825 
09826     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
09827 
09828         <span class="keywordflow">if</span> (*VetoType != PNP_VetoTypeUnknown) {
09829 
09830             <span class="keywordflow">if</span> (VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09831 
09832                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
09833                     &amp;UnicodeString,
09834                     <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>
09835                 );
09836 
09837                 <a class="code" href="../../d8/d0/pnpioapi_8c.html#a116">IopAppendLegacyVeto</a>(
09838                     &amp;Context,
09839                     &amp;UnicodeString
09840                 );
09841 
09842             }
09843 
09844         }
09845 
09846     }
09847 
09848     <span class="comment">//</span>
09849     <span class="comment">// If a previous operation was unsuccessful, free any veto list we may have</span>
09850     <span class="comment">// allocated along the way.</span>
09851     <span class="comment">//</span>
09852 
09853     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
09854 
09855         <span class="keywordflow">if</span> (VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; *VetoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
09856             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*VetoList);
09857             *VetoList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09858         }
09859 
09860     }
09861 
09862     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
09863 }
09864 
09865 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09866"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a356">09866</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a356">IopDoDeferredSetInterfaceState</a>(
09867     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
09868     )
09869 <span class="comment">/*++</span>
09870 <span class="comment"></span>
09871 <span class="comment">Routine Description:</span>
09872 <span class="comment"></span>
09873 <span class="comment">    Process the queued IoSetDeviceInterfaceState calls.</span>
09874 <span class="comment"></span>
09875 <span class="comment">Parameters:</span>
09876 <span class="comment"></span>
09877 <span class="comment">    DeviceNode - Device node which has just been started.</span>
09878 <span class="comment"></span>
09879 <span class="comment">Return Value:</span>
09880 <span class="comment"></span>
09881 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
09882 <span class="comment"></span>
09883 <span class="comment">--*/</span>
09884 {
09885     KIRQL           irql;
09886     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  attachedDevice;
09887 
09888     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
09889     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
09890 
09891     ExAcquireFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, &amp;irql );
09892 
09893     <span class="keywordflow">for</span> (attachedDevice = DeviceNode-&gt;PhysicalDeviceObject;
09894          attachedDevice;
09895          attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
09896 
09897         attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>;
09898     }
09899 
09900     ExReleaseFastLock( &amp;<a class="code" href="../../d3/d5/iodata_8c.html#a3">IopDatabaseLock</a>, irql );
09901 
09902     <span class="keywordflow">while</span> (!IsListEmpty(&amp;DeviceNode-&gt;PendedSetInterfaceState)) {
09903 
09904         <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a> entry;
09905 
09906         entry = (<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a>)RemoveHeadList(&amp;DeviceNode-&gt;PendedSetInterfaceState);
09907 
09908         <a class="code" href="../../d9/d0/pnpiop_8h.html#a357">IopProcessSetInterfaceState</a>(&amp;entry-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
09909 
09910         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer);
09911 
09912         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
09913     }
09914 
09915     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;<a class="code" href="../../d6/d9/pnp_8h.html#a13">PpRegistryDeviceResource</a>);
09916     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
09917 
09918     <span class="keywordflow">return</span> STATUS_SUCCESS;
09919 }
09920 
09921 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l09922"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a357">09922</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a357">IopProcessSetInterfaceState</a>(
09923     IN PUNICODE_STRING SymbolicLinkName,
09924     IN BOOLEAN Enable,
09925     IN BOOLEAN DeferNotStarted
09926     )
09927 <span class="comment">/*++</span>
09928 <span class="comment"></span>
09929 <span class="comment">Routine Description:</span>
09930 <span class="comment"></span>
09931 <span class="comment">    This DDI allows a device class to activate and deactivate an association</span>
09932 <span class="comment">    previously registered using IoRegisterDeviceInterface</span>
09933 <span class="comment"></span>
09934 <span class="comment">Parameters:</span>
09935 <span class="comment"></span>
09936 <span class="comment">    SymbolicLinkName - Supplies a pointer to the symbolic link name which was</span>
09937 <span class="comment">        returned by IoRegisterDeviceInterface when the interface was registered,</span>
09938 <span class="comment">        or as returned by IoGetDeviceInterfaces.</span>
09939 <span class="comment"></span>
09940 <span class="comment">    Enable - If TRUE (non-zero), the interface will be enabled.  If FALSE, it</span>
09941 <span class="comment">        will be disabled.</span>
09942 <span class="comment"></span>
09943 <span class="comment">    DeferNotStarted - If TRUE then enables will be queued if the PDO isn't</span>
09944 <span class="comment">        started.  It is FALSE when we've started the PDO and are processing the</span>
09945 <span class="comment">        queued enables.</span>
09946 <span class="comment"></span>
09947 <span class="comment">Return Value:</span>
09948 <span class="comment"></span>
09949 <span class="comment">    Status code that indicates whether or not the function was successful.</span>
09950 <span class="comment"></span>
09951 <span class="comment">--*/</span>
09952 
09953 {
09954     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
09955     HANDLE hInterfaceClassKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09956     HANDLE hInterfaceParentKey= <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceInstanceKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09957     HANDLE hInterfaceParentControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, hInterfaceInstanceControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09958     UNICODE_STRING tempString, actualSymbolicLinkName, deviceNameString;
09959     PKEY_VALUE_FULL_INFORMATION pKeyValueInfo;
09960     ULONG linked, refcount;
09961     GUID guid;
09962     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDeviceObject;
09963     PWCHAR deviceNameBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
09964     ULONG deviceNameBufferLength;
09965 
09966     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
09967 
09968     <span class="comment">//</span>
09969     <span class="comment">// Get the symbolic link name without the ref string</span>
09970     <span class="comment">//</span>
09971 
09972     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a65">IopDropReferenceString</a>(&amp;actualSymbolicLinkName, SymbolicLinkName);
09973     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09974         <span class="keywordflow">goto</span> clean0;
09975     }
09976 
09977     <span class="comment">//</span>
09978     <span class="comment">// Extract the device class guid</span>
09979     <span class="comment">//</span>
09980 
09981     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a66">IopParseSymbolicLinkName</a>(SymbolicLinkName, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;guid);
09982 
09983     <span class="comment">//</span>
09984     <span class="comment">// Get function class instance handle</span>
09985     <span class="comment">//</span>
09986 
09987     status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a62">IopDeviceInterfaceKeysFromSymbolicLink</a>(SymbolicLinkName,
09988                                                     KEY_READ | KEY_WRITE,
09989                                                     &amp;hInterfaceClassKey,
09990                                                     &amp;hInterfaceParentKey,
09991                                                     &amp;hInterfaceInstanceKey
09992                                                     );
09993 
09994     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
09995         <span class="keywordflow">goto</span> clean1;
09996     }
09997 
09998     <span class="comment">//</span>
09999     <span class="comment">// Open the parent interface control subkey</span>
10000     <span class="comment">//</span>
10001     PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
10002     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hInterfaceParentControl,
10003                                      hInterfaceParentKey,
10004                                      &amp;tempString,
10005                                      KEY_READ,
10006                                      REG_OPTION_VOLATILE,
10007                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
10008                                      );
10009     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10010         <span class="keywordflow">goto</span> clean1;
10011     }
10012 
10013 
10014     <span class="comment">//</span>
10015     <span class="comment">// Find out the name of the device instance that 'owns' this interface.</span>
10016     <span class="comment">//</span>
10017     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceParentKey,
10018                                  REGSTR_VAL_DEVICE_INSTANCE,
10019                                  &amp;pKeyValueInfo
10020                                  );
10021 
10022     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10023         <span class="comment">//</span>
10024         <span class="comment">// Open the device instance control subkey</span>
10025         <span class="comment">//</span>
10026         PiWstrToUnicodeString(&amp;tempString, REGSTR_KEY_CONTROL);
10027         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;hInterfaceInstanceControl,
10028                                          hInterfaceInstanceKey,
10029                                          &amp;tempString,
10030                                          KEY_READ,
10031                                          REG_OPTION_VOLATILE,
10032                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
10033                                          );
10034         <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10035             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10036             hInterfaceInstanceControl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10037         }
10038     }
10039 
10040     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10041         <span class="keywordflow">goto</span> clean2;
10042     }
10043 
10044     <span class="comment">//</span>
10045     <span class="comment">// Find the PDO corresponding to this device instance name.</span>
10046     <span class="comment">//</span>
10047     <span class="keywordflow">if</span> (pKeyValueInfo-&gt;Type == REG_SZ) {
10048 
10049         <a class="code" href="../../d9/d0/pnpiop_8h.html#a82">IopRegistryDataToUnicodeString</a>(&amp;tempString,
10050                                         (PWSTR)<a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo),
10051                                         pKeyValueInfo-&gt;DataLength
10052                                         );
10053 
10054         physicalDeviceObject = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;tempString);
10055 
10056         <span class="keywordflow">if</span> (physicalDeviceObject) {
10057 
10058             <span class="comment">//</span>
10059             <span class="comment">// DeferNotStarted is set TRUE if we are being called from</span>
10060             <span class="comment">// IoSetDeviceInterfaceState.  It will be set FALSE if we are</span>
10061             <span class="comment">// processing previously queued operations as we are starting the</span>
10062             <span class="comment">// device.</span>
10063             <span class="comment">//</span>
10064 
10065             <span class="keywordflow">if</span> (DeferNotStarted) {
10066 
10067                 <span class="keywordflow">if</span> (physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o5">ExtensionFlags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a142">DOE_START_PENDING</a>) {
10068 
10069                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
10070                     <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a> pendingSetState;
10071 
10072                     <span class="comment">//</span>
10073                     <span class="comment">// The device hasn't been started yet.  We need to queue</span>
10074                     <span class="comment">// any enables and remove items from the queue on a disable.</span>
10075                     <span class="comment">//</span>
10076                     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
10077 
10078                     <span class="keywordflow">if</span> (Enable) {
10079 
10080                         pendingSetState = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
10081                                                           <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PENDING_SET_INTERFACE_STATE</a>));
10082 
10083                         <span class="keywordflow">if</span> (pendingSetState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10084 
10085                             pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
10086                                                                                SymbolicLinkName-&gt;Length);
10087 
10088                             <span class="keywordflow">if</span> (pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10089 
10090                                 <span class="comment">//</span>
10091                                 <span class="comment">// Capture the callers info and queue it to the</span>
10092                                 <span class="comment">// devnode.  Once the device stack is started</span>
10093                                 <span class="comment">// we will dequeue and process it.</span>
10094                                 <span class="comment">//</span>
10095                                 pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.MaximumLength = SymbolicLinkName-&gt;Length;
10096                                 pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Length = SymbolicLinkName-&gt;Length;
10097                                 RtlCopyMemory( pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer,
10098                                                SymbolicLinkName-&gt;Buffer,
10099                                                SymbolicLinkName-&gt;Length);
10100                                 InsertTailList( &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>,
10101                                                 &amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o0">List</a>);
10102 
10103                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10104 
10105                                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10106 
10107                                 status = STATUS_SUCCESS;
10108                                 <span class="keywordflow">goto</span> clean2;
10109 
10110                             } <span class="keywordflow">else</span> {
10111                                 <span class="comment">//</span>
10112                                 <span class="comment">// Couldn't allocate a buffer to hold the</span>
10113                                 <span class="comment">// symbolic link name.</span>
10114                                 <span class="comment">//</span>
10115 
10116                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState);
10117                                 status = STATUS_INSUFFICIENT_RESOURCES;
10118                             }
10119 
10120                         } <span class="keywordflow">else</span> {
10121                             <span class="comment">//</span>
10122                             <span class="comment">// Couldn't allocate the PENDING_SET_INTERFACE_STATE</span>
10123                             <span class="comment">// structure.</span>
10124                             <span class="comment">//</span>
10125 
10126 
10127                             status = STATUS_INSUFFICIENT_RESOURCES;
10128                         }
10129 
10130                     } <span class="keywordflow">else</span> {
10131 
10132                         PLIST_ENTRY entry;
10133 
10134                         <span class="comment">//</span>
10135                         <span class="comment">// We are disabling an interface.  Since we aren't</span>
10136                         <span class="comment">// started yet we should have queued the enable.  Now</span>
10137                         <span class="comment">// we go back and find the matching enable and remove</span>
10138                         <span class="comment">// it from the queue.</span>
10139                         <span class="comment">//</span>
10140 
10141                         <span class="keywordflow">for</span> (entry = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>.Flink;
10142                              entry != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>;
10143                              entry = entry-&gt;Flink)  {
10144 
10145                             pendingSetState = CONTAINING_RECORD( entry,
10146                                                                  <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PENDING_SET_INTERFACE_STATE</a>,
10147                                                                  <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> );
10148 
10149                             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( &amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>,
10150                                                        SymbolicLinkName,
10151                                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
10152 
10153                                 <span class="comment">//</span>
10154                                 <span class="comment">// We found it, remove it from the list and</span>
10155                                 <span class="comment">// free it.</span>
10156                                 <span class="comment">//</span>
10157                                 RemoveEntryList(&amp;pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o0">List</a>);
10158 
10159                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer);
10160                                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pendingSetState);
10161 
10162                                 <span class="keywordflow">break</span>;
10163                             }
10164                         }
10165 
10166 <span class="preprocessor">#if 0</span>
10167 <span class="preprocessor"></span>                        <span class="comment">//</span>
10168                         <span class="comment">// Debug code to catch the case where we couldn't find</span>
10169                         <span class="comment">// the entry to remove.  This could happen if we messed</span>
10170                         <span class="comment">// up adding the entry to the list or the driver disabled</span>
10171                         <span class="comment">// an interface without first enabling it.  Either way</span>
10172                         <span class="comment">// it probably merits some investigation.</span>
10173                         <span class="comment">//</span>
10174                         <span class="keywordflow">if</span> (entry == &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>) {
10175                             PIDBGMSG(PIDBG_ERROR,
10176                                      (<span class="stringliteral">"IopProcessSetInterfaceState: Disable couldn't find deferred enable, DeviceNode = 0x%p, SymbolicLink = \"%Z\"\n"</span>,
10177                                      deviceNode,
10178                                      SymbolicLinkName));
10179                         }
10180 
10181                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry != &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>);
10182 <span class="preprocessor">#endif</span>
10183 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10184 
10185                         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10186 
10187                         status = STATUS_SUCCESS;
10188                         <span class="keywordflow">goto</span> clean2;
10189                     }
10190                 }
10191             }
10192 
10193             <span class="keywordflow">if</span> (!Enable || !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10194                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10195             }
10196         } <span class="keywordflow">else</span> {
10197 
10198             status = STATUS_INVALID_DEVICE_REQUEST;
10199         }
10200 
10201     } <span class="keywordflow">else</span> {
10202         <span class="comment">//</span>
10203         <span class="comment">// This will only happen if the registry information is screwed up.</span>
10204         <span class="comment">//</span>
10205         physicalDeviceObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10206         status = STATUS_INVALID_DEVICE_REQUEST;
10207     }
10208 
10209     <span class="keywordflow">if</span> (!Enable) {
10210         <span class="comment">//</span>
10211         <span class="comment">// In the case of Disable we want to continue even if there was an error</span>
10212         <span class="comment">// finding the PDO.  Prior to adding support for deferring the</span>
10213         <span class="comment">// IoSetDeviceInterfaceState calls, we never looked up the PDO for</span>
10214         <span class="comment">// disables.  This will make sure that we continue to behave the same as</span>
10215         <span class="comment">// we used to in the case where we can't find the PDO.</span>
10216         <span class="comment">//</span>
10217         status = STATUS_SUCCESS;
10218     }
10219 
10220     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10221 
10222     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10223         <span class="keywordflow">goto</span> clean2;
10224     }
10225 
10226     <span class="keywordflow">if</span> (Enable) {
10227         <span class="comment">//</span>
10228         <span class="comment">// Retrieve the PDO's device object name.  (Start out with a reasonably-sized</span>
10229         <span class="comment">// buffer so we hopefully only have to retrieve this once.</span>
10230         <span class="comment">//</span>
10231         deviceNameBufferLength = 256 * <span class="keyword">sizeof</span>(WCHAR);
10232 
10233         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
10234 
10235             deviceNameBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, deviceNameBufferLength);
10236             <span class="keywordflow">if</span> (!deviceNameBuffer) {
10237                 status = STATUS_INSUFFICIENT_RESOURCES;
10238                 <span class="keywordflow">break</span>;
10239             }
10240 
10241             status = <a class="code" href="../../d8/d0/pnpioapi_8c.html#a74">IoGetDeviceProperty</a>( physicalDeviceObject,
10242                                           <a class="code" href="../../d6/d9/pnp_8h.html#a170a94">DevicePropertyPhysicalDeviceObjectName</a>,
10243                                           deviceNameBufferLength,
10244                                           deviceNameBuffer,
10245                                           &amp;deviceNameBufferLength
10246                                          );
10247 
10248             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10249                 <span class="keywordflow">break</span>;
10250             } <span class="keywordflow">else</span> {
10251                 <span class="comment">//</span>
10252                 <span class="comment">// Free the current buffer before we figure out what went wrong.</span>
10253                 <span class="comment">//</span>
10254                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNameBuffer);
10255 
10256                 <span class="keywordflow">if</span> (status != STATUS_BUFFER_TOO_SMALL) {
10257                     <span class="comment">//</span>
10258                     <span class="comment">// Our failure wasn't because the buffer was too small--bail now.</span>
10259                     <span class="comment">//</span>
10260                     <span class="keywordflow">break</span>;
10261                 }
10262 
10263                 <span class="comment">//</span>
10264                 <span class="comment">// Otherwise, loop back and try again with our new buffer size.</span>
10265                 <span class="comment">//</span>
10266             }
10267         }
10268 
10269         <span class="comment">//</span>
10270         <span class="comment">// OK, we don't need the PDO anymore.</span>
10271         <span class="comment">//</span>
10272         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(physicalDeviceObject);
10273 
10274         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10275             <span class="keywordflow">goto</span> clean2;
10276         }
10277 
10278         <span class="comment">//</span>
10279         <span class="comment">// Now create a unicode string based on the device object name we just retrieved.</span>
10280         <span class="comment">//</span>
10281 
10282         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;deviceNameString, deviceNameBuffer);
10283     }
10284 
10285     <span class="comment">//</span>
10286     <span class="comment">// Retrieve the linked value from the control subkey.</span>
10287     <span class="comment">//</span>
10288     pKeyValueInfo=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
10289     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceInstanceControl, REGSTR_VAL_LINKED, &amp;pKeyValueInfo);
10290 
10291     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10292 
10293         <span class="comment">//</span>
10294         <span class="comment">// The absence of a linked value is taken to mean not linked</span>
10295         <span class="comment">//</span>
10296 
10297         linked = 0;
10298 
10299     } <span class="keywordflow">else</span> {
10300         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10301             <span class="comment">//</span>
10302             <span class="comment">// If the call failed, pKeyValueInfo was never allocated</span>
10303             <span class="comment">//</span>
10304             <span class="keywordflow">goto</span> clean3;
10305         }
10306 
10307         <span class="comment">//</span>
10308         <span class="comment">// Check linked is a DWORD</span>
10309         <span class="comment">//</span>
10310 
10311         <span class="keywordflow">if</span>(pKeyValueInfo-&gt;Type == REG_DWORD &amp;&amp; pKeyValueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
10312 
10313             linked = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo));
10314 
10315         } <span class="keywordflow">else</span> {
10316 
10317             <span class="comment">//</span>
10318             <span class="comment">// The registry is screwed up - assume linked is 0 and the registry will be fixed when</span>
10319             <span class="comment">// we update linked in a few moments</span>
10320             <span class="comment">//</span>
10321 
10322             linked = 0;
10323 
10324         }
10325 
10326     }
10327     <span class="keywordflow">if</span> (pKeyValueInfo) {
10328         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (pKeyValueInfo);
10329     }
10330 
10331     <span class="comment">//</span>
10332     <span class="comment">// Retrieve the refcount value from the control subkey.</span>
10333     <span class="comment">//</span>
10334 
10335     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, REGSTR_VAL_REFERENCECOUNT);
10336     status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(hInterfaceParentControl,
10337                                  tempString.Buffer,
10338                                  &amp;pKeyValueInfo
10339                                  );
10340 
10341     <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10342 
10343         <span class="comment">//</span>
10344         <span class="comment">// The absence of a refcount value is taken to mean refcount == 0</span>
10345         <span class="comment">//</span>
10346 
10347         refcount = 0;
10348 
10349     } <span class="keywordflow">else</span> {
10350         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10351             <span class="keywordflow">goto</span> clean3;
10352         }
10353 
10354         <span class="comment">//</span>
10355         <span class="comment">// Check refcount is a DWORD</span>
10356         <span class="comment">//</span>
10357 
10358         <span class="keywordflow">if</span>(pKeyValueInfo-&gt;Type == REG_DWORD &amp;&amp; pKeyValueInfo-&gt;DataLength == <span class="keyword">sizeof</span>(ULONG)) {
10359 
10360             refcount = *((PULONG) <a class="code" href="../../d9/d0/pnpiop_8h.html#a75">KEY_VALUE_DATA</a>(pKeyValueInfo));
10361 
10362         } <span class="keywordflow">else</span> {
10363 
10364             <span class="comment">//</span>
10365             <span class="comment">// The registry is screwed up - assume refcount is 0 and the registry will be fixed when</span>
10366             <span class="comment">// we update refcount in a few moments</span>
10367             <span class="comment">//</span>
10368 
10369             refcount = 0;
10370 
10371         }
10372 
10373         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(pKeyValueInfo);
10374     }
10375 
10376 
10377     <span class="keywordflow">if</span> (Enable) {
10378 
10379         <span class="keywordflow">if</span> (!linked) {
10380             <span class="comment">//</span>
10381             <span class="comment">// check and update the reference count</span>
10382             <span class="comment">//</span>
10383 
10384             <span class="keywordflow">if</span> (refcount &gt; 0) {
10385                 <span class="comment">//</span>
10386                 <span class="comment">// Another device instance has already referenced this interface;</span>
10387                 <span class="comment">// just increment the reference count; don't try create a symbolic link.</span>
10388                 <span class="comment">//</span>
10389                 refcount += 1;
10390             } <span class="keywordflow">else</span> {
10391                 <span class="comment">//</span>
10392                 <span class="comment">// According to the reference count, no other device instances currently</span>
10393                 <span class="comment">// reference this interface, and therefore no symbolic links should exist,</span>
10394                 <span class="comment">// so we should create one.</span>
10395                 <span class="comment">//</span>
10396                 refcount = 1;
10397                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>(&amp;actualSymbolicLinkName, &amp;deviceNameString);
10398 
10399                 <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_COLLISION) {
10400                     <span class="comment">//</span>
10401                     <span class="comment">// The reference count is screwed up.</span>
10402                     <span class="comment">//</span>
10403                     KdPrint((<span class="stringliteral">"IoSetDeviceInterfaceState: symbolic link for %ws already exists! status = %8.8X\n"</span>,
10404                              actualSymbolicLinkName.Buffer, status));
10405                     status = STATUS_SUCCESS;
10406                 }
10407 
10408             }
10409 
10410             linked = 1;
10411 
10412 <span class="preprocessor">#if 0</span>
10413 <span class="preprocessor"></span>            <a class="code" href="../../d8/d0/pnpioapi_8c.html#a55">IopSetupDeviceObjectFromDeviceClass</a>(physicalDeviceObject,
10414                                                 hInterfaceClassKey);
10415 <span class="preprocessor">#endif</span>
10416 <span class="preprocessor"></span>
10417         } <span class="keywordflow">else</span> {
10418 
10419             <span class="comment">//</span>
10420             <span class="comment">// The association already exists - don't perform the notification</span>
10421             <span class="comment">//</span>
10422 
10423             status = STATUS_OBJECT_NAME_EXISTS; <span class="comment">// Informational message not error</span>
10424             <span class="keywordflow">goto</span> clean3;
10425 
10426         }
10427     } <span class="keywordflow">else</span> {
10428 
10429         <span class="keywordflow">if</span> (linked) {
10430 
10431             <span class="comment">//</span>
10432             <span class="comment">// check and update the reference count</span>
10433             <span class="comment">//</span>
10434 
10435             <span class="keywordflow">if</span> (refcount &gt; 1) {
10436                 <span class="comment">//</span>
10437                 <span class="comment">// Another device instance already references this interface;</span>
10438                 <span class="comment">// just decrement the reference count; don't try to remove the symbolic link.</span>
10439                 <span class="comment">//</span>
10440                 refcount -= 1;
10441             } <span class="keywordflow">else</span> {
10442                 <span class="comment">//</span>
10443                 <span class="comment">// According to the reference count, only this device instance currently</span>
10444                 <span class="comment">// references this interface, so it is ok to delete this symbolic link</span>
10445                 <span class="comment">//</span>
10446                 refcount = 0;
10447                 status = <a class="code" href="../../d4/d6/iosubs_8c.html#a57">IoDeleteSymbolicLink</a>(&amp;actualSymbolicLinkName);
10448 
10449                 <span class="keywordflow">if</span> (status == STATUS_OBJECT_NAME_NOT_FOUND) {
10450                     <span class="comment">//</span>
10451                     <span class="comment">// The reference count is screwed up.</span>
10452                     <span class="comment">//</span>
10453                     KdPrint((<span class="stringliteral">"IoSetDeviceInterfaceState: no symbolic link for %ws to delete! status = %8.8X\n"</span>,
10454                              actualSymbolicLinkName.Buffer, status));
10455                     status = STATUS_SUCCESS;
10456                 }
10457 
10458             }
10459 
10460             linked = 0;
10461 
10462         } <span class="keywordflow">else</span> {
10463 
10464             <span class="comment">//</span>
10465             <span class="comment">// The association does not exists - fail and do not perform notification</span>
10466             <span class="comment">//</span>
10467 
10468             status = STATUS_OBJECT_NAME_NOT_FOUND;
10469         }
10470     }
10471 
10472     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
10473         <span class="keywordflow">goto</span> clean3;
10474     }
10475 
10476     <span class="comment">//</span>
10477     <span class="comment">// Update the value of linked</span>
10478     <span class="comment">//</span>
10479 
10480     PiWstrToUnicodeString(&amp;tempString, REGSTR_VAL_LINKED);
10481     status = ZwSetValueKey(hInterfaceInstanceControl,
10482                            &amp;tempString,
10483                            0,
10484                            REG_DWORD,
10485                            &amp;linked,
10486                            <span class="keyword">sizeof</span>(linked)
10487                           );
10488 
10489     <span class="comment">//</span>
10490     <span class="comment">// Update the value of refcount</span>
10491     <span class="comment">//</span>
10492 
10493     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;tempString, REGSTR_VAL_REFERENCECOUNT);
10494     status = ZwSetValueKey(hInterfaceParentControl,
10495                            &amp;tempString,
10496                            0,
10497                            REG_DWORD,
10498                            &amp;refcount,
10499                            <span class="keyword">sizeof</span>(refcount)
10500                           );
10501 
10502 
10503     <span class="comment">//</span>
10504     <span class="comment">// Notify anyone that is interested</span>
10505     <span class="comment">//</span>
10506 
10507     <span class="keywordflow">if</span> (linked) {
10508 
10509         <a class="code" href="../../d6/d9/pnp_8h.html#a161">PpSetDeviceClassChange</a>( (LPGUID) &amp;GUID_DEVICE_INTERFACE_ARRIVAL, &amp;guid, SymbolicLinkName);
10510 
10511     } <span class="keywordflow">else</span> {
10512 
10513         <a class="code" href="../../d6/d9/pnp_8h.html#a161">PpSetDeviceClassChange</a>( (LPGUID) &amp;GUID_DEVICE_INTERFACE_REMOVAL, &amp;guid, SymbolicLinkName);
10514 
10515     }
10516 
10517 clean3:
10518     <span class="keywordflow">if</span> (deviceNameBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10519         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNameBuffer);
10520     }
10521 
10522 clean2:
10523     <span class="keywordflow">if</span> (hInterfaceParentControl) {
10524         ZwClose(hInterfaceParentControl);
10525     }
10526     <span class="keywordflow">if</span> (hInterfaceInstanceControl) {
10527         ZwClose(hInterfaceInstanceControl);
10528     }
10529 
10530 clean1:
10531     <span class="keywordflow">if</span> (hInterfaceParentKey) {
10532         ZwClose(hInterfaceParentKey);
10533     }
10534     <span class="keywordflow">if</span> (hInterfaceInstanceKey) {
10535         ZwClose(hInterfaceInstanceKey);
10536     }
10537     <span class="keywordflow">if</span>(hInterfaceClassKey != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
10538         ZwClose(hInterfaceClassKey);
10539     }
10540 
10541 clean0:
10542     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; !Enable) {
10543         <span class="comment">//</span>
10544         <span class="comment">// If we failed to disable an interface (most likely because the</span>
10545         <span class="comment">// interface keys have already been deleted) report success.</span>
10546         <span class="comment">//</span>
10547         status = STATUS_SUCCESS;
10548     }
10549 
10550     <span class="keywordflow">return</span> status;
10551 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:17 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
