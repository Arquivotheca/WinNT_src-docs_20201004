<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psdelete.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psdelete.c</h1><a href="../../d8/d0/psdelete_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    psdelete.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements process and thread object termination and</span>
00012 <span class="comment">    deletion.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Mark Lucovsky (markl) 01-May-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d8/d1/psp_8h.html">psp.h</a>"</span>
00023 
00024 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspTerminateThreadByPointer)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspTerminateProcess)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtTerminateProcess)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtTerminateThread)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspNullSpecialApc)</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspExitNormalApc)</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspExitProcess)</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspProcessDelete)</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspThreadDelete)</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtRegisterThreadTerminatePort)</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PspExitThread)</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsExitSpecialApc)</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsGetProcessExitTime)</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, PsSetLegoNotifyRoutine)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 
<a name="l00042"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a0">00042</a> <a class="code" href="../../d1/d9/ps_8h.html#a66">PLEGO_NOTIFY_ROUTINE</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a>;
00043 
00044 ULONG
<a name="l00045"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a1">00045</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a1">PsSetLegoNotifyRoutine</a>(
00046     PLEGO_NOTIFY_ROUTINE LegoNotifyRoutine
00047     )
00048 {
00049     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00050 
00051     <a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a> = LegoNotifyRoutine;
00052 
00053     <span class="keywordflow">return</span> FIELD_OFFSET(<a class="code" href="../../d1/d8/struct__KTHREAD.html">KTHREAD</a>,LegoData);
00054 }
00055 
00056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00057"></a><a class="code" href="../../d8/d1/psp_8h.html#a66">00057</a> <a class="code" href="../../d8/d1/psp_8h.html#a66">PspReaper</a>(
00058     IN PVOID Context
00059     )
00060 
00061 <span class="comment">/*++</span>
00062 <span class="comment"></span>
00063 <span class="comment">Routine Description:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    This routine implements the thread reaper. The reaper is responsible</span>
00066 <span class="comment">    for processing terminated threads. This includes:</span>
00067 <span class="comment"></span>
00068 <span class="comment">        - deallocating their kernel stacks</span>
00069 <span class="comment"></span>
00070 <span class="comment">        - releasing their process' CreateDelete lock</span>
00071 <span class="comment"></span>
00072 <span class="comment">        - dereferencing their process</span>
00073 <span class="comment"></span>
00074 <span class="comment">        - dereferencing themselves</span>
00075 <span class="comment"></span>
00076 <span class="comment">Arguments:</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Context - NOT USED</span>
00079 <span class="comment"></span>
00080 <span class="comment">Return Value:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    None.</span>
00083 <span class="comment"></span>
00084 <span class="comment">--*/</span>
00085 
00086 {
00087 
00088     PLIST_ENTRY NextEntry;
00089     KIRQL OldIrql, OldIrql2;
00090     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00091     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00092 
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">// Lock the dispatcher data and continually remove entries from the</span>
00096     <span class="comment">// reaper list until no more entries exist.</span>
00097     <span class="comment">//</span>
00098     <span class="comment">// N.B. The dispatcher database lock is used to synchronize access to</span>
00099     <span class="comment">//      the reaper list. This is done to avoid a race condition with</span>
00100     <span class="comment">//      the thread termination code.</span>
00101     <span class="comment">//</span>
00102 
00103     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00104     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>.Flink;
00105     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>) {
00106 
00107         <span class="comment">//</span>
00108         <span class="comment">// Remove the next thread from the reaper list, get the address of</span>
00109         <span class="comment">// the executive thread object, acquire the context swap lock, and</span>
00110         <span class="comment">// then release the both the context swap dispatcher database locks.</span>
00111         <span class="comment">//</span>
00112         <span class="comment">// N.B. The context swap lock is acquired and immediately released.</span>
00113         <span class="comment">//    This is necessary to ensure that the respective thread has</span>
00114         <span class="comment">//    completely passed through the context switch code before it</span>
00115         <span class="comment">//    is terminated.</span>
00116         <span class="comment">//</span>
00117 
00118         RemoveEntryList(NextEntry);
00119         Thread = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, TerminationPortList);
00120 
00121         <a class="code" href="../../d0/d0/ki_8h.html#a11">KiLockContextSwap</a>(&amp;OldIrql2);
00122         <a class="code" href="../../d0/d0/ki_8h.html#a12">KiUnlockContextSwap</a>(OldIrql2);
00123 
00124         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">// Get the address of the executive process object, release the</span>
00128         <span class="comment">// process' CreateDelete lock and then dereference the process</span>
00129         <span class="comment">// object.</span>
00130         <span class="comment">//</span>
00131 
00132         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
00133         <span class="comment">//</span>
00134         <span class="comment">// Delete the kernel stack and dereference the thread.</span>
00135         <span class="comment">//</span>
00136 
00137         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o61">StackBase</a>,(BOOLEAN)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o52">LargeStack</a>);
00138         Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00139         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00140 
00141         <span class="comment">//</span>
00142         <span class="comment">// Lock the dispatcher database and get the address of the next</span>
00143         <span class="comment">// entry in the list.</span>
00144         <span class="comment">//</span>
00145 
00146         <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00147         NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a64">PsReaperListHead</a>.Flink;
00148     }
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">// Set the reaper not active and unlock the dispatcher database.</span>
00152     <span class="comment">//</span>
00153 
00154     <a class="code" href="../../d1/d9/ps_8h.html#a63">PsReaperActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00155     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00156     <span class="keywordflow">return</span>;
00157 }
00158 
00159 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00160"></a><a class="code" href="../../d8/d1/psp_8h.html#a69">00160</a> <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(
00161     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,
00162     IN NTSTATUS ExitStatus
00163     )
00164 
00165 <span class="comment">/*++</span>
00166 <span class="comment"></span>
00167 <span class="comment">Routine Description:</span>
00168 <span class="comment"></span>
00169 <span class="comment">    This function causes the specified thread to terminate.</span>
00170 <span class="comment"></span>
00171 <span class="comment">Arguments:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    ThreadHandle - Supplies a referenced pointer to the thread to terminate.</span>
00174 <span class="comment"></span>
00175 <span class="comment">    ExitStatus - Supplies the exit status associated with the thread.</span>
00176 <span class="comment"></span>
00177 <span class="comment">Return Value:</span>
00178 <span class="comment"></span>
00179 <span class="comment">    TBD</span>
00180 <span class="comment"></span>
00181 <span class="comment">--*/</span>
00182 
00183 {
00184 
00185     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ExitApc;
00186 
00187     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00188 
00189     <span class="keywordflow">if</span> ( Thread == <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() ) {
00190         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00191         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00192 
00193         <span class="comment">//</span>
00194         <span class="comment">// Never Returns</span>
00195         <span class="comment">//</span>
00196 
00197     } <span class="keywordflow">else</span> {
00198         ExitApc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,(ULONG)<span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
00199 
00200         <span class="keywordflow">if</span> ( !ExitApc ) {
00201             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00202         }
00203 
00204         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00205             ExitApc,
00206             &amp;Thread-&gt;Tcb,
00207             <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00208             <a class="code" href="../../d1/d9/ps_8h.html#a117">PsExitSpecialApc</a>,
00209             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00210             <a class="code" href="../../d8/d0/psdelete_8c.html#a10">PspExitNormalApc</a>,
00211             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00212             ULongToPtr(ExitStatus) <span class="comment">// Sundown: ExitStatus is zero-extended.</span>
00213             );
00214 
00215 
00216         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(ExitApc,ExitApc,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 2) ) {
00217             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00218 
00219             <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00220         }
00221     }
00222 
00223     <span class="keywordflow">return</span> STATUS_SUCCESS;
00224 }
00225 
00226 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00227"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a4">00227</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a4">NtTerminateProcess</a>(
00228     IN HANDLE ProcessHandle OPTIONAL,
00229     IN NTSTATUS ExitStatus
00230     )
00231 
00232 <span class="comment">/*++</span>
00233 <span class="comment"></span>
00234 <span class="comment">Routine Description:</span>
00235 <span class="comment"></span>
00236 <span class="comment">    This function causes the specified process and all of</span>
00237 <span class="comment">    its threads to terminate.</span>
00238 <span class="comment"></span>
00239 <span class="comment">Arguments:</span>
00240 <span class="comment"></span>
00241 <span class="comment">    ProcessHandle - Supplies a handle to the process to terminate.</span>
00242 <span class="comment"></span>
00243 <span class="comment">    ExitStatus - Supplies the exit status associated with the process.</span>
00244 <span class="comment"></span>
00245 <span class="comment">Return Value:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    TBD</span>
00248 <span class="comment"></span>
00249 <span class="comment">--*/</span>
00250 
00251 {
00252 
00253     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread,Self;
00254     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00255     PLIST_ENTRY Next;
00256     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st,xst;
00257     BOOLEAN ProcessHandleSpecified;
00258     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00259 
00260     Self = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00261 
00262     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ProcessHandle) ) {
00263         ProcessHandleSpecified = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00264     } <span class="keywordflow">else</span> {
00265         ProcessHandleSpecified = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00266         ProcessHandle = NtCurrentProcess();
00267     }
00268 
00269     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00270             ProcessHandle,
00271             PROCESS_TERMINATE,
00272             <a class="code" href="../../d9/d8/ntos_8h.html#a2">PsProcessType</a>,
00273             KeGetPreviousMode(),
00274             (PVOID *)&amp;Process,
00275             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00276             );
00277 
00278     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00279         <span class="keywordflow">return</span>(st);
00280     }
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// If the exit status is DBG_TERMINATE_PROCESS, then fail the terminate</span>
00284     <span class="comment">// if the process is being debugged. This is for shutdown so that we can</span>
00285     <span class="comment">// kill debuggers and not debuggees reliably</span>
00286     <span class="comment">//</span>
00287 
00288     <span class="keywordflow">if</span> ( ExitStatus == DBG_TERMINATE_PROCESS &amp;&amp; Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00289         <span class="keywordflow">if</span> ( Process-&gt;DebugPort ) {
00290             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
00291             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00292             }
00293         <span class="keywordflow">else</span> {
00294             ExitStatus = STATUS_SUCCESS;
00295             }
00296         }
00297 
00298     st = STATUS_SUCCESS;
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">// the following allows NtTerminateProcess to fail properly if</span>
00302     <span class="comment">// called while the exiting process is blocked holding the</span>
00303     <span class="comment">// createdeletelock. This can happen during debugger/server</span>
00304     <span class="comment">// lpc transactions that occur in pspexitthread</span>
00305     <span class="comment">//</span>
00306 
00307     xst = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a89">PsLockPollOnTimeout</a>);
00308 
00309     <span class="keywordflow">if</span> ( xst != STATUS_SUCCESS ) {
00310         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Process );
00311         <span class="keywordflow">return</span> STATUS_PROCESS_IS_TERMINATING;
00312         }
00313 
00314     Next = Process-&gt;ThreadListHead.Flink;
00315 
00316     <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;ThreadListHead) {
00317 
00318         Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
00319 
00320         <span class="keywordflow">if</span> ( Thread != Self ) {
00321 
00322             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00323                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00324                 <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00325                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00326             }
00327 
00328             <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
00329                 Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00330 
00331                 <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(Thread, ExitStatus);
00332                 <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00333             }
00334         }
00335         Next = Next-&gt;Flink;
00336     }
00337 
00338 
00339 
00340     <span class="keywordflow">if</span> ( Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() &amp;&amp; ProcessHandleSpecified ) {
00341 
00342         Self-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343 
00344         <span class="comment">//</span>
00345         <span class="comment">// early set of process exit time will eliminate the deadlocks</span>
00346         <span class="comment">// that occur when csrss tries to create a remote thread in a</span>
00347         <span class="comment">// process that is in the process of exiting, and that has an</span>
00348         <span class="comment">// unhandled exit call outstanding to its debugger</span>
00349         <span class="comment">//</span>
00350         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;ExitTime);
00351 
00352         <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00353 
00354         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00355 
00356         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">// Never Returns</span>
00360         <span class="comment">//</span>
00361 
00362     }
00363 
00364     <span class="comment">//</span>
00365     <span class="comment">// early set of process exit time will eliminate the deadlocks</span>
00366     <span class="comment">// that occur when csrss tries to create a remote thread in a</span>
00367     <span class="comment">// process that is in the process of exiting, and that has an</span>
00368     <span class="comment">// unhandled exit call outstanding to its debugger</span>
00369     <span class="comment">//</span>
00370     <span class="keywordflow">if</span> ( ProcessHandleSpecified ) {
00371 
00372         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;ExitTime);
00373 
00374         }
00375 
00376     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00377 
00378     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00379 
00380     <span class="keywordflow">return</span> st;
00381 }
00382 
00383 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00384"></a><a class="code" href="../../d8/d1/psp_8h.html#a94">00384</a> <a class="code" href="../../d8/d1/psp_8h.html#a94">PspTerminateProcess</a>(
00385     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00386     NTSTATUS Status,
00387     PSLOCKPROCESSMODE LockMode
00388     )
00389 
00390 <span class="comment">/*++</span>
00391 <span class="comment"></span>
00392 <span class="comment">Routine Description:</span>
00393 <span class="comment"></span>
00394 <span class="comment">    This function causes the specified process and all of</span>
00395 <span class="comment">    its threads to terminate.</span>
00396 <span class="comment"></span>
00397 <span class="comment">Arguments:</span>
00398 <span class="comment"></span>
00399 <span class="comment">    ProcessHandle - Supplies a handle to the process to terminate.</span>
00400 <span class="comment"></span>
00401 <span class="comment">    ExitStatus - Supplies the exit status associated with the process.</span>
00402 <span class="comment"></span>
00403 <span class="comment">Return Value:</span>
00404 <span class="comment"></span>
00405 <span class="comment">    TBD</span>
00406 <span class="comment"></span>
00407 <span class="comment">--*/</span>
00408 
00409 {
00410 
00411     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00412     PLIST_ENTRY Next;
00413     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00414 
00415     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00416 
00417     <span class="keywordflow">if</span> ( Process == <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() ) {
00418         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00419         }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">// the following allows NtTerminateProcess to fail properly if</span>
00423     <span class="comment">// called while the exiting process is blocked holding the</span>
00424     <span class="comment">// createdeletelock. This can happen during debugger/server</span>
00425     <span class="comment">// lpc transactions that occur in pspexitthread</span>
00426     <span class="comment">//</span>
00427 
00428     st = <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,LockMode);
00429 
00430     <span class="keywordflow">if</span> ( st != STATUS_SUCCESS ) {
00431         <span class="keywordflow">return</span> st;
00432         }
00433 
00434     Next = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink;
00435 
00436     <span class="keywordflow">while</span> ( Next != &amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>) {
00437 
00438         Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>)(CONTAINING_RECORD(Next,<a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>,ThreadListEntry));
00439 
00440         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00441             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
00442             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00443             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00444             }
00445 
00446         <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> ) {
00447             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00448             <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(Thread, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00449             <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00450             }
00451         Next = Next-&gt;Flink;
00452         }
00453 
00454     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
00455 
00456     <span class="keywordflow">return</span> STATUS_SUCCESS;
00457 }
00458 
00459 
00460 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00461"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a6">00461</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>(
00462     IN HANDLE ThreadHandle OPTIONAL,
00463     IN NTSTATUS ExitStatus
00464     )
00465 
00466 <span class="comment">/*++</span>
00467 <span class="comment"></span>
00468 <span class="comment">Routine Description:</span>
00469 <span class="comment"></span>
00470 <span class="comment">    This function causes the specified thread to terminate.</span>
00471 <span class="comment"></span>
00472 <span class="comment">Arguments:</span>
00473 <span class="comment"></span>
00474 <span class="comment">    ThreadHandle - Supplies a handle to the thread to terminate.</span>
00475 <span class="comment"></span>
00476 <span class="comment">    ExitStatus - Supplies the exit status associated with the thread.</span>
00477 <span class="comment"></span>
00478 <span class="comment">Return Value:</span>
00479 <span class="comment"></span>
00480 <span class="comment">    TBD</span>
00481 <span class="comment"></span>
00482 <span class="comment">--*/</span>
00483 
00484 {
00485 
00486     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00487     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
00488 
00489     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00490 
00491     <span class="keywordflow">if</span> ( !ARGUMENT_PRESENT(<a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>) ) {
00492         <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ThreadListHead.Flink ==
00493               <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ThreadListHead.Blink
00494              )
00495                 &amp;&amp;
00496              (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ThreadListHead.Flink ==
00497               &amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ThreadListEntry
00498              )
00499            ) {
00500             <span class="keywordflow">return</span>( STATUS_CANT_TERMINATE_SELF );
00501         } <span class="keywordflow">else</span> {
00502             <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a> = NtCurrentThread();
00503         }
00504     }
00505 
00506     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(
00507             <a class="code" href="../../d2/d1/cttoken_8c.html#a63">ThreadHandle</a>,
00508             THREAD_TERMINATE,
00509             <a class="code" href="../../d9/d8/ntos_8h.html#a3">PsThreadType</a>,
00510             KeGetPreviousMode(),
00511             (PVOID *)&amp;Thread,
00512             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00513             );
00514 
00515     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00516         <span class="keywordflow">return</span>(st);
00517     }
00518 
00519     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00520         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00521         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00522     }
00523 
00524     <span class="keywordflow">if</span> ( Thread != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() ) {
00525 
00526         <span class="keywordflow">if</span> (!Thread-&gt;HasTerminated) {
00527             <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread),<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a91">PsLockWaitForever</a>);
00528 
00529             Thread-&gt;HasTerminated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00530             st = <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(Thread,ExitStatus);
00531             <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
00532                 <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;Tcb);
00533             }
00534             <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(<a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread));
00535         }
00536     } <span class="keywordflow">else</span> {
00537         Thread-&gt;HasTerminated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00538         <a class="code" href="../../d8/d1/psp_8h.html#a69">PspTerminateThreadByPointer</a>(Thread,ExitStatus);
00539     }
00540     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
00541 
00542     <span class="keywordflow">return</span> st;
00543 }
00544 
00545 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00546"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a7">00546</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a7">PsTerminateSystemThread</a>(
00547     IN NTSTATUS ExitStatus
00548     )
00549 
00550 <span class="comment">/*++</span>
00551 <span class="comment"></span>
00552 <span class="comment">Routine Description:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    This function causes the current thread, which must be a system</span>
00555 <span class="comment">    thread, to terminate.</span>
00556 <span class="comment"></span>
00557 <span class="comment">Arguments:</span>
00558 <span class="comment"></span>
00559 <span class="comment">    ExitStatus - Supplies the exit status associated with the thread.</span>
00560 <span class="comment"></span>
00561 <span class="comment">Return Value:</span>
00562 <span class="comment"></span>
00563 <span class="comment">    None.</span>
00564 <span class="comment"></span>
00565 <span class="comment">--*/</span>
00566 
00567 {
00568     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00569 
00570     <span class="keywordflow">if</span> ( !<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00571         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00572     }
00573 
00574     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o26">HasTerminated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00575     <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00576 }
00577 
00578 
00579 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00580"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a8">00580</a> <a class="code" href="../../d8/d1/psp_8h.html#a67">PspNullSpecialApc</a>(
00581     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00582     IN PKNORMAL_ROUTINE *NormalRoutine,
00583     IN PVOID *NormalContext,
00584     IN PVOID *SystemArgument1,
00585     IN PVOID *SystemArgument2
00586     )
00587 
00588 {
00589 
00590     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00591 
00592     UNREFERENCED_PARAMETER(NormalContext);
00593     UNREFERENCED_PARAMETER(SystemArgument1);
00594     UNREFERENCED_PARAMETER(SystemArgument2);
00595 
00596     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;HasTerminated ) {
00597         *NormalRoutine = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00598     }
00599     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00600 }
00601 
00602 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00603"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a9">00603</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a9">PsExitSpecialApc</a>(
00604     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00605     IN PKNORMAL_ROUTINE *NormalRoutine,
00606     IN PVOID *NormalContext,
00607     IN PVOID *SystemArgument1,
00608     IN PVOID *SystemArgument2
00609     )
00610 
00611 {
00612     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExitStatus;
00613 
00614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00615 
00616     UNREFERENCED_PARAMETER(NormalRoutine);
00617     UNREFERENCED_PARAMETER(NormalContext);
00618     UNREFERENCED_PARAMETER(SystemArgument1);
00619     UNREFERENCED_PARAMETER(SystemArgument2);
00620 
00621     <span class="keywordflow">if</span> ( Apc-&gt;SystemArgument2 ) {
00622         ExitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)((LONG_PTR)Apc-&gt;NormalContext);
00623         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00624         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00625     }
00626 
00627 }
00628 
00629 
00630 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00631"></a><a class="code" href="../../d8/d1/psp_8h.html#a75">00631</a> <a class="code" href="../../d8/d1/psp_8h.html#a75">PspExitNormalApc</a>(
00632     IN PVOID NormalContext,
00633     IN PVOID SystemArgument1,
00634     IN PVOID SystemArgument2
00635     )
00636 
00637 {
00638     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00639     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> ExitApc;
00640     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExitStatus;
00641 
00642     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00643 
00644     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00645 
00646     <span class="keywordflow">if</span> ( SystemArgument2 ) {
00647         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(0x12345678);
00648     }
00649 
00650     ExitApc = (<a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a>) SystemArgument1;
00651 
00652     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00653         ExitStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>)((LONG_PTR)ExitApc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o8">NormalContext</a>);
00654         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00655         <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(ExitStatus);
00656     } <span class="keywordflow">else</span> {
00657 
00658         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(
00659             ExitApc,
00660             &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
00661             <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00662             <a class="code" href="../../d1/d9/ps_8h.html#a117">PsExitSpecialApc</a>,
00663             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00664             <a class="code" href="../../d8/d0/psdelete_8c.html#a10">PspExitNormalApc</a>,
00665             <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00666             NormalContext
00667             );
00668 
00669         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(ExitApc,ExitApc,(PVOID) 1, 2) ) {
00670             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ExitApc);
00671         }
00672 
00673         <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00674     }
00675 }
00676 
00677 
00678 BOOLEAN
<a name="l00679"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a11">00679</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a11">PspMarkCidInvalid</a>(
00680     IN <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> HandleEntry,
00681     IN ULONG_PTR Parameter
00682     )
00683 {
00684     HandleEntry-&gt;Object = (PVOID)Parameter;
00685     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00686 }
00687 
00688 DECLSPEC_NORETURN
00689 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00690"></a><a class="code" href="../../d8/d1/psp_8h.html#a68">00690</a> <a class="code" href="../../d8/d1/psp_8h.html#a68">PspExitThread</a>(
00691     IN NTSTATUS ExitStatus
00692     )
00693 
00694 <span class="comment">/*++</span>
00695 <span class="comment"></span>
00696 <span class="comment">Routine Description:</span>
00697 <span class="comment"></span>
00698 <span class="comment">    This function causes the currently executing thread to terminate.  This</span>
00699 <span class="comment">    function is only called from within the process structure.  It is called</span>
00700 <span class="comment">    either from mainline exit code to exit the current thread, or from</span>
00701 <span class="comment">    PsExitSpecialApc (as a piggyback to user-mode PspExitNormalApc).</span>
00702 <span class="comment"></span>
00703 <span class="comment">Arguments:</span>
00704 <span class="comment"></span>
00705 <span class="comment">    ExitStatus - Supplies the exit status associated with the current thread.</span>
00706 <span class="comment"></span>
00707 <span class="comment">Return Value:</span>
00708 <span class="comment"></span>
00709 <span class="comment">    None.</span>
00710 <span class="comment"></span>
00711 <span class="comment">--*/</span>
00712 
00713 
00714 {
00715 
00716     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00717     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00718     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00719     PLIST_ENTRY FirstEntry;
00720     PLIST_ENTRY NextEntry;
00721     <a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">PTERMINATION_PORT</a> TerminationPort;
00722     LPC_CLIENT_DIED_MSG CdMsg;
00723     BOOLEAN LastThread;
00724 
00725     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00726 
00727     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00728     Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
00729 
00730     <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d9/ke_8h.html#a25">KeIsAttachedProcess</a>() ) {
00731         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
00732             INVALID_PROCESS_ATTACH_ATTEMPT,
00733             (ULONG_PTR)Process,
00734             (ULONG_PTR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>,
00735             (ULONG)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o58">ApcStateIndex</a>,
00736             (ULONG_PTR)Thread
00737             );
00738         }
00739 
00740     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(<a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>);
00741 
00742     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> &lt; LOW_REALTIME_PRIORITY) {
00743         <a class="code" href="../../d9/d1/thredobj_8c.html#a24">KeSetPriorityThread</a> (&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>, LOW_REALTIME_PRIORITY);
00744     }
00745 
00746     <span class="comment">//</span>
00747     <span class="comment">// Clear any execution state associated with the thread</span>
00748     <span class="comment">//</span>
00749 
00750     <a class="code" href="../../d1/d2/po_8h.html#a6">PoRundownThread</a>(Thread);
00751 
00752     <span class="comment">//</span>
00753     <span class="comment">// Account for a miss where we try to freeze a thread and bump the</span>
00754     <span class="comment">// freeze count, but in the freeze APC we bail from the APC due to the</span>
00755     <span class="comment">// pending exit APC. This results in an active thread running with a biased</span>
00756     <span class="comment">// freeze count and no pending APC. When this sort of thread tries to grab the</span>
00757     <span class="comment">// process lock, it ends of spinning since it things a freeze is pending and</span>
00758     <span class="comment">// an APC should occur.</span>
00759     <span class="comment">//</span>
00760     <span class="comment">// Wait mode of UserMode allows the kernel stack to page out if necessary</span>
00761     <span class="comment">//</span>
00762 
00763     <a class="code" href="../../d2/d8/ps_2create_8c.html#a22">PsLockProcess</a>(Process,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,<a class="code" href="../../d1/d9/ps_8h.html#a155a92">PsLockIAmExiting</a>);
00764     <a class="code" href="../../d9/d1/thredobj_8c.html#a8">KeForceResumeThread</a> (&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Notify registered callout routines of thread deletion.</span>
00768     <span class="comment">//</span>
00769 
00770     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a23">PspCreateThreadNotifyRoutineCount</a> != 0) {
00771         ULONG i;
00772 
00773         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a6">PSP_MAX_CREATE_THREAD_NOTIFY</a>; i++) {
00774             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00775                 (*<a class="code" href="../../d8/d1/psp_8h.html#a24">PspCreateThreadNotifyRoutine</a>[i])(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>,
00776                                                    Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread,
00777                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00778                                                    );
00779             }
00780         }
00781     }
00782 
00783     LastThread = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00784 
00785     <span class="keywordflow">if</span> ( (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink == Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Blink)
00786          &amp;&amp; (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o87">ThreadListHead</a>.Flink == &amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>) ) {
00787         LastThread = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00788         <span class="keywordflow">if</span> ( ExitStatus == STATUS_THREAD_IS_TERMINATING ) {
00789             <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> == STATUS_PENDING ) {
00790                 Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o50">LastThreadExitStatus</a>;
00791             }
00792         } <span class="keywordflow">else</span> {
00793             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o1">ExitStatus</a> = ExitStatus;
00794         }
00795 
00796         <a class="code" href="../../d4/d3/dbgk_8h.html#a2">DbgkExitProcess</a>(ExitStatus);
00797 
00798     } <span class="keywordflow">else</span> {
00799         <span class="keywordflow">if</span> ( ExitStatus != STATUS_THREAD_IS_TERMINATING ) {
00800             Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o50">LastThreadExitStatus</a> = ExitStatus;
00801         }
00802 
00803         <a class="code" href="../../d4/d3/dbgk_8h.html#a1">DbgkExitThread</a>(ExitStatus);
00804     }
00805 
00806     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00807     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0);
00808 
00809     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> = 0;
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">// Process the TerminationPortList</span>
00813     <span class="comment">//</span>
00814     <span class="keywordflow">if</span> ( !IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>) ) {
00815 
00816         CdMsg.PortMsg.u1.s1.DataLength = <span class="keyword">sizeof</span>(LARGE_INTEGER);
00817         CdMsg.PortMsg.u1.s1.TotalLength = <span class="keyword">sizeof</span>(LPC_CLIENT_DIED_MSG);
00818         CdMsg.PortMsg.u2.s2.Type = LPC_CLIENT_DIED;
00819         CdMsg.PortMsg.u2.s2.DataInfoOffset = 0;
00820 
00821         <span class="keywordflow">while</span> ( !IsListEmpty(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>) ) {
00822 
00823             NextEntry = RemoveHeadList(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o9">TerminationPortList</a>);
00824             TerminationPort = CONTAINING_RECORD(NextEntry,<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">TERMINATION_PORT</a>,Links);
00825             CdMsg.CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a>(Thread);
00826             <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>(TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o1">Port</a>, (PPORT_MESSAGE)&amp;CdMsg);
00827             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o1">Port</a>);
00828             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(TerminationPort);
00829         }
00830     } <span class="keywordflow">else</span> {
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">// If there are no ports to send notifications to,</span>
00834         <span class="comment">// but there is an exception port, then we have to</span>
00835         <span class="comment">// send a client died message through the exception</span>
00836         <span class="comment">// port. This will allow a server a chance to get notification</span>
00837         <span class="comment">// if an app/thread dies before it even starts</span>
00838         <span class="comment">//</span>
00839         <span class="comment">//</span>
00840         <span class="comment">// We only send the exception if the thread creation really worked.</span>
00841         <span class="comment">// DeadThread is set when an NtCreateThread returns an error, but</span>
00842         <span class="comment">// the thread will actually execute this path. If DeadThread is not</span>
00843         <span class="comment">// set than the thread creation succeeded. The other place DeadThread</span>
00844         <span class="comment">// is set is when we were terminated without having any chance to move.</span>
00845         <span class="comment">// in this case, DeadThread is set and the exit status is set to</span>
00846         <span class="comment">// STATUS_THREAD_IS_TERMINATING</span>
00847         <span class="comment">//</span>
00848 
00849         <span class="keywordflow">if</span> ( (ExitStatus == STATUS_THREAD_IS_TERMINATING &amp;&amp; Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a>) ||
00850              !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o24">DeadThread</a> ) {
00851 
00852             CdMsg.PortMsg.u1.s1.DataLength = <span class="keyword">sizeof</span>(LARGE_INTEGER);
00853             CdMsg.PortMsg.u1.s1.TotalLength = <span class="keyword">sizeof</span>(LPC_CLIENT_DIED_MSG);
00854             CdMsg.PortMsg.u2.s2.Type = LPC_CLIENT_DIED;
00855             CdMsg.PortMsg.u2.s2.DataInfoOffset = 0;
00856             <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExceptionPort ) {
00857                 CdMsg.CreateTime.QuadPart = <a class="code" href="../../d1/d9/ps_8h.html#a15">PS_GET_THREAD_CREATE_TIME</a>(Thread);
00858                 <a class="code" href="../../d6/d7/lpcsend_8c.html#a2">LpcRequestPort</a>(<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExceptionPort, (PPORT_MESSAGE)&amp;CdMsg);
00859                 }
00860             }
00861     }
00862 
00863     <span class="comment">//</span>
00864     <span class="comment">// rundown the Win32 structures</span>
00865     <span class="comment">//</span>
00866 
00867     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a> ) {
00868         (<a class="code" href="../../d8/d1/psp_8h.html#a40">PspW32ThreadCallout</a>)(Thread,<a class="code" href="../../d1/d9/ps_8h.html#a157a97">PsW32ThreadCalloutExit</a>);
00869         }
00870 
00871     <span class="keywordflow">if</span> ( LastThread &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a> ) {
00872         (<a class="code" href="../../d8/d1/psp_8h.html#a39">PspW32ProcessCallout</a>)(Process,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00873         }
00874 
00875     <span class="comment">//</span>
00876     <span class="comment">// User/Gdi has been given a chance to clean up. Now make sure they didn't</span>
00877     <span class="comment">// leave the kernel stack locked which would happen if data was still live on</span>
00878     <span class="comment">// this stack, but was being used by another thread</span>
00879     <span class="comment">//</span>
00880 
00881     <span class="keywordflow">if</span> ( !Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o51">EnableStackSwap</a> ) {
00882         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(KERNEL_STACK_LOCKED_AT_EXIT,0,0,0,0);
00883         }
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">// Delete the thread's TEB.  If the address of the TEB is in user</span>
00887     <span class="comment">// space, then this is a real user mode TEB.  If the address is in</span>
00888     <span class="comment">// system space, then this is a special system thread TEB allocated</span>
00889     <span class="comment">// from paged or nonpaged pool.</span>
00890     <span class="comment">//</span>
00891 
00892 
00893     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>) {
00894         <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread) ) {
00895             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a> );
00896         } <span class="keywordflow">else</span> {
00897 
00898             <span class="comment">//</span>
00899             <span class="comment">// The thread is a user-mode thread. Look to see if the thread</span>
00900             <span class="comment">// owns the loader lock (and any other key peb-based critical</span>
00901             <span class="comment">// sections. If so, do our best to release the locks.</span>
00902             <span class="comment">//</span>
00903             <span class="comment">// Since the LoaderLock used to be a mutant, releasing the lock</span>
00904             <span class="comment">// like this is very similar to mutant abandonment and the loader</span>
00905             <span class="comment">// never did anything with abandoned status anyway</span>
00906             <span class="comment">//</span>
00907 
00908             <span class="keywordflow">try</span> {
00909                 PTEB Teb;
00910                 PPEB Peb;
00911                 PRTL_CRITICAL_SECTION Cs;
00912                 <span class="keywordtype">int</span> DecrementCount;
00913 
00914                 Teb = Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>;
00915                 Peb = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o47">Peb</a>;
00916 
00917                 Cs = Peb-&gt;LoaderLock;
00918                 <span class="keywordflow">if</span> ( Cs ) {
00919                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Cs,<span class="keyword">sizeof</span>(*Cs),4);
00920                     <span class="keywordflow">if</span> ( Cs-&gt;OwningThread == Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ) {
00921 
00922                         <span class="comment">//</span>
00923                         <span class="comment">// x86 uses a 1 based recursion count</span>
00924                         <span class="comment">//</span>
00925 
00926 <span class="preprocessor">#if defined(_X86_)</span>
00927 <span class="preprocessor"></span>                        DecrementCount = Cs-&gt;RecursionCount;
00928 <span class="preprocessor">#else</span>
00929 <span class="preprocessor"></span>                        DecrementCount = Cs-&gt;RecursionCount + 1;
00930 <span class="preprocessor">#endif</span>
00931 <span class="preprocessor"></span>                        Cs-&gt;RecursionCount = 0;
00932                         Cs-&gt;OwningThread = 0;
00933 
00934                         <span class="comment">//</span>
00935                         <span class="comment">// undo lock count increments for recursion cases</span>
00936                         <span class="comment">//</span>
00937 
00938                         <span class="keywordflow">while</span>(DecrementCount &gt; 1){
00939                             InterlockedDecrement(&amp;Cs-&gt;LockCount);
00940                             DecrementCount--;
00941                             }
00942 
00943                         <span class="comment">//</span>
00944                         <span class="comment">// undo final lock count</span>
00945                         <span class="comment">//</span>
00946 
00947                         <span class="keywordflow">if</span> ( InterlockedDecrement(&amp;Cs-&gt;LockCount) &gt;= 0 ){
00948                             <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(Cs-&gt;LockSemaphore,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00949                             }
00950                         }
00951 
00952                     <span class="comment">//</span>
00953                     <span class="comment">// if the thread exited while waiting on the loader</span>
00954                     <span class="comment">// lock clean it up. There is still a potential race</span>
00955                     <span class="comment">// here since we can not safely know what happens to</span>
00956                     <span class="comment">// a thread after it interlocked increments the lock count</span>
00957                     <span class="comment">// but before it sets the waiting on loader lock flag. On the</span>
00958                     <span class="comment">// release side, it it safe since we mark ownership of the lock</span>
00959                     <span class="comment">// before clearing the flag. This triggers the first part of this</span>
00960                     <span class="comment">// test. The only thing out of whack is the recursion count, but this</span>
00961                     <span class="comment">// is also safe since in this state, recursion count is 0.</span>
00962                     <span class="comment">//</span>
00963 
00964                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Teb-&gt;WaitingOnLoaderLock ) {
00965 
00966                         <span class="comment">//</span>
00967                         <span class="comment">// This code isn't right. We need to bump down our lock count</span>
00968                         <span class="comment">// increment.</span>
00969                         <span class="comment">//</span>
00970                         <span class="comment">// A few cases to consider:</span>
00971                         <span class="comment">//</span>
00972                         <span class="comment">// Another thread releases the lock signals the event.</span>
00973                         <span class="comment">// We take the wait and then die before setting our ID.</span>
00974                         <span class="comment">// I doubt very much that this can happen because right</span>
00975                         <span class="comment">// after we come out of the wait, we set the owner Id</span>
00976                         <span class="comment">// (meaning that we would go through the other part of the if).</span>
00977                         <span class="comment">// Bottom line is that we should just decrement our lock count</span>
00978                         <span class="comment">// and get out of the way. There is no need to set the event.</span>
00979                         <span class="comment">// In the RAS stress failure, I saw us setting the event</span>
00980                         <span class="comment">// just because the lock count was &gt;= 0. The lock was already held</span>
00981                         <span class="comment">// by another thread so setting the event let yet another thread</span>
00982                         <span class="comment">// also own the lock. Last one to release would get a</span>
00983                         <span class="comment">// not owner critical section failure</span>
00984                         <span class="comment">//</span>
00985                         <span class="comment">//</span>
00986                         <span class="comment">// if ( InterlockedDecrement(&amp;Cs-&gt;LockCount) &gt;= 0 ){</span>
00987                         <span class="comment">//     NtSetEvent(Cs-&gt;LockSemaphore,NULL);</span>
00988                         <span class="comment">//     }</span>
00989                         <span class="comment">//</span>
00990 
00991                         InterlockedDecrement(&amp;Cs-&gt;LockCount);
00992                         }
00993                     }
00994 <span class="preprocessor">#if defined(_WIN64)</span>
00995 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>) {
00996                         <span class="comment">// Do the same thing for the 32-bit PEB-&gt;Ldr</span>
00997                         PRTL_CRITICAL_SECTION32 Cs32;
00998                         PPEB32 Peb32;
00999 
01000                         Peb32 = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>-&gt;<a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html#o0">Wow64</a>;
01001                         Cs32 = (PRTL_CRITICAL_SECTION32)ULongToPtr(Peb32-&gt;LoaderLock);
01002                         <span class="keywordflow">if</span> (Cs32) {
01003                             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Cs32,<span class="keyword">sizeof</span>(*Cs32),4);
01004                             <span class="keywordflow">if</span> ( Cs32-&gt;OwningThread == PtrToUlong(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread) ) {
01005                                 <span class="comment">//</span>
01006                                 <span class="comment">// x86 uses a 1 based recursion count, so the</span>
01007                                 <span class="comment">// IA64 kernel needs to do the same, since</span>
01008                                 <span class="comment">// the critsect is really implemented by IA32</span>
01009                                 <span class="comment">// usermode.</span>
01010                                 <span class="comment">//</span>
01011                                 DecrementCount = Cs32-&gt;RecursionCount;
01012                                 Cs32-&gt;RecursionCount = 0;
01013                                 Cs32-&gt;OwningThread = 0;
01014 
01015                                 <span class="comment">//</span>
01016                                 <span class="comment">// undo lock count increments for recursion cases</span>
01017                                 <span class="comment">//</span>
01018                                 <span class="keywordflow">while</span>(DecrementCount &gt; 1) {
01019                                     InterlockedDecrement(&amp;Cs32-&gt;LockCount);
01020                                     DecrementCount--;
01021                                 }
01022 
01023                                 <span class="comment">//</span>
01024                                 <span class="comment">// undo final lock count</span>
01025                                 <span class="comment">//</span>
01026                                 <span class="keywordflow">if</span> ( InterlockedDecrement(&amp;Cs32-&gt;LockCount) &gt;= 0 ){
01027                                     <a class="code" href="../../d0/d8/ex_2event_8c.html#a10">NtSetEvent</a>(LongToHandle(Cs32-&gt;LockSemaphore),<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01028                                 }
01029                             } <span class="keywordflow">else</span> {
01030                                 PTEB32 Teb32 = WOW64_GET_TEB32(Teb);
01031 
01032                                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(Teb32,<span class="keyword">sizeof</span>(*Teb32),4);
01033                                 <span class="keywordflow">if</span> ( Teb32-&gt;WaitingOnLoaderLock ) {
01034                                     InterlockedDecrement(&amp;Cs32-&gt;LockCount);
01035                                 }
01036                             }
01037                         }
01038                     }
01039 <span class="preprocessor">#endif</span>
01040 <span class="preprocessor"></span>                }
01041             except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01042                 ;
01043                 }
01044 
01045 <span class="preprocessor">#if defined(_WIN64)</span>
01046 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>) {
01047                 <span class="comment">//</span>
01048                 <span class="comment">// Free the 32 bit Teb</span>
01049                 <span class="comment">//</span>
01050                 <span class="keywordflow">try</span> {
01051                     PVOID BaseAddress;
01052                     SIZE_T RegionSize;
01053 
01054                     <span class="comment">// Get the TEB32 pointer</span>
01055                     BaseAddress = *(PVOID *)WOW64_TEB32_POINTER_ADDRESS(((PTEB)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>));
01056 
01057                     <span class="comment">// Free it.  ZwFreeVirtualMemory will probe the address</span>
01058                     <span class="comment">// for us, ensuring that it is in usermode memory.</span>
01059                     RegionSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01060                     ZwFreeVirtualMemory( NtCurrentProcess(),
01061                                          &amp;BaseAddress,
01062                                          &amp;RegionSize,
01063                                          MEM_RELEASE
01064                                        );
01065 
01066                     }
01067                 except (<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01068                     ;
01069                     }
01070             }
01071 <span class="preprocessor">#endif</span>
01072 <span class="preprocessor"></span>
01073             <a class="code" href="../../d4/d5/procsup_8c.html#a42">MmDeleteTeb</a>(Process, Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a>);
01074             Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o4">Teb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01075         }
01076     }
01077 
01078     <span class="comment">//</span>
01079     <span class="comment">// Rundown The Lists:</span>
01080     <span class="comment">//</span>
01081     <span class="comment">//      - Cancel Io By Thread</span>
01082     <span class="comment">//      - Cancel Timers</span>
01083     <span class="comment">//      - Cancel Registry Notify Requests pending against this thread</span>
01084     <span class="comment">//      - Perform kernel thread rundown</span>
01085     <span class="comment">//</span>
01086 
01087     <a class="code" href="../../d4/d6/iosubs_8c.html#a31">IoCancelThreadIo</a>(Thread);
01088     <a class="code" href="../../d2/d2/timer_8c.html#a10">ExTimerRundown</a>();
01089     <a class="code" href="../../d7/d9/cm_8h.html#a32">CmNotifyRunDown</a>(Thread);
01090     <a class="code" href="../../d9/d1/thredobj_8c.html#a17">KeRundownThread</a>();
01091 
01092     <span class="comment">//</span>
01093     <span class="comment">// delete the Client Id and decrement the reference count for it.</span>
01094     <span class="comment">//</span>
01095 
01096     <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>, Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread, <a class="code" href="../../d8/d0/psdelete_8c.html#a11">PspMarkCidInvalid</a>, <a class="code" href="../../d1/d9/ps_8h.html#a0">PSP_INVALID_ID</a>))) {
01097         <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01098     }
01099     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Thread);
01100 
01101     <span class="comment">//</span>
01102     <span class="comment">// Let LPC component deal with message stack in Thread-&gt;LpcReplyMessage</span>
01103     <span class="comment">// but do it after the client ID becomes invalid.</span>
01104     <span class="comment">//</span>
01105 
01106     <a class="code" href="../../d3/d6/lpcclose_8c.html#a2">LpcExitThread</a>(Thread);
01107 
01108     <span class="comment">//</span>
01109     <span class="comment">// If this is the last thread in the process, then clean the address space</span>
01110     <span class="comment">//</span>
01111 
01112     <span class="keywordflow">if</span> ( LastThread ) {
01113         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a298">ExChangeHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>,Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o7">UniqueProcessId</a>, <a class="code" href="../../d8/d0/psdelete_8c.html#a11">PspMarkCidInvalid</a>, <a class="code" href="../../d1/d9/ps_8h.html#a0">PSP_INVALID_ID</a>))) {
01114             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01115         }
01116         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o5">ExitTime</a>);
01117         <a class="code" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,Process);
01118     }
01119 
01120 
01121     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o6">ExitStatus</a> = ExitStatus;
01122     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o4">ExitTime</a>);
01123 
01124 
01125     RemoveEntryList(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>);
01126     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01127 
01128     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01129     Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o37">ThreadListEntry</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01130 
01131     <a class="code" href="../../d2/d8/ps_2create_8c.html#a23">PsUnlockProcess</a>(Process);
01132     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a> == 0);
01133 
01134     <span class="keywordflow">if</span> ( LastThread ) {
01135 
01136         <span class="comment">//</span>
01137         <span class="comment">// can not hold the process lock while running down the object table</span>
01138         <span class="comment">// since this can lead to a delete routine, which will need the job</span>
01139         <span class="comment">// lock, BUT our lock ordering is always joblock -&gt; processlock</span>
01140         <span class="comment">//</span>
01141 
01142         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, Process);
01143 
01144         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>) {
01145 
01146             <span class="comment">//</span>
01147             <span class="comment">// Now we can fold the process accounting into the job. Don't need to wait for</span>
01148             <span class="comment">// the delete routine.</span>
01149             <span class="comment">//</span>
01150 
01151             <a class="code" href="../../d8/d1/psp_8h.html#a93">PspExitProcessFromJob</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>,Process);
01152 
01153             }
01154 
01155         <a class="code" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a>(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01156 
01157         }
01158 
01159     <span class="comment">//</span>
01160     <span class="comment">// Rundown pending APCs</span>
01161     <span class="comment">//</span>
01162 
01163     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d9/d1/thredobj_8c.html#a6">KeDisableApcQueuingThread</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
01164 
01165     <span class="comment">//</span>
01166     <span class="comment">// flush user-mode APC queue</span>
01167     <span class="comment">//</span>
01168 
01169     FirstEntry = <a class="code" href="../../d5/d7/apcobj_8c.html#a2">KeFlushQueueApc</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,<a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
01170 
01171     <span class="keywordflow">if</span> ( FirstEntry ) {
01172 
01173         NextEntry = FirstEntry;
01174         <span class="keywordflow">do</span> {
01175             Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
01176             NextEntry = NextEntry-&gt;Flink;
01177 
01178             <span class="comment">//</span>
01179             <span class="comment">// If the APC has a rundown routine then call it. Otherwise</span>
01180             <span class="comment">// deallocate the APC</span>
01181             <span class="comment">//</span>
01182 
01183             <span class="keywordflow">if</span> ( Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o6">RundownRoutine</a> ) {
01184                 (Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o6">RundownRoutine</a>)(Apc);
01185             } <span class="keywordflow">else</span> {
01186                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
01187             }
01188 
01189         } <span class="keywordflow">while</span> (NextEntry != FirstEntry);
01190     }
01191 
01192     <span class="keywordflow">if</span> ( LastThread ) {
01193         <a class="code" href="../../d4/d5/procsup_8c.html#a32">MmCleanProcessAddressSpace</a>();
01194     }
01195 
01196     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o29">LegoData</a> &amp;&amp; <a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a> ) {
01197         (<a class="code" href="../../d8/d0/psdelete_8c.html#a0">PspLegoNotifyRoutine</a>)(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>);
01198         }
01199 
01200     <span class="comment">//</span>
01201     <span class="comment">// flush kernel-mode APC queue</span>
01202     <span class="comment">// There should never be any kernel mode APCs found this far</span>
01203     <span class="comment">// into thread termination. Since we go to PASSIVE_LEVEL upon</span>
01204     <span class="comment">// entering exit.</span>
01205     <span class="comment">//</span>
01206 
01207     FirstEntry = <a class="code" href="../../d5/d7/apcobj_8c.html#a2">KeFlushQueueApc</a>(&amp;Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>);
01208 
01209     <span class="keywordflow">if</span> ( FirstEntry ) {
01210         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(
01211             KERNEL_APC_PENDING_DURING_EXIT,
01212             (ULONG_PTR)FirstEntry,
01213             (ULONG_PTR)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o30">KernelApcDisable</a>,
01214             (ULONG_PTR)KeGetCurrentIrql(),
01215             0
01216             );
01217     }
01218 
01219     <span class="comment">//</span>
01220     <span class="comment">// Terminate the thread.</span>
01221     <span class="comment">//</span>
01222     <span class="comment">// N.B. There is no return from this call.</span>
01223     <span class="comment">//</span>
01224     <span class="comment">// N.B. The kernel inserts the current thread in the reaper list and</span>
01225     <span class="comment">//      activates a thread, if necessary, to reap the terminating thread.</span>
01226     <span class="comment">//</span>
01227 
01228     <a class="code" href="../../d9/d1/thredobj_8c.html#a26">KeTerminateThread</a>(0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01229 }
01230 
01231 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01232"></a><a class="code" href="../../d8/d1/psp_8h.html#a71">01232</a> <a class="code" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a>(
01233     IN BOOLEAN TrimAddressSpace,
01234     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01235     )
01236 {
01237 
01238     ULONG ActualTime;
01239 
01240     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01241 
01242     <span class="keywordflow">if</span> (!Process-&gt;ExitProcessCalled &amp;&amp; <a class="code" href="../../d8/d1/psp_8h.html#a21">PspCreateProcessNotifyRoutineCount</a> != 0) {
01243         ULONG i;
01244 
01245         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/d1/psp_8h.html#a5">PSP_MAX_CREATE_PROCESS_NOTIFY</a>; i++) {
01246             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i] != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01247                 (*<a class="code" href="../../d8/d1/psp_8h.html#a22">PspCreateProcessNotifyRoutine</a>[i])( Process-&gt;InheritedFromUniqueProcessId,
01248                                                      Process-&gt;UniqueProcessId,
01249                                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01250                                                    );
01251             }
01252         }
01253     }
01254 
01255     Process-&gt;ExitProcessCalled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01256 
01257     <a class="code" href="../../d1/d2/po_8h.html#a7">PoRundownProcess</a>(Process);
01258 
01259     <span class="comment">//</span>
01260     <span class="comment">// If the process is on the active list, remove it now. Must be done before ObKill</span>
01261     <span class="comment">// due to code in ex\sysinfo that references the process through the handle table</span>
01262     <span class="comment">//</span>
01263 
01264     <span class="keywordflow">if</span> ( Process-&gt;ActiveProcessLinks.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01265          Process-&gt;ActiveProcessLinks.Blink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01266 
01267         ExAcquireFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
01268         RemoveEntryList(&amp;Process-&gt;ActiveProcessLinks);
01269         Process-&gt;ActiveProcessLinks.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01270         Process-&gt;ActiveProcessLinks.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01271         ExReleaseFastMutex(&amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a25">PspActiveProcessMutex</a>);
01272 
01273     }
01274 
01275     <span class="keywordflow">if</span> (Process-&gt;SecurityPort) {
01276 
01277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;SecurityPort);
01278 
01279         Process-&gt;SecurityPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ;
01280     }
01281 
01282 
01283     <span class="keywordflow">if</span> ( TrimAddressSpace ) {
01284 
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">// If the current process has previously set the timer resolution,</span>
01288         <span class="comment">// then reset it.</span>
01289         <span class="comment">//</span>
01290 
01291         <span class="keywordflow">if</span> (Process-&gt;SetTimerResolution != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01292             ZwSetTimerResolution(<a class="code" href="../../d4/d9/ke_8h.html#a131">KeMaximumIncrement</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;ActualTime);
01293         }
01294 
01295         <span class="keywordflow">if</span> ( Process-&gt;Job
01296              &amp;&amp; Process-&gt;Job-&gt;CompletionPort
01297              &amp;&amp; !(Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a9">PS_JOB_STATUS_NOT_REALLY_ACTIVE</a>)
01298              &amp;&amp; !(Process-&gt;JobStatus &amp; <a class="code" href="../../d1/d9/ps_8h.html#a12">PS_JOB_STATUS_EXIT_PROCESS_REPORTED</a>)) {
01299 
01300             ULONG_PTR ExitMessageId;
01301 
01302             <span class="keywordflow">switch</span> (Process-&gt;ExitStatus) {
01303                 <span class="keywordflow">case</span> STATUS_GUARD_PAGE_VIOLATION      :
01304                 <span class="keywordflow">case</span> STATUS_DATATYPE_MISALIGNMENT     :
01305                 <span class="keywordflow">case</span> STATUS_BREAKPOINT                :
01306                 <span class="keywordflow">case</span> STATUS_SINGLE_STEP               :
01307                 <span class="keywordflow">case</span> STATUS_ACCESS_VIOLATION          :
01308                 <span class="keywordflow">case</span> STATUS_IN_PAGE_ERROR             :
01309                 <span class="keywordflow">case</span> STATUS_ILLEGAL_INSTRUCTION       :
01310                 <span class="keywordflow">case</span> STATUS_NONCONTINUABLE_EXCEPTION  :
01311                 <span class="keywordflow">case</span> STATUS_INVALID_DISPOSITION       :
01312                 <span class="keywordflow">case</span> STATUS_ARRAY_BOUNDS_EXCEEDED     :
01313                 <span class="keywordflow">case</span> STATUS_FLOAT_DENORMAL_OPERAND    :
01314                 <span class="keywordflow">case</span> STATUS_FLOAT_DIVIDE_BY_ZERO      :
01315                 <span class="keywordflow">case</span> STATUS_FLOAT_INEXACT_RESULT      :
01316                 <span class="keywordflow">case</span> STATUS_FLOAT_INVALID_OPERATION   :
01317                 <span class="keywordflow">case</span> STATUS_FLOAT_OVERFLOW            :
01318                 <span class="keywordflow">case</span> STATUS_FLOAT_STACK_CHECK         :
01319                 <span class="keywordflow">case</span> STATUS_FLOAT_UNDERFLOW           :
01320                 <span class="keywordflow">case</span> STATUS_INTEGER_DIVIDE_BY_ZERO    :
01321                 <span class="keywordflow">case</span> STATUS_INTEGER_OVERFLOW          :
01322                 <span class="keywordflow">case</span> STATUS_PRIVILEGED_INSTRUCTION    :
01323                 <span class="keywordflow">case</span> STATUS_STACK_OVERFLOW            :
01324                 <span class="keywordflow">case</span> STATUS_CONTROL_C_EXIT            :
01325                 <span class="keywordflow">case</span> STATUS_FLOAT_MULTIPLE_FAULTS     :
01326                 <span class="keywordflow">case</span> STATUS_FLOAT_MULTIPLE_TRAPS      :
01327                 <span class="keywordflow">case</span> STATUS_REG_NAT_CONSUMPTION       :
01328                     ExitMessageId = JOB_OBJECT_MSG_ABNORMAL_EXIT_PROCESS;
01329                     <span class="keywordflow">break</span>;
01330                 <span class="keywordflow">default</span>:
01331                     ExitMessageId = JOB_OBJECT_MSG_EXIT_PROCESS;
01332                     <span class="keywordflow">break</span>;
01333                 }
01334 
01335             <a class="code" href="../../d1/d9/ps_8h.html#a8">PS_SET_CLEAR_BITS</a> (&amp;Process-&gt;JobStatus,
01336                                <a class="code" href="../../d1/d9/ps_8h.html#a12">PS_JOB_STATUS_EXIT_PROCESS_REPORTED</a>,
01337                                <a class="code" href="../../d1/d9/ps_8h.html#a14">PS_JOB_STATUS_LAST_REPORT_MEMORY</a>);
01338 
01339             ExAcquireFastMutex(&amp;Process-&gt;Job-&gt;MemoryLimitsLock);
01340 
01341             <span class="keywordflow">if</span> (Process-&gt;Job-&gt;CompletionPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01342                 <a class="code" href="../../d5/d4/complete_8c.html#a6">IoSetIoCompletion</a>(
01343                     Process-&gt;Job-&gt;CompletionPort,
01344                     Process-&gt;Job-&gt;CompletionKey,
01345                     (PVOID)Process-&gt;UniqueProcessId,
01346                     STATUS_SUCCESS,
01347                     ExitMessageId,
01348                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01349                     );
01350             }
01351             ExReleaseFastMutex(&amp;Process-&gt;Job-&gt;MemoryLimitsLock);
01352             }
01353 
01354     } <span class="keywordflow">else</span> {
01355         <a class="code" href="../../d3/d5/procobj_8c.html#a10">KeSetProcess</a>(&amp;Process-&gt;Pcb,0,<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01356         <a class="code" href="../../d0/d1/obinit_8c.html#a23">ObKillProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, Process);
01357         <a class="code" href="../../d4/d5/procsup_8c.html#a32">MmCleanProcessAddressSpace</a>();
01358     }
01359 
01360 }
01361 
01362 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01363"></a><a class="code" href="../../d8/d1/psp_8h.html#a50">01363</a> <a class="code" href="../../d8/d1/psp_8h.html#a50">PspProcessDelete</a>(
01364     IN PVOID Object
01365     )
01366 {
01367     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01368     ULONG AddressSpace;
01369     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
01370 
01371     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01372 
01373     Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)Object;
01374 
01375     <span class="keywordflow">if</span> ( <a class="code" href="../../d0/d5/se_8h.html#a106">SeDetailedAuditing</a> &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o21">Token</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01376         <a class="code" href="../../d7/d6/sepaudit_8c.html#a21">SeAuditProcessExit</a>(
01377             Process
01378             );
01379     }
01380 
01381     <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a> ) {
01382         <a class="code" href="../../d8/d1/psp_8h.html#a92">PspRemoveProcessFromJob</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>,Process);
01383         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o73">Job</a>);
01384         }
01385 
01386     <a class="code" href="../../d4/d9/ke_8h.html#a26">KeTerminateProcess</a>((<a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>)Process);
01387     AddressSpace = (ULONG)
01388         ((PHARDWARE_PTE)(&amp;(Process-&gt;Pcb.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o2">DirectoryTableBase</a>[0])))-&gt;PageFrameNumber;
01389 
01390 
01391     <span class="keywordflow">if</span> (Process-&gt;DebugPort) {
01392         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;DebugPort);
01393     }
01394     <span class="keywordflow">if</span> (Process-&gt;ExceptionPort) {
01395         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process-&gt;ExceptionPort);
01396     }
01397     <span class="keywordflow">if</span> ( Process-&gt;UniqueProcessId ) {
01398         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>,Process-&gt;UniqueProcessId,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01399             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01400         }
01401     }
01402 
01403     <a class="code" href="../../d8/d1/psp_8h.html#a85">PspDeleteLdt</a>( Process );
01404     <a class="code" href="../../d8/d1/psp_8h.html#a87">PspDeleteVdmObjects</a>( Process );
01405 
01406     <span class="keywordflow">if</span> ( AddressSpace ) {
01407 
01408         <span class="comment">//</span>
01409         <span class="comment">// Clean address space of the process</span>
01410         <span class="comment">//</span>
01411 
01412         <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a>(&amp;Process-&gt;Pcb, &amp;ApcState);
01413 
01414         <a class="code" href="../../d8/d1/psp_8h.html#a71">PspExitProcess</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,Process);
01415 
01416         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
01417     }
01418 
01419     <a class="code" href="../../d6/d5/ps_2security_8c.html#a11">PspDeleteProcessSecurity</a>( Process );
01420 
01421     <span class="keywordflow">if</span> (AddressSpace) {
01422         <a class="code" href="../../d4/d5/procsup_8c.html#a31">MmDeleteProcessAddressSpace</a>(Process);
01423     }
01424 
01425 <span class="preprocessor">#if DEVL</span>
01426 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( Process-&gt;WorkingSetWatch ) {
01427         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Process-&gt;WorkingSetWatch);
01428     }
01429 <span class="preprocessor">#endif // DEVL</span>
01430 <span class="preprocessor"></span>
01431     <a class="code" href="../../d2/d1/mm_8h.html#a88">PERFINFO_PROCESS_DELETE</a>(Process);
01432 
01433     <a class="code" href="../../d7/d0/obdevmap_8c.html#a3">ObDereferenceDeviceMap</a>(Process);
01434     <a class="code" href="../../d0/d2/psquota_8c.html#a6">PspDereferenceQuota</a>(Process);
01435 }
01436 
01437 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01438"></a><a class="code" href="../../d8/d1/psp_8h.html#a54">01438</a> <a class="code" href="../../d8/d1/psp_8h.html#a54">PspThreadDelete</a>(
01439     IN PVOID Object
01440     )
01441 {
01442     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
01443     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01444 
01445     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01446 
01447     Thread = (<a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>) Object;
01448 
01449     <a class="code" href="../../d2/d1/mm_8h.html#a95">PERFINFO_THREAD_DELETE</a>(Thread);
01450 
01451     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o47">Win32Thread</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01452 
01453     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a> ) {
01454         <a class="code" href="../../d4/d5/procsup_8c.html#a34">MmDeleteKernelStack</a>(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o2">InitialStack</a>,(BOOLEAN)Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>.<a class="code" href="../../d1/d8/struct__KTHREAD.html#o52">LargeStack</a>);
01455         }
01456 
01457     <span class="keywordflow">if</span> ( Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread ) {
01458         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>(<a class="code" href="../../d6/d8/sysinfo_8c.html#a1">PspCidTable</a>,Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>.UniqueThread,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
01459             <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(CID_HANDLE_DELETION);
01460             }
01461         }
01462 
01463     <a class="code" href="../../d6/d5/ps_2security_8c.html#a14">PspDeleteThreadSecurity</a>( Thread );
01464 
01465     Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
01466     <span class="keywordflow">if</span> (Process) {
01467         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
01468         }
01469 }
01470 
01471 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01472"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a16">01472</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a16">NtRegisterThreadTerminatePort</a>(
01473     IN HANDLE PortHandle
01474     )
01475 
01476 <span class="comment">/*++</span>
01477 <span class="comment"></span>
01478 <span class="comment">Routine Description:</span>
01479 <span class="comment"></span>
01480 <span class="comment">    This API allows a thread to register a port to be notified upon</span>
01481 <span class="comment">    thread termination.</span>
01482 <span class="comment"></span>
01483 <span class="comment">Arguments:</span>
01484 <span class="comment"></span>
01485 <span class="comment">    PortHandle - Supplies an open handle to a port object that will be</span>
01486 <span class="comment">        sent a termination message when the thread terminates.</span>
01487 <span class="comment"></span>
01488 <span class="comment">Return Value:</span>
01489 <span class="comment"></span>
01490 <span class="comment">    TBD</span>
01491 <span class="comment"></span>
01492 <span class="comment">--*/</span>
01493 
01494 {
01495 
01496     PVOID Port;
01497     <a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">PTERMINATION_PORT</a> TerminationPort;
01498     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> st;
01499 
01500     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01501 
01502     st = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
01503             <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>,
01504             0,
01505             <a class="code" href="../../d9/d8/ntos_8h.html#a5">LpcPortObjectType</a>,
01506             KeGetPreviousMode(),
01507             (PVOID *)&amp;Port,
01508             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01509             );
01510 
01511     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(st) ) {
01512         <span class="keywordflow">return</span> st;
01513 
01514     }
01515 
01516     <span class="comment">//</span>
01517     <span class="comment">// Catch exception and dereference port...</span>
01518     <span class="comment">//</span>
01519 
01520     <span class="keywordflow">try</span> {
01521 
01522         TerminationPort = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01523         TerminationPort = <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html">TERMINATION_PORT</a>));
01524 
01525         TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o1">Port</a> = Port;
01526         InsertTailList(&amp;<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;TerminationPortList,&amp;TerminationPort-&gt;<a class="code" href="../../d3/d0/struct__TERMINATION__PORT.html#o0">Links</a>);
01527 
01528     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
01529 
01530         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Port);
01531 
01532         <span class="keywordflow">return</span> GetExceptionCode();
01533     }
01534 
01535     <span class="keywordflow">return</span> STATUS_SUCCESS;
01536 }
01537 
01538 LARGE_INTEGER
<a name="l01539"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a17">01539</a> <a class="code" href="../../d8/d0/psdelete_8c.html#a17">PsGetProcessExitTime</a>(
01540     VOID
01541     )
01542 
01543 <span class="comment">/*++</span>
01544 <span class="comment"></span>
01545 <span class="comment">Routine Description:</span>
01546 <span class="comment"></span>
01547 <span class="comment">    This routine returns the exit time for the current process.</span>
01548 <span class="comment"></span>
01549 <span class="comment">Arguments:</span>
01550 <span class="comment"></span>
01551 <span class="comment">    None.</span>
01552 <span class="comment"></span>
01553 <span class="comment">Return Value:</span>
01554 <span class="comment"></span>
01555 <span class="comment">    The function value is the exit time for the current process.</span>
01556 <span class="comment"></span>
01557 <span class="comment">Note:</span>
01558 <span class="comment"></span>
01559 <span class="comment">    This routine assumes that the caller wants an error log entry within the</span>
01560 <span class="comment">    bounds of the maximum size.</span>
01561 <span class="comment"></span>
01562 <span class="comment">--*/</span>
01563 
01564 {
01565     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01566 
01567     <span class="comment">//</span>
01568     <span class="comment">// Simply return the exit time for this process.</span>
01569     <span class="comment">//</span>
01570 
01571     <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;ExitTime;
01572 }
01573 
01574 
01575 <span class="preprocessor">#undef PsIsThreadTerminating</span>
01576 <span class="preprocessor"></span>
01577 BOOLEAN
<a name="l01578"></a><a class="code" href="../../d8/d0/psdelete_8c.html#a18">01578</a> <a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(
01579     IN <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread
01580     )
01581 
01582 <span class="comment">/*++</span>
01583 <span class="comment"></span>
01584 <span class="comment">Routine Description:</span>
01585 <span class="comment"></span>
01586 <span class="comment">    This routine returns TRUE if the specified thread is in the process of</span>
01587 <span class="comment">    terminating.</span>
01588 <span class="comment"></span>
01589 <span class="comment">Arguments:</span>
01590 <span class="comment"></span>
01591 <span class="comment">    Thread - Supplies a pointer to the thread to be checked for termination.</span>
01592 <span class="comment"></span>
01593 <span class="comment">Return Value:</span>
01594 <span class="comment"></span>
01595 <span class="comment">    TRUE is returned if the thread is terminating, else FALSE is returned.</span>
01596 <span class="comment"></span>
01597 <span class="comment">--*/</span>
01598 
01599 {
01600     <span class="comment">//</span>
01601     <span class="comment">// Simply return whether or not the thread is in the process of terminating.</span>
01602     <span class="comment">//</span>
01603 
01604     <span class="keywordflow">if</span> ( Thread-&gt;HasTerminated ) {
01605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01606         }
01607     <span class="keywordflow">else</span> {
01608         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609         }
01610 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:32 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
