<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ppc/exdsptch.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exdsptch.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include "<a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html">vunwind.c</a>"</code><br>

<p>
<a href="../../d0/d9/ppc_2exdsptch_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a0">READ_ULONG</a>(addr, dest)&nbsp;&nbsp;&nbsp;dest = (*((PULONG)(addr)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a1">READ_DOUBLE</a>(addr, dest)&nbsp;&nbsp;&nbsp;dest = (*((<a class="el" href="../../d0/d7/ppc_2vunwind_8c.html#a7">PDOUBLE</a>)(addr)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a2">RAISE_EXCEPTION</a>(<a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>, ExceptionRecordt)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a3">RtlpRestoreContext</a> (IN PCONTEXT Context, IN PEXCEPTION_RECORD ExceptionRecord OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a4">RtlpRaiseException</a> (IN PEXCEPTION_RECORD ExceptionRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a5">RtlpRaiseStatus</a> (IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a6">RtlpVirtualUnwind</a> (IN ULONG ControlPc, IN PRUNTIME_FUNCTION FunctionEntry, IN PCONTEXT ContextRecord, OUT PBOOLEAN InFunction, OUT PULONG EstablisherFrame, IN OUT PKNONVOLATILE_CONTEXT_POINTERS ContextPointers OPTIONAL, IN ULONG LowStackLimit, IN ULONG HighStackLimit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a> (IN PEXCEPTION_RECORD ExceptionRecord, IN PCONTEXT ContextRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PRUNTIME_FUNCTION&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a> (IN ULONG ControlPc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a9">RtlRaiseException</a> (IN PEXCEPTION_RECORD ExceptionRecord)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a> (IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a11">RtlUnwind</a> (IN PVOID TargetFrame OPTIONAL, IN PVOID TargetIp OPTIONAL, IN PEXCEPTION_RECORD ExceptionRecord OPTIONAL, IN PVOID ReturnValue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a12">RtlUnwind2</a> (IN PVOID TargetFrame OPTIONAL, IN PVOID TargetIp OPTIONAL, IN PEXCEPTION_RECORD ExceptionRecord OPTIONAL, IN PVOID ReturnValue, IN PCONTEXT ContextRecord)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="ppc/exdsptch.c::RAISE_EXCEPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define RAISE_EXCEPTION          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ExceptionRecordt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    EXCEPTION_RECORD ExceptionRecordn; \
                                            \
    ExceptionRecordn.ExceptionCode = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>; \
    ExceptionRecordn.ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>; \
    ExceptionRecordn.ExceptionRecord = ExceptionRecordt; \
    ExceptionRecordn.NumberParameters = 0; \
    <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a17">RtlRaiseException</a>(&amp;ExceptionRecordn); \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00055">55</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="ppc/exdsptch.c::READ_DOUBLE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define READ_DOUBLE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">addr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>dest&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;dest = (*((<a class="el" href="../../d0/d7/ppc_2vunwind_8c.html#a7">PDOUBLE</a>)(addr)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00043">43</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="ppc/exdsptch.c::READ_ULONG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define READ_ULONG          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">addr,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>dest&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;dest = (*((PULONG)(addr)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00042">42</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00179">ClassifyInstruction()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, and <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00165">TryReadUlong()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="ppc/exdsptch.c::RtlDispatchException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN RtlDispatchException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00098">98</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00051">EXCEPTION_NESTED_CALL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00047">EXCEPTION_NONCONTINUABLE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00050">EXCEPTION_STACK_INVALID</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00059">ExceptionContinueExecution</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00060">ExceptionContinueSearch</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00061">ExceptionNestedException</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00065">RAISE_EXCEPTION</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d6/d9/ntrtlppc_8h.html#a0">RtlpExecuteHandlerForException()</a>, <a class="el" href="../../d9/d9/rtl_2ia64_2miscc_8c-source.html#l00126">RtlpGetStackLimits()</a>, <a class="el" href="../../d4/d8/excptdbg_8c-source.html#l00065">RtlpLogExceptionHandler()</a>, <a class="el" href="../../d5/d9/ntrtlp_8h.html#a49">RtlpLogLastExceptionDisposition()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00085">ExpRaiseException()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00196">ExpRaiseStatus()</a>, and <a class="el" href="../../d9/d7/alpha_2exceptn_8c-source.html#l00412">KiDispatchException()</a>.
<p>
<pre class="fragment"><div>00105                    :
00106 
00107     This function attempts to dispatch an exception to a frame based
00108     handler by searching backwards through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack based call frames.
00109     The search begins with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame specified in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record and
00110     continues backward until either a handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found that handles <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00111     exception, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found to be invalid (i.e., out of limits or
00112     unaligned), or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call hierarchy <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> reached.
00113 
00114     As each frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encountered, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PC where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00115     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined and used to lookup exception handler information
00116     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> runtime function table built by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> linker. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> respective
00117     routine has an exception handler, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00118     handler does not handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prologue of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine
00119     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed backwards to <span class="stringliteral">"unwind"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> effect of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prologue and then
00120     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> examined.
00121 
00122 Arguments:
00123 
00124     ExceptionRecord - Supplies a pointer to an exception record.
00125 
00126     ContextRecord - Supplies a pointer to a context record.
00127 
00128 Return Value:
00129 
00130     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled by one of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> frame based handlers, then
00131     a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00132 
00133 --*/
00134 
00135 {
00136 
00137     CONTEXT ContextRecord1;
00138     ULONG ControlPc;
00139     <a class="code" href="../../d0/d6/struct__DISPATCHER__CONTEXT.html">DISPATCHER_CONTEXT</a> DispatcherContext;
00140     EXCEPTION_DISPOSITION Disposition;
00141     ULONG EstablisherFrame;
00142     ULONG ExceptionFlags;
00143     PRUNTIME_FUNCTION FunctionEntry;
00144     BOOLEAN InFunction;
00145     ULONG HighLimit;
00146     ULONG LowLimit;
00147     ULONG NestedFrame;
00148     ULONG NextPc;
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">// Get current stack limits, copy the context record, get the initial</span>
00152     <span class="comment">// PC value, capture the exception flags, and set the nested exception</span>
00153     <span class="comment">// frame pointer.</span>
00154     <span class="comment">//</span>
00155 
00156     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a30">RtlpGetStackLimits</a>(&amp;LowLimit, &amp;HighLimit);
00157     RtlMoveMemory(&amp;ContextRecord1, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
00158     ControlPc = ContextRecord1.Iar;
00159     ExceptionFlags = ExceptionRecord-&gt;ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>;
00160     NestedFrame = 0;
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Start with the frame specified by the context record and search</span>
00164     <span class="comment">// backwards through the call frame hierarchy attempting to find an</span>
00165     <span class="comment">// exception handler that will handle the exception.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">do</span> {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">// Lookup the function table entry using the point at which control</span>
00172         <span class="comment">// left the procedure.</span>
00173         <span class="comment">//</span>
00174 
00175         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00176 
00177         <span class="comment">//</span>
00178         <span class="comment">// Virtually unwind to the caller of the current routine to obtain</span>
00179         <span class="comment">// the virtual frame pointer of the establisher and the next PC.</span>
00180         <span class="comment">//</span>
00181 
00182         NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
00183                                   FunctionEntry,
00184                                   &amp;ContextRecord1,
00185                                   &amp;InFunction,
00186                                   &amp;EstablisherFrame,
00187                                   NULL,
00188                                   LowLimit,
00189                                   HighLimit);
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// If there is a function table entry for the routine, check if</span>
00193         <span class="comment">// there is an exception handler for the frame.</span>
00194         <span class="comment">//</span>
00195 
00196         <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00197             <span class="comment">//</span>
00198             <span class="comment">// If the virtual frame pointer is not within the specified stack</span>
00199             <span class="comment">// limits or the virtual frame pointer is unaligned, then set the</span>
00200             <span class="comment">// stack invalid flag in the exception record and return exception</span>
00201             <span class="comment">// not handled. Otherwise, check if the current routine has an</span>
00202             <span class="comment">// exception handler.</span>
00203             <span class="comment">//</span>
00204 
00205             <span class="keywordflow">if</span> ((EstablisherFrame &lt; LowLimit) || (EstablisherFrame &gt; HighLimit) ||
00206                ((EstablisherFrame &amp; 0x7) != 0)) {
00207                 ExceptionFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a28">EXCEPTION_STACK_INVALID</a>;
00208                 <span class="keywordflow">break</span>;
00209 
00210             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((FunctionEntry-&gt;ExceptionHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; InFunction) {
00211                 ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00212 
00213                 <span class="comment">//</span>
00214                 <span class="comment">// The frame has an exception handler. The handler must be</span>
00215                 <span class="comment">// executed by calling another routine that is written in</span>
00216                 <span class="comment">// assembler. This is required because up level addressing</span>
00217                 <span class="comment">// of the handler information is required when a nested</span>
00218                 <span class="comment">// exception is encountered.</span>
00219                 <span class="comment">//</span>
00220 
00221                 DispatcherContext.ControlPc = ControlPc;
00222                 DispatcherContext.FunctionEntry = FunctionEntry;
00223                 DispatcherContext.EstablisherFrame = EstablisherFrame;
00224                 DispatcherContext.ContextRecord = ContextRecord;
00225                 ExceptionRecord-&gt;ExceptionFlags = ExceptionFlags;
00226 
00227                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_EXCEPTION_LOGGING) {
00228                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d5/d9/ntrtlp_8h.html#a48">RtlpLogExceptionHandler</a>(
00229                                     ExceptionRecord,
00230                                     ContextRecord,
00231                                     ControlPc,
00232                                     FunctionEntry,
00233                                     <span class="keyword">sizeof</span>(RUNTIME_FUNCTION));
00234                 }
00235 
00236                 Disposition =
00237                     <a class="code" href="../../d6/d9/ntrtlppc_8h.html#a0">RtlpExecuteHandlerForException</a>(ExceptionRecord,
00238                                                    EstablisherFrame,
00239                                                    ContextRecord,
00240                                                    &amp;DispatcherContext,
00241                                                    FunctionEntry-&gt;ExceptionHandler);
00242 
00243                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_EXCEPTION_LOGGING) {
00244                     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a49">RtlpLogLastExceptionDisposition</a>(Index, Disposition);
00245                 }
00246 
00247                 ExceptionFlags |=
00248                     (ExceptionRecord-&gt;ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>);
00249 
00250                 <span class="comment">//</span>
00251                 <span class="comment">// If the current scan is within a nested context and the frame</span>
00252                 <span class="comment">// just examined is the end of the nested region, then clear</span>
00253                 <span class="comment">// the nested context frame and the nested exception flag in</span>
00254                 <span class="comment">// the exception flags.</span>
00255                 <span class="comment">//</span>
00256 
00257                 <span class="keywordflow">if</span> (NestedFrame == EstablisherFrame) {
00258                     ExceptionFlags &amp;= (~<a class="code" href="../../d6/d7/halmips_8h.html#a29">EXCEPTION_NESTED_CALL</a>);
00259                     NestedFrame = 0;
00260                 }
00261 
00262                 <span class="comment">//</span>
00263                 <span class="comment">// Case on the handler disposition.</span>
00264                 <span class="comment">//</span>
00265 
00266                 <span class="keywordflow">switch</span> (Disposition) {
00267 
00268                     <span class="comment">//</span>
00269                     <span class="comment">// The disposition is to continue execution.</span>
00270                     <span class="comment">//</span>
00271                     <span class="comment">// If the exception is not continuable, then raise the</span>
00272                     <span class="comment">// exception STATUS_NONCONTINUABLE_EXCEPTION. Otherwise</span>
00273                     <span class="comment">// return exception handled.</span>
00274                     <span class="comment">//</span>
00275 
00276                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a36">ExceptionContinueExecution</a> :
00277                     <span class="keywordflow">if</span> ((ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>) != 0) {
00278                         <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a0">RAISE_EXCEPTION</a>(STATUS_NONCONTINUABLE_EXCEPTION, ExceptionRecord);
00279 
00280                     } <span class="keywordflow">else</span> {
00281                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00282                     }
00283 
00284                     <span class="comment">//</span>
00285                     <span class="comment">// The disposition is to continue the search.</span>
00286                     <span class="comment">//</span>
00287                     <span class="comment">// Get next frame address and continue the search.</span>
00288                     <span class="comment">//</span>
00289 
00290                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a> :
00291                     <span class="keywordflow">break</span>;
00292 
00293                     <span class="comment">//</span>
00294                     <span class="comment">// The disposition is nested exception.</span>
00295                     <span class="comment">//</span>
00296                     <span class="comment">// Set the nested context frame to the establisher frame</span>
00297                     <span class="comment">// address and set the nested exception flag in the</span>
00298                     <span class="comment">// exception flags.</span>
00299                     <span class="comment">//</span>
00300 
00301                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a38">ExceptionNestedException</a> :
00302                     ExceptionFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a29">EXCEPTION_NESTED_CALL</a>;
00303                     <span class="keywordflow">if</span> (DispatcherContext.EstablisherFrame &gt; NestedFrame) {
00304                         NestedFrame = DispatcherContext.EstablisherFrame;
00305                     }
00306 
00307                     <span class="keywordflow">break</span>;
00308 
00309                     <span class="comment">//</span>
00310                     <span class="comment">// All other disposition values are invalid.</span>
00311                     <span class="comment">//</span>
00312                     <span class="comment">// Raise invalid disposition exception.</span>
00313                     <span class="comment">//</span>
00314 
00315                 <span class="keywordflow">default</span> :
00316                     <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a0">RAISE_EXCEPTION</a>(STATUS_INVALID_DISPOSITION, ExceptionRecord);
00317                 }
00318             }
00319 
00320         } <span class="keywordflow">else</span> {
00321 
00322             <span class="comment">//</span>
00323             <span class="comment">// If the next control PC is the same as the old control PC, then</span>
00324             <span class="comment">// the function table is not correctly formed.</span>
00325             <span class="comment">//</span>
00326 
00327             <span class="keywordflow">if</span> (NextPc == ControlPc) {
00328                 <span class="keywordflow">break</span>;
00329             }
00330         }
00331 
00332         <span class="comment">//</span>
00333         <span class="comment">// Set point at which control left the previous routine.</span>
00334         <span class="comment">//</span>
00335 
00336         ControlPc = NextPc;
00337     } <span class="keywordflow">while</span> (ContextRecord1.Gpr1 &lt; HighLimit);
00338 
00339     <span class="comment">//</span>
00340     <span class="comment">// Set final exception flags and return exception not handled.</span>
00341     <span class="comment">//</span>
00342 
00343     ExceptionRecord-&gt;ExceptionFlags = ExceptionFlags;
00344     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00345 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="ppc/exdsptch.c::RtlLookupFunctionEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PRUNTIME_FUNCTION RtlLookupFunctionEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ControlPc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">348</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00250">RtlImageDirectoryEntryToData()</a>, <a class="el" href="../../d7/d3/pctohdr_8c-source.html#l00042">RtlPcToFileHeader()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00179">ClassifyInstruction()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00085">ExpRaiseException()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00196">ExpRaiseStatus()</a>, <a class="el" href="../../d8/d9/psctxppc_8c-source.html#l00386">PspGetSetContextApc()</a>, <a class="el" href="../../d7/d9/psctxmip_8c-source.html#l00475">PspGetSetContextSpecialApc()</a>, <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00349">PspGetSetContextSpecialApcMain()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00162">RtlDispatchException()</a>, <a class="el" href="../../d3/d1/alpha_2getcalr_8c-source.html#l00039">RtlGetCallersAddress()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00507">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00643">RtlpRaiseException()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00745">RtlpRaiseStatus()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00883">RtlUnwind2()</a>, <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00492">RtlUnwindReturn()</a>, <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00076">RtlUnwindRfp()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, and <a class="el" href="../../d6/d7/jumps_8c-source.html#l00088">setjmp()</a>.
<p>
<pre class="fragment"><div>00354                    :
00355 
00356     This function searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> currently active function tables <span class="keywordflow">for</span> an entry
00357     that corresponds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PC value.
00358 
00359 Arguments:
00360 
00361     ControlPc - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of an instruction within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00362         function.
00363 
00364 Return Value:
00365 
00366     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function table <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PC, then
00367     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function table entry
00368     that corresponds to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified PC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00369 
00370 --*/
00371 
00372 {
00373 
00374     PRUNTIME_FUNCTION FunctionEntry;
00375     PRUNTIME_FUNCTION FunctionTable;
00376     ULONG SizeOfExceptionTable;
00377     LONG High;
00378     PVOID ImageBase;
00379     LONG Low;
00380     LONG Middle;
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">// Search for the image that includes the specified PC value.</span>
00384     <span class="comment">//</span>
00385 
00386     ImageBase = <a class="code" href="../../d6/d4/pctohdr_8c.html#a1">RtlPcToFileHeader</a>((PVOID)ControlPc, &amp;ImageBase);
00387 
00388     <span class="comment">//</span>
00389     <span class="comment">// If an image is found that includes the specified PC, then locate the</span>
00390     <span class="comment">// function table for the image.</span>
00391     <span class="comment">//</span>
00392 
00393     <span class="keywordflow">if</span> (ImageBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00394         FunctionTable = (PRUNTIME_FUNCTION)<a class="code" href="../../d8/d9/imagedir_8c.html#a5">RtlImageDirectoryEntryToData</a>(
00395                          ImageBase, TRUE, IMAGE_DIRECTORY_ENTRY_EXCEPTION,
00396                          &amp;SizeOfExceptionTable);
00397 
00398         <span class="comment">//</span>
00399         <span class="comment">// If a function table is located, then search the function table</span>
00400         <span class="comment">// for a function table entry for the specified PC.</span>
00401         <span class="comment">//</span>
00402 
00403         <span class="keywordflow">if</span> (FunctionTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00404 
00405             <span class="comment">//</span>
00406             <span class="comment">// Initialize search indicies.</span>
00407             <span class="comment">//</span>
00408 
00409             Low = 0;
00410             High = (SizeOfExceptionTable / <span class="keyword">sizeof</span>(RUNTIME_FUNCTION)) - 1;
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">// Perform binary search on the function table for a function table</span>
00414             <span class="comment">// entry that subsumes the specified PC.</span>
00415             <span class="comment">//</span>
00416 
00417             <span class="keywordflow">while</span> (High &gt;= Low) {
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">// Compute next probe index and test entry. If the specified PC</span>
00421                 <span class="comment">// is greater than of equal to the beginning address and less</span>
00422                 <span class="comment">// than the ending address of the function table entry, then</span>
00423                 <span class="comment">// return the address of the function table entry. Otherwise,</span>
00424                 <span class="comment">// continue the search.</span>
00425                 <span class="comment">//</span>
00426 
00427                 Middle = (Low + High) &gt;&gt; 1;
00428                 FunctionEntry = &amp;FunctionTable[Middle];
00429                 <span class="keywordflow">if</span> (ControlPc &lt; FunctionEntry-&gt;BeginAddress) {
00430                     High = Middle - 1;
00431 
00432                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ControlPc &gt;= FunctionEntry-&gt;EndAddress) {
00433                     Low = Middle + 1;
00434 
00435                 } <span class="keywordflow">else</span> {
00436 
00437                     <span class="comment">//</span>
00438                     <span class="comment">// The capability exists for more than one function entry</span>
00439                     <span class="comment">// to map to the same function. This permits a function to</span>
00440                     <span class="comment">// have (within reason) discontiguous code segment(s). If</span>
00441                     <span class="comment">// PrologEndAddress is out of range, it is re-interpreted</span>
00442                     <span class="comment">// as a pointer to the primary function table entry for</span>
00443                     <span class="comment">// that function.  The out of range test takes into account</span>
00444                     <span class="comment">// the redundant encoding of millicode and glue code.</span>
00445                     <span class="comment">//</span>
00446 
00447                     <span class="keywordflow">if</span> (((FunctionEntry-&gt;PrologEndAddress &lt; FunctionEntry-&gt;BeginAddress) ||
00448                          (FunctionEntry-&gt;PrologEndAddress &gt; FunctionEntry-&gt;EndAddress)) &amp;&amp;
00449                         (FunctionEntry-&gt;PrologEndAddress &amp; 3) == 0) {
00450                         FunctionEntry = (PRUNTIME_FUNCTION)FunctionEntry-&gt;PrologEndAddress;
00451                     }
00452                     <span class="keywordflow">return</span> FunctionEntry;
00453                 }
00454             }
00455         }
00456     }
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// A function table entry for the specified PC was not found.</span>
00460     <span class="comment">//</span>
00461 
00462     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00463 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="ppc/exdsptch.c::RtlpRaiseException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpRaiseException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionRecord</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html#l00311">311</a> of file <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html">ia64/exdsptch.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00603">RtlRaiseException()</a>.
<p>
<pre class="fragment"><div>00317                    :
00318 
00319     This function raises a software exception by building a context record
00320     and calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raise exception system service.
00321 
00322 Arguments:
00323 
00324     ExceptionRecord - Supplies a pointer to an exception record.
00325 
00326 Return Value:
00327 
00328     None.
00329 
00330 --*/
00331 
00332 {
00333     ULONGLONG ImageBase;
00334     ULONGLONG TargetGp;
00335     ULONGLONG ControlPc;
00336     CONTEXT ContextRecord;
00337     FRAME_POINTERS EstablisherFrame;
00338     PRUNTIME_FUNCTION FunctionEntry;
00339     BOOLEAN InFunction;
00340     ULONGLONG NextPc;
00341     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Capture the current context, virtually unwind to the caller of this</span>
00345     <span class="comment">// routine, set the fault instruction address to that of the caller, and</span>
00346     <span class="comment">// call the raise exception system service.</span>
00347     <span class="comment">//</span>
00348 
00349     RtlCaptureContext(&amp;ContextRecord);
00350     ControlPc = RtlIa64InsertIPSlotNumber((ContextRecord.BrRp-16), 2);
00351     FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc, &amp;ImageBase, &amp;TargetGp);
00352     NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ImageBase,
00353                               ControlPc,
00354                               FunctionEntry,
00355                               &amp;ContextRecord,
00356                               &amp;InFunction,
00357                               &amp;EstablisherFrame,
00358                               NULL);
00359 
00360     ContextRecord.StIIP = NextPc + 8;
00361     ContextRecord.StIPSR &amp;= ~((ULONGLONG) 3 &lt;&lt; PSR_RI);
00362     ExceptionRecord-&gt;ExceptionAddress = (PVOID)ContextRecord.StIIP;
00363     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwRaiseException(ExceptionRecord, &amp;ContextRecord, TRUE);
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// There should never be a return from this system service unless</span>
00367     <span class="comment">// there is a problem with the argument list itself. Raise another</span>
00368     <span class="comment">// exception specifying the status value returned.</span>
00369     <span class="comment">//</span>
00370 
00371     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00372     <span class="keywordflow">return</span>;
00373 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="ppc/exdsptch.c::RtlpRaiseStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpRaiseStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Status</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html#l00409">409</a> of file <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html">ia64/exdsptch.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00047">EXCEPTION_NONCONTINUABLE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00705">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00415                    :
00416 
00417     This function raises an exception with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified status value. The
00418     exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as noncontinuable with no parameters.
00419 
00420 Arguments:
00421 
00422     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status value to be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code
00423         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be raised.
00424 
00425 Return Value:
00426 
00427     None.
00428 
00429 --*/
00430 
00431 {
00432     ULONGLONG ImageBase;
00433     ULONGLONG TargetGp;
00434     ULONGLONG ControlPc;
00435     ULONGLONG NextPc;
00436     CONTEXT ContextRecord;
00437     FRAME_POINTERS EstablisherFrame;
00438     EXCEPTION_RECORD ExceptionRecord;
00439     PRUNTIME_FUNCTION FunctionEntry;
00440     BOOLEAN InFunction;
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">// Construct an exception record.</span>
00444     <span class="comment">//</span>
00445 
00446     ExceptionRecord.ExceptionCode = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00447     ExceptionRecord.ExceptionRecord = (PEXCEPTION_RECORD)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448     ExceptionRecord.NumberParameters = 0;
00449     ExceptionRecord.ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a25">EXCEPTION_NONCONTINUABLE</a>;
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Capture the current context, virtually unwind to the caller of this</span>
00453     <span class="comment">// routine, set the fault instruction address to that of the caller, and</span>
00454     <span class="comment">// call the raise exception system service.</span>
00455     <span class="comment">//</span>
00456 
00457     RtlCaptureContext(&amp;ContextRecord);
00458     ControlPc = RtlIa64InsertIPSlotNumber((ContextRecord.BrRp-16), 2);
00459     FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc, &amp;ImageBase, &amp;TargetGp);
00460     NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ImageBase,
00461                               ControlPc,
00462                               FunctionEntry,
00463                               &amp;ContextRecord,
00464                               &amp;InFunction,
00465                               &amp;EstablisherFrame,
00466                               NULL);
00467     ContextRecord.StIIP = NextPc + 8;
00468     ContextRecord.StIPSR &amp;= ~((ULONGLONG) 3 &lt;&lt; PSR_RI);
00469     ExceptionRecord.ExceptionAddress = (PVOID)ContextRecord.StIIP;
00470     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwRaiseException(&amp;ExceptionRecord, &amp;ContextRecord, TRUE);
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// There should never be a return from this system service unless</span>
00474     <span class="comment">// there is a problem with the argument list itself. Raise another</span>
00475     <span class="comment">// exception specifying the status value returned.</span>
00476     <span class="comment">//</span>
00477 
00478     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(Status);
00479     <span class="keywordflow">return</span>;
00480 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="ppc/exdsptch.c::RtlpRestoreContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlpRestoreContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD ExceptionRecord&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00883">RtlUnwind2()</a>, <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00492">RtlUnwindReturn()</a>, and <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00076">RtlUnwindRfp()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="ppc/exdsptch.c::RtlpVirtualUnwind" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG RtlpVirtualUnwind           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ControlPc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PRUNTIME_FUNCTION&nbsp;</td>
          <td class="mdname" nowrap> <em>FunctionEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InFunction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>EstablisherFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PKNONVOLATILE_CONTEXT_POINTERS ContextPointers&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LowStackLimit</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HighStackLimit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l01102">1102</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00883">RtlUnwind2()</a>.
<p>
<pre class="fragment"><div>01115                    :
01116 
01117     This function virtually unwinds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specfified function by executing its
01118     prologue code backwards.
01119 
01120     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a leaf function, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left
01121     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> obtained from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01122     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nested function, but not an exception or interrupt frame, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01123     prologue code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed backwards and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left
01124     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> obtained from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> updated context record.
01125 
01126     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">register</span> save millicode, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> treated as a leaf
01127     function.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">register</span> restore millicode, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining
01128     body <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed forwards and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01129     previous frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> obtained from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> blr instruction.
01130 
01131     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was called via glue code and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not that glue code,
01132     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prologe of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> glue code <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed backwards in addition to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01133     above actions.
01134 
01135     Otherwise, an exception or interrupt entry to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being
01136     unwound and a specially coded prologue restores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> address
01137     twice. Once from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault instruction address and once from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> saved
01138     <span class="keywordflow">return</span> address <span class="keyword">register</span>. The first restore <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function
01139     value and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> second restore <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> place in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> updated context record.
01140 
01141     If a context pointers record <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where each
01142     nonvolatile registers <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> restored from <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> recorded in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate
01143     element of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context pointers record.
01144 
01145     N.B. This function copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record and <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> computes
01146          <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher frame and whether <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> actually in a function.
01147 
01148 Arguments:
01149 
01150     ControlPc - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
01151         function.
01152 
01153     FunctionEntry - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01154         specified function or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a leaf function.
01155 
01156     ContextRecord - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
01157 
01158     InFunction - Supplies a pointer to a variable that receives whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01159         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> PC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current function.
01160 
01161     EstablisherFrame - Supplies a pointer to a variable that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01162         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> establisher frame pointer value.
01163 
01164     ContextPointers - Supplies an optional pointer to a context pointers
01165         record.
01166 
01167     LowStackLimit, HighStackLimit - Range of valid values <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack
01168         pointer.  This indicates whether <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid to examine NextPc.
01169 
01170 Return Value:
01171 
01172     The address where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01173     function value.
01174 
01175 --*/
01176 
01177 {
01178 
01179     CONTEXT LocalContext;
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">// Copy the context record so updates will not be reflected in the</span>
01183     <span class="comment">// original copy and then virtually unwind to the caller of the</span>
01184     <span class="comment">// specified control point.</span>
01185     <span class="comment">//</span>
01186 
01187     RtlMoveMemory((PVOID)&amp;LocalContext, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
01188     <span class="keywordflow">return</span> <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
01189                             FunctionEntry,
01190                             &amp;LocalContext,
01191                             InFunction,
01192                             EstablisherFrame,
01193                             ContextPointers,
01194                             LowStackLimit,
01195                             HighStackLimit);
01196 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="ppc/exdsptch.c::RtlRaiseException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlRaiseException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PEXCEPTION_RECORD&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionRecord</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00466">466</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html#l00311">RtlpRaiseException()</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/ctrlc_8c-source.html#l00093">CtrlRoutine()</a>, <a class="el" href="../../d1/d4/rtl_2debug_8c-source.html#l00036">DbgPrint()</a>, <a class="el" href="../../d1/d4/rtl_2debug_8c-source.html#l00157">DbgPrintReturnControlC()</a>, <a class="el" href="../../d4/d9/test_8c-source.html#l00160">DivMarker()</a>, <a class="el" href="../../d1/d2/utxcpt2_8c-source.html#l00009">ExceptionTest()</a>, <a class="el" href="../../d1/d2/utxcpt2_8c-source.html#l00382">foo()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l00143">main()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">RtlAcquireResourceExclusive()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">RtlAcquireResourceShared()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l01316">RtlAllocateHeap()</a>, <a class="el" href="../../d2/d8/rtl_2heap_8c-source.html#l02075">RtlAllocateHeapSlowly()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">RtlConvertSharedToExclusive()</a>, <a class="el" href="../../d7/d8/i386_2exdsptch_8c-source.html#l00070">RtlDispatchException()</a>, <a class="el" href="../../d7/d8/heappage_8c-source.html#l00674">RtlpDebugPageHeapException()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>, <a class="el" href="../../d5/d3/rtl_2i386_2raisests_8c-source.html#l00029">RtlRaiseStatus()</a>, <a class="el" href="../../d6/d8/heapdll_8c-source.html#l00518">RtlReAllocateHeap()</a>, <a class="el" href="../../d7/d8/i386_2exdsptch_8c-source.html#l00303">RtlUnwind()</a>, and <a class="el" href="../../d3/d2/utxcpt4_8c-source.html#l00047">Tkm()</a>.
<p>
<pre class="fragment"><div>00472                    :
00473 
00474     This function raises a software exception by building a context record
00475     and calling <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> raise exception system service.
00476 
00477     N.B. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a shell routine that simply calls another routine
00478          to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real work. The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to avoid a problem
00479          in <span class="keywordflow">try</span>/finally scopes where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last statement in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scope <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00480          call to raise an exception.
00481 
00482 Arguments:
00483 
00484     ExceptionRecord - Supplies a pointer to an exception record.
00485 
00486 Return Value:
00487 
00488     None.
00489 
00490 --*/
00491 
00492 {
00493 
00494     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a4">RtlpRaiseException</a>(ExceptionRecord);
00495     <span class="keywordflow">return</span>;
00496 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="ppc/exdsptch.c::RtlRaiseStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlRaiseStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Status</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">563</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d8/d8/ia64_2exdsptch_8c-source.html#l00409">RtlpRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d4/d1/ofsmisc_8c-source.html#l00622">_purecall()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02131">addtwo()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l01946">ConsoleInputThread()</a>, <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00678">CsrProbeForRead()</a>, <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00607">CsrProbeForWrite()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02190">dojump()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02238">except1()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02279">except3()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02305">foo1()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00575">LdrpForkProcess()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00186">LdrpInitialize()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02476">LdrpSnapThunk()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l00143">main()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00515">RtlAcquireResourceExclusive()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00350">RtlAcquireResourceShared()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01061">RtlConvertExclusiveToShared()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00851">RtlConvertSharedToExclusive()</a>, <a class="el" href="../../d3/d5/rtl_2alpha_2context_8c-source.html#l00034">RtlInitializeContext()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00247">RtlInitializeResource()</a>, <a class="el" href="../../d8/d7/divlarge_8c-source.html#l00028">RtlLargeIntegerDivide()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01412">RtlpCreateCriticalSectionSem()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01717">RtlpNotOwnerCriticalSection()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00643">RtlpRaiseException()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00745">RtlpRaiseStatus()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01675">RtlpUnWaitCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01544">RtlpWaitForCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l00680">RtlReleaseResource()</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00883">RtlUnwind2()</a>, <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00492">RtlUnwindReturn()</a>, <a class="el" href="../../d7/d8/unwindr_8c-source.html#l00076">RtlUnwindRfp()</a>, <a class="el" href="../../d2/d0/xcpt4_8c-source.html#l02367">Test61Part2()</a>, <a class="el" href="../../d3/d2/utxcpt4_8c-source.html#l00047">Tkm()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l04103">UnlockConsole()</a>, and <a class="el" href="../../d7/d7/clinit_8c-source.html#l01626">UserRtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00569                    :
00570 
00571     This function raises an exception with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified status value. The
00572     exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> marked as noncontinuable with no parameters.
00573 
00574     N.B. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a shell routine that simply calls another routine
00575          to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real work. The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to avoid a problem
00576          in <span class="keywordflow">try</span>/finally scopes where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last statement in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scope <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a
00577          call to raise an exception.
00578 
00579 Arguments:
00580 
00581     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status value to be used as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code
00582         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be raised.
00583 
00584 Return Value:
00585 
00586     None.
00587 
00588 --*/
00589 
00590 {
00591 
00592     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a5">RtlpRaiseStatus</a>(Status);
00593     <span class="keywordflow">return</span>;
00594 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="ppc/exdsptch.c::RtlUnwind" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlUnwind           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID TargetFrame&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID TargetIp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD ExceptionRecord&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnValue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00671">671</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00737">RtlUnwind2()</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>, and <a class="el" href="../../d6/d7/jumps_8c-source.html#l00033">longjmp()</a>.
<p>
<pre class="fragment"><div>00680                    :
00681 
00682     This function initiates an unwind of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call frames. The machine
00683     state at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured in a context record
00684     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwinding flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00685     record. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TargetFrame parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> unwind
00686     flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> backward
00687     scan through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call frames <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then performed to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00688     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind operation.
00689 
00690     As each frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encounter, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PC where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00691     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined and used to lookup exception handler information
00692     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> runtime function table built by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> linker. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> respective
00693     routine has an exception handler, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00694 
00695     N.B. This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> provided <span class="keywordflow">for</span> backward compatibility with release 1.
00696 
00697 Arguments:
00698 
00699     TargetFrame - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call frame that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00700         target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind. If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then an <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>
00701         unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed.
00702 
00703     TargetIp - Supplies an optional instruction address that specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00704         continuation address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind. This address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00705         target frame parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00706 
00707     ExceptionRecord - Supplies an optional pointer to an exception record.
00708 
00709     ReturnValue - Supplies a value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> integer
00710         function <span class="keywordflow">return</span> <span class="keyword">register</span> just before continuing execution.
00711 
00712 Return Value:
00713 
00714     None.
00715 
00716 --*/
00717 
00718 {
00719 
00720     CONTEXT ContextRecord;
00721 
00722     <span class="comment">//</span>
00723     <span class="comment">// Call real unwind routine specifying a context record as an</span>
00724     <span class="comment">// extra argument.</span>
00725     <span class="comment">//</span>
00726 
00727     <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a12">RtlUnwind2</a>(TargetFrame,
00728                TargetIp,
00729                ExceptionRecord,
00730                ReturnValue,
00731                &amp;ContextRecord);
00732 
00733     <span class="keywordflow">return</span>;
00734 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="ppc/exdsptch.c::RtlUnwind2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlUnwind2           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID TargetFrame&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID TargetIp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_RECORD ExceptionRecord&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnValue</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextRecord</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00737">737</a> of file <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html">ppc/exdsptch.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00053">EXCEPTION_COLLIDED_UNWIND</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00049">EXCEPTION_EXIT_UNWIND</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00052">EXCEPTION_TARGET_UNWIND</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00048">EXCEPTION_UNWINDING</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00062">ExceptionCollidedUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00060">ExceptionContinueSearch</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00065">RAISE_EXCEPTION</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d6/d9/ntrtlppc_8h.html#a1">RtlpExecuteHandlerForUnwind()</a>, <a class="el" href="../../d9/d9/rtl_2ia64_2miscc_8c-source.html#l00126">RtlpGetStackLimits()</a>, <a class="el" href="../../d9/d9/ppc_2exdsptch_8c.html#a3">RtlpRestoreContext()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l01102">RtlpVirtualUnwind()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>, and <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>.
<p>
Referenced by <a class="el" href="../../d1/d5/alpha_2chandler_8c-source.html#l00052">__C_specific_handler()</a>, <a class="el" href="../../d1/d5/ghandler_8c-source.html#l00091">_OtsCSpecificHandler()</a>, <a class="el" href="../../d5/d4/ia64_2trapc_8c-source.html#l00906">KiSystemServiceHandler()</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00817">RtlUnwind()</a>.
<p>
<pre class="fragment"><div>00747                    :
00748 
00749     This function initiates an unwind of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call frames. The machine
00750     state at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call to unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> captured in a context record
00751     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwinding flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception
00752     record. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TargetFrame parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a> unwind
00753     flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also set in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception flags of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception record. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> backward
00754     scan through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> call frames <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> then performed to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00755     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind operation.
00756 
00757     As each frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> encounter, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PC where <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> left <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding
00758     function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined and used to lookup exception handler information
00759     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> runtime function table built by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> linker. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> respective
00760     routine has an exception handler, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handler <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00761 
00762 Arguments:
00763 
00764     TargetFrame - Supplies an optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call frame that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00765         target of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind. If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then an <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>
00766         unwind <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed.
00767 
00768     TargetIp - Supplies an optional instruction address that specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00769         continuation address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind. This address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00770         target frame parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
00771 
00772     ExceptionRecord - Supplies an optional pointer to an exception record.
00773 
00774     ReturnValue - Supplies a value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be placed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> integer
00775         function <span class="keywordflow">return</span> <span class="keyword">register</span> just before continuing execution.
00776 
00777     ContextRecord - Supplies a pointer to a context record that can be used
00778         to store context druing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unwind operation.
00779 
00780 Return Value:
00781 
00782     None.
00783 
00784 --*/
00785 
00786 {
00787 
00788     ULONG ControlPc;
00789     <a class="code" href="../../d0/d6/struct__DISPATCHER__CONTEXT.html">DISPATCHER_CONTEXT</a> DispatcherContext;
00790     EXCEPTION_DISPOSITION Disposition;
00791     ULONG EstablisherFrame;
00792     ULONG ExceptionFlags;
00793     EXCEPTION_RECORD ExceptionRecord1;
00794     PRUNTIME_FUNCTION FunctionEntry;
00795     BOOLEAN InFunction;
00796     ULONG HighLimit;
00797     ULONG LowLimit;
00798     ULONG NextPc;
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Get current stack limits, capture the current context, virtually</span>
00802     <span class="comment">// unwind to the caller of this routine, get the initial PC value, and</span>
00803     <span class="comment">// set the unwind target address.</span>
00804     <span class="comment">//</span>
00805 
00806     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a30">RtlpGetStackLimits</a>(&amp;LowLimit, &amp;HighLimit);
00807     RtlCaptureContext(ContextRecord);
00808     ControlPc = ContextRecord-&gt;Lr - 4;
00809     FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00810     NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
00811                               FunctionEntry,
00812                               ContextRecord,
00813                               &amp;InFunction,
00814                               &amp;EstablisherFrame,
00815                               NULL,
00816                               0,
00817                               0xffffffff);
00818 
00819     ControlPc = NextPc;
00820     ContextRecord-&gt;Iar = (ULONG)TargetIp;
00821 
00822     <span class="comment">//</span>
00823     <span class="comment">// If an exception record is not specified, then build a local exception</span>
00824     <span class="comment">// record for use in calling exception handlers during the unwind operation.</span>
00825     <span class="comment">//</span>
00826 
00827     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ExceptionRecord) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00828         ExceptionRecord = &amp;ExceptionRecord1;
00829         ExceptionRecord1.ExceptionCode = STATUS_UNWIND;
00830         ExceptionRecord1.ExceptionRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00831         ExceptionRecord1.ExceptionAddress = (PVOID)ControlPc;
00832         ExceptionRecord1.NumberParameters = 0;
00833     }
00834 
00835     <span class="comment">//</span>
00836     <span class="comment">// If the target frame of the unwind is specified, then a normal unwind</span>
00837     <span class="comment">// is being performed. Otherwise, an exit unwind is being performed.</span>
00838     <span class="comment">//</span>
00839 
00840     ExceptionFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a26">EXCEPTION_UNWINDING</a>;
00841     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(TargetFrame) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00842         ExceptionRecord-&gt;ExceptionFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a27">EXCEPTION_EXIT_UNWIND</a>;
00843     }
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">// Scan backward through the call frame hierarchy and call exception</span>
00847     <span class="comment">// handlers until the target frame of the unwind is reached.</span>
00848     <span class="comment">//</span>
00849 
00850     <span class="keywordflow">do</span> {
00851 
00852         <span class="comment">//</span>
00853         <span class="comment">// Lookup the function table entry using the point at which control</span>
00854         <span class="comment">// left the procedure.</span>
00855         <span class="comment">//</span>
00856 
00857         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
00858 
00859         <span class="comment">//</span>
00860         <span class="comment">// If there is a function table entry for the routine, then virtually</span>
00861         <span class="comment">// unwind to the caller of the routine to obtain the virtual frame</span>
00862         <span class="comment">// pointer of the establisher, but don't update the context record.</span>
00863         <span class="comment">//</span>
00864 
00865         <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00866             NextPc = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a6">RtlpVirtualUnwind</a>(ControlPc,
00867                                        FunctionEntry,
00868                                        ContextRecord,
00869                                        &amp;InFunction,
00870                                        &amp;EstablisherFrame,
00871                                        NULL,
00872                                        LowLimit,
00873                                        HighLimit);
00874 
00875             <span class="comment">//</span>
00876             <span class="comment">// If the virtual frame pointer is not within the specified stack</span>
00877             <span class="comment">// limits, the virtual frame pointer is unaligned, or the target</span>
00878             <span class="comment">// frame is below the virtual frame and an exit unwind is not being</span>
00879             <span class="comment">// performed, then raise the exception STATUS_BAD_STACK. Otherwise,</span>
00880             <span class="comment">// check to determine if the current routine has an exception</span>
00881             <span class="comment">// handler.</span>
00882             <span class="comment">//</span>
00883 
00884             <span class="keywordflow">if</span> ((EstablisherFrame &lt; LowLimit) || (EstablisherFrame &gt; HighLimit) ||
00885                ((ARGUMENT_PRESENT(TargetFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00886                ((ULONG)TargetFrame &lt; EstablisherFrame)) ||
00887                ((EstablisherFrame &amp; 0x7) != 0)) {
00888                 <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a0">RAISE_EXCEPTION</a>(STATUS_BAD_STACK, ExceptionRecord);
00889 
00890             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((FunctionEntry-&gt;ExceptionHandler != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; InFunction) {
00891 
00892                 <span class="comment">//</span>
00893                 <span class="comment">// The frame has an exception handler.</span>
00894                 <span class="comment">//</span>
00895                 <span class="comment">// The control PC, establisher frame pointer, the address</span>
00896                 <span class="comment">// of the function table entry, and the address of the</span>
00897                 <span class="comment">// context record are all stored in the dispatcher context.</span>
00898                 <span class="comment">// This information is used by the unwind linkage routine</span>
00899                 <span class="comment">// and can be used by the exception handler itself.</span>
00900                 <span class="comment">//</span>
00901                 <span class="comment">// A linkage routine written in assembler is used to actually</span>
00902                 <span class="comment">// call the actual exception handler. This is required by the</span>
00903                 <span class="comment">// exception handler that is associated with the linkage</span>
00904                 <span class="comment">// routine so it can have access to two sets of dispatcher</span>
00905                 <span class="comment">// context when it is called.</span>
00906                 <span class="comment">//</span>
00907 
00908                 DispatcherContext.ControlPc = ControlPc;
00909                 DispatcherContext.FunctionEntry = FunctionEntry;
00910                 DispatcherContext.EstablisherFrame = EstablisherFrame;
00911                 DispatcherContext.ContextRecord = ContextRecord;
00912 
00913                 <span class="comment">//</span>
00914                 <span class="comment">// Call the exception handler.</span>
00915                 <span class="comment">//</span>
00916 
00917                 <span class="keywordflow">do</span> {
00918 
00919                     <span class="comment">//</span>
00920                     <span class="comment">// If the establisher frame is the target of the unwind</span>
00921                     <span class="comment">// operation, then set the target unwind flag.</span>
00922                     <span class="comment">//</span>
00923 
00924                     <span class="keywordflow">if</span> ((ULONG)TargetFrame == EstablisherFrame) {
00925                         ExceptionFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a30">EXCEPTION_TARGET_UNWIND</a>;
00926                     }
00927 
00928                     ExceptionRecord-&gt;ExceptionFlags = ExceptionFlags;
00929 
00930                     <span class="comment">//</span>
00931                     <span class="comment">// Set the specified return value in case the exception</span>
00932                     <span class="comment">// handler directly continues execution.</span>
00933                     <span class="comment">//</span>
00934 
00935                     ContextRecord-&gt;Gpr3 = (ULONG)ReturnValue;
00936                     Disposition =
00937                         <a class="code" href="../../d6/d9/ntrtlppc_8h.html#a1">RtlpExecuteHandlerForUnwind</a>(ExceptionRecord,
00938                                                     EstablisherFrame,
00939                                                     ContextRecord,
00940                                                     &amp;DispatcherContext,
00941                                                     FunctionEntry-&gt;ExceptionHandler);
00942 
00943                     <span class="comment">//</span>
00944                     <span class="comment">// Clear target unwind and collided unwind flags.</span>
00945                     <span class="comment">//</span>
00946 
00947                     ExceptionFlags &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a31">EXCEPTION_COLLIDED_UNWIND</a> |
00948                                                         <a class="code" href="../../d6/d7/halmips_8h.html#a30">EXCEPTION_TARGET_UNWIND</a>);
00949 
00950                     <span class="comment">//</span>
00951                     <span class="comment">// Case on the handler disposition.</span>
00952                     <span class="comment">//</span>
00953 
00954                     <span class="keywordflow">switch</span> (Disposition) {
00955 
00956                         <span class="comment">//</span>
00957                         <span class="comment">// The disposition is to continue the search.</span>
00958                         <span class="comment">//</span>
00959                         <span class="comment">// If the target frame has not been reached, then</span>
00960                         <span class="comment">// virtually unwind to the caller of the current</span>
00961                         <span class="comment">// routine, update the context record, and continue</span>
00962                         <span class="comment">// the search for a handler.</span>
00963                         <span class="comment">//</span>
00964 
00965                     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a37">ExceptionContinueSearch</a> :
00966                         <span class="keywordflow">if</span> (EstablisherFrame != (ULONG)TargetFrame) {
00967                             NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
00968                                                       FunctionEntry,
00969                                                       ContextRecord,
00970                                                       &amp;InFunction,
00971                                                       &amp;EstablisherFrame,
00972                                                       NULL,
00973                                                       0,
00974                                                       0xffffffff);
00975                         }
00976 
00977                         <span class="keywordflow">break</span>;
00978 
00979                         <span class="comment">//</span>
00980                         <span class="comment">// The disposition is collided unwind.</span>
00981                         <span class="comment">//</span>
00982                         <span class="comment">// Set the target of the current unwind to the context</span>
00983                         <span class="comment">// record of the previous unwind, and reexecute the</span>
00984                         <span class="comment">// exception handler from the collided frame with the</span>
00985                         <span class="comment">// collided unwind flag set in the exception record.</span>
00986                         <span class="comment">//</span>
00987 
00988                     <span class="keywordflow">case</span> <a class="code" href="../../d6/d7/halmips_8h.html#a39">ExceptionCollidedUnwind</a> :
00989                         ControlPc = DispatcherContext.ControlPc;
00990                         FunctionEntry = DispatcherContext.FunctionEntry;
00991                         ContextRecord = DispatcherContext.ContextRecord;
00992                         ContextRecord-&gt;Iar = (ULONG)TargetIp;
00993                         ExceptionFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a31">EXCEPTION_COLLIDED_UNWIND</a>;
00994                         EstablisherFrame = DispatcherContext.EstablisherFrame;
00995                         <span class="keywordflow">break</span>;
00996 
00997                         <span class="comment">//</span>
00998                         <span class="comment">// All other disposition values are invalid.</span>
00999                         <span class="comment">//</span>
01000                         <span class="comment">// Raise invalid disposition exception.</span>
01001                         <span class="comment">//</span>
01002 
01003                     <span class="keywordflow">default</span> :
01004                         <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a0">RAISE_EXCEPTION</a>(STATUS_INVALID_DISPOSITION, ExceptionRecord);
01005                     }
01006 
01007                 } <span class="keywordflow">while</span> ((ExceptionFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a31">EXCEPTION_COLLIDED_UNWIND</a>) != 0);
01008 
01009             } <span class="keywordflow">else</span> {
01010 
01011                 <span class="comment">//</span>
01012                 <span class="comment">// If the target frame has not been reached, then virtually unwind to the</span>
01013                 <span class="comment">// caller of the current routine and update the context record.</span>
01014                 <span class="comment">//</span>
01015 
01016                 <span class="keywordflow">if</span> (EstablisherFrame != (ULONG)TargetFrame) {
01017                     NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
01018                                               FunctionEntry,
01019                                               ContextRecord,
01020                                               &amp;InFunction,
01021                                               &amp;EstablisherFrame,
01022                                               NULL,
01023                                               0,
01024                                               0xffffffff);
01025                 }
01026             }
01027 
01028         } <span class="keywordflow">else</span> {
01029 
01030             <span class="comment">//</span>
01031             <span class="comment">// Set point at which control left the previous routine.</span>
01032             <span class="comment">//</span>
01033             NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
01034                                       FunctionEntry,
01035                                       ContextRecord,
01036                                       &amp;InFunction,
01037                                       &amp;EstablisherFrame,
01038                                       NULL,
01039                                       0,
01040                                       0xffffffff);
01041 
01042             <span class="comment">//</span>
01043             <span class="comment">// If the next control PC is the same as the old control PC, then</span>
01044             <span class="comment">// the function table is not correctly formed.</span>
01045             <span class="comment">//</span>
01046 
01047             <span class="keywordflow">if</span> (NextPc == ControlPc) {
01048                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_FUNCTION_TABLE);
01049             }
01050         }
01051 
01052         <span class="comment">//</span>
01053         <span class="comment">// Set point at which control left the previous routine.</span>
01054         <span class="comment">//</span>
01055         <span class="comment">// N.B. Make sure the address is in the delay slot of the jal</span>
01056         <span class="comment">//      to prevent the boundary condition of the return address</span>
01057         <span class="comment">//      being at the front of a try body.</span>
01058         <span class="comment">//</span>
01059 
01060         ControlPc = NextPc;
01061 
01062     } <span class="keywordflow">while</span> ((EstablisherFrame &lt; HighLimit) &amp;&amp;
01063             (EstablisherFrame != (ULONG)TargetFrame));
01064 
01065     <span class="comment">//</span>
01066     <span class="comment">// If the establisher stack pointer is equal to the target frame</span>
01067     <span class="comment">// pointer, then continue execution. Otherwise, an exit unwind was</span>
01068     <span class="comment">// performed or the target of the unwind did not exist and the</span>
01069     <span class="comment">// debugger and subsystem are given a second chance to handle the</span>
01070     <span class="comment">// unwind.</span>
01071     <span class="comment">//</span>
01072 
01073     <span class="keywordflow">if</span> (EstablisherFrame == (ULONG)TargetFrame) {
01074         <span class="comment">//</span>
01075         <span class="comment">// Virtually unwind the target frame to recover the value of r.2.</span>
01076         <span class="comment">// We must take care to not unwind a glue sequence that may have</span>
01077         <span class="comment">// been used to reach the target frame.  This is done by giving</span>
01078         <span class="comment">// stack limit values that will regard any stack pointer as bad.</span>
01079         <span class="comment">//</span>
01080         CONTEXT TocContext;
01081         RtlMoveMemory((PVOID)&amp;TocContext, ContextRecord, <span class="keyword">sizeof</span>(CONTEXT));
01082         ControlPc = ContextRecord-&gt;Iar;
01083         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc);
01084         NextPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ControlPc,
01085                                   FunctionEntry,
01086                                   &amp;TocContext,
01087                                   &amp;InFunction,
01088                                   &amp;EstablisherFrame,
01089                                   NULL,
01090                                   0xffffffff,
01091                                   0);
01092         ContextRecord-&gt;Gpr2 = TocContext.Gpr2;
01093         ContextRecord-&gt;Gpr3 = (ULONG)ReturnValue;
01094         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a3">RtlpRestoreContext</a>(ContextRecord, ExceptionRecord);
01095 
01096     } <span class="keywordflow">else</span> {
01097         ZwRaiseException(ExceptionRecord, ContextRecord, FALSE);
01098     }
01099 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
